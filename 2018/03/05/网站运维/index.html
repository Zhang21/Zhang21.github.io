<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Operations,Database," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="参考： 《网站运维：保持数据实时的秘籍》(Web Operations: Keeping the Data on Time)">
<meta name="keywords" content="Operations,Database">
<meta property="og:type" content="article">
<meta property="og:title" content="《网站运维》读书笔记">
<meta property="og:url" content="https://zhang21.github.io/2018/03/05/网站运维/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考： 《网站运维：保持数据实时的秘籍》(Web Operations: Keeping the Data on Time)">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-03-11T08:26:34.459Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《网站运维》读书笔记">
<meta name="twitter:description" content="参考： 《网站运维：保持数据实时的秘籍》(Web Operations: Keeping the Data on Time)">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2018/03/05/网站运维/"/>





  <title>《网站运维》读书笔记 | 风继续吹</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2018/03/05/网站运维/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang21">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">《网站运维》读书笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-05T22:34:49+08:00">
                2018-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/05/网站运维/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/05/网站运维/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  9,482
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考： 《网站运维：保持数据实时的秘籍》(Web Operations: Keeping the Data on Time)</p>
<p><br><br><br></p>
<a id="more"></a>
<p><br></p>
<h1 id="作为职业的运维"><a href="#作为职业的运维" class="headerlink" title="作为职业的运维"></a>作为职业的运维</h1><p>互联网变化如此之快，以至于几乎没有时间认真思考一下我们在做什么，以及为什么做。我们奋力拼搏，才避免被淘汰出局，哪里还敢谈论什么引领潮流呢！这种高压、过度刺激的环境使得所有努力都只是为了一份工作，而没有职业的概念了。</p>
<p>职业是指占去你人生大部分时光的事业，并能够逐步晋升。工作只是拿钱干活儿，换句话说，工作就只是工作而已。</p>
<p><br></p>
<h2 id="为什么运维如此艰难"><a href="#为什么运维如此艰难" class="headerlink" title="为什么运维如此艰难"></a>为什么运维如此艰难</h2><p>运维对如下领域都有深入的理解：<strong>网络、路由、交换、防火墙、负载均衡、高可用性、灾难恢复、TCP与UDP服务、网络运维中心管理、硬件规范、各种Unix、各种Web服务器技术、高速缓存技术、数据库技术、存储基础架构、密码学、算法、趋势分析、容量规划…</strong></p>
<p>运维要求广博，可以说几乎是不可接受的。</p>
<p>运维领域成为一个合格的人选，需要具备三点素质：<strong>扎实的计算背景、娴熟的决断力、沉稳的性格</strong>。</p>
<p><br></p>
<h3 id="扎实的计算背景"><a href="#扎实的计算背景" class="headerlink" title="扎实的计算背景"></a>扎实的计算背景</h3><p>运维要求理解架构中的各个组成部分，在理解计算系统的来龙去脉时，扎实的计算背景对你会有莫大的帮助。具有扎实的基础，对于理解为什么及如何架构解决方案，以及识别出问题所在，是非常重要的。毕竟，计算是架构我们的智能系统的基础。此外，工程师的思维方式和对物理定律的基本理解，也是一个很大的优势。</p>
<p>运维会经常遇到随意的、不切实际的期望。<br>运维，就是理解理论和实践在哪里发生冲突，并发明适当的方法，以便在发生事故时减少损失。</p>
<p><br></p>
<h3 id="娴熟的决断力"><a href="#娴熟的决断力" class="headerlink" title="娴熟的决断力"></a>娴熟的决断力</h3><p>虽然优柔寡断在任何领域都不算是一个优点，但在运维中却几乎不能容忍。</p>
<p><br></p>
<h3 id="沉稳的性格"><a href="#沉稳的性格" class="headerlink" title="沉稳的性格"></a>沉稳的性格</h3><p>一个沉稳与可控的思维过程是非常关键的，需要保持自己是清醒的一方。</p>
<p>在运维领域，目标很简单，使所有事情在所有时间正常运转。一个简单的定义，但却是一个不可能的期望。或许在这个领域成为一名工程师的更大挑战是组织内的同事对你的不切实际的期望。</p>
<p><br><br><br></p>
<h2 id="从学徒到师傅"><a href="#从学徒到师傅" class="headerlink" title="从学徒到师傅"></a>从学徒到师傅</h2><p>掌握任何知识领域都需要四项基本要求：<strong>知识、工具、经验和纪律</strong>。</p>
<p><br></p>
<h3 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h3><p>互联网行业的一个独特之处就是几乎所有的东西都是公开的，事实上，有专有权的东西也是极少的，而更为独特的是，几乎所有规范文档都是免费的。</p>
<p>在你走在从从学徒到师傅的路途中，尽可能多滴占有信息是你的职责，这样你的大脑才能将那些细微之处进行排序、过滤、关联，使其成为一幅简明、精确的图画，从而有助于你的决策——不管是长期的架构设计的关键决策，还是临时的排除故障的决策。</p>
<p><br></p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>虽然工具各有优缺点，然而人们使用这些工具都取得了成功。制造和使用工具使我们人类的本性。<br>所有的工具归根结底都只是人类肢体和感觉器官的延长。</p>
<p>师傅不适用工具炼成的。在互联网应用的环境中，你会看得更清楚，五花八门的语言、平台、技术都能够成功地结合在一起，将这些成功地构建为一个架构的，不是Java或PHP，而是设计与实现它的工程师——那些师傅们。</p>
<p>工具上的一个真理是，不管在用的工具是什么，要了解你的工具，这是在这个行业登堂入室的前提。灵巧地运用工具的能力，比工具本身的质量要重要的多。话虽如此，有经验的工程师还是应该手边备一件合适的高质量的工具。</p>
<p><br></p>
<h3 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h3><p>从最本质的意义上来说，经验意味着良好的判断力，而良好的判断力却是从很多失败中取得的。</p>
<p>经验与知识是紧密相关的，知识可以认为是他人经验的总结。<br>经验既是一个名词，也是一个动词。获得经验与应用经验，同样容易也同样困难。</p>
<p>一名资深工程师最大的特点是其一致与可靠的良好判断力。很显然，这要在需要做出判断的场合经受锻炼。</p>
<p>对进入运维这个领域而没有什么经验的工程师，我的忠告是：<strong>耐心</strong>。</p>
<p><br></p>
<h3 id="纪律"><a href="#纪律" class="headerlink" title="纪律"></a>纪律</h3><p>通过尽可能正确而高效地做事，从而为解决同样问题，而尽可能地少做工作。</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="如何应用云计算-Elastic-Compute"><a href="#如何应用云计算-Elastic-Compute" class="headerlink" title="如何应用云计算(Elastic Compute)"></a>如何应用云计算(Elastic Compute)</h1><p>云服务器(ECS, Elastic Compute Service)</p>
<p><br></p>
<h2 id="什么地方适合云计算"><a href="#什么地方适合云计算" class="headerlink" title="什么地方适合云计算"></a>什么地方适合云计算</h2><p>灵活性和一定程度上的自由是云服务器的特点，当然，本地服务器同样有这个特点。</p>
<p><br></p>
<h3 id="混合计算"><a href="#混合计算" class="headerlink" title="混合计算"></a>混合计算</h3><p>混合计算=云计算+本地计算</p>
<p><br></p>
<h2 id="什么地方不适合云计算"><a href="#什么地方不适合云计算" class="headerlink" title="什么地方不适合云计算"></a>什么地方不适合云计算</h2><p>当然，最先考虑的肯定是经济层面。</p>
<p>服务层与数据库是紧密耦合的，所以使它们之间的网络延迟最小化是很重要的。这意味着它们要么全在云里，要么全在云外。</p>
<p><br></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>尽管有大量广告吹嘘完整托管在云里，但从运维角度来说，混合应用架构模式或许是最有趣的。有些事情在云里做的不一定好。脚踏两只船，你才会游刃有余。</p>
<p>混合应用还强调一点，就是传统运维中的最佳时间仍然是成功的公司的云应用所必须的。</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="基础架构与应用程序测量"><a href="#基础架构与应用程序测量" class="headerlink" title="基础架构与应用程序测量"></a>基础架构与应用程序测量</h1><p>任何规模的运维，采集测量数据就像将服务器连接到网络上一样重要，对于一个规模不断增长的基础架构来说，或许更加重要。</p>
<p>我们不光讨论你要采集并监视的测量数据的种类，还要讨论为了应对各种情况，你能利用这些数据做些什么。</p>
<p>测量数据的采集和带有报警(alerting)功能的监控有明显的区别。</p>
<p><br><br><br></p>
<h2 id="时间刷新率和存留时间的考虑"><a href="#时间刷新率和存留时间的考虑" class="headerlink" title="时间刷新率和存留时间的考虑"></a>时间刷新率和存留时间的考虑</h2><p>随着采集的数据不断增长，确保这些数据能够一直可查询和移动，这是很明智的。</p>
<p>如Zabbix中——获取数据的时间刷新率和数据保存时间。历史数据保留时长和趋势数据存储时间。<br>比如有的数据要30s获取一次，而有的信息只需要1h获取一次。</p>
<p>测量数据真正出彩的地方：</p>
<ul>
<li>对于某个特定的资源，每天的峰值是哪些？每周的峰值日是哪些？每年的峰值月是哪些？</li>
<li>有季节性模式吗？<ul>
<li>如夏时日和节假日会高一些</li>
</ul>
</li>
<li>最大(波峰)值与最小(波谷)值比较起来怎么样？</li>
<li>在用户分布广泛的情况下，波峰与波谷是否发生变化？</li>
</ul>
<p><br><br><br></p>
<h2 id="测量数据采集与存储的地点"><a href="#测量数据采集与存储的地点" class="headerlink" title="测量数据采集与存储的地点"></a>测量数据采集与存储的地点</h2><p>无论使用什么采集工具，易于采集和便于得出结果都是必须要考虑的。</p>
<p><br><br><br></p>
<h2 id="测量数据的层次"><a href="#测量数据的层次" class="headerlink" title="测量数据的层次"></a>测量数据的层次</h2><p>不同层次的数据存储在不同的数据库中。</p>
<p><br></p>
<h3 id="高层业务或功能特定的测量数据"><a href="#高层业务或功能特定的测量数据" class="headerlink" title="高层业务或功能特定的测量数据"></a>高层业务或功能特定的测量数据</h3><p>有了这些高层数据之后，面向产品的那些人对这些数据也抱有极大的兴趣，你一点都不用感到惊讶。</p>
<p>对于应用层面的数据，最有用的是能够跟踪用户的交互情况。</p>
<p><br></p>
<h3 id="系统及服务层面的测量数据"><a href="#系统及服务层面的测量数据" class="headerlink" title="系统及服务层面的测量数据"></a>系统及服务层面的测量数据</h3><p>这些是在运维工程师电脑上以图形方式显示的数据。</p>
<p><br></p>
<p>测量数据的层次：</p>
<table>
<thead>
<tr>
<th>-</th>
<th>例子</th>
<th>测量项目</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层</td>
<td>网页或API</td>
<td>故障：类型、延迟、发生率…</td>
</tr>
<tr>
<td>服务层</td>
<td>Nginx, MySQL, MongoDB…</td>
<td>Nginx: 请求频率、响应时间、忙碌的工作进程… <br> MySQL/MongoDB：导致故障的查询类型、慢查询、连接数…</td>
</tr>
<tr>
<td>物理层</td>
<td>CPU、内存、网络、硬盘</td>
<td>内存：繁忙程度 <br> 内存：空闲内存 <br> 硬盘：可用空间，I/O速率 <br> 网络：网络I/O带宽情况</td>
</tr>
</tbody>
</table>
<p>有了这些数据，就能够回答如下问题：</p>
<ul>
<li>平均的Web请求时间</li>
<li>CPU时间</li>
<li>调用最多的数据库查询</li>
<li>数据库慢查询</li>
<li>文件系统缓存</li>
<li>最大的页面响应</li>
<li>…</li>
</ul>
<p><br><br><br></p>
<h2 id="为异常检测和报警提供环境"><a href="#为异常检测和报警提供环境" class="headerlink" title="为异常检测和报警提供环境"></a>为异常检测和报警提供环境</h2><p>在本地采集的测量数据的主要理由，就像油表一样，有了这些数据，就可以明白基础架构正在发生什么，以及正在驶向何方。<br>知道哪里的资源在增长或缩减，能够进行预测。使用预测对基础架构的容量需求进行预报，称为容量规划。<br>观察网站运行是否有异常时，测量数据就派上用场了。</p>
<p>发生异常是，测量数据回味报警提供相关信息。报警的信息要尽量简明，告知检测到了什么，以及何时检测到。而测量数据会告诉你报警都发生了什么。</p>
<p><br><br><br></p>
<h2 id="日志记录也是测量数据"><a href="#日志记录也是测量数据" class="headerlink" title="日志记录也是测量数据"></a>日志记录也是测量数据</h2><p>应用程序的日志文件也提供了测量数据和使用情况的信息。这些信息用于追踪过去发生的事件。</p>
<p><br><br><br></p>
<h2 id="将变化管理和事件的时间线建立关联"><a href="#将变化管理和事件的时间线建立关联" class="headerlink" title="将变化管理和事件的时间线建立关联"></a>将变化管理和事件的时间线建立关联</h2><p>更新生产系统会带来风险。<br>记录更新发生的时间，从而保留更新的踪迹，这在发生问题需要进行追踪时是非常有价值的。</p>
<p><br><br><br></p>
<h2 id="给测量数据加入报警机制"><a href="#给测量数据加入报警机制" class="headerlink" title="给测量数据加入报警机制"></a>给测量数据加入报警机制</h2><p>Zabbix、Nagios等就是一个测量数据采集系统配合使用的监控/报警工具。</p>
<p><br><br><br></p>
<h2 id="使用测量数据建立加载-反馈机制"><a href="#使用测量数据建立加载-反馈机制" class="headerlink" title="使用测量数据建立加载-反馈机制"></a>使用测量数据建立加载-反馈机制</h2><p>采集时序数据的另一个好处，就是能够通过编程使你的应用生成测量数据，从而可以建立安全、精密的反馈循环。</p>
<p><br><br><br></p>
<h2 id="结语-1"><a href="#结语-1" class="headerlink" title="结语"></a>结语</h2><p>测量数据的采集、存储、显示，可以认为是web基础架构的关键部分。不论是及时排查错误，预测容量、规划产品的发布，还是建立应用的反馈机制，如果没有正确的测量数据为你提供一个基础架构运行的全景图的话，你会损失惨重。</p>
<p>设计数据如何经过系统时，要考虑安全问题，而且数据要易于导出到其它应用。一旦运维部门采集了测量数据，你会发现，追踪数据是一件多么有趣的事情，同时也能使工作更加轻松。</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="连续部署"><a href="#连续部署" class="headerlink" title="连续部署"></a>连续部署</h1><p>软件应该以小批量的方式进行设计、编写和部署。</p>
<p>批量大小是产品在开发过程的各个阶段转移的单位。对于软件而言，最容易看到的批量是代码。每次工程师检入代码，都是在提交一定量的工作。有很多技术用来控制这些批量，从连续部署所需的最小批量到更为传统的分支开发，在分支开发中，多个开发者工作数周或数月产生的所有代码将被成批处理，并集中到一起。</p>
<p>结果证明，以远小于传统做法的建议的批量工作，有极大的好处。</p>
<p><br><br><br></p>
<h2 id="小批量意味着更快的反馈"><a href="#小批量意味着更快的反馈" class="headerlink" title="小批量意味着更快的反馈"></a>小批量意味着更快的反馈</h2><p>工作转移到下一阶段越快，则也就能越快地发现下一个阶段是如何接纳你的工作的。</p>
<p><br><br><br></p>
<h2 id="小批量意味着问题即刻被本地化"><a href="#小批量意味着问题即刻被本地化" class="headerlink" title="小批量意味着问题即刻被本地化"></a>小批量意味着问题即刻被本地化</h2><p>问题发现得越快，则解决的也越快。</p>
<p>每次部署，都只有少量代码有变化，所以导致回归或料想不到的性能问题的任何变化，都能够快速识别出来，并进行改正。当然，由于需要改正或回滚的变化数量不仅是确定的，也是很小的，所以解决问题的平均时间也就很低了。</p>
<p><br><br><br></p>
<h2 id="小批量能够减少风险"><a href="#小批量能够减少风险" class="headerlink" title="小批量能够减少风险"></a>小批量能够减少风险</h2><p><br><br><br></p>
<h2 id="小批量可以降低总开销"><a href="#小批量可以降低总开销" class="headerlink" title="小批量可以降低总开销"></a>小批量可以降低总开销</h2><p>大多数机构都会降低自己的批量大小，以降低总的开销。<br>大批量导致的瓶颈经常是隐含的，是这些隐含的瓶颈显现出来，是需要开销的，甚至要投入更多的工作才能修正这些瓶颈。</p>
<p>连续部署的目标，是在减小批量的同时，帮助开发团队清除开发过程中的垃圾，加快工作步伐。这样就能使各个团队处于持续的流动状态，这种状态使得团队的创新、试验变得非常容易，从而形成可持续发展的良性循环。</p>
<p><br><br><br></p>
<h2 id="质量卫士的挽歌"><a href="#质量卫士的挽歌" class="headerlink" title="质量卫士的挽歌"></a>质量卫士的挽歌</h2><p>产生开发过程中的垃圾的一个很大原因是重复检查。</p>
<p>连续集成，有助于加快缺陷反馈流程；故事卡和看板，用于降低批量大小；日站，有助于加快步伐；连续部署也是这样的技术，有能力是开发团队更有活力。</p>
<p><br></p>
<h3 id="为什么连续部署能行"><a href="#为什么连续部署能行" class="headerlink" title="为什么连续部署能行"></a>为什么连续部署能行</h3><p>连续部署区分了发布的两种不同的定义：</p>
<ul>
<li>一个是工程师使用的，指的是将代码完全集成到生产环境中的过程；</li>
<li>另一个是市场部门使用的，指的是客户看到的东西</li>
</ul>
<p>使用连续部署，代码一旦写完，就在去往生产环境的路上了。<br>连续部署也起着速度调节器的作用。</p>
<p>这种速度调节，对于习惯于通过个体效率来度量其进步的团队来说，是一种技巧性的调整。在这种团队中，每个工程师的头等大事就是保持忙碌。不幸的是，这种观点忽略了团队的整体生产能力。对于有些情形，大家坐下来讨论，找出协调方法，从而不需要做重复工作，这时候才是有效率的。</p>
<p><br><br><br></p>
<h2 id="让我们开始吧"><a href="#让我们开始吧" class="headerlink" title="让我们开始吧"></a>让我们开始吧</h2><h3 id="步骤1：连续集成服务器"><a href="#步骤1：连续集成服务器" class="headerlink" title="步骤1：连续集成服务器"></a>步骤1：连续集成服务器</h3><p>这是连续部署的脊梁。我们需要一个中心服务器，运行所有的自动化测试，并监控每一次的提交。</p>
<p><br></p>
<h3 id="步骤2：源代码控制提交检查"><a href="#步骤2：源代码控制提交检查" class="headerlink" title="步骤2：源代码控制提交检查"></a>步骤2：源代码控制提交检查</h3><p>下一个需要的基础框架是源代码控制服务器，并带有能进行提交检查的甲苯。如CVS、SVN、Git等。</p>
<p>作为一个团队，我们的目标是在能够可靠地生产高质量代码的前提下，尽可能快地工作，但不要过快。</p>
<p><br></p>
<h3 id="步骤3：简单的部署脚本"><a href="#步骤3：简单的部署脚本" class="headerlink" title="步骤3：简单的部署脚本"></a>步骤3：简单的部署脚本</h3><p>建立一个关键的部署脚本，用于逐台机器进行增量备份，与此同时，监控集群和业务的运行情况。这样一旦出现异常，就可以快速恢复。</p>
<p><br></p>
<h3 id="步骤4：实时报警"><a href="#步骤4：实时报警" class="headerlink" title="步骤4：实时报警"></a>步骤4：实时报警</h3><p>无论部署过程多么完美，缺陷仍然会通过部署而进入生产环境。需要一个监控平台，以便事情一旦偏离正常，能够进行提醒，并找到人来调试。</p>
<p><br></p>
<h3 id="步骤5：根本原因分析"><a href="#步骤5：根本原因分析" class="headerlink" title="步骤5：根本原因分析"></a>步骤5：根本原因分析</h3><p>无论问题多小，都要做些投资，而且各个级别都要做。<br>小的改进，经过经年累月，非常像复利。</p>
<p><br><br><br></p>
<h2 id="连续部署用于关键应用"><a href="#连续部署用于关键应用" class="headerlink" title="连续部署用于关键应用"></a>连续部署用于关键应用</h2><p>连续部署要求的第一个心态转移是：如果一个更新假设是无副作用的，马上发布。不要再等着与其它相关的更新捆绑在一起，否则，一旦发生副作用，就很难确定到底是哪个更新产生的。</p>
<p>第二个是心态转移是把市场发布的概念和工程发布的概念区分开。</p>
<p><br></p>
<ul>
<li>更快更好的反馈</li>
<li>更多的自动化</li>
<li>对真实环境测量数据的监控</li>
<li>更好地处理间歇性错误</li>
<li>更小的批量</li>
</ul>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="作为代码的基础架构"><a href="#作为代码的基础架构" class="headerlink" title="作为代码的基础架构"></a>作为代码的基础架构</h1><p><strong>只需要源代码库、应用程序数据备份、硬件裸机就能够把整个业务重建起来。</strong></p>
<p>理想情况下，重组业务的最大制约是还原应用程序数据所需要的时间，应用程序数据是真正的业务价值所在。</p>
<p><br><br><br></p>
<h2 id="面向服务体系结构"><a href="#面向服务体系结构" class="headerlink" title="面向服务体系结构"></a>面向服务体系结构</h2><p>将系统的每个组件都分解为可通过网络访问的服务，这些服务集成在一起就构成了一个功能性应用程序。</p>
<p>通过将每个基本组件都呈现为服务、应用开发者可自由组装的新的应用，结果就是重用更为容易、封装更为清洁、错误排查更为简单。</p>
<ul>
<li><p>应该是模块化的</p>
<ul>
<li>做一件事，并且做好<br>在SOA中，每个服务都很小——只做一件事，并允许其它服务调用。每个服务都很简单，但应用程序员要做很多集成工作。每个服务都专注于自己的狭小领域，则管理、开发、测试都会很容易。<br>基础架构服务也是一样的，缩小每个服务的操作范围，就可以降低复杂性，从而他人也就易于理解其行为。</li>
</ul>
</li>
<li><p>应该是协作的</p>
<ul>
<li>让我们团结起来<br>在构建通过网络API呈现的基本服务时，要鼓励别人和你协作，而不是重复实现相同的功能。每个服务都要设计成与其它服务协作的，尽量少假设服务的使用方式。<br>服务的协作本性决定了用的人越多，则服务本身就越有用。对于基础架构服务而言，这种本性是至关重要的——随着基础架构的每个部分都成为可集成的服务，服务之间相互协作的方式会呈指数增长。</li>
</ul>
</li>
<li><p>应该是可组合的</p>
<ul>
<li>应该一切准备就绪<br>理想情况下，每个服务都应该通过易于访问的网络API呈现自己的配置和功能，实际情况是：大部分都没有。</li>
</ul>
</li>
</ul>
<p><br></p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>配置管理是一种管理活动，从技术和管理两个方面作用于产品和生命周期、配置项，以及相关的产品配置信息。</p>
<p>配置管理是指对所有那些事情的跟踪，那些事情是把一个系统从<strong>裸机(baremetal)</strong>转变成<strong>做自己的事</strong>时必须要做的。系统管理员手工配置系统，并将笔记贴到wiki上时，他就是在实践着最基本的配置管理。软件开发者写了一个脚本来自动部署自己的应用程序，她就是在实践着自动化的配置管理。</p>
<p><br></p>
<h3 id="配置管理是策略驱动的"><a href="#配置管理是策略驱动的" class="headerlink" title="配置管理是策略驱动的"></a>配置管理是策略驱动的</h3><ol>
<li>把问题和解决方案的最终结果记入文档(设立策略)；</li>
<li>写出在策略中要执行的代码(执行策略)；</li>
<li>确认最终结果是正确的(审计策略)；</li>
<li>重复这个过程，确保以后呢能够可靠的执行(测试策略)</li>
</ol>
<p><br></p>
<h3 id="系统自动化就是用代码实现配置管理策略"><a href="#系统自动化就是用代码实现配置管理策略" class="headerlink" title="系统自动化就是用代码实现配置管理策略"></a>系统自动化就是用代码实现配置管理策略</h3><p>自动化几乎总是使用高级语言，自动化方式展现了三个原则：</p>
<ul>
<li>应该是灵活的<ul>
<li>无论需要什么，都应该有能力做</li>
</ul>
</li>
<li>应该是可扩展的<ul>
<li>遇到新情况时，要易于扩展</li>
</ul>
</li>
<li>应该是可重复的<ul>
<li>不管重复做了多少次，结果都一样</li>
</ul>
</li>
</ul>
<p><br></p>
<h3 id="系统管理中的配置管理"><a href="#系统管理中的配置管理" class="headerlink" title="系统管理中的配置管理"></a>系统管理中的配置管理</h3><p>配置管理工具应该有如下思想：</p>
<ul>
<li>描述的<ul>
<li>说明做什么，而不是怎么做</li>
</ul>
</li>
<li>抽象的<ul>
<li>让工具为你操心细节</li>
</ul>
</li>
<li>幂等的<ul>
<li>旨在需要时才采取行动</li>
</ul>
</li>
<li>聚合的<ul>
<li>只关心自己，并信赖其他服务亦然</li>
</ul>
</li>
</ul>
<p><br></p>
<h3 id="系统集成"><a href="#系统集成" class="headerlink" title="系统集成"></a>系统集成</h3><p>系统集成是指将各个组件整合为一个功能正常的、完全自动化的系统。系统集成侧重于广度，能否成功则依赖于对两个方面的理解：</p>
<ul>
<li>系统中的每个组件是如何工作的</li>
<li>这些组件是如何相关的</li>
</ul>
<p>应该遵循这两个步骤将基础架构构建为代码，这两个恰好也是系统集成阶段使用的步骤。系统集成就是将所有的东西整合在一起。</p>
<p><br></p>
<p><strong>将基础架构分解为可重用的，可通过网络访问的服务</strong></p>
<p>良好基础架构的十大核心原则：</p>
<ul>
<li>应该是模块化的<ul>
<li>启动过程将只处理这样的任务：使资源成为网络可访问</li>
</ul>
</li>
<li>应该是协作的<ul>
<li>启动服务应该能够将启动后的工作传给其他服务</li>
</ul>
</li>
<li>应该是可组合的<ul>
<li>能够从不同的服务中调用启动服务</li>
</ul>
</li>
<li>应该是灵活的<ul>
<li>足够灵活以应付不同类型的物理系统</li>
</ul>
</li>
<li>应该是可扩展的<ul>
<li>易于扩展，义启动新的资源类型</li>
</ul>
</li>
<li>应该是可重复的<ul>
<li>每次启动，都要生产相同的系统</li>
</ul>
</li>
<li>应该是描述的<ul>
<li>应该描述需要的系统类型，而不是如何安装和构建这些系统的细节</li>
</ul>
</li>
<li>应该是抽象的<ul>
<li>应该隐藏底层机制</li>
</ul>
</li>
<li>应该是幂等的</li>
<li>应该是聚合的<ul>
<li>应该尽快将每个系统都启动起来，并为随后的操作系统做好准备，而不用担心其他系统的状态</li>
</ul>
</li>
</ul>
<p><br></p>
<p><strong>将服务集成在一起</strong></p>
<p>现在，你已经创建了一个如何引导和配置系统的策略，你知道接收标准是什么、能够列出实现步骤、能够对策略进行测试。这种做系统集成的方式类似于做一个多层蛋糕：每一层都建立在前一层的美味基础上，使得整个蛋糕更为诱人。</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h1><p>我以前假定服务器资源是无限的，实际情况却是服务器正在为获得必要的内存而努力挣扎着。操作系统开始进行交换，CPU开始过载，从而响应时间开始变糟。</p>
<p>技术人员的观点和最终用户/业务的观点并不一致。</p>
<p>监控并不是设置一个系统，它是用来支持业务运转的，是用来保证系统中各个部分都在各司其职地工作着。能够正常工作也可以表述为保持网站的可用性。</p>
<p>可用性(A)可表述为：<br>A = Uptime/(Uptime + Downtime)</p>
<p>网站可用性受如下4个参数的影响：</p>
<ul>
<li><strong>MTTD(平均故障诊断时间)</strong><ul>
<li>诊断该问题所花费的平均时间</li>
</ul>
</li>
<li><strong>MTTR(平均修复时间)</strong><ul>
<li>用于修复问题所花费的平均时间</li>
</ul>
</li>
<li><strong>MTTF(平均无故障时间)</strong><ul>
<li>正常运行的平均时间</li>
</ul>
</li>
<li><strong>MTBF(平均故障间隔时间)</strong><ul>
<li>两次故障间隔的平均时间</li>
</ul>
</li>
</ul>
<p>A = MTTF/MTBF = MTTF/(MTTF+MTTD+MTTR)</p>
<p>并不是说你的业务需要接近90%或更高的可用性，业务要求的可能性只是一种期望值，如果宕机发生在周末，即使发生在工作日，只要还能工作，用户也不会说什么。你的目标是应该通过降低MTTD和MTTR，以及增加MTTF来增加可用性。</p>
<p><br><br><br></p>
<h2 id="理解你在监控什么"><a href="#理解你在监控什么" class="headerlink" title="理解你在监控什么"></a>理解你在监控什么</h2><p><strong>技术组件的依赖项：</strong></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>依赖关系</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用程序</td>
<td>应用程序服务器、Web服务器、邮件服务器、缓存服务器、队列服务器</td>
</tr>
<tr>
<td>Mail服务器</td>
<td>Mail服务进程、网络、主机、存储</td>
</tr>
<tr>
<td>DNS服务器</td>
<td>DNS服务进程、网络、主机、存储</td>
</tr>
<tr>
<td>应用程序服务</td>
<td>应用程序服务进程、网络、主机、存储</td>
</tr>
<tr>
<td>Web服务器</td>
<td>Web服务器进程、网络、主机、存储</td>
</tr>
<tr>
<td>数据库</td>
<td>数据库服务进程、网络、主机、存储</td>
</tr>
<tr>
<td>主机</td>
<td>设备、OS设备进程</td>
</tr>
<tr>
<td>网络</td>
<td>设备、网络设备进程</td>
</tr>
<tr>
<td>存储</td>
<td>设备、磁盘、RAID控制器、接口</td>
</tr>
<tr>
<td>通用设备</td>
<td>磁盘、内存、CPU、接口、房屋</td>
</tr>
<tr>
<td>房屋</td>
<td>UPS、电源、温度</td>
</tr>
</tbody>
</table>
<p>依赖项常常不受你控制，相反，它是由公司内不同的组管理的。从你自己的筒子里走出来，到其他部门获取相关信息，并不是很容易。正是因为你依赖于他们，所以更好地理解他们的就很关键了。这样你就不用在讯早问题的原因上浪费时间，在用户访问服务所依赖的那些组件上也就不会存在盲点。</p>
<p><br></p>
<p><strong>不同部门之间的边界：</strong></p>
<table>
<thead>
<tr>
<th>企业部门</th>
<th>依赖项</th>
</tr>
</thead>
<tbody>
<tr>
<td>支援部门</td>
<td>能影响浏览器、桌面设置、防病毒/间谍软件</td>
</tr>
<tr>
<td>开发组</td>
<td>专注于应用程序更新</td>
</tr>
<tr>
<td>中间件组</td>
<td>经常运行数据库、Web服务器、应用程序服务器、邮件服务器、缓存服务器队列服务器</td>
</tr>
<tr>
<td>系统组</td>
<td>操作系统、DNS、DHCP、虚拟化、集群</td>
</tr>
<tr>
<td>网络组</td>
<td>交换机、路由器、VPN、代理服务器</td>
</tr>
<tr>
<td>存储组</td>
<td>SAN、NAS、备份、恢复</td>
</tr>
<tr>
<td>数据中心组</td>
<td>电缆、电力、UPS</td>
</tr>
<tr>
<td>安全小组</td>
<td>防火墙、安全策略</td>
</tr>
</tbody>
</table>
<p>这样划分责任，在不清楚问题的真正原因时，会显著增加修复问题的时间。大量精力会花在努力证明自己部门的清白上面，从而延长了解决问题的时间。这份额外时间称为平均清白时间(Mean Time to Innocence)。<br>为了减少这种相互推诿的时间，良好的合作与协调很重要。持续的知识共享有助于增加这种共同应对问题的责任感。</p>
<p>组织边界到防火墙哪里就停止了，但Internet服务比内部控制的服务有更多的依赖项，这些外部依赖项有ISP、广告商、RSS信息、Internet邮件、DNS服务器、ISP连接等，内部依赖项和外部依赖项的主要区别在于，对于外部依赖项，你不知道这些服务是如何提供的。即使如此，也不能在监控这些服务上止步不前，毕竟它们仍然是你的服务的依赖项。</p>
<p>在无冗余的系统中，一个组件失效，整个服务就会失效。当一个组件的失效会影响整个服务时，这种失效就称为单点故障。这种影响既指服务完全中断，也指对服务质量的影响。<br>为了避免单点故障，通常是在架构中的多个位置增加冗余，这些冗余是你的环境的安全卫士，而不是对问题的某种补偿方式。通常，增加冗余会增加复杂性，所以不要掉进过度设计的陷阱。</p>
<p><strong>一些冗余机制：</strong></p>
<table>
<thead>
<tr>
<th>服务/组件</th>
<th>冗余机制</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用程序</td>
<td>负载均衡器、状态复制</td>
</tr>
<tr>
<td>Mail服务器</td>
<td>一个域名多条MX记录</td>
</tr>
<tr>
<td>DNS服务器</td>
<td>一个域名多条NS记录</td>
</tr>
<tr>
<td>应用程序服务器</td>
<td>会话复制、多实例安装</td>
</tr>
<tr>
<td>Web服务器</td>
<td>Web服务器服务进程</td>
</tr>
<tr>
<td>数据库</td>
<td>集群服务、水平区分</td>
</tr>
<tr>
<td>主机</td>
<td>虚拟化、集群</td>
</tr>
<tr>
<td>网络</td>
<td>多网关、BGP、VRRP、多ISP</td>
</tr>
<tr>
<td>存储</td>
<td>RAID、镜像、多重路径技术</td>
</tr>
<tr>
<td>通用设备</td>
<td>多网卡、CPU、内存</td>
</tr>
<tr>
<td>数据中心</td>
<td>BGP任播、GSLB</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>不要忘了检查监控服务的依赖项，如果监控都挂了，那还监控什么呢。</p>
<p><strong>各种检查：</strong></p>
<table>
<thead>
<tr>
<th>检查种类</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>可用性</td>
<td>能访问80端口吗？HTTP进程在运行吗？数据库能访问吗？</td>
</tr>
<tr>
<td>功能/既时</td>
<td>应用程序在请求数据库，OS在进行DNS查询，控制器在进行磁盘写入，负载均衡器在请求Web服务器</td>
</tr>
<tr>
<td>功能/模拟</td>
<td>模拟HTTP请求、DNS请求、发送邮件</td>
</tr>
<tr>
<td>质量/利用</td>
<td>CPU、内存、磁盘等硬件信息使用情况，可以知道机器是否有足够的处理能力</td>
</tr>
<tr>
<td>质量/效率</td>
<td>Squid缓存命中率</td>
</tr>
<tr>
<td>质量/吞吐</td>
<td>订阅数、登录数、请求数、进/出请求数，用户数，数据库连接数，活动连接数，实例数</td>
</tr>
<tr>
<td>环境</td>
<td>配置监控，安全监控，备份监控</td>
</tr>
<tr>
<td>可信性</td>
<td>邮件域的垃圾邮件防范级别，SSL证书</td>
</tr>
</tbody>
</table>
<p><br></p>
<p><strong>不同层级的检查：</strong></p>
<table>
<thead>
<tr>
<th>层级</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>业务</td>
<td>内部网管理站点</td>
</tr>
<tr>
<td>交易</td>
<td>登录、增加文档、分享链接、注销</td>
</tr>
<tr>
<td>服务</td>
<td>Mail、DNS、Web服务器、数据库、路由、防火墙</td>
</tr>
<tr>
<td>机器</td>
<td>服务器、CPU、内存、交换机</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h2 id="理解正常行为"><a href="#理解正常行为" class="headerlink" title="理解正常行为"></a>理解正常行为</h2><p><strong>即使你了解所有依赖项，但设计一个好的监控解决方案仍是要花时间的。需要根据业务实际需求和变化对监控实施改变。</strong></p>
<blockquote>
<p><strong>一些监控中的主要问题：</strong><br>如果多次报警基于同一个原因，应该只发送一次报警；<br>夜间，备份可能会在生产网络上产生很高的负载，这样由于响应时间的变慢而导致多个ping失败和其它可能的误报，从而产生起起伏伏的报警；<br>如果我们想要随时待命的支持人员，必须尽可能降低报警和误报的次数。</p>
</blockquote>
<p><br></p>
<p>加入的检查越多，消耗的生产系统的资源也就越多，这些资源可以是传送数据的带宽、计算结果的CPU…<br>你需要找到正确的平衡：监控太多只会浪费资源，从而降低对整个状况的了解；监控不足将导致不能及时报警。越靠近业务层的检查越有机会检测出问题，而越底层的检查越能够对发生的问题进行定位。</p>
<p>监控被认为是运维环境的一部分，通常是由系统或网络管理员来管理的。开始时是一个很小的系统，在后台运行。随着监控环境的扩大，需要执行更多的配置和定制。虽然运维人员常常是第一个对要部署的新软件进行仔细检查的人，他们的标准却往往并不应用到自己的监控系统上。监控系统是你的关键应用之一，请一视同仁。</p>
<p><br></p>
<p><strong>监控的最佳实践：</strong></p>
<table>
<thead>
<tr>
<th>实践</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>版本</td>
<td>对你的检查进行版本华，并把他们放入版本控制库中</td>
</tr>
<tr>
<td>不同环境</td>
<td>使用不同环境开发、测试新的检查</td>
</tr>
<tr>
<td>测试</td>
<td>将检查作为通常代码对待，在代码功能中加入测试</td>
</tr>
<tr>
<td>可使用性</td>
<td>创建一个所有组件及其关系的可视化总览图，指出失效和组件的关系对工程师很有帮助，只需要看一下仪表板就能明白问题出在哪里</td>
</tr>
<tr>
<td>信息架构</td>
<td>使用不同的数据表示法，将数据组织为层次结构以便于导航，同时还要避免信息过载</td>
</tr>
<tr>
<td>代码重用</td>
<td>如果能够重用所监控的应用程序中的业务逻辑，就不要自己写</td>
</tr>
<tr>
<td>无硬编码</td>
<td>避免将参数编码在脚本中，使用配置文件，这也易于脚本在不同环境中的迁移</td>
</tr>
<tr>
<td>部署</td>
<td>要易于部署和分发新的检查</td>
</tr>
<tr>
<td>备份/还原</td>
<td>备份监控数据，并了解在什么情况下需要还原</td>
</tr>
<tr>
<td>监控</td>
<td>监控你的监控系统</td>
</tr>
<tr>
<td>冗余</td>
<td>在监控上，使用高可用性的功能做维护工作</td>
</tr>
<tr>
<td>应用的安全规则</td>
<td>监控账号与其它事务账号分开 <br> 是用最小特权级 <br> 不要将密码保存为明文 <br> 限制对系统的访问，不要将其用于其它的测试 <br> 将监控系统用防火墙或代理系统保护起来，避免来自易受攻击的主机的访问</td>
</tr>
</tbody>
</table>
<p>所有信息一旦采集和存储，接下来做的就是分析检查结果。服务或系统的状态有<strong>可用(Up)</strong>和<strong>不可用(Down)</strong>，某些监控系统还增加了两个状态，一个用于<strong>系统不可达(Unreachable)</strong>，一个用于<strong>系统/服务尚未检查(Pending)</strong>。</p>
<p>有的时候，在位新服务建立环境时，预先定义的阈值很困难——实际使用可能会超过预期，或者相反。所以，对阈值进行不断的调优就有意义了。先根据理论上的假设定义一组阈值，然后在测试环境中模拟预期的行为，并翻译为技术化的组件使用情况。因为系统及使用情况的复杂性，对系统、应用程序、用户行为建立精确的模型是很困难的。所以，对阈值只能持续不断地研究与改进。趋势分析确实有助于定义阈值，大部分监控软件都可以让你对监控的值做趋势分析，而不产生报警，根据历史数据得出阈值之后，再启动报警设置。</p>
<p>管理报警并不仅仅是状态变化时发出报警信息。所有报警如果一直打开着的话，工程师将无法安心做系统支持，因为报警信息太多了，可能要被报警轰炸。同样，如果有太多假设报警，也会导致同样的问题，这可以看成是你的监控系统存在技术缺陷。<br>警报应该产生行动。如果一条警报可以忽略或不需要人工干预，这条报警就是一种浪费。然而，消除噪音却是真正的挑战。警报太多会导致<strong>狼来了</strong>效应，由于警报过载而忽略了正在重要的警报。</p>
<p>为了使网站可以忍受而限制报警是好的，但假如与业务需求不一致的话，就不行了。反之也是对的，如果业务不需要的话，为了显示网站运行正常而发送很多报警信息，也是毫无意义的。使监控保持正确的平衡，这很重要。</p>
<p><br><br><br></p>
<h2 id="有备而学"><a href="#有备而学" class="headerlink" title="有备而学"></a>有备而学</h2><p>一个人不可能在每个方面都是专家，有一个清晰定义的升级路径，从而把问题提交给更为专业的人员去处理是明智的。<br>对紧急报警进行跟踪和趋势分析，有助于提出架构和过程的改进建议。</p>
<p>故障时间本身并不仅仅有功能失效引起的，也可能是由于维护活动产生的。维护活动产生的故障时间被描述为维护窗口。在这种情况下，业务部门是认可默写故障时间的。为了避免不必要的报警，监控系统可能会在这段时间关闭报警。这会导致丢失一些与此次维护无关的系统/服务故障。所以，应该只关掉与维护相关的报警，而不是整个报警系统。然后，一旦服务运行稳定了，就要打开报警。</p>
<p><br><br><br></p>
<h2 id="结语-2"><a href="#结语-2" class="headerlink" title="结语"></a>结语</h2><p>监控并不是要保持服务器运行正常，也要保持业务运行正常。理解了技术组件和业务行为，你就会有相当的把握减少和修复问题上的时间。错误总是会发生的，但要为此做好准备。万一系统失效，一定要将反馈信息发送给每一个希望听到的人，并对事情做出改进，避免再发生新的错误。愿监控的力量与你同在。</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="复杂系统是如何失败的"><a href="#复杂系统是如何失败的" class="headerlink" title="复杂系统是如何失败的"></a>复杂系统是如何失败的</h1><p>所有复杂系统失败时，都有共同点。Web运维就是这样一个领域。</p>
<p><br><br><br></p>
<h2 id="复杂系统是如何失效的"><a href="#复杂系统是如何失效的" class="headerlink" title="复杂系统是如何失效的"></a>复杂系统是如何失效的</h2><ul>
<li>复杂系统本质上都是灾难系统</li>
<li>复杂系统都被重重地然而也是成功地防护着</li>
<li>灾难要求多点失效——单点失效是不够的</li>
<li>复杂系统包含潜藏在其中的缺陷的变化混合物</li>
<li>复杂系统以降级模式运行</li>
<li>灾难随时会发生</li>
<li>事后归结为”根本原因“是错误的</li>
<li>幕后认识对人类行为的时候评估存在偏见</li>
<li>人类操作员有双重角色：作为生产者，以及作为失效防护者</li>
<li>所有操作者的行为都是赌博</li>
<li>最为困难的行动解决了所有的模糊性</li>
<li>人类操作者是复杂系统的可调整因素</li>
<li>复杂系统中人类专门处理知识处于不断变化中</li>
<li>变化会引入新的失效</li>
<li>“原因”观点限制了对未来事件的有效防护</li>
<li>安全是系统的特性，而不是系统的组件</li>
<li>持续创造安全的是人</li>
<li>无事故的运维需要经历事故的历练</li>
</ul>
<p><br></p>
<p><strong>针对Web运维而言：</strong></p>
<ul>
<li>了解系统失效很困难</li>
<li>了解哪部分失效很困难</li>
<li>有意义的响应会被延迟</li>
<li>沟通会产生紧张，而脾气会冒火</li>
<li>维护会成为新的失效的主要源头</li>
<li>从备份中恢复本身就很困难，而且还有潜在的危险</li>
<li>创建测试过程，一线人员用来验证系统状态</li>
<li>对运维进行例行的每日管理</li>
<li>控制维护</li>
<li>定期对性能进行评估</li>
<li>要成为(独一无二)的用户</li>
</ul>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="社区管理与Web运维"><a href="#社区管理与Web运维" class="headerlink" title="社区管理与Web运维"></a>社区管理与Web运维</h1>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Operations/" rel="tag"># Operations</a>
          
            <a href="/tags/Database/" rel="tag"># Database</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/23/经济学原理读书笔记/" rel="next" title="《经济学原理》读书笔记">
                <i class="fa fa-chevron-left"></i> 《经济学原理》读书笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/leslie.jpg"
              alt="Zhang21" />
          
            <p class="site-author-name" itemprop="name">Zhang21</p>
            <p class="site-description motion-element" itemprop="description">踏踏实实谋发展</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/f13278e94ecb" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-circle-o"></i>简书</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:elite_zhang21@163.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#作为职业的运维"><span class="nav-number">1.</span> <span class="nav-text">作为职业的运维</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么运维如此艰难"><span class="nav-number">1.1.</span> <span class="nav-text">为什么运维如此艰难</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#扎实的计算背景"><span class="nav-number">1.1.1.</span> <span class="nav-text">扎实的计算背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#娴熟的决断力"><span class="nav-number">1.1.2.</span> <span class="nav-text">娴熟的决断力</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#沉稳的性格"><span class="nav-number">1.1.3.</span> <span class="nav-text">沉稳的性格</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从学徒到师傅"><span class="nav-number">1.2.</span> <span class="nav-text">从学徒到师傅</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#知识"><span class="nav-number">1.2.1.</span> <span class="nav-text">知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工具"><span class="nav-number">1.2.2.</span> <span class="nav-text">工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#经验"><span class="nav-number">1.2.3.</span> <span class="nav-text">经验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#纪律"><span class="nav-number">1.2.4.</span> <span class="nav-text">纪律</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何应用云计算-Elastic-Compute"><span class="nav-number">2.</span> <span class="nav-text">如何应用云计算(Elastic Compute)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么地方适合云计算"><span class="nav-number">2.1.</span> <span class="nav-text">什么地方适合云计算</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#混合计算"><span class="nav-number">2.1.1.</span> <span class="nav-text">混合计算</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么地方不适合云计算"><span class="nav-number">2.2.</span> <span class="nav-text">什么地方不适合云计算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结语"><span class="nav-number">2.3.</span> <span class="nav-text">结语</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基础架构与应用程序测量"><span class="nav-number">3.</span> <span class="nav-text">基础架构与应用程序测量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#时间刷新率和存留时间的考虑"><span class="nav-number">3.1.</span> <span class="nav-text">时间刷新率和存留时间的考虑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测量数据采集与存储的地点"><span class="nav-number">3.2.</span> <span class="nav-text">测量数据采集与存储的地点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测量数据的层次"><span class="nav-number">3.3.</span> <span class="nav-text">测量数据的层次</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#高层业务或功能特定的测量数据"><span class="nav-number">3.3.1.</span> <span class="nav-text">高层业务或功能特定的测量数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统及服务层面的测量数据"><span class="nav-number">3.3.2.</span> <span class="nav-text">系统及服务层面的测量数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为异常检测和报警提供环境"><span class="nav-number">3.4.</span> <span class="nav-text">为异常检测和报警提供环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志记录也是测量数据"><span class="nav-number">3.5.</span> <span class="nav-text">日志记录也是测量数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将变化管理和事件的时间线建立关联"><span class="nav-number">3.6.</span> <span class="nav-text">将变化管理和事件的时间线建立关联</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#给测量数据加入报警机制"><span class="nav-number">3.7.</span> <span class="nav-text">给测量数据加入报警机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用测量数据建立加载-反馈机制"><span class="nav-number">3.8.</span> <span class="nav-text">使用测量数据建立加载-反馈机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结语-1"><span class="nav-number">3.9.</span> <span class="nav-text">结语</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#连续部署"><span class="nav-number">4.</span> <span class="nav-text">连续部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#小批量意味着更快的反馈"><span class="nav-number">4.1.</span> <span class="nav-text">小批量意味着更快的反馈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小批量意味着问题即刻被本地化"><span class="nav-number">4.2.</span> <span class="nav-text">小批量意味着问题即刻被本地化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小批量能够减少风险"><span class="nav-number">4.3.</span> <span class="nav-text">小批量能够减少风险</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小批量可以降低总开销"><span class="nav-number">4.4.</span> <span class="nav-text">小批量可以降低总开销</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#质量卫士的挽歌"><span class="nav-number">4.5.</span> <span class="nav-text">质量卫士的挽歌</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么连续部署能行"><span class="nav-number">4.5.1.</span> <span class="nav-text">为什么连续部署能行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#让我们开始吧"><span class="nav-number">4.6.</span> <span class="nav-text">让我们开始吧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤1：连续集成服务器"><span class="nav-number">4.6.1.</span> <span class="nav-text">步骤1：连续集成服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤2：源代码控制提交检查"><span class="nav-number">4.6.2.</span> <span class="nav-text">步骤2：源代码控制提交检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤3：简单的部署脚本"><span class="nav-number">4.6.3.</span> <span class="nav-text">步骤3：简单的部署脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤4：实时报警"><span class="nav-number">4.6.4.</span> <span class="nav-text">步骤4：实时报警</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤5：根本原因分析"><span class="nav-number">4.6.5.</span> <span class="nav-text">步骤5：根本原因分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连续部署用于关键应用"><span class="nav-number">4.7.</span> <span class="nav-text">连续部署用于关键应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#作为代码的基础架构"><span class="nav-number">5.</span> <span class="nav-text">作为代码的基础架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#面向服务体系结构"><span class="nav-number">5.1.</span> <span class="nav-text">面向服务体系结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置管理"><span class="nav-number">5.1.1.</span> <span class="nav-text">配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置管理是策略驱动的"><span class="nav-number">5.1.2.</span> <span class="nav-text">配置管理是策略驱动的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统自动化就是用代码实现配置管理策略"><span class="nav-number">5.1.3.</span> <span class="nav-text">系统自动化就是用代码实现配置管理策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统管理中的配置管理"><span class="nav-number">5.1.4.</span> <span class="nav-text">系统管理中的配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统集成"><span class="nav-number">5.1.5.</span> <span class="nav-text">系统集成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#监控"><span class="nav-number">6.</span> <span class="nav-text">监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#理解你在监控什么"><span class="nav-number">6.1.</span> <span class="nav-text">理解你在监控什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#理解正常行为"><span class="nav-number">6.2.</span> <span class="nav-text">理解正常行为</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#有备而学"><span class="nav-number">6.3.</span> <span class="nav-text">有备而学</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结语-2"><span class="nav-number">6.4.</span> <span class="nav-text">结语</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#复杂系统是如何失败的"><span class="nav-number">7.</span> <span class="nav-text">复杂系统是如何失败的</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#复杂系统是如何失效的"><span class="nav-number">7.1.</span> <span class="nav-text">复杂系统是如何失效的</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#社区管理与Web运维"><span class="nav-number">8.</span> <span class="nav-text">社区管理与Web运维</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang21</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 165.3k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2018/03/05/网站运维/';
          this.page.identifier = '2018/03/05/网站运维/';
          this.page.title = '《网站运维》读书笔记';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
