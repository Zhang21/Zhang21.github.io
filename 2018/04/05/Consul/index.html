<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Consul," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="参考：  https://www.consul.io/intro/index.html https://www.consul.io/docs/ Consul Template: https://www.hashicorp.com/blog/introducing-consul-template  环境：  CentOS7x86_64 Consul v1.2.0">
<meta name="keywords" content="Consul">
<meta property="og:type" content="article">
<meta property="og:title" content="Consul">
<meta property="og:url" content="https://zhang21.github.io/2018/04/05/Consul/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考：  https://www.consul.io/intro/index.html https://www.consul.io/docs/ Consul Template: https://www.hashicorp.com/blog/introducing-consul-template  环境：  CentOS7x86_64 Consul v1.2.0">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-06-29T10:12:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Consul">
<meta name="twitter:description" content="参考：  https://www.consul.io/intro/index.html https://www.consul.io/docs/ Consul Template: https://www.hashicorp.com/blog/introducing-consul-template  环境：  CentOS7x86_64 Consul v1.2.0">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2018/04/05/Consul/"/>





  <title>Consul | 风继续吹</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2018/04/05/Consul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang21">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Consul</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-05T22:08:11+08:00">
                2018-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/05/Consul/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/05/Consul/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  8,497
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考：</p>
<ul>
<li><a href="https://www.consul.io/intro/index.html" target="_blank" rel="noopener">https://www.consul.io/intro/index.html</a></li>
<li><a href="https://www.consul.io/docs/" target="_blank" rel="noopener">https://www.consul.io/docs/</a></li>
<li>Consul Template: <a href="https://www.hashicorp.com/blog/introducing-consul-template" target="_blank" rel="noopener">https://www.hashicorp.com/blog/introducing-consul-template</a></li>
</ul>
<p>环境：</p>
<ul>
<li>CentOS7x86_64</li>
<li>Consul v1.2.0</li>
</ul>
<p><br><br><br></p>
<a id="more"></a>
<hr>
<p><br></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>介绍consul是什么，它可以解决哪些问题，以及如何开始使用它。</p>
<p><br></p>
<h2 id="Consul是什么"><a href="#Consul是什么" class="headerlink" title="Consul是什么"></a>Consul是什么</h2><p>Consule有多个组件，但总体而言，它是发现(discovery)和配置(config)基础架构(infrastructure)服务的工具。它提供几个关键特点：</p>
<ul>
<li>服务发现(service discovery)<ul>
<li>Consul客户端可提供一个服务，如API或mysql，其它客户端能够使用Consul来发现给定服务的提供者。使用DNS或HTTP，应用程序可以轻松找到他们所依赖的服务</li>
</ul>
</li>
<li>健康检查(health checking)<ul>
<li>Consul可以提供任何数量的健康检查，既可以与给定服务相关联(webserver return 200)，也可与本地节点(内存使用率小于90%)相关联。操作人员可用此信息来监视集群运行状况，服务发现组件使用此信息将流量(traffic)从不健康的主机中引导出去</li>
</ul>
</li>
<li>KV store<ul>
<li>应用程序可将Consul的分层Key/Value用于存储任何目的，包括动态配置(dynamic configuration)、功能标记(feature flagging)、协调(coordination)、领导选举(leader election)…简单的HTTP API使其易于使用</li>
</ul>
</li>
<li>多数据中心(Multi Datacenter)<ul>
<li>Consul支持多数据中心，这意味着Consul的用户不必担心构建额外的抽象层以扩展到多个区域</li>
</ul>
</li>
</ul>
<p>Consul旨在与DevOps和应用程序开发者保持友好，使其成为现代化 ，弹性基础架构的完美选择。</p>
<p><br><br><br></p>
<h2 id="Consul用例"><a href="#Consul用例" class="headerlink" title="Consul用例"></a>Consul用例</h2><ul>
<li><p>服务发现(service )<br>服务注册，集成健康检查，使用DNS或HTTP接口使得任何服务都能被其它服务发现。</p>
</li>
<li><p>服务分割(service segmentation)<br>通过自动TLS加密和基于身份的授权实现安全的服务到服务通信。</p>
</li>
<li><p>服务配置(service configuration)<br>功能丰富的 key/value 可轻易配置服务。</p>
</li>
</ul>
<p><br><br><br></p>
<h2 id="Consul基础架构"><a href="#Consul基础架构" class="headerlink" title="Consul基础架构"></a>Consul基础架构</h2><p>Consul是一个分布式、高可用的系统。</p>
<p>每一个向Consul提供服务的节点都运行一个Consul agent。运行agent对于服务发现或get/set Key/Value不是必需的。agent负责健康检查节点上的服务和节点自身。</p>
<p>agent可与一个或多个Consul server交流。Consul server是数据存储和复制集所在之地。server之间选出一个leader。虽然Consul可以使用一台服务器，但推荐使用3-5台以避免数据丢失的故障情况。对每一个数据中心都推荐使用Consul server cluster。</p>
<p>需要发现其它服务或节点的基础架构组件 可以查询任何Consul server或Consul agent。agent自动将查询发送到server。</p>
<p>每个数据中心运行一组consul server cluster。当发生cross-datacenter服务发现或配置请求时，本地consul server将请求转发给远程数据中心并返回结果。</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h1><h2 id="安装Consul"><a href="#安装Consul" class="headerlink" title="安装Consul"></a>安装Consul</h2><ul>
<li>二进制包: <a href="https://www.consul.io/downloads.html" target="_blank" rel="noopener">https://www.consul.io/downloads.html</a><ul>
<li>解压缩，得到一个consul二进制可执行文件，可将其放入系统路径</li>
</ul>
</li>
<li>验证安装: <code>consul</code></li>
</ul>
<p><br><br><br></p>
<h2 id="运行consul-agent"><a href="#运行consul-agent" class="headerlink" title="运行consul-agent"></a>运行consul-agent</h2><p>安装consul后请务必运行agent，agent可运行在server或client模式。每个datacenter必须至少有一台server，推荐3-5台做一个集群。单一server部署非常不安全，在故障情况下数据丢失就不可避免了。</p>
<p>所有其它agents都以client模式运行。client是一个非常轻量化的进程——它注册服务、运行健康检查、转发查询给server。agent必须运行在集群的每个节点上。</p>
<p><br></p>
<h3 id="启动agent"><a href="#启动agent" class="headerlink" title="启动agent"></a>启动agent</h3><p>测试consul development模式，不建议在生产环境使用此方法，此处做测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev</span><br><span class="line"></span><br><span class="line">netstat -nltp</span><br><span class="line"></span><br><span class="line">#可根据日志看出agent已成为server，并成为集群leader</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Consul成员"><a href="#Consul成员" class="headerlink" title="Consul成员"></a>Consul成员</h3><p><code>members</code>命令基于<code>gossip protocol</code>并最终保持一致。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">consul members</span><br><span class="line"></span><br><span class="line">#节点名称、监听地址、健康状态、集群角色、版本信息</span><br><span class="line">Node     Address         Status  Type    Build  Protocol  DC   Segment</span><br><span class="line">zhang22  127.0.0.1:8301  alive   server  1.0.6  2         dc1  &lt;all&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使用HTTP API将请求转发给server以获取一致的view of world</span><br><span class="line">culr localhost:8500/v1/catalog/nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#DNS interface也可以查询节点，默认端口8600</span><br><span class="line">dig @127.0.0.1 -p 8600 zhang22.node.consul</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="停止agent"><a href="#停止agent" class="headerlink" title="停止agent"></a>停止agent</h3><p>可使用<code>Ctrl + C</code>优雅地终止agent，你可以看到它离开集群并关闭。</p>
<p>优雅关闭，Consul会通知集群其它节点此节点的离开。如果你强制kill agent，则集群的其它节点将检测该节点失败。<br>当成员离开时，其服务和健康检查将从catalog中移除。当成员失败时，其健康状态被标记为critical，但不会从catalog中移除。<br>Consul会自动尝试重连失败的节点，允许它从当前网络条件中修复，知道离开的节点不在联系。</p>
<p>此外，如果agent正作为server在运行，那么优雅地离开对避免造成严重的影响有帮助。</p>
<p><br><br><br></p>
<h2 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h2><p>注册(register)服务并查询(query)服务。</p>
<p><br></p>
<h3 id="定义一个服务"><a href="#定义一个服务" class="headerlink" title="定义一个服务"></a>定义一个服务</h3><p>服务可以通过以下两种方法注册：</p>
<ul>
<li>服务定义(service definition)</li>
<li>调用HTTP API</li>
</ul>
<p>服务定义是注册服务最常见的方式，我们将构建前面agent的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#创建一个consul配置目录</span><br><span class="line">mkdir /etc/consul.d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#编写服务定义配置文件</span><br><span class="line">#假设有一个web服务运行在80端口，添加一个便于query的tag</span><br><span class="line">echo &apos;&#123;&quot;service&quot;: &#123;&quot;name: &quot;web&quot;, &quot;tag&quot;: [&quot;rails&quot;], &quot;port&quot;: 80 &#125;&#125;&apos; | tee /etc/consul.d/web.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重启agent，指定配置目录</span><br><span class="line">consul agent -dev -config-dir=/etc/consul.d</span><br></pre></td></tr></table></figure>
<p>如果你想注册多个服务，你可以在配置目录下创建多个服务定义文件。</p>
<p><br></p>
<h3 id="查询服务"><a href="#查询服务" class="headerlink" title="查询服务"></a>查询服务</h3><p>一旦agent启动并且服务已同步，我们可通过HTTP API或DNS查询(query)服务。</p>
<p><br></p>
<p><strong>DNS API</strong><br>使用DNS API(默认8600)查询服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#DNS name(默认) -- NAME.service.consul</span><br><span class="line"></span><br><span class="line">#只有IP</span><br><span class="line">dig @127.0.0.1 -p 8600 web.service.consul</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#返回IP/Port</span><br><span class="line">dig @127.0.0.1 -p 8600 web.service.consul SRV</span><br></pre></td></tr></table></figure>
<p>我们还可以用DNS API按tag来过滤service。基于标签的查询格式为<code>tag.name.service.consul</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @127.0.0.1 -p 8600 rails.web.service.consul</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>HTTP API</strong><br>除了DNS API，HTTP API(默认8500)同样可用于查询服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#前面定义了web这个service</span><br><span class="line">curl http://localhost:8500/v1/catalog/service/web</span><br></pre></td></tr></table></figure>
<p>catalog API提供了给定服务的所有节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#仅仅健康实例的查询</span><br><span class="line"> curl &apos;http://localhost:8500/v1/health/service/web?passing&apos;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="更新服务"><a href="#更新服务" class="headerlink" title="更新服务"></a>更新服务</h3><p>服务定义可以通过更改配置文件并向agent发送SIGHUP来更新。这使得更新服务不会出现任何停机或查询服务不可达的情况。</p>
<p>另外，HTTP API能够用来动态地添加、移除、修改服务。</p>
<p><br><br><br></p>
<h2 id="Consul集群"><a href="#Consul集群" class="headerlink" title="Consul集群"></a>Consul集群</h2><p>具有多个成员的consul集群。</p>
<p>当consul节点启动时，它不知道任何其它节点，它是一个孤立的集群。为了了解到集群中的其它成员，agent必须要加入一个存在的集群。要加入一个现有的集群，只需知道一个现有成员。当加入集群后，agent将于其此成员闲聊，并迅速发现集群中的其它成员。一个agent可以加入任何其它agent，而不仅仅是server模式的agent。</p>
<p><br></p>
<h3 id="启动agents"><a href="#启动agents" class="headerlink" title="启动agents"></a>启动agents</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#node1</span><br><span class="line">consul agent -server -bootstrap-expect=1 \</span><br><span class="line">    -data-dir=/tmp/consul -node=agent-one -bind=ip1 \</span><br><span class="line">    -enable-script-checks=true -config-dir=/etc/consul.d</span><br><span class="line"></span><br><span class="line">#node2</span><br><span class="line">consul agent -data-dir=/tmp/consul -node=agent-two \</span><br><span class="line">    -bind=ip2 -enable-script-checks=true -config-dir=/etc/consul.d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#两个独立的node</span><br><span class="line"></span><br><span class="line">#现在，我们有两个agent在运行中：一个server，一个client。但是他们两者并不知道对方，并仍然是一个单一节点的集群。</span><br><span class="line">#查看节点</span><br><span class="line">consul member</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="加入集群"><a href="#加入集群" class="headerlink" title="加入集群"></a>加入集群</h2><p>由于我们在启动agent的时候便已指定server，所以从哪个节点加入都一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">consul join ip</span><br><span class="line">#Successfully joined cluster by contacting 1 nodes.</span><br><span class="line"></span><br><span class="line">consul members</span><br><span class="line"></span><br><span class="line">Node       Address              Status  Type    Build  Protocol  DC   Segment</span><br><span class="line">agent-one  172.16.129.141:8301  alive   server  1.0.6  2         dc1  &lt;all&gt;</span><br><span class="line">agent-two  172.16.129.150:8301  alive   client  1.0.6  2         dc1  &lt;default&gt;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="在启动时自动加入集群"><a href="#在启动时自动加入集群" class="headerlink" title="在启动时自动加入集群"></a>在启动时自动加入集群</h3><p>理想情况下，每当一个新节点出现在数据中心时，它应该自动加入集群而不需要人工干预。</p>
<p><br><br><br></p>
<h3 id="查询节点"><a href="#查询节点" class="headerlink" title="查询节点"></a>查询节点</h3><p>就像查询服务，consul有一个API用于查询节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#NAME.node.consul或NAME.node.DATACENTER.conosul</span><br><span class="line">dig @localhost -p 8600 agent-one.node.consul</span><br><span class="line">dig @127.0.0.1 -p 8600 agent-two.node.consul</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="离开集群"><a href="#离开集群" class="headerlink" title="离开集群"></a>离开集群</h3><ul>
<li>优雅的退出: <code>Ctrl+C</code></li>
<li>强制<code>kill</code></li>
</ul>
<p><br><br><br></p>
<h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><p>对节点和服务添加健康检查(health check)。<br>健康检查是服务发现的关键组件，可以防止使用不健康的服务。</p>
<p><br></p>
<h3 id="定义检查"><a href="#定义检查" class="headerlink" title="定义检查"></a>定义检查</h3><p>与服务类似，一个检查能够通过定义检查或适当调用HTTP API来两种方式来注册。</p>
<p>定义<strong>检查</strong>是一个最基本和推荐的方法。</p>
<p>在consul配置目录中创建检查定义文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#在基于脚本的健康检查上，它与consul进程使用同样的用户</span><br><span class="line">#如果命令以非0状态码退出，则该节点会被标记为unhealthy</span><br><span class="line"></span><br><span class="line">echo &apos;&#123;&quot;check&quot;: &#123;&quot;name&quot;: &quot;ping&quot;, &quot;args&quot;: [&quot;ping&quot;, &quot;-c1&quot;, &quot;baidu.com&quot;], &quot;interval&quot;: &quot;30s&quot;&#125;&#125;&apos; &gt;/etc/consul.d/ping.json</span><br><span class="line"></span><br><span class="line">echo &apos;&#123;&quot;service&quot;: &#123;&quot;name&quot;: &quot;web&quot;, &quot;tags&quot;: [&quot;rails&quot;], &quot;port&quot;: 80, &quot;check&quot;: &#123;&quot;args&quot;: [&quot;curl&quot;, &quot;localhost&quot;], &quot;interval&quot;: &quot;10s&quot;&#125;&#125;&#125;&apos; &gt;/etc/consul.d/web.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">consul reload</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="检查健康状态"><a href="#检查健康状态" class="headerlink" title="检查健康状态"></a>检查健康状态</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8500/v1/health/state/critical</span><br><span class="line"></span><br><span class="line">dig @127.0.0.1 -p 8600 web.service.consul</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="KV数据"><a href="#KV数据" class="headerlink" title="KV数据"></a>KV数据</h2><p>Consul提供了一个易于使用的KV存储。这可以用来保存动态配置，协助服务协调，构建leader选举，并启用开发人员可以考虑构建的任何其它内容。</p>
<p><br></p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>有两种方法与Consul K/V交互的方式：</p>
<ul>
<li>HTTP API</li>
<li>Consul KV CLI</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#CLI</span><br><span class="line">consul kv --help</span><br><span class="line"></span><br><span class="line">consul kv put name zhang</span><br><span class="line">consul kv get name</span><br><span class="line">#zhang</span><br><span class="line"></span><br><span class="line">consul kv get -detailed name</span><br><span class="line"></span><br><span class="line">consul kv puut -flags=42 who zhang21</span><br><span class="line">#所有key都支持设置一个64位的整数标志值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#列出所有kv</span><br><span class="line">consul kv get -recurse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除</span><br><span class="line">consul kv delete name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使用 Check-And-Set 进行原子更新</span><br><span class="line">consul kv put -cas -modify-index=112 NAME zhang</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#导出与导入</span><br><span class="line">consul kv export &gt; xxx.json</span><br><span class="line"></span><br><span class="line">consul kv import $xxx.json</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="Web界面"><a href="#Web界面" class="headerlink" title="Web界面"></a>Web界面</h2><p>Consul支持美观的Web界面。用户界面可以查看所有的服务和节点，查看所有健康检查和当前状态，读取和设置kv数据，并自动支持多数据中心。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">consul agent -ui</span><br><span class="line"></span><br><span class="line">#localhost:8500/ui</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h1><h2 id="启动和停止"><a href="#启动和停止" class="headerlink" title="启动和停止"></a>启动和停止</h2><p>Consul Agent是Consul的核心进程。它维护成员关系信息，注册服务，运行检查，响应查询…<br>Consul Agent必须运行在在Consul集群的每个节点上。</p>
<p>Agent有两种运行模式：</p>
<ul>
<li>server</li>
<li>client</li>
</ul>
<p>Server节点承担了作为<strong>consensus quorum(共识法人)</strong>的额外责任，这些节点参与Raft，并在出现故障时提供强大的一致性和可用性。<br>Client节点构成了集群的大部分，它们非常轻便。因为它们与Server进行大部分操作，保持自己的状态则很少。</p>
<p><br></p>
<p><strong>运行Agent</strong><br>以下是一些重要信息：</p>
<ul>
<li>Node name</li>
<li>Datacenter</li>
<li>Server</li>
<li>Client addr</li>
<li>Cluster addr</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接指定配置项运行</span></span><br><span class="line">consul agent -options</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#将配置项写入文件，指定配置目录运行</span></span><br><span class="line">mkdir /etc/consul.d</span><br><span class="line">vim /etc/consul.d/consul.json</span><br><span class="line"></span><br><span class="line">consul agent -config-dir=/etc/consul.d</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>停止Agent</strong><br>有两种停止方式：</p>
<ul>
<li><p>gracefully<br>发送中断信号<code>ctrl+c</code>或运行<code>kill -INT</code>。优雅地退出，Agent首先通知集群它要离开集群。这样，集群便会通知其它成员该节点已离开。</p>
</li>
<li><p>forcefully<br>通过<code>kill signal</code>来强制杀掉Consul。集群的其余部分最终会检测到该节点已死亡并通知集群节点已失效。</p>
</li>
</ul>
<p>特别重要的是允许Server节点优雅地离开，以便对可用性产生最小的影响。<br>对于Client Agent来说，节点失效和节点离开的区别对用例并不是那么重要。</p>
<p><br></p>
<p><strong>生命周期</strong><br>Consul集群中的每个Agent都会经历一个生命周期(lifecycle)。<br>当Agent首次启动时，他并不知道集群中的其它任何节点。要发现它的同伴，它必须加入集群。这使用<code>join</code>命令或在配置文件中配置。一旦一个节点加入，这个信息就会传递给整个集群，这意味着所有节点最终都会意识到对方。<br>如果Agent是一个Server，则已经存在的Server就会开始复制(replicating)到新节点。</p>
<p>在网络故障的情况下，某些节点可能无法被其它节点访问。在这种情况下，无法访问的节点被标记为失败(failed)。无法区分网络故障和Agent崩溃，因此两种情况的处理方式都是相同的。该信息将在service catalog中被更新。</p>
<p>当一个节点离开时，它指定了它的意图，并且集群将该节点标记为已离开。与失败(failed)不同，节点提供的所有服务都立即注销(deregistered)。如果Agent是Server，则对其的复制(replication)将停止。</p>
<p>为了防止死亡(failed/left)节点的堆积，Consul会自动将死亡节点从目录中移除。这个过程被称为<strong>收割(reaping)</strong>。</p>
<p><br><br><br></p>
<h2 id="DNS接口"><a href="#DNS接口" class="headerlink" title="DNS接口"></a>DNS接口</h2><p>DNS接口允许应用程序利用服务发现，而无需与Consul进行高度整合。</p>
<p>有几个重要的配置项：</p>
<ul>
<li><code>client_addr</code></li>
<li><code>ports.dns</code></li>
<li><code>recursors</code></li>
<li><code>domain</code></li>
<li><code>dns_config</code></li>
</ul>
<p><strong>数据中心部分是可选的，如果没有提供，则默认为Agent自身的数据中心。</strong></p>
<p><br></p>
<p><strong>节点查找</strong><br>为了解析名称(name)，Consul依赖于特定的查询格式。基本上有两种类型的查询：</p>
<ul>
<li>node lookup</li>
<li>service lookup</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#node lookup</span><br><span class="line">&lt;node&gt;.node[.datacenter].&lt;domain&gt;</span><br><span class="line"></span><br><span class="line">node1.node.dc1.consul</span><br><span class="line">node1.node.consul</span><br><span class="line"></span><br><span class="line">dig @127.0.0.1 -p 8600 node1.node.consul</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>服务查找</strong><br>服务查找用于查询你服务提供者。</p>
<p>有两种查询方式：</p>
<ul>
<li>标准查询<br>DNS查询系统利用健康检查信息来防止路由到不健康的节点。为了实现简单的负载均衡，每次返回的节点集都是随机的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[tag.]&lt;service&gt;.service[.datacenter].&lt;domain&gt;</span><br><span class="line"></span><br><span class="line">redis.service.consul</span><br><span class="line">postgresql.service.dc2.consul</span><br><span class="line"></span><br><span class="line">dig @127.0.0.1 -p 8600 redis.service.consul SRV</span><br></pre></td></tr></table></figure>
<ul>
<li>RFC 2782查询<br>RFC 2782使用<code>_</code>下划线作为查询中服务和协议值的前缀，以防止DNS冲突。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_&lt;service&gt;._&lt;protocol&gt;[.service][.datacenter][.domain]</span><br><span class="line"></span><br><span class="line">dig @127.0.0.1 -p 8600 _rabbitmq._amqp.service.consul SRV</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Prepared Query Lookups</strong><br>The query or name is the ID or given name of an existing Prepared Query.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;query or name&gt;.query[.datacenter].&lt;domain&gt;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>可连接的服务查找</strong><br>Connect-Capable Service Lookups.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;service&gt;.connect.&lt;domain&gt;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Caching</strong><br>默认情况下，Consul服务的所有DNS结果都会设置一个为0的TTL。这回禁用DNS结果的缓存。但，很多情况下，缓存对性能和伸缩性都是可去的。</p>
<p><br></p>
<p><strong>WAN地址转换</strong><br>默认情况下，Consul DNS查询将会返回一个节点的本地地址。如果你需要外部地址，则可使用<code>advertise-wan</code>和<code>translate_wan_addrs</code>选项来配置此行为。</p>
<p><br><br><br></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Agent有许多通过命令行或配置文件配置的配置项。配置优先级如下：</p>
<ol>
<li>命令行参数</li>
<li>环境变量</li>
<li>配置文件</li>
</ol>
<p>配置文件可以是<strong>HCL</strong>或<strong>JSON</strong>格式。<br>Consul可通过<code>reload</code>命令重新载入配置文件。</p>
<p><br><br><br></p>
<h3 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h3><p>Consul默认使用的端口：</p>
<ul>
<li><p>8300(tcp)<br>Server RPC. Server用于处理来自其它Agent的传入请求。</p>
</li>
<li><p>8301(tcp/udp)<br>Serf LAN. 用于处理LAN中的gossip，所有Agent都需要。</p>
</li>
<li><p>8302(tcp/udp)<br>Serf WAN. Server用于处理WAN上gossip到其它Server。</p>
</li>
<li><p>8500(tcp)<br>HTTP API.</p>
</li>
<li><p>8600(tcp/udp)<br>DNS Interface.</p>
</li>
</ul>
<p><br><br><br></p>
<h3 id="可重新加载的配置"><a href="#可重新加载的配置" class="headerlink" title="可重新加载的配置"></a>可重新加载的配置</h3><p>Reloadable Configuration</p>
<p>重新加载配置文件不会加载所有配置项，如下这些配置项是可重新载入的：</p>
<ul>
<li>log level</li>
<li>checks</li>
<li>services</li>
<li>watches</li>
<li>http client address</li>
<li>node metadata</li>
<li>metric prefix filter</li>
<li>discard check output</li>
<li>rpc rate limiting</li>
</ul>
<p><br><br><br></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件不仅用于设置代理，还用于提供检查和服务定义。</p>
<p>配置文件选项和命令行参数稍微有点不一样。<br>使用<code>consul agent -h</code>查看具体配置项。</p>
<p>栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#开始栗子</span><br><span class="line">vim /etc/consul.d/service.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;bind_addr&quot;: &quot;192.168.1.11&quot;,</span><br><span class="line">&quot;client_addr&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">&quot;datacenter&quot;: &quot;zhang&quot;,</span><br><span class="line">&quot;data_dir&quot;: &quot;/var/lib/consul&quot;,</span><br><span class="line">&quot;log_level&quot;: &quot;WARN&quot;,</span><br><span class="line">&quot;node_name&quot;: &quot;zhang21&quot;,</span><br><span class="line">&quot;server&quot;: true,</span><br><span class="line">&quot;enable_syslog&quot;: true,</span><br><span class="line">&quot;ui&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#集群配置</span><br><span class="line">vim /etc/consul.d/service.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;bind_addr&quot;: &quot;xxx&quot;;</span><br><span class="line">	&quot;client_addr&quot;: &quot;0.0.0.0&quot;;</span><br><span class="line">	&quot;datacenter&quot;: &quot;zhang&quot;;</span><br><span class="line">	&quot;data_dir&quot;: &quot;/var/lib/consul&quot;;</span><br><span class="line">	&quot;encrypt&quot;: &quot;a1b8vAA2==@xyz&quot;,</span><br><span class="line">	&quot;log_level&quot;: &quot;WARN&quot;,</span><br><span class="line">	&quot;node_name&quot;: &quot;zhang21&quot;,</span><br><span class="line">	&quot;node_id&quot;: &quot;zhang21&quot;,</span><br><span class="line">	&quot;server&quot;: true,</span><br><span class="line">	&quot;enable_syslog&quot;: true,</span><br><span class="line">	&quot;ui&quot;: true,</span><br><span class="line">	&quot;retry_interval&quot;: 20s,</span><br><span class="line">	&quot;retry_join&quot;: [</span><br><span class="line">		&quot;consul.domain.internal&quot;,</span><br><span class="line">		&quot;10.0.1.2:8301&quot;,</span><br><span class="line">		&quot;[::1]:8301&quot;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="服务定义"><a href="#服务定义" class="headerlink" title="服务定义"></a>服务定义</h2><p>服务发现的主要目标之一是提供可用服务的目录(catalog)。为此，Agent提供了一种简单的服务定义格式来声明服务的可用性，并可能将其与健康检查相关联。如果健康检查与服务关联，则认为它是应用程序级别。</p>
<p><br></p>
<h3 id="服务定义-1"><a href="#服务定义-1" class="headerlink" title="服务定义"></a>服务定义</h3><p>服务定义方式：</p>
<ul>
<li>配置文件(推荐)</li>
<li>HTTP API</li>
</ul>
<p>一个服务定义包含的字段：</p>
<ul>
<li>name(必须)</li>
<li>id(可选)</li>
<li>tags(可选)</li>
<li>address(可选)</li>
<li>port(可选)</li>
<li>check(可选)</li>
<li>meta(可选)</li>
<li><code>enable_tag_override</code>(可选)</li>
<li>token(可选)</li>
</ul>
<p>id必须唯一，如果未设置id，默认使用name。</p>
<p><br></p>
<p>服务可以关联健康检查，这是一个强大的功能。<br>检查必须是脚本、HTTP、TCP或TTL类型。</p>
<ul>
<li>脚本类型，必须提供参数和间隔</li>
<li>HTTP类型，必须提供http和interval</li>
<li>TCP类型，必须提供tcp和interval</li>
<li>TTL类型，只能提供ttl</li>
</ul>
<p>检查名称自动生成为: <code>service:&lt;service-id&gt;</code>，如果有多个服务检查注册，生成的id为： <code>service:&lt;service:-id&gt;:&lt;num&gt;</code>，num是从1开始递增的数字。</p>
<p><br></p>
<p>栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/consul.d/redis.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;service&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;redis&quot;,</span><br><span class="line">    &quot;tags&quot;: [&quot;primary&quot;],</span><br><span class="line">    &quot;address&quot;: &quot;&quot;,</span><br><span class="line">    &quot;meta&quot;: &#123;</span><br><span class="line">      &quot;meta&quot;: &quot;for my service&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;port&quot;: 8000,</span><br><span class="line">    &quot;enable_tag_override&quot;: false,</span><br><span class="line">    &quot;checks&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;args&quot;: [&quot;/usr/local/bin/check_redis.py&quot;],</span><br><span class="line">        &quot;interval&quot;: &quot;10s&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;connect&quot;: &#123;</span><br><span class="line">      &quot;native&quot;: false,</span><br><span class="line">      &quot;proxy&quot;: &#123;</span><br><span class="line">        &quot;command&quot;: [],</span><br><span class="line">        &quot;config&quot;: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="多个服务定义"><a href="#多个服务定义" class="headerlink" title="多个服务定义"></a>多个服务定义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;services&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;red0&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;redis&quot;,</span><br><span class="line">      &quot;tags&quot;: [</span><br><span class="line">        &quot;primary&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;address&quot;: &quot;&quot;,</span><br><span class="line">      &quot;port&quot;: 6000,</span><br><span class="line">      &quot;checks&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;args&quot;: [&quot;/bin/check_redis&quot;, &quot;-p&quot;, &quot;6000&quot;],</span><br><span class="line">          &quot;interval&quot;: &quot;5s&quot;,</span><br><span class="line">          &quot;ttl&quot;: &quot;20s&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;red1&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;redis&quot;,</span><br><span class="line">      &quot;tags&quot;: [</span><br><span class="line">        &quot;delayed&quot;,</span><br><span class="line">        &quot;secondary&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;address&quot;: &quot;&quot;,</span><br><span class="line">      &quot;port&quot;: 7000,</span><br><span class="line">      &quot;checks&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;args&quot;: [&quot;/bin/check_redis&quot;, &quot;-p&quot;, &quot;7000&quot;],</span><br><span class="line">          &quot;interval&quot;: &quot;30s&quot;,</span><br><span class="line">          &quot;ttl&quot;: &quot;60s&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="检查定义"><a href="#检查定义" class="headerlink" title="检查定义"></a>检查定义</h2><p>Agent的主要角色便是管理系统级和应用级的健康检查。<br>一个检查的定义有两种方式：</p>
<ul>
<li>配置文件</li>
<li>HTTP API</li>
</ul>
<p><br></p>
<p>检查方式：</p>
<ul>
<li>Script + Interval</li>
<li>HTTP + Interval</li>
<li>TCP + Interval</li>
<li>TTL</li>
<li>Docker + Interval</li>
<li>gRPC + Interval</li>
</ul>
<p><br></p>
<h3 id="定义检查-1"><a href="#定义检查-1" class="headerlink" title="定义检查"></a>定义检查</h3><p>A script check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;mem-util&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;Memory utilization&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;/usr/local/bin/check_mem.py&quot;, &quot;-limit&quot;, &quot;256MB&quot;],</span><br><span class="line">    &quot;interval&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;timeout&quot;: &quot;1s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>A HTTP check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;api&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;HTTP API on port 5000&quot;,</span><br><span class="line">    &quot;http&quot;: &quot;https://localhost:5000/health&quot;,</span><br><span class="line">    &quot;tls_skip_verify&quot;: false,</span><br><span class="line">    &quot;method&quot;: &quot;POST&quot;,</span><br><span class="line">    &quot;header&quot;: &#123;&quot;x-foo&quot;:[&quot;bar&quot;, &quot;baz&quot;]&#125;,</span><br><span class="line">    &quot;interval&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;timeout&quot;: &quot;1s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>A TCP check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;ssh&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;SSH TCP on port 22&quot;,</span><br><span class="line">    &quot;tcp&quot;: &quot;localhost:22&quot;,</span><br><span class="line">    &quot;interval&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;timeout&quot;: &quot;1s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>A TTL check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;web-app&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;Web App Status&quot;,</span><br><span class="line">    &quot;notes&quot;: &quot;Web app does a curl internally every 10 seconds&quot;,</span><br><span class="line">    &quot;ttl&quot;: &quot;30s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>A Docker check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;mem-util&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;Memory utilization&quot;,</span><br><span class="line">    &quot;docker_container_id&quot;: &quot;f972c95ebf0e&quot;,</span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;/usr/local/bin/check_mem.py&quot;],</span><br><span class="line">    &quot;interval&quot;: &quot;10s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>A gRPC check:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;mem-util&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;Service health status&quot;,</span><br><span class="line">    &quot;grpc&quot;: &quot;127.0.0.1:12345&quot;,</span><br><span class="line">    &quot;grpc_use_tls&quot;: true,</span><br><span class="line">    &quot;interval&quot;: &quot;10s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="检查脚本"><a href="#检查脚本" class="headerlink" title="检查脚本"></a>检查脚本</h3><p>使用<code>enable_script_checks</code>选项来启用脚本检查。</p>
<p>检查脚本的退出码(exit code)必须遵循如下约定：</p>
<ul>
<li><p>exit code o<br>检查通过</p>
</li>
<li><p>exit code 1<br>检查警告</p>
</li>
<li><p>any exit code<br>检查失败</p>
</li>
</ul>
<p><br></p>
<h3 id="初始化健康检查状态"><a href="#初始化健康检查状态" class="headerlink" title="初始化健康检查状态"></a>初始化健康检查状态</h3><p>在某些情况下，可能需要指定健康检查的初始状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;mem&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;/bin/check_mem&quot;, &quot;-limit&quot;, &quot;256MB&quot;],</span><br><span class="line">    &quot;interval&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;status&quot;: &quot;passing&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="绑定服务检查"><a href="#绑定服务检查" class="headerlink" title="绑定服务检查"></a>绑定服务检查</h3><p>健康检查可以选择性地绑定到特定服务。这可以确保健康检查的状态只会影响给定服务的健康状态，而不会影响整个节点。<br>服务绑定检查需要添加一个<code>service_id</code>字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;check&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;web-app&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;Web App Status&quot;,</span><br><span class="line">    &quot;service_id&quot;: &quot;web-app&quot;,</span><br><span class="line">    &quot;ttl&quot;: &quot;30s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="定义多个检查"><a href="#定义多个检查" class="headerlink" title="定义多个检查"></a>定义多个检查</h3><p>使用<code>checks</code>来定义多个服务检查。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;checks&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;chk1&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;mem&quot;,</span><br><span class="line">      &quot;args&quot;: [&quot;/bin/check_mem&quot;, &quot;-limit&quot;, &quot;256MB&quot;],</span><br><span class="line">      &quot;interval&quot;: &quot;5s&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;chk2&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;/health&quot;,</span><br><span class="line">      &quot;http&quot;: &quot;http://localhost:5000/health&quot;,</span><br><span class="line">      &quot;interval&quot;: &quot;15s&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;chk3&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;cpu&quot;,</span><br><span class="line">      &quot;script&quot;: &quot;/bin/check_cpu&quot;,</span><br><span class="line">      &quot;interval&quot;: &quot;10s&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p>Encryption</p>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="consul-template"><a href="#consul-template" class="headerlink" title="consul-template"></a>consul-template</h1><p>Consul Template 查询consul instance，并更新文件系统上任意数量的指定模板。作为额外的奖励，Consul Template可以在模板更新完成时执行任意命令。</p>
<p>Consul Tempalte可以查询Consul中的服务条目，keys, key values。强大的抽象和模板查询语言是Consul Template非常适合创建动态配置。</p>
<p>如：</p>
<ul>
<li>Apache</li>
<li>Nginx</li>
<li>HAproxy</li>
</ul>
<p><br><br><br></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>下载地址: <a href="https://releases.hashicorp.com/consul-template/" target="_blank" rel="noopener">https://releases.hashicorp.com/consul-template/</a></li>
</ul>
<p>步骤：</p>
<ol>
<li>下载</li>
<li>解压</li>
<li>添加PATH</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">wget https://releases.hashicorp.com/consul-template/0.19.5/consul-template_0.19.5_linux_amd64.tgz</span><br><span class="line"></span><br><span class="line">tar -xzvf ./consul-template_0.19.5_linux_amd64.tgz</span><br><span class="line">mv ./consul-template /bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#or</span><br><span class="line">mv consul-template /usr/local/bin</span><br><span class="line">vim /etc/profile</span><br><span class="line">export PATH=$PATH:/usr/local/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">consul-template --version</span><br><span class="line">consul-template v0.19.5 (57b6c71)</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h2><p>官方栗子： <a href="https://github.com/hashicorp/consul-template/tree/master/examples" target="_blank" rel="noopener">https://github.com/hashicorp/consul-template/tree/master/examples</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -h</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><p>查询<code>demo.consul.io</code>这个consul实例。</p>
<p>渲染模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">consul-template \</span><br><span class="line">    -template &quot;/tmp/nginx.ctmpl:/var/nginx/nginx.conf:nginx -s reload&quot; \</span><br><span class="line">    -template &quot;/tmp/redis.ctmpl:/var/redis/redis.conf:service redis restart&quot; \</span><br><span class="line">    -template &quot;/tmp/haproxy.ctmpl:/var/haproxy/haproxy.conf&quot;</span><br></pre></td></tr></table></figure>
<p>监听Consul：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -consul-addr=&quot;consul1:8500&quot; -consul-addr=&quot;consul2:8500&quot;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件使用 <a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener">HashiCorp Configuration Language</a>编写的。这意味着，配置也是JSON兼容的。</p>
<p>命令行指定的选项优先于配置文件！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/consul-template</span><br><span class="line"></span><br><span class="line">vim consul-template.hcl</span><br><span class="line"></span><br><span class="line">consul-template -config=&apos;/etc/consul-template/consul-template.hcl&apos;</span><br></pre></td></tr></table></figure>
<p>配置文件详情：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"># This denotes the start of the configuration section for Consul. All values</span><br><span class="line"># contained in this section pertain to Consul.</span><br><span class="line">consul &#123;</span><br><span class="line">  # This block specifies the basic authentication information to pass with the</span><br><span class="line">  # request. For more information on authentication, please see the Consul</span><br><span class="line">  # documentation.</span><br><span class="line">  auth &#123;</span><br><span class="line">    enabled  = true</span><br><span class="line">    username = &quot;test&quot;</span><br><span class="line">    password = &quot;test&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This is the address of the Consul agent. By default, this is</span><br><span class="line">  # 127.0.0.1:8500, which is the default bind and port for a local Consul</span><br><span class="line">  # agent. It is not recommended that you communicate directly with a Consul</span><br><span class="line">  # server, and instead communicate with the local Consul agent. There are many</span><br><span class="line">  # reasons for this, most importantly the Consul agent is able to multiplex</span><br><span class="line">  # connections to the Consul server and reduce the number of open HTTP</span><br><span class="line">  # connections. Additionally, it provides a &quot;well-known&quot; IP address for which</span><br><span class="line">  # clients can connect.</span><br><span class="line">  address = &quot;127.0.0.1:8500&quot;</span><br><span class="line"></span><br><span class="line">  # This is the ACL token to use when connecting to Consul. If you did not</span><br><span class="line">  # enable ACLs on your Consul cluster, you do not need to set this option.</span><br><span class="line">  #</span><br><span class="line">  # This option is also available via the environment variable CONSUL_TOKEN.</span><br><span class="line">  token = &quot;abcd1234&quot;</span><br><span class="line"></span><br><span class="line">  # This controls the retry behavior when an error is returned from Consul.</span><br><span class="line">  # Consul Template is highly fault tolerant, meaning it does not exit in the</span><br><span class="line">  # face of failure. Instead, it uses exponential back-off and retry functions</span><br><span class="line">  # to wait for the cluster to become available, as is customary in distributed</span><br><span class="line">  # systems.</span><br><span class="line">  retry &#123;</span><br><span class="line">    # This enabled retries. Retries are enabled by default, so this is</span><br><span class="line">    # redundant.</span><br><span class="line">    enabled = true</span><br><span class="line"></span><br><span class="line">    # This specifies the number of attempts to make before giving up. Each</span><br><span class="line">    # attempt adds the exponential backoff sleep time. Setting this to</span><br><span class="line">    # zero will implement an unlimited number of retries.</span><br><span class="line">    attempts = 12</span><br><span class="line"></span><br><span class="line">    # This is the base amount of time to sleep between retry attempts. Each</span><br><span class="line">    # retry sleeps for an exponent of 2 longer than this base. For 5 retries,</span><br><span class="line">    # the sleep times would be: 250ms, 500ms, 1s, 2s, then 4s.</span><br><span class="line">    backoff = &quot;250ms&quot;</span><br><span class="line"></span><br><span class="line">    # This is the maximum amount of time to sleep between retry attempts.</span><br><span class="line">    # When max_backoff is set to zero, there is no upper limit to the</span><br><span class="line">    # exponential sleep between retry attempts.</span><br><span class="line">    # If max_backoff is set to 10s and backoff is set to 1s, sleep times</span><br><span class="line">    # would be: 1s, 2s, 4s, 8s, 10s, 10s, ...</span><br><span class="line">    max_backoff = &quot;1m&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This block configures the SSL options for connecting to the Consul server.</span><br><span class="line">  ssl &#123;</span><br><span class="line">    # This enables SSL. Specifying any option for SSL will also enable it.</span><br><span class="line">    enabled = true</span><br><span class="line"></span><br><span class="line">    # This enables SSL peer verification. The default value is &quot;true&quot;, which</span><br><span class="line">    # will check the global CA chain to make sure the given certificates are</span><br><span class="line">    # valid. If you are using a self-signed certificate that you have not added</span><br><span class="line">    # to the CA chain, you may want to disable SSL verification. However, please</span><br><span class="line">    # understand this is a potential security vulnerability.</span><br><span class="line">    verify = false</span><br><span class="line"></span><br><span class="line">    # This is the path to the certificate to use to authenticate. If just a</span><br><span class="line">    # certificate is provided, it is assumed to contain both the certificate and</span><br><span class="line">    # the key to convert to an X509 certificate. If both the certificate and</span><br><span class="line">    # key are specified, Consul Template will automatically combine them into an</span><br><span class="line">    # X509 certificate for you.</span><br><span class="line">    cert = &quot;/path/to/client/cert&quot;</span><br><span class="line">    key  = &quot;/path/to/client/key&quot;</span><br><span class="line"></span><br><span class="line">    # This is the path to the certificate authority to use as a CA. This is</span><br><span class="line">    # useful for self-signed certificates or for organizations using their own</span><br><span class="line">    # internal certificate authority.</span><br><span class="line">    ca_cert = &quot;/path/to/ca&quot;</span><br><span class="line"></span><br><span class="line">    # This is the path to a directory of PEM-encoded CA cert files. If both</span><br><span class="line">    # `ca_cert` and `ca_path` is specified, `ca_cert` is preferred.</span><br><span class="line">    ca_path = &quot;path/to/certs/&quot;</span><br><span class="line"></span><br><span class="line">    # This sets the SNI server name to use for validation.</span><br><span class="line">    server_name = &quot;my-server.com&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># This is the signal to listen for to trigger a reload event. The default</span><br><span class="line"># value is shown below. Setting this value to the empty string will cause CT</span><br><span class="line"># to not listen for any reload signals.</span><br><span class="line">reload_signal = &quot;SIGHUP&quot;</span><br><span class="line"></span><br><span class="line"># This is the signal to listen for to trigger a graceful stop. The default</span><br><span class="line"># value is shown below. Setting this value to the empty string will cause CT</span><br><span class="line"># to not listen for any graceful stop signals.</span><br><span class="line">kill_signal = &quot;SIGINT&quot;</span><br><span class="line"></span><br><span class="line"># This is the maximum interval to allow &quot;stale&quot; data. By default, only the</span><br><span class="line"># Consul leader will respond to queries; any requests to a follower will</span><br><span class="line"># forward to the leader. In large clusters with many requests, this is not as</span><br><span class="line"># scalable, so this option allows any follower to respond to a query, so long</span><br><span class="line"># as the last-replicated data is within these bounds. Higher values result in</span><br><span class="line"># less cluster load, but are more likely to have outdated data.</span><br><span class="line">max_stale = &quot;10m&quot;</span><br><span class="line"></span><br><span class="line"># This is the log level. If you find a bug in Consul Template, please enable</span><br><span class="line"># debug logs so we can help identify the issue. This is also available as a</span><br><span class="line"># command line flag.</span><br><span class="line">log_level = &quot;warn&quot;</span><br><span class="line"></span><br><span class="line"># This is the path to store a PID file which will contain the process ID of the</span><br><span class="line"># Consul Template process. This is useful if you plan to send custom signals</span><br><span class="line"># to the process.</span><br><span class="line">pid_file = &quot;/path/to/pid&quot;</span><br><span class="line"></span><br><span class="line"># This is the quiescence timers; it defines the minimum and maximum amount of</span><br><span class="line"># time to wait for the cluster to reach a consistent state before rendering a</span><br><span class="line"># template. This is useful to enable in systems that have a lot of flapping,</span><br><span class="line"># because it will reduce the the number of times a template is rendered.</span><br><span class="line">wait &#123;</span><br><span class="line">  min = &quot;5s&quot;</span><br><span class="line">  max = &quot;10s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># This denotes the start of the configuration section for Vault. All values</span><br><span class="line"># contained in this section pertain to Vault.</span><br><span class="line">vault &#123;</span><br><span class="line">  # This is the address of the Vault leader. The protocol (http(s)) portion</span><br><span class="line">  # of the address is required.</span><br><span class="line">  address = &quot;https://vault.service.consul:8200&quot;</span><br><span class="line"></span><br><span class="line">  # This is the grace period between lease renewal of periodic secrets and secret</span><br><span class="line">  # re-acquisition. When renewing a secret, if the remaining lease is less than or</span><br><span class="line">  # equal to the configured grace, Consul Template will request a new credential.</span><br><span class="line">  # This prevents Vault from revoking the credential at expiration and Consul</span><br><span class="line">  # Template having a stale credential.</span><br><span class="line">  #</span><br><span class="line">  # Note: If you set this to a value that is higher than your default TTL or</span><br><span class="line">  # max TTL, Consul Template will always read a new secret!</span><br><span class="line">  #</span><br><span class="line">  # This should also be less than or around 1/3 of your TTL for a predictable</span><br><span class="line">  # behaviour. See https://github.com/hashicorp/vault/issues/3414</span><br><span class="line">  grace = &quot;5m&quot;</span><br><span class="line"></span><br><span class="line">  # This is the token to use when communicating with the Vault server.</span><br><span class="line">  # Like other tools that integrate with Vault, Consul Template makes the</span><br><span class="line">  # assumption that you provide it with a Vault token; it does not have the</span><br><span class="line">  # incorporated logic to generate tokens via Vault&apos;s auth methods.</span><br><span class="line">  #</span><br><span class="line">  # This value can also be specified via the environment variable VAULT_TOKEN.</span><br><span class="line">  token = &quot;abcd1234&quot;</span><br><span class="line"></span><br><span class="line">  # This tells Consul Template that the provided token is actually a wrapped</span><br><span class="line">  # token that should be unwrapped using Vault&apos;s cubbyhole response wrapping</span><br><span class="line">  # before being used. Please see Vault&apos;s cubbyhole response wrapping</span><br><span class="line">  # documentation for more information.</span><br><span class="line">  unwrap_token = true</span><br><span class="line"></span><br><span class="line">  # This option tells Consul Template to automatically renew the Vault token</span><br><span class="line">  # given. If you are unfamiliar with Vault&apos;s architecture, Vault requires</span><br><span class="line">  # tokens be renewed at some regular interval or they will be revoked. Consul</span><br><span class="line">  # Template will automatically renew the token at half the lease duration of</span><br><span class="line">  # the token. The default value is true, but this option can be disabled if</span><br><span class="line">  # you want to renew the Vault token using an out-of-band process.</span><br><span class="line">  #</span><br><span class="line">  # Note that secrets specified in a template (using &#123;&#123;secret&#125;&#125; for example)</span><br><span class="line">  # are always renewed, even if this option is set to false. This option only</span><br><span class="line">  # applies to the top-level Vault token itself.</span><br><span class="line">  renew_token = true</span><br><span class="line"></span><br><span class="line">  # This section details the retry options for connecting to Vault. Please see</span><br><span class="line">  # the retry options in the Consul section for more information (they are the</span><br><span class="line">  # same).</span><br><span class="line">  retry &#123;</span><br><span class="line">    # ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This section details the SSL options for connecting to the Vault server.</span><br><span class="line">  # Please see the SSL options in the Consul section for more information (they</span><br><span class="line">  # are the same).</span><br><span class="line">  ssl &#123;</span><br><span class="line">    # ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># This block defines the configuration for connecting to a syslog server for</span><br><span class="line"># logging.</span><br><span class="line">syslog &#123;</span><br><span class="line">  # This enables syslog logging. Specifying any other option also enables</span><br><span class="line">  # syslog logging.</span><br><span class="line">  enabled = true</span><br><span class="line"></span><br><span class="line">  # This is the name of the syslog facility to log to.</span><br><span class="line">  facility = &quot;LOCAL5&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># This block defines the configuration for de-duplication mode. Please see the</span><br><span class="line"># de-duplication mode documentation later in the README for more information</span><br><span class="line"># on how de-duplication mode operates.</span><br><span class="line">deduplicate &#123;</span><br><span class="line">  # This enables de-duplication mode. Specifying any other options also enables</span><br><span class="line">  # de-duplication mode.</span><br><span class="line">  enabled = true</span><br><span class="line"></span><br><span class="line">  # This is the prefix to the path in Consul&apos;s KV store where de-duplication</span><br><span class="line">  # templates will be pre-rendered and stored.</span><br><span class="line">  prefix = &quot;consul-template/dedup/&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># This block defines the configuration for exec mode. Please see the exec mode</span><br><span class="line"># documentation at the bottom of this README for more information on how exec</span><br><span class="line"># mode operates and the caveats of this mode.</span><br><span class="line">exec &#123;</span><br><span class="line">  # This is the command to exec as a child process. There can be only one</span><br><span class="line">  # command per Consul Template process.</span><br><span class="line">  command = &quot;/usr/bin/app&quot;</span><br><span class="line"></span><br><span class="line">  # This is a random splay to wait before killing the command. The default</span><br><span class="line">  # value is 0 (no wait), but large clusters should consider setting a splay</span><br><span class="line">  # value to prevent all child processes from reloading at the same time when</span><br><span class="line">  # data changes occur. When this value is set to non-zero, Consul Template</span><br><span class="line">  # will wait a random period of time up to the splay value before reloading</span><br><span class="line">  # or killing the child process. This can be used to prevent the thundering</span><br><span class="line">  # herd problem on applications that do not gracefully reload.</span><br><span class="line">  splay = &quot;5s&quot;</span><br><span class="line"></span><br><span class="line">  env &#123;</span><br><span class="line">    # This specifies if the child process should not inherit the parent</span><br><span class="line">    # process&apos;s environment. By default, the child will have full access to the</span><br><span class="line">    # environment variables of the parent. Setting this to true will send only</span><br><span class="line">    # the values specified in `custom_env` to the child process.</span><br><span class="line">    pristine = false</span><br><span class="line"></span><br><span class="line">    # This specifies additional custom environment variables in the form shown</span><br><span class="line">    # below to inject into the child&apos;s runtime environment. If a custom</span><br><span class="line">    # environment variable shares its name with a system environment variable,</span><br><span class="line">    # the custom environment variable takes precedence. Even if pristine,</span><br><span class="line">    # whitelist, or blacklist is specified, all values in this option</span><br><span class="line">    # are given to the child process.</span><br><span class="line">    custom = [&quot;PATH=$PATH:/etc/myapp/bin&quot;]</span><br><span class="line"></span><br><span class="line">    # This specifies a list of environment variables to exclusively include in</span><br><span class="line">    # the list of environment variables exposed to the child process. If</span><br><span class="line">    # specified, only those environment variables matching the given patterns</span><br><span class="line">    # are exposed to the child process. These strings are matched using Go&apos;s</span><br><span class="line">    # glob function, so wildcards are permitted.</span><br><span class="line">    whitelist = [&quot;CONSUL_*&quot;]</span><br><span class="line"></span><br><span class="line">    # This specifies a list of environment variables to exclusively prohibit in</span><br><span class="line">    # the list of environment variables exposed to the child process. If</span><br><span class="line">    # specified, any environment variables matching the given patterns will not</span><br><span class="line">    # be exposed to the child process, even if they are whitelisted. The values</span><br><span class="line">    # in this option take precedence over the values in the whitelist.</span><br><span class="line">    # These strings are matched using Go&apos;s glob function, so wildcards are</span><br><span class="line">    # permitted.</span><br><span class="line">    blacklist = [&quot;VAULT_*&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This defines the signal that will be sent to the child process when a</span><br><span class="line">  # change occurs in a watched template. The signal will only be sent after the</span><br><span class="line">  # process is started, and the process will only be started after all</span><br><span class="line">  # dependent templates have been rendered at least once. The default value is</span><br><span class="line">  # nil, which tells Consul Template to stop the child process and spawn a new</span><br><span class="line">  # one instead of sending it a signal. This is useful for legacy applications</span><br><span class="line">  # or applications that cannot properly reload their configuration without a</span><br><span class="line">  # full reload.</span><br><span class="line">  reload_signal = &quot;&quot;</span><br><span class="line"></span><br><span class="line">  # This defines the signal sent to the child process when Consul Template is</span><br><span class="line">  # gracefully shutting down. The application should begin a graceful cleanup.</span><br><span class="line">  # If the application does not terminate before the `kill_timeout`, it will</span><br><span class="line">  # be terminated (effectively &quot;kill -9&quot;). The default value is &quot;SIGTERM&quot;.</span><br><span class="line">  kill_signal = &quot;SIGINT&quot;</span><br><span class="line"></span><br><span class="line">  # This defines the amount of time to wait for the child process to gracefully</span><br><span class="line">  # terminate when Consul Template exits. After this specified time, the child</span><br><span class="line">  # process will be force-killed (effectively &quot;kill -9&quot;). The default value is</span><br><span class="line">  # &quot;30s&quot;.</span><br><span class="line">  kill_timeout = &quot;2s&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># This block defines the configuration for a template. Unlike other blocks,</span><br><span class="line"># this block may be specified multiple times to configure multiple templates.</span><br><span class="line"># It is also possible to configure templates via the CLI directly.</span><br><span class="line">template &#123;</span><br><span class="line">  # This is the source file on disk to use as the input template. This is often</span><br><span class="line">  # called the &quot;Consul Template template&quot;. This option is required if not using</span><br><span class="line">  # the `contents` option.</span><br><span class="line">  source = &quot;/path/on/disk/to/template.ctmpl&quot;</span><br><span class="line"></span><br><span class="line">  # This is the destination path on disk where the source template will render.</span><br><span class="line">  # If the parent directories do not exist, Consul Template will attempt to</span><br><span class="line">  # create them, unless create_dest_dirs is false.</span><br><span class="line">  destination = &quot;/path/on/disk/where/template/will/render.txt&quot;</span><br><span class="line"></span><br><span class="line">  # This options tells Consul Template to create the parent directories of the</span><br><span class="line">  # destination path if they do not exist. The default value is true.</span><br><span class="line">  create_dest_dirs = true</span><br><span class="line"></span><br><span class="line">  # This option allows embedding the contents of a template in the configuration</span><br><span class="line">  # file rather then supplying the `source` path to the template file. This is</span><br><span class="line">  # useful for short templates. This option is mutually exclusive with the</span><br><span class="line">  # `source` option.</span><br><span class="line">  contents = &quot;&#123;&#123; keyOrDefault \&quot;service/redis/maxconns@east-aws\&quot; \&quot;5\&quot; &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">  # This is the optional command to run when the template is rendered. The</span><br><span class="line">  # command will only run if the resulting template changes. The command must</span><br><span class="line">  # return within 30s (configurable), and it must have a successful exit code.</span><br><span class="line">  # Consul Template is not a replacement for a process monitor or init system.</span><br><span class="line">  command = &quot;restart service foo&quot;</span><br><span class="line"></span><br><span class="line">  # This is the maximum amount of time to wait for the optional command to</span><br><span class="line">  # return. Default is 30s.</span><br><span class="line">  command_timeout = &quot;60s&quot;</span><br><span class="line"></span><br><span class="line">  # Exit with an error when accessing a struct or map field/key that does not</span><br><span class="line">  # exist. The default behavior will print &quot;&lt;no value&gt;&quot; when accessing a field</span><br><span class="line">  # that does not exist. It is highly recommended you set this to &quot;true&quot; when</span><br><span class="line">  # retrieving secrets from Vault.</span><br><span class="line">  error_on_missing_key = false</span><br><span class="line"></span><br><span class="line">  # This is the permission to render the file. If this option is left</span><br><span class="line">  # unspecified, Consul Template will attempt to match the permissions of the</span><br><span class="line">  # file that already exists at the destination path. If no file exists at that</span><br><span class="line">  # path, the permissions are 0644.</span><br><span class="line">  perms = 0600</span><br><span class="line"></span><br><span class="line">  # This option backs up the previously rendered template at the destination</span><br><span class="line">  # path before writing a new one. It keeps exactly one backup. This option is</span><br><span class="line">  # useful for preventing accidental changes to the data without having a</span><br><span class="line">  # rollback strategy.</span><br><span class="line">  backup = true</span><br><span class="line"></span><br><span class="line">  # These are the delimiters to use in the template. The default is &quot;&#123;&#123;&quot; and</span><br><span class="line">  # &quot;&#125;&#125;&quot;, but for some templates, it may be easier to use a different delimiter</span><br><span class="line">  # that does not conflict with the output file itself.</span><br><span class="line">  left_delimiter  = &quot;&#123;&#123;&quot;</span><br><span class="line">  right_delimiter = &quot;&#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">  # This is the `minimum(:maximum)` to wait before rendering a new template to</span><br><span class="line">  # disk and triggering a command, separated by a colon (`:`). If the optional</span><br><span class="line">  # maximum value is omitted, it is assumed to be 4x the required minimum value.</span><br><span class="line">  # This is a numeric time with a unit suffix (&quot;5s&quot;). There is no default value.</span><br><span class="line">  # The wait value for a template takes precedence over any globally-configured</span><br><span class="line">  # wait.</span><br><span class="line">  wait &#123;</span><br><span class="line">    min = &quot;2s&quot;</span><br><span class="line">    max = &quot;10s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/consul-template/consul.hcl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">max_stale = &apos;10m&apos;</span><br><span class="line">wait = &#123;</span><br><span class="line">  min = &apos;1s&apos;</span><br><span class="line">  max = &apos;3s&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">template &#123;</span><br><span class="line">  source = &apos;/etc/consul-template/ctmpl/a.ctmpl&apos;</span><br><span class="line">  destination = &apos;/etc/nginx/conf.d/upstream-a.conf&apos;</span><br><span class="line">  command = &apos;systemctl reload nginx&apos;</span><br><span class="line">  perms = 0644</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">vim /etc/consul-template/ctmpl/a.ctmpl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">upstream upstream-a &#123;</span><br><span class="line">  &#123;&#123;range service &apos;a&apos;&#125;&#125;</span><br><span class="line">  server &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125;;</span><br><span class="line">  &#123;&#123;else&#125;&#125;</span><br><span class="line">  server 127.0.0.1:12345;</span><br><span class="line">  &#123;&#123;end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#nginx</span><br><span class="line">vim /etc/nginx/conf.d/upstream-a.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">upstream upstream-a &#123;</span><br><span class="line"></span><br><span class="line">  server 192.168.1.11:12345;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h3><p>Consul Template解析文件以 <a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener">Go Template</a>创作。<br>Consul Template提供了如下函数：</p>
<h4 id="API函数"><a href="#API函数" class="headerlink" title="API函数"></a>API函数</h4><p>API函数与远程API进行交互，与Consul等外部服务进行通信。</p>
<ul>
<li>datacenters<br>查询Consul目录中的所有数据中心。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; datacenters &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#栗子</span><br><span class="line">&#123;&#123; range datacenters &#125;&#125;</span><br><span class="line">&#123;&#123; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">#效果</span><br><span class="line">dc1</span><br><span class="line">dc2</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Consul/" rel="tag"># Consul</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/05/网站运维/" rel="next" title="《网站运维》读书笔记">
                <i class="fa fa-chevron-left"></i> 《网站运维》读书笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/08/Supervisor/" rel="prev" title="Supervisor">
                Supervisor <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/leslie.jpg"
              alt="Zhang21" />
          
            <p class="site-author-name" itemprop="name">Zhang21</p>
            <p class="site-description motion-element" itemprop="description">踏踏实实谋发展</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/f13278e94ecb" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-circle-o"></i>简书</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:elite_zhang21@163.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul是什么"><span class="nav-number">1.1.</span> <span class="nav-text">Consul是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul用例"><span class="nav-number">1.2.</span> <span class="nav-text">Consul用例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul基础架构"><span class="nav-number">1.3.</span> <span class="nav-text">Consul基础架构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#快速开始"><span class="nav-number">2.</span> <span class="nav-text">快速开始</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Consul"><span class="nav-number">2.1.</span> <span class="nav-text">安装Consul</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行consul-agent"><span class="nav-number">2.2.</span> <span class="nav-text">运行consul-agent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动agent"><span class="nav-number">2.2.1.</span> <span class="nav-text">启动agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul成员"><span class="nav-number">2.2.2.</span> <span class="nav-text">Consul成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止agent"><span class="nav-number">2.2.3.</span> <span class="nav-text">停止agent</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册服务"><span class="nav-number">2.3.</span> <span class="nav-text">注册服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义一个服务"><span class="nav-number">2.3.1.</span> <span class="nav-text">定义一个服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询服务"><span class="nav-number">2.3.2.</span> <span class="nav-text">查询服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新服务"><span class="nav-number">2.3.3.</span> <span class="nav-text">更新服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul集群"><span class="nav-number">2.4.</span> <span class="nav-text">Consul集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动agents"><span class="nav-number">2.4.1.</span> <span class="nav-text">启动agents</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加入集群"><span class="nav-number">2.5.</span> <span class="nav-text">加入集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在启动时自动加入集群"><span class="nav-number">2.5.1.</span> <span class="nav-text">在启动时自动加入集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询节点"><span class="nav-number">2.5.2.</span> <span class="nav-text">查询节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#离开集群"><span class="nav-number">2.5.3.</span> <span class="nav-text">离开集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#健康检查"><span class="nav-number">2.6.</span> <span class="nav-text">健康检查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义检查"><span class="nav-number">2.6.1.</span> <span class="nav-text">定义检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查健康状态"><span class="nav-number">2.7.</span> <span class="nav-text">检查健康状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KV数据"><span class="nav-number">2.8.</span> <span class="nav-text">KV数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用法"><span class="nav-number">2.8.1.</span> <span class="nav-text">用法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web界面"><span class="nav-number">2.9.</span> <span class="nav-text">Web界面</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Agent"><span class="nav-number">3.</span> <span class="nav-text">Agent</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#启动和停止"><span class="nav-number">3.1.</span> <span class="nav-text">启动和停止</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS接口"><span class="nav-number">3.2.</span> <span class="nav-text">DNS接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">3.3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#端口"><span class="nav-number">3.3.1.</span> <span class="nav-text">端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可重新加载的配置"><span class="nav-number">3.3.2.</span> <span class="nav-text">可重新加载的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件"><span class="nav-number">3.3.3.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务定义"><span class="nav-number">3.4.</span> <span class="nav-text">服务定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务定义-1"><span class="nav-number">3.4.1.</span> <span class="nav-text">服务定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多个服务定义"><span class="nav-number">3.4.2.</span> <span class="nav-text">多个服务定义</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查定义"><span class="nav-number">3.5.</span> <span class="nav-text">检查定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义检查-1"><span class="nav-number">3.5.1.</span> <span class="nav-text">定义检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查脚本"><span class="nav-number">3.5.2.</span> <span class="nav-text">检查脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化健康检查状态"><span class="nav-number">3.5.3.</span> <span class="nav-text">初始化健康检查状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绑定服务检查"><span class="nav-number">3.5.4.</span> <span class="nav-text">绑定服务检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义多个检查"><span class="nav-number">3.5.5.</span> <span class="nav-text">定义多个检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加密"><span class="nav-number">3.6.</span> <span class="nav-text">加密</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#consul-template"><span class="nav-number">4.</span> <span class="nav-text">consul-template</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">4.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用法-1"><span class="nav-number">4.2.</span> <span class="nav-text">用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#命令行"><span class="nav-number">4.2.1.</span> <span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板语法"><span class="nav-number">4.2.3.</span> <span class="nav-text">模板语法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#API函数"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">API函数</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang21</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 268.9k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2018/04/05/Consul/';
          this.page.identifier = '2018/04/05/Consul/';
          this.page.title = 'Consul';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
