<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="SaltStack," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="参考：  SaltStack官网：https://saltstack.com SaltStack文档：https://docs.saltstack.com/en/latest/topics SaltStack-GitHub：https://github.com/saltstack Salt-repo：https://repo.saltstack.com/ Salt TOC: https://doc">
<meta name="keywords" content="SaltStack">
<meta property="og:type" content="article">
<meta property="og:title" content="SaltStack">
<meta property="og:url" content="https://zhang21.github.io/2017/12/25/SaltStack/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考：  SaltStack官网：https://saltstack.com SaltStack文档：https://docs.saltstack.com/en/latest/topics SaltStack-GitHub：https://github.com/saltstack Salt-repo：https://repo.saltstack.com/ Salt TOC: https://doc">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://zhang21.github.io/images/Salt/SaltStack.png">
<meta property="og:image" content="https://zhang21.github.io/images/Salt/external-job-cache.png">
<meta property="og:image" content="https://zhang21.github.io/images/Salt/master-job-cache.png">
<meta property="og:image" content="https://zhang21.github.io/image/Salt/spm-overview.png">
<meta property="og:image" content="https://zhang21.github.io/images/Salt/spm-package-contents.png">
<meta property="og:image" content="https://zhang21.github.io/images/Salt/spm-package-extraction.png">
<meta property="og:image" content="https://zhang21.github.io/images/Salt/proxy_minions.png">
<meta property="og:updated_time" content="2019-02-21T02:50:10.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SaltStack">
<meta name="twitter:description" content="参考：  SaltStack官网：https://saltstack.com SaltStack文档：https://docs.saltstack.com/en/latest/topics SaltStack-GitHub：https://github.com/saltstack Salt-repo：https://repo.saltstack.com/ Salt TOC: https://doc">
<meta name="twitter:image" content="https://zhang21.github.io/images/Salt/SaltStack.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2017/12/25/SaltStack/"/>





  <title>SaltStack | 风继续吹</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2017/12/25/SaltStack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang21">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SaltStack</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-25T09:47:39+08:00">
                2017-12-25
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-02-21T10:50:10+08:00">
                2019-02-21
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/25/SaltStack/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/12/25/SaltStack/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  46,340
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考：</p>
<ul>
<li>SaltStack官网：<a href="https://saltstack.com" target="_blank" rel="noopener">https://saltstack.com</a></li>
<li>SaltStack文档：<a href="https://docs.saltstack.com/en/latest/topics" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics</a></li>
<li>SaltStack-GitHub：<a href="https://github.com/saltstack" target="_blank" rel="noopener">https://github.com/saltstack</a></li>
<li>Salt-repo：<a href="https://repo.saltstack.com/" target="_blank" rel="noopener">https://repo.saltstack.com/</a></li>
<li>Salt TOC: <a href="https://docs.saltstack.com/en/latest/contents.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/contents.html</a></li>
<li>Salt Modules: <a href="https://docs.saltstack.com/en/latest/salt-modindex.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/salt-modindex.html</a></li>
<li>Salt Index: <a href="https://docs.saltstack.com/en/latest/genindex.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/genindex.html</a></li>
</ul>
<p>环境：</p>
<ul>
<li>CentOS7_x64;</li>
<li>Salt-2018.02</li>
</ul>
<p><br><br><br></p>
<hr>
<a id="more"></a>
<p><br><br><br></p>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p><code>SaltStack</code>是一种革命性的用速度(speed)取代复杂性(complexity)的基础设施(infrastucture)管理方法。</p>
<ul>
<li>简单(Simple)，可以在几分钟内运行；</li>
<li>可伸缩性(Scalable)，足以管理数以万计的Server；</li>
<li>快速(Fast)，能在几秒内与各系统间进行通信。</li>
</ul>
<p><br></p>
<p><strong>You’ll learn how to:</strong></p>
<ul>
<li>安装和配置SaltStack；</li>
<li>在所有托管系统上远程执行命令(Remotely execute commands)；</li>
<li>设计、开发和部署系统配置；</li>
<li>使用Salt Reactor是基础设施自动化(automate)；</li>
<li>使用Salt Orchestration协调复杂管理操作。</li>
</ul>
<p><img src="/images/Salt/SaltStack.png" alt="SaltStack"></p>
<p><br></p>
<p>Salt是建立在动态通信总线(dynamic communication bus)上的基础设施管理的一种新方法。Salt可以用于数据驱动(data-driven)业务，远程执行(remote execution)任何基础设施，配置管理(configuration management)任意应用堆栈…</p>
<ul>
<li>REMOTE EXECUTION;</li>
<li>CONFIGURATION MANAGEMENT;</li>
<li>EVENT-DRIVEN INFRASTRUCTURE;</li>
<li>SALT ESSENTIALS.</li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="词汇表"><a href="#词汇表" class="headerlink" title="词汇表"></a>词汇表</h1><p>GLOSSARY</p>
<ul>
<li><p><strong>Auto-Order</strong>: 按照在SLS文件中定义的顺序评估状态</p>
</li>
<li><p><strong>Bootstrap</strong>: 下载和安装Salt的一个项目</p>
</li>
<li><p><strong>Compound Matcher</strong>: 可以与布尔运算符组合的许多目标定义的组合</p>
</li>
<li><p><strong>EAuth</strong>: 外部认证(external authentication)的简写</p>
</li>
<li><p><strong>Environment</strong>: 包含可应用于minions的状态文件的目录树</p>
</li>
<li><p><strong>Execution Function</strong>: 执行模块中的Python函数，可以接受参数并执行特定的系统管理任务</p>
</li>
<li><p><strong>Execution Module</strong>: 包含执行功能的Python模块，可直接在服务器上执行各种系统管理任务。 Salt附带了许多执行模块，但用户也可以编写自己的执行模块来执行专门的任务</p>
</li>
<li><p><strong>External Job Cache</strong>: 外部数据存储，可以存档有关已运行作业的信息</p>
</li>
<li><p><strong>External Pillar</strong>: 一个接受任意参数并返回字典的模块</p>
</li>
<li><p><strong>Event</strong>: 发送到事件总线的通知</p>
</li>
<li><p><strong>File Server</strong>: 用于存储Salt特定文件的本地或远程位置</p>
</li>
<li><p><strong>Grain</strong>: 包含系统信息的键值对</p>
</li>
<li><p><strong>Highdata</strong>: SLS文件中的数据结构表示一组状态声明</p>
</li>
<li><p><strong>Highstate</strong>: 要应用于系统的状态集合</p>
</li>
<li><p><strong>Idempotent</strong>：在应用操作之前，无论系统状态如何，都确保系统处于已知状态的操作</p>
</li>
<li><p><strong>Jinja</strong>: 一种模板语言，允许变量和简单逻辑在呈现时动态插入到静态文本文件中</p>
</li>
<li><p><strong>Job</strong>: Salt命令要执行的完整任务集是单个作业</p>
</li>
<li><p><strong>Job Cache</strong>: 作业结果的存储位置，然后可由salt runner或外部系统查询</p>
</li>
<li><p><strong>Job ID</strong>: 作业的唯一标识符</p>
</li>
<li><p><strong>Low State</strong>: 评估requirements和order的已处理状态的集合</p>
</li>
<li><p><strong>Master</strong>: salt daemon，可向minions发出命令</p>
</li>
<li><p><strong>Masterless</strong>: 不需要Salt Master操作的minion，所有配置都是本地的</p>
</li>
<li><p><strong>Master Tops</strong>: 允许hook进入外部系统以生成顶级文件数据的系统</p>
</li>
<li><p><strong>Mine</strong>: 从minion收集任意数据并将数据存储在master上。这些数据可供其它 minions 使用</p>
</li>
<li><p><strong>Minion</strong>: Salt Minion daemon</p>
</li>
<li><p><strong>Minion ID</strong>: minion的全局标识符</p>
</li>
<li><p><strong>Multi-Master</strong>: 在高可用环境下，minion可以同时主动连接到多个Salt Master</p>
</li>
<li><p><strong>Node Group</strong>: 为minion进行逻辑分组</p>
</li>
<li><p><strong>Outputter</strong>: 定义Salt命令的输出数据格式的程序</p>
</li>
<li><p><strong>Peer Communication</strong>: minion与minion直接进行沟通，而不通过salt master</p>
</li>
<li><p><strong>Pillar</strong>: 为使用者提供用户定义的数据的键值对，通常用于存储敏感数据并将其分发给minion</p>
</li>
<li><p><strong>Proxy Minion</strong>: 可控制无法再本地运行salt minion的minion</p>
</li>
<li><p><strong>PyDSL</strong>: 用作Salt渲染器的Pythonic域特定语言</p>
</li>
<li><p><strong>Reactor</strong>: 一个接口，用于侦听事件和定义Salt在收到给定事件时应采取的操作</p>
</li>
<li><p><strong>Render Pipe</strong>: 将给定数据格式(yaml/json…)转换为可由salt使用的Python数据结构</p>
</li>
<li><p><strong>Returner</strong>: 允许将Salt命令的结果发送到给定的数据存储（例如数据库或日志文件）以进行存档</p>
</li>
<li><p><strong>Roster</strong>: 目标主机的文件列表</p>
</li>
<li><p><strong>Runner Module</strong>: 包含一组runner功能的模块</p>
</li>
<li><p><strong>Runner Function</strong>: 由<code>salt-run</code>命令调用并在master上(not minion)执行的函数</p>
</li>
<li><p><strong>Salt Cloud</strong>: 用于托管的云环境</p>
</li>
<li><p><strong>Salt SSH</strong>: 配置管理和远程编排系统，只需要SSH</p>
</li>
<li><p><strong>Salt Thin</strong>: 是salt发行版的一个子集，不包含任何传输例程</p>
</li>
<li><p><strong>Salt Virt</strong>: 用于管理虚拟机在一组主机上的创建和部署。通常用于创建和部署私有云</p>
</li>
<li><p><strong>SLS Module</strong>: 包含一组状态声明</p>
</li>
<li><p><strong>State Compiler</strong>: 将highdata转换为lowdata</p>
</li>
<li><p><strong>State Declaration</strong>: 一种数据结构，包含唯一ID并描述系统的一个或多个状态</p>
</li>
<li><p><strong>State Function</strong>: 包含在状态模块内的函数，该函数可以管理特定状态对系统的应用</p>
</li>
<li><p><strong>State Module</strong>: 包含一组状态函数的模块</p>
</li>
<li><p><strong>State Run</strong>: 在一组系统上应用一组状态</p>
</li>
<li><p><strong>Syndic</strong>: 一个转发器，可以在分层主服务器之间中继消息</p>
</li>
<li><p><strong>Target</strong>: 将要应用给定salt命令的minion</p>
</li>
<li><p><strong>Top File</strong>: 确定应将哪些SLS文件应用于各种系统，并将这些系统组织到环境中</p>
</li>
<li><p><strong><strong>virtual</strong></strong>: 模块负载上调用的模块中的函数，用于确定模块是否应该对minion可用</p>
</li>
<li><p><strong>Worker</strong>: 一个Master process， 可以发送通知并接收来自minion的回复</p>
</li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>INTRODUCTION TO SALT</p>
<p> We’re not just talking about NaCl.</p>
<p><br></p>
<p><strong>30s摘要</strong></p>
<p>Salt是：</p>
<ul>
<li>配置管理系统，能够将远程节点维护在已定义的状态</li>
<li>分布式远程执行系统，用于在远程节点上单独或通过任意选择标准执行命令和查询数据</li>
</ul>
<p>它的开发是为了将远程执行领域中发现的最佳解决方案结合在一起，使其更好，更快，更具可塑性。Salt通过简单易用的界面快速处理大量信息，而不仅仅是数十个甚至数千个单独的服务器。</p>
<p><br></p>
<p><strong>简单理解</strong></p>
<p>在大规模部署和较小系统之间提供多功能性似乎令人生畏，但无论项目规模如何，Salt的设置和维护都非常简单。Salt的体系结构旨在与任意数量的服务器协同工作，从少数本地网络系统到跨不同数据中心的国际部署。拓扑结构是一个简单的C/S模型，其中所需的功能内置于一组守护进程中。虽然默认配置几乎不需要修改，但可以对Salt进行微调以满足特定需求。</p>
<p><br></p>
<p><strong>并行执行(PARALLEL EXECUTION)</strong></p>
<p>Salt的核心功能:</p>
<ul>
<li>使命令能够并行而不是串行地调用远程系统</li>
<li>使用安全和加密的协议</li>
<li>尽可能使用最小和最快的网络负载</li>
</ul>
<p>Salt还为远程执行领域引入了更精细的控件，允许系统不仅可以通过主机名进行定位，还可以通过系统属性进行定位。</p>
<p><br></p>
<p><strong>建立在经过验证的技术上</strong></p>
<p>Salt使用了许多技术：</p>
<ul>
<li>网络层使用优秀的 <a href="http://zeromq.org/" target="_blank" rel="noopener">ZeroMQ</a> 网络库构建，因此Salt守护程序包含一个可行且透明的AMQ代理。</li>
<li>使用公钥对Master Daemon进行身份验证，然后使用更快的AES加密进行负载通信。身份验证和加密是Salt的组成部分。</li>
<li>利用 <a href="https://msgpack.org/" target="_blank" rel="noopener">msgpack</a> 的通信功能，实现快速，轻便的网络流量。</li>
</ul>
<p><br></p>
<p><strong>Python客户端接口</strong></p>
<p>为了允许简单的扩展，Salt执行例程可以编写为普通的Python模块。从Salt执行中收集的数据可以发送回Master或任意程序。可从简单的Python API或CLI调用Salt，这样Salt可用于执行一次性(one-off)命令以及作为更大应用程序的组成部分。</p>
<p><br></p>
<p><strong>快速、灵活、可扩展</strong></p>
<p>结果是一个系统可以在从一个服务器到很多服务器的目标服务器组上高速执行命令。Salt非常快速，易于设置，具有惊人的可塑性，并提供单一的远程执行架构，可以管理任意数量服务器的各种需求。Salt基础设施汇集了最佳的远程执行世界，扩大了其功能并扩展了其范围，从而使系统具有实用性，适用于任何网络。</p>
<p><br></p>
<p><strong>开放</strong></p>
<p>Salt是在Apache License 下开发的，可用于开放和专有项目。请将您的扩展提交回Salt项目，以便我们可以随着Salt的发展一起受益。</p>
<p><br></p>
<p><strong>社区</strong></p>
<p>加入Salt，有很多方法可参与Salt社区并进行沟通。Salt有一个活跃的IRC频道和邮件列表。</p>
<p><br></p>
<p><strong>GitHub</strong></p>
<p>Salt: <a href="https://github.com/saltstack/salt" target="_blank" rel="noopener">https://github.com/saltstack/salt</a></p>
<p><br></p>
<p><strong>Blog</strong></p>
<p>Salt Blogs: <a href="https://www.saltstack.com/blog/" target="_blank" rel="noopener">https://www.saltstack.com/blog/</a></p>
<p><br></p>
<p><strong>SALT STATES</strong></p>
<p><code>salt-states</code> 官方库: <a href="https://github.com/saltstack/salt-states" target="_blank" rel="noopener">https://github.com/saltstack/salt-states</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>Installation</p>
<p>如果是第一次设置环境，你应该在专用的管理服务器上安装<code>Salt master</code>，然后在每个使用Salt管理的系统上安装<code>Salt minion</code>。现在不需要担心你的系统架构(architecture)，你可以在以后轻易添加组件(componet)和修改配置(configuration)而不需要重新安装任何东西。</p>
<p>The general installation process is as follows:</p>
<ul>
<li>安装<code>Salt master</code>，通过各平台说明安装或通过Salt <code>bootstrap.sh</code>脚本来安装；</li>
<li>确保你的<code>Salt minion</code>能够找到<code>Salt master</code>；</li>
<li>在想要管理的每个系统上安装<code>Salt minion</code>；</li>
<li>在<code>Salt minion</code>连接后接受<code>Salt minion key</code>。</li>
</ul>
<p>在此之后，就可以<strong>运行一个简单命令</strong>，并从所有的<code>Salt minion</code><strong>接收返回</strong>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#salt &lt;minion-id&gt; &lt;cmd&gt;</span></span><br><span class="line"></span><br><span class="line">salt minion1 test.ping</span><br><span class="line">salt * test.ping</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><p>Quick install</p>
<p>在绝大多数发行版本上，可以使用<strong>Salt Bootstrap</strong>脚本进行快速安装。</p>
<p>参考：<a href="https://docs.saltstack.com/en/latest/topics/tutorials/salt_bootstrap.html#salt-bootstrap" target="_blank" rel="noopener">Salt Bootstrap</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#wget</span><br><span class="line">wget https://bootstrap.saltstack.com -O bootstrap-salt.sh</span><br><span class="line">sh bootstrap-salt.sh</span><br><span class="line"></span><br><span class="line">#curl</span><br><span class="line">curl -o bootstrap-salt.sh -L https://bootstrap.saltstack.com</span><br><span class="line">sh bootstrap-salt.sh</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="指定平台"><a href="#指定平台" class="headerlink" title="指定平台"></a>指定平台</h2><p>Platform-Specific Installation</p>
<p><a href="https://docs.saltstack.com/en/latest/topics/installation/index.html#platform-specific-installation-instructions" target="_blank" rel="noopener">选择发行版本安装</a></p>
<p><br></p>
<h3 id="CentOS7"><a href="#CentOS7" class="headerlink" title="CentOS7"></a>CentOS7</h3><p>repo: <a href="https://repo.saltstack.com/#rhel" target="_blank" rel="noopener">https://repo.saltstack.com/#rhel</a></p>
<p><strong>1. 下载SaltStack-Repository进行安装：</strong></p>
<p><code>systemd</code>和<code>systemd-python</code>是Salt必须的，在安装Salt前需装好。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装salt-repo</span></span><br><span class="line">yum install -y https://repo.saltstack.com/yum/redhat/salt-repo-latest-2.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum clean expire-cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装salt组件</span></span><br><span class="line">yum install -y salt-master salt-minion salt-ssh salt-syndic salt-cloud salt-api</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#开启</span></span><br><span class="line">systemctl start salt-master</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>2. 自建salt-repo：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/saltstack.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[saltstack-repo]</span><br><span class="line">name=SaltStack repo <span class="keyword">for</span> Cent0S7</span><br><span class="line">baseurl=https://repo.saltstack.com/yum/redhat/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/latest</span><br><span class="line">enalbed=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://repo.saltstack.com/yum/redhat/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/latest/SALTSTACK-GPG-KEY.pub</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>Initial Configuration</p>
<h3 id="配置salt"><a href="#配置salt" class="headerlink" title="配置salt"></a>配置salt</h3><p>Configuration Salt</p>
<p><code>salt-master</code> 的默认配置会为安装而工作，唯一要求是在<code>salt-minion</code>的配置文件中设置<code>salt-master</code>的位置。</p>
<p><br></p>
<h4 id="salt-master"><a href="#salt-master" class="headerlink" title="salt-master"></a>salt-master</h4><p>默认的，<code>salt-master</code>配置文件位于<code>/etc/salt/master</code>，在all interfaces(0.0.0.0)上监听<code>4505</code>和<code>4506</code>端口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/salt/master</span><br><span class="line"></span><br><span class="line">interface: 0.0.0.0</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="salt-minion"><a href="#salt-minion" class="headerlink" title="salt-minion"></a>salt-minion</h4><p>默认，一个<code>salt-minion</code>会尝试连接到DNS名称为<code>salt</code>。如果<code>salt-minion</code>能够正确解析(resolve)这个名称，则可以不需要配置文件。如果DNS名称<code>salt</code>未能解析为<code>salt-master</code>的正确位置，那么可在<code>/etc/salt/minion</code>配置文件下重新定义<code>salt</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/salt/minion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#master: salt</span></span><br><span class="line"><span class="comment">#如果是默认的salt,需要在本地hosts下解析salt</span></span><br><span class="line"><span class="comment">#此处我们修改为salt-master的IP地址</span></span><br><span class="line">master: 192.168.1.9</span><br></pre></td></tr></table></figure>
<p><strong>修改配置文件后，请重启服务。</strong></p>
<p><br></p>
<h4 id="minion代理配置"><a href="#minion代理配置" class="headerlink" title="minion代理配置"></a>minion代理配置</h4><p>PROXY MINION CONFIGURATION</p>
<p>A Proxy Minion模仿一个规律的行为和继承(inherit)他们的选项。<br>类似地，它的配置文件存放于<code>/etc/salt/proxy</code>，<code>proxy</code>也将尝试连接DNS名为<code>salt</code>的主机。</p>
<p>除了<code>salt-minion</code>有规律的选型，<code>proxy</code>还有一些特定的选项。参考:<a href="https://docs.saltstack.com/en/latest/ref/configuration/proxy.html#configuration-salt-proxy" target="_blank" rel="noopener">Proxy minion</a></p>
<p><br></p>
<h4 id="运行Salt"><a href="#运行Salt" class="headerlink" title="运行Salt"></a>运行Salt</h4><p>以<code>salt</code>命令运行:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">salt-master</span><br><span class="line"><span class="comment">#开启守护进程</span></span><br><span class="line">salt-master -d</span><br><span class="line"></span><br><span class="line"><span class="comment">#systemd</span></span><br><span class="line">systemctl start salt-master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">salt-minion</span><br><span class="line">salt-minion -d</span><br><span class="line">systemctl start salt-minion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#日志信息</span></span><br><span class="line">salt-master --<span class="built_in">log</span>-level=debug</span><br></pre></td></tr></table></figure>
<p><strong>以non-root运行salt</strong></p>
<ul>
<li>确保此用户有相应的权限；</li>
<li>可能需要修改相应目录的权限：<ul>
<li>/etc/salt</li>
<li>/var/cache/salt</li>
<li>/var/log/salt</li>
<li>/var/run/salt</li>
</ul>
</li>
</ul>
<p><br></p>
<h4 id="密钥识别"><a href="#密钥识别" class="headerlink" title="密钥识别"></a>密钥识别</h4><p>Key Identity</p>
<p>在<code>initial key</code>交换之前，<code>Salt</code>会提供命令来验证(validate)<code>salt-master</code>和<code>salt-minion</code>的身份。<br>验证身份有助于避免疏忽地连接到错误的<code>salt-master</code>，并且在建立初始化连接的阻止MiTM攻击。</p>
<p><strong>Master Key Fingerprint</strong><br>复制<code>master.pub</code>的值，并将其作为<code>salt-minion</code>配置文件<code>/etc/salt/minion</code>中<code>master_finger</code>的值。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#salt-key is used to manage Salt authentication keys</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看master的key</span></span><br><span class="line">salt-key -F master</span><br><span class="line"></span><br><span class="line">Local Keys:</span><br><span class="line">master.pem:  60:87:25:6a:68:28:4a:bf:5e:87:ee:4f:3f:46:d4:8e:38:8b:58:d9:8a:f4:44:b6:64:67:d9:da:0f:5d:f3:b4</span><br><span class="line">master.pub:  46:52:c1:36:f2:6f:33:c0:72:a1:18:5e:99:36:04:ea:1a:9b:ea:e7:61:3b:d9:30:34:c1:f1:3b:65:08:f8:42</span><br><span class="line"><span class="comment">#将公钥写入salt-minion配置文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看minion的finger</span></span><br><span class="line"><span class="comment">#salt-key --finger &lt;minion_id&gt;</span></span><br><span class="line">salt-key --finger <span class="string">'192.168.1.7'</span></span><br></pre></td></tr></table></figure>
<p><strong>Minion Key Fingerprint</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#salt-call is used to execute module functions locally on a Salt Minion</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看minion key fingerprint</span></span><br><span class="line"><span class="comment">#可在master上查看，比对两者是否相同</span></span><br><span class="line">salt-call --<span class="built_in">local</span> key.finger</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="密钥管理"><a href="#密钥管理" class="headerlink" title="密钥管理"></a>密钥管理</h4><p>Key Management</p>
<p>Salt使用AES Encryption加密<code>salt-master</code>与<code>salt-minion</code>间的所有通信。这确保了发送到Minion的命令不会被篡改(tamper)，并保证了master与minion间是认证的和受信任的。</p>
<p>当命令发送到<code>salt-minion</code>之前，<code>salt-minion</code>的key必须要被<code>salt-master</code>所接受。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出salt-master上已知的keys</span></span><br><span class="line">salt-key -L</span><br></pre></td></tr></table></figure>
<p>其中包含四项:</p>
<ul>
<li>Accepted Keys:</li>
<li>Denied Keys:</li>
<li>Unaccepted keys:</li>
<li>Rejected keys:</li>
</ul>
<p><strong>让<code>salt-master</code>接收key，并允许<code>salt-minion</code>被<code>salt-master</code>控制</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-a 192.168.1.7, --accept=192.168.1.7</span></span><br><span class="line"><span class="comment">#-A, --accept-all</span></span><br><span class="line"></span><br><span class="line">salt-key -A</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="发送命令"><a href="#发送命令" class="headerlink" title="发送命令"></a>发送命令</h4><p>Sending Commands</p>
<p><code>salt-master</code>和<code>salt-minion</code>之间通过运行<code>test.ping</code>命令来证实(verified)。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">salt 192.168.1.7 test.ping</span><br><span class="line"></span><br><span class="line">salt * test.ping</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="其它安装指南"><a href="#其它安装指南" class="headerlink" title="其它安装指南"></a>其它安装指南</h2><p>Additional Installation Guides</p>
<p><br></p>
<h3 id="Salt-Bootstrap"><a href="#Salt-Bootstrap" class="headerlink" title="Salt Bootstrap"></a>Salt Bootstrap</h3><p>Salt Bootstrap脚本允许用户在各种系统和版本上安装<code>salt-minion</code>和<code>salt-master</code>。shell脚本为<code>bootstrap-salt.sh</code>，运行一系列的检查来确定操作系统的类型和版本，然后通过适当的方法安装salt二进制文件。salt-bootstrap脚本安装运行<code>salt</code>的最小化安装包，如Git便不会安装。</p>
<p>Salt Bootstrap’s GitHub: <a href="https://github.com/saltstack/salt-bootstrap" target="_blank" rel="noopener">https://github.com/saltstack/salt-bootstrap</a></p>
<p><br></p>
<h4 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h4><p>Satl Bootstrap脚本有多种可以传递的选项，以及获取引导脚本本身的方法。</p>
<p><strong>1. 使用<code>curl</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -o bootstrap-salt.sh -L https://bootstrap.saltstack.com</span><br><span class="line">sh bootstrap-salt.sh git develop</span><br></pre></td></tr></table></figure>
<p><strong>2. 使用<code>wget</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O bootstrap-salt.sh https://bootstrap.saltstack.com</span><br><span class="line">sh bootstrap-salt.sh</span><br></pre></td></tr></table></figure>
<p><strong>3. An Insecure one-liner</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://bootstrap.saltstack.com | sh</span><br><span class="line"></span><br><span class="line">wget -O - https://bootstrap.saltstack.com | sh</span><br><span class="line"></span><br><span class="line">curl -L https://bootstrap.saltstack.com | sh -s -- git develop</span><br></pre></td></tr></table></figure>
<p><strong>4. cmd line options</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查看帮助</span><br><span class="line">sh bootstrap-salt.sh -h</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><p><code>salt-master</code>和<code>salt-minion</code>间的通信使用AES加密的<code>ZeroMQ</code>，它使用TCP的4505和4506端口，仅需要在<code>salt-master</code>上可访问就行。</p>
<p>下面概述了关于<code>salt-master</code>的防火墙规则：</p>
<p><strong>RHEL7/CENTOS7</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=&lt;zone&gt; --add-port=4505-4506/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Preseed-minion-with-accepted-key"><a href="#Preseed-minion-with-accepted-key" class="headerlink" title="Preseed minion with accepted key"></a>Preseed minion with accepted key</h3><p>某些情况下，在<code>salt-master</code>上接受<code>minion-key</code>之前等待<code>salt-minion</code>启动是不方便的。比如，你可能希望<code>minion</code>一上线(online)就引导。</p>
<p>有多种方式生成<code>minion-key</code>，下面是一般生成<code>minion-key</code>的四个步骤：</p>
<ol>
<li>在master上生成key：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#请给key取个名字</span><br><span class="line">salt-key --gen-keys=[key_name]</span><br></pre></td></tr></table></figure>
<ol>
<li>把公钥(publick key)添加到已接受的minion文件夹中:</li>
</ol>
<p>公钥文件和 minion_id 有相同的名字是很有必要的，这就是Salt如何通过key与minions匹配。<br>还有，由于不同操作系统或特定的master配置文件，pki 文件夹可能位于不同的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &lt;key_name&gt;.pub /etc/salt/pkimaster/minions/&lt;minion_id&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li>分配<code>minion-key</code>：</li>
</ol>
<p>对于minion来说，没有单一方法去得到密钥对，难点是找到一种安全的分配方法。</p>
<p>由于<code>master</code>已经接受了<code>minion-key</code>，因此分发私钥(private key)会有潜在的安全风险。</p>
<ol>
<li>配置带key的minion：</li>
</ol>
<p>你可能希望在启动<code>salt-miniont daemon</code>之前取得<code>minion-key</code>的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/salt/pki/minion/minion.pem</span><br><span class="line">/etc/salt/pki/minion/minion.pub</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="以普通用户运行root"><a href="#以普通用户运行root" class="headerlink" title="以普通用户运行root"></a>以普通用户运行root</h3><p>Running salt as normal user tutorial</p>
<p><strong>以普通用户(non-root)运行salt function</strong></p>
<p>如果你不想使用<code>root</code>用户安装或运行salt，你可以在你的工作目录中创建一个虚拟根目录(virtual root dir)来配置它。<br>salt system使用<code>salt.syspath</code>module来查找变量。</p>
<p>如果你运行salt-build，它会生成在: <code>./build/lib.linux-x86_64-2.7/salt/_syspaths.py</code>；</p>
<p>运行<code>python setup.py build</code>命令来生成它；</p>
<p>复制生成的module到你的salt dir，<code>cp ./build/lib.linux-x86_64-2.7/salt/_syspaths.py ./salt/_syspaths.py</code></p>
<p>修改它，并加入需要的变量和新路径：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># you need to edit this</span></span><br><span class="line">ROOT_DIR = *your current dir* + <span class="string">'/salt/root'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># you need to edit this</span></span><br><span class="line">INSTALL_DIR = *location of source code*</span><br><span class="line"></span><br><span class="line">CONFIG_DIR =  ROOT_DIR + <span class="string">'/etc/salt'</span></span><br><span class="line">CACHE_DIR = ROOT_DIR + <span class="string">'/var/cache/salt'</span></span><br><span class="line">SOCK_DIR = ROOT_DIR + <span class="string">'/var/run/salt'</span></span><br><span class="line">SRV_ROOT_DIR= ROOT_DIR + <span class="string">'/srv'</span></span><br><span class="line">BASE_FILE_ROOTS_DIR = ROOT_DIR + <span class="string">'/srv/salt'</span></span><br><span class="line">BASE_PILLAR_ROOTS_DIR = ROOT_DIR + <span class="string">'/srv/pillar'</span></span><br><span class="line">BASE_MASTER_ROOTS_DIR = ROOT_DIR + <span class="string">'/srv/salt-master'</span></span><br><span class="line">LOGS_DIR = ROOT_DIR + <span class="string">'/var/log/salt'</span></span><br><span class="line">PIDFILE_DIR = ROOT_DIR + <span class="string">'/var/run'</span></span><br><span class="line">CLOUD_DIR = INSTALL_DIR + <span class="string">'/cloud'</span></span><br><span class="line">BOOTSTRAP = CLOUD_DIR + <span class="string">'/deploy/bootstrap-salt.sh'</span></span><br></pre></td></tr></table></figure>
<p>创建目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p root/etc/salt root/var/cache/run root/run/salt root/srv</span><br><span class="line">root/srv/salt root/srv/pillar root/srv/salt-master root/var/log/salt root/var/run</span><br></pre></td></tr></table></figure>
<p>填充配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp -r conf/* /etc/salt/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /etc/salt/master</span><br><span class="line"></span><br><span class="line">user: *your user name*</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYTHONPATH=`pwd` scripts/salt-cloud</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="minion独立运行"><a href="#minion独立运行" class="headerlink" title="minion独立运行"></a>minion独立运行</h3><p>Standalone minion</p>
<p>因为<code>salt-minion</code>包含了如此广泛的功能，它可以独立运行。<br>一个独立的minion可以用来做很多事情:</p>
<ul>
<li>在没有连接到<code>master</code>的系统上使用<code>salt-call</code>命令；</li>
<li>无主状态(masterless states)。</li>
</ul>
<p>当以无主模式运行salt时，不要运行<code>salt-minion daemon</code>。否则，它将尝试连接到master并失败。<br><code>salt-call</code>命令是独立的，不需要<code>salt-minion daemon</code>。</p>
<p><br></p>
<h4 id="minion配置"><a href="#minion配置" class="headerlink" title="minion配置"></a>minion配置</h4><p>有几个参考方法来设置不同的选项来配置<code>masterless minion</code>，<code>salt-minion</code>很容易通过配置文件(默认位于:<code>/etc/salt/minion</code>)进行配置。</p>
<p><br></p>
<p><strong>告诉salt运行masterless</strong></p>
<p><code>salt-call</code>命令用于在<code>salt-minion</code>本地运行模块功能，而不是在<code>salt-master</code>执行他们。通常，<code>salt-call</code>命令检查主机检索文件服务器和支柱数据，当时当运行<code>standalone salt-call</code>时，需要指示不要检查master的这些数据。<br>为了指示<code>minion</code>不要查找<code>master</code>，需要在运行<code>salt-call</code>时设置<code>file_client</code>配置选项。默认情况下，<code>file_client</code>被设置为<code>remote</code>让<code>minion</code>知道将从<code>master</code>中收集文件服务器和支柱数据。当设置<code>file_client</code>为<code>local</code>时，<code>minion</code>将不会从<code>master</code>收集这些数据。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">file_client:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这样，salt-call命令将不会查找master</span></span><br><span class="line"><span class="comment">#并认为本地系统拥有所有的文件文支柱资源</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>masterless运行状态</strong></p>
<p>the state system在所有需要的文件都在<code>minion</code>本地，轻易地在没有<code>salt-master</code>的情况下运行。为了达到此效果，需要配置<code>minion</code>配置文件，以了解如何像<code>master</code>一样返回file_roots信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt</span></span><br></pre></td></tr></table></figure>
<p>现在设置salt state tree, top file和SLS modules，就像在<code>master</code>上设置它们一样。将<code>file_client</code>设置为<code>local</code>，并且一个可用的state tree会调用state module中的function，将使用<code>minion</code>上的file_roots中的信息而不是<code>master</code>。</p>
<p>当在一个<code>minion</code>上创建一个<code>state tree</code>时，不需要语法或路径的更改。<code>master</code>上的SLS modules不需要进行任何修改就可以与<code>minion</code>一起工作。这就使得salt scrit不需要设置一个<code>master</code>就能轻易部署，并允许这些SLS modules随着部署发展而容易转移到<code>master</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以声明的状态可以执行</span></span><br><span class="line">salt-call state.apply</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#无需修改配置文件</span></span><br><span class="line">salt-call state.apply --<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Salt无主模式"><a href="#Salt无主模式" class="headerlink" title="Salt无主模式"></a>Salt无主模式</h3><p>Salt masterless quickstart</p>
<p>运行一个无主模式的minion可以允许你在单一主机上使用salt配置管理，而不用在另一台主机上调用master。<br>在无主模式下运行salt时，请勿运行salt daemon。否则，它将尝试连接到master并失败。<code>salt-call</code>命令时独立的</p>
<p><br></p>
<p><strong>bootstrap salt minion</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://bootstrap.saltstack.com -o bootstrap_salt.sh</span><br><span class="line">sudo sh bootstrap_salt.sh</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>告诉salt运行masterless模式</strong><br>在minion配置文件中配置此，表示不去寻找master，并假设本地系统拥有所有文件和资源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/salt/minion</span><br><span class="line"></span><br><span class="line">file_client: local</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>创建状态树(state tree)</strong></p>
<ol>
<li>创建<code>top.sls</code>文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /srv/salt/top.sls</span><br><span class="line"></span><br><span class="line">base:</span><br><span class="line">  &apos;*&apos;:</span><br><span class="line">    - webserver</span><br></pre></td></tr></table></figure>
<ol>
<li>创建webserver状态树</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /srv/salt/webserver.sls</span><br><span class="line">#这是基于Debian</span><br><span class="line"></span><br><span class="line">apache:               # ID declaration</span><br><span class="line">  pkg:                # state declaration</span><br><span class="line">    - installed       # function declaration</span><br></pre></td></tr></table></figure>
<ol>
<li><code>salt-call</code><br><code>salt-call</code>命令在minion本地运行远程执行功能，而不是在master执行。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#--local,在本地文件系统查找状态树</span><br><span class="line">salt-call --local state.apply</span><br><span class="line"></span><br><span class="line">#minion首先检查top.sls，然后应用webserver.sls</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>Configuring Salt</p>
<p>本节介绍如何配置用户访问，查看，存储作业结果，安全，疑难解答以及如何执行其它管理任务。</p>
<p><br></p>
<h2 id="master"><a href="#master" class="headerlink" title="master"></a>master</h2><p>CONFIGURING THE SALT MASTER</p>
<ul>
<li>master config: <a href="https://docs.saltstack.com/en/latest/ref/configuration/master.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/configuration/master.html</a></li>
</ul>
<p><br></p>
<p>salt系统的两个组件都有相应的配置文件:</p>
<ul>
<li><code>/etc/salt/master</code></li>
<li><code>/etc/salt/minion</code></li>
</ul>
<p><br></p>
<h3 id="master配置项"><a href="#master配置项" class="headerlink" title="master配置项"></a>master配置项</h3><p>PRIMARY MASTER CONFIGURATION</p>
<p><strong>基础配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line">#INTERFACE，默认值0.0.0.0</span><br><span class="line">interface: 0.0.0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#IPv6，默认值False</span><br><span class="line">ipv6: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PUBLISH_PORT，默认值4505</span><br><span class="line">publish_port: 4505</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MASTER_ID，默认值None</span><br><span class="line">master_id: Master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#USER，默认值root</span><br><span class="line">user: root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ENALBE_SSH_MINIONS，默认值False</span><br><span class="line">enable_ssh_minions: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#RET_PORT，默认值4506</span><br><span class="line">#接收命令执行返回的端口</span><br><span class="line">ret_prot: 4506</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PIDFILE，默认值/var/run/salt-master.pid</span><br><span class="line">pidfile: /var/run/salt-master.pid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ROOT_DIR，默认值/</span><br><span class="line">root_dir: /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#CONF_FILE，默认值/etc/salt/master</span><br><span class="line">conf_file: /etc/salt/master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PKI_DIR，默认值/etc/salt/pki/master</span><br><span class="line">#存储pki认证密钥的目录</span><br><span class="line">pki_dir: /etc/salt/pki/master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EXTENSION_MODULES，默认值/var/cache/salt/master/extmods</span><br><span class="line">extension_modules: /root/salt_extmods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EXTMOD_WHITELIST/EXTMOD_BLACKLIST</span><br><span class="line">#有效的选项: modules, states, grains, renderers, returners, output, proxy, runners,</span><br><span class="line">#wheel, engines, queues, utils, pillar, sdb, cache, clouds, tops, roster, tokens</span><br><span class="line">extmod_whitelist:</span><br><span class="line">  modules:</span><br><span class="line">    - custom_module</span><br><span class="line">  engines:</span><br><span class="line">    - custom_engine</span><br><span class="line">  pillars: []</span><br><span class="line"></span><br><span class="line">extmod_blacklist:</span><br><span class="line">  modules:</span><br><span class="line">    - specific_module</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MODULE_DIRS，默认值[]</span><br><span class="line">module_dirs:</span><br><span class="line">  - /var/cache/salt/minion/extmods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#CACHEDIR，默认值/var/cache/salt/master</span><br><span class="line">cachedir: /var/cache/salt/master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#VERIFY_ENV，默认值True</span><br><span class="line">#在启动时验证并设置目录权限</span><br><span class="line">verify_env: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#KEEP_JOBS，默认值24</span><br><span class="line">#设置保留旧作业信息的小时数，0表示禁用缓存清理</span><br><span class="line">keep_jobs: 24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#GATHER_JOB_TIMEOUT，默认10</span><br><span class="line">#客户端请求正在运行的作业信息是等待的秒数</span><br><span class="line">gather_job_timeout: 10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TIMEOUT，默认值5</span><br><span class="line">#salt命令和api默认超时值</span><br><span class="line">timeout: 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#LOOP_INTERVAL，默认值60</span><br><span class="line">#维护过程检查周期的秒数</span><br><span class="line">loop_interval: 60</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#OUTPUT，默认值nested</span><br><span class="line">#设置命令使用的默认输出器</span><br><span class="line">output: nested</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#OUTPUTTER_DIRS，默认值[]</span><br><span class="line">#salt输出器附加目录列表</span><br><span class="line">outputter_dirs: []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#OUTPUT_FILE，默认值None</span><br><span class="line">#salt命令使用的默认输出文件</span><br><span class="line">output_file: /path/output/file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#SHOW_TIMEOUT，默认值True</span><br><span class="line">#告诉client已超时的minion</span><br><span class="line">show_timeout: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#SHOW_JID，默认值False</span><br><span class="line">#告诉client在工作发布时显示jid</span><br><span class="line">show_jid: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#COLOR，默认值True</span><br><span class="line">#彩色输出</span><br><span class="line">color: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#COLOR_THEME，默认值&quot;&quot;</span><br><span class="line">color_theme: /etc/salt/color_theme</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#CLI_SUMMARY，默认False</span><br><span class="line">#显示目标minion数量的摘要</span><br><span class="line">cli_summary: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#SOCK_DIR</span><br><span class="line">#Default: /var/run/salt/master</span><br><span class="line">#创建Unix socket的位置</span><br><span class="line">sock_dir: /var/run/salt/master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ENABLE_GPU_GRAINS</span><br><span class="line">#Default: True</span><br><span class="line">#启用GPU硬件数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#JOB_CACHE</span><br><span class="line">#Default: True</span><br><span class="line">#维护一个临时作业缓存</span><br><span class="line">job_cache: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MINION_DATA_CACHE</span><br><span class="line">#Default: True</span><br><span class="line">#存储在master端的minion数据缓存</span><br><span class="line">minion_data_cache: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#CACHE</span><br><span class="line">#Default: localfs</span><br><span class="line">#缓存子系统模块用于minion数据缓存</span><br><span class="line">cache: consul</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MEMCACHE_EXPIRE_SECONDS</span><br><span class="line">#Default: 0，禁用</span><br><span class="line">#内存缓存数据过期时间</span><br><span class="line">memcache_expire_seconds: 30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MEMCACHE_MAX_ITEMS</span><br><span class="line">#Default: 1024</span><br><span class="line">#缓存项限制</span><br><span class="line">memcache_max_items: 1024</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MEMCACHE_FULL_CLEANUP</span><br><span class="line">#Default: False</span><br><span class="line">#如果缓存已满(超过max_literms)，则项目将清除其存储</span><br><span class="line">memcache_full_cleanup: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MEMCACHE_DEBUG</span><br><span class="line">#Default: False</span><br><span class="line">#收集缓存统计信息并记入调试日志级别</span><br><span class="line">memcache_debug: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EXT_JOB_CACHE</span><br><span class="line">#Default: &apos;&apos;</span><br><span class="line">#指定所有minion的默认returner</span><br><span class="line">ext_job_cache: redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EVENT_RETURN</span><br><span class="line">#Default: &apos;&apos;</span><br><span class="line">#指定用于记录时间的returner</span><br><span class="line">event_return:</span><br><span class="line">  - syslog</span><br><span class="line">  - splunk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EVENT_RETURN_QUEUE</span><br><span class="line">#Default: 0</span><br><span class="line">#在繁忙的系统上，启用event_returns可能会给存储系统造成相当大的负载。事件可以在master使用队列排队，并以批处理方式使用单个事务存储多个事件</span><br><span class="line">event_return_queue: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EVENT_RETURN_WHITELIST</span><br><span class="line">#Default: []</span><br><span class="line">event_return_whitelist:</span><br><span class="line">  - salt/master/a_tag</span><br><span class="line">  - salt/run/*/ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#EVENT_RETURN_BLACKLIST</span><br><span class="line">#Default: []</span><br><span class="line">event_return_blacklist:</span><br><span class="line">  - salt/master/not_this_tag</span><br><span class="line">  - salt/wheel/*/ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MAX_EVENT_SIZE</span><br><span class="line">#Default: 1048576，单位为Byte</span><br><span class="line">#传递非常大的事件可能导致minion消耗大量的内存</span><br><span class="line">max_event_size: 1048576</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PING_ON_ROTATE</span><br><span class="line">#Default: False</span><br><span class="line">#告知master在AES密钥刷新后立即ping所有minion</span><br><span class="line">ping_on_rotate: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MASTER_JOB_CACHE</span><br><span class="line">#Default: local_cache</span><br><span class="line">master_job_cache: redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ENFORCE_MINE_CACHE</span><br><span class="line">#Default: False</span><br><span class="line">enforce_mine_cache: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MAX_MINIONS</span><br><span class="line">#Default: 0，表示不限制</span><br><span class="line">#master允许连接的最大minion数</span><br><span class="line">max_minions: 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#CON_CACHE</span><br><span class="line">#Default: False</span><br><span class="line">#为所有连接提供缓存</span><br><span class="line">con_cache: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PRESENCE_EVENTS</span><br><span class="line">#Default: False</span><br><span class="line">#master周期性地寻找主动连接的minion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#PING_ON_ROTATE，默认False</span><br><span class="line">#默认情况下，master AES key每24h轮换一次</span><br><span class="line">#要告诉master在AES key刷新后立即Ping所有minions，请设置为True。但这样可能在刷新后立即导致Master的高负载，因为它管理着大量的minion，请注意</span><br><span class="line">#如果禁用，建议使用密钥标记监听`aes_key_rotate`</span><br><span class="line">ping_on_rotate: False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TRANSPORT</span><br><span class="line">#Default: zeromq</span><br><span class="line">#修改底层传输层，支持的值有zeromq, raet, tcp</span><br><span class="line">transport: zeromq</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TRANSPORT_OPTS</span><br><span class="line">#Default: &#123;&#125;</span><br><span class="line">#启用多个传输</span><br><span class="line">transport_opts:</span><br><span class="line">  tcp:</span><br><span class="line">    publish_port: 4605</span><br><span class="line">    ret_port: 4606</span><br><span class="line">  zeromq: []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MASTER_STATS</span><br><span class="line">#Default: False</span><br><span class="line">#Master统计信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MASTER_STATS_EVENT_ITER</span><br><span class="line">#Default: 60</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#SOCK_POOL_SIZE</span><br><span class="line">#Default: 1</span><br><span class="line">#为了避免将数据写入套接字时阻塞等待，启用salt应用程序的套接字池</span><br><span class="line">sock_pool_size: 15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#IPC_MODE</span><br><span class="line">#Default: ipc</span><br><span class="line">#windows default: tcp</span><br><span class="line">ipc_mode: ipc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TCP_MASTER_PUB_PORT</span><br><span class="line">#Default: 4512</span><br><span class="line">#ipc_mode的tcp端口</span><br><span class="line">tcp_master_pub_port: 4512</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TCP_MASTER_PULL_PORT</span><br><span class="line">#Default: 4513</span><br><span class="line">#ipc_mode的tcp端口</span><br><span class="line">tcp_master_pull_port: 4513</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TCP_MASTER_PUBLISH_PULL</span><br><span class="line">#Default: 4514</span><br><span class="line">tcp_master_publish_pull: 4514</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#TCP_MASTER_WORKERS</span><br><span class="line">#Default: 4515</span><br><span class="line"># mworkers连接到master的端口</span><br><span class="line">tcp_master_workers: 4515</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#AUTH_EVENTS</span><br><span class="line">#Default: True</span><br><span class="line">auth_events: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#MINION_DATA_CACHE_EVENTS</span><br><span class="line">#Default: True</span><br><span class="line">minion_data_cache_events: True</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="salt-ssh"><a href="#salt-ssh" class="headerlink" title="salt-ssh"></a>salt-ssh</h3><p>SALT-SSH CONFIGURATION</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ROSTER</span></span><br><span class="line"><span class="comment">#Default: flat</span></span><br><span class="line"><span class="comment">#定义默认ROSTER模块</span></span><br><span class="line"><span class="attr">roster:</span> <span class="string">cache</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ROSTER_DEFAULTS</span></span><br><span class="line"><span class="comment">#所有rosters都能继承的设置</span></span><br><span class="line"><span class="attr">roster_defaults:</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">daniel</span></span><br><span class="line"><span class="attr">  sudo:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">  priv:</span> <span class="string">/root/.ssh/id_rsa</span></span><br><span class="line"><span class="attr">  tty:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ROSTER_FILE</span></span><br><span class="line"><span class="comment">#Default: /etc/salt/roster</span></span><br><span class="line"><span class="attr">roster_file:</span> <span class="string">/root/roster</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ROSTERS</span></span><br><span class="line"><span class="comment">#Default: None</span></span><br><span class="line"><span class="comment">#定义roster的位置，以便在使用salt api时选择他们</span></span><br><span class="line"><span class="attr">rosters:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">/etc/salt/roster.d</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">/opt/salt/some/more/rosters</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_PASSWD</span></span><br><span class="line"><span class="comment">#Default: ''</span></span><br><span class="line"><span class="comment">#用于登录的ssh密码</span></span><br><span class="line"><span class="attr">ssh_passwd:</span> <span class="string">abc@123</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_PORT</span></span><br><span class="line"><span class="comment">#Default: 22</span></span><br><span class="line"><span class="comment">#目标系统的ssh端口</span></span><br><span class="line"><span class="attr">ssh_port:</span> <span class="number">22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_SCAN_PORTS</span></span><br><span class="line"><span class="comment">#Default: 22</span></span><br><span class="line"><span class="comment">#多个值以逗号(,)分隔</span></span><br><span class="line"><span class="attr">ssh_scan_ports:</span> <span class="number">22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_SCAN_TIMEOUT</span></span><br><span class="line"><span class="comment">#Default: 0.01</span></span><br><span class="line"><span class="attr">ssh_scan_timeout:</span> <span class="number">0.01</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_SUDO</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">ssh_sudo:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_TIMEOUT</span></span><br><span class="line"><span class="comment">#Default: 60</span></span><br><span class="line"><span class="attr">ssh_timeout:</span> <span class="number">60</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_USER</span></span><br><span class="line"><span class="comment">#Default: root</span></span><br><span class="line"><span class="attr">ssh_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_LOG_FILE</span></span><br><span class="line"><span class="comment">#Default: /var/log/salt/ssh</span></span><br><span class="line"><span class="comment">#salt-ssh命令的日志文件</span></span><br><span class="line"><span class="attr">ssh_log_file:</span> <span class="string">/var/log/salt/ssh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_MINION_OPTS</span></span><br><span class="line"><span class="comment">#Default: None</span></span><br><span class="line"><span class="attr">ssh_minion_opts:</span></span><br><span class="line"><span class="attr">  gpg_keydir:</span> <span class="string">/root/gpg</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_USE_HOME_KEY</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#使用~/.ssh/id_rsa对salt-ssh身份验证</span></span><br><span class="line"><span class="attr">ssh_use_home_key:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_IDENTITIES_ONLY</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#设置为True表示为salt-ssh -o IdentitiesOnly=yes</span></span><br><span class="line"><span class="attr">ssh_identities_only:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSH_LIST_NODEGROUPS</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br><span class="line"><span class="attr">ssh_list_nodegroups:</span></span><br><span class="line"><span class="attr">  groupA:</span> <span class="string">minion1,minion2</span></span><br><span class="line"><span class="attr">  groupB:</span> <span class="string">minion1,minion3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#THIN_EXTRA_MODS</span></span><br><span class="line"><span class="comment">#Default: None</span></span><br><span class="line"><span class="comment">#包含在salt thin中的附加模块</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MIN_EXTRA_MODS</span></span><br><span class="line"><span class="comment">#Default: None</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="安全配置"><a href="#安全配置" class="headerlink" title="安全配置"></a>安全配置</h3><p>MASTER SECURITY SETTINGS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OPEN_MODE</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#open mode关闭认证并通知master接受所有身份认证</span></span><br><span class="line"><span class="attr">open_mode:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTO_ACCEPT</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#自动接收所有来自minion的public key</span></span><br><span class="line"><span class="attr">auto_accept:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#KEYSIZE</span></span><br><span class="line"><span class="comment">#Default: 2048</span></span><br><span class="line"><span class="comment">#创建新Key时生成的Key大小</span></span><br><span class="line"><span class="attr">keysize:</span> <span class="number">2048</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTOSIGN_TIMEOUT</span></span><br><span class="line"><span class="comment">#Default: 120</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTOSIGN_FILE</span></span><br><span class="line"><span class="comment">#Default: not defined</span></span><br><span class="line"><span class="comment">#此文件中指定的传入key将自动被接受</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTOREJECT_FILE</span></span><br><span class="line"><span class="comment">#Default: not defined</span></span><br><span class="line"><span class="comment">#此文件中指定的传入key将自动被拒绝</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTOSIGN_GRAINS_DIR</span></span><br><span class="line"><span class="comment">#Default: not defined</span></span><br><span class="line"><span class="attr">autosign_grains_dir:</span> <span class="string">/etc/salt/autosign_grains</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PERMISSIVE_PKI_ACCESS</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">permissive_pki_access:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PUBLISHER_ACL</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br><span class="line"><span class="comment">#允许master上用户执行特定模块</span></span><br><span class="line"><span class="attr">publisher_acl:</span></span><br><span class="line"><span class="attr">  fred:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test.ping</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">pkg.*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PUBLISHER_ACL_BLACKLIST</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br><span class="line"><span class="attr">publisher_acl_blacklist:</span></span><br><span class="line"><span class="attr">  users:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">root</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'^(?!sudo_).*$'</span>   <span class="comment">#  all non sudo users</span></span><br><span class="line"><span class="attr">  modules:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cmd.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test.echo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SUDO_ACL</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">sudo_acl:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#EXTERNAL_AUTH</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br><span class="line"><span class="attr">external_auth:</span></span><br><span class="line"><span class="attr">  pam:</span></span><br><span class="line"><span class="attr">    fred:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">test.*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TOKEN_EXPIRE</span></span><br><span class="line"><span class="comment">#Default: 43200(12h)</span></span><br><span class="line"><span class="attr">token_expire:</span> <span class="number">43200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TOKEN_EXPIRE_USER_OVERRIDE</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">token_expire_user_override:</span></span><br><span class="line"><span class="attr">  pam:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fred</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">  ldap:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">gary</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#KEEP_ACL_IN_TOKEN</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">keep_acl_in_token:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#EAUTH_ACL_MODULE</span></span><br><span class="line"><span class="comment">#Default: ''</span></span><br><span class="line"><span class="attr">eauth_acl_module:</span> <span class="string">django</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#FILE_RECV</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#允许minion将文件推送给master</span></span><br><span class="line"><span class="attr">file_recv:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#FILE_RECV_MAX_SIZE</span></span><br><span class="line"><span class="comment">#Default: 100</span></span><br><span class="line"><span class="attr">file_recv_max_size:</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MASTER_SIGN_PUBKEY</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#使用master公钥的加密签名来签署master认证回复</span></span><br><span class="line"><span class="attr">master_sign_pubkey:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MASTER_SIGN_KEY_NAME</span></span><br><span class="line"><span class="comment">#Default: master_sign</span></span><br><span class="line"><span class="comment">#自定义签名密钥的名称</span></span><br><span class="line"><span class="attr">master_sign_key_name:</span> <span class="string">&lt;filename_without_suffix&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MASTER_PUBKEY_SIGNATURE</span></span><br><span class="line"><span class="comment">#Default: master_pubkey_signature</span></span><br><span class="line"><span class="attr">master_pubkey_signature:</span> <span class="string">&lt;filename&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MASTER_USE_PUBKEY_SIGNATURE</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">master_use_pubkey_signature:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ROTATE_AES_KEY</span></span><br><span class="line"><span class="comment">#Default: True</span></span><br><span class="line"><span class="comment">#当salt-key删除一个minion-public时，轮询salt-master的AES-key</span></span><br><span class="line"><span class="attr">rotate_aes_key:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PUBLISH_SESSION</span></span><br><span class="line"><span class="comment">#Default: 86400</span></span><br><span class="line"><span class="comment">#master上AES key轮询之间的秒数</span></span><br><span class="line"><span class="attr">publish_session:</span> <span class="attr">Default:</span> <span class="number">86400</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SSL</span></span><br><span class="line"><span class="comment">#Default: None</span></span><br><span class="line"><span class="comment">#TLS/SSL连接项</span></span><br><span class="line"><span class="attr">ssl:</span></span><br><span class="line"><span class="attr">    keyfile:</span> <span class="string">&lt;path_to_keyfile&gt;</span></span><br><span class="line"><span class="attr">    certfile:</span> <span class="string">&lt;path_to_certfile&gt;</span></span><br><span class="line"><span class="attr">    ssl_version:</span> <span class="string">PROTOCOL_TLSv1_2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ALLOW_MINION_KEY_REVOKE</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="comment">#默认情况下，当minion key被移除时，master会删除它的缓存数据</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="大规模调整设置"><a href="#大规模调整设置" class="headerlink" title="大规模调整设置"></a>大规模调整设置</h3><p>MASTER LARGE SCALE TUNING SETTINGS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MAX_OPEN_FILES</span></span><br><span class="line"><span class="comment">#Default: 100000</span></span><br><span class="line"><span class="comment">#请注意ulimit</span></span><br><span class="line"><span class="attr">max_open_files:</span> <span class="number">100000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#WORKER_THREADS</span></span><br><span class="line"><span class="comment">#Default: 5</span></span><br><span class="line"><span class="attr">worker_threads:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PUB_HWM</span></span><br><span class="line"><span class="comment">#Default: 1000</span></span><br><span class="line"><span class="attr">pub_hwm:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ZMQ_BACKLOG</span></span><br><span class="line"><span class="comment">#Default: 1000</span></span><br><span class="line"><span class="comment">#zeromq backlog的监听队列大小</span></span><br><span class="line"><span class="attr">zmq_backlog:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SALT_EVENT_PUB_HWM AND EVENT_PUBLISHER_PUB_HWM</span></span><br><span class="line"><span class="attr">salt_event_pub_hwm:</span> <span class="number">20000</span></span><br><span class="line"><span class="attr">event_publisher_pub_hwm:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="模块管理"><a href="#模块管理" class="headerlink" title="模块管理"></a>模块管理</h3><p>MASTER MODULE MANAGEMENT</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#RUNNER_DIRS</span></span><br><span class="line"><span class="comment">#Default: []</span></span><br><span class="line"><span class="attr">runner_dirs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/var/lib/salt/runners</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#UTILS_DIRS</span></span><br><span class="line"><span class="comment">#Default: []</span></span><br><span class="line"><span class="attr">utils_dirs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/var/lib/salt/utils</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CYTHON_ENABLE</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">cython_enable:</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="系统状态设置"><a href="#系统状态设置" class="headerlink" title="系统状态设置"></a>系统状态设置</h3><p>MASTER STATE SYSTEM SETTINGS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#STATE_TOP</span></span><br><span class="line"><span class="comment">#Default: top.sls</span></span><br><span class="line"><span class="attr">state_top:</span> <span class="string">top.sls</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#STATE_TOP_SALTENV</span></span><br><span class="line"><span class="comment">#无默认值</span></span><br><span class="line"><span class="attr">state_top_saltenv:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TOP_FILE_MERGING_STRATEGY</span></span><br><span class="line"><span class="comment">#Default: merge</span></span><br><span class="line"><span class="attr">top_file_merging_strategy:</span> <span class="string">same</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ENV_ORDER</span></span><br><span class="line"><span class="comment">#Default: []</span></span><br><span class="line"><span class="attr">env_order:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dev</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">qa</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="文件服务器设置"><a href="#文件服务器设置" class="headerlink" title="文件服务器设置"></a>文件服务器设置</h3><p>MASTER FILE SERVER SETTINGS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="本地文件服务器"><a href="#本地文件服务器" class="headerlink" title="本地文件服务器"></a>本地文件服务器</h3><p>ROOTS: MASTER’S LOCAL FILE SERVER</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="git远程文件服务器后端"><a href="#git远程文件服务器后端" class="headerlink" title="git远程文件服务器后端"></a>git远程文件服务器后端</h3><p>GITFS: GIT REMOTE FILE SERVER BACKEND</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="gitfs认证项"><a href="#gitfs认证项" class="headerlink" title="gitfs认证项"></a>gitfs认证项</h3><p>GITFS AUTHENTICATION OPTIONS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="hgfs远程文件服务器后端"><a href="#hgfs远程文件服务器后端" class="headerlink" title="hgfs远程文件服务器后端"></a>hgfs远程文件服务器后端</h3><p>HGFS: MERCURIAL REMOTE FILE SERVER BACKEND</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="svnfs远程文件服务器后端"><a href="#svnfs远程文件服务器后端" class="headerlink" title="svnfs远程文件服务器后端"></a>svnfs远程文件服务器后端</h3><p>SVNFS: SUBVERSION REMOTE FILE SERVER BACKEND</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="minions远程文件服务器后端"><a href="#minions远程文件服务器后端" class="headerlink" title="minions远程文件服务器后端"></a>minions远程文件服务器后端</h3><p>MINIONFS: MINIONFS REMOTE FILE SERVER BACKEND</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="azurefs文件服务器后端"><a href="#azurefs文件服务器后端" class="headerlink" title="azurefs文件服务器后端"></a>azurefs文件服务器后端</h3><p>AZUREFS: AZURE FILE SERVER BACKEND</p>
<p><br></p>
<h3 id="S3文件服务器后端"><a href="#S3文件服务器后端" class="headerlink" title="S3文件服务器后端"></a>S3文件服务器后端</h3><p>S3FS: S3 FILE SERVER BACKEND</p>
<p><br></p>
<h3 id="pillar配置"><a href="#pillar配置" class="headerlink" title="pillar配置"></a>pillar配置</h3><p>PILLAR CONFIGURATION</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="reactor设置"><a href="#reactor设置" class="headerlink" title="reactor设置"></a>reactor设置</h3><p>MASTER REACTOR SETTINGS</p>
<p><br></p>
<h3 id="salt-api设置"><a href="#salt-api设置" class="headerlink" title="salt-api设置"></a>salt-api设置</h3><p>SALT-API MASTER SETTINGS</p>
<p><br></p>
<h3 id="syndic服务器"><a href="#syndic服务器" class="headerlink" title="syndic服务器"></a>syndic服务器</h3><p>SYNDIC SERVER SETTINGS</p>
<p><br></p>
<h3 id="peer-publish"><a href="#peer-publish" class="headerlink" title="peer publish"></a>peer publish</h3><p>PEER PUBLISH SETTINGS</p>
<p><br></p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>MASTER LOGGING SETTINGS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#LOG_FILE</span></span><br><span class="line"><span class="comment">#Default: /var/log/salt/master</span></span><br><span class="line"><span class="attr">log_file:</span> <span class="string">/var/log/salt/master</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_LEVEL</span></span><br><span class="line"><span class="comment">#Default: warning</span></span><br><span class="line"><span class="attr">log_level:</span> <span class="string">notice</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_LEVEL_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: warning</span></span><br><span class="line"><span class="attr">log_level_logfile:</span> <span class="string">warning</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_DATEFMT</span></span><br><span class="line"><span class="comment">#Default: %H:%M:%S</span></span><br><span class="line"><span class="attr">log_datefmt:</span> <span class="string">'%H:%M:%S'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_DATEFMT_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: %Y-%m-%d %H:%M:%S</span></span><br><span class="line"><span class="attr">log_datefmt_logfile:</span> <span class="string">'%Y-%m-%d %H:%M:%S'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_FMT_CONSOLE</span></span><br><span class="line"><span class="comment">#Default: [%(levelname)-8s] %(message)s</span></span><br><span class="line"><span class="attr">log_fmt_console:</span> <span class="string">'%(colorlevel)s %(colormsg)s'</span></span><br><span class="line"><span class="attr">log_fmt_console:</span> <span class="string">'[%(levelname)-8s] %(message)s'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_FMT_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: %(asctime)s,%(msecs)03d [%(name)-17s][%(levelname)-8s] %(message)s</span></span><br><span class="line"><span class="attr">log_fmt_logfile:</span> <span class="string">'%(asctime)s,%(msecs)03d [%(name)-17s][%(levelname)-8s] %(message)s'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_GRANULAR_LEVELS</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="NODE-GROUPS"><a href="#NODE-GROUPS" class="headerlink" title="NODE GROUPS"></a>NODE GROUPS</h3><p>将minion进行逻辑分组</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#NODE GROUPS</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br><span class="line"><span class="attr">nodegroups:</span></span><br><span class="line"><span class="attr">  group1:</span> <span class="string">'L@foo.domain.com,bar.domain.com,baz.domain.com or bl*.domain.com'</span></span><br><span class="line"><span class="attr">  group2:</span> <span class="string">'G@os:Debian and foo.domain.com'</span></span><br><span class="line"><span class="attr">  group3:</span> <span class="string">'G@os:Debian and N@group1'</span></span><br><span class="line"><span class="attr">  group4:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'G@foo:bar'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'or'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'G@foo:baz'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#RANGE_SERVER</span></span><br><span class="line"><span class="comment">#Default: 'range:80'</span></span><br><span class="line"><span class="attr">range_server:</span> <span class="attr">range:80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#INCLUDE CONFIGURATION</span></span><br><span class="line"><span class="comment">#DEFAULT_INCLUDE</span></span><br><span class="line"><span class="comment">#Default: master.d/*.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#INCLUDE</span></span><br><span class="line"><span class="comment">#Default: not defined</span></span><br><span class="line"><span class="comment"># Include files from a master.d directory in the same</span></span><br><span class="line"><span class="comment"># directory as the master config file</span></span><br><span class="line"><span class="attr">include:</span> <span class="string">master.d/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Include a single extra file into the configuration</span></span><br><span class="line"><span class="attr">include:</span> <span class="string">/etc/roles/webserver</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Include several files and the master.d directory</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">extra_config</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">master.d/*</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/etc/roles/webserver</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#KEEPALIVE</span></span><br><span class="line"><span class="comment">#TCP_KEEPALIVE</span></span><br><span class="line"><span class="comment">#Default: True</span></span><br><span class="line"><span class="attr">tcp_keepalive:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TCP_KEEPALIVE_CNT</span></span><br><span class="line"><span class="comment">#Default: -1</span></span><br><span class="line"><span class="comment">#Sets the ZeroMQ TCP keepalive count</span></span><br><span class="line"><span class="attr">tcp_keepalive_cnt:</span> <span class="bullet">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TCP_KEEPALIVE_IDLE</span></span><br><span class="line"><span class="comment">#Default: 300</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TCP_KEEPALIVE_INTVL</span></span><br><span class="line"><span class="comment">#Default: -1</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="文件路径"><a href="#文件路径" class="headerlink" title="文件路径"></a>文件路径</h3><ul>
<li>Linux</li>
<li>Windows</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#Linux</span><br><span class="line"></span><br><span class="line">#path</span><br><span class="line">conf_file: /etc/salt/master</span><br><span class="line">log_file: /var/log/salt/master</span><br><span class="line">pidfile: /var/run/salt-master.pid</span><br><span class="line"></span><br><span class="line">#dir</span><br><span class="line">cachedir: /var/cache/salt/master</span><br><span class="line">extension_modules: /var/cache/salt/master/extmods</span><br><span class="line">pki_dir: /etc/salt/pki/master</span><br><span class="line">root_dir: /</span><br><span class="line">sock_dir: /var/run/salt/master</span><br><span class="line"></span><br><span class="line">#file_roots</span><br><span class="line">/srv/salt</span><br><span class="line">/srv/spm/salt</span><br><span class="line"></span><br><span class="line">#pillar_roots</span><br><span class="line">/srv/pillar</span><br><span class="line">/srv/spm/pillar</span><br><span class="line"></span><br><span class="line">#win repo</span><br><span class="line">winrepo_dir: /srv/salt/win/repo</span><br><span class="line">winrepo_dir_ng: /srv/salt/win/repo-ng</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Windows</span><br><span class="line"></span><br><span class="line">#path</span><br><span class="line">conf_file: c:\salt\conf\master</span><br><span class="line">log_file: c:\salt\var\log\salt\master</span><br><span class="line">pidfile: c:\salt\var\run\salt-master.pid</span><br><span class="line"></span><br><span class="line">#dir</span><br><span class="line">cachedir: c:\salt\var\cache\salt\master</span><br><span class="line">c:\salt\var\cache\salt\master\extmods</span><br><span class="line">pki_dir: c:\salt\conf\pki\master</span><br><span class="line">root_dir: c:\salt</span><br><span class="line">sock_dir: c:\salt\var\run\salt\master</span><br><span class="line"></span><br><span class="line">#file_roots</span><br><span class="line">c:\salt\srv\salt</span><br><span class="line">c:\salt\srv\spm\salt</span><br><span class="line"></span><br><span class="line">#pillar_roots</span><br><span class="line">c:\salt\srv\pillar</span><br><span class="line">c:\salt\srv\spm\pillar</span><br><span class="line"></span><br><span class="line">#win-repo</span><br><span class="line">winrepo_dir: c:\salt\srv\salt\win\repo</span><br><span class="line">winrepo_dir_ng: c:\salt\srv\salt\win\repo-ng</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="minion"><a href="#minion" class="headerlink" title="minion"></a>minion</h2><p>CONFIGURING THE SALT MINION</p>
<ul>
<li>minion config: <a href="https://docs.saltstack.com/en/latest/ref/configuration/minion.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/configuration/minion.html</a></li>
</ul>
<p>Salt Minion配置非常简单。通常，需要设置的唯一值是master value，因此minion知道在哪里找到其Master Server。</p>
<p><br><br><br><br><br></p>
<h2 id="proxy-minion"><a href="#proxy-minion" class="headerlink" title="proxy minion"></a>proxy minion</h2><p>CONFIGURING THE SALT PROXY MINION</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ADD_PROXYMODULE_TO_OPTS</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"><span class="attr">add_proxymodule_to_opts:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_MERGE_GRAINS_IN_MODULE</span></span><br><span class="line"><span class="comment">#Default: True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_KEEP_ALIVE</span></span><br><span class="line"><span class="comment">#Default: True</span></span><br><span class="line"><span class="comment">#死亡时是否重启与远程设备的连接</span></span><br><span class="line"><span class="attr">proxy_keep_alive:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_KEEP_ALIVE_INTERVA</span></span><br><span class="line"><span class="comment">#Default: 1(min)</span></span><br><span class="line"><span class="comment">#keepalive检查频率</span></span><br><span class="line"><span class="attr">proxy_keep_alive_interval:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_ALWAYS_ALIVE</span></span><br><span class="line"><span class="comment">#Default: True</span></span><br><span class="line"><span class="attr">proxy_always_alive:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_MERGE_PILLAR_IN_OPTS</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_DEEP_MERGE_PILLAR_IN_OPTS</span></span><br><span class="line"><span class="comment">#Default: False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_MERGE_PILLAR_IN_OPTS_STRATEGY</span></span><br><span class="line"><span class="comment">#Default: smart</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#PROXY_MINES_PILLAR</span></span><br><span class="line"><span class="comment">#Default: True</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="栗子配置文件"><a href="#栗子配置文件" class="headerlink" title="栗子配置文件"></a>栗子配置文件</h2><ul>
<li>config file examples: <a href="https://docs.saltstack.com/en/latest/ref/configuration/examples.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/configuration/examples.html</a></li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="minion-blackout"><a href="#minion-blackout" class="headerlink" title="minion blackout"></a>minion blackout</h2><p>MINION BLACKOUT CONFIGURATION</p>
<p>Salt支持minion blackouts。当一个minion处于blackout mode时，所有远程执行命令都被禁用。</p>
<p>minion blackout mode通过pillar key——<code>minion_blackout</code>进行配置。如果此为True，则minion将拒绝除<code>saltutil.refresh_pillar</code>命令外的所有传入命令。<br>它也支持whitelist:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minion_blackout_whitelist:</span><br><span class="line">  - test.ping</span><br><span class="line">  - pillar.get</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="访问控制系统"><a href="#访问控制系统" class="headerlink" title="访问控制系统"></a>访问控制系统</h2><p>ACCESS CONTROL SYSTEM</p>
<p>Salt维护一个标准系统，用于向非管理用户开放粒度控制以执行Salt命令。访问控制系统已应用于所有用于配置对Salt中非管理控制接口的访问的系统。<br>访问控制系统强制要求在所有三个系统中使用的标准配置语法。</p>
<p>这个接口包括:</p>
<ul>
<li><strong>peer</strong> system</li>
<li><strong>external auth</strong> system</li>
<li><strong>publisher acl</strong> system</li>
</ul>
<p><br><br><br></p>
<h3 id="什么时候使用每个认证系统"><a href="#什么时候使用每个认证系统" class="headerlink" title="什么时候使用每个认证系统"></a>什么时候使用每个认证系统</h3><p><code>publisher_acl</code> 对于允许本地系统用户运行Salt命令而不给予root访问权限非常有用。如果您可以直接登录Salt master，那么 <code>publisher_acl</code>允许您在没有root权限的情况下使用Salt。如果本地系统配置为针对远程系统（如LDAP或Active Directory）进行身份验证，则 <code>publisher_acl</code> 将透明地与远程系统进行交互。</p>
<p><code>external_auth</code> 对于 <code>salt-api</code> 或者使用Salt Python API创建自己的脚本非常有用。它可以在CLI上使用（with the <code>-a</code> flag），但由于涉及更多步骤，因此更麻烦。在CLI中唯一有用的是本地系统未配置为针对外部服务进行身份验证，但您仍希望Salt对外部服务进行身份验证。</p>
<p><br><br><br></p>
<h3 id="Publisher-ACL"><a href="#Publisher-ACL" class="headerlink" title="Publisher ACL"></a>Publisher ACL</h3><p>PUBLISHER ACL SYSTEM</p>
<p>Salt <strong>Publisher ACL</strong> 系统，允许除root之外的系统用户有权在master上访问在minion上执行的salt命令。<br>它在master的配置文件中的 <code>publisher_acl</code> 部分进行配置。在此配置项下，指定用户打开发送命令，然后指定将对特定用户可用的minion函数列表。<br>用户和函数都可以通过完全匹配、shell glob、正则表达式来指定。</p>
<p><br></p>
<p>栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">publisher_acl:</span></span><br><span class="line">  <span class="comment"># Allow thatch to execute anything.</span></span><br><span class="line"><span class="attr">  thatch:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.*</span></span><br><span class="line">  <span class="comment"># Allow fred to use test and pkg, but only on "web*" minions.</span></span><br><span class="line"><span class="attr">  fred:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">web*:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">test.*</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">pkg.*</span></span><br><span class="line">  <span class="comment"># Allow admin and managers to use saltutil module functions</span></span><br><span class="line">  <span class="string">admin|manager_.*:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">saltutil.*</span></span><br><span class="line">  <span class="comment"># Allow users to use only my_mod functions on "web*" minions with specific arguments.</span></span><br><span class="line">  <span class="string">user_.*:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">web*:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'my_mod.*'</span><span class="string">:</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">'a.*'</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">'b.*'</span></span><br><span class="line"><span class="attr">          kwargs:</span></span><br><span class="line"><span class="attr">            'kwa':</span> <span class="string">'kwa.*'</span></span><br><span class="line"><span class="attr">            'kwb':</span> <span class="string">'kwb'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="PERMISSION-ISSUES"><a href="#PERMISSION-ISSUES" class="headerlink" title="PERMISSION ISSUES"></a>PERMISSION ISSUES</h4><p>必须修改 <code>publisher_acl</code> 所需的目录，以便指定的用户可以读取:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /var/cache/salt /var/cache/salt/master /var/cache/salt/master/<span class="built_in">jobs</span> /var/run/salt /var/run/salt/master</span><br><span class="line"></span><br><span class="line"><span class="comment">#还要更改日志文件有对应的写入权限</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="白-黑名单"><a href="#白-黑名单" class="headerlink" title="白/黑名单"></a>白/黑名单</h4><p>WHITELIST AND BLACKLIST</p>
<p>在Salt身份认证配置系统中，可以通过使用白名单指定允许的内容，使用黑名单指定不允许的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#白名单</span><br><span class="line">publisher_acl:</span><br><span class="line">  fred:</span><br><span class="line">    - test.ping</span><br><span class="line">    - pkg.*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#黑名单</span><br><span class="line">publisher_acl_blacklist:</span><br><span class="line">  users:</span><br><span class="line">    - root</span><br><span class="line">    - &apos;^(?!sudo_).*$&apos;   #  all non sudo users</span><br><span class="line">  modules:</span><br><span class="line">    - cmd.*</span><br><span class="line">    - test.echo</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="External-Authentication"><a href="#External-Authentication" class="headerlink" title="External Authentication"></a>External Authentication</h3><p>EXTERNAL AUTHENTICATION SYSTEM</p>
<p>Salt’s <strong>External Authentication</strong> System (eAuth)，允许Salt将命令授权传递给任何外部身份验证系统(PAM、LDAP)。</p>
<blockquote>
<p>eAuth如果使用PAM，则需要以root身份来运行 <code>slat-master</code></p>
</blockquote>
<p><br></p>
<h4 id="eAuth配置"><a href="#eAuth配置" class="headerlink" title="eAuth配置"></a>eAuth配置</h4><p><strong>eAuth</strong> 允许特定用户被授予访问权限在特权minion上执行特定功能。它在master中配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">external_auth:</span></span><br><span class="line"><span class="attr">  pam:</span></span><br><span class="line"><span class="attr">    thatch:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'web*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">test.*</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">network.*</span></span><br><span class="line">    <span class="string">steve|admin.*:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用户thatch在web*的minions上执行test和network模块</span></span><br><span class="line"><span class="comment">#用户steve和adminxxx被授予不受限制的访问权限</span></span><br><span class="line"><span class="comment">#PAM模块不允许以root身份进行身份验证</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#wheel modules/runner modules</span></span><br><span class="line"><span class="attr">external_auth:</span></span><br><span class="line"><span class="attr">  pam:</span></span><br><span class="line"><span class="attr">    thatch:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'@wheel'</span>   <span class="comment"># to allow access to all wheel modules</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'@runner'</span>  <span class="comment"># to allow access to all runner modules</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'@jobs'</span>    <span class="comment"># to allow access to the jobs runner and/or wheel module</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#runner/wheel的标记是不同的，因为没有minions来限定ACL</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意:<br>所有具有外部身份验证权限的用户允许运行 <code>saltutil.findjob</code>。请注意，这可能会无意中暴露一些数据，例如minion ID。</p>
</blockquote>
<p><br></p>
<h5 id="匹配语法"><a href="#匹配语法" class="headerlink" title="匹配语法"></a>匹配语法</h5><p>MATCHING SYNTAX</p>
<p><code>external_auth</code> 字典的结构可以采用以下形状:</p>
<ul>
<li>user, function 是完全匹配</li>
<li>shell 是glob pattern或 RE</li>
<li>minions 是复合目标</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#By user</span></span><br><span class="line"><span class="attr">external_auth:</span></span><br><span class="line">  <span class="string">&lt;eauth</span> <span class="string">backend&gt;:</span></span><br><span class="line">    <span class="string">&lt;user</span> <span class="string">or</span> <span class="string">group%&gt;:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">&lt;regex</span> <span class="string">to</span> <span class="string">match</span> <span class="string">function&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#By user, by minion</span></span><br><span class="line"><span class="attr">external_auth:</span></span><br><span class="line">  <span class="string">&lt;eauth</span> <span class="string">backend&gt;:</span></span><br><span class="line">    <span class="string">&lt;user</span> <span class="string">or</span> <span class="string">group%&gt;:</span></span><br><span class="line">      <span class="string">&lt;minion</span> <span class="string">compound</span> <span class="string">target&gt;:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">&lt;regex</span> <span class="string">to</span> <span class="string">match</span> <span class="string">function&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#By user, by runner/wheel</span></span><br><span class="line"><span class="attr">external_auth:</span></span><br><span class="line">  <span class="string">&lt;eauth</span> <span class="string">backend&gt;:</span></span><br><span class="line">    <span class="string">&lt;user</span> <span class="string">or</span> <span class="string">group%&gt;:</span></span><br><span class="line">      <span class="string">&lt;@runner</span> <span class="string">or</span> <span class="string">@wheel&gt;:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">&lt;regex</span> <span class="string">to</span> <span class="string">match</span> <span class="string">function&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#By user, by runner+wheel module</span></span><br><span class="line"><span class="attr">external_auth:</span></span><br><span class="line">  <span class="string">&lt;eauth</span> <span class="string">backend&gt;:</span></span><br><span class="line">    <span class="string">&lt;user</span> <span class="string">or</span> <span class="string">group%&gt;:</span></span><br><span class="line">      <span class="string">&lt;@module_name&gt;:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">&lt;regex</span> <span class="string">to</span> <span class="string">match</span> <span class="string">function</span> <span class="string">without</span> <span class="string">module_name&gt;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="GROUPS"><a href="#GROUPS" class="headerlink" title="GROUPS"></a>GROUPS</h5><p>要将权限应用于eAuth中的一组用户，请在ID中附加<code>％</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">external_auth:</span></span><br><span class="line"><span class="attr">  pam:</span></span><br><span class="line">    <span class="string">admins%:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'pkg.*'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="通过函数参数来限制"><a href="#通过函数参数来限制" class="headerlink" title="通过函数参数来限制"></a>通过函数参数来限制</h5><p>LIMITING BY FUNCTION ARGUMENTS</p>
<p>函数的位置参数或关键字参数也可以列入白名单:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">external_auth:</span></span><br><span class="line"><span class="attr">  pam:</span></span><br><span class="line"><span class="attr">    my_user:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'my_mod.*'</span><span class="string">:</span></span><br><span class="line"><span class="attr">            args:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">'a.*'</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">'b.*'</span></span><br><span class="line"><span class="attr">            kwargs:</span></span><br><span class="line"><span class="attr">              'kwa':</span> <span class="string">'kwa.*'</span></span><br><span class="line"><span class="attr">              'kwb':</span> <span class="string">'kwb'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'@runner'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'runner_mod.*'</span><span class="string">:</span></span><br><span class="line"><span class="attr">            args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">'a.*'</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">'b.*'</span></span><br><span class="line"><span class="attr">            kwargs:</span></span><br><span class="line"><span class="attr">              'kwa':</span> <span class="string">'kwa.*'</span></span><br><span class="line"><span class="attr">              'kwb':</span> <span class="string">'kwb'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>任何用户在master上可以使用 <code>-a</code> 选项在同一系统从命令行使用 eAu:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt -a pam web\* test.ping</span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="TOKENS"><a href="#TOKENS" class="headerlink" title="TOKENS"></a>TOKENS</h5><p>仅使用外部身份验证，每次调用Salt时都需要身份验证凭据。这可以通过Salt Token 来缓解。<br>令牌是短期授权，只需在验证时添加-T选项即可轻松创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">salt -T -a pam web\* test.ping</span><br><span class="line"></span><br><span class="line"><span class="comment">#现在将创建一个有效期为12小时（默认）的令牌，此令牌存储在活动用户主目录中名为 `salt_token` 的文件中</span></span><br><span class="line"><span class="comment">#创建令牌后，将与所有后续通信一起发送令牌。在令牌过期之前，不需要再次输入用户身份验证</span></span><br><span class="line"><span class="comment">#令牌的过期时间可在master config中修改</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="LDAP和AD"><a href="#LDAP和AD" class="headerlink" title="LDAP和AD"></a>LDAP和AD</h4><p>LDAP AND ACTIVE DIRECTORY</p>
<blockquote>
<p>LDAP要求安装python-ldap</p>
</blockquote>
<p>Salt支持LDAP的和组身份验证。</p>
<p><br></p>
<h5 id="OPENLDAP和类似的系统"><a href="#OPENLDAP和类似的系统" class="headerlink" title="OPENLDAP和类似的系统"></a>OPENLDAP和类似的系统</h5><p>LDAP配置发生在 Salt Master配置文件中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server to auth against</span></span><br><span class="line"><span class="string">auth.ldap.server:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port to connect via</span></span><br><span class="line"><span class="string">auth.ldap.port:</span> <span class="number">389</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use TLS when connecting</span></span><br><span class="line"><span class="string">auth.ldap.tls:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP scope level, almost always 2</span></span><br><span class="line"><span class="string">auth.ldap.scope:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Server specified in URI format</span></span><br><span class="line"><span class="string">auth.ldap.uri:</span> <span class="string">''</span>    <span class="comment"># Overrides .ldap.server, .ldap.port, .ldap.tls above</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify server's TLS certificate</span></span><br><span class="line"><span class="string">auth.ldap.no_verify:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind to LDAP anonymously to determine group membership</span></span><br><span class="line"><span class="comment"># Active Directory does not allow anonymous binds without special configuration</span></span><br><span class="line"><span class="comment"># In addition, if auth.ldap.anonymous is True, empty bind passwords are not permitted.</span></span><br><span class="line"><span class="string">auth.ldap.anonymous:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FOR TESTING ONLY, this is a VERY insecure setting.</span></span><br><span class="line"><span class="comment"># If this is True, the LDAP bind password will be ignored and</span></span><br><span class="line"><span class="comment"># access will be determined by group membership alone with</span></span><br><span class="line"><span class="comment"># the group memberships being retrieved via anonymous bind</span></span><br><span class="line"><span class="string">auth.ldap.auth_by_group_membership_only:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Require authenticating user to be part of this Organizational Unit</span></span><br><span class="line"><span class="comment"># This can be blank if your LDAP schema does not use this kind of OU</span></span><br><span class="line"><span class="string">auth.ldap.groupou:</span> <span class="string">'Groups'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Object Class for groups.  An LDAP search will be done to find all groups of this</span></span><br><span class="line"><span class="comment"># class to which the authenticating user belongs.</span></span><br><span class="line"><span class="string">auth.ldap.groupclass:</span> <span class="string">'posixGroup'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Unique ID attribute name for the user</span></span><br><span class="line"><span class="string">auth.ldap.accountattributename:</span> <span class="string">'memberUid'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These are only for Active Directory</span></span><br><span class="line"><span class="string">auth.ldap.activedirectory:</span> <span class="literal">False</span></span><br><span class="line"><span class="string">auth.ldap.persontype:</span> <span class="string">'person'</span></span><br><span class="line"></span><br><span class="line"><span class="string">auth.ldap.minion_stripdomains:</span> <span class="string">[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redhat Identity Policy Audit</span></span><br><span class="line"><span class="string">auth.ldap.freeipa:</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>验证LDAP服务器</strong></li>
</ul>
<p>LDAP身份验证有两个阶段:</p>
<ul>
<li>首先，Salt进行身份验证以搜索用户的专有名称(DN)和组成员</li>
<li>Salt搜索目录以确定实际用户的DN和组后，它将以运行Salt命令的用户重新进行身份验证</li>
</ul>
<p>如果您已经了解DN的结构，并且LDAP存储中的权限已设置为用户可以查找自己的组成员身份，则第一个和第二个用户可以相同。要告诉Salt这种情况，请省略 <code>auth.ldap.bindpw</code> 参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#binddn</span></span><br><span class="line"><span class="string">auth.ldap.basedn:</span> <span class="string">dc=saltstack,dc=com</span></span><br><span class="line"><span class="string">auth.ldap.binddn:</span> <span class="string">uid=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;,cn=users,cn=accounts,dc=saltstack,dc=com</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">auth.ldap.binddn:</span> <span class="string">uid=ldaplookup,cn=sysaccounts,cn=etc,dc=saltstack,dc=com</span></span><br><span class="line"><span class="string">auth.ldap.bindpw:</span> <span class="string">mypassword</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">auth.ldap.filter:</span> <span class="string">uid=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>确定组成员</strong></li>
</ul>
<p>对于OpenLDAP，要确定组成员身份，可以指定包含组数据的OU。<br>对于AD，以不同方式处理组成员身份，并且不使用groupou配置变量。</p>
<p><br><br><br></p>
<h3 id="Peer-Communication"><a href="#Peer-Communication" class="headerlink" title="Peer Communication"></a>Peer Communication</h3><p>此功能的目的不是让Salt minions作为另一个独立的中间商，而是让 Salt Minions 将命令传递给另外的 Salt Minion。<br>peer interface 通过主配置文件中的两个选项进行配置：</p>
<ul>
<li>对于从 master 发送命令的minion来说，使用 <code>peer</code></li>
<li>对于从 master 执行 runners 的minion来说，使用 <code>peer_run</code></li>
</ul>
<p>由于这可以通过允许minions访问master publisher，可能存在安全风险，因此默认情况下关闭该功能。根据正则表达式，可以允许 minions 基于每个 minion 访问 master publisher。根据minion的ID可以允许ID访问某些Salt模块和功能。</p>
<p><br><br><br></p>
<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>PEER CONFIGURATION</p>
<p>它在 master config 的 <code>peer</code> 部分进行配置:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#最简单方法是为 allminions 启用 all communication，仅限于很安全的环境下</span></span><br><span class="line"><span class="attr">peer:</span></span><br><span class="line">  <span class="string">.*:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#以 example.com 结尾的ID</span></span><br><span class="line"><span class="attr">peer:</span></span><br><span class="line">  <span class="string">.*example.com:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ps.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">pkg.*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">peer:</span></span><br><span class="line">  <span class="string">.*example.com:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ps.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">pkg.*</span></span><br><span class="line">  <span class="string">.*foo.org:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ps.*</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">pkg.*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用正则表达式匹配函数</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="PEER-RUNNER"><a href="#PEER-RUNNER" class="headerlink" title="PEER RUNNER"></a>PEER RUNNER</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#all to all</span><br><span class="line">peer_run:</span><br><span class="line">  .*:</span><br><span class="line">    - .*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">peer_run:</span><br><span class="line">  .*example.com:</span><br><span class="line">    - manage.*</span><br><span class="line">    - jobs.*</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="使用对等通信"><a href="#使用对等通信" class="headerlink" title="使用对等通信"></a>使用对等通信</h4><p>USING PEER COMMUNICATION</p>
<p>publish module 被创建来管理 peer communication。它有多种方式来执行对等通信，目前，此模块有三个functions:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">salt-call publish.publish \* test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">salt-call publish.runner manage.up</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">salt-call publish.publish <span class="string">'webserv* and not G@os:Ubuntu'</span> test.ping tgt_type=<span class="string">'compound'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="作业管理"><a href="#作业管理" class="headerlink" title="作业管理"></a>作业管理</h2><p>JOB MANAGEMENT</p>
<p>由于Salt执行在许多系统上运行的作业，因此Salt需要能够管理在许多系统上运行的作业。</p>
<p><br></p>
<h3 id="Minion-Proc系统"><a href="#Minion-Proc系统" class="headerlink" title="Minion Proc系统"></a>Minion Proc系统</h3><p>THE MINION PROC SYSTEM</p>
<p>Salt Minions 在 Salt <code>cachedir</code> 中维护一个 <code>proc</code> 目录(默认<code>/var/cache/salt/proc</code>)，<code>proc</code> 目录维护以执行的作业的ID命名的文件。这些文件包含有关minion上当前正在运行的作业的信息，并允许查找作业。</p>
<p><br><br><br></p>
<h3 id="saltutil模块中的函数"><a href="#saltutil模块中的函数" class="headerlink" title="saltutil模块中的函数"></a>saltutil模块中的函数</h3><p>FUNCTIONS IN THE SALTUTIL MODULE</p>
<p><code>saltutil</code>模块中的函数用于管理作业，它们有:</p>
<ul>
<li><code>running</code>: 返回 <code>proc</code> 目录中找到的所有正在运行的作业的数据</li>
<li><code>find_job</code>: 根据 Job ID 返回有关特定作业的特定数据</li>
<li><code>signal_job</code>: 允许给定的 JID 发送信号</li>
<li><code>term_job</code>: Sends a termination signal (SIGTERM, 15)到指定作业进程</li>
<li><code>kill_job</code>: Sends a kill signal (SIGKILL, 9)到指定作业进程</li>
</ul>
<p>这些函数构成了后端的核心，用于管理minion级别的工作。</p>
<p><br><br><br><br><br></p>
<h3 id="JOB-RUNNER"><a href="#JOB-RUNNER" class="headerlink" title="JOB RUNNER"></a>JOB RUNNER</h3><p><strong>jobs runner</strong> 包含使查看数据更简单，更清晰的功能。它包含许多功能:</p>
<p><br></p>
<ul>
<li><strong>ACTIVE</strong></li>
</ul>
<p><code>acrive</code>函数对所有minions运行 <code>saltutil.running</code>，并以更加可用和紧凑的格式格式化有关所有正在运行的作业返回的数据。它还将比较已返回的作业和仍在运行的作业，从而更容易查看系统已完成作业以及系统仍在等待的作业。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run jobs.active</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>LOOKUP_JID</strong></li>
</ul>
<p>执行作业时，返回数据将发送回 Master 并进行缓存。默认缓存24小时，但可以通过 master config 中的 <code>keep_jobs</code> 选项进行配置。使用 <code>lookup_jid</code> runner 将显示与salt命令初始作业调用相同的返回数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run jobs.lookup_jid &lt;job id number&gt;</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>LIST_JOBS</strong></li>
</ul>
<p>在找到历史性工作之前，可能需要找到 JID。<code>list_jobs</code> 将解析缓存的执行数据，并显示已经或部分返回的作业的所有作业数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run jobs.list_jobs</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="调度作业"><a href="#调度作业" class="headerlink" title="调度作业"></a>调度作业</h3><p>SCHEDULING JOBS</p>
<p>Salt调度系统允许对 Minion/Master 进行增量执行。调度系统公开了对 Minion/Runner on Master 的任何执行函数的执行。</p>
<p>有多种方法启用调度:</p>
<ul>
<li>在 master/minion 配置文件中的 <code>schedule</code> 选项，修改之后重启生效</li>
<li>Minion pillar data. 通过刷新minion pillar data来实现(<code>saltutil.refresh_pillar</code>)</li>
<li><code>schedule state</code>/<code>schedule module</code></li>
</ul>
<blockquote>
<p>注意:<br>调度器在 minion 和 master 上执行不同的函数。<code>runner</code> func on master; <code>specify execution</code> func on minino.</p>
</blockquote>
<p><br></p>
<p>调度在 minion 上是没有输出的，除非设置 minion 的日志级别。</p>
<p>States 在 minion 上执行，所有的都是如此。您可以传递位置参数并提供命名参数的YAML dict。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每3600s调度一次 state.sls httpd test=True</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#延长10s-15s</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    splay:</span></span><br><span class="line"><span class="attr">      start:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      end:</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="按时间和日期调度"><a href="#按时间和日期调度" class="headerlink" title="按时间和日期调度"></a>按时间和日期调度</h4><p>SCHEDULE BY DATE AND TIME</p>
<p>可以使用Python <code>dateutil</code> 库支持的日期字符串指定作业频率。当然，你需要安装此库。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    when:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Monday</span> <span class="number">5</span><span class="string">:00pm</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Tuesday</span> <span class="number">3</span><span class="string">:00pm</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Wednesday</span> <span class="number">5</span><span class="string">:00pm</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Thursday</span> <span class="number">3</span><span class="string">:00pm</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Friday</span> <span class="number">5</span><span class="string">:00pm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#调度程序自定义短语用于when</span></span><br><span class="line"></span><br><span class="line"><span class="attr">whens:</span></span><br><span class="line">  <span class="string">tea</span> <span class="attr">time:</span> <span class="number">1</span><span class="string">:40pm</span></span><br><span class="line">  <span class="string">deployment</span> <span class="attr">time:</span> <span class="string">Friday</span> <span class="number">5</span><span class="string">:00pm</span></span><br><span class="line"></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    when:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'tea time'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#时间区间</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    range:</span></span><br><span class="line"><span class="attr">      invert:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">      start:</span> <span class="number">8</span><span class="string">:00am</span></span><br><span class="line"><span class="attr">      end:</span> <span class="number">5</span><span class="string">:00pm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定时间</span></span><br><span class="line"><span class="comment">#默认日期格式为ISO 8601</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">pkg.install</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      pkgs:</span> <span class="string">[&#123;'bar':</span> <span class="string">'&gt;1.2.3'</span><span class="string">&#125;]</span></span><br><span class="line"><span class="attr">      refresh:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    once:</span> <span class="string">'2016-01-07T14:30:00'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定日期格式</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">test.ping</span></span><br><span class="line"><span class="attr">    once:</span> <span class="number">2015</span><span class="bullet">-04</span><span class="bullet">-22</span><span class="attr">T20:21:00</span></span><br><span class="line"><span class="attr">    once_fmt:</span> <span class="string">'%Y-%m-%dT%H:%M:%S'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="最大并行工作"><a href="#最大并行工作" class="headerlink" title="最大并行工作"></a>最大并行工作</h4><p>MAXIMUM PARALLEL JOBS RUNNING</p>
<p>调度程序还支持确保运行特定例程的副本不超过N个。将此用于可能长时间运行的、发生基础设施中断可能会相互踩踏或堆积在一起的作业。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#maxrunning默认值1</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  long_running_job:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">big_file_transfer</span></span><br><span class="line"><span class="attr">    jid_include:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    maxrunning:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="类似定时任务的调度"><a href="#类似定时任务的调度" class="headerlink" title="类似定时任务的调度"></a>类似定时任务的调度</h4><p>CRON-LIKE SCHEDULE</p>
<p>调度器支持使用定时任务格式来调度作业。当然，需要安装Python <code>croniter</code> 库。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    cron:</span> <span class="string">'*/15 * * * *'</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="作业数据返回"><a href="#作业数据返回" class="headerlink" title="作业数据返回"></a>作业数据返回</h4><p>JOB DATA RETURN</p>
<p>默认情况下，有关从Salt Scheduler 运行的作业的数据将返回到 Master。可在 master config 的 <code>return_job</code> 配置项进行修改。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">scheduled_job_function</span></span><br><span class="line"><span class="attr">    return_job:</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="JOB-METADATA"><a href="#JOB-METADATA" class="headerlink" title="JOB METADATA"></a>JOB METADATA</h4><p>包含特定数据用以区分一个作业与其他作业可能很有用。使用元数据(metadata)参数，特殊值可以与调度作业相关联。这些值不用于作业的执行，但如果与 <code>return_job</code> 参数结合使用，可用于稍后搜索特定作业。元数据参数必须指定为 字典数据格式，否则将会被忽略。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">scheduled_job_function</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      foo:</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="启动时运行"><a href="#启动时运行" class="headerlink" title="启动时运行"></a>启动时运行</h4><p>RUN ON START</p>
<p>默认情况下，根据minion的启动时间安排的任何作业将在minion启动时运行预定作业。有时这不是理想的情况。将 <code>run_on_start</code>参数 设置为 <code>False</code> 将导致调度程序跳过此第一次运行并等待下一次计划运行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    run_on_start:</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="UNTIL-AFTER"><a href="#UNTIL-AFTER" class="headerlink" title="UNTIL/AFTER"></a>UNTIL/AFTER</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#until参数，允许指定调度作业的结束时间</span></span><br><span class="line"><span class="comment">#在此时间过后，作业将不在运行</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    until:</span> <span class="string">'12/31/2015 11:59pm'</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#after参数，允许指定调度作业的开始时间</span></span><br><span class="line"><span class="comment">#在此时间过后，作业将不在运行</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  job1:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.sls</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    after:</span> <span class="string">'12/31/2015 11:59pm'</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="调度状态"><a href="#调度状态" class="headerlink" title="调度状态"></a>调度状态</h4><p>SCHEDULING STATES</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  log-loadavg:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">cmd.run</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">3660</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'logger -t salt &lt; /proc/loadavg'</span></span><br><span class="line"><span class="attr">    kwargs:</span></span><br><span class="line"><span class="attr">      stateful:</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">/bin/sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#'&gt;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="高峰调度"><a href="#高峰调度" class="headerlink" title="高峰调度"></a>高峰调度</h4><p>SCHEDULING HIGHSTATES</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#highstate</span></span><br><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  highstate:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.highstate</span></span><br><span class="line"><span class="attr">    minutes:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p>####　调度runner</p>
<p>SCHEDULING RUNNERS</p>
<p>也在在master上指定runner的运行:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  run_my_orch:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">state.orchestrate</span></span><br><span class="line"><span class="attr">    hours:</span> <span class="number">6</span></span><br><span class="line"><span class="attr">    splay:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">orchestration.my_orch</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<p>####　SCHEDULER WITH RETURNER</p>
<p>调度程序对于收集有关minion的监视数据等任务也很有用，此调度选项将收集状态数据并将其发送到MySQL返回者数据库：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schedule:</span></span><br><span class="line"><span class="attr">  uptime:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">status.uptime</span></span><br><span class="line"><span class="attr">    seconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">    returner:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  meminfo:</span></span><br><span class="line"><span class="attr">    function:</span> <span class="string">status.meminfo</span></span><br><span class="line"><span class="attr">    minutes:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    returner:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br><br><br></p>
<h2 id="管理作业缓存"><a href="#管理作业缓存" class="headerlink" title="管理作业缓存"></a>管理作业缓存</h2><p>MANAGING THE JOB CACHE</p>
<p>Salt Maste r维护所有作业执行的作业缓存，可以通过 Job Runner查询。此作业缓存称为默认作业缓存。</p>
<p><br></p>
<h3 id="默认作业缓存"><a href="#默认作业缓存" class="headerlink" title="默认作业缓存"></a>默认作业缓存</h3><p>DEFAULT JOB CACHE</p>
<p>默认缓存系统使用Salt Master上的本地存储，可以在作业缓存目录(默认: <code>/var/cache/salt/master/jobs</code>)中找到。默认缓存系统适用于大多数部署，因为它通常不需要任何进一步的配置或管理。</p>
<p>默认作业缓存是临时缓存，作业将存储24小时。可在 master config 文件中的 <code>keep_jobs</code> 参数来调整它:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请勿将此值设置为0，因为这意味着缓存清理程序永远不会运行</span></span><br><span class="line"><span class="attr">keep_jobs:</span> <span class="number">24</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>减小默认缓存的大小</strong></li>
</ul>
<p>REDUCING THE SIZE OF THE DEFAULT JOB CACHE</p>
<p>默认作业缓存有时会成为大型部署(<code>minions &gt; 5000</code>的负担。禁用作业缓存将使以前执行的作业对作业系统不可用，<strong>通常不建议这样做</strong>。通常，确保 Master 可以访问更快的IO系统或者将tmpfs安装到jobs目录是明智的。<br>但是，您可以通过在Salt Master配置文件中将<code>job_cache</code> 设置为 <code>False</code> 来禁用它。这意味着Salt Master将不再缓存minion的返回信息，但仍将创建每个作业的JID目录和jid文件。此JID目录是检查和防止JID冲突所必需的。</p>
<p><br><br><br><br><br><br><br></p>
<h2 id="在外部系统中存储作业结果"><a href="#在外部系统中存储作业结果" class="headerlink" title="在外部系统中存储作业结果"></a>在外部系统中存储作业结果</h2><p>STORING JOB RESULTS IN AN EXTERNAL SYSTEM</p>
<p>作业执行后，每个Salt Minion将作业结果返回给Salt Master。这些结果存储在默认作业缓存中。除了默认作业缓存之外，Salt还提供了两种额外的机制来将作业结果发送到其它系统(databases, local syslog, others):</p>
<ul>
<li>External Job Cache</li>
<li>Master Job Cache</li>
</ul>
<p><br></p>
<h3 id="EXTERNAL-JOB-CACHE-MINION-SIDE-RETURNER"><a href="#EXTERNAL-JOB-CACHE-MINION-SIDE-RETURNER" class="headerlink" title="EXTERNAL JOB CACHE - MINION-SIDE RETURNER"></a>EXTERNAL JOB CACHE - MINION-SIDE RETURNER</h3><p>配置外部作业缓存后，数据会像往常一样返回Salt Master上的默认作业缓存，然后使用Salt Minion上运行的Salt ruturner module 将结果发送到外部作业缓存。</p>
<p><img src="/images/Salt/external-job-cache.png" alt=""></p>
<p><br><br><br></p>
<h3 id="MASTER-JOB-CACHE-MASTER-SIDE-RETURNER"><a href="#MASTER-JOB-CACHE-MASTER-SIDE-RETURNER" class="headerlink" title="MASTER JOB CACHE - MASTER-SIDE RETURNER"></a>MASTER JOB CACHE - MASTER-SIDE RETURNER</h3><p>在此配置中，Salt Minions 像往常一样将数据发送到默认作业缓存，然后 Salt Master 使用在 Salt Master 上运行的Salt Returner Module 将数据发送到外部系统。</p>
<p><img src="/images/Salt/master-job-cache.png" alt=""></p>
<p><br><br><br></p>
<h3 id="配置两种机制"><a href="#配置两种机制" class="headerlink" title="配置两种机制"></a>配置两种机制</h3><p><br></p>
<ul>
<li><strong>了解SALT RETURNERS</strong></li>
</ul>
<p>在配置作业缓存之前，必须了解 Salt Returner Module。<strong>Returner</strong> 是可插拔的 Salt Modules，它接收作业返回的数据，然后执行任何必要的步骤将数据发送到外部系统。<br>Salt Returner 为 External Job Cache 和 Master Job Cache 提供了许多核心功能。</p>
<p>Salt目前提供许多不同的 Returner ，以便让您连接到各种系统。各种 Returner Module: <a href="https://docs.saltstack.com/en/latest/ref/returners/all/index.html#all-salt-returners" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/returners/all/index.html#all-salt-returners</a></p>
<p><br></p>
<ul>
<li><strong>配置它们</strong></li>
</ul>
<p><code>EXTERNAL JOB CACHE</code>，可在如下选项中配置:</p>
<ul>
<li>Minion configuration file</li>
<li>Minion’s grains</li>
<li>Minion’s pillar data</li>
</ul>
<p><br></p>
<p><code>MASTER JOB CACHE</code>，在 Master config 中进行配置。</p>
<p>栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql</span></span><br><span class="line"><span class="string">mysql.host:</span> <span class="string">'salt'</span></span><br><span class="line"><span class="string">mysql.user:</span> <span class="string">'salt'</span></span><br><span class="line"><span class="string">mysql.pass:</span> <span class="string">'salt'</span></span><br><span class="line"><span class="string">mysql.db:</span> <span class="string">'salt'</span></span><br><span class="line"><span class="string">mysql.port:</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#slack</span></span><br><span class="line"><span class="string">slack.channel:</span> <span class="string">'channel'</span></span><br><span class="line"><span class="string">slack.api_key:</span> <span class="string">'key'</span></span><br><span class="line"><span class="string">slack.from_name:</span> <span class="string">'name'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>启用它们</strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#EXTERNAL JOB CACHE</span></span><br><span class="line"><span class="comment">#ext_job_cache: mysql</span></span><br><span class="line"><span class="attr">ext_job_cache:</span> <span class="string">&lt;returner&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#MASTER JOB CACHE</span></span><br><span class="line"><span class="comment">#master_job_cache: mysql</span></span><br><span class="line"><span class="attr">master_job_cache:</span> <span class="string">&lt;returner&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启服务</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="日志-1"><a href="#日志-1" class="headerlink" title="日志"></a>日志</h2><p>LOGGING</p>
<p>Salt 尽力让日志工作为您工作，并帮助我们解决您可能在此过程中发现的任何问题。</p>
<p><br></p>
<h3 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h3><p>LOG LEVELS</p>
<p>日志级别按数字顺序排列，以便将日志级别设置为特定级别将记录该级别及更高级别的所有日志语句。<br>例如，<code>log_level: error</code> 将会记录 <code>error, critical, quiet</code> 级别的日志。</p>
<p>大多数日志记录级别在Python logging lib 中默认定义，Salt 使用了更多日志级别。</p>
<table>
<thead>
<tr>
<th>Level</th>
<th>Numeric value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>quiet</td>
<td>1000</td>
<td>Nothing should be logged at this level</td>
</tr>
<tr>
<td>critical</td>
<td>50</td>
<td>Critical errors</td>
</tr>
<tr>
<td>error</td>
<td>40</td>
<td>Errors</td>
</tr>
<tr>
<td>warning</td>
<td>30</td>
<td>Warnings</td>
</tr>
<tr>
<td>info</td>
<td>20</td>
<td>Normal log information</td>
</tr>
<tr>
<td>profile</td>
<td>15</td>
<td>Profiling information on salt performance</td>
</tr>
<tr>
<td>debug</td>
<td>10</td>
<td>Information useful for debugging both salt implementations and salt code</td>
</tr>
<tr>
<td>trace</td>
<td>5</td>
<td>More detailed code debugging information</td>
</tr>
<tr>
<td>garbage</td>
<td>1</td>
<td>Even more debugging information</td>
</tr>
<tr>
<td>all</td>
<td>0</td>
<td>Everything</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h3 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#LOG_FILE</span></span><br><span class="line"><span class="comment">#日志记录可以发送到常规文件，本地路径名或网络位置，配置为使用rsyslogd时，远程日志记录效果最佳</span></span><br><span class="line"><span class="comment">#远程地址格式: &lt;file|udp|tcp&gt;://&lt;host|socketpath&gt;:&lt;port-if-required&gt;/&lt;log-facility&gt;</span></span><br><span class="line"><span class="comment">#栗子</span></span><br><span class="line"><span class="attr">log_file:</span> <span class="string">/var/log/salt/master</span></span><br><span class="line"><span class="attr">log_file:</span> <span class="string">/var/log/salt/minion</span></span><br><span class="line"><span class="attr">log_file:</span> <span class="attr">file:///dev/log</span></span><br><span class="line"><span class="attr">log_file:</span> <span class="attr">file:///dev/log/LOG_DAEMON</span></span><br><span class="line"><span class="attr">log_file:</span> <span class="attr">udp://loghost:10514</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_LEVEL</span></span><br><span class="line"><span class="comment">#Default: warning</span></span><br><span class="line"><span class="comment">#发送到控制台的日志记录消息的级别</span></span><br><span class="line"><span class="attr">log_level:</span> <span class="string">warning</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_LEVEL_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: info</span></span><br><span class="line"><span class="comment">#要发送到日志文件的消息级别</span></span><br><span class="line"><span class="attr">log_level_logfile:</span> <span class="string">warning</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_DATEFMT</span></span><br><span class="line"><span class="comment">#Default: %H:%M:%S</span></span><br><span class="line"><span class="comment">#控制台日志消息中使用的日期和时间格式</span></span><br><span class="line"><span class="attr">log_datefmt:</span> <span class="string">'%H:%M:%S'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_DATEFMT_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: %Y-%m-%d %H:%M:%S</span></span><br><span class="line"><span class="comment">#日志文件消息中使用的日期和时间格式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_FMT_CONSOLE</span></span><br><span class="line"><span class="comment">#Default: [%(levelname)-8s] %(message)s</span></span><br><span class="line"><span class="comment">#控制台日志消息的格式</span></span><br><span class="line"><span class="attr">log_fmt_console:</span> <span class="string">'[%(levelname)-8s] %(message)s'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可使用所有标准python日志记录LogRecord属性。 Salt还提供自定义LogRecord属性自定义控制台显示的颜色</span></span><br><span class="line"><span class="string">'%(colorlevel)s'</span>   <span class="comment"># log level name colorized by level</span></span><br><span class="line"><span class="string">'%(colorname)s'</span>    <span class="comment"># colorized module name</span></span><br><span class="line"><span class="string">'%(colorprocess)s'</span> <span class="comment"># colorized process number</span></span><br><span class="line"><span class="string">'%(colormsg)s'</span>     <span class="comment"># log message colorized by level</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_FMT_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: %(asctime)s,%(msecs)03d [%(name)-17s][%(levelname)-8s] %(message)s</span></span><br><span class="line"><span class="comment">#日志文件记录消息的格式</span></span><br><span class="line"><span class="attr">log_fmt_logfile:</span> <span class="string">'%(asctime)s,%(msecs)03d [%(name)-17s][%(levelname)-8s] %(message)s'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#也可通过对 LogRecord 自定义控制台显示颜色</span></span><br><span class="line"><span class="string">'%(bracketlevel)s'</span>   <span class="comment"># equivalent to [%(levelname)-8s]</span></span><br><span class="line"><span class="string">'%(bracketname)s'</span>    <span class="comment"># equivalent to [%(name)-17s]</span></span><br><span class="line"><span class="string">'%(bracketprocess)s'</span> <span class="comment"># equivalent to [%(process)5s]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LOG_GRANULAR_LEVELS</span></span><br><span class="line"><span class="comment">#Default: &#123;&#125;</span></span><br><span class="line"><span class="comment">#用于根据日志调用名称更具体地控制日志记录级别</span></span><br><span class="line"><span class="attr">log_granular_levels:</span></span><br><span class="line"><span class="attr">  'salt':</span> <span class="string">'warning'</span></span><br><span class="line">  <span class="string">'salt.modules'</span><span class="string">:</span> <span class="string">'debug'</span></span><br><span class="line">  <span class="string">'salt.loader.saltmaster.ext.module.custom_module'</span><span class="string">:</span> <span class="string">'all'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="外部日志处理器"><a href="#外部日志处理器" class="headerlink" title="外部日志处理器"></a>外部日志处理器</h3><p>EXTERNAL LOGGING HANDLERS</p>
<p>除了salt使用的内部日志处理程序外，还有一些可以使用的外部日志处理程序:</p>
<ul>
<li><a href="https://docs.saltstack.com/en/latest/ref/configuration/logging/handlers/salt.log.handlers.fluent_mod.html" target="_blank" rel="noopener">fluent_mod</a></li>
<li><a href="https://docs.saltstack.com/en/latest/ref/configuration/logging/handlers/salt.log.handlers.log4mongo_mod.html" target="_blank" rel="noopener">log4mongo_mod</a></li>
<li><a href="https://docs.saltstack.com/en/latest/ref/configuration/logging/handlers/salt.log.handlers.logstash_mod.html" target="_blank" rel="noopener">logstash_mod</a></li>
<li><a href="https://docs.saltstack.com/en/latest/ref/configuration/logging/handlers/salt.log.handlers.sentry_mod.html" target="_blank" rel="noopener">sentry_mod</a></li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h2><p>Salt File Server</p>
<p>Salt 附带了一个简单的文件服务器，适合将文件分发给 Salt minions，它是内置在 Salt Master 中的无状态 ZeroMQ Server。</p>
<p>Salt文件服务器的主要目的是提供在 Salt state system 中使用的文件。有了这个说法，Salt文件服务器可用于从Master到minions的任何常规文件传输。</p>
<p><br></p>
<h3 id="文件系统后端"><a href="#文件系统后端" class="headerlink" title="文件系统后端"></a>文件系统后端</h3><p>FILE SERVER BACKENDS</p>
<p>此功能增加了Salt Master集成不同文件服务器后端的能力。文件服务器后端允许Salt文件服务器充当外部资源的透明桥。<br>一个很好的例子是<code>git</code>后端，它允许Salt提供来自一个或多个<code>git</code>存储库的文件，但也有其他几个。</p>
<p>File Server Module:</p>
<ul>
<li>azurefs</li>
<li>gitfs</li>
<li>hgfs</li>
<li>minionfs</li>
<li>roots</li>
<li>s3fs</li>
<li>svnfs</li>
</ul>
<p><br></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用</span></span><br><span class="line"><span class="attr">fileserver_backend:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用多个后端</span></span><br><span class="line"><span class="attr">fileserver_backend:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">roots</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义环境变量</span></span><br><span class="line"><span class="comment">#在文件服务器环境中定义不同源的顺序也很重要</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br><span class="line"><span class="attr">  qa:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/qa</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br><span class="line"><span class="attr">  dev:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/dev</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/qa</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#栗子</span></span><br><span class="line"><span class="attr">gitfs_remotes:</span></span><br><span class="line"><span class="attr">  - https:</span><span class="string">//mydomain.tld/repos/first.git</span></span><br><span class="line"><span class="attr">  - https:</span><span class="string">//mydomain.tld/repos/second.git</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="从特定环境请求文件"><a href="#从特定环境请求文件" class="headerlink" title="从特定环境请求文件"></a>从特定环境请求文件</h3><p>REQUESTING FILES FROM SPECIFIC ENVIRONMENTS</p>
<p>Salt文件服务器支持多种环境，允许隔离SLS文件和其他文件以便更好地组织。<br>对于默认后端(root)，使用 <code>roots</code> 选项定义环境。其它后端以它们自己的方式定义环境。</p>
<p><br></p>
<p><strong>QUERYSTRING SYNTAX</strong></p>
<p>任何 <code>salt://</code> 文件URL都可以使用查询字符串语法指定其文件服务器环境</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">salt:</span><span class="string">//path/to/file?saltenv=foo</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>IN STATES</strong></p>
<p>可以指示Minions在全局和单个状态下使用哪个环境，并且每个环境都有多种方法:</p>
<ul>
<li>GLOBALLY</li>
</ul>
<p>使用minion配置文件中的 <code>environment</code> 选项将minion固定到环境中。此外，可以将环境设置为单次调用以下函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state.apply</span><br><span class="line">state.highstate</span><br><span class="line">state.sls</span><br><span class="line">state.top</span><br></pre></td></tr></table></figure>
<ul>
<li>ON A PER-STATE BASIS</li>
</ul>
<p>在单个状态中，有两种指定环境的方法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一个是向 state 添加 saltenv 参数</span></span><br><span class="line"><span class="string">/etc/foo/bar.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://foo/bar.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">    - saltenv:</span> <span class="string">config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#另一种是使用查询字符串语法</span></span><br><span class="line"><span class="string">/etc/foo/bar.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://foo/bar.conf?saltenv=config</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">600</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="文件系统配置"><a href="#文件系统配置" class="headerlink" title="文件系统配置"></a>文件系统配置</h3><p>FILE SERVER CONFIGURATION</p>
<p>Salt文件服务器是用ZeroMQ编写的高性能文件服务器。它可以快速管理大型文件，而且开销很小，并且已经过优化，可以非常有效地处理小文件。</p>
<p>Salt文件服务器是一个环境感知文件服务器。这意味着可以在许多根目录中分配文件，并通过指定文件路径和要搜索的环境来访问这些文件。各个环境可以跨多个目录根来创建叠加，并允许以多种灵活的方式组织文件。</p>
<p><br></p>
<h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>Salt文件服务器默认为强制 <code>base</code> 环境。必须定义这个环境，并在未指定环境时用于下载文件。</p>
<p>环境允许 file 和 sls data 在逻辑上分开，但环境不会相互隔离。这允许工程师使用Salt对环境进行逻辑隔离，但也允许在多个环境中使用信息。</p>
<p><br></p>
<h4 id="目录覆盖"><a href="#目录覆盖" class="headerlink" title="目录覆盖"></a>目录覆盖</h4><p>DIRECTORY OVERLAY</p>
<p>环境设置是用于发布文件的目录列表。搜索这些目录以查找指定的文件并返回找到的第一个文件。这意味着目录数据的优先级基于它们的列出顺序。<br>这允许根据在配置中定义的顺序来覆盖目录并确定其优先级。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/failover</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果一个文件的URI是 salt://httpd/httpd.conf，它会首先在 /srv/salt/base/httpd/httpd.conf 搜索文件，找到则返回</span></span><br><span class="line"><span class="comment">#如果未找到，那么使用 /srv/salt/failover/httpd/httpd.conf</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="本地文件服务器-1"><a href="#本地文件服务器-1" class="headerlink" title="本地文件服务器"></a>本地文件服务器</h4><p>LOCAL FILE SERVER</p>
<p>可以重新路由文件服务器以从minion运行。这主要是为了在没有Salt master的情况下运行Salt State。要使用本地文件服务器接口，请将文件服务器数据复制到minion，并将minion上的 <code>file_roots</code> 选项设置为指向从 Master 复制的目录。一旦设置了minion <code>file_roots</code> 选项，将 <code>file_client</code>选项更改为本地以确保使用本地文件服务器接口。</p>
<p><br><br><br></p>
<h3 id="CP模块"><a href="#CP模块" class="headerlink" title="CP模块"></a>CP模块</h3><p>THE CP MODULE</p>
<p>cp模块是minion端文件服务器操作的主页。cp模块由Salt State system, <code>salt-cp</code> 使用，可用于分发Salt文件服务器提供的文件。</p>
<p><br></p>
<ul>
<li><strong>ESCAPING SPECIAL CHARACTERS</strong></li>
</ul>
<p><code>satl://</code> url格式可能包含查询字符串，例如 <code>salt://dir/file.txt?saltenv=base</code>。通过带有<code>satl://-</code>的引用文件作为查询字符串的初始标记，你可阻止<code>?</code>的解释。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/marathon/conf/?checkpoint:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://|hw/config/?checkpoint</span></span><br><span class="line"><span class="attr">    - makedirs:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>ENVIRONMENTS</strong></li>
</ul>
<p>由于文件服务器可以与Salt State system 一起使用，因此它支持环境。如前所述，环境在master配置文件中定义。</p>
<p><br></p>
<ul>
<li><strong>GET_FILE</strong></li>
</ul>
<p>可以在minion上使用 <code>cp.get_file</code> 函数从 master 下载文件。对于较大的文件，此函数支持gzip压缩，由于gzip是CPU密集型的，因此仅应在压缩率非常高的情况下使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cp.get_file salt://vimrc /etc/vimrc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启用模板</span></span><br><span class="line">salt <span class="string">'*'</span> cp.get_file <span class="string">"salt://&#123;&#123;grains.os&#125;&#125;/vimrc"</span> /etc/vimrc template=jinja</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gzip范围: 1-9</span></span><br><span class="line">salt <span class="string">'*'</span> cp.get_file salt://vimrc /etc/vimrc gzip=5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认情况下不会创建新的目标目录，如果有需要，请使用`makedirs`参数</span></span><br><span class="line">salt <span class="string">'*'</span> cp.get_file salt://vimrc /etc/vim/vimrc makedirs=True</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>GET_DIR</strong></li>
</ul>
<p>可以在minion上使用 <code>cp.get_dir</code> 函数从master下载整个目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cp.get_dir salt://etc/apache2 /etc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#同样支持模板和压缩</span></span><br><span class="line">salt <span class="string">'*'</span> cp.get_dir salt://etc/&#123;&#123;pillar.webserver&#125;&#125; /etc gzip=5 template=jinja</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="客户端实例"><a href="#客户端实例" class="headerlink" title="客户端实例"></a>客户端实例</h3><p>FILE SERVER CLIENT INSTANCE</p>
<p>允许编写模块和应用程序的客户端实例来使用Salt文件系统。<br>文件服务器使用与Salt系统其余部分相同的身份验证和加密进行网络通信。</p>
<p><br></p>
<ul>
<li><strong>FILECLIENT MODULE</strong></li>
</ul>
<p><code>salt/fileclient.py</code> 模块用于设置从minion到master的通信。使用 <code>fileclient</code> 模块创建客户端实例时，需要传入minion配置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在minion模块中使用fileclient模块时，可以传递内置的__opts__数据</span></span><br><span class="line"><span class="keyword">import</span> salt.minion</span><br><span class="line"><span class="keyword">import</span> salt.fileclient</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file</span><span class="params">(path, dest, saltenv=<span class="string">'base'</span>)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Used to get a single file from the Salt master</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CLI Example:</span></span><br><span class="line"><span class="string">    salt '*' cp.get_file salt://vimrc /etc/vimrc</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># Get the fileclient object</span></span><br><span class="line">    client = salt.fileclient.get_file_client(__opts__)</span><br><span class="line">    <span class="comment"># Call get_file</span></span><br><span class="line">    <span class="keyword">return</span> client.get_file(path, dest, <span class="keyword">False</span>, saltenv)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#__opts__数据不可用的minion模块之外创建一个fileclient实例</span></span><br><span class="line"><span class="keyword">import</span> salt.fileclient</span><br><span class="line"><span class="keyword">import</span> salt.config</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file</span><span class="params">(path, dest, saltenv=<span class="string">'base'</span>)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Used to get a single file from the Salt master</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># Get the configuration data</span></span><br><span class="line">    opts = salt.config.minion_config(<span class="string">'/etc/salt/minion'</span>)</span><br><span class="line">    <span class="comment"># Get the fileclient object</span></span><br><span class="line">    client = salt.fileclient.get_file_client(opts)</span><br><span class="line">    <span class="comment"># Call get_file</span></span><br><span class="line">    <span class="keyword">return</span> client.get_file(path, dest, <span class="keyword">False</span>, saltenv)</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h2><p>SALT PACKAGE MANAGER</p>
<blockquote>
<p>Status:  Technical Review</p>
</blockquote>
<p>The Salt Package Manager(SPM)，使Salt formulas 得以打包，以简化向Salt Master 的分发。SPM的设计受到其他现有包系统的影响，包括RPM, Yum, Pacman。</p>
<p><img src="/image/Salt/spm-overview.png" alt=""></p>
<p><br></p>
<h3 id="SPM包构建"><a href="#SPM包构建" class="headerlink" title="SPM包构建"></a>SPM包构建</h3><p>BUILDING SPM PACKAGES</p>
<blockquote>
<p>Status:  Technical Review</p>
</blockquote>
<p>使用SPM的第一步是为要分发的每个方案构建包。可以在任何可以安装Salt的系统上构建软件包。</p>
<p><br></p>
<h4 id="包构建概述"><a href="#包构建概述" class="headerlink" title="包构建概述"></a>包构建概述</h4><p>PACKAGE BUILD OVERVIEW</p>
<p>saltstack-formulas: <a href="https://github.com/saltstack-formulas" target="_blank" rel="noopener">https://github.com/saltstack-formulas</a></p>
<p>构建程序包，方案使用的所有 state, pillar, jinja, and file templates 都将组装到构建系统上的文件夹中。这些文件可以从GitHub 存储库克隆。</p>
<p><img src="/images/Salt/spm-package-contents.png" alt=""></p>
<p><br></p>
<h4 id="包安装概述"><a href="#包安装概述" class="headerlink" title="包安装概述"></a>包安装概述</h4><p>PACKAGE INSTALLATION OVERVIEW</p>
<p>构建包时，了解Salt master上文件的安装位置很有用。在安装过程中，除了 <code>pillar.example</code> 和 <code>FORMULA</code> 之外的所有文件都被直接复制到Salt master上的 spm state tree(<code>\srv\spm\salt</code>)。<br>如果根目录中存在 <code>pillar.example</code> 文件，则将其重命名为 <code>formula_name.sls.orig</code> 并放在 <code>pillar_path</code> 中。</p>
<p><img src="/images/Salt/spm-package-extraction.png" alt=""></p>
<p><br></p>
<h4 id="构建一个SPM-formula包"><a href="#构建一个SPM-formula包" class="headerlink" title="构建一个SPM formula包"></a>构建一个SPM formula包</h4><p>BUILDING AN SPM FORMULA PACKAGE</p>
<ul>
<li>将方案(formula)文件组装到构建系统上的文件夹中</li>
<li>创建一个FORMULA文件并将其放在包文件夹的根目录中</li>
<li>运行<code>spm build folder_name</code>，此包是构建并放在 <code>/srv/spm_build</code> 文件夹中: <code>spm build /path/to/salt-packages-source/myapp-formula</code></li>
<li>将 <code>.spm</code> 文件复制到存储库系统上的文件夹</li>
</ul>
<p><br></p>
<h4 id="包类型"><a href="#包类型" class="headerlink" title="包类型"></a>包类型</h4><p>TYPES OF PACKAGES</p>
<p>SPM支持不同类型的包，每个包的功能由其名称表示。</p>
<ul>
<li>FORMULA: 默认情况下，此类包的大多数文件都位于 <code>/srv/spm/salt/</code> 目录中，上面说的<code>pillar.example</code>文件例外</li>
<li>REACTOR: 默认情况下，此类包的文件位于 <code>/srv/spm/reactor/</code> 目录</li>
<li>CONF: 此类软件包中的文件是Salt的配置文件，通常位于 <code>/etc/salt/</code> 目录</li>
</ul>
<p><br></p>
<h4 id="技术信息"><a href="#技术信息" class="headerlink" title="技术信息"></a>技术信息</h4><p>TECHNICAL INFORMATION</p>
<p>软件包使用BZ2压缩的tar包构建，默认情况下，使用 <code>sqlite3</code> 驱动存储包数据库。<br>这些内容的支持是内置于Python中的，因此不需要外部依赖项。</p>
<p>属于SPM的所有其它文件都使用YAML，以实现可移植性，易用性和可维护性。</p>
<p><br></p>
<h4 id="特定SPM装载器模块"><a href="#特定SPM装载器模块" class="headerlink" title="特定SPM装载器模块"></a>特定SPM装载器模块</h4><p>SPM-SPECIFIC LOADER MODULES</p>
<p>SPM的设计与传统的包管理器相似，后者将文件应用于文件系统并将包元数据存储在本地数据库中。但是，由于现代基础架构通常超出了这些用例，因此SPM的某些部分已经分解为它们自己的模块集。</p>
<ul>
<li>PACKAGE DATABASE: 默认使用 <code>sqlite3</code>模块</li>
<li>PACKAGE FILES: 默认使用<code>local</code>模块</li>
</ul>
<p><br><br><br></p>
<h3 id="分发SPM包"><a href="#分发SPM包" class="headerlink" title="分发SPM包"></a>分发SPM包</h3><p>DISTRIBUTING SPM PACKAGES</p>
<blockquote>
<p>Status:  Technical Review</p>
</blockquote>
<p>SPM包可以通过HTTP(S), FTP, FS 分发给Salt Master。SPM Repo 可以托管在可以安装Salt的任何系统上。安装Salt后，您可以在更新包或向存储库添加包时运行 <code>spm create_repo</code> 命令。</p>
<p><br></p>
<ul>
<li><strong>设置一个包的Repo</strong></li>
</ul>
<p>构建包后，生成的SPM文件将放在 <code>srv/spm_build</code> 文件夹中。</p>
<p><br></p>
<ul>
<li><strong>添加一个包到Repo</strong></li>
</ul>
<p>只需将SPM文件复制到repo文件夹，然后生成repo元数据即可添加新软件包。</p>
<p><br></p>
<ul>
<li><strong>生成Repo Metadata</strong></li>
</ul>
<p>每次更新或向存储库添加SPM包时，请发出 <code>spm create_repo</code> 命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spm create_repo /srv/spm_build</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="安装SPM包"><a href="#安装SPM包" class="headerlink" title="安装SPM包"></a>安装SPM包</h3><p>INSTALLING SPM PACKAGES</p>
<blockquote>
<p>Status:  Technical Review</p>
</blockquote>
<p>SPM软件包安装在Salt master中，使用Salt的所有包管理功能可以使用它们。</p>
<p><br></p>
<h4 id="配置远程REPO"><a href="#配置远程REPO" class="headerlink" title="配置远程REPO"></a>配置远程REPO</h4><p>CONFIGURING REMOTE REPOSITORIES</p>
<p>在SPM可以使用存储库之前，需要做两件事。首先，Salt master 需要通过配置过程知道存储库的位置。然后它需要 pull down 存储库元数据。</p>
<ul>
<li><strong>Repo配置文件</strong></li>
</ul>
<p>通过将每个存储库添加到每个 Salt Master 的 <code>/etc/salt/spm.repos.d/spm.repo</code> 文件来配置存储库，它包含Repo的名称和链接:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my_repo:</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">https://spm.example.com/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#https，请注意文件权限</span></span><br><span class="line"><span class="attr">my_repo:</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">https://spm.example.com/</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#http(s), ftp, file</span></span><br><span class="line"><span class="attr">my_repo:</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">file:///srv/spm_build</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>更新本地Repo Metadata</strong></li>
</ul>
<p>使用 <code>spm update_repo</code> 命令下载 Repo 元数据。运行命令后，每个repo的文件都放在Salt master上的 <code>/var/cache/salt/spm</code> 中，如果添加存储库但它似乎没有显示，请检查此路径以验证是否找到了存储库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spm update_repo</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="更新文件根"><a href="#更新文件根" class="headerlink" title="更新文件根"></a>更新文件根</h4><p>UPDATE FILE ROOTS</p>
<p>SPM软件包安装在Salt master上的 <code>srv/spm/salt</code> 文件夹中，需要手动将此路径添加到Salt master上的文件根目录中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line">    <span class="number">1.</span> <span class="string">/srv/salt</span></span><br><span class="line">    <span class="number">2.</span> <span class="string">/srv/spm/salt</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h4><blockquote>
<p>警告:<br>目前，SPM在安装之前不会检查文件是否已就位。这意味着现有文件将被覆盖而不会发出警告。</p>
</blockquote>
<p>使用 <code>spm install</code> 命令来安装包:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spm install apache</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用spm local install命令使用本地SPM文件安装SPM软件包</span></span><br><span class="line">spm <span class="built_in">local</span> install /srv/spm/apache-201506-1.spm</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="PILLARS"><a href="#PILLARS" class="headerlink" title="PILLARS"></a>PILLARS</h4><p>如果已安装的软件包包含Pillar数据，确保使用 pillar Top file 将安装的pillar用于必要的系统。</p>
<p><br><br><br></p>
<h4 id="删除包"><a href="#删除包" class="headerlink" title="删除包"></a>删除包</h4><p>安装包之后，使用 <code>spm remove</code> 命令来删除包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#如果文件已被修改，则不会删除它们。空目录也将被删除</span><br><span class="line">spm remove apache</span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="SPM配置"><a href="#SPM配置" class="headerlink" title="SPM配置"></a>SPM配置</h3><p>有许多特定的SPM配置，可在Salt Master中配置，也可在SPM自己的配置文件(通常: <code>/etc/salt/spm</code>)中配置。如果在两个地方都进行了配置，则SPM配置文件优先。通常，不需要更改这些默认值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#SPM_LOGFILE</span></span><br><span class="line"><span class="comment">#Default: /var/log/salt/spm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SPM_REPOS_CONFIG</span></span><br><span class="line"><span class="comment">#Default: /etc/salt/spm.repos</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SPM_CACHE_DIR</span></span><br><span class="line"><span class="comment">#Default: /var/cache/salt/spm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SPM_DB</span></span><br><span class="line"><span class="comment">#Default: /var/cache/salt/spm/packages.db</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SPM_BUILD_DIR</span></span><br><span class="line"><span class="comment">#Default: /srv/spm_build</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#SPM_BUILD_EXCLUDE</span></span><br><span class="line"><span class="comment">#Default: ['.git']</span></span><br><span class="line"><span class="attr">spm_build_exclude:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">.git</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">.svn</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#FORMULA</span></span><br><span class="line"><span class="comment">#Default dir: /srv/spm/salt/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#REACTOR</span></span><br><span class="line"><span class="comment">#Default dir: /srv/spm/reactor/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CONF</span></span><br><span class="line"><span class="comment">#Default dir: /etc/salt/</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="FORMULA-File"><a href="#FORMULA-File" class="headerlink" title="FORMULA File"></a>FORMULA File</h3><p>除了FORMULA本身，还必须存在描述包的FORMULA文件。栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">os:</span> <span class="string">RedHat,</span> <span class="string">Debian,</span> <span class="string">Ubuntu,</span> <span class="string">SUSE,</span> <span class="string">FreeBSD</span></span><br><span class="line"><span class="attr">os_family:</span> <span class="string">RedHat,</span> <span class="string">Debian,</span> <span class="string">Suse,</span> <span class="string">FreeBSD</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">201506</span></span><br><span class="line"><span class="attr">release:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">summary:</span> <span class="string">Formula</span> <span class="string">for</span> <span class="string">installing</span> <span class="string">Apache</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">Formula</span> <span class="string">for</span> <span class="string">installing</span> <span class="string">Apache</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="需要的字段"><a href="#需要的字段" class="headerlink" title="需要的字段"></a>需要的字段</h4><p>REQUIRED FIELDS</p>
<p>这个文件必须包含以下字段:</p>
<ul>
<li>NAME: 包名</li>
<li>OS: 支持的操作系统</li>
<li>OS_FAMILY: 支持的<code>os_family</code></li>
<li>VERSION: 包版本，建议使用<code>YYYYMM</code>格式</li>
<li>MINIMUM_VERSION: Salt最低推荐版本</li>
<li>RELEASE: 发行版</li>
<li>SUMMARY: 简短描述</li>
<li>DESCRIPTION: 详细描述</li>
</ul>
<p><br><br><br></p>
<h4 id="可选字段"><a href="#可选字段" class="headerlink" title="可选字段"></a>可选字段</h4><p>OPTIONAL FIELDS</p>
<p>如下字段也可能存在:</p>
<ul>
<li>TOP_LEVEL_DIR</li>
<li>DEPENDENCIES</li>
<li>OPTIONAL</li>
<li>RECOMMENDED</li>
<li>FILES</li>
<li>LOCAL STATES</li>
<li>TGT STATES</li>
<li>TEMPLATING STATES</li>
<li>LOADER MODULES</li>
<li>REMOVING PACKAGES</li>
<li>TECHNICAL INFORMATION</li>
<li>SPM-SPECIFIC LOADER MODULES</li>
<li>PACKAGE DATABASE</li>
<li>PACKAGE FILES</li>
<li>TYPES OF PACKAGES</li>
<li>FORMULA</li>
<li>REACTOR</li>
<li>CONF</li>
</ul>
<p><br><br><br><br><br></p>
<h3 id="SPM开发指南"><a href="#SPM开发指南" class="headerlink" title="SPM开发指南"></a>SPM开发指南</h3><p>docs: <a href="https://docs.saltstack.com/en/latest/topics/spm/dev.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/spm/dev.html</a></p>
<p>先放着，后面有需要再来学习。</p>
<p><br><br><br><br><br></p>
<h2 id="在其它数据库中存储数据"><a href="#在其它数据库中存储数据" class="headerlink" title="在其它数据库中存储数据"></a>在其它数据库中存储数据</h2><p>STORING DATA IN OTHER DATABASES</p>
<p>SDB接口用于存储和检索数据，这些数据与  pillars and grains 不同，不一定是特定于特定部分的数据。最初的设计目标是允许将密码存储在安全数据库中，而不是纯文本文件。但是，作为通用数据库接口，它可以在概念上用于许多其它目的。</p>
<p><br></p>
<h3 id="SDB-CONF"><a href="#SDB-CONF" class="headerlink" title="SDB CONF"></a>SDB CONF</h3><p>要使用SDB接口，必须设置配置文件。要对Salt Master Command 可用，需在master配置文件中定义；对于在 Salt Minion 上执行的模块，可在 minion配置文件和 pillar 中进行配置。</p>
<p>栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建议使用简单的名字，因为它在BSD URI中使用</span></span><br><span class="line"><span class="attr">mykeyring:</span></span><br><span class="line"><span class="attr">  driver:</span> <span class="string">keyring</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="SDB-URIS"><a href="#SDB-URIS" class="headerlink" title="SDB URIS"></a>SDB URIS</h3><p>SDB旨在使用紧凑的URL进行小型数据库查询。这允许用户在多个Salt配置区域内快速引用数据库值，而不会产生大量开销。</p>
<p>SDB URI 基本格式:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#profile指的是master/minion配置中定义的profile</span></span><br><span class="line"><span class="attr">sdb:</span><span class="string">//&lt;profile&gt;/&lt;args&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#profile look like</span></span><br><span class="line"><span class="attr">kevinopenstack:</span></span><br><span class="line"><span class="attr">  driver:</span> <span class="string">keyring</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">salt.cloud.openstack.kevin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#URI look like</span></span><br><span class="line"><span class="attr">sdb:</span><span class="string">//kevinopenstack/password</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="获取、配置和删除SDB值"><a href="#获取、配置和删除SDB值" class="headerlink" title="获取、配置和删除SDB值"></a>获取、配置和删除SDB值</h3><p>GETTING, SETTING AND DELETING SDB VALUES</p>
<p>配置SDB驱动后，您可以使用sdb执行模块从中获取、设置和删除值。</p>
<p>SDB Modules:</p>
<ul>
<li><code>get</code></li>
<li><code>set</code></li>
<li><code>delete</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">salt-call</span> <span class="string">sdb.get</span> <span class="attr">sdb://kevinopenstack/password</span></span><br><span class="line"><span class="string">salt-call</span> <span class="string">sdb.set</span> <span class="string">'sdb://myvault/secret/salt/saltstack'</span> <span class="string">'super awesome'</span></span><br><span class="line"><span class="string">salt-call</span> <span class="string">sdb.delete</span> <span class="string">'sdb://mykvstore/foobar'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#runner system也可用</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">sdb.get</span> <span class="string">'sdb://myvault/secret/salt/saltstack'</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">sdb.set</span> <span class="string">'sdb://myvault/secret/salt/saltstack'</span> <span class="string">'super awesome'</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">sdb.delete</span> <span class="string">'sdb://mykvstore/foobar'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="在文件中使用SDB-URIS"><a href="#在文件中使用SDB-URIS" class="headerlink" title="在文件中使用SDB URIS"></a>在文件中使用SDB URIS</h3><p>USING SDB URIS IN FILES</p>
<p>SDB URI可用于配置文件和由渲染器系统（jinja，mako…）处理的文件。</p>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mykey: sdb://myetcd/mykey</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#使用模块检索值</span><br><span class="line">mykey = __salt__[&apos;config.get&apos;](&apos;mykey&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Templating renderers</span><br><span class="line">&#123;&#123; salt[&apos;config.get&apos;](&apos;mykey&apos;) &#125;&#125;</span><br><span class="line">&#123;&#123; salt[&apos;sdb.get&apos;](&apos;sdb://myetcd/mykey&apos;) &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="非特权用户运行"><a href="#非特权用户运行" class="headerlink" title="非特权用户运行"></a>非特权用户运行</h2><p>RUNNING THE SALT MASTER/MINION AS AN UNPRIVILEGED USER</p>
<blockquote>
<p>当master未以root用户身份运行时，某些Salt的操作无法正确执行。特别是PAM外部认证系统，因为它需要root访问权来检查身份验证。</p>
</blockquote>
<p>默认使用root用户运行，有些人认为使用 non-root 用户运行更安全。使用non-root 用户并不会改变master访问minion的能力。由于许多人认为以 non-root 用于运行它们不会体现真正的安全优势，因此这就是默认使用root运行的原因。</p>
<p><br></p>
<p>通过在master配置文件中设置用户参数来启用非特权用户。<br>minion也有自己的用户参数，但是作为非特权用户运行minion将阻止它对用户，已安装的软件包等进行更改，除非在minion上设置访问控制（sudo等）以允许非root用户进行所需的更改。</p>
<p>还应该更改Salt使用到的目录和文件对于此用户的权限:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#/etc/salt</span><br><span class="line">#/var/cache/salt</span><br><span class="line">#/var/log/salt</span><br><span class="line">#/var/run/salt</span><br><span class="line">#...</span><br><span class="line"></span><br><span class="line">chown -R user /etc/salt /var/cache/salt /var/log/salt /var/run/salt</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>由于 <code>salt-minion</code> 要执行由 Salt-Master 的 <code>salt &#39;minion&#39; xxx</code> 命令，出于安全考虑，应该使用非特权用户执行，对此用户添加 <code>sudo</code> 权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># 添加普通用户, salt</span><br><span class="line"># 使用 /sbin/nologin 可以连接Salt Master，但是无法执行 cmd.run。 会报错: This account is currently not available.</span><br><span class="line"># 空密码用户是处于锁定状态，也就是无法进行登录，所以不必要担心安全问题。可以使用su salt</span><br><span class="line">useradd -M -s /bin/sh salt</span><br><span class="line"></span><br><span class="line"># 查看是否锁定</span><br><span class="line"># passwd -S salt</span><br><span class="line"># salt LK 2019-02-14 0 99999 7 -1 (密码已被锁定。)</span><br><span class="line"># passwd -S zhang</span><br><span class="line"># zhang PS 1969-12-31 0 99999 7 -1 (密码已设置，使用 SHA512 算法。)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改对应文件夹权限</span><br><span class="line"># 可能之前以root运行还存在未修改到的文件，请注意日志报错</span><br><span class="line">chown -R salt /etc/salt /var/cache/salt /var/log/salt /var/run/salt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加sudo</span><br><span class="line">visudo</span><br><span class="line">salt   ALL=(ALL)  NOPASSWD:ALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改 Master Config</span><br><span class="line">vim /etc/salt/master</span><br><span class="line"></span><br><span class="line">user: salt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改 Minion Config</span><br><span class="line">vim /etc/salt/minion</span><br><span class="line"></span><br><span class="line">user: salt</span><br><span class="line">sudo_user: salt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 重启服务</span><br><span class="line">systemcrt restart salt-master</span><br><span class="line">systemctl restart salt-minion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line"># 执行特权命令使用sudo</span><br><span class="line">salt &apos;minion-xxx&apos; cmd.run &apos;ls -l /root&apos;</span><br><span class="line"></span><br><span class="line">salt &apos;minion-xxx&apos; cmd.run &apos;sudo ls -l /root&apos;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="使用CRON"><a href="#使用CRON" class="headerlink" title="使用CRON"></a>使用CRON</h2><p>USING CRON WITH SALT</p>
<p>Salt Minion可以使用 <code>salt-call</code>命令启动自己的highstate:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#minion检查与master的状态</span></span><br><span class="line">salt-call state.apply</span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#USE CRON TO INITIATE A HIGHSTATE</span></span><br><span class="line"><span class="comment">#如果希望minion定期检查master</span></span><br><span class="line">0 0 * * * salt-call state.apply</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="HARDENING-SALT"><a href="#HARDENING-SALT" class="headerlink" title="HARDENING SALT"></a>HARDENING SALT</h2><p>本主题包含可用于保护和强化Salt环境的提示。如何最好地保护和加强您的Salt环境在很大程度上取决于您如何使用Salt，您在哪里使用Salt，您的团队结构，从何处获取数据以及您需要什么类型的访问（内部和外部）。</p>
<p><br></p>
<p><strong>一般强化技巧:</strong></p>
<ul>
<li>限制谁可登录到Salt Master</li>
<li>使用SSH Key登录Salt Master</li>
<li>保护好SSH Key</li>
<li>使用堡垒机或VPN限制从Internet直接访问Salt Master</li>
<li>不要将Salt Master暴露在范围之外</li>
<li>强化系统</li>
<li>更新系统补丁</li>
<li>使用严密的防火墙规则</li>
</ul>
<p><br></p>
<p><strong>Salt强化技巧:</strong></p>
<ul>
<li>了解Salt版本可用性和补丁</li>
<li>使用Salt Client ACL，避免必须使用root才能执行Salt命令</li>
<li>使用Salt Client ACL，限制哪些用户可以使用什么命令</li>
<li>使用 External Pillar 将数据从外部源拉取到Salt中，以便非系统管理员可以提供配置数据，而无需访问Salt Master</li>
<li>使用版本控制的SLS文件，并在部署到生产环境前进行同行评审/代码审查流程</li>
<li>如果将Salt Master公开给外服服务，使用<code>salt-api</code>, SSL等来认证外部系统</li>
<li>利用Salt事件系统和 Reactor，允许minion向master发送信号，而无需直接访问</li>
<li>以non-root用户运行<code>salt-master</code> Daemon</li>
<li>使用 <code>disable_modules</code> 设置禁用将哪些模块加载到minions上</li>
<li>查看完整注释的示例master和minion配置文件</li>
<li>在特别敏感的minino上运行 <code>masterless-mode</code>，</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="SALT-TRANSPORT"><a href="#SALT-TRANSPORT" class="headerlink" title="SALT TRANSPORT"></a>SALT TRANSPORT</h2><p>Salt的基本功能之一是远程执行。Salt有两个基本的信道与minion进行沟通，每个信道都需要C端(minion)和S端(master)的实现才能在Salt中工作。这些信道对将一起工作以实现通道接口所需的特定消息传递。</p>
<p><br></p>
<h3 id="PUB-CHANNEL"><a href="#PUB-CHANNEL" class="headerlink" title="PUB CHANNEL"></a>PUB CHANNEL</h3><p><strong>pub(publish) channel</strong> ，是master如何将job发送给minion。遍历发布系统的所有数据都应加密，以便只有Salt集群的成员才能解密发布。</p>
<p><br><br><br></p>
<h3 id="REQ-CHANNEL"><a href="#REQ-CHANNEL" class="headerlink" title="REQ CHANNEL"></a>REQ CHANNEL</h3><p><strong>req channel</strong> ，是minion如何将数据发送给master。此接口主要用于获取文件和返回作业信息。在与master通信时，req channel有两个基本的接口:</p>
<ul>
<li><code>send</code>: 保证消息至少被加密的基本方法，只有连接到同一个master的minions才能读取它，但不保证 minion-master 的机密性</li>
<li><code>crypted_transfer_decode_dictentry</code>: 此方法保证 minion-master 的机密性</li>
</ul>
<p><br><br><br></p>
<h3 id="ZEROMQ传输"><a href="#ZEROMQ传输" class="headerlink" title="ZEROMQ传输"></a>ZEROMQ传输</h3><blockquote>
<p>zeromq是Salt当前的默认传输</p>
</blockquote>
<p><strong>zeromq</strong> 是一种可绑定多种语言的消息库(message lib)，Zeromq实现了一个用于消息传递的套接字接口，它具有套接字类型的特定语义。</p>
<ul>
<li><p>PUB CHANNEL<br>使用zeromq pub/sub socket，默认不使用zeromq的过滤，这意味着所有发布作业都被发送到所有minions和过滤的minion端。zeromq有一个发布端过滤，可在Salt中使用 <code>zmq_filtering</code> 来启用。</p>
</li>
<li><p>REQ CHANNEL<br>使用zeromq req/rep sockets，这些套接字强制执行 send/recv 模式，强制salt通过这些套接字对序列化消息。这意味着虽然接口在minion上是异步的，但是在收到第一条消息的回复之前，我们不能发送第二条消息。</p>
</li>
</ul>
<p><br><br><br></p>
<h3 id="TCP传输"><a href="#TCP传输" class="headerlink" title="TCP传输"></a>TCP传输</h3><p><strong>tcp transport</strong> 是使用原始tcp套接字实现Salt的通道。由于这不是使用预定义的消息库，因此将在本文档中描述协议、消息语义等。</p>
<p>在master和minion上将<code>transport</code>修改为<code>tcp</code>来启用tcp传输。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">transport:</span> <span class="string">tcp</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<blockquote>
<p>警告:<br>建议在使用Syndics时，所有Masters和Minions都使用相同的传输，在高负载时，混合使用传输类型可能会导致错误。</p>
</blockquote>
<p><br><br><br></p>
<h4 id="WIRE-PROTOCOL"><a href="#WIRE-PROTOCOL" class="headerlink" title="WIRE PROTOCOL"></a>WIRE PROTOCOL</h4><p>TCP上的这种实现侧重于绝对效率的灵活性，这意味着我们可以花费几个字节的线路空间来提高未来的灵活性。看起来如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgpack(&#123;&apos;head&apos;: SOMEHEADER, &apos;body&apos;: SOMEBODY&#125;)</span><br></pre></td></tr></table></figure>
<p>通过这种灵活的有线协议，我们可以实现我们想要的任何消息语义，包括在单个套接字上传递的多路复用消息。</p>
<p><br><br><br></p>
<h4 id="TLS支持"><a href="#TLS支持" class="headerlink" title="TLS支持"></a>TLS支持</h4><p>tcp transport 允许 master/minion 通信可选地包装在TLS连接中。启用它很简单，master和minion只需先启用tcp传输，然后启用ssl。ssl选项作为dict传递，对应于传递给Python <code>ssl.wrap_socket</code> 函数的对应项。</p>
<p>简单栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ssl:</span></span><br><span class="line"><span class="attr">  keyfile:</span> <span class="string">&lt;path_to_keyfile&gt;</span></span><br><span class="line"><span class="attr">  certfile:</span> <span class="string">&lt;path_to_certfile&gt;</span></span><br><span class="line"><span class="attr">  ssl_version:</span> <span class="string">PROTOCOL_TLSv1_2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#最小化配置</span></span><br><span class="line"><span class="attr">ssl:</span> <span class="literal">True</span></span><br><span class="line"><span class="comment"># Versions below 2016.11.4:</span></span><br><span class="line"><span class="attr">ssl:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h4><p>当前实现使用与zeromq传输相同的加密。</p>
<p><br><br><br></p>
<h4 id="PUB-CHANNEL-1"><a href="#PUB-CHANNEL-1" class="headerlink" title="PUB CHANNEL"></a>PUB CHANNEL</h4><p>对于pub信道，我们发送没有 <code>message id</code> 的消息，远程端将其解释为单向发送。</p>
<p><br><br><br></p>
<h4 id="REQ-CHANNEL-1"><a href="#REQ-CHANNEL-1" class="headerlink" title="REQ CHANNEL"></a>REQ CHANNEL</h4><p>对于req信道，我们发送带有 <code>message id</code> 的消息，它允许我们在套接字上多路复用消息。</p>
<p><br><br><br></p>
<h3 id="RAET传输"><a href="#RAET传输" class="headerlink" title="RAET传输"></a>RAET传输</h3><p>此处先跳过，后面有需要再来学习。</p>
<p>docs: <a href="https://docs.saltstack.com/en/latest/topics/transports/raet/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/transports/raet/index.html</a></p>
<blockquote>
<p>注意：<br>RAET传输处于早期开发阶段，虽然功能齐全，但尚未就其可靠性或安全性做出承诺。至于可靠性和安全性，使用的加密已经通过审核，我们的测试显示raet是可靠的。据此，我们仍在进行更多的安全审计并提高可靠性。</p>
</blockquote>
<p><br><br><br><br><br></p>
<h2 id="MASTER-TOPS"><a href="#MASTER-TOPS" class="headerlink" title="MASTER TOPS"></a>MASTER TOPS</h2><p>docs: <a href="https://docs.saltstack.com/en/latest/topics/master_tops/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/master_tops/index.html</a></p>
<p>先跳过，后面有需要再来学习。</p>
<p><br><br><br><br><br></p>
<h2 id="RETURNERS"><a href="#RETURNERS" class="headerlink" title="RETURNERS"></a>RETURNERS</h2><p>默认情况下，发送给Salt minions的命令的返回值将返回到Salt master，但是任何事情都可以使用结果数据完成。<br>通过使用 Salt Returner，可以将结果数据重定向到外部数据存储以进行分析和归档。</p>
<p>returner interface 允许将返回数据发送到可以接收数据的任何系统(如MySQL, MongoDB, Redis…)</p>
<p><br></p>
<h3 id="RETURNER-MODULES"><a href="#RETURNER-MODULES" class="headerlink" title="RETURNER MODULES"></a>RETURNER MODULES</h3><p>Returner: <a href="https://docs.saltstack.com/en/latest/ref/returners/all/index.html#all-salt-returners" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/returners/all/index.html#all-salt-returners</a></p>
<p><br></p>
<p>当然，你也可以自己编写Returner。</p>
<p>docs: <a href="https://docs.saltstack.com/en/latest/ref/returners/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/returners/index.html</a></p>
<p><br><br><br><br><br></p>
<h2 id="RENDERERS"><a href="#RENDERERS" class="headerlink" title="RENDERERS"></a>RENDERERS</h2><p>docs: <a href="https://docs.saltstack.com/en/latest/ref/renderers/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/renderers/index.html</a></p>
<p>Salt State System 通过从常用数据类型（如列表，字典和字符串）收集信息来运行。</p>
<p>SLS文件从它们写入的任何数据模板格式转换回要由Salt使用的Python数据类型。默认情况下，SLS文件呈现为Jinja模板，然后解析为YAML文档。由于状态系统唯一关心的是原始数据，因此SLS文件可以是任何可以设想的结构化格式。</p>
<p>目前支持:</p>
<ul>
<li><code>Jinja + YAML</code></li>
<li><code>Mako + YAML</code></li>
<li><code>Wempy + YAML</code></li>
<li><code>Jinja + json</code></li>
<li><code>Mako + json</code></li>
<li><code>Wempy + json</code></li>
</ul>
<p>可以编写渲染器以支持任何模板类型。这意味着Salt状态可以由XML、HTML、Puppet文件或任何可以转换为状态系统使用的Pythonic数据结构的格式管理。</p>
<p><br><br><br></p>
<h3 id="RENDERER-MODULES"><a href="#RENDERER-MODULES" class="headerlink" title="RENDERER MODULES"></a>RENDERER MODULES</h3><p>Renderer: <a href="https://docs.saltstack.com/en/latest/ref/renderers/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/renderers/all/index.html</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>USING SALT</p>
<p>本节介绍使用Salt时需要了解的基本组件和概念。</p>
<p><br></p>
<h2 id="GRAINS"><a href="#GRAINS" class="headerlink" title="GRAINS"></a>GRAINS</h2><blockquote>
<p>注意:<br>Grains解析为小写字母<br>grains 是静态的，是不经常变动的数据。在更新它之后需要刷新，可调用此模块: <code>salt minion saltutil.refresh_modules</code></p>
</blockquote>
<p>Salt附带了一个用于获取有关底层系统的信息接口，这被称为 <strong>grains interface</strong> 。Grains 收集操作系统、域名、IP地址、kernel、OS类型、许多其它系统信息。</p>
<p>Grain 模块和组件可以使用 grain interface，以便在正确的系统上自动获得正确的salt minion命令。</p>
<p>Grains 数据是相对静态的，但如果系统信息发生变化，或者如果将新值分配给它，则 Grain数据将被刷新。</p>
<p><br></p>
<h3 id="LISTING-GRAINS"><a href="#LISTING-GRAINS" class="headerlink" title="LISTING GRAINS"></a>LISTING GRAINS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可使用 grains.ls 模块列出 grains</span></span><br><span class="line">salt <span class="string">'*'</span> grains.ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#可使用 grains.item 模块列出 grains data</span></span><br><span class="line">salt <span class="string">'*'</span> grains.items</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="GRAINS-IN-THE-MINION-CONFIG"><a href="#GRAINS-IN-THE-MINION-CONFIG" class="headerlink" title="GRAINS IN THE MINION CONFIG"></a>GRAINS IN THE MINION CONFIG</h3><p>Grains 也可在 minion 配置文件中静态配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">grains:</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">memcache</span></span><br><span class="line"><span class="attr">  deployment:</span> <span class="string">datacenter4</span></span><br><span class="line"><span class="attr">  cabinet:</span> <span class="number">13</span></span><br><span class="line"><span class="attr">  cab_u:</span> <span class="number">14</span><span class="bullet">-15</span></span><br></pre></td></tr></table></figure>
<p>然后，可以通过Salt检索特定于服务器的状态数据，或者在State系统内部使用以进行匹配。</p>
<p><br><br><br></p>
<h3 id="GRAINS-IN-ETC-SALT-GRAINS"><a href="#GRAINS-IN-ETC-SALT-GRAINS" class="headerlink" title="GRAINS IN /ETC/SALT/GRAINS"></a>GRAINS IN /ETC/SALT/GRAINS</h3><blockquote>
<p>注意:<br>如果在 minion 配置文件中指定了grains, 则忽略 <code>/etc/salt/grains</code></p>
</blockquote>
<p>如果你不想将自定义 grains 放置在 minion 的配置文件中，你可将它放置于 minion 端的 <code>/etc/salt/grains</code> 下。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意，没有顶级项 grains</span></span><br><span class="line"><span class="attr">roles:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">webserver</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">memcache</span></span><br><span class="line"><span class="attr">deployment:</span> <span class="string">datacenter4</span></span><br><span class="line"><span class="attr">cabinet:</span> <span class="number">13</span></span><br><span class="line"><span class="attr">cab_u:</span> <span class="number">14</span><span class="bullet">-15</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="MATCHING-GRAINS-IN-THE-TOP-FILE"><a href="#MATCHING-GRAINS-IN-THE-TOP-FILE" class="headerlink" title="MATCHING GRAINS IN THE TOP FILE"></a>MATCHING GRAINS IN THE TOP FILE</h3><p>使用Minion上正确配置的 Grains，Pillar/Highstate 中使用的 top file 可以非常高效。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#你需为此 grains 定义 role</span></span><br><span class="line"><span class="string">'roles:webserver'</span><span class="string">:</span></span><br><span class="line"><span class="attr">  - match:</span> <span class="string">grain</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">state0</span></span><br><span class="line"></span><br><span class="line"><span class="string">'roles:memcache'</span><span class="string">:</span></span><br><span class="line"><span class="attr">  - match:</span> <span class="string">grain</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">state1</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">state2</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="编写grains"><a href="#编写grains" class="headerlink" title="编写grains"></a>编写grains</h3><p>通过执行Salt core grains code 模块中的所有公共函数（即不以下划线开头的函数），然后是任何自定义 grains 模块中的函数，得到 grain 。grain 模块中的函数必须返回一个Python字典，其中字典键是grain的名称，每个键的值是该grain的值。</p>
<p>自定义 grain 模块应放在名为 <code>_grains</code> 的子目录中，该子目录位于 master 配置文件指定的 <code>file_roots</code> 下(默认路径 <code>/srv/salt/_grains</code>)。通过 <code>saltutil.sync_grains</code> 或 <code>saltutil.sync_all</code> 将自定义 grains 分发到 minions 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#grains容易编写，只需要返回一个字典即可</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">yourfunction</span><span class="params">()</span>:</span></span><br><span class="line">     <span class="comment"># initialize a grains dictionary</span></span><br><span class="line">     grains = &#123;&#125;</span><br><span class="line">     <span class="comment"># Some code for logic that sets grains like</span></span><br><span class="line">     grains[<span class="string">'yourcustomgrain'</span>] = <span class="keyword">True</span></span><br><span class="line">     grains[<span class="string">'anothergrain'</span>] = <span class="string">'somevalue'</span></span><br><span class="line">     <span class="keyword">return</span> grains</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>什么时候使用自定义的GRAIN</strong></p>
<p>在添加新 grain 的时候，请考虑数据是什么，大部分 grains 数据都应该是静态数据。</p>
<p>如果数据可能会发生变化，请考虑使用 <em>Pillar</em> 或 <em>执行模块</em>。如果它是一组简单的键/值对，那么pillar 是一个很好的匹配。如果编译信息需要运行系统命令，那么将此信息放在执行模块中可能更好。</p>
<p><br></p>
<p><strong>载入自定义的GRAIN</strong></p>
<p>如果您有多个函数指定从 <code>main</code> 函数调用的GRAIN，请确保使用下划线添加粒度函数名称。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_my_custom_grain</span><span class="params">()</span>:</span></span><br><span class="line">    my_grain = &#123;<span class="string">'foo'</span>: <span class="string">'bar'</span>, <span class="string">'hello'</span>: <span class="string">'world'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> my_grain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># initialize a grains dictionary</span></span><br><span class="line">    grains = &#123;&#125;</span><br><span class="line">    grains[<span class="string">'my_grains'</span>] = _my_custom_grain()</span><br><span class="line">    <span class="keyword">return</span> grains</span><br></pre></td></tr></table></figure>
<p>事例输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># salt-call --local grains.items</span><br><span class="line">local:</span><br><span class="line">    ----------</span><br><span class="line">    &lt;Snipped for brevity&gt;</span><br><span class="line">    my_grains:</span><br><span class="line">        ----------</span><br><span class="line">        foo:</span><br><span class="line">            bar</span><br><span class="line">        hello:</span><br><span class="line">            world</span><br></pre></td></tr></table></figure>
<p>但是，如果你没有在 <code>my_custom_grain</code> 函数前面添加下划线，那么该函数将在items输出中由Salt呈现两次：一次用于 <code>my_custom_grain</code> 调用本身，另一次用于在 <code>main</code> 函数中调用它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># salt-call --local grains.items</span><br><span class="line">local:</span><br><span class="line">----------</span><br><span class="line">    &lt;Snipped for brevity&gt;</span><br><span class="line">    foo:</span><br><span class="line">        bar</span><br><span class="line">    &lt;Snipped for brevity&gt;</span><br><span class="line">    hello:</span><br><span class="line">        world</span><br><span class="line">    &lt;Snipped for brevity&gt;</span><br><span class="line">    my_grains:</span><br><span class="line">        ----------</span><br><span class="line">        foo:</span><br><span class="line">            bar</span><br><span class="line">        hello:</span><br><span class="line">            world</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="优先权"><a href="#优先权" class="headerlink" title="优先权"></a>优先权</h3><p>PRECEDENCE</p>
<p>Core grain 可被 custom grain所覆盖，因此应该记住它们的优先顺序：</p>
<ol>
<li>Core grains</li>
<li>Custom grains in <code>/etc/salt/grains</code></li>
<li>Custom grains in <code>/etc/salt/minion</code></li>
<li>Custom grain modules in <code>_grains</code> directory, synced to minions</li>
</ol>
<p><br><br><br></p>
<h3 id="GRAINS栗子"><a href="#GRAINS栗子" class="headerlink" title="GRAINS栗子"></a>GRAINS栗子</h3><p>示例: <a href="https://github.com/saltstack/salt/blob/develop/salt/grains/core.py" target="_blank" rel="noopener">https://github.com/saltstack/salt/blob/develop/salt/grains/core.py</a></p>
<p><br><br><br><br><br></p>
<h2 id="PILLAR"><a href="#PILLAR" class="headerlink" title="PILLAR"></a>PILLAR</h2><p>STORING STATIC DATA IN THE PILLAR</p>
<blockquote>
<p>注意:<br>Pillar用来存储敏感数据<br>Pillar data 在 master 上进行编译。此外，给定minion 的 pillar data 只能由配置文件中定义的 目标minion 来访问。这使得 pillar data 可用于存储特定minion的敏感信息很有用。<br>我觉得 salt pillar 有点类似于 K8S seceret</p>
</blockquote>
<p><strong>Pillar</strong> 是一个Salt接口，用来为分布式 minions 提供 全局值(global value)。</p>
<p><br><br><br></p>
<h3 id="声明Master-Pillar"><a href="#声明Master-Pillar" class="headerlink" title="声明Master Pillar"></a>声明Master Pillar</h3><p>DECLARING THE MASTER PILLAR</p>
<p>Salt Master 维护一个 <code>pillar_roots</code> 设置，该设置与Salt文件服务器中使用的 <code>file_roots</code> 的结构相匹配。然后根据 top file 中的匹配器将 pillar data 映射到minions。</p>
<p>master配置文件中的例子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#它不能是 state tree 下的子目录</span></span><br><span class="line"><span class="attr">pillar_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/pillar</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/pillar/top.sls</span></span><br><span class="line"><span class="comment">#此 top file 声明在 base 环境中，匹配所有minions的glob将具有在 `package` 中找到的 pillar data 可用于它</span></span><br><span class="line"><span class="comment">#假设pillar_root使用上面的值，则如下packages将定位到/srv/pillar/packages.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">packages</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可将任意数量的匹配器添加到base环境中</span></span><br><span class="line"><span class="comment">#/srv/pillar/top.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">packages</span></span><br><span class="line">  <span class="string">'web*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">vim</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>示例显示了如何使用其它标准顶部匹配类型将特定 salt pillar data 传递给具有不同属性的minions:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#grains matcher</span></span><br><span class="line"><span class="attr">dev:</span></span><br><span class="line">  <span class="string">'os:Debian'</span><span class="string">:</span></span><br><span class="line"><span class="attr">    - match:</span> <span class="string">grain</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">servers</span></span><br></pre></td></tr></table></figure>
<p><code>/srv/pillar/packages.sls</code>, 所有minions都具有<code>company</code>这个键值对</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> grains['os'] == 'RedHat' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">apache: httpd</span></span><br><span class="line"><span class="xml">git: git</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">elif</span></span> grains['os'] == 'Debian' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">apache: apache2</span></span><br><span class="line"><span class="xml">git: git-core</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">company: Foo Industries</span></span><br></pre></td></tr></table></figure>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">apache:</span></span><br><span class="line"><span class="xml">  pkg.installed:</span></span><br><span class="line"><span class="xml">    - name: </span><span class="template-variable">&#123;&#123; pillar['apache'] &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">git:</span></span><br><span class="line"><span class="xml">  pkg.installed:</span></span><br><span class="line"><span class="xml">    - name: </span><span class="template-variable">&#123;&#123; pillar['git'] &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="动态Pillar环境"><a href="#动态Pillar环境" class="headerlink" title="动态Pillar环境"></a>动态Pillar环境</h3><p>DYNAMIC PILLAR ENVIRONMENTS</p>
<p>如果在 <code>pillar_roots</code> 中指定了环境 <code>__env__</code>，在 <code>pillar_roots</code> 中未明确指定的所有环境都将映射到 <code>__env__</code> 中的目录。这使得人们可以使用基于 dynamic git branch 的环境来处理 state/pillar 文件，并使用相同的基于文件的pillar应用于所有环境。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pillar_roots:</span></span><br><span class="line"><span class="attr">  __env__:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/pillar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ext_pillar:</span></span><br><span class="line"><span class="attr">  - git:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">__env__</span> <span class="attr">https://example.com/git-pillar.git</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="PILLAR-NAMESPACE-FLATTENING"><a href="#PILLAR-NAMESPACE-FLATTENING" class="headerlink" title="PILLAR NAMESPACE FLATTENING"></a>PILLAR NAMESPACE FLATTENING</h3><p>单独的 pillar SLS 文件全部合并为单个键值对字典。当在多个SLS文件中定义相同的Key时，如果不注意 pillar SLS 文件的布局方式，可能会导致意外情况发生。</p>
<p>栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#top.sls</span></span><br><span class="line"></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">packages</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">services</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># packages.sls包含</span></span><br><span class="line"><span class="attr">bind:</span> <span class="string">bind9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#services.sls包含</span></span><br><span class="line"><span class="attr">bind:</span> <span class="string">named</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#此二者相同，package之后会评估 services，所以bind9这个值会丢失</span></span><br><span class="line"><span class="comment">#在请求 pillar bind key时，将返回 named</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用多层次的pillar文件可能会更好</span></span><br><span class="line"><span class="comment">#packages.sls</span></span><br><span class="line"><span class="attr">packages:</span></span><br><span class="line"><span class="attr">  bind:</span> <span class="string">bind9</span></span><br></pre></td></tr></table></figure>
<p>pillar 文件按照它们在 top file 中列出的顺序应用。因此，冲突的Key将以最后一次胜利的方式的值覆盖！</p>
<p><br><br><br></p>
<h3 id="pillar字典合并"><a href="#pillar字典合并" class="headerlink" title="pillar字典合并"></a>pillar字典合并</h3><p>PILLAR DICTIONARY MERGING</p>
<p>如果在多个 pillar SLS 文件中定义了相同的 pillar key，并且两个文件中的key都引用了嵌套的字典，则将以递归方式合并这些字典中的内容。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#top.sls与上面相同</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#packages.sls</span></span><br><span class="line"><span class="attr">bind:</span></span><br><span class="line"><span class="attr">  package-name:</span> <span class="string">bind9</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">9.9</span><span class="number">.5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#services.sls</span></span><br><span class="line"><span class="attr">bind:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">  listen-on:</span> <span class="string">any</span></span><br></pre></td></tr></table></figure>
<p>pillar字典结果如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">salt-call pillar.get bind</span><br><span class="line">local:</span><br><span class="line">    ----------</span><br><span class="line">    listen-on:</span><br><span class="line">        any</span><br><span class="line">    package-name:</span><br><span class="line">        bind9</span><br><span class="line">    port:</span><br><span class="line">        53</span><br><span class="line">    version:</span><br><span class="line">        9.9.5</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="包含其它pillars"><a href="#包含其它pillars" class="headerlink" title="包含其它pillars"></a>包含其它pillars</h3><p>INCLUDING OTHER PILLARS</p>
<p>与state文件类似，pillar SLS 文件可能包含其它 pillar 文件。有两种语法可实现此目的：</p>
<ul>
<li>简单包含表单</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">users</span></span><br></pre></td></tr></table></figure>
<ul>
<li>完整包含表单</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="attr">  - users:</span></span><br><span class="line"><span class="attr">      defaults:</span></span><br><span class="line"><span class="attr">          sudo:</span> <span class="string">['bob',</span> <span class="string">'paul'</span><span class="string">]</span></span><br><span class="line"><span class="attr">      key:</span> <span class="string">users</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="内存中的pillar数据与一经请求的pillar数据"><a href="#内存中的pillar数据与一经请求的pillar数据" class="headerlink" title="内存中的pillar数据与一经请求的pillar数据"></a>内存中的pillar数据与一经请求的pillar数据</h3><p>IN-MEMORY PILLAR DATA VS. ON-DEMAND PILLAR DATA</p>
<p>由于编译pillar数据在计算上是昂贵的，因此minion将在内存中维护pillar数据的副本，以避免在每次请求pillar数据时要求master重新编译并向其发送pillar数据的副本。这个内存中(in-mem)的pillar数据是 <code>pillar.item</code>, <code>pillar.get</code>,<code>pillar.raw</code> 函数返回的内容。</p>
<p>对于自定义编写的可执行模块，内存中的pillar数据在 <code>__pillar__</code> 字典下可用。</p>
<p>内存中的pillar是在minion启动时生成的，可使用 <code>saltutil.refresh_pillar</code> 函数进行刷新。此函数触发minion异步刷新内存中的pillar数据，并始终返回<code>None</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> saltutil.refresh_pillar</span><br></pre></td></tr></table></figure>
<p>与内存中pillar数据相反，某些动作会触发pillar数据的编译，以确保最新的pillar数据可用。这些动作包括:</p>
<ul>
<li>运行 states</li>
<li>运行 <code>pillar.items</code></li>
</ul>
<p>执行这些操作不会刷新内存中的pillar数据。因此，如果pillar数据被修改，然后运行state，状态将看到更新后的pillar数据，但是<code>pillar.item</code>, <code>pillar.get</code>, <code>pillar.raw</code> 将不会看到更新，除非使用 <code>saltutil.refresh_pillar</code> 函数进行刷新。</p>
<p><br><br><br></p>
<h3 id="如何处理pillar环境"><a href="#如何处理pillar环境" class="headerlink" title="如何处理pillar环境"></a>如何处理pillar环境</h3><p>HOW PILLAR ENVIRONMENTS ARE HANDLED</p>
<p>当使用多个pillar环境时，默认行为是将来自所有环境的pillar数据合并在一起。</p>
<p>minion配置项 <code>pillarenv</code> 可用于强制minion仅考虑来自单个环境的pillar配置。这对于需要在 test/QA 环境中运行具有备用pillar数据的状态或在推送pillar数据之前测试pillar数据的更改的情况非常有用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#minion config 栗子</span></span><br><span class="line"><span class="attr">pillarenv:</span> <span class="string">base</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在编译内存中的pillar数据时，这将导致minion忽略除base之外的所有其它pillar环境</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pillarenv命令行参数 可以覆盖 配置文件中的值</span></span><br><span class="line">salt <span class="string">'*'</span> state.apply mystates pillarenv=testing</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>可以使用minion配置选项 <code>pillarenv_from_saltenv</code> 将 <code>pillarenv</code> 固定到有效的 <code>saltenv</code>。当此参数设置为<code>True</code>时，如果在运行状态时指定了特定的 <code>saltenv</code>，则 <code>pillarenv</code>将与之相同。<br>如果指定了 <code>pillarenv</code>，它将覆盖此行为。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> state.apply mystates saltenv=dev</span><br><span class="line">salt <span class="string">'*'</span> state.apply mystates saltenv=dev pillarenv=dev</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">salt <span class="string">'*'</span> state.apply mystates saltenv=dev pillarenv=qa</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="查看pillar数据"><a href="#查看pillar数据" class="headerlink" title="查看pillar数据"></a>查看pillar数据</h3><p>VIEWING PILLAR DATA</p>
<p>要查看pillar数据 ，使用 <code>pillar</code> 执行模块。此模块包含如下函数:</p>
<ul>
<li><code>pillar.item</code>: 从内存中的pillar daj中检索一个或多个key的值</li>
<li><code>pillar.items</code>: 编译一个新的pillar数据并返回它，保持内存中的pillar数据不变。但是，如果将 pillar key 传递给此函数，则此函数的作用类似于 <code>pillar.item</code></li>
<li><code>pillar.raw</code>: 从内存中返回整个pillar dictionary</li>
<li><code>pillar.get</code>: 与Python dict中的<code>get</code>方法相同，但有一个增强功能，可以使用冒号<code>:</code>作为分隔符遍历嵌套的dicts</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pillar嵌套栗子</span></span><br><span class="line"><span class="attr">foo:</span></span><br><span class="line"><span class="attr">  bar:</span></span><br><span class="line"><span class="attr">    baz:</span> <span class="string">qux</span></span><br></pre></td></tr></table></figure>
<p>从SLS公式或模板中提取是这样的:</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; pillar['foo']['bar']['baz'] &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>使用新的 <code>pillar.get</code> 函数可以安全地收集数据并设置默认值，如果值不可用，则允许模板回退。这使得处理嵌套结构变得更加容易。</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; salt['pillar.get']('foo:bar:baz', 'qux') &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="在CLI设置pillar数据"><a href="#在CLI设置pillar数据" class="headerlink" title="在CLI设置pillar数据"></a>在CLI设置pillar数据</h3><p>SETTING PILLAR DATA AT THE COMMAND LINE</p>
<blockquote>
<p>注意:<br>当通过命令行中的pillar发送敏感数据时，所有minions都将收到包含该数据的发布，并且不会限制为目标minion<br>在某些情况下，这可能存在安全问题</p>
</blockquote>
<p>pillar数据可在命令行设置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> state.apply pillar=<span class="string">'&#123;"cheese": "spam"&#125;'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Pillar加密"><a href="#Pillar加密" class="headerlink" title="Pillar加密"></a>Pillar加密</h3><p>PILLAR ENCRYPTION</p>
<p>Salt的渲染器系统可用于解密pillar数据。这允许pillar项目以加密状态存储，并在编译期间解密。</p>
<p><br></p>
<p><strong>加密pillar SLS</strong></p>
<p>考虑如下 pillar SLS 文件:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">secrets:</span></span><br><span class="line"><span class="attr">  vault:</span></span><br><span class="line"><span class="attr">    foo:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      -----BEGIN PGP MESSAGE-----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      hQEMAw2B674HRhwSAQgAhTrN8NizwUv/VunVrqa4/X8t6EUulrnhKcSeb8sZS4th</span></span><br><span class="line"><span class="string">      W1Qz3K2NjL4lkUHCQHKZVx/VoZY7zsddBIFvvoGGfj8+2wjkEDwFmFjGE4DEsS74</span></span><br><span class="line"><span class="string">      ZLRFIFJC1iB/O0AiQ+oU745skQkU6OEKxqavmKMrKo3rvJ8ZCXDC470+i2/Hqrp7</span></span><br><span class="line"><span class="string">      +KWGmaDOO422JaSKRm5D9bQZr9oX7KqnrPG9I1+UbJyQSJdsdtquPWmeIpamEVHb</span></span><br><span class="line"><span class="string">      VMDNQRjSezZ1yKC4kCWm3YQbBF76qTHzG1VlLF5qOzuGI9VkyvlMaLfMibriqY73</span></span><br><span class="line"><span class="string">      zBbPzf6Bkp2+Y9qyzuveYMmwS4sEOuZL/PetqisWe9JGAWD/O+slQ2KRu9hNww06</span></span><br><span class="line"><span class="string">      KMDPJRdyj5bRuBVE4hHkkP23KrYr7SuhW2vpe7O/MvWEJ9uDNegpMLhTWruGngJh</span></span><br><span class="line"><span class="string">      iFndxegN9w==</span></span><br><span class="line"><span class="string">      =bAuo</span></span><br><span class="line"><span class="string">      -----END PGP MESSAGE-----</span></span><br><span class="line"><span class="string"></span><span class="attr">    bar:</span> <span class="string">this</span> <span class="string">was</span> <span class="string">unencrypted</span> <span class="string">already</span></span><br><span class="line"><span class="attr">    baz:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      -----BEGIN PGP MESSAGE-----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      hQEMAw2B674HRhwSAQf+Ne+IfsP2IcPDrUWct8sTJrga47jQvlPCmO+7zJjOVcqz</span></span><br><span class="line"><span class="string">      gLjUKvMajrbI/jorBWxyAbF+5E7WdG9WHHVnuoywsyTB9rbmzuPqYCJCe+ZVyqWf</span></span><br><span class="line"><span class="string">      9qgJ+oUjcvYIFmH3h7H68ldqbxaAUkAOQbTRHdr253wwaTIC91ZeX0SCj64HfTg7</span></span><br><span class="line"><span class="string">      Izwk383CRWonEktXJpientApQFSUWNeLUWagEr/YPNFA3vzpPF5/Ia9X8/z/6oO2</span></span><br><span class="line"><span class="string">      q+D5W5mVsns3i2HHbg2A8Y+pm4TWnH6mTSh/gdxPqssi9qIrzGQ6H1tEoFFOEq1V</span></span><br><span class="line"><span class="string">      kJBe0izlfudqMq62XswzuRB4CYT5Iqw1c97T+1RqENJCASG0Wz8AGhinTdlU5iQl</span></span><br><span class="line"><span class="string">      JkLKqBxcBz4L70LYWyHhYwYROJWjHgKAywX5T67ftq0wi8APuZl9olnOkwSK+wrY</span></span><br><span class="line"><span class="string">      1OZi</span></span><br><span class="line"><span class="string">      =7epf</span></span><br><span class="line"><span class="string">      -----END PGP MESSAGE-----</span></span><br><span class="line"><span class="string"></span><span class="attr">    qux:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">foo</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">bar</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">|</span></span><br><span class="line"><span class="string">        -----BEGIN PGP MESSAGE-----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        hQEMAw2B674HRhwSAQgAg1YCmokrweoOI1c9HO0BLamWBaFPTMblOaTo0WJLZoTS</span></span><br><span class="line"><span class="string">        ksbQ3OJAMkrkn3BnnM/djJc5C7vNs86ZfSJ+pvE8Sp1Rhtuxh25EKMqGOn/SBedI</span></span><br><span class="line"><span class="string">        gR6N5vGUNiIpG5Tf3DuYAMNFDUqw8uY0MyDJI+ZW3o3xrMUABzTH0ew+Piz85FDA</span></span><br><span class="line"><span class="string">        YrVgwZfqyL+9OQuu6T66jOIdwQNRX2NPFZqvon8liZUPus5VzD8E5cAL9OPxQ3sF</span></span><br><span class="line"><span class="string">        f7/zE91YIXUTimrv3L7eCgU1dSxKhhfvA2bEUi+AskMWFXFuETYVrIhFJAKnkFmE</span></span><br><span class="line"><span class="string">        uZx+O9R9hADW3hM5hWHKH9/CRtb0/cC84I9oCWIQPdI+AaPtICxtsD2N8Q98hhhd</span></span><br><span class="line"><span class="string">        4M7I0sLZhV+4ZJqzpUsOnSpaGyfh1Zy/1d3ijJi99/l+uVHuvmMllsNmgR+ZTj0=</span></span><br><span class="line"><span class="string">        =LrCQ</span></span><br><span class="line"><span class="string">        -----END PGP MESSAGE-----</span></span><br></pre></td></tr></table></figure>
<p>编译pillar数据时，结果将被解密:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt myminion pillar.items</span></span><br><span class="line">myminion:</span><br><span class="line">    ----------</span><br><span class="line">    secrets:</span><br><span class="line">        ----------</span><br><span class="line">        vault:</span><br><span class="line">            ----------</span><br><span class="line">            bar:</span><br><span class="line">                this was unencrypted already</span><br><span class="line">            baz:</span><br><span class="line">                rosebud</span><br><span class="line">            foo:</span><br><span class="line">                supersecret</span><br><span class="line">            qux:</span><br><span class="line">                - foo</span><br><span class="line">                - bar</span><br><span class="line">                - baz</span><br></pre></td></tr></table></figure>
<p>必须告诉Salt要解密的pillar数据的哪部分。这使用 <code>decrypt_pillar</code> 配置选项完成的:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">decrypt_pillar:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'secrets:vault'</span><span class="string">:</span> <span class="string">gpg</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以使用 ` decrypt_pillar_delimiter` 配置项指定分隔符</span></span><br><span class="line"><span class="attr">decrypt_pillar:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'secrets|vault'</span><span class="string">:</span> <span class="string">gpg</span></span><br><span class="line"></span><br><span class="line"><span class="attr">decrypt_pillar_delimiter:</span> <span class="string">'|'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>在CLI加密pillar数据</strong></p>
<p>以下函数支持通过pillar参数在CLI上传递pillar数据:</p>
<ul>
<li><code>pillar.items</code></li>
<li><code>state.apply</code></li>
<li><code>state.highstate</code></li>
<li><code>state.sls</code></li>
</ul>
<p><br><br><br></p>
<h3 id="MASTER-CONFIG-IN-PILLAR"><a href="#MASTER-CONFIG-IN-PILLAR" class="headerlink" title="MASTER CONFIG IN PILLAR"></a>MASTER CONFIG IN PILLAR</h3><p>为方便起见，存储在Master配置文件中的数据可以在所有minion的pillar中使用。这使得服务和系统的全局配置非常容易。但如果敏感数据存储在Master配置中，则可能不需要。默认情况下禁用此选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在minion config 启用它</span><br><span class="line">pillar_opts: True</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="MINION-CONFIG-IN-PILLAR"><a href="#MINION-CONFIG-IN-PILLAR" class="headerlink" title="MINION CONFIG IN PILLAR"></a>MINION CONFIG IN PILLAR</h3><p>可在pillar上设置Minion配置选项。您要修改的任何选项都应位于pillar的第一级，与配置文件中的选项相同。<br>例如，要配置MySQL Salt执行模块使用的MySQL root密码，请设置以下pillar变量:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql.pass:</span> <span class="string">hardtoguesspassword</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="TARGETING-MINIONS"><a href="#TARGETING-MINIONS" class="headerlink" title="TARGETING MINIONS"></a>TARGETING MINIONS</h2><p>目标minions 指定哪些minions应该运行命令，或通过匹配主机名、系统信息、定义的组、甚至其组合来执行状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#栗子</span></span><br><span class="line"><span class="comment">#重新启动指定目标为web1的机器的 apache httpd，并且命令将仅在此一个minion上运行</span></span><br><span class="line">salt web1 apache.signal restart</span><br></pre></td></tr></table></figure>
<p>在State的 top file 中情况也类似，如<code>webserver.sls</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base:</span></span><br><span class="line"><span class="attr">  'web1':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="TARGETING-WITH-GRAINS"><a href="#TARGETING-WITH-GRAINS" class="headerlink" title="TARGETING WITH GRAINS"></a>TARGETING WITH GRAINS</h3><p>Grains Interface 内置于Salt中，用于收集系统属性。因此，可以调用在 特定操作系统/特定内核 上运行的minions来执行函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">salt &apos;*&apos; grains.items</span><br><span class="line">#查看对应的grains信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#-G, Grains</span><br><span class="line">#使用上面的grains信息匹配目标</span><br><span class="line">salt -G &apos;os:Fedora&apos; test.ping</span><br><span class="line">salt -G &apos;host:xxx&apos; test.ping</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="复合条件"><a href="#复合条件" class="headerlink" title="复合条件"></a>复合条件</h3><p>COMPOUND TARGETING</p>
<p>可以结合使用多个目标接口来确定命令目标，通过使用 <code>and</code> 和 <code>or</code>语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#默认类型为 glob</span><br><span class="line">#可通过 类型字母@ 来指定类型</span><br><span class="line">#G@, 表示Grains</span><br><span class="line">#E@, 表示RE</span><br><span class="line">salt -C &apos;G@os:Debian and webser* or E@db.*&apos; test.ping</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="节点组目标"><a href="#节点组目标" class="headerlink" title="节点组目标"></a>节点组目标</h3><p>NODE GROUP TARGETING</p>
<p>对于某些情况，可以方便地使用预定义的一组minions来执行命令。这可以使用所谓的 <strong>节点组(nodegroups)</strong> 来完成。节点组允许在Master配置文件中声明预定义的复合目标，作为必须键入复杂复合表达式的一种简写。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodegroups:</span></span><br><span class="line"><span class="attr">  group1:</span> <span class="string">'L@foo.domain.com,bar.domain.com,baz.domain.com and bl*.domain.com'</span></span><br><span class="line"><span class="attr">  group2:</span> <span class="string">'G@os:Debian and foo.domain.com'</span></span><br><span class="line"><span class="attr">  group3:</span> <span class="string">'G@os:Debian and N@group1'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="高级的目标方法"><a href="#高级的目标方法" class="headerlink" title="高级的目标方法"></a>高级的目标方法</h3><p>ADVANCED TARGETING METHODS</p>
<p>url: <a href="https://docs.saltstack.com/en/latest/topics/targeting/index.html#advanced-targeting-methods" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/targeting/index.html#advanced-targeting-methods</a></p>
<p>后面再来学习。</p>
<p><br><br><br><br><br></p>
<h2 id="MINE"><a href="#MINE" class="headerlink" title="MINE"></a>MINE</h2><p>THE SALT MINE</p>
<p><strong>Salt Mine</strong> 用于从Minions收集任意数据(arbitrary data)并将其存储在Master上，它只维护最新数据。通过 <code>salt.modules.mine</code> 模块将所有数据提供给所有Minions。</p>
<p><br></p>
<p><strong>MINE VS GRAINS</strong></p>
<p>Mine数据要比Grains数据更新。<br>Grains在非常有限的基础上更新数据，主要是静态数据。<br>当Minions需要来自其它Minions的数据时，Mines旨在取代慢速对等发布调用。Salt Mine 运行在 Master，而不是让一个minion与其它minions联系以获取数据。可从所有minion的每个 <code>Minion Interval</code> 收集它，在任何给定时间产生几乎新鲜的数据，而且开销更少。</p>
<p><br><br><br></p>
<h3 id="Mine函数"><a href="#Mine函数" class="headerlink" title="Mine函数"></a>Mine函数</h3><p>要启用Salt Mine，需要将 <code>mine_functions</code> 选项应用于Minion。此选项可通过 minion config/minion pillar 来应用。它指示正在执行的函数，并传入参数。<code>salt.module</code>中提供了函数列表。如果没有传递参数，则必须添加一个空列表。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mine_functions:</span></span><br><span class="line">  <span class="string">test.ping:</span> <span class="string">[]</span></span><br><span class="line">  <span class="string">network.ip_addrs:</span></span><br><span class="line"><span class="attr">    interface:</span> <span class="string">eth0</span></span><br><span class="line"><span class="attr">    cidr:</span> <span class="string">'10.0.0.0/8'</span></span><br><span class="line"><span class="comment">#做了网络范围限制</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Mine函数别名</strong></p>
<p>函数别名可用于提供友好地名称、使用意图、允许使用不同参数多次调用相同函数。传递位置参数和KV参数有不同的语法，不支持混合位置参数和KV参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mine_functions:</span></span><br><span class="line">  <span class="string">network.ip_addrs:</span> <span class="string">[eth0]</span></span><br><span class="line">  <span class="string">networkplus.internal_ip_addrs:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  internal_ip_addrs:</span></span><br><span class="line"><span class="attr">    mine_function:</span> <span class="string">network.ip_addrs</span></span><br><span class="line"><span class="attr">    cidr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">  ip_list:</span></span><br><span class="line"><span class="attr">    - mine_function:</span> <span class="string">grains.get</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ip_interfaces</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="MINE-INTERVAL"><a href="#MINE-INTERVAL" class="headerlink" title="MINE INTERVAL"></a>MINE INTERVAL</h3><p>Mine Interval 函数在Minion启动时执行，并由调度程序以给定间隔(interval)执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#minion config</span><br><span class="line">#默认60m</span><br><span class="line">mine_interval: 60</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="MINE-IN-SALT-SSH"><a href="#MINE-IN-SALT-SSH" class="headerlink" title="MINE IN SALT-SSH"></a>MINE IN SALT-SSH</h4><p>由于Minions不能提供它们自己的 <code>mine_functions</code> 配置，所以在三个地方之一中检索指定的mine函数的参数，按以下顺序搜索:</p>
<ol>
<li>Roster data</li>
<li>Pillar</li>
<li>Master config</li>
</ol>
<p><br><br><br><br><br></p>
<h2 id="RUNNERS"><a href="#RUNNERS" class="headerlink" title="RUNNERS"></a>RUNNERS</h2><p><strong>Salt runners</strong> 是使用 <code>salt-run</code> 命令执行的便捷应用程序。<br>Salt runners 与 Salt  execution modules 的工作方式类似。但是，它在 Salt master本身 而不是 远程Salt minions 上执行。</p>
<p>Salt runner 可以是 一个简单的客户调用 或 一个复杂的应用程序。</p>
<p><br></p>
<h3 id="RUNNER-MODULES"><a href="#RUNNER-MODULES" class="headerlink" title="RUNNER MODULES"></a>RUNNER MODULES</h3><p>The full list of runners: <a href="https://docs.saltstack.com/en/latest/ref/runners/all/index.html#all-salt-runners" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/runners/all/index.html#all-salt-runners</a></p>
<p><br><br><br></p>
<h3 id="编写Runner"><a href="#编写Runner" class="headerlink" title="编写Runner"></a>编写Runner</h3><p>WRITING SALT RUNNERS</p>
<p>Salt runner 的编写方式也与 Salt execution module 类似。两者都是包含函数的Python模块，每个公共函数都是一个可以通过 <code>salt-run</code> 命令执行的 Runner。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#栗子</span></span><br><span class="line"><span class="comment">#在runners目录中创建了名为test.py的Python模块，此模块包含一个名为foo的函数</span></span><br><span class="line"><span class="comment">#则runner可以这样调用它</span></span><br><span class="line">salt-run test.foo</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>runner有几种控制输出的选项:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#runner上的任何print语句会自动触发到master的事件总线上</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_runner</span><span class="params">(outputter=None, display_progress=False)</span>:</span></span><br><span class="line">    print(<span class="string">'Hello world'</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>runner 还可以发送进度事件，该进度事件在runner执行期间显示给用户。并且如果runner的 <code>display_progress</code> 参数设置为 <code>True</code>，则也通过事件总线传递。</p>
<p>自定义的runner可以通过 <code>__jid_event_.fire_event()</code> 方法 发送自己的进程事件:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> display_progress:</span><br><span class="line">    __jid_event__.fire_event(&#123;<span class="string">'message'</span>: <span class="string">'A progress message'</span>&#125;, <span class="string">'progress'</span>)</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="同步-异步"><a href="#同步-异步" class="headerlink" title="同步/异步"></a>同步/异步</h3><p>SYNCHRONOUS VS. ASYNCHRONOUS</p>
<p>可以异步触发runner，这将立即返回控制。在这种情况下，如果从命令行使用 <code>salt-run</code>，则不会向用户显示任何输出。如果以编程方式使用，则不会返回任何结果。如果需要结果，则必须从runner到事件总线，或通过其它方式收集。</p>
<p>在异步模式下运行运行程序时，<code>--progress</code> 标志不会将输出传递给 <code>salt-run</code> 的CLI。但是，依然会在总线上触发进程事件。</p>
<p>在同步模式（默认情况），在runner完成执行之前，不会返回控制。</p>
<p>要添加自定义的runner，将它们放置到master config 中的 <code>runner_dirs</code> 配置项的位置里去。</p>
<p><br><br><br></p>
<h3 id="栗子-1"><a href="#栗子-1" class="headerlink" title="栗子"></a>栗子</h3><p>Salt 发行版的runner栗子: <a href="https://github.com/saltstack/salt/blob/develop/salt/runners" target="_blank" rel="noopener">https://github.com/saltstack/salt/blob/develop/salt/runners</a></p>
<p><br><br><br><br><br></p>
<h2 id="SALT-ENGINES"><a href="#SALT-ENGINES" class="headerlink" title="SALT ENGINES"></a>SALT ENGINES</h2><p>Salt Engines are long-running, external system processes that leverage Salt.</p>
<ul>
<li>Engines 可以访问Salt配置，执行modules和runner(<code>__opts__</code>, <code>__salt__</code>, <code>__runners__</code>)</li>
<li>Engines 在由Salt监视的单独进程中执行。如果引擎停止，会自动重启它</li>
<li>Engines 可运行在 Master 和Minions 上</li>
</ul>
<p>SaltEngines 增强并取代了 <a href="https://docs.saltstack.com/en/latest/topics/ext_processes/index.html#ext-processes" target="_blank" rel="noopener">外部进程(external processes)</a> 功能。</p>
<p><br></p>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><p>Salt Engines 可在 master/minion config 中的 <code>engines</code> 部分进行配置:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">engines:</span></span><br><span class="line"><span class="attr">  - logstash:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">log.my_network.com</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">5959</span></span><br><span class="line"><span class="attr">      proto:</span> <span class="string">tcp</span></span><br></pre></td></tr></table></figure>
<p>Salt Engine 必须位于 Salt path 下，或者，你可以在 master config 中添加 <code>engines_dirs</code> 选项让Salt去查找引擎，它的值为要搜索的目录列表。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">engines_dirs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">/home/bob/engines</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="编写引擎"><a href="#编写引擎" class="headerlink" title="编写引擎"></a>编写引擎</h3><p>Salt source 提供了一个栗子引擎: <a href="https://github.com/saltstack/salt/blob/develop/salt/engines/test.py" target="_blank" rel="noopener">https://github.com/saltstack/salt/blob/develop/salt/engines/test.py</a></p>
<p>要开发一个引擎，唯一的要求是你的模块实现了<code>start()</code>函数。</p>
<p><br><br><br><br><br></p>
<h2 id="YAML"><a href="#YAML" class="headerlink" title="YAML"></a>YAML</h2><p>docs: <a href="https://docs.saltstack.com/en/latest/topics/yaml/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/yaml/index.html</a></p>
<p>SLS文件的默认渲染器是YAML渲染器。<br>Salt使用一小部分YAML来映射非常常用的数据结构(如list/dict)。YAML渲染器的工作是采用YAML数据结构并将其编译为Python数据结构以供Salt使用。</p>
<p><br><br><br><br><br></p>
<h2 id="JINJA"><a href="#JINJA" class="headerlink" title="JINJA"></a>JINJA</h2><p>docs: <a href="https://docs.saltstack.com/en/latest/topics/jinja/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/jinja/index.html</a></p>
<p><a href="http://jinja.pocoo.org/" target="_blank" rel="noopener">Jinja</a> 是SLS文件中的默认模板语言。</p>
<p><br><br><br><br><br></p>
<h2 id="教程索引"><a href="#教程索引" class="headerlink" title="教程索引"></a>教程索引</h2><p>TUTORIALS INDEX</p>
<p>docs: <a href="https://docs.saltstack.com/en/latest/topics/tutorials/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/tutorials/index.html</a></p>
<p><br><br><br><br><br></p>
<h2 id="TROUBLESHOOTING"><a href="#TROUBLESHOOTING" class="headerlink" title="TROUBLESHOOTING"></a>TROUBLESHOOTING</h2><p>docs: <a href="https://docs.saltstack.com/en/latest/topics/troubleshooting/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/troubleshooting/index.html</a></p>
<p><br><br><br><br><br></p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>faq: <a href="https://docs.saltstack.com/en/latest/faq.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/faq.html</a></p>
<p><br><br><br><br><br></p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>SALT BEST PRACTICES</p>
<p>docs: <a href="https://docs.saltstack.com/en/latest/topics/best_practices.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/best_practices.html</a></p>
<p>Salt的极端灵活性导致许多关于配置文件结构的问题。<br>本节旨在通过示例和代码阐明这些要点。</p>
<p><br></p>
<h3 id="通用规则"><a href="#通用规则" class="headerlink" title="通用规则"></a>通用规则</h3><p>GENERAL RULES</p>
<ul>
<li>应尽可能强调模块性和清晰度</li>
<li>在Pillars和States之间建立明确的关系</li>
<li>在有意义的情况下使用变量，但不要过度使用变量</li>
<li>将敏感数据存储在 Pillar 中</li>
<li>不要在 pillar top file 中使用 grains 匹配任何敏感pillar</li>
</ul>
<p><br><br><br></p>
<h3 id="构造STATES和FORMULAS"><a href="#构造STATES和FORMULAS" class="headerlink" title="构造STATES和FORMULAS"></a>构造STATES和FORMULAS</h3><p>在构造Salt States和Formulas时，重要的是从目录结构开始。恰当的目录结构通过可视查状态名称清楚地为用户定义每个状态的功能。</p>
<p><br><br><br></p>
<h3 id="构造Pillar"><a href="#构造Pillar" class="headerlink" title="构造Pillar"></a>构造Pillar</h3><p>Pillar 用于存储于Minions有关的安全的和不安全的数据。在设计 <code>/srv/pillar</code> 目录的结构时，其中包含的 Pillar 应该再次专注于清晰简洁的数据，用户可以轻松查看、修改、理解这些数据。</p>
<p><br><br><br></p>
<h3 id="变量的灵活性"><a href="#变量的灵活性" class="headerlink" title="变量的灵活性"></a>变量的灵活性</h3><p>VARIABLE FLEXIBILITY</p>
<p>Salt允许用户在SLS文件中定义变量。创建状态变量时应为用户提供尽可能多的灵活性。这意味着应该清楚地定义变量并且易于操作，并且在未正确定义变量的情况下应该存在合理的默认值。</p>
<p><br><br><br></p>
<h3 id="状态模块化"><a href="#状态模块化" class="headerlink" title="状态模块化"></a>状态模块化</h3><p>MODULARITY WITHIN STATES</p>
<p>确保状态是模块化的是理解Salt的关键概念之一。在创建状态时，用户必须考虑重新使用状态的次数，以及它依赖于操作的次数。</p>
<p><br><br><br></p>
<h3 id="存储安全数据"><a href="#存储安全数据" class="headerlink" title="存储安全数据"></a>存储安全数据</h3><p>STORING SECURE DATA</p>
<p>安全数据是指您不希望与访问服务器的任何人分享的任何信息，这可能包括密码、密钥…</p>
<p>由于连接的每个服务器都可以访问状态中的所有数据，因此将安全数据存储在Pillar中非常重要。这将确保只有那些需要此安全数据的服务器才能访问它。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="远程执行"><a href="#远程执行" class="headerlink" title="远程执行"></a>远程执行</h1><p>REMOTE EXECUTION</p>
<p>在远程主机上运行 预定义的 或 任意命令 —— 也称为远程执行，是Salt的核心功能。modules 和 returners 是远程执行的两个关键要素。</p>
<p><strong>Salt Execution Modules</strong><br>远程执行系统调用Salt执行模块来执行各种任务。这些模块提供了各种各样的功能。</p>
<p><br></p>
<h2 id="执行模块"><a href="#执行模块" class="headerlink" title="执行模块"></a>执行模块</h2><p>EXECUTION MODULES</p>
<p>Full list of execution modules: <a href="https://docs.saltstack.com/en/latest/ref/modules/all/index.html#all-salt-modules" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/modules/all/index.html#all-salt-modules</a></p>
<p><br><br><br><br><br></p>
<h2 id="编写执行模块"><a href="#编写执行模块" class="headerlink" title="编写执行模块"></a>编写执行模块</h2><p>WRITING EXECUTION MODULES</p>
<p>Writing execution modules: <a href="https://docs.saltstack.com/en/latest/ref/modules/index.html#writing-execution-modules" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/modules/index.html#writing-execution-modules</a></p>
<p><br><br><br><br><br></p>
<h3 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h3><p>REMOTE EXECUTION TUTORIAL</p>
<p>Salt调用由三个主要组件组成:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'&lt;target&gt;'</span> &lt;<span class="keyword">function</span>&gt; [arguments]</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>TARGET</strong></p>
<p>目标组件允许您过滤哪些minions应运行以下函数，默认的过滤器是glob的<code>minion.id</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> test.ping</span><br><span class="line">salt <span class="string">'*.example.org'</span> test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于Grains</span></span><br><span class="line">salt -G <span class="string">'os:Ubuntu'</span> test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于RE</span></span><br><span class="line">salt -E <span class="string">'virtmach[0-9]'</span> test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定一个列表</span></span><br><span class="line">salt -L <span class="string">'foo,bar,baz,quo'</span> test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#复合目标</span></span><br><span class="line">salt -C <span class="string">'G@os:Ubuntu and webser* or E@database.*'</span> test.ping</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>FUNCTION</strong></p>
<p>函数是模块提供的一些功能。Salt附带了大量可用的功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出minion上可用的所有函数</span></span><br><span class="line">salt <span class="string">'*'</span> sys.doc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#显示当前可用的minions</span></span><br><span class="line">salt <span class="string">'*'</span> test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#运行任意shell命令</span></span><br><span class="line">salt <span class="string">'*'</span> cmd.run <span class="string">'uname -a'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>ARGUMENTS</strong></p>
<p>使用空格分割函数的参数，也支持关键字参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cmd.exec_code python <span class="string">'import sys; print sys.version'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关键字参数, kwarg=argument</span></span><br><span class="line">salt <span class="string">'*'</span> pip.install salt timeout=5 upgrade=True</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="在minions上运行命令"><a href="#在minions上运行命令" class="headerlink" title="在minions上运行命令"></a>在minions上运行命令</h2><p>RUNNING COMMANDS ON SALT MINIONS</p>
<p>Salt Master 上的root用户可以通过 CLI Client 控制Salt。 Salt CLI Client 使用 Salt Client API 与 Salt Master Server 进行通信。Salt Client 简单易用。<br>使用 Salt Client 命令可以轻松发送给 minions。</p>
<p><br></p>
<h3 id="使用Salt命令"><a href="#使用Salt命令" class="headerlink" title="使用Salt命令"></a>使用Salt命令</h3><p>USING THE SALT COMMAND</p>
<p><strong>Salt command</strong> 需要一些组件来向 Salt minions 发送信息。需要定义目标minions，调用函数和函数需要的任何参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#DEFINING THE TARGET MINIONS</span></span><br><span class="line">salt <span class="string">'*foo.com'</span> sys.doc</span><br><span class="line">salt -E <span class="string">'.*'</span> cmd.run <span class="string">'ls -l | grep foo'</span></span><br><span class="line">salt -L foo.bar.baz,quo.qux cmd.run <span class="string">'ps aux | grep foo'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CALLING THE FUNCTION</span></span><br><span class="line">salt <span class="string">'*'</span> cmd.exec_code python <span class="string">'import sys; print sys.version'</span></span><br><span class="line">salt <span class="string">'*'</span> pip.install salt timeout=5 upgrade=True</span><br><span class="line">salt <span class="string">'*'</span> cmd.run <span class="string">'echo "Hello: $FIRST_NAME"'</span> saltenv=<span class="string">'&#123;FIRST_NAME: "Joe"&#125;'</span></span><br><span class="line">salt <span class="string">'*'</span> test.arg_repr <span class="string">'echo "Hello: $FIRST_NAME"'</span> saltenv=<span class="string">'&#123;FIRST_NAME: "Joe"&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#FINDING AVAILABLE MINION FUNCTIONS</span></span><br><span class="line">salt <span class="string">'*'</span> sys.doc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#COMPOUND COMMAND EXECUTION</span></span><br><span class="line"><span class="comment">#将一系列命令发送到单个目标，可以在单个发布中发送命令。这可以更快地收集信息组，并降低网络对重复命令的压力</span></span><br><span class="line"><span class="comment">#复合命令执行的工作原理是发送函数和参数列表，而不是发送单个函数和参数</span></span><br><span class="line"><span class="comment">#这些函数按照它们在命令行中定义的顺序在minion上执行，然后所有命令中的数据都在字典中返回</span></span><br><span class="line"></span><br><span class="line">salt <span class="string">'*'</span> cmd.run,test.ping,test.echo <span class="string">'cat /proc/cpuinfo'</span>,,foo</span><br><span class="line"></span><br><span class="line"><span class="comment">#cmd.run的参数为'cat /proc/cpuinfo'</span></span><br><span class="line"><span class="comment">#test.ping的参数为空</span></span><br><span class="line"><span class="comment">#test.echo的参数为foo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#传递的命令包含参数</span></span><br><span class="line">salt <span class="string">'*'</span> cmd.run,test.ping,test.echo <span class="string">'echo "1,2,3"'</span> , , foo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#还可指定参数分割符</span></span><br><span class="line">salt --args-separator=:: <span class="string">'*'</span> some.fun,test.echo params with , comma :: foo</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="EXECUTORS"><a href="#EXECUTORS" class="headerlink" title="EXECUTORS"></a>EXECUTORS</h2><p>minion使用 <strong>执行程序(executor)</strong> 来执行模块函数(module func)。执行程序可用于修改函数行为，执行任何执行前的步骤或以特定方式执行，如 <code>sudo执行器</code> 。</p>
<p>执行程序可以作为列表传递，它们将在指令中逐个使用。<br>如果执行程序返回 <code>None</code> ，则将调用下一个执行程序；如果执行程序返回<code>非None</code> ，则终止执行序列，并将返回的值用作结果。这是一种执行器可以控制模块执行作为过滤器的方式。</p>
<p>执行器列表可以通过如下方式在 minion config 中传递:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">module_executors:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">splay</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">direct_call</span></span><br><span class="line"><span class="attr">splaytime:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>也可在CLI中操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt -t 40 --module-executors=<span class="string">'[splay, direct_call]'</span> --executor-opts=<span class="string">'&#123;splaytime: 30&#125;'</span> <span class="string">'*'</span> test.ping</span><br></pre></td></tr></table></figure>
<p>通过netapi调用的相同命令将如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -sSk https://localhost:8000 \</span><br><span class="line">    -H <span class="string">'Accept: application/x-yaml'</span> \</span><br><span class="line">    -H <span class="string">'X-Auth-Token: 697adbdc8fe971d09ae4c2a3add7248859c87079'</span> \</span><br><span class="line">    -H <span class="string">'Content-type: application/json'</span> \</span><br><span class="line">    -d <span class="string">'[&#123;</span></span><br><span class="line"><span class="string">        "client": "local",</span></span><br><span class="line"><span class="string">        "tgt": "*",</span></span><br><span class="line"><span class="string">        "fun": "test.ping",</span></span><br><span class="line"><span class="string">        "module_executors": ["splay", "direct_call"],</span></span><br><span class="line"><span class="string">        "executor_opts": &#123;"splaytime": 10&#125;</span></span><br><span class="line"><span class="string">        &#125;]'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="编写执行器"><a href="#编写执行器" class="headerlink" title="编写执行器"></a>编写执行器</h3><p>WRITING SALT EXECUTORS</p>
<p>Salt Executor 的编写方式与 Salt Execution Module 类似。执行器是一个 python 模块，放在 <code>executors</code> 文件夹中，包含带有如下签名的 <code>execute</code> 函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(opts, data, func, args, kwargs)</span></span></span><br></pre></td></tr></table></figure>
<p>参数:</p>
<ul>
<li><strong>opts</strong>: 包含minion配置选项的字典</li>
<li><strong>data</strong>: 包含载入数据(通过 CLI/API 传递给 <code>executor_opts</code> )的字典</li>
<li><strong>func, args, kwargs</strong>: 要执行的函数及其参数</li>
<li><strong>Returns</strong>: 如果必须使用下一个执行器继续执行序列，则为 <code>None</code></li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h1><p>CONFIGURATION MANAGEMENT</p>
<p>Salt包含一个强大而灵活的配置管理框架，该框架构建在远程执行核心之上。该框架在minions上执行，通过呈现特定于语言的状态文件，允许同时配置数万台主机。</p>
<p>Salt State 系统的核心是 SLS(SaLt State File)。SLS表示系统应处于的状态，并设置为以简单格式包含此数据。这通常称为配置管理(Configuration Management)。</p>
<p><br></p>
<p><strong>State:</strong></p>
<ul>
<li>Full list of states: <a href="https://docs.saltstack.com/en/latest/ref/states/all/index.html#all-salt-states" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/states/all/index.html#all-salt-states</a></li>
<li>Pillar System: <a href="https://docs.saltstack.com/en/latest/topics/pillar/index.html#pillar" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/pillar/index.html#pillar</a></li>
<li>Highstate data structure: <a href="https://docs.saltstack.com/en/latest/ref/states/highstate.html#states-highstate" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/states/highstate.html#states-highstate</a></li>
<li>Writing states: <a href="https://docs.saltstack.com/en/latest/ref/states/writing.html#state-modules" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/states/writing.html#state-modules</a></li>
</ul>
<p>Salt执行模块与状态模块不同，不能在SLS文件中作为状态调用。</p>
<p><br></p>
<p><strong>Renderers:</strong><br>渲染器使用以各种语言、模板引擎、文件编写的状态配置文件。Salt的配置管理系统与语言无关。</p>
<ul>
<li>Full list of renderers: <a href="https://docs.saltstack.com/en/latest/ref/renderers/all/index.html#all-salt-renderers" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/renderers/all/index.html#all-salt-renderers</a></li>
<li>Renderers: <a href="https://docs.saltstack.com/en/latest/ref/renderers/index.html#renderers" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/renderers/index.html#renderers</a></li>
</ul>
<p><br><br><br></p>
<h2 id="Salt-States"><a href="#Salt-States" class="headerlink" title="Salt States"></a>Salt States</h2><p>HOW DO I USE SALT STATES?</p>
<blockquote>
<p>注意:<br>这仅仅是使用State的开始，请确保阅读了Pillar</p>
</blockquote>
<p><strong>Salt State</strong> 系统的核心是 <strong>SLS</strong>(SaLt State File)。SLS表示系统应处于的状态，并设置为以简单格式包含此数据。这通常称为配置管理(Configuration Management)。</p>
<p><br></p>
<h3 id="一切都是数据"><a href="#一切都是数据" class="headerlink" title="一切都是数据"></a>一切都是数据</h3><p>IT IS ALL JUST DATA</p>
<p>在深入研究细节之前，有助于理解SLS文件只是一个数据结构。虽然理解SLS只是一种数据结构对于理解和利用Salt States并不重要，但它应该有助于增强对实际力量所在位置的了解。</p>
<p>因此，SLS文件实际上只是 <code>dictionaries, lists, strings, numbers</code> 。通过使用这种方法，Salt可以更加灵活。当一个人写了更多的状态文件时，它就会更清楚地写出正在编写的内容。随着管理员或开发人员的需求而增长。结果便是一个易于理解的系统。</p>
<p><br></p>
<h3 id="THE-TOP-FILE"><a href="#THE-TOP-FILE" class="headerlink" title="THE TOP FILE"></a>THE TOP FILE</h3><p>可以使用名为 <code>top.sls</code> 的文件将以下部分中的示例SLS文件分配给主机。</p>
<p><br></p>
<h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>大多数基础架构都是由一组机器组成，组中的每台机器都扮演着与其它机器相似的角色。这些机器组彼此协同工作以创建应用程序堆栈。<br>为了有效地管理这些机器组，管理员需要能够为这些组创建角色。</p>
<p>在Salt中，包含网络上的机器组之间的映射以及应该应用于它们的配置角色的文件 称为 <strong>顶级文件</strong> (<code>top file</code>)。</p>
<p>顶级文件(<code>top file</code>) 默认名为 <code>top.sls</code> ，之所以如此命名，是因为它们始终存在于包含状态文件的目录层次结构的顶部。该目录结构被称为 <strong>状态树</strong>(<code>state tree</code>)。</p>
<p><br><br><br></p>
<h4 id="栗子-2"><a href="#栗子-2" class="headerlink" title="栗子"></a>栗子</h4><p>顶级文件有三个部件:</p>
<ul>
<li><strong>Environment</strong>: 状态树目录，包含一组用于配置系统的状态文件</li>
<li><strong>Target</strong>: 一组机器，它们将应用一组状态</li>
<li><strong>State files</strong>: 应用于目标的状态文件列表。每个状态文件都描述了要在目标机器上配置和强制执行的一个或多个状态</li>
</ul>
<p>三个组件之间的关系:</p>
<ul>
<li>Environments contain targets</li>
<li>Targets contain states</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base:</span>          <span class="comment"># Apply SLS files from the directory root for the 'base' environment</span></span><br><span class="line">  <span class="string">'web*'</span><span class="string">:</span>      <span class="comment"># All minions with a minion_id that begins with 'web'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">apache</span>   <span class="comment"># Apply the state file named 'apache.sls'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="ENVIRONMENTS"><a href="#ENVIRONMENTS" class="headerlink" title="ENVIRONMENTS"></a>ENVIRONMENTS</h4><p>环境是包含顶级文件和一组状态文件的目录层次结构。<br>环境可以以多种方式使用，但是并不要求它们被使用。事实上，部署Salt的最常见方式是使用一个名为 <code>base</code> 的环境。如果用户具有专门调用多个版本状态树的用例时，才建议用户仅创建多个环境。</p>
<p><br><br><br></p>
<h4 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h4><p>GETTING STARTED WITH TOP FILES</p>
<p>每个环境都在名为 <code>file_roots</code> 的 salt master config 变量中定义。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在常见的单一环境中，只定义了一个base环境，并且只有一个目录路径用于状态文件</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对于base环境，所有minions都会将名为core.sls和edit.sls的状态文件应用于它们</span></span><br><span class="line"><span class="comment">#core.sls, edit.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">core</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">edit</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="多环境"><a href="#多环境" class="headerlink" title="多环境"></a>多环境</h4><p>MULTIPLE ENVIRONMENTS</p>
<p>在某些情况下，团队可能希望创建版本化状态树，这些树可用于在将状态部署到生产环境之前在隔离的系统集中测试Salt配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每个环境一个目录</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  dev:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/dev</span></span><br><span class="line"><span class="attr">  qa:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/qa</span></span><br><span class="line"><span class="attr">  prod:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br></pre></td></tr></table></figure>
<p>顶级文件引用这些环境:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dev:</span></span><br><span class="line">  <span class="string">'webserver*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver</span></span><br><span class="line">  <span class="string">'db*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">db</span></span><br><span class="line"><span class="attr">qa:</span></span><br><span class="line">  <span class="string">'webserver*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver</span></span><br><span class="line">  <span class="string">'db*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">db</span></span><br><span class="line"><span class="attr">prod:</span></span><br><span class="line">  <span class="string">'webserver*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver</span></span><br><span class="line">  <span class="string">'db*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">db</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="给目标选择一个环境"><a href="#给目标选择一个环境" class="headerlink" title="给目标选择一个环境"></a>给目标选择一个环境</h4><p>CHOOSING AN ENVIRONMENT TO TARGET</p>
<p>顶级文件用于将minion分配给环境，除非使用下面描述的方法覆盖。顶级文件中的环境必须与有效的文件服务器环境匹配，以便将任何状态应用于minion。当使用默认文件服务器后端时，环境在 <code>file_roots</code> 中定义。</p>
<p>可以使用 <code>state.show_top</code> 函数查看将在给定环境中应用于minion的状态。</p>
<p>通过在 minion config 中设置环境值(<code>environment</code>)，可以将Minions固定到特定环境。这样做时，minion将仅从其分配的环境中请求文件。</p>
<blockquote>
<p><strong>Note:</strong><br>Changed in version <code>2018.3.0</code>: Renamed from <code>environment</code> to <code>saltenv</code>.<br>If <code>environment</code> is used, <code>saltenv</code> will take its value. If both are used, <code>environment</code> will be ignored and <code>saltenv</code> will be used.</p>
</blockquote>
<p>也可在运行命令(<code>salt, salt-ssh, salt-call...</code>)时动态传递环境值，但也并不是所有函数都接收此参数。例如: <code>salt &#39;*&#39; state.highstate saltenv=prod</code></p>
<p><br><br><br></p>
<h4 id="高级的minion目标"><a href="#高级的minion目标" class="headerlink" title="高级的minion目标"></a>高级的minion目标</h4><p>ADVANCED MINION TARGETING</p>
<p>顶层文件中为目标表达式设置的可用匹配类型:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>glob</td>
<td>Full minion ID or glob expression to match multiple minions (e.g. <code>minion123</code> or <code>minion*</code>)</td>
</tr>
<tr>
<td>pcre</td>
<td>Perl-compatible regular expression (PCRE) matching a minion ID (e.g. <code>web[0-3].domain.com</code>)</td>
</tr>
<tr>
<td>grain</td>
<td>Match a grain, optionally using globbing (e.g. <code>kernel:Linux</code> or <code>kernel:*BSD</code>)</td>
</tr>
<tr>
<td>grain_pcre</td>
<td>Match a grain using PCRE (e.g. `kernel:(Free</td>
<td>Open)BSD`)</td>
</tr>
<tr>
<td>list</td>
<td>Comma-separated list of minions (e.g. <code>minion1,minion2,minion3</code>)</td>
</tr>
<tr>
<td>pillar</td>
<td>Pillar match, optionally using globbing (e.g. <code>role:webserver</code> or <code>role:web*</code>)</td>
</tr>
<tr>
<td>pillar_pcre</td>
<td>Pillar match using PCRE (e.g. `role:web(server</td>
<td>proxy)`</td>
</tr>
<tr>
<td>pillar_exact</td>
<td>Pillar match with no globbing or PCRE (e.g. <code>role:webserver</code>)</td>
</tr>
<tr>
<td>ipcidr</td>
<td>Subnet or IP address (e.g. <code>172.17.0.0/16</code> or <code>10.2.9.80</code>)</td>
</tr>
<tr>
<td>data</td>
<td>Match values kept in the minion’s datastore (created using the data execution module)</td>
</tr>
<tr>
<td>range</td>
<td>Range cluster</td>
</tr>
<tr>
<td>compound</td>
<td>Complex expression combining multiple match types</td>
</tr>
<tr>
<td>nodegroup</td>
<td>Pre-defined compound expressions in the master config file</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h4 id="如何编译顶级文件"><a href="#如何编译顶级文件" class="headerlink" title="如何编译顶级文件"></a>如何编译顶级文件</h4><p>HOW TOP FILES ARE COMPILED</p>
<p>当执行 <code>highstate</code> 并指定环境时，那么该环境的顶级文件是用于将状态分配给minions的唯一顶级文件，只有来自此环境的状态才会被运行。</p>
<p>如果没有指定环境，minion将在每个环境中查找顶级文件，并且将处理每个顶级文件以确定要在minions上运行的SLS文件。默认情况下，每个环境中的顶级文件将被合并在一起。<br>在具有多个环境的配置中，可能会导致意外结果。所以，你可能需要修改策略使得每个环境使用其自己的顶级文件，另一种选择是将 <code>state_top_saltenv</code> 设置为特定环境。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改合并策略</span></span><br><span class="line"><span class="attr">top_file_merging_strategy:</span> <span class="string">same</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改环境</span></span><br><span class="line"><span class="attr">state_top_saltenv:</span> <span class="string">base</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="顶级文件编译栗子"><a href="#顶级文件编译栗子" class="headerlink" title="顶级文件编译栗子"></a>顶级文件编译栗子</h4><p>TOP FILE COMPILATION EXAMPLES</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/etc/salt/master</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/base</span></span><br><span class="line"><span class="attr">  dev:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/dev</span></span><br><span class="line"><span class="attr">  qa:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/qa</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/salt/base/top.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base1</span></span><br><span class="line"><span class="attr">dev:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">dev1</span></span><br><span class="line"><span class="attr">qa:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">qa1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/salt/dev/top.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line"><span class="attr">  'minion1':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base2</span></span><br><span class="line"><span class="attr">dev:</span></span><br><span class="line"><span class="attr">  'minion2':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">dev2</span></span><br><span class="line"><span class="attr">qa:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">qa1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">qa2</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h3 id="YAML格式的SLS"><a href="#YAML格式的SLS" class="headerlink" title="YAML格式的SLS"></a>YAML格式的SLS</h3><p>DEFAULT DATA - YAML</p>
<p>默认情况下，Salt使用YAML格式来代表SLS文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 典型的YAML格式的SLS文件</span><br><span class="line"># 不同Linux发行版的包管理方式不一样</span><br><span class="line"># 此SLS文件将确保安装名为apache的程序包，并确保apache服务正在运行</span><br><span class="line"></span><br><span class="line">apache:</span><br><span class="line">  pkg.installed: []</span><br><span class="line">  service.running:</span><br><span class="line">    - require:</span><br><span class="line">      - pkg: apache</span><br><span class="line"></span><br><span class="line"># 第一行是一组数据的ID，称为ID声明。此ID设置需要操作的事物的名称。</span><br><span class="line"># 第二行和第三行包含要运行的状态模块函数，格式为: &lt;state_module&gt;.&lt;function&gt;</span><br><span class="line"># require为必要的声明(Requisite Statement)，确保在安装Apache包之后启动它</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="添加配置和用户"><a href="#添加配置和用户" class="headerlink" title="添加配置和用户"></a>添加配置和用户</h3><p>ADDING CONFIGS AND USERS</p>
<p>在设置Apache之类的服务时，可能需要添加更多组件。很可能会管理Apache配置文件，并且可能需要设置用户和组。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用必须的声明: watch，观察状态</span></span><br><span class="line"><span class="comment"># require确保安装Apache后创建组，创建组之后创建用户</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache:</span></span><br><span class="line">  <span class="string">pkg.installed:</span> <span class="string">[]</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">      - user:</span> <span class="string">apache</span></span><br><span class="line">  <span class="string">user.present:</span></span><br><span class="line"><span class="attr">    - uid:</span> <span class="number">87</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">87</span></span><br><span class="line"><span class="attr">    - home:</span> <span class="string">/var/www/html</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">/bin/nologin</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - group:</span> <span class="string">apache</span></span><br><span class="line">  <span class="string">group.present:</span></span><br><span class="line"><span class="attr">    - gid:</span> <span class="number">87</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/httpd/conf/httpd.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://apache/httpd.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="MOVING-BEYOND-A-SINGLE-SLS"><a href="#MOVING-BEYOND-A-SINGLE-SLS" class="headerlink" title="MOVING BEYOND A SINGLE SLS"></a>MOVING BEYOND A SINGLE SLS</h3><p>以可伸缩的方式设置Salt States时，需要使用多个SLS。</p>
<p>上面的示例位于单个SLS文件中，但可以组合两个或多个SLS文件来构建状态树。上面的SLS文件还引用了一个奇怪的source(<code>source: salt://apache/httpd.conf</code>)，此文件也需要提供。<br>SLS文件布局在Salt master的目录结构中，SLS是一个文件，要下载的文件也是一个文件。</p>
<p><strong>不要再SLS名字中使用点(<code>.</code>)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#salt file server</span><br><span class="line">apache/init.sls</span><br><span class="line">apache/httpd.conf</span><br></pre></td></tr></table></figure>
<p>但是，当使用多个单个SLS文件时，可以将更多组件添加到工具箱中。<br><code>include</code>语句包含其它的SLS文件，以便在其中找到的组件可以被 <code>required, watched, demonstrated - extended</code>。<code>include</code> 语句允许状态交叉链接。当SLS具有 <code>include</code> 语句时，它实际上扩展为包括所包含的SLS文件的内容。</p>
<p>考虑如下SSH示例:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh/init.sls</span></span><br><span class="line"><span class="attr">openssh-client:</span></span><br><span class="line">  <span class="string">pkg.installed</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/ssh/ssh_config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://ssh/ssh_config</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">openssh-client</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ssh/server.sls:</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ssh</span></span><br><span class="line"></span><br><span class="line"><span class="attr">openssh-server:</span></span><br><span class="line">  <span class="string">pkg.installed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sshd:</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">openssh-client</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">openssh-server</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/ssh/banner</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/ssh/sshd_config</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/ssh/sshd_config:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://ssh/sshd_config</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">openssh-server</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/ssh/banner:</span></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">managed</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://ssh/banner</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">openssh-server</span></span><br></pre></td></tr></table></figure>
<p>状态树看起来可能是下面这个样子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apache/init.sls</span><br><span class="line">apache/httpd.conf</span><br><span class="line">ssh/init.sls</span><br><span class="line">ssh/server.sls</span><br><span class="line">ssh/banner</span><br><span class="line">ssh/ssh_config</span><br><span class="line">ssh/sshd_config</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="EXTENDING"><a href="#EXTENDING" class="headerlink" title="EXTENDING"></a>EXTENDING</h3><p>EXTENDING INCLUDED SLS DATA</p>
<p>有时，需要扩展(<code>extend</code>) SLS。也许apache服务需要观察(<code>watch</code>)额外的资源，或者在某些情况下需要放置不同的文件。<br><code>extend</code> 语句不是必须的声明，它是附加的。</p>
<p>考虑如下栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ssh/custom-server.sls:</span></span><br><span class="line"><span class="comment">#使用extend语句覆盖下载的banner文件，而使用新的文件</span></span><br><span class="line"></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ssh.server</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extend:</span></span><br><span class="line">  <span class="string">/etc/ssh/banner:</span></span><br><span class="line"><span class="attr">    file:</span></span><br><span class="line"><span class="attr">      - source:</span> <span class="attr">salt://ssh/custom-banner</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python/mod_python.sls:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extend:</span></span><br><span class="line"><span class="attr">  apache:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      - watch:</span></span><br><span class="line"><span class="attr">        - pkg:</span> <span class="string">mod_python</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mod_python:</span></span><br><span class="line">  <span class="string">pkg.installed</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="渲染系统"><a href="#渲染系统" class="headerlink" title="渲染系统"></a>渲染系统</h3><p>UNDERSTANDING THE RENDER SYSTEM</p>
<p>由于SLS数据只是简单的数据，因此不需要用YAML表示。 Salt默认为YAML，因为它非常简单易学，易于使用。但是，只要提供了渲染器模块，就可以从几乎任何可以想象的介质渲染SLS文件。</p>
<p>默认渲染系统是 <code>yaml_jinja</code> 渲染器，此渲染器首先通过Jinja2模板系统传递模板，然后通过YAML解析器。这样做的好处是在创建SLS文件时可以使用完整的编程结构。<br>其它可用的渲染器有 <code>yaml_mako</code> 和 <code>yaml_wempy</code>，纯Python的<code>pydsl</code>, <code>pyobjects</code> 渲染器。</p>
<p><br><br><br></p>
<h3 id="DEBUG-SALT-STATES"><a href="#DEBUG-SALT-STATES" class="headerlink" title="DEBUG SALT STATES"></a>DEBUG SALT STATES</h3><p>RUNNING AND DEBUGGING SALT STATES</p>
<p>一旦SLS中的规则准备就绪，就应对其进行测试以确保它们正常工作。使用<code>salt &#39;*&#39; state.apply</code>命令调用这些规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#minion</span><br><span class="line">#这有助于解决问题</span><br><span class="line"></span><br><span class="line">salt-call state.apply -l debug</span><br><span class="line"></span><br><span class="line">salt-minion -l debug</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="STATES-TUTORIAL"><a href="#STATES-TUTORIAL" class="headerlink" title="STATES TUTORIAL"></a>STATES TUTORIAL</h2><p>本节的目的是演示如何快速配置由Salt States管理的系统。</p>
<p><br></p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p>BASIC USAGE</p>
<p>本节将引导您使用Salt配置minion以运行 Apache HTTP Server 并确保服务器正在运行。</p>
<p>我的Salt Minions有两个跑在Docker里:</p>
<ul>
<li>centos</li>
<li>ubuntu</li>
</ul>
<p><code>apache</code> 在 <code>ubuntu</code> 中包名为 <code>apache2</code>， 在 <code>centos</code> 下包名为 <code>httpd</code>。下面的SLS文件中，可能我并没有修改，但我在测试的时候是修改了的，请大家注意。</p>
<p><br></p>
<h4 id="配置状态树"><a href="#配置状态树" class="headerlink" title="配置状态树"></a>配置状态树</h4><p>SETTING UP THE SALT STATE TREE</p>
<p>States 是存储在 Master 的文本文件中，并通过 Master FileServer 按需发送给 Minions。状态文件的集合构成了 <strong>状态树(state tree)</strong> 。</p>
<p>要在Salt中开始使用中央状态系统，必须首先设置Salt 文件服务器。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑 master config，并取消 file_roots 的注释</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改之后重启master</span></span><br><span class="line">systemctl restart salt-master</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="准备顶级文件"><a href="#准备顶级文件" class="headerlink" title="准备顶级文件"></a>准备顶级文件</h4><p>PREPARING THE TOP FILE</p>
<p>在Master上的<code>file_roots</code>目录(<code>/srv/salt</code>)下创建顶级文件(<code>top.sls</code>)。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/top.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#env: base</span></span><br><span class="line"><span class="comment">#target: '*'</span></span><br><span class="line"><span class="comment">#state file: webserver.sls</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="创建sls文件"><a href="#创建sls文件" class="headerlink" title="创建sls文件"></a>创建sls文件</h4><p>CREATE AN SLS FILE</p>
<p>在顶级文件相同的目录下，创建sls文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/salt/webserver.sls</span></span><br><span class="line"><span class="comment">#ubuntu下叫apache2, Fedora下叫httpd</span></span><br><span class="line"><span class="attr">apache2:</span>                 <span class="comment"># ID declaration，定义要安装的包名称</span></span><br><span class="line"><span class="attr">  pkg:</span>                  <span class="comment"># state declaration，定义要使用的Salt State</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">installed</span>         <span class="comment"># function declaration，声明要调用的函数</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h4><p>INSTALL THE PACKAGE</p>
<p>在Master上执行命令，完成之后，Minion将报告所有采取的行动和所做的所有更改的摘要。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#salt '*' state.apply</span></span><br><span class="line">salt <span class="string">'ubuntu'</span> state.apply</span><br><span class="line"></span><br><span class="line"><span class="comment"># salt 'ubuntu' state.apply -l debug</span></span><br><span class="line"><span class="comment"># salt 'ubuntu' state.apply -t 60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#之后便可看到状态</span></span><br><span class="line">------------</span><br><span class="line">Succeeded: 1 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>SLS File Namespace</strong></p>
<p>注意上面的栗子，SLS文件 <code>webserver.sls</code> 简称为 <code>webserver</code>。在 <code>top.sls</code> 或 <code>include</code> 声明中引用时，SLS文件的命名空间遵循一些简单的规则:</p>
<ul>
<li><code>.sls</code> 被丢弃了(如 <code>webserver.sls</code> 变为 <code>webserver</code>)</li>
<li>子目录可用于更好的组织<ul>
<li>每个子目录在Salt状态和命令行中用点(<code>.</code>, 遵循 python import 模型）表示。如文件系统中的 <code>webserver/dev.sls</code> 在Salt中称为 <code>webserver.dev</code></li>
<li>所以，不要在状态文件名中使用点(<code>.</code>)，否则便无法匹配</li>
</ul>
</li>
<li>子目录中名为 <code>init.sls</code> 的文件指由目录路径引用。如 <code>webserver/init.sls</code> 指的是 <code>webserver</code></li>
<li>如果 <code>webserver.sls</code> 和 <code>webserver/init.sls</code> 都存在，那么 <code>webserver/init.sls</code> 会被忽略，<code>webserver.sls</code> 将指的是 <code>webserver</code></li>
</ul>
<p><br><br><br></p>
<h4 id="ubuntu和centos两台minion"><a href="#ubuntu和centos两台minion" class="headerlink" title="ubuntu和centos两台minion"></a>ubuntu和centos两台minion</h4><p>前面我只用了Ubuntu，现在我加一台Centos，现在便有两台Minion。则现在就需要修改状态文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/salt/top.sls</span></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line"><span class="attr">  'ubuntu':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver-ubuntu</span></span><br><span class="line"><span class="attr">  'centos':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver-centos</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#/srv/salt/webserver-ubuntu.sls</span></span><br><span class="line"><span class="attr">apache2:</span>                 <span class="comment"># ID declaration</span></span><br><span class="line"><span class="attr">  pkg:</span>                  <span class="comment"># state declaration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">installed</span>         <span class="comment"># function declaration</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#/srv/salt/webserver-centos.sls</span></span><br><span class="line"><span class="attr">httpd:</span>                 <span class="comment"># ID declaration</span></span><br><span class="line"><span class="attr">  pkg:</span>                  <span class="comment"># state declaration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">installed</span>         <span class="comment"># function declaration</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#执行</span><br><span class="line"># salt &apos;centos&apos; state.apply</span><br><span class="line"># salt &apos;ubuntu&apos; state.apply</span><br><span class="line"># salt &apos;*&apos; state.apply -l debug</span><br><span class="line">salt &apos;*&apos; state.apply</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="复杂的状态和要求"><a href="#复杂的状态和要求" class="headerlink" title="复杂的状态和要求"></a>复杂的状态和要求</h3><p>MORE COMPLEX STATES, REQUISITES</p>
<p>前面介绍了安装软件包的基础知识。现在将修改我们的 <code>webserver.sls</code> 文件以满足要求，并使用更多的Salt State。</p>
<p><br></p>
<h4 id="调用多个状态"><a href="#调用多个状态" class="headerlink" title="调用多个状态"></a>调用多个状态</h4><p>CALL MULTIPLE STATES</p>
<p>你可以在ID声明下指定多个状态声明。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#webserver.sls</span></span><br><span class="line"><span class="comment">#注意Ubuntu下和Centos下的包名不同，请记得修改</span></span><br><span class="line"><span class="comment">#如果apache没有运行，则启动它</span></span><br><span class="line"><span class="attr">apache:</span></span><br><span class="line">  <span class="string">pkg.installed:</span> <span class="string">[]</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#尝试在执行state.apply之前停止apache</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="要求其它状态"><a href="#要求其它状态" class="headerlink" title="要求其它状态"></a>要求其它状态</h4><p>REQUIRE OTHER STATES</p>
<p>现在Apache已经跑起来了，我们需要添加一些HTML文件来定制网站。但我们不希望在Salt安装和运行Apache之前添加HTML文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/salt/webserver/init.sls</span></span><br><span class="line"><span class="comment">#注意，根据前面的规则，webserver.sls还存在的话会忽略 webserver/init.sls，所以需要注释它，之后才会生效</span></span><br><span class="line"><span class="attr">apache:</span></span><br><span class="line">  <span class="string">pkg.installed:</span> <span class="string">[]</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="string">/var/www/index.html:</span>                        <span class="comment"># ID declaration，此栗中为自定义的HTML文件位置</span></span><br><span class="line"><span class="attr">  file:</span>                                     <span class="comment"># state declaration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">managed</span>                               <span class="comment"># function</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://webserver/index.html</span>   <span class="comment"># function arg</span></span><br><span class="line"><span class="attr">    - require:</span>                              <span class="comment"># requisite declaration</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache</span>                         <span class="comment"># requisite reference</span></span><br></pre></td></tr></table></figure>
<p><code>/srv/salt/webserver/index.html</code> 文件内容:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Salt rocks<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This file brought to you by Salt<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行</span></span><br><span class="line">salt <span class="string">'*'</span> state.apply</span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">Succeeded: 3 (changed=1)</span><br><span class="line">Failed:    0</span><br><span class="line">------------</span><br><span class="line">Total states</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#之后可在minion上进行验证，我测试是没有问题</span></span><br><span class="line"><span class="comment">#只不过apache的Web目录为 /var/www/html</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong><code>require</code> vs <code>watch</code></strong></p>
<p>有两个非必要的声明:</p>
<ul>
<li><code>require</code></li>
<li><code>watch</code></li>
</ul>
<p>并非每个state都支持 <code>watch</code> ，<code>service state</code> 支持 <code>watch</code> 并且将根据监控的情况重启服务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/httpd/extra/httpd-vhosts.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://webserver/httpd-vhosts.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apache:</span></span><br><span class="line">  <span class="string">pkg.installed:</span> <span class="string">[]</span></span><br><span class="line">  <span class="string">service.running:</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/httpd/extra/httpd-vhosts.conf</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="模板、包含、扩展"><a href="#模板、包含、扩展" class="headerlink" title="模板、包含、扩展"></a>模板、包含、扩展</h3><p>TEMPLATING, INCLUDES, EXTENDS</p>
<p>本节将介绍sls文件的更高级模板和配置技术。</p>
<p><br></p>
<h4 id="SLS模块模板"><a href="#SLS模块模板" class="headerlink" title="SLS模块模板"></a>SLS模块模板</h4><p>TEMPLATING SLS MODULES</p>
<p>SLS模块可能需要编程逻辑或内联执行，这通过模块模板实现。默认使用的模块模板系统是Jinja2，可修改 master config 里的 <code>renderer</code> 来更改它。</p>
<p>所有状态在初始化读取时都通过模板系统，要使用模板系统，只需添加一些模板标记即可。</p>
<p>带模板标记的sls模块的栗子如下:</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> usr <span class="keyword">in</span> ['moe','larry','curly'] %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; usr &#125;&#125;</span><span class="xml">:</span></span><br><span class="line"><span class="xml">  user.present</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>这个模板化的sls文件一旦生成将如下所示:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">moe:</span></span><br><span class="line">  <span class="string">user.present</span></span><br><span class="line"><span class="attr">larry:</span></span><br><span class="line">  <span class="string">user.present</span></span><br><span class="line"><span class="attr">curly:</span></span><br><span class="line">  <span class="string">user.present</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="在SLS模块中使用GRAINS"><a href="#在SLS模块中使用GRAINS" class="headerlink" title="在SLS模块中使用GRAINS"></a>在SLS模块中使用GRAINS</h4><p>USING GRAINS IN SLS MODULES</p>
<p>通常，需要对不同的系统应用不同的状态。Salt Grains 在模板上下文中可用。Grains可在SLS模板中使用:</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">apache:</span></span><br><span class="line"><span class="xml">  pkg.installed:</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> grains['os'] == 'RedHat' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    - name: httpd</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">elif</span></span> grains['os'] == 'Ubuntu' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    - name: apache2</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="在SLS模板中使用环境变量"><a href="#在SLS模板中使用环境变量" class="headerlink" title="在SLS模板中使用环境变量"></a>在SLS模板中使用环境变量</h4><p>USING ENVIRONMENT VARIABLES IN SLS MODULES</p>
<p>你可使用 <code>salt[&#39;environ.get&#39;](&#39;VARNAME&#39;)</code> 在Salt State 中使用环境变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MYENVVAR=<span class="string">"world"</span> salt-call state.template test.sls</span><br></pre></td></tr></table></figure>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">Create a file with contents from an environment variable:</span></span><br><span class="line"><span class="xml">  file.managed:</span></span><br><span class="line"><span class="xml">    - name: /tmp/hello</span></span><br><span class="line"><span class="xml">    - contents: </span><span class="template-variable">&#123;&#123; salt['environ.get']('MYENVVAR') &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>错误检查:</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">set</span> myenvvar = salt['environ.get']('MYENVVAR') %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> myenvvar %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">Create a file with contents from an environment variable:</span></span><br><span class="line"><span class="xml">  file.managed:</span></span><br><span class="line"><span class="xml">    - name: /tmp/hello</span></span><br><span class="line"><span class="xml">    - contents: </span><span class="template-variable">&#123;&#123; salt['environ.get']('MYENVVAR') &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">Fail - no environment passed in:</span></span><br><span class="line"><span class="xml">  test.fail_without_changes</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="从模板调用模块"><a href="#从模板调用模块" class="headerlink" title="从模板调用模块"></a>从模板调用模块</h4><p>CALLING SALT MODULES FROM TEMPLATES</p>
<p>由minion加载的所有Salt模块都可在模板系统中使用。这允许在目标系统上实时收集数据。它还允许从sls模块中轻松运行shell命令。</p>
<p>Salt模块函数也可以在模板上下文中以salt形式提供，考虑如下栗子:</p>
<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">moe:</span></span><br><span class="line"><span class="xml">  user.present:</span></span><br><span class="line"><span class="xml">    - gid: </span><span class="template-variable">&#123;&#123; salt['file.group_to_gid']('some_group_that_exists') &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> salt.modules.file</span><br><span class="line">file.group_to_gid(<span class="string">'some_group_that_exists'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">salt[<span class="string">'network.hw_addr'</span>](<span class="string">'eth0'</span>)</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="SLS模块高级语法"><a href="#SLS模块高级语法" class="headerlink" title="SLS模块高级语法"></a>SLS模块高级语法</h4><p>ADVANCED SLS MODULE SYNTAX</p>
<p>最后，我们将介绍一些非常有用的技术，用于更复杂的状态树。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># INCLUDE DECLARATION</span></span><br><span class="line"><span class="comment"># 使用 include 声明跨越多个文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#python/python-libs.sls:</span></span><br><span class="line"><span class="attr">python-dateutil:</span></span><br><span class="line">  <span class="string">pkg.installed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#python/django.sls:</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">python.python-libs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">django:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">python-dateutil</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># EXTEND DECLARATION</span></span><br><span class="line"><span class="comment"># 您可以使用 extend 声明修改以前的声明</span></span><br><span class="line"><span class="comment"># extend 与 require, watch 的工作方式不同，它附加，而不是替换必须的组件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#apache/apache.sls:</span></span><br><span class="line"><span class="attr">apache:</span></span><br><span class="line">  <span class="string">pkg.installed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#apache/mywebsite.sls:</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">apache.apache</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extend:</span></span><br><span class="line"><span class="attr">  apache:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">running</span></span><br><span class="line"><span class="attr">      - watch:</span></span><br><span class="line"><span class="attr">        - file:</span> <span class="string">/etc/httpd/extra/httpd-vhosts.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/httpd/extra/httpd-vhosts.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://apache/httpd-vhosts.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NAME DECLARATION</span></span><br><span class="line"><span class="comment"># 您可以使用Name声明覆盖ID声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#apache/mywebsite.sls:</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">apache.apache</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extend:</span></span><br><span class="line"><span class="attr">  apache:</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">running</span></span><br><span class="line"><span class="attr">      - watch:</span></span><br><span class="line"><span class="attr">        - file:</span> <span class="string">mywebsite</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mywebsite:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/httpd/extra/httpd-vhosts.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://apache/httpd-vhosts.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NAMES DECLARATION</span></span><br><span class="line"><span class="comment"># 更强大的是使用Names声明一次覆盖多个状态的ID声明。这通常可以消除模板中循环的需要</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stooges:</span></span><br><span class="line">  <span class="string">user.present:</span></span><br><span class="line"><span class="attr">    - names:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">moe</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">larry</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">curly</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="状态工作流"><a href="#状态工作流" class="headerlink" title="状态工作流"></a>状态工作流</h3><p>本节将展示如何使用salt的 <code>file_roots</code> 来设置工作流。在该工作流中，状态可以从 dev, 到 QA, 到 Prod 。</p>
<p><br></p>
<h4 id="Salt文件服务器路径继承"><a href="#Salt文件服务器路径继承" class="headerlink" title="Salt文件服务器路径继承"></a>Salt文件服务器路径继承</h4><p>SALT FILESERVER PATH INHERITANCE</p>
<blockquote>
<p>注意:<br>使用多个文件服务器后端时，它们在 master config 中的 <code>fileserver_backend</code> 参数中列出的顺序也很重要</p>
</blockquote>
<p>Salt FileServer 允许每个环境有多个根目录。Salt FileServer 将根目录列表折叠到包含每个根的所有文件的单个虚拟环境中。<br>如果同一文件存在于多个根目录中的相同相对路径中，则最顶级匹配成功。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># In the master config file (/etc/salt/master)</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/mnt/salt-nfs/base</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#如以下两者都存在</span><br><span class="line">/srv/salt/foo.txt</span><br><span class="line">/mnt/salt-nfs/base/foo.txt</span><br><span class="line"></span><br><span class="line">#则 salt://foo.txt 将指向 /srv/salt/foo.txt</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><p>ENVIRONMENT CONFIGURATION</p>
<p>配置多个环境:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">file_roots:</span></span><br><span class="line"><span class="attr">  base:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br><span class="line"><span class="attr">  qa:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/qa</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br><span class="line"><span class="attr">  dev:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/dev</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/qa</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/salt/prod</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="栗子-3"><a href="#栗子-3" class="headerlink" title="栗子"></a>栗子</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/srv/salt/prod/top.sls:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'web*prod*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver.foobarcom</span></span><br><span class="line"><span class="attr">qa:</span></span><br><span class="line">  <span class="string">'web*qa*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver.foobarcom</span></span><br><span class="line"><span class="attr">dev:</span></span><br><span class="line">  <span class="string">'web*dev*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">webserver.foobarcom</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="状态系统参考"><a href="#状态系统参考" class="headerlink" title="状态系统参考"></a>状态系统参考</h3><p>STATE SYSTEM REFERENCE</p>
<p>url: <a href="https://docs.saltstack.com/en/latest/ref/states/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/states/index.html</a></p>
<p>Salt提供了一个接口来管理Salt minions的配置或状态，此接口是一个功能完备的机制，用于从中央管理器强制执行系统状态。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="实用程序模块"><a href="#实用程序模块" class="headerlink" title="实用程序模块"></a>实用程序模块</h1><p>UTILITY MODULES - CODE REUSE IN CUSTOM MODULES</p>
<p>当通过编写自定义(state module, execution module) 来扩展Salt时，有时需要一种功能不仅仅适用于一种自定义模块。对于这些情况，Salt支持所谓的 <strong>实用程序模块(Utility Module)</strong>。这些模块与普通执行模块类似，但不是使用 <code>__salt__</code> 在Salt代码中调用，而是使用 <code>__utils__</code> 前缀。</p>
<p><br></p>
<p>例如，假设有以下简单实用程序模块 <code>salt://_utils/foo.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">My utils module</span></span><br><span class="line"><span class="string">---------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This module contains common functions for use in my other custom types.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'baz'</span></span><br></pre></td></tr></table></figure>
<p>一旦同步到一个minion，这个函数将可用于其他自定义Salt类型，如下所示:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">My awesome execution module</span></span><br><span class="line"><span class="string">---------------------------</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">observe_the_awesomeness</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Prints information from my utility module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CLI Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. code-block:: bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        salt '*' mymodule.observe_the_awesomeness</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> __utils__[<span class="string">'foo.bar'</span>]()</span><br></pre></td></tr></table></figure>
<p>与任何其它类型的Salt扩展一样，实用程序模块支持使用 <code>__virtual__</code> 函数有条件地加载它们，或者在不同的命名空间下加载它们。例如，在 <code>salt://_utils/</code> 下有一个实用程序模块。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">My utils module</span></span><br><span class="line"><span class="string">---------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This module contains common functions for use in my other custom types.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__virtual__</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Load as a different name</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'foo'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'baz'</span></span><br></pre></td></tr></table></figure>
<p>您甚至可以以面向对象的方式编写实用程序模块:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">My OOP-style utils module</span></span><br><span class="line"><span class="string">-------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This module contains common functions for use in my other custom types.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'baz'</span></span><br></pre></td></tr></table></figure>
<p>将它们导入其它自定义模块:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">My awesome execution module</span></span><br><span class="line"><span class="string">---------------------------</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mymodule</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">observe_the_awesomeness</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Prints information from my utility module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CLI Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. code-block:: bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        salt '*' mymodule.observe_the_awesomeness</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    foo = mymodule.Foo()</span><br><span class="line">    <span class="keyword">return</span> foo.bar()</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>当然，这些都是人为的例子，但它们应该用来展示通过编写实用程序模块开辟的一些可能性。请记住，虽然状态仍然可以访问所有执行模块，因此没有必要编写实用程序模块来使函数可用于状态和执行模块。实用程序模块的一个很好的用例是需要从自定义 输出器/返回器(outputter/returner) 以及执行模块调用相同功能的用例。</p>
<p>放置在 <code>salt://_utils/</code> 中的实用程序模块将在运行 HighStage 时以及在调用以下任何Salt函数时同步到minions:</p>
<ul>
<li><code>saltutil.sync_utils</code></li>
<li><code>saltutil.sync_all</code></li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="事件和反应器"><a href="#事件和反应器" class="headerlink" title="事件和反应器"></a>事件和反应器</h1><p>EVENTS and REACTOR</p>
<p><br></p>
<h2 id="事件系统"><a href="#事件系统" class="headerlink" title="事件系统"></a>事件系统</h2><p>Event System</p>
<p><strong>Salt Event System(事件系统)</strong> 用于触发事件，使第三方应用程序或外部进程能够对Salt内的行为做出反应。事件系统使用 发布-订阅模式(publish-subscribe)。</p>
<p><br><br><br></p>
<h3 id="事件总线"><a href="#事件总线" class="headerlink" title="事件总线"></a>事件总线</h3><p>EVENT BUS</p>
<p>事件系统由两个主要组件组成，它们构成了事件总线的概念:</p>
<ul>
<li><strong>Event Socket</strong>, 用于发布事件</li>
<li><strong>Event Library</strong>, 可以监听事件并将事件发送到salt系统</li>
</ul>
<p>事件发布到事件总线上，事件总线订阅者监听已发布的事件。<br>事件总线用于进程间通信(IPC)以及Salt中的网络传输。通过 UNIX Domain Sockets 提供进程间通信。</p>
<p>Salt Master 和 每个Salt Minion 都有自己的 Event Bus。</p>
<p><br><br><br></p>
<h3 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h3><p>EVENT TYPES</p>
<p><br></p>
<h4 id="SALT-MASTER-EVENTS"><a href="#SALT-MASTER-EVENTS" class="headerlink" title="SALT MASTER EVENTS"></a>SALT MASTER EVENTS</h4><p>这些事件是在Salt Master Event Bus 上发生的。</p>
<p>Salt Master Events:</p>
<ul>
<li>Authentication events</li>
<li>Start events</li>
<li>Key events</li>
<li>Job events</li>
<li>Runner Events</li>
<li>Presence Events</li>
<li>Cloud Events</li>
</ul>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">#AUTHENTICATION EVENTS</span><br><span class="line"></span><br><span class="line">#salt/auth</span><br><span class="line">#Fired when a minion performs an authentication check with the master.</span><br><span class="line">Variables:</span><br><span class="line">  id -- The minion ID.</span><br><span class="line">  act -- The current status of the minion key: accept, pend, reject.</span><br><span class="line">  pub -- The minion public key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#START EVENTS</span><br><span class="line">#salt/minion/&lt;MID&gt;/start</span><br><span class="line">#Fired every time a minion connects to the Salt master.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  id -- The minion ID.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#KEY EVENTS</span><br><span class="line"></span><br><span class="line">#salt/key</span><br><span class="line">#Fired when accepting and rejecting minions keys on the Salt master. These happen as a result of actions undertaken by the salt-key command.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  id -- The minion ID.</span><br><span class="line">  act -- The new status of the minion key: accept, delete,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># JOB EVENTS</span><br><span class="line"></span><br><span class="line"># salt/job/&lt;JID&gt;/new</span><br><span class="line"># Fired as a new job is sent out to minions.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  jid -- The job ID.</span><br><span class="line">  tgt -- The target of the job: *, a minion ID, G@os_family:RedHat, etc.</span><br><span class="line">  tgt_type -- The type of targeting used: glob, grain, compound, etc.</span><br><span class="line">  fun -- The function to run on minions: test.ping, network.interfaces, etc.</span><br><span class="line">  arg -- A list of arguments to pass to the function that will be called.</span><br><span class="line">  minions -- A list of minion IDs that Salt expects will return data for this job.</span><br><span class="line">  user -- The name of the user that ran the command as defined in Salt&apos;s Publisher ACL or external auth.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># salt/job/&lt;JID&gt;/ret/&lt;MID&gt;</span><br><span class="line"># Fired each time a minion returns data for a job.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  id -- The minion ID.</span><br><span class="line">  jid -- The job ID.</span><br><span class="line">  retcode -- The return code for the job.</span><br><span class="line">  fun -- The function the minion ran. E.g., test.ping.</span><br><span class="line">  return -- The data returned from the execution module.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># salt/job/&lt;JID&gt;/prog/&lt;MID&gt;/&lt;RUN NUM&gt;</span><br><span class="line"># Fired each time a each function in a state run completes execution. Must be enabled using the state_events option.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  data -- The data returned from the state module function.</span><br><span class="line">  id -- The minion ID.</span><br><span class="line">  jid -- The job ID.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># RUNNER EVENTS</span><br><span class="line"></span><br><span class="line"># salt/run/&lt;JID&gt;/new</span><br><span class="line"># Fired as a runner begins execution</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  jid -- The job ID.</span><br><span class="line">  fun -- The name of the runner function, with runner. prepended to it (e.g. runner.jobs.lookup_jid)</span><br><span class="line">  fun_args -- The arguments passed to the runner function (e.g. [&apos;20160829225914848058&apos;])</span><br><span class="line">  user -- The user who executed the runner (e.g. root)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># salt/run/&lt;JID&gt;/ret</span><br><span class="line"># Fired when a runner function returns</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  jid -- The job ID.</span><br><span class="line">  fun -- The name of the runner function, with runner. prepended to it (e.g. runner.jobs.lookup_jid)</span><br><span class="line">  fun_args -- The arguments passed to the runner function (e.g. [&apos;20160829225914848058&apos;])</span><br><span class="line">  return -- The data returned by the runner function</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># salt/run/&lt;JID&gt;/args</span><br><span class="line"># New in version 2016.11.0.</span><br><span class="line"># Fired by the state.orchestrate runner</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  name -- The ID declaration for the orchestration job (i.e. the line above salt.state, salt.function, salt.runner, etc.)</span><br><span class="line">  type -- The type of orchestration job being run (e.g. state)</span><br><span class="line">  tgt -- The target expression (e.g. *). Included for state and function types only.</span><br><span class="line">  args -- The args passed to the orchestration job. Note: for state and function types, also includes a tgt_type value which shows what kind of match (glob, pcre, etc.) was used. This value was named expr_form in the 2016.11 release cycle but has been renamed to tgt_type in 2017.7.0 for consistency with other events.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># PRESENCE EVENTS</span><br><span class="line"></span><br><span class="line"># salt/presence/present</span><br><span class="line"># Events fired on a regular interval about currently connected, newly connected, or recently disconnected minions. Requires the presence_events setting to be enabled.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  present -- A list of minions that are currently connected to the Salt master.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># salt/presence/change</span><br><span class="line"># Fired when the Presence system detects new minions connect or disconnect.</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">  new -- A list of minions that have connected since the last presence event.</span><br><span class="line">  lost -- A list of minions that have disconnected since the last presence event.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># CLOUD EVENTS</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="监听事件"><a href="#监听事件" class="headerlink" title="监听事件"></a>监听事件</h3><p>LISTENING FOR EVENTS</p>
<p>Salt事件系统在Salt中大量使用，它也被编写为与现有工具和脚本大量集成。<br>有多种方法可以消费它:</p>
<ul>
<li>CLI</li>
<li>REST API</li>
<li>Python</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"># FROM THE CLI</span><br><span class="line"># 查看事件总线的最快方法是调用 state.event runner</span><br><span class="line"># 此Runner旨在通过外部工具和shell脚本与事件总线进行交互</span><br><span class="line">salt-run state.event pretty=True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># REMOTELY VIA THE REST API</span><br><span class="line"># Salt事件总线可使用 salt.netapi.rest_cherrypy.app.Events 作为来自外部工具或服务的 HTTP stream</span><br><span class="line">curl -SsNk https://salt-api.example.com:8000/events?token=05A3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># FROM PYTHON</span><br><span class="line"># Python脚本只能作为运行Salt的同一系统用户访问事件总线</span><br><span class="line"># 要监听事件，需要创建SaltEvent对象，然后需要运行 get_event 函数。它的默认轮询时间分配为5秒，可使用 wait 选项更改</span><br><span class="line"># SaltEvent对象需要知道 Salt Unix Socket 的保存位置，它在配置文件的 sock_dir 选项中配置，默认为 /var/run/salt/master</span><br><span class="line"></span><br><span class="line"># 如下代码将检查单一事件</span><br><span class="line">import salt.config</span><br><span class="line">import salt.utils.event</span><br><span class="line"></span><br><span class="line">opts = salt.config.client_config(&apos;/etc/salt/master&apos;)</span><br><span class="line"></span><br><span class="line">event = salt.utils.event.get_event(</span><br><span class="line">        &apos;master&apos;,</span><br><span class="line">        sock_dir=opts[&apos;sock_dir&apos;],</span><br><span class="line">        transport=opts[&apos;transport&apos;],</span><br><span class="line">        opts=opts)</span><br><span class="line"></span><br><span class="line">data = event.get_event()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 事件也将使用标签(tag)，标签允许通过前缀过滤事件。默认情况下，将返回所有事件。如果只需要认证标签，则只需要传递 salt/auth 标签。</span><br><span class="line"># 栗子</span><br><span class="line">data = event.get_event(wait=10, tag=&apos;salt/auth&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检索标记以及事件数据，请传递 full=True</span><br><span class="line">evdata = event.get_event(wait=10, tag=&apos;salt/job&apos;, full=True)</span><br><span class="line">tag, data = evdata[&apos;tag&apos;], evdata[&apos;data&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 事件标签是可以全局的，如可在Reactor中使用fnmatch库</span><br><span class="line">import fnmatch</span><br><span class="line"></span><br><span class="line">import salt.config</span><br><span class="line">import salt.utils.event</span><br><span class="line"></span><br><span class="line">opts = salt.config.client_config(&apos;/etc/salt/master&apos;)</span><br><span class="line"></span><br><span class="line">sevent = salt.utils.event.get_event(</span><br><span class="line">        &apos;master&apos;,</span><br><span class="line">        sock_dir=opts[&apos;sock_dir&apos;],</span><br><span class="line">        transport=opts[&apos;transport&apos;],</span><br><span class="line">        opts=opts)</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    ret = sevent.get_event(full=True)</span><br><span class="line">    if ret is None:</span><br><span class="line">        continue</span><br><span class="line"></span><br><span class="line">    if fnmatch.fnmatch(ret[&apos;tag&apos;], &apos;salt/job/*/ret/*&apos;):</span><br><span class="line">        do_something_with_job_return(ret[&apos;data&apos;])</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="引发事件"><a href="#引发事件" class="headerlink" title="引发事件"></a>引发事件</h3><p>FIRING EVENTS</p>
<p>可以在Minion的本地总线上引发事件或引发用于Master的事件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 要在命令行上从Minion引发本地事件，请调用 event.fire 执行函数</span><br><span class="line">salt-call event.fire &apos;&#123;&quot;data&quot;: &quot;message to be sent in the event&quot;&#125;&apos; &apos;tag&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 要从Minion发送一个要发送给Master的事件，请调用 event.send 执行函数。记住YAML可以在函数参数的CLI中使用</span><br><span class="line">salt-call event.send &apos;myco/mytag/success&apos; &apos;&#123;success: True, message: &quot;It works!&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 如果一个进程正在监听Minion，那么Master上的用户可以向它发出一个事件</span><br><span class="line"># Job on minion</span><br><span class="line">import salt.utils.event</span><br><span class="line"></span><br><span class="line">event = salt.utils.event.MinionEvent(**__opts__)</span><br><span class="line"></span><br><span class="line">for evdata in event.iter_events(tag=&apos;customtag/&apos;):</span><br><span class="line">    return evdata # do your processing here...</span><br><span class="line"></span><br><span class="line"># Bash</span><br><span class="line">salt minionname event.fire &apos;&#123;&quot;data&quot;: &quot;message for the minion&quot;&#125;&apos; &apos;customtag/african/unladen&apos;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="从Python引发事件"><a href="#从Python引发事件" class="headerlink" title="从Python引发事件"></a>从Python引发事件</h3><p>FIRING EVENTS FROM PYTHON</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FROM SALT EXECUTION MODULES</span></span><br><span class="line"><span class="comment"># 在编写执行模块时，事件非常有用，以便在发生特定任务时通知Master上的各个进程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /srv/salt/_modules/my_custom_module.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Do something and fire an event to the master when finished</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CLI Example::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        salt '*' my_custom_module:do_something</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># do something!</span></span><br><span class="line">    __salt__[<span class="string">'event.send'</span>](<span class="string">'myco/my_custom_module/finished'</span>, &#123;</span><br><span class="line">        <span class="string">'finished'</span>: <span class="keyword">True</span>,</span><br><span class="line">        <span class="string">'message'</span>: <span class="string">"The something is finished!"</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># FROM CUSTOM PYTHON SCRIPTS</span></span><br><span class="line"><span class="comment"># 从自定义Python代码中触发事件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> salt.client</span><br><span class="line"></span><br><span class="line">caller = salt.client.Caller()</span><br><span class="line"></span><br><span class="line">caller.sminion.functions[<span class="string">'event.send'</span>](</span><br><span class="line">    <span class="string">'myco/myevent/success'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'success'</span>: <span class="keyword">True</span>,</span><br><span class="line">        <span class="string">'message'</span>: <span class="string">"It works!"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="Beacons"><a href="#Beacons" class="headerlink" title="Beacons"></a>Beacons</h2><blockquote>
<p>注意:<br>Salt beacons 是一种事件生成机制。当信标事件(beacons events)发生时，信标利用Salt Reactor System 进行更改。</p>
</blockquote>
<p><strong>Beacons</strong> 允许您使用 Salt event system 来监控 non-Salt 进程。Beacon system 允许minion挂钩到各种系统进程并持续监视这些进程。当在系统进程中发生受监视的活动时，将在  Salt event bus 上发送可用于触发反应器(reactor)的事件。</p>
<p>Salt beacons 当前可以监控和发送Salt事件，用于许多系统活动，包括:</p>
<ul>
<li>文件系统更改(file system changes)</li>
<li>系统负载(system load)</li>
<li>服务状态(service status)</li>
<li>shell activity, such as user login</li>
<li>网络和磁盘使用情况(network and disk usage)</li>
</ul>
<p><br><br><br></p>
<h3 id="BEACON-MODULES"><a href="#BEACON-MODULES" class="headerlink" title="BEACON MODULES"></a>BEACON MODULES</h3><p>BEACON MODULES LISTS: <a href="https://docs.saltstack.com/en/latest/ref/beacons/all/index.html#all-salt-beacons" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/beacons/all/index.html#all-salt-beacons</a></p>
<p><br><br><br></p>
<h3 id="BEACONS-配置"><a href="#BEACONS-配置" class="headerlink" title="BEACONS 配置"></a>BEACONS 配置</h3><p>Salt Beacons 不需要对正在监视的系统组件进行任何更改，所有内容都使用Salt进行配置。</p>
<p>Beacons 通常在Minio config 中的 <code>beacons:</code> 段进行配置，或在 <code>/etc/salt/minion.d/</code> 下的任意文件，如 <code>/etc/salt/minion.d/beacons.conf</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># inotify信标仅适用于具有inotify内核支持的操作系统</span></span><br><span class="line"><span class="attr">beacons:</span></span><br><span class="line"><span class="attr">  inotify:</span></span><br><span class="line"><span class="attr">    - files:</span></span><br><span class="line">        <span class="string">/etc/important_file:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="string">/opt:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>与Salt中的许多其它系统一样，信标系统也可以通过 Minion Pillar，Grains 或 本地配置文件进行配置。</p>
<p><br></p>
<h4 id="Beacons监控间隔"><a href="#Beacons监控间隔" class="headerlink" title="Beacons监控间隔"></a>Beacons监控间隔</h4><p>BEACON MONITORING INTERVAL</p>
<p>默认情况下，信标以1秒的间隔监控。要设置不同的间隔，请为信标提供 <code>interval</code> 参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">beacons:</span></span><br><span class="line"><span class="attr">  inotify:</span></span><br><span class="line"><span class="attr">    - files:</span></span><br><span class="line">        <span class="string">/etc/important_file:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="string">/opt:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    - interval:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    - disable_during_state_run:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">  load:</span></span><br><span class="line"><span class="attr">    - averages:</span></span><br><span class="line">        <span class="number">1</span><span class="attr">m:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">0.0</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">2.0</span></span><br><span class="line">        <span class="number">5</span><span class="attr">m:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">0.0</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">1.5</span></span><br><span class="line">        <span class="number">15</span><span class="attr">m:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">0.1</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">    - interval:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="避免事件循环"><a href="#避免事件循环" class="headerlink" title="避免事件循环"></a>避免事件循环</h4><p>AVOIDING EVENT LOOPS</p>
<p>仔细考虑在 Reactor 和 Beacons 之间创建循环的可能性非常重要。例如，可以设置一个信标，该信标监视是否读取文件，该文件又触发反应器以运行状态，该状态又反过来读取文件并重新激活信标。<br>为了避免这些类型的场景，可以设置 <code>disable_during_state_run</code> 参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">beacons:</span></span><br><span class="line"><span class="attr">  inotify:</span></span><br><span class="line"><span class="attr">    - files:</span></span><br><span class="line">        <span class="string">/etc/important_file:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    - disable_during_state_run:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="栗子-4"><a href="#栗子-4" class="headerlink" title="栗子"></a>栗子</h3><p>BEACON EXAMPLE</p>
<p>栗子配置 <code>inotify</code> 信标以监视文件以进行更改，然后在进行更改时将文件还原为其原始内容。</p>
<p><code>inotify</code> 信标需要在 <code>minion</code> 上使用 <code>Pyinotify</code>，使用 <code>salt myminion pkg.install python-inotify</code> 进行安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 安装Pyinotify</span><br><span class="line">salt &apos;centos&apos; pkg.install python-inotify</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># CREATE WATCHED FILE</span><br><span class="line">echo &apos;important_config: True&apos; &gt; /etc/salt/important_file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ADD BEACON CONFIGS TO MINION</span><br><span class="line"># Salt Minion /etc/salt/minion.d/beacons.conf</span><br><span class="line">beacons:</span><br><span class="line">  inotify:</span><br><span class="line">    - files:</span><br><span class="line">        /etc/salt/important_file:</span><br><span class="line">          mask:</span><br><span class="line">            - modify</span><br><span class="line">    - disable_during_state_run: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 保存配置文件，并重新启动Minion服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># VIEW EVENTS ON THE MASTER</span><br><span class="line"># Salt Master</span><br><span class="line">salt-run state.event pretty=true</span><br><span class="line"># 此Runner显示Master在Salt事件总线上接收的事件</span><br><span class="line"></span><br><span class="line"># 要测试您在上一节中设置的信标，请对 /etc/salt/important_file 进行修改并保存</span><br><span class="line"># Salt Minion</span><br><span class="line">echo &apos;name: zhang&apos; &gt;&gt; /etc/salt/important_file</span><br><span class="line"></span><br><span class="line"># 此时Master上的Runner会显示修改信息</span><br><span class="line">salt/beacon/centos/inotify//etc/salt/important_file     &#123;</span><br><span class="line">    &quot;_stamp&quot;: &quot;2019-02-11T06:36:06.282180&quot;,</span><br><span class="line">    &quot;change&quot;: &quot;IN_MODIFY&quot;,</span><br><span class="line">    &quot;id&quot;: &quot;centos&quot;</span><br><span class="line">    &quot;path&quot;: &quot;/etc/salt/important_file&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，您可以创建一个反应器(Reactor)，以便在发生此事件时采取措施。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># CREATE A REACTOR</span><br><span class="line"># 每次修改时，此反应器都会监视的文件恢复为salt提供的内容</span><br><span class="line"></span><br><span class="line">mkdir -p /srv/reactor</span><br><span class="line"></span><br><span class="line"># /srv/reactor/revert.sls</span><br><span class="line">revert-file:</span><br><span class="line">  local.state.apply:</span><br><span class="line">    - tgt: &#123;&#123; data[&apos;data&apos;][&apos;id&apos;] &#125;&#125;</span><br><span class="line">    - arg:</span><br><span class="line">      - maintain_important_file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># STATE SLS</span><br><span class="line"># /srv/salt/maintain_important_file.sls</span><br><span class="line">important_file:</span><br><span class="line">  file.managed:</span><br><span class="line">    - name: /etc/important_file</span><br><span class="line">    - contents: |</span><br><span class="line">        important_config: True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># MASTER CONFIG</span><br><span class="line"># 配置master以将inotify信标事件映射到 /etc/salt/master.d/reactor.conf 中的还原反应</span><br><span class="line">reactor:</span><br><span class="line">  - salt/beacon/*/inotify//etc/important_file:</span><br><span class="line">    - /srv/reactor/revert.sls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># START THE SALT MASTER IN DEBUG MODE</span><br><span class="line"># 启用调试后，你可以在日志中看到Reactor和Event相关信息</span><br><span class="line">service salt-master stop</span><br><span class="line">salt-master -l debug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># TRIGGER THE REACTOR</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="编写Beacon插件"><a href="#编写Beacon插件" class="headerlink" title="编写Beacon插件"></a>编写Beacon插件</h3><p>WRITING BEACON PLUGINS</p>
<p>Beacon Plugin 使用标准的 Salt Loader System，这意味着来自其它插件系统的许多构造都是正确的，例如 <code>__virtual__</code> 函数。<br>Beacon Plugin 中的重要的函数是 <code>beacon</code> 函数。当beacon配置为运行时，该功能将由minion重复执行。因此，<code>beacon</code> 功能不能阻止，并且应尽可能轻。信标还必须返回一个dicts列表，列表中的每个dict将被转换为master上的事件。</p>
<p><br></p>
<p><strong>THE BEACON FUNCTION</strong></p>
<p>信标系统将在模块中寻找名为 <code>beacon</code> 的函数。如果此函数不存在，则不会触发信标。定期调用此函数，默认情况下在minion的每次迭代时调用，每秒迭代次数可达数十至数百次。这意味着信标功能不能阻止，不应该是 CPU/IO 密集型。</p>
<p>信标功能将在执行的信标的配置中传递。这使得为每个被调用的信标建立灵活配置变得容易。这也是摄取信标配置的首选方式，因为它允许在 Minion 运行时通过配置 Minion Pillar 中的信标来动态更新配置。</p>
<p><br></p>
<p><strong>THE BEACON RETURN</strong></p>
<p>从信标返回的信息预计遵循预定义的结构。返回的值必须是字典列表（首选标准python字典，不需要有序的字典）。</p>
<p>这些字典代表了对Minion和Master 事件总线的个别事件。每个字典都是一个单一的事件。 dict可以包含任意键，但是tag键将被提取并添加到被触发事件的标签中。</p>
<p><br></p>
<p><strong>CALLING EXECUTION MODULES</strong></p>
<p>执行模块仍然是Salt中所有工作和系统交互的首选位置。因此，<code>__salt__</code> 变量在信标内可用。<br>在 <code>__salt__</code> 中调用函数时要小心，虽然这是在Salt中执行复杂例程的首选方法，但并不是所有的执行模块都是用信标编写的。注意可能是CPU密集或IO限制的执行模块。请随意添加新的执行模块和功能以支持特定的信标。</p>
<p><br><br><br><br><br></p>
<h2 id="反应器系统"><a href="#反应器系统" class="headerlink" title="反应器系统"></a>反应器系统</h2><p>Reactor System</p>
<p>Salt’s Reactor system 使Salt能够触发操作以响应事件。这是一个简单的接口，用于监视Salt的事件总线，以查找与给定模式匹配的事件标记，然后运行一个或多个命令作为响应。</p>
<p>该系统将sls文件绑定到Master上的事件标记。这些sls文件然后定义反应(reactions)。这意味着反应器系统有两个部分。首先，需要在主配置文件中设置reactor选项。 reactor选项允许事件标记与sls反应文件相关联。其次，这些反应文件使用highdata（如状态系统）来定义要执行的反应。</p>
<p><br></p>
<h3 id="事件系统-1"><a href="#事件系统-1" class="headerlink" title="事件系统"></a>事件系统</h3><p>EVENT SYSTEM</p>
<p>理解反应器需要对事件系统有基本的了解。事件系统是一个本地ZeroMQ PUB接口，用于引发Salt事件。此事件总线是一个开放系统，用于发送通知Salt和其它系统有关操作的信息。</p>
<p>事件系统使用非常特定的标准引发事件。每个事件都有一个tag。事件标记允许对事件进行快速顶级过滤。除了标记之外，每个事件都有一个数据结构。此数据结构是一个字典，其中包含有关该事件的信息。</p>
<p><br><br><br></p>
<h3 id="将事件映射到反应器SLS文件"><a href="#将事件映射到反应器SLS文件" class="headerlink" title="将事件映射到反应器SLS文件"></a>将事件映射到反应器SLS文件</h3><p>MAPPING EVENTS TO REACTOR SLS FILES</p>
<p>Reactor SLS Files 和 Event Tag 在 Master config 中关联。默认为<code>/etc/salt/master</code>，也可以是<code>/etc/salt/master.d/reactor.conf</code>。</p>
<p>例如:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">reactor:</span>                            <span class="comment"># Master config section "reactor"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'salt/minion/*/start'</span><span class="string">:</span>          <span class="comment"># Match tag "salt/minion/*/start"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/reactor/start.sls</span>        <span class="comment"># Things to do when a minion starts</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/reactor/monitor.sls</span>      <span class="comment"># Other things to do</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'salt/cloud/*/destroyed'</span><span class="string">:</span>       <span class="comment"># Globs can be used to match tags</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/reactor/destroy/*.sls</span>    <span class="comment"># Globs can be used to match file names</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'myco/custom/event/tag'</span><span class="string">:</span>        <span class="comment"># React to custom event tags</span></span><br><span class="line"><span class="attr">    - salt:</span><span class="string">//reactor/mycustom.sls</span>   <span class="comment"># Reactor files can come from the salt fileserver</span></span><br></pre></td></tr></table></figure>
<p>Reactor SLS文件类似于State和Pillar SLS文件。它们默认为 <code>YAML + Jinja</code> 模板，并传递熟悉的上下文变量。</p>
<p><br><br><br></p>
<h3 id="反应类型"><a href="#反应类型" class="headerlink" title="反应类型"></a>反应类型</h3><p>TYPES OF REACTIONS</p>
<blockquote>
<p>注意:<br>The local and caller reaction types will likely be renamed in a future release.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>local</td>
<td>Runs a remote-execution function on targeted minions</td>
</tr>
<tr>
<td>runner</td>
<td>Executes a runner function</td>
</tr>
<tr>
<td>wheel</td>
<td>Executes a wheel function on the master</td>
</tr>
<tr>
<td>caller</td>
<td>Runs a remote-execution function on a masterless minion</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h3 id="哪里放置反应器SLS文件"><a href="#哪里放置反应器SLS文件" class="headerlink" title="哪里放置反应器SLS文件"></a>哪里放置反应器SLS文件</h3><p>WHERE TO PUT REACTOR SLS FILES</p>
<p>Reactor SLS文件既可以来自master的本地文件，也可以来自通过 <code>fileserver_backend</code> 配置项启用的任何后端。可以使用 <code>salt://</code> URL引用放置在Salt文件服务器中的文件，就像它们可以在状态SLS文件中一样。</p>
<p>建议将reactor和orchestrator SLS文件放在它们自己唯一命名的子目录中。如 <code>orch/</code>, <code>orchestrate/</code>, <code>react/</code>, <code>reactor/</code>…</p>
<p><br><br><br></p>
<h3 id="编写反应器SLS"><a href="#编写反应器SLS" class="headerlink" title="编写反应器SLS"></a>编写反应器SLS</h3><p>WRITING REACTOR SLS</p>
<p>不同的反应类型是分开开发的，历史上有不同的传递参数的方法。对于 <code>2017.7.2 release</code>，引入了一种新的统一配置模式，该模式适用于所有反应类型。</p>
<p>将继续支持旧的配置架构，并且目前没有计划弃用它。</p>
<p><br></p>
<p><strong>LOCAL REACTIONS</strong></p>
<p>旧的配置架构要求用户在 <code>arg</code> 和 <code>kwarg</code> 参数下手动分隔位置和关键字参数。<br>但是，这不是很用户友好，因为它强制用户区分哪种类型的参数，并确保正确排序位置参数。因此，如果主服务器正在运行受支持的版本，则建议使用新的配置模式。</p>
<p>以下两个例子等效:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Supported in 2017.7.2 and later</span></span><br><span class="line"><span class="attr">install_zsh:</span></span><br><span class="line">  <span class="string">local.state.single:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'kernel:Linux'</span></span><br><span class="line"><span class="attr">    - tgt_type:</span> <span class="string">grain</span></span><br><span class="line"><span class="attr">    - args:</span></span><br><span class="line"><span class="attr">      - fun:</span> <span class="string">pkg.installed</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">zsh</span></span><br><span class="line"><span class="attr">      - fromrepo:</span> <span class="string">updates</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Supported in all releases</span></span><br><span class="line"><span class="attr">install_zsh:</span></span><br><span class="line">  <span class="string">local.state.single:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'kernel:Linux'</span></span><br><span class="line"><span class="attr">    - tgt_type:</span> <span class="string">grain</span></span><br><span class="line"><span class="attr">    - arg:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">pkg.installed</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">zsh</span></span><br><span class="line"><span class="attr">    - kwarg:</span></span><br><span class="line"><span class="attr">        fromrepo:</span> <span class="string">updates</span></span><br></pre></td></tr></table></figure></p>
<p>这个反应等同于运行以下Salt命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt -G <span class="string">'kernel:Linux'</span> state.single pkg.installed name=zsh fromrepo=updates</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>RUNNER REACTIONS</strong></p>
<p>新旧两个例子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Supported in 2017.7.2 and later</span></span><br><span class="line"><span class="attr">deploy_app:</span></span><br><span class="line">  <span class="string">runner.state.orchestrate:</span></span><br><span class="line"><span class="attr">    - args:</span></span><br><span class="line"><span class="attr">      - mods:</span> <span class="string">orchestrate.deploy_app</span></span><br><span class="line"><span class="attr">      - pillar:</span></span><br><span class="line"><span class="attr">          event_tag:</span> <span class="string">&#123;&#123;</span> <span class="string">tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          event_data:</span> <span class="string">&#123;&#123;</span> <span class="string">data['data']|json</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Supported in all releases</span></span><br><span class="line"><span class="attr">deploy_app:</span></span><br><span class="line">  <span class="string">runner.state.orchestrate:</span></span><br><span class="line"><span class="attr">    - mods:</span> <span class="string">orchestrate.deploy_app</span></span><br><span class="line"><span class="attr">    - kwarg:</span></span><br><span class="line"><span class="attr">        pillar:</span></span><br><span class="line"><span class="attr">          event_tag:</span> <span class="string">&#123;&#123;</span> <span class="string">tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">          event_data:</span> <span class="string">&#123;&#123;</span> <span class="string">data['data']|json</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>假设事件标记是foo，并且传递给事件的数据是 <code>{&#39;bar&#39;：&#39;baz&#39;}</code> ，那么这个反应等同于运行以下Salt命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run state.orchestrate mods=orchestrate.deploy_app pillar=<span class="string">'&#123;"event_tag": "foo", "event_data": &#123;"bar": "baz"&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>WHEEL REACTIONS</strong></p>
<p>新旧两种栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Supported in 2017.7.2 and later</span></span><br><span class="line"><span class="attr">remove_key:</span></span><br><span class="line">  <span class="string">wheel.key.delete:</span></span><br><span class="line"><span class="attr">    - args:</span></span><br><span class="line"><span class="attr">      - match:</span> <span class="string">&#123;&#123;</span> <span class="string">data['id']</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Supported in all releases</span></span><br><span class="line"><span class="attr">remove_key:</span></span><br><span class="line">  <span class="string">wheel.key.delete:</span></span><br><span class="line"><span class="attr">    - match:</span> <span class="string">&#123;&#123;</span> <span class="string">data['id']</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>CALLER REACTIONS</strong></p>
<blockquote>
<p>注意:<br>Masterless Minions use this Reactor</p>
</blockquote>
<p>新旧两种栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Supported in 2017.7.2 and later</span></span><br><span class="line"><span class="attr">touch_file:</span></span><br><span class="line">  <span class="string">caller.file.touch:</span></span><br><span class="line"><span class="attr">    - args:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">/tmp/foo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Supported in all releases</span></span><br><span class="line"><span class="attr">touch_file:</span></span><br><span class="line">  <span class="string">caller.file.touch:</span></span><br><span class="line"><span class="attr">    - args:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/tmp/foo</span></span><br></pre></td></tr></table></figure>
<p>此反应等同于运行以下Salt命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-call file.touch name=/tmp/foo</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="编写反应器SLS的最佳实践"><a href="#编写反应器SLS的最佳实践" class="headerlink" title="编写反应器SLS的最佳实践"></a>编写反应器SLS的最佳实践</h3><p>BEST PRACTICES FOR WRITING REACTOR SLS FILES</p>
<p>Reactor的工作原理如下:</p>
<ol>
<li>The Salt Reactor watches Salt’s event bus for new events.</li>
<li>Each event’s tag is matched against the list of event tags configured under the reactor section in the Salt Master config.</li>
<li>The SLS files for any matches are rendered into a data structure that represents one or more function calls.</li>
<li>That data structure is given to a pool of worker threads for execution.</li>
</ol>
<p><br><br><br></p>
<h3 id="BEACONS-AND-REACTORS"><a href="#BEACONS-AND-REACTORS" class="headerlink" title="BEACONS AND REACTORS"></a>BEACONS AND REACTORS</h3><p>An event initiated by a beacon, when it arrives at the master will be wrapped inside a second event, such that the data object containing the beacon information will be data[‘data’], rather than data.</p>
<p><br><br><br></p>
<h3 id="手动引发事件"><a href="#手动引发事件" class="headerlink" title="手动引发事件"></a>手动引发事件</h3><p>MANUALLY FIRING AN EVENT</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FROM THE MASTER</span></span><br><span class="line"><span class="comment"># Use the event.send runner</span></span><br><span class="line">salt-run event.send foo <span class="string">'&#123;orchestrate: refresh&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># FROM THE MINION</span></span><br><span class="line"><span class="comment"># To fire an event to the master from a minion, call event.send</span></span><br><span class="line">salt-call event.send foo <span class="string">'&#123;orchestrate: refresh&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To fire an event to the minion's local event bus, call event.fire:</span></span><br><span class="line">salt-call event.fire <span class="string">'&#123;orchestrate: refresh&#125;'</span> foo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># REFERENCING DATA PASSED IN EVENTS</span></span><br><span class="line"><span class="comment"># any reactor SLS files triggered by watching the event tag foo will execute with &#123;&#123; data['data']['orchestrate'] &#125;&#125; equal to 'refresh'.</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="获取事件信息"><a href="#获取事件信息" class="headerlink" title="获取事件信息"></a>获取事件信息</h3><p>GETTING INFORMATION ABOUT EVENTS</p>
<p>确切地查看已触发的事件以及每个事件中可用的数据的最佳方法是使用 <code>state.event runner</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">salt-run state.event pretty=True</span><br><span class="line"></span><br><span class="line"><span class="comment">#一有变动，就会触发你所定义的动作。就会显示变动信息。</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="编排"><a href="#编排" class="headerlink" title="编排"></a>编排</h1><p>ORCHESTRATION</p>
<p><br></p>
<h2 id="ORCHESTRATE-RUNNER"><a href="#ORCHESTRATE-RUNNER" class="headerlink" title="ORCHESTRATE RUNNER"></a>ORCHESTRATE RUNNER</h2><p>当你想确保minion按照你想要的方式配置和运行时，对minion执行State或Highstate是完美的。但有时你想同时配置一组minions。</p>
<p>例如，如果要在Web服务器集群前设置负载均衡器，可以确保首先设置负载均衡器，然后在整个集群中一致地应用相同的匹配配置。<br><strong>编排(Orchestration)</strong> 是实现此目的的方法。</p>
<p><br></p>
<h3 id="THE-ORCHESTRATE-RUNNER"><a href="#THE-ORCHESTRATE-RUNNER" class="headerlink" title="THE ORCHESTRATE RUNNER"></a>THE ORCHESTRATE RUNNER</h3><blockquote>
<p>注意:<br>Orchestrate弃用了OverState<br>在 Salt <code>2015.8.0</code>, Orchestrate Runner 取代了 OverState system</p>
</blockquote>
<p>Orchestrate Runner(最初称为 state.sls runner) 提供OverState的所有功能，但有以下优点:</p>
<ul>
<li>可以使用State中可用的所有requisites 和其它全局参数</li>
<li>states/functions 也适用于 salt-ssh minions</li>
</ul>
<p><br></p>
<p>Orchestrate Runner 将 Salt State system 概括为 Salt Master Context。而 <code>state.sls</code>, <code>state.highstate</code> 在每个Salt Minion上同时独立执行，<code>state.orchestrate</code> runner 在Master上执行。给它一个 <code>master-level</code> 视图并控制必要条件，如状态排序和条件。这允许了Minion的必要条件，例如在不同的Minion上排序这些应用的状态，这些状态不能够同时发生，或者如果Minion失去其中一个状态，则停止所有Minion的状态。</p>
<p><code>state.sls</code>, <code>state.highstate</code> 允许你有状态地管理每个Minion，<code>state.orchestrate</code> runner 允许你有状态的管理整个基础结构。</p>
<p><br><br><br></p>
<h4 id="编写SLS文件"><a href="#编写SLS文件" class="headerlink" title="编写SLS文件"></a>编写SLS文件</h4><p>Orchestrate SLS 文件与 State SLS 文件存储在相同的位置。这意味着 <code>file_roots</code> 和 <code>gitfs_remotes</code> 都会影响 Reactor 和 Orchestrator 可用的SLS文件。</p>
<p>建议将 reactor和orchestrator SLS文件保存在各自唯一命名的子目录中，如 <code>_orch/</code>, <code>orch/</code>, <code>_orchestrate/</code>, <code>react/</code>, <code>_reactor</code> …这样可以避免重复命名，有助于防止混淆。</p>
<p><br><br><br></p>
<h4 id="执行编排运行器"><a href="#执行编排运行器" class="headerlink" title="执行编排运行器"></a>执行编排运行器</h4><p>EXECUTING THE ORCHESTRATE RUNNER</p>
<p>Orchestrate Runner命令格式与 <code>state.sls</code> 函数相同，除了因为它是一个Runner，它是用 <code>salt-run</code> 而不是 <code>salt</code> 来执行。<br>假设你有一个名为 <code>/srv/salt/orch/webserver.sls</code> 的 <code>state.sls</code> 文件，则在Master上运行以下命令将该应用该文件中定义的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># state.orch 是 state.orchestrate 的同义词</span></span><br><span class="line">salt-run state.orchestrate orch.webserver</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="无主编排"><a href="#无主编排" class="headerlink" title="无主编排"></a>无主编排</h4><p>MASTERLESS ORCHESTRATION</p>
<blockquote>
<p>注意:<br>无主模式编排仅支持SLS文件中的 <code>salt.state</code> 命令，它当前不支持 <code>salt.function</code> 命令。</p>
</blockquote>
<p>要在 MasterLess Minions 上支持 Salt Orchetration, Orchestrate Runner 可用作执行模块。无主编排的语法完全相同，但是它使用 <code>salt-call</code> 命令，并且Minion Config 必须包含 <code>file_mode: local</code> 选项。(或者，在命令行使用 <code>salt-call --local</code>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-call --<span class="built_in">local</span> state.orchestrate orch.webserver</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="栗子-5"><a href="#栗子-5" class="headerlink" title="栗子"></a>栗子</h4><p><strong>FUNCTION</strong></p>
<p>要执行函数，使用 <code>salt.function</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /srv/salt/orch/cleanfoo.sls</span></span><br><span class="line"><span class="string">cmd.run:</span></span><br><span class="line">  <span class="string">salt.function:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">    - arg:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">rm</span> <span class="bullet">-rf</span> <span class="string">/tmp/foo</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run state.orchestrate orch.cleanfoo</span><br></pre></td></tr></table></figure>
<p>如果省略了 <code>name</code> 参数，则状态的ID将是默认名称，或者在 <code>salt.function</code> 的情况下，执行模块函数运行。你可以指定 <code>name</code> 参数以避免ID冲突:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">copy_some_file:</span></span><br><span class="line">  <span class="string">salt.function:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">file.copy</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">    - arg:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/path/to/file</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/tmp/copy_of_file</span></span><br><span class="line"><span class="attr">    - kwarg:</span></span><br><span class="line"><span class="attr">        remove_existing:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>FAIL FUNCTIONS</strong></p>
<blockquote>
<p>重要:<br>Fail Function 运行在Master上，因此必须使用 <code>salt-run saltutil.sync_modules</code> 同步。</p>
</blockquote>
<p>在编排中运行远程执行功能时，这些功能的某些返回值可能表示失败，而函数本身并未设置返回码。对于这些情况，使用 <code>FAIL FUNCTION</code> 允许更灵活的评估成功或失败的方法。</p>
<p>失败函数可以编写为自定义执行模块的一部分。该函数接受一个参数，并返回一个布尔结果。例如:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_func_result</span><span class="params">(retval)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> some_condition:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>可以在编排SLS中引用此函数，如下所示:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">do_stuff:</span></span><br><span class="line">  <span class="string">salt.function:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">modname.funcname</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">    - fail_function:</span> <span class="string">mymod.check_func_result</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>STATE</strong></p>
<p>要执行一个状态，使用 <code>salt.state</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /srv/salt/orch/webserver.sls</span></span><br><span class="line"><span class="attr">install_nginx:</span></span><br><span class="line">  <span class="string">salt.state:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'web*'</span></span><br><span class="line"><span class="attr">    - sls:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run state.orchestrate orch.webserver</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>HIGHSTATE</strong></p>
<p>要运行highstate，在状态配置中设置 <code>highstate: True</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /srv/salt/orch/web_setup.sls</span></span><br><span class="line"><span class="attr">webserver_setup:</span></span><br><span class="line">  <span class="string">salt.state:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'web*'</span></span><br><span class="line"><span class="attr">    - highstate:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run state.orchestrate orch.web_setup</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>RUNNER</strong></p>
<p>要使用其它RUNNER，使用<code>salt.runner</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /srv/salt/orch/deploy.sls</span></span><br><span class="line"><span class="attr">create_instance:</span></span><br><span class="line">  <span class="string">salt.runner:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">cloud.profile</span></span><br><span class="line"><span class="attr">    - prof:</span> <span class="string">cloud-centos</span></span><br><span class="line"><span class="attr">    - provider:</span> <span class="string">cloud</span></span><br><span class="line"><span class="attr">    - instances:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">server1</span></span><br><span class="line"><span class="attr">    - opts:</span></span><br><span class="line"><span class="attr">        minion:</span></span><br><span class="line"><span class="attr">          master:</span> <span class="string">master1</span></span><br></pre></td></tr></table></figure>
<p>使用Pillar数据执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-run state.orch orch.deploy pillar=<span class="string">'&#123;"servers": "newsystem1", "master": "mymaster"&#125;'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>RETURN CODES IN RUNNER/WHEEL JOBS</strong></p>
<p>状态作业(<code>salt.state</code>)能够通过状态返回字典(state return dictionary)上报失败。运城执行(<code>salt.function</code>)作业能够通过在<code>__context__</code>字典中设置<code>retcode</code> 键 来上报失败。然而，Runner(<code>salt.runner</code>)和 Wheel(<code>salt.wheel</code>)作业才会上报 <code>False</code> 结果。<br>从 <code>2018.3.0</code> 版本开始，现在可以像在远程执行功能中一样在 Runner 和 Wheel 功能中设置 Retcode。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义 Runner/Wheel 函数上报其失败，以便准确地告知作业失败</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myrunner</span><span class="params">()</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    do stuff</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> some_error_condition:</span><br><span class="line">        __context__[<span class="string">'retcode'</span>] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>MORE COMPLEX ORCHESTRATION</strong></p>
<p>可以在单个文件中配置许多 <em>状态/函数</em> ，当与完整的Requisites 和其它全局状态参数组合时，可以使用它们轻松配置复杂的编排任务。此外，状态/函数将按照定义它们的顺序执行，除非你做了配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bootstrap_servers:</span></span><br><span class="line">  <span class="string">salt.function:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">cmd.run</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">    - tgt_type:</span> <span class="string">ipcidr</span></span><br><span class="line"><span class="attr">    - arg:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">bootstrap</span></span><br><span class="line"></span><br><span class="line"><span class="attr">storage_setup:</span></span><br><span class="line">  <span class="string">salt.state:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'role:storage'</span></span><br><span class="line"><span class="attr">    - tgt_type:</span> <span class="string">grain</span></span><br><span class="line"><span class="attr">    - sls:</span> <span class="string">ceph</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - salt:</span> <span class="string">webserver_setup</span></span><br><span class="line"></span><br><span class="line"><span class="attr">webserver_setup:</span></span><br><span class="line">  <span class="string">salt.state:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">'web*'</span></span><br><span class="line"><span class="attr">    - highstate:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>鉴于上述配置，编排将按照如下方式执行:</p>
<ol>
<li><code>bootstrap</code>将在 cidr 中的所有minion上执行</li>
<li>由于 <code>storage_setup</code> state require，因此将在ID以<code>web</code>开头的minion上运行Highstate</li>
<li>最后，ceph SLS 目标将在匹配 Grains的minion上执行</li>
</ol>
<p><br><br><br></p>
<h3 id="程序化解析结果"><a href="#程序化解析结果" class="headerlink" title="程序化解析结果"></a>程序化解析结果</h3><p>PARSING RESULTS PROGRAMMATICALLY</p>
<p>编排作业返回一个特定数据结构的输出。根据使用的输出器，该数据结构的表示方式不同。使用编排的默认输出器，你将获得一个很好的人类可读输出。</p>
<p>假设以下 Orchestration SLS:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">good_state:</span></span><br><span class="line">  <span class="string">salt.state:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">myminion</span></span><br><span class="line"><span class="attr">    - sls:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">succeed_with_changes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bad_state:</span></span><br><span class="line">  <span class="string">salt.state:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">myminion</span></span><br><span class="line"><span class="attr">    - sls:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail_with_changes</span></span><br><span class="line"></span><br><span class="line"><span class="string">mymod.myfunc:</span></span><br><span class="line">  <span class="string">salt.function:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">myminion</span></span><br><span class="line"></span><br><span class="line"><span class="string">mymod.myfunc_false_result:</span></span><br><span class="line">  <span class="string">salt.function:</span></span><br><span class="line"><span class="attr">    - tgt:</span> <span class="string">myminion</span></span><br></pre></td></tr></table></figure>
<p>默认输出器输出结果太多，这里给出链接: <a href="https://docs.saltstack.com/en/latest/topics/orchestrate/orchestrate_runner.html#parsing-results-programmatically" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/orchestrate/orchestrate_runner.html#parsing-results-programmatically</a></p>
<p><br><br><br></p>
<h4 id="在没有Minion的Master上运行STATE"><a href="#在没有Minion的Master上运行STATE" class="headerlink" title="在没有Minion的Master上运行STATE"></a>在没有Minion的Master上运行STATE</h4><p>RUNNING STATES ON THE MASTER WITHOUT A MINION</p>
<p>Orchestrate runner可用于在不使用minion的情况下在master上执行状态。</p>
<p>假设有 <code>salt://foo.sls</code> SLS文件:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/foo.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://files/foo.conf</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">0600</span></span><br></pre></td></tr></table></figure>
<p>在这种情况下，运行 <code>salt-run state.orchestrate foo</code> 将等同于运行 <code>state.sls foo</code>，但它只在Master上执行，并且不需要在Master上运行Minion个的守护进程。</p>
<p>这不是技术上的编排，但它在某些用例中很有用。</p>
<p><br></p>
<p><strong>LIMITATIONS</strong></p>
<p>使用此方法一次只能运行一个SLS目标，而使用 <code>state.sls</code> 允许在逗号分隔列表中传递多个SLS文件。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="SALT-PROXY-MINION"><a href="#SALT-PROXY-MINION" class="headerlink" title="SALT PROXY MINION"></a>SALT PROXY MINION</h1><p><strong>Proxy Minion</strong> 是一种开发中的Salt功能，可以控制无论出于何种原因无法运行标准 <code>salt-minion</code> 的设备。例如，具有API但运行专有操作系统的网络设备，具有有限的CPU或MEM的设备，可以运行Minion的设备，但出于安全原因，并不会运行。</p>
<p>proxy minion 不是一个 <strong>开箱即用</strong>(out of the box) 的功能。由于存爱无限数量的可控设备，因此你很可能必须自己编写接口(interface)。幸运的是，这与代理设备的实际接口一样困难。设备具有现有Python模块(如: <code>PyUSB</code>)的接口相对简单。用于控制具有 HTML REST接口的代码设备应该很容易。</p>
<p>Salt Proxy-Minion 提供了 ，允许设备 <strong>枚举</strong>(enumeration) 和 <strong>发现</strong>(discovery)， <strong>控制</strong>(control)， <strong>状态</strong>(status)， <strong>远程执行</strong>(remote execution) 和 <strong>状态管理</strong>(state management) 的 <strong>管道</strong>(plumbing)。</p>
<p><br></p>
<h2 id="入门-1"><a href="#入门-1" class="headerlink" title="入门"></a>入门</h2><p>下图可能有助于理解包含 Proxy-Minions 的 Salt 结构:</p>
<p><img src="/images/Salt/proxy_minions.png" alt=""></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="网络自动化"><a href="#网络自动化" class="headerlink" title="网络自动化"></a>网络自动化</h1><p>NETWORK AUTOMATION</p>
<p><strong>Network Automation</strong> 是自动化计算机网络的 配置，管理，操作的连续过程。虽然抽象(abstraction)可以与服务器端的操作进行比较，但是存在许多特殊的挑战，最重要的是网络设备传统上是封闭的硬件，只能运行专有软件。换句话说，用户无法直接在传统网络设备上安装 <code>salt-minion</code> 包。由于这些原因，大多数网络设备只能通 Proxy-Minion 或使用 Salt-SSH 进行远程控制。但也有一些供应商生产了专门的设备。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="命令参考"><a href="#命令参考" class="headerlink" title="命令参考"></a>命令参考</h1><p>COMMAND LINE REFERENCE</p>
<p><br></p>
<h2 id="SALT-CALL"><a href="#SALT-CALL" class="headerlink" title="SALT-CALL"></a>SALT-CALL</h2><blockquote>
<p>注意:<br><code>salt-call</code> 命令从当前用户的shell上下文执行，而salt命令从系统的默认上下文执行。</p>
</blockquote>
<p><code>salt-call</code> 命令用于在 Minion 上本地运行模块函数(module functions)，而不是从 Master 执行它们。<br>除非指定了 <code>--local</code> 选项，否则将联系Salt Master以在执行期间检索状态文件和其他资源。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-call - salt-call Documentation</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#语法</span></span><br><span class="line">salt-call [options]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT"><a href="#SALT" class="headerlink" title="SALT"></a>SALT</h2><p>Salt允许命令在一系列远程系统上并行执行。这意味着可以轻松地控制和查询远程系统。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法</span></span><br><span class="line">salt [options] <span class="string">'&lt;target&gt;'</span> &lt;<span class="keyword">function</span>&gt; [arguments]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#栗子</span></span><br><span class="line">salt <span class="string">'*'</span> [ options ] sys.doc</span><br><span class="line"></span><br><span class="line">salt -E <span class="string">'.*'</span> [ options ] sys.doc cmd</span><br><span class="line"></span><br><span class="line">salt -G <span class="string">'os:Arch.*'</span> [ options ] test.ping</span><br><span class="line"></span><br><span class="line">salt -C <span class="string">'G@os:Arch.* and webserv* or G@kernel:FreeBSD'</span> [ options ] test.ping</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-CLOUD"><a href="#SALT-CLOUD" class="headerlink" title="SALT-CLOUD"></a>SALT-CLOUD</h2><p>使用Salt在云中配置虚拟机。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-cloud - Salt Cloud Command</span></span><br><span class="line"><span class="comment"># Provision virtual machines in the cloud with Salt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-cloud [options] &lt;-m MAP | -p PROFILE&gt; &lt;NAME&gt; [NAME2 ...]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-CP"><a href="#SALT-CP" class="headerlink" title="SALT-CP"></a>SALT-CP</h2><p>复制文件到一个/多个 Minions。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-cp - salt-cp Documentation</span></span><br><span class="line"><span class="comment"># Copy a file or files to one or more minions</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-cp [options] <span class="string">'&lt;target&gt;'</span> SOURCE DEST</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 栗子</span></span><br><span class="line">salt-cp <span class="string">'*'</span> [ options ] SOURCE [SOURCE2 SOURCE3 ...] DEST</span><br><span class="line"></span><br><span class="line">salt-cp -E <span class="string">'.*'</span> [ options ] SOURCE [SOURCE2 SOURCE3 ...] DEST</span><br><span class="line"></span><br><span class="line">salt-cp -G <span class="string">'os:Arch.*'</span> [ options ] SOURCE [SOURCE2 SOURCE3 ...] DEST</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-EXTEND"><a href="#SALT-EXTEND" class="headerlink" title="SALT-EXTEND"></a>SALT-EXTEND</h2><p>用于生成Salt源代码扩展的实用程序。这用于:</p>
<ul>
<li>添加新的执行模块，状态模块</li>
<li>添加单元测试到现有模块</li>
<li>添加集成测试到现有模块</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="SALT-KEY"><a href="#SALT-KEY" class="headerlink" title="SALT-KEY"></a>SALT-KEY</h2><p>Salt-key执行用于身份验证的 salt server public keys 的简单管理。</p>
<p>在初始连接时，Salt Minion 将其公钥发送给 Salt Master。必须使用 Salt Master 上的 <code>salt-key</code> 命令接受此密钥。</p>
<p>Salt Minion Key 可处于以下状态:</p>
<ul>
<li><strong>unaccepted</strong>: key正在等待被接受</li>
<li><strong>accepted</strong>: key已被接受。Minion可与Master通信</li>
<li><strong>rejected</strong>: 使用 <code>salt-key</code> 命令拒绝了key。在这种状态下，Minion 不接受 Master 的任何通信</li>
<li><strong>denied</strong>: key被Master自动拒绝。当minion有重复的ID，或minion被重建或生成了新的密钥并且之前的密钥没有从Master中删除时，会发生这种情况。在这种状态下，Minion 不接受 Master 的任何通信</li>
</ul>
<p>出现上述情况，删除对应的key，之后在接受就行了。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-key - salt-key Documentation</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-key [ options ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#常用选项</span></span><br><span class="line">-a ACCEPT, --accept=ACCEPT</span><br><span class="line">-A, --accept-all    Accept all pending keys</span><br><span class="line"></span><br><span class="line">-r REJECT, --reject=REJECT</span><br><span class="line">-R, --reject-all    Reject all pending keys</span><br><span class="line"></span><br><span class="line">-f FINGER, --finger=FINGER</span><br><span class="line">-F, --finger-all</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-MASTER"><a href="#SALT-MASTER" class="headerlink" title="SALT-MASTER"></a>SALT-MASTER</h2><p>Salt master守护进程，用于控制Salt minions。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-master - salt-master Documentation</span></span><br><span class="line"><span class="comment"># The Salt master daemon, used to control the Salt minions</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-master [ options ]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-MINION"><a href="#SALT-MINION" class="headerlink" title="SALT-MINION"></a>SALT-MINION</h2><p>Salt minion 守护程序，从远程Salt master接收命令。<br>Salt minion 接收来自 Salt Master 的命令并回复所述命令的结果。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-minion - salt-minion Documentation</span></span><br><span class="line"><span class="comment"># The Salt minion daemon, receives commands from a remote Salt master.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用法</span></span><br><span class="line">salt-minion [options]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-PROXY"><a href="#SALT-PROXY" class="headerlink" title="SALT-PROXY"></a>SALT-PROXY</h2><p>从 Salt Master 接收命令，并将这些命令代理到无法运行完整 Minion 的设备。<br>Salt Proxy Minion 从 Salt Master 接收命令，将适当的命令发送到无法运行 Minion 的设备，并回复所述命令的结果。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-proxy - salt-proxy Documentation</span></span><br><span class="line"><span class="comment"># Receives commands from a Salt master and proxies these commands to devices that are unable to run a full minion.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-proxy [ options ]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-RUN"><a href="#SALT-RUN" class="headerlink" title="SALT-RUN"></a>SALT-RUN</h2><p>执行一个 Salt runner。<br><code>salt-run</code> 是执行 Salt Runners 的前端命令。 Salt Runners 是用于在 Master 上执行便捷功能的简单模块。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-run - salt-run Documentation</span></span><br><span class="line"><span class="comment"># Execute a Salt runner</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-run RUNNER</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-SSH"><a href="#SALT-SSH" class="headerlink" title="SALT-SSH"></a>SALT-SSH</h2><p>Salt SSH允许仅使用SSH进行传输来执行salt例程。<br>通过ssh执行salt命令和状态而不安装salt-minion。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Execute salt commands and states over ssh without installing a salt-minion.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-ssh [options] <span class="string">'&lt;target&gt;'</span> &lt;<span class="keyword">function</span>&gt; [arguments]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 栗子</span></span><br><span class="line"></span><br><span class="line">salt-ssh <span class="string">'*'</span> [ options ] sys.doc</span><br><span class="line"></span><br><span class="line">salt-ssh -E <span class="string">'.*'</span> [ options ] sys.doc cmd</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="入门-2"><a href="#入门-2" class="headerlink" title="入门"></a>入门</h3><p>GETTING STARTED</p>
<p>Salt SSH使用简单，只需设置系统的基本 <strong>Roster</strong>(目标主机名册) 文件，以与标准的 <code>salt</code> 命令类似的方式连接并运行 <code>salt-ssh</code> 命令。</p>
<ul>
<li>远程系统上需要Python（除非使用 <code>-r</code> 选项发送原始 <code>ssh</code> 命令）</li>
<li>在许多系统上，<code>salt-ssh</code> 可执行文件将位于自己的包中，通常名为 <code>salt-ssh</code></li>
<li>Salt SSH系统不会取代标准的Salt通信系统，它只提供基于SSH的替代方案，不需要ZeroMQ和远程Agent。(请注意，由于所有与Salt SSH的通信都是通过SSH执行的，因此它比使用ZeroMQ的标准Salt慢得多)</li>
<li>目前必须包装文件服务器操作以确保使用 <code>salt-ssh</code> 命令传递相关文件。However, needed fileserver wrappers are still under development</li>
</ul>
<p><br><br><br></p>
<h3 id="ROSTER"><a href="#ROSTER" class="headerlink" title="ROSTER"></a>ROSTER</h3><p>SALT SSH ROSTER</p>
<p>Salt中的 Roster(名册) System 允许轻松定义远程minion。<br>它是Salt中添加的可插拔系统，以促进 <code>salt-ssh</code> 系统。名册系统的创建是因为 <code>salt-ssh</code> 需要一种方法来确定哪些系统需要作为执行目标。</p>
<p>由于名册系统是可插拔的，因此可以轻松扩充到任何现有系统，以收集有关当前可用的服务器信息，并且通过 <code>salt-ssh</code> 附件。默认情况下，名册文件位于 <code>/etc/salt/roster</code>。</p>
<p>标准的Salt系统中不需要或不使用名册系统，因为Master了解目标Minion。</p>
<p><br></p>
<h4 id="Roster模块"><a href="#Roster模块" class="headerlink" title="Roster模块"></a>Roster模块</h4><p>链接: <a href="https://docs.saltstack.com/en/latest/ref/roster/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/roster/all/index.html</a></p>
<p><br><br><br></p>
<h4 id="如何工作"><a href="#如何工作" class="headerlink" title="如何工作"></a>如何工作</h4><p>HOW ROSTERS WORK</p>
<p>名册系统编译内部称为 <code>targets</code>(目标) 的数据结构。目标是关于如何连接到所述系统的目标的系统和属性的列表。Salt 名册系统的唯一要求是返回 <code>targets</code> 数据结构。</p>
<p><br></p>
<p><strong>TARGETS DATA</strong></p>
<p>可以存储在 Roster target 中的信息:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;Salt</span> <span class="string">ID&gt;:</span>       <span class="comment"># The id to reference the target system with</span></span><br><span class="line"><span class="attr">    host:</span>        <span class="comment"># The IP address or DNS name of the remote host</span></span><br><span class="line"><span class="attr">    user:</span>        <span class="comment"># The user to log in as</span></span><br><span class="line"><span class="attr">    passwd:</span>      <span class="comment"># The password to use for login, if omitted, keys are used</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optional parameters</span></span><br><span class="line"><span class="attr">    port:</span>        <span class="comment"># The target system's ssh port number</span></span><br><span class="line"><span class="attr">    sudo:</span>        <span class="comment"># Boolean to run command via sudo</span></span><br><span class="line"><span class="attr">    sudo_user:</span>   <span class="comment"># Str: Set this to execute Salt as a sudo user other than root.</span></span><br><span class="line">                 <span class="comment"># This user must be in the same system group as the remote user</span></span><br><span class="line">                 <span class="comment"># that is used to login and is specified above. Alternatively,</span></span><br><span class="line">                 <span class="comment"># the user must be a super-user.</span></span><br><span class="line"><span class="attr">    tty:</span>         <span class="comment"># Boolean: Set this option to True if sudo is also set to</span></span><br><span class="line">                 <span class="comment"># True and requiretty is also set on the target system</span></span><br><span class="line"><span class="attr">    priv:</span>        <span class="comment"># File path to ssh private key, defaults to salt-ssh.rsa</span></span><br><span class="line">                 <span class="comment"># The priv can also be set to agent-forwarding to not specify</span></span><br><span class="line">                 <span class="comment"># a key, but use ssh agent forwarding</span></span><br><span class="line"><span class="attr">    timeout:</span>     <span class="comment"># Number of seconds to wait for response when establishing</span></span><br><span class="line">                 <span class="comment"># an SSH connection</span></span><br><span class="line"><span class="attr">    minion_opts:</span> <span class="comment"># Dictionary of minion opts</span></span><br><span class="line"><span class="attr">    thin_dir:</span>    <span class="comment"># The target system's storage directory for Salt</span></span><br><span class="line">                 <span class="comment"># components. Defaults to /tmp/salt-&lt;hash&gt;.</span></span><br><span class="line"><span class="attr">    cmd_umask:</span>   <span class="comment"># umask to enforce for the salt-call command. Should be in</span></span><br><span class="line">                 <span class="comment"># octal (so for 0o077 in YAML you would do 0077, or 63)</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>TARGET DEFAULTS</strong></p>
<p>master配置中的 <code>roster_defaults</code> 字典用于为名单中的minion上设置默认登录变量，以便不需要使用命令行参数传递相同的参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">roster_defaults:</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">daniel</span></span><br><span class="line"><span class="attr">  sudo:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">  priv:</span> <span class="string">/root/.ssh/id_rsa</span></span><br><span class="line"><span class="attr">  tty:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>THIN_DIR</strong></p>
<p>Salt 需要将独立环境上载到目标系统，默认为 <code>/tmp/salt-&lt;hash&gt;</code>。每个正常的系统操作都将清理此目录。</p>
<p>如果你需要持久化的Salt环境，如设置持久化的grains，请记得修改此值。</p>
<p><br><br><br></p>
<h4 id="简单栗子"><a href="#简单栗子" class="headerlink" title="简单栗子"></a>简单栗子</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/salt/roster</span></span><br><span class="line"><span class="comment"># sudo NOPASSWD /etc/sudoers: fred ALL=(ALL) NOPASSWD: ALL</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker-ubuntu:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.5</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">ubuntu</span></span><br><span class="line"><span class="attr">  passwd:</span> <span class="string">ubuntu</span></span><br><span class="line"><span class="attr">  sudo:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">  thin_dir:</span> <span class="string">/etc/salt/roster-thin</span></span><br><span class="line"><span class="attr">docker-centos:</span></span><br><span class="line"><span class="attr">  host:</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line">  <span class="string">xxx</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="部署SSH-KEY"><a href="#部署SSH-KEY" class="headerlink" title="部署SSH KEY"></a>部署SSH KEY</h3><p>DEPLOY SSH KEY FOR SALT-SSH</p>
<p>默认情况下，<code>salt-ssh</code> 将为SSH生成秘钥对，默认路径为 <code>/etc/salt/pki/master/ssh/salt-ssh.rsa</code>。密钥生成发生在你第一次运行 <code>salt-ssh</code> 时。</p>
<p>你可以使用 <code>ssh-copy-id</code> (OpenSSH密钥部署工具) 将密钥部署到Server。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ssh-copy-id -i /etc/salt/pki/master/ssh/salt-ssh.rsa.pub user@server.demo.com</span></span><br><span class="line"></span><br><span class="line">ssh-copy-id -i /etc/salt/pki/master/ssh/salt-ssh.rsa.pub ubuntu@172.17.0.5</span><br></pre></td></tr></table></figure>
<p>你也可以写一个简单的脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$1</span> ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$0</span> user@host.com</span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">ssh-copy-id -i /etc/salt/pki/master/ssh/salt-ssh.rsa.pub <span class="variable">$1</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="调用SALT-SSH"><a href="#调用SALT-SSH" class="headerlink" title="调用SALT SSH"></a>调用SALT SSH</h3><p>CALLING SALT SSH</p>
<p><code>salt-ssh</code> 命令可以像 <code>salt</code> 命令一样轻松执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-ssh <span class="string">'*'</span> test.ping</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>RAW SHELL CALLS</strong></p>
<p>默认情况下，<code>salt-ssh</code> 在远程系统上运行 Salt 模块，但 <code>salt-ssh</code> 也可以执行 raw(原始) shell 命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-ssh <span class="string">'*'</span> -r <span class="string">'ifconfig'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="STATES-VIA-SALT-SSH"><a href="#STATES-VIA-SALT-SSH" class="headerlink" title="STATES VIA SALT SSH"></a>STATES VIA SALT SSH</h3><p>Salt State System也可以与 <code>salt-ssh</code> 一起使用。状态系统在 <code>salt-ssh</code> 中向用户提取与使用标准 <code>salt</code> 时相同的接口。目的是两者(<code>salt</code>, <code>salt-ssh</code>)可以无缝配合。</p>
<p><br><br><br></p>
<h3 id="TARGETING-WITH-SALT-SSH"><a href="#TARGETING-WITH-SALT-SSH" class="headerlink" title="TARGETING WITH SALT SSH"></a>TARGETING WITH SALT SSH</h3><p>由于 <code>salt-ssh</code> 中的定位方法不同，因此在撰写本文时仅支持 <code>glob</code> 和 <code>regex</code> 目标，其余的目标系统仍然需要实现。<br>默认情况下，可以通过 <code>salt-ssh</code>设置 Grains。默认情况下，这些 grains 不会在重新启动后持续存在。</p>
<p><br><br><br></p>
<h3 id="配置SALT-SSH"><a href="#配置SALT-SSH" class="headerlink" title="配置SALT SSH"></a>配置SALT SSH</h3><p>Salt SSH 在 Master Config 中配置。如果要使用自定义的配置文件，请使用 <code>-c</code> 选项传递。</p>
<p><br><br><br></p>
<h3 id="非特权用户运行-1"><a href="#非特权用户运行-1" class="headerlink" title="非特权用户运行"></a>非特权用户运行</h3><p>RUNNING SALT SSH AS NON-ROOT USER</p>
<p>默认情况下，Salt 从 <code>/etc/salt/</code> 读取所有配置。如果使用 普通用户运行 Salt SSH，则可能报 <code>Permission denied</code> 错误，因此需要修改文件权限。</p>
<p>不建议对 Salt SSH 修改 <code>/etc/salt/</code> 的权限，而是复制它们作为副本，通过 <code>-c</code> 来指定。当然，如果你的SaltStack本就以普通用户运行，则可以直接使用这个用户。</p>
<p><br><br><br></p>
<h3 id="定义CLI选项"><a href="#定义CLI选项" class="headerlink" title="定义CLI选项"></a>定义CLI选项</h3><p>DEFINE CLI OPTIONS WITH SALTFILE</p>
<p>如果您通常将CLI选项传递给 <code>salt-ssh</code>，则可以创建Saltfile以自动使用这些选项。<br>因此，你可在Saltfile目录中编写内容:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">salt-ssh:</span></span><br><span class="line"><span class="attr">  config_dir:</span> <span class="string">path/to/config/dir</span></span><br><span class="line"><span class="attr">  ssh_max_procs:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">  ssh_wipe:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-SYNDIC"><a href="#SALT-SYNDIC" class="headerlink" title="SALT-SYNDIC"></a>SALT-SYNDIC</h2><p>Salt syndic 守护进程，一个通过高级Master的命令的特殊Minion。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-syndic [ options ]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-UNITY"><a href="#SALT-UNITY" class="headerlink" title="SALT-UNITY"></a>SALT-UNITY</h2><p>围绕其它 Salt CLI 脚本的统一调用包装器。<br>此脚本接受一个参数，该参数是其它 Salt CLI 脚本之一并调用该脚本。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-unity salt <span class="string">'*'</span> test.ping</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SALT-API"><a href="#SALT-API" class="headerlink" title="SALT-API"></a>SALT-API</h2><p>用于远程连接 Salt Master 的接口。<br>Salt API系统管理Salt Master的网络API连接器。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-api - salt-api Command</span></span><br><span class="line"><span class="comment"># Start interfaces used to remotely connect to the salt master</span></span><br><span class="line"><span class="comment"># The Salt API system manages network API connectors for the Salt Master</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">salt-api [options]</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="SPM"><a href="#SPM" class="headerlink" title="SPM"></a>SPM</h2><p>Salt Package Manager<br>spm是用于管理Salt包的前端命令。软件包通常只包含公式，表示安装在 Salt Master 上的 <code>file_roots</code> 中的一组SLS文件，但也可以安装Salt模块。</p>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spm - Salt Package Manager Command</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 语法</span></span><br><span class="line">spm [options] &lt;<span class="keyword">function</span>&gt; &lt;argument&gt;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="模块参考"><a href="#模块参考" class="headerlink" title="模块参考"></a>模块参考</h1><p>SALT MODULE REFERENCE</p>
<p>以下包含用于扩展Salt中各种子系统的Python Module 的列表。</p>
<ul>
<li><strong>auth modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/auth/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/auth/all/index.html</a></li>
<li><strong>beacon modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/beacons/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/beacons/all/index.html</a></li>
<li><strong>Cache Modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/cache/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/cache/all/index.html</a></li>
<li><strong>cloud modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/clouds/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/clouds/all/index.html</a></li>
<li><strong>engine modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/engines/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/engines/all/index.html</a></li>
<li><strong>executors modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/executors/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/executors/all/index.html</a></li>
<li><strong>fileserver modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/file_server/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/file_server/all/index.html</a></li>
<li><strong>grains modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/grains/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/grains/all/index.html</a></li>
<li><strong>execution modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/modules/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/modules/all/index.html</a></li>
<li><strong>netapi modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/netapi/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/netapi/all/index.html</a></li>
<li><strong>output modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/output/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/output/all/index.html</a></li>
<li><strong>pillar modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/pillar/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/pillar/all/index.html</a></li>
<li><strong>proxy modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/proxy/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/proxy/all/index.html</a></li>
<li><strong>queue modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/queues/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/queues/all/index.html</a></li>
<li><strong>renderer modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/renderers/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/renderers/all/index.html</a></li>
<li><strong>returner modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/returners/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/returners/all/index.html</a></li>
<li><strong>roster modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/roster/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/roster/all/index.html</a></li>
<li><strong>runner modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/runners/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/runners/all/index.html</a></li>
<li><strong>sdb modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/sdb/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/sdb/all/index.html</a></li>
<li><strong>serializer modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/serializers/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/serializers/all/index.html</a></li>
<li><strong>state modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/states/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/states/all/index.html</a></li>
<li><strong>thorium modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/thorium/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/thorium/all/index.html</a></li>
<li><strong>master tops modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/tops/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/tops/all/index.html</a></li>
<li><strong>wheel modules</strong>: <a href="https://docs.saltstack.com/en/latest/ref/wheel/all/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/wheel/all/index.html</a></li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="APIs"><a href="#APIs" class="headerlink" title="APIs"></a>APIs</h1><p><br></p>
<h2 id="客户端API"><a href="#客户端API" class="headerlink" title="客户端API"></a>客户端API</h2><p>Python client API</p>
<p>docs: <a href="https://docs.saltstack.com/en/latest/ref/clients/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/ref/clients/index.html</a></p>
<p><br><br><br><br><br></p>
<h2 id="netapi模块"><a href="#netapi模块" class="headerlink" title="netapi模块"></a>netapi模块</h2><p>docs: <a href="https://docs.saltstack.com/en/latest/topics/netapi/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/netapi/index.html</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p>ARCHITECTURE</p>
<p>如果你习惯于在安装任何内容之前规划一个细节的配置管理工具。使用Salt，你可以随时切换到高可用系统结构，并田间其它组件以随时扩展部署。</p>
<p>由于 Single Salt Master 可以管理成千上万个系统，因此我们通常建议您首先部署 Single Salt Master，然后根据需要修改部署以实现 冗余，地理分布和扩展。</p>
<p><br><br><br></p>
<h2 id="高可用功能"><a href="#高可用功能" class="headerlink" title="高可用功能"></a>高可用功能</h2><p>HIGH AVAILABILITY FEATURES IN SALT</p>
<p>Salt支持多种功能，可实现高可用性和容错性。</p>
<p><br></p>
<h3 id="MULTIMASTER"><a href="#MULTIMASTER" class="headerlink" title="MULTIMASTER"></a>MULTIMASTER</h3><p>通过将 minion config 中的 master配置项配置为所有可用Master设备的YAML 列表，Salt Minion可以一次性连接到多个主设备。</p>
<p>在多主配置中，每个Master必须具有相同的加密秘钥(cryptographic keys)，并且必须分别在所有Master上接受 Minion Keys。<code>file_roots</code> 和 <code>pillar_roots</code> 的内容也需要与Salt外部的进程保持同步，这个可使用网络挂载。</p>
<p><br><br><br></p>
<h3 id="MULTIMASTER-WITH-FAILOVER"><a href="#MULTIMASTER-WITH-FAILOVER" class="headerlink" title="MULTIMASTER WITH FAILOVER"></a>MULTIMASTER WITH FAILOVER</h3><p>将 <code>master_type</code> 参数从 <code>str</code> 修改为 <code>failover</code>(故障转移) 将导致 Minion 连接到Master列表中的第一个响应的 Master Server。每个 <code>master_alive_interval</code> 的秒数都会检查 Minion 以确保当前的Master仍在响应。如果Master没有响应，则Minion将尝试连接到列表中的下一个Master。如果列表中的Master都用尽了，那么该列表将被回收，以防止之前响应故障的Master又恢复。请注意，<code>master_alive_interval</code> 必须存在于minion配置中，否则将无法调度检查主状态的定期作业。</p>
<p><code>master_type: failover</code> 可与 <code>master_shuffle: True</code> 结合使用，以在所有Master上传播Minion连接。</p>
<p>将 Salt Syndic 添加到混合中可以创建负载均衡的Salt基础架构。如果一个Master失败，Minion会注意到并从可用列中表选择另一个Master。</p>
<p><br><br><br></p>
<h3 id="SYNDIC"><a href="#SYNDIC" class="headerlink" title="SYNDIC"></a>SYNDIC</h3><p><strong>Salt Syndic</strong> 功能是一种创建不同基础架构拓扑的方法。它不是严格意义上的HA功能，但可以这样看待它。</p>
<p>使用 Syndic， Salt基础架构可以以某种方式进行分区，使得主控制器控制基础结构的某些部分。</p>
<p><br><br><br></p>
<h3 id="SYNDIC-WITH-MULTIMASTER"><a href="#SYNDIC-WITH-MULTIMASTER" class="headerlink" title="SYNDIC WITH MULTIMASTER"></a>SYNDIC WITH MULTIMASTER</h3><p><strong>Syndic with Multimaster</strong> 允许您连接一个 Syndic 到多个主，以便在syndic配置中提供额外的冗余层。</p>
<p><br><br><br><br><br></p>
<h2 id="SALT-SYNDIC-1"><a href="#SALT-SYNDIC-1" class="headerlink" title="SALT SYNDIC"></a>SALT SYNDIC</h2><p>最基本的Salt拓扑结构由控制一组Minion节点的单个Master节点组成。使用称为Syndic的中间节点类型在构建Salt拓扑时提供了比仅由Master和Minion节点类型构造的拓扑更大的结构灵活性和可伸缩性。</p>
<p>一个 Syndic 节点可被认为是一个特殊的直通(passthrough)Minion节点。Syndic 节点是由 <code>salt-syndic</code> 守护进程和在同一系统上运行的 <code>salt-master</code> 守护进程组成。在 Syndic 节点上运行的 <code>salt-master</code> 用于控制一组较低级别的Minion节点，<code>salt-syndic</code> 连接较高级别的Master节点。有时称之为 <strong>Master of Master</strong>。</p>
<p><code>salt-syndic</code> 守护进程在Master节点和本地 <code>salt-mastr</code> 守护进程之间中继(relay) 发布和事件。这使Master节点可以控制连接到Syndic节点上运行的 <code>salt-master</code> 守护程序的Minion节点。</p>
<p>这个功能我个人感觉有点像 多级Salt-Master-Minion。多级情况下，<code>salt-syndic</code>去控制下级Master，<code>salt-master</code>控制Minion。</p>
<p><br></p>
<h3 id="配置Syndic"><a href="#配置Syndic" class="headerlink" title="配置Syndic"></a>配置Syndic</h3><p>要配置 Salt Syndic，您需要告诉 Syndic节点 及其 Master节点 关于它们彼此。<br>每个Syndic都必须提供自己的 <code>file_roots</code> 目录。文件不会自动从主节点传输。</p>
<p>假如您的Master几点位于<code>10.10.0.1</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/salt/master</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If this master will be running a salt syndic daemon, syndic_master tells</span></span><br><span class="line"><span class="comment"># this master where to receive commands from.</span></span><br><span class="line"><span class="attr">syndic_master:</span> <span class="number">10.10</span><span class="number">.0</span><span class="number">.1</span>  <span class="comment"># may be either an IP address or a hostname</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the order_masters setting to True if this master will command lower</span></span><br><span class="line"><span class="comment"># masters' syndic interfaces.</span></span><br><span class="line"><span class="attr">order_masters:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/salt/minion</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># id is shared by the salt-syndic daemon and a possible salt-minion daemon</span></span><br><span class="line"><span class="comment"># on the Syndic node</span></span><br><span class="line"><span class="attr">id:</span> <span class="string">my_syndic</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="多主Syndic配置"><a href="#多主Syndic配置" class="headerlink" title="多主Syndic配置"></a>多主Syndic配置</h3><p>CONFIGURING THE SYNDIC WITH MULTIMASTER</p>
<p>使用 MultiMaster 的 Syndic 可以将 Syndic连接到多个Master，以便提供额外的冗余层。</p>
<p>首先应该在多主配置中配置更高级的Master。<br>在Syndic上， <code>syndic_master</code>选项提供了更高级别的Master的列表。</p>
<p>由于每个Syndic都连接到每个Master，因此从任何Master发送的作业都会转发给连接到每个Syndic的Minions。</p>
<p><br><br><br></p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p><code>salt-syndic</code> 守护进程是一个单独的进程，除了在Syndic节点上运行的 <code>salt-master</code> 守护进程之外，还需要启动它。Master节点在许多方面将Syndic视为普通的Minion节点。尤其是，Master需要去接受Syndic的Minion Key，就像其它Minion一样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">systemctl start salt-syndic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"></span><br><span class="line">service salt-syndic start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接受key</span></span><br><span class="line">salt-key -a my_syndic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">salt <span class="string">'*'</span> test.ping</span><br><span class="line">minion_1:</span><br><span class="line">  True</span><br><span class="line">minion_2:</span><br><span class="line">  True</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Master节点现在可以控制连接到Syndic的Minion节点。</p>
<p><br><br><br></p>
<h3 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h3><p>TOPOLOGY</p>
<ul>
<li>Master节点必须运行<code>salt-master</code>守护进程</li>
<li>Syndic节点必须运行<code>salt-master</code>, <code>salt-syndic</code>守护进程</li>
<li>Minion节点必须运行<code>salt-minion</code>守护进程</li>
<li><code>salt-master</code> 守护进程发出命令时，它将被直接连接到它的Syndic和Minion节点接收<ul>
<li>Minion节点将以通常的方式处理命令</li>
<li>在Syndic节点上，<code>salt-syndic</code>守护进程将该命令中继到<code>salt-master</code>守护进程，然后该节点将命令传播到与其连接的Minion和Syndic</li>
</ul>
</li>
<li>当<code>salt-master</code>守护进程生成事件和作业返回数据时，它们由它们所连接的<code>salt-master</code>守护进程聚合，然后<code>salt-master</code>通过其<code>salt-syndic</code>守护进程将数据中继回来，直到数据到达Master节点或发出命令的Syndic节点</li>
</ul>
<p><br><br><br></p>
<h3 id="SYNDIC-WAIT"><a href="#SYNDIC-WAIT" class="headerlink" title="SYNDIC WAIT"></a>SYNDIC WAIT</h3><p><code>syndic_wait</code> 是一个master config设置，它指定Salt Client 在放弃之前应等待其它Syndic检查其预期的minions列表的秒数。这个值默认为5s。</p>
<p><code>syndic_wait</code> 是必要的，因为 Higher-Level Mater 没有办法知道 Syndic 下面的 Minions。更高级别的Master有自己的Minion列表，它们下面的Master也有自己的列表，所以Salt Client没有等待所有返回的时间。<code>syndic_wait</code> 选项允许所有Minion返回Salt Client的时间。</p>
<p><br><br><br></p>
<h3 id="Syndic配置项"><a href="#Syndic配置项" class="headerlink" title="Syndic配置项"></a>Syndic配置项</h3><p>除了<code>id</code>之外，所有配置项都在Syndic节点的Master config中:</p>
<ul>
<li><code>id</code>: Syndic id (shared by the <code>salt-syndic</code> daemon with a potential <code>salt-minion</code> daemon on the same system)</li>
<li><code>syndic_master</code>: Master node IP address or hostname</li>
<li><code>syndic_master_port</code>: Master node ret_port</li>
<li><code>syndic_log_file</code>: path to the logfile (absolute or not)</li>
<li><code>syndic_pidfile</code>: path to the pidfile (absolute or not)</li>
<li><code>syndic_wait</code>: time in seconds to wait on returns from this syndic</li>
</ul>
<p><br><br><br></p>
<h3 id="Minion数据缓存"><a href="#Minion数据缓存" class="headerlink" title="Minion数据缓存"></a>Minion数据缓存</h3><p>MINION DATA CACHE</p>
<p><strong>Minion数据缓存</strong> 包含Salt Master数据，Minion Grains 和 缓存在Master上的Minion Pillars。默认情况下，Salt使用<code>localfs</code>缓存模块，但可使用其它外部数据存储。</p>
<p><br><br><br><br><br></p>
<h2 id="有规模的使用salt"><a href="#有规模的使用salt" class="headerlink" title="有规模的使用salt"></a>有规模的使用salt</h2><p>USING SALT AT SCALE</p>
<p>本节的重点是构建一个Salt基础架构来处理大量的Minions。</p>
<blockquote>
<p>注意:<br>本章节适用于大型安装，虽然这些相同的设置并不会有伤害，但小型安装可能并不值得。<br>当与Minions一起使用时，术语<strong>许多(many)</strong>指的是至少一千个；术语<strong>少数(a few)</strong>总是指500个。<br>为简单起见，本章节将默认使用Salt使用的标准端口。</p>
</blockquote>
<p><br></p>
<h3 id="The-Master"><a href="#The-Master" class="headerlink" title="The Master"></a>The Master</h3><p>Salt Master最常见的问题是:</p>
<ul>
<li>too many minions authing at once</li>
<li>too many minions re-authing at once</li>
<li>too many minions re-connecting at once</li>
<li>too many minions returning at once</li>
<li>too few resources (CPU/DISK)</li>
</ul>
<p>前三个问题是<strong>雷鸣般的一群</strong>(thundering herd)。为了缓解这些问题，我们必须配置在Master高负载时适当地退回Minion。<br>第四个问题是有拥有少量硬件资源的Master和ZeroMQ中可能存在的Bug引起的。</p>
<p><br></p>
<p>要理解每个问题，重要的是要了解Salt的工作原理。<br>简而言之，Salt Master为Minion提供两种服务:</p>
<ul>
<li>作业发布者(job publisher)在端口4505上</li>
<li>开放端口4506接受Minion的返回</li>
</ul>
<p>所有Minion始终在端口4505上连接到Publisher，并且如果需要，仅连接到打开的返回端口4506。在空闲的Master上，端口4505上只有连接。</p>
<p><br></p>
<p><strong>TOO MANY MINIONS AUTHING</strong></p>
<p>当Minion服务首次启动时，它将通过端口4505连接到Master的Publisher。如果同时启动 too many minions，这可能会导致<strong>thundering herd</strong>。这可以通过不同时启动 too many minions 来避免。</p>
<p>连接本身通常不是罪魁祸首，主要问题的原因更可能是Master端关于使用Master对Minion进行认证。如果Master负载过重而无法处理身份认证请求，则将其计时。然后Minion将等待 <code>acceptance_wait_time</code> 时间进行重试。如果设置了 <code>acceptance_wait_time_max</code>， 那么Minion将在每次后续重试之前通过 <code>acceptance_wait_time</code> 增加其等待时间，知道达到 <code>acceptance_wait_time_max</code>。</p>
<p><br></p>
<p><strong>TOO MANY MINIONS RE-AUTHING</strong></p>
<p>这很有可能发生在Salt部署的测试阶段，当所有Minion keys 都已被接受，但框架正在测试，并且参数在Salt Master Config 中经常更改。</p>
<p>Salt Master生成一个新的 AES key，用于某些事件加密其发布。如果遇到此问题，请删除(<code>salt-key -d</code>)对应 minion key 之后重新接受(<code>salt-key -a</code>)它。</p>
<p>当Master生成新的 AES key时，不会通知Minion，但会在它们收到下一个 发布作业(pub job) 中发现它。当Minion收到这样的作业后，它将与Master重新认证。由于Salt进行了Minion过滤(也就是未认证的不行)，这意味所有的Minion都会在Master下发布的下一个命令上重新认证——这就导致了另一个 thundering herd 。这可以通过以下设置来避免:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 minion config 中配置更高的值并错开重新认证尝试的数量</span></span><br><span class="line"><span class="attr">random_reauth_delay:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>TOO MANY MINIONS RE-CONNECTING</strong></p>
<p>例如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">salt * disk.usage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用salt batch模式可避免此问题</span></span><br><span class="line"><span class="comment"># 以下限制为50个minion</span></span><br><span class="line">salt * disk.usage -b 50</span><br></pre></td></tr></table></figure>
<p>它可能导致成千上万的Minion试图将它们的结果返回到Master的开放端口4506.如果Master无法立即处理那么多返回，也会导致大量的 syn flood。</p>
<p><br><br><br></p>
<h3 id="资源太少"><a href="#资源太少" class="headerlink" title="资源太少"></a>资源太少</h3><p>TOO FEW RESOURCES</p>
<p>Master资源总是应该与Master运行的环境相匹配。所以，随着Minion的不断增加，也要考虑Master的资源问题。</p>
<p><br></p>
<p><strong>THE MASTER IS CPU BOUND</strong></p>
<p><br></p>
<p><strong>THE MASTER IS DISK IO BOUND</strong></p>
<ul>
<li>USE AND EXTERNAL JOB CACHE</li>
<li>DISABLE THE JOB CACHE(非常不建议)</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="Multi-Master"><a href="#Multi-Master" class="headerlink" title="Multi Master"></a>Multi Master</h2><p><strong>多主(Multi Master)</strong> 允许Salt Minion连接到冗余，并促进多个通信点的Minion。当使用多主设置时，所有Master都在热状态，并且任何活跃的Master都可用于向Minion发送命令。</p>
<p>如果你需要多主的故障转移(failover)，还可使用 MultiMaster-PKI配置。</p>
<p>Master间不共享信息，并且需要在多个Master接受keys。并且需要共享文件或使用git fileserver后端/网络文件系统来保持 <code>file_roots</code> 的一致性。<br>使用可插入的minion cache modules允许存储在Master上的关于Minion的数据被复制到Minion所连接的其它Master上。</p>
<p><br></p>
<h3 id="步骤概要"><a href="#步骤概要" class="headerlink" title="步骤概要"></a>步骤概要</h3><ol>
<li>Create a redundant master server</li>
<li>Copy primary master key to redundant master</li>
<li>Start redundant master</li>
<li>Configure minions to connect to redundant master</li>
<li>Restart minions</li>
<li>Accept keys on redundant master</li>
</ol>
<p><br><br><br></p>
<h3 id="准备冗余Master"><a href="#准备冗余Master" class="headerlink" title="准备冗余Master"></a>准备冗余Master</h3><p>PREPPING A REDUNDANT MASTER</p>
<blockquote>
<p>注意:<br>并没有冗余Master的逻辑上的限制</p>
</blockquote>
<p>第一项任务是准备冗余Master。如果冗余Mater已在运行，请停止它。只要一个要求，即Master间共享相同的私钥。创建第一个Master时，会生成Master的key pair并放置在Master端的<code>pki_dir</code>目录下(默认为: <code>/etc/salt/pki/master/</code>)。请保持各个Master秘钥相同。</p>
<ul>
<li><code>master.pem</code>，私钥</li>
<li><code>master.pub</code>，公钥</li>
</ul>
<p><br><br><br></p>
<h3 id="配置Minion"><a href="#配置Minion" class="headerlink" title="配置Minion"></a>配置Minion</h3><p>由于Minion需要掌握Master相关信息，因此需要将新的Master添加到Minion Config中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">master:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">saltmaster1.example.com</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">saltmaster2.example.com</span></span><br></pre></td></tr></table></figure>
<p>之后，重启Minion服务。</p>
<p><br><br><br></p>
<h3 id="在Master间共享文件"><a href="#在Master间共享文件" class="headerlink" title="在Master间共享文件"></a>在Master间共享文件</h3><p>SHARING FILES BETWEEN MASTERS</p>
<p>Salt不会自动在Master之间共享文件。不建议各个Master之间存在差异，强烈建议共享这些文件，解决一致性问题。者可以使用网络文件系统或git fileserver后端。</p>
<ul>
<li>minion key</li>
<li>file_roots</li>
<li>pillar_roots</li>
<li>master config</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="具有故障转移的Multi-PKI-Master"><a href="#具有故障转移的Multi-PKI-Master" class="headerlink" title="具有故障转移的Multi-PKI-Master"></a>具有故障转移的Multi-PKI-Master</h2><p>MULTI-MASTER-PKI TUTORIAL WITH FAILOVER</p>
<blockquote>
<p>请注意，建议先熟悉salt-authentication和communication以了解本节。此处描述的所有设置都在默认的身份认证/通信过程之上。</p>
</blockquote>
<p>本节将解释如何运行salt-environment，当Minion当前Master失败时在它们之间进行故障转移。</p>
<p>各个步骤是:</p>
<ul>
<li>setup the master(s) to sign its auth-replies</li>
<li>setup minion(s) to verify master-public-keys</li>
<li>enable multiple masters on minion(s)</li>
<li>enable master-check on minion(s)</li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="Minion数据缓存-1"><a href="#Minion数据缓存-1" class="headerlink" title="Minion数据缓存"></a>Minion数据缓存</h1><p>MINION DATA CACHE</p>
<p>Minion数据缓存在Salt Master上包含了 Salt Mine data， Minion grains， Minion Pillar。默认情况下，Salt使用 <code>localfs</code> 缓存模块将数据保存在Salt Master上的<code>msgpack</code>文件中。</p>
<p><br></p>
<h2 id="缓存模块"><a href="#缓存模块" class="headerlink" title="缓存模块"></a>缓存模块</h2><p>CACHE MODULES</p>
<p>缓存模块如下:</p>
<table>
<thead>
<tr>
<th><code>consul</code></th>
<th>Minion data cache plugin for Consul key/value data store.</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>etcd_cache</code></td>
<td>Minion data cache plugin for Etcd key/value data store.</td>
</tr>
<tr>
<td><code>localfs</code></td>
<td>Cache data in filesystem.</td>
</tr>
<tr>
<td><code>mysql_cache</code></td>
<td>Minion data cache plugin for MySQL database.</td>
</tr>
<tr>
<td><code>redis_cache</code></td>
<td>Redis</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h2 id="可插拔数据缓存"><a href="#可插拔数据缓存" class="headerlink" title="可插拔数据缓存"></a>可插拔数据缓存</h2><p>PLUGGABLE DATA CACHE</p>
<p>虽然默认的Minion数据缓存是 <code>localfs</code> 缓存，但其它外部数据存储也可用于存储此数据，如 <code>consul</code> 模块。Salt Master 配置如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cache:</span> <span class="string">consul</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="配置Minion数据缓存"><a href="#配置Minion数据缓存" class="headerlink" title="配置Minion数据缓存"></a>配置Minion数据缓存</h2><p>CONFIGURING THE MINION DATA CACHE</p>
<p>默认的 <code>localfs</code> Minion数据缓存不需要任何配置。具有外部数据缓存模块需要在Master上进行配置。</p>
<p>这是一个Consul的栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">consul.host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="string">consul.port:</span> <span class="number">8500</span></span><br><span class="line"><span class="string">consul.token:</span> <span class="string">None</span></span><br><span class="line"><span class="string">consul.scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="string">consul.consistency:</span> <span class="string">default</span></span><br><span class="line"><span class="string">consul.dc:</span> <span class="string">dc1</span></span><br><span class="line"><span class="string">consul.verify:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span> <span class="string">consul</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="Salt开发"><a href="#Salt开发" class="headerlink" title="Salt开发"></a>Salt开发</h1><p>DEVELOPING SALT</p>
<p>docs: <a href="https://docs.saltstack.com/en/latest/topics/development/index.html" target="_blank" rel="noopener">https://docs.saltstack.com/en/latest/topics/development/index.html</a></p>
<p><br></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SaltStack/" rel="tag"># SaltStack</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/11/数据结构/" rel="next" title="数据结构">
                <i class="fa fa-chevron-left"></i> 数据结构
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/26/Ansible/" rel="prev" title="Ansible">
                Ansible <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/leslie.jpg"
              alt="Zhang21" />
          
            <p class="site-author-name" itemprop="name">Zhang21</p>
            <p class="site-description motion-element" itemprop="description">踏踏实实谋发展</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">81</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">130</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/f13278e94ecb" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-circle-o"></i>简书</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:elite_zhang21@163.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#说明"><span class="nav-number">1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#词汇表"><span class="nav-number">2.</span> <span class="nav-text">词汇表</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">3.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number">4.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#快速安装"><span class="nav-number">4.1.</span> <span class="nav-text">快速安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#指定平台"><span class="nav-number">4.2.</span> <span class="nav-text">指定平台</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CentOS7"><span class="nav-number">4.2.1.</span> <span class="nav-text">CentOS7</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化"><span class="nav-number">4.3.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置salt"><span class="nav-number">4.3.1.</span> <span class="nav-text">配置salt</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#salt-master"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">salt-master</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#salt-minion"><span class="nav-number">4.3.1.2.</span> <span class="nav-text">salt-minion</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#minion代理配置"><span class="nav-number">4.3.1.3.</span> <span class="nav-text">minion代理配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行Salt"><span class="nav-number">4.3.1.4.</span> <span class="nav-text">运行Salt</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#密钥识别"><span class="nav-number">4.3.1.5.</span> <span class="nav-text">密钥识别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#密钥管理"><span class="nav-number">4.3.1.6.</span> <span class="nav-text">密钥管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送命令"><span class="nav-number">4.3.1.7.</span> <span class="nav-text">发送命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其它安装指南"><span class="nav-number">4.4.</span> <span class="nav-text">其它安装指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Salt-Bootstrap"><span class="nav-number">4.4.1.</span> <span class="nav-text">Salt Bootstrap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#栗子"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">栗子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防火墙"><span class="nav-number">4.4.2.</span> <span class="nav-text">防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Preseed-minion-with-accepted-key"><span class="nav-number">4.4.3.</span> <span class="nav-text">Preseed minion with accepted key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#以普通用户运行root"><span class="nav-number">4.4.4.</span> <span class="nav-text">以普通用户运行root</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#minion独立运行"><span class="nav-number">4.4.5.</span> <span class="nav-text">minion独立运行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#minion配置"><span class="nav-number">4.4.5.1.</span> <span class="nav-text">minion配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Salt无主模式"><span class="nav-number">4.4.6.</span> <span class="nav-text">Salt无主模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置"><span class="nav-number">5.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#master"><span class="nav-number">5.1.</span> <span class="nav-text">master</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#master配置项"><span class="nav-number">5.1.1.</span> <span class="nav-text">master配置项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#salt-ssh"><span class="nav-number">5.1.2.</span> <span class="nav-text">salt-ssh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全配置"><span class="nav-number">5.1.3.</span> <span class="nav-text">安全配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#大规模调整设置"><span class="nav-number">5.1.4.</span> <span class="nav-text">大规模调整设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模块管理"><span class="nav-number">5.1.5.</span> <span class="nav-text">模块管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统状态设置"><span class="nav-number">5.1.6.</span> <span class="nav-text">系统状态设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件服务器设置"><span class="nav-number">5.1.7.</span> <span class="nav-text">文件服务器设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地文件服务器"><span class="nav-number">5.1.8.</span> <span class="nav-text">本地文件服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#git远程文件服务器后端"><span class="nav-number">5.1.9.</span> <span class="nav-text">git远程文件服务器后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gitfs认证项"><span class="nav-number">5.1.10.</span> <span class="nav-text">gitfs认证项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hgfs远程文件服务器后端"><span class="nav-number">5.1.11.</span> <span class="nav-text">hgfs远程文件服务器后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#svnfs远程文件服务器后端"><span class="nav-number">5.1.12.</span> <span class="nav-text">svnfs远程文件服务器后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#minions远程文件服务器后端"><span class="nav-number">5.1.13.</span> <span class="nav-text">minions远程文件服务器后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#azurefs文件服务器后端"><span class="nav-number">5.1.14.</span> <span class="nav-text">azurefs文件服务器后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#S3文件服务器后端"><span class="nav-number">5.1.15.</span> <span class="nav-text">S3文件服务器后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pillar配置"><span class="nav-number">5.1.16.</span> <span class="nav-text">pillar配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reactor设置"><span class="nav-number">5.1.17.</span> <span class="nav-text">reactor设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#salt-api设置"><span class="nav-number">5.1.18.</span> <span class="nav-text">salt-api设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#syndic服务器"><span class="nav-number">5.1.19.</span> <span class="nav-text">syndic服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#peer-publish"><span class="nav-number">5.1.20.</span> <span class="nav-text">peer publish</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志"><span class="nav-number">5.1.21.</span> <span class="nav-text">日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NODE-GROUPS"><span class="nav-number">5.1.22.</span> <span class="nav-text">NODE GROUPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件路径"><span class="nav-number">5.1.23.</span> <span class="nav-text">文件路径</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#minion"><span class="nav-number">5.2.</span> <span class="nav-text">minion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#proxy-minion"><span class="nav-number">5.3.</span> <span class="nav-text">proxy minion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#栗子配置文件"><span class="nav-number">5.4.</span> <span class="nav-text">栗子配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#minion-blackout"><span class="nav-number">5.5.</span> <span class="nav-text">minion blackout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问控制系统"><span class="nav-number">5.6.</span> <span class="nav-text">访问控制系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么时候使用每个认证系统"><span class="nav-number">5.6.1.</span> <span class="nav-text">什么时候使用每个认证系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Publisher-ACL"><span class="nav-number">5.6.2.</span> <span class="nav-text">Publisher ACL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PERMISSION-ISSUES"><span class="nav-number">5.6.2.1.</span> <span class="nav-text">PERMISSION ISSUES</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#白-黑名单"><span class="nav-number">5.6.2.2.</span> <span class="nav-text">白/黑名单</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#External-Authentication"><span class="nav-number">5.6.3.</span> <span class="nav-text">External Authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#eAuth配置"><span class="nav-number">5.6.3.1.</span> <span class="nav-text">eAuth配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#匹配语法"><span class="nav-number">5.6.3.1.1.</span> <span class="nav-text">匹配语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GROUPS"><span class="nav-number">5.6.3.1.2.</span> <span class="nav-text">GROUPS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过函数参数来限制"><span class="nav-number">5.6.3.1.3.</span> <span class="nav-text">通过函数参数来限制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用法"><span class="nav-number">5.6.3.2.</span> <span class="nav-text">用法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TOKENS"><span class="nav-number">5.6.3.2.1.</span> <span class="nav-text">TOKENS</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LDAP和AD"><span class="nav-number">5.6.3.3.</span> <span class="nav-text">LDAP和AD</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#OPENLDAP和类似的系统"><span class="nav-number">5.6.3.3.1.</span> <span class="nav-text">OPENLDAP和类似的系统</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Peer-Communication"><span class="nav-number">5.6.4.</span> <span class="nav-text">Peer Communication</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-1"><span class="nav-number">5.6.4.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PEER-RUNNER"><span class="nav-number">5.6.4.2.</span> <span class="nav-text">PEER RUNNER</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用对等通信"><span class="nav-number">5.6.4.3.</span> <span class="nav-text">使用对等通信</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#作业管理"><span class="nav-number">5.7.</span> <span class="nav-text">作业管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Minion-Proc系统"><span class="nav-number">5.7.1.</span> <span class="nav-text">Minion Proc系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#saltutil模块中的函数"><span class="nav-number">5.7.2.</span> <span class="nav-text">saltutil模块中的函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JOB-RUNNER"><span class="nav-number">5.7.3.</span> <span class="nav-text">JOB RUNNER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调度作业"><span class="nav-number">5.7.4.</span> <span class="nav-text">调度作业</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#按时间和日期调度"><span class="nav-number">5.7.4.1.</span> <span class="nav-text">按时间和日期调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#最大并行工作"><span class="nav-number">5.7.4.2.</span> <span class="nav-text">最大并行工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类似定时任务的调度"><span class="nav-number">5.7.4.3.</span> <span class="nav-text">类似定时任务的调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#作业数据返回"><span class="nav-number">5.7.4.4.</span> <span class="nav-text">作业数据返回</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JOB-METADATA"><span class="nav-number">5.7.4.5.</span> <span class="nav-text">JOB METADATA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动时运行"><span class="nav-number">5.7.4.6.</span> <span class="nav-text">启动时运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UNTIL-AFTER"><span class="nav-number">5.7.4.7.</span> <span class="nav-text">UNTIL/AFTER</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调度状态"><span class="nav-number">5.7.4.8.</span> <span class="nav-text">调度状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高峰调度"><span class="nav-number">5.7.4.9.</span> <span class="nav-text">高峰调度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理作业缓存"><span class="nav-number">5.8.</span> <span class="nav-text">管理作业缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#默认作业缓存"><span class="nav-number">5.8.1.</span> <span class="nav-text">默认作业缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在外部系统中存储作业结果"><span class="nav-number">5.9.</span> <span class="nav-text">在外部系统中存储作业结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EXTERNAL-JOB-CACHE-MINION-SIDE-RETURNER"><span class="nav-number">5.9.1.</span> <span class="nav-text">EXTERNAL JOB CACHE - MINION-SIDE RETURNER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MASTER-JOB-CACHE-MASTER-SIDE-RETURNER"><span class="nav-number">5.9.2.</span> <span class="nav-text">MASTER JOB CACHE - MASTER-SIDE RETURNER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置两种机制"><span class="nav-number">5.9.3.</span> <span class="nav-text">配置两种机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志-1"><span class="nav-number">5.10.</span> <span class="nav-text">日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#日志级别"><span class="nav-number">5.10.1.</span> <span class="nav-text">日志级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志配置"><span class="nav-number">5.10.2.</span> <span class="nav-text">日志配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#外部日志处理器"><span class="nav-number">5.10.3.</span> <span class="nav-text">外部日志处理器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件服务器"><span class="nav-number">5.11.</span> <span class="nav-text">文件服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件系统后端"><span class="nav-number">5.11.1.</span> <span class="nav-text">文件系统后端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从特定环境请求文件"><span class="nav-number">5.11.2.</span> <span class="nav-text">从特定环境请求文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件系统配置"><span class="nav-number">5.11.3.</span> <span class="nav-text">文件系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#环境"><span class="nav-number">5.11.3.1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#目录覆盖"><span class="nav-number">5.11.3.2.</span> <span class="nav-text">目录覆盖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本地文件服务器-1"><span class="nav-number">5.11.3.3.</span> <span class="nav-text">本地文件服务器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CP模块"><span class="nav-number">5.11.4.</span> <span class="nav-text">CP模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端实例"><span class="nav-number">5.11.5.</span> <span class="nav-text">客户端实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#包管理"><span class="nav-number">5.12.</span> <span class="nav-text">包管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SPM包构建"><span class="nav-number">5.12.1.</span> <span class="nav-text">SPM包构建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#包构建概述"><span class="nav-number">5.12.1.1.</span> <span class="nav-text">包构建概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包安装概述"><span class="nav-number">5.12.1.2.</span> <span class="nav-text">包安装概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建一个SPM-formula包"><span class="nav-number">5.12.1.3.</span> <span class="nav-text">构建一个SPM formula包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#包类型"><span class="nav-number">5.12.1.4.</span> <span class="nav-text">包类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#技术信息"><span class="nav-number">5.12.1.5.</span> <span class="nav-text">技术信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#特定SPM装载器模块"><span class="nav-number">5.12.1.6.</span> <span class="nav-text">特定SPM装载器模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发SPM包"><span class="nav-number">5.12.2.</span> <span class="nav-text">分发SPM包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装SPM包"><span class="nav-number">5.12.3.</span> <span class="nav-text">安装SPM包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置远程REPO"><span class="nav-number">5.12.3.1.</span> <span class="nav-text">配置远程REPO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新文件根"><span class="nav-number">5.12.3.2.</span> <span class="nav-text">更新文件根</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装包"><span class="nav-number">5.12.3.3.</span> <span class="nav-text">安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PILLARS"><span class="nav-number">5.12.3.4.</span> <span class="nav-text">PILLARS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除包"><span class="nav-number">5.12.3.5.</span> <span class="nav-text">删除包</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPM配置"><span class="nav-number">5.12.4.</span> <span class="nav-text">SPM配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FORMULA-File"><span class="nav-number">5.12.5.</span> <span class="nav-text">FORMULA File</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#需要的字段"><span class="nav-number">5.12.5.1.</span> <span class="nav-text">需要的字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可选字段"><span class="nav-number">5.12.5.2.</span> <span class="nav-text">可选字段</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPM开发指南"><span class="nav-number">5.12.6.</span> <span class="nav-text">SPM开发指南</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在其它数据库中存储数据"><span class="nav-number">5.13.</span> <span class="nav-text">在其它数据库中存储数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SDB-CONF"><span class="nav-number">5.13.1.</span> <span class="nav-text">SDB CONF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDB-URIS"><span class="nav-number">5.13.2.</span> <span class="nav-text">SDB URIS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取、配置和删除SDB值"><span class="nav-number">5.13.3.</span> <span class="nav-text">获取、配置和删除SDB值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在文件中使用SDB-URIS"><span class="nav-number">5.13.4.</span> <span class="nav-text">在文件中使用SDB URIS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#非特权用户运行"><span class="nav-number">5.14.</span> <span class="nav-text">非特权用户运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用CRON"><span class="nav-number">5.15.</span> <span class="nav-text">使用CRON</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HARDENING-SALT"><span class="nav-number">5.16.</span> <span class="nav-text">HARDENING SALT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-TRANSPORT"><span class="nav-number">5.17.</span> <span class="nav-text">SALT TRANSPORT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PUB-CHANNEL"><span class="nav-number">5.17.1.</span> <span class="nav-text">PUB CHANNEL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#REQ-CHANNEL"><span class="nav-number">5.17.2.</span> <span class="nav-text">REQ CHANNEL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZEROMQ传输"><span class="nav-number">5.17.3.</span> <span class="nav-text">ZEROMQ传输</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP传输"><span class="nav-number">5.17.4.</span> <span class="nav-text">TCP传输</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WIRE-PROTOCOL"><span class="nav-number">5.17.4.1.</span> <span class="nav-text">WIRE PROTOCOL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TLS支持"><span class="nav-number">5.17.4.2.</span> <span class="nav-text">TLS支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CRYPTO"><span class="nav-number">5.17.4.3.</span> <span class="nav-text">CRYPTO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PUB-CHANNEL-1"><span class="nav-number">5.17.4.4.</span> <span class="nav-text">PUB CHANNEL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REQ-CHANNEL-1"><span class="nav-number">5.17.4.5.</span> <span class="nav-text">REQ CHANNEL</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAET传输"><span class="nav-number">5.17.5.</span> <span class="nav-text">RAET传输</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MASTER-TOPS"><span class="nav-number">5.18.</span> <span class="nav-text">MASTER TOPS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RETURNERS"><span class="nav-number">5.19.</span> <span class="nav-text">RETURNERS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RETURNER-MODULES"><span class="nav-number">5.19.1.</span> <span class="nav-text">RETURNER MODULES</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RENDERERS"><span class="nav-number">5.20.</span> <span class="nav-text">RENDERERS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RENDERER-MODULES"><span class="nav-number">5.20.1.</span> <span class="nav-text">RENDERER MODULES</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用"><span class="nav-number">6.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GRAINS"><span class="nav-number">6.1.</span> <span class="nav-text">GRAINS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LISTING-GRAINS"><span class="nav-number">6.1.1.</span> <span class="nav-text">LISTING GRAINS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GRAINS-IN-THE-MINION-CONFIG"><span class="nav-number">6.1.2.</span> <span class="nav-text">GRAINS IN THE MINION CONFIG</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GRAINS-IN-ETC-SALT-GRAINS"><span class="nav-number">6.1.3.</span> <span class="nav-text">GRAINS IN /ETC/SALT/GRAINS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MATCHING-GRAINS-IN-THE-TOP-FILE"><span class="nav-number">6.1.4.</span> <span class="nav-text">MATCHING GRAINS IN THE TOP FILE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写grains"><span class="nav-number">6.1.5.</span> <span class="nav-text">编写grains</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优先权"><span class="nav-number">6.1.6.</span> <span class="nav-text">优先权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GRAINS栗子"><span class="nav-number">6.1.7.</span> <span class="nav-text">GRAINS栗子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PILLAR"><span class="nav-number">6.2.</span> <span class="nav-text">PILLAR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#声明Master-Pillar"><span class="nav-number">6.2.1.</span> <span class="nav-text">声明Master Pillar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态Pillar环境"><span class="nav-number">6.2.2.</span> <span class="nav-text">动态Pillar环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PILLAR-NAMESPACE-FLATTENING"><span class="nav-number">6.2.3.</span> <span class="nav-text">PILLAR NAMESPACE FLATTENING</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pillar字典合并"><span class="nav-number">6.2.4.</span> <span class="nav-text">pillar字典合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#包含其它pillars"><span class="nav-number">6.2.5.</span> <span class="nav-text">包含其它pillars</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存中的pillar数据与一经请求的pillar数据"><span class="nav-number">6.2.6.</span> <span class="nav-text">内存中的pillar数据与一经请求的pillar数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何处理pillar环境"><span class="nav-number">6.2.7.</span> <span class="nav-text">如何处理pillar环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看pillar数据"><span class="nav-number">6.2.8.</span> <span class="nav-text">查看pillar数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在CLI设置pillar数据"><span class="nav-number">6.2.9.</span> <span class="nav-text">在CLI设置pillar数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pillar加密"><span class="nav-number">6.2.10.</span> <span class="nav-text">Pillar加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MASTER-CONFIG-IN-PILLAR"><span class="nav-number">6.2.11.</span> <span class="nav-text">MASTER CONFIG IN PILLAR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MINION-CONFIG-IN-PILLAR"><span class="nav-number">6.2.12.</span> <span class="nav-text">MINION CONFIG IN PILLAR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TARGETING-MINIONS"><span class="nav-number">6.3.</span> <span class="nav-text">TARGETING MINIONS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TARGETING-WITH-GRAINS"><span class="nav-number">6.3.1.</span> <span class="nav-text">TARGETING WITH GRAINS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复合条件"><span class="nav-number">6.3.2.</span> <span class="nav-text">复合条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节点组目标"><span class="nav-number">6.3.3.</span> <span class="nav-text">节点组目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高级的目标方法"><span class="nav-number">6.3.4.</span> <span class="nav-text">高级的目标方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MINE"><span class="nav-number">6.4.</span> <span class="nav-text">MINE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mine函数"><span class="nav-number">6.4.1.</span> <span class="nav-text">Mine函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MINE-INTERVAL"><span class="nav-number">6.4.2.</span> <span class="nav-text">MINE INTERVAL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MINE-IN-SALT-SSH"><span class="nav-number">6.4.2.1.</span> <span class="nav-text">MINE IN SALT-SSH</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RUNNERS"><span class="nav-number">6.5.</span> <span class="nav-text">RUNNERS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RUNNER-MODULES"><span class="nav-number">6.5.1.</span> <span class="nav-text">RUNNER MODULES</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写Runner"><span class="nav-number">6.5.2.</span> <span class="nav-text">编写Runner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步-异步"><span class="nav-number">6.5.3.</span> <span class="nav-text">同步/异步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#栗子-1"><span class="nav-number">6.5.4.</span> <span class="nav-text">栗子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-ENGINES"><span class="nav-number">6.6.</span> <span class="nav-text">SALT ENGINES</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-2"><span class="nav-number">6.6.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写引擎"><span class="nav-number">6.6.2.</span> <span class="nav-text">编写引擎</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML"><span class="nav-number">6.7.</span> <span class="nav-text">YAML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JINJA"><span class="nav-number">6.8.</span> <span class="nav-text">JINJA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#教程索引"><span class="nav-number">6.9.</span> <span class="nav-text">教程索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TROUBLESHOOTING"><span class="nav-number">6.10.</span> <span class="nav-text">TROUBLESHOOTING</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-number">6.11.</span> <span class="nav-text">FAQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最佳实践"><span class="nav-number">6.12.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通用规则"><span class="nav-number">6.12.1.</span> <span class="nav-text">通用规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构造STATES和FORMULAS"><span class="nav-number">6.12.2.</span> <span class="nav-text">构造STATES和FORMULAS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构造Pillar"><span class="nav-number">6.12.3.</span> <span class="nav-text">构造Pillar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量的灵活性"><span class="nav-number">6.12.4.</span> <span class="nav-text">变量的灵活性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模块化"><span class="nav-number">6.12.5.</span> <span class="nav-text">状态模块化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储安全数据"><span class="nav-number">6.12.6.</span> <span class="nav-text">存储安全数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#远程执行"><span class="nav-number">7.</span> <span class="nav-text">远程执行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#执行模块"><span class="nav-number">7.1.</span> <span class="nav-text">执行模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写执行模块"><span class="nav-number">7.2.</span> <span class="nav-text">编写执行模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#教程"><span class="nav-number">7.2.1.</span> <span class="nav-text">教程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在minions上运行命令"><span class="nav-number">7.3.</span> <span class="nav-text">在minions上运行命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Salt命令"><span class="nav-number">7.3.1.</span> <span class="nav-text">使用Salt命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXECUTORS"><span class="nav-number">7.4.</span> <span class="nav-text">EXECUTORS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写执行器"><span class="nav-number">7.4.1.</span> <span class="nav-text">编写执行器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置管理"><span class="nav-number">8.</span> <span class="nav-text">配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Salt-States"><span class="nav-number">8.1.</span> <span class="nav-text">Salt States</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一切都是数据"><span class="nav-number">8.1.1.</span> <span class="nav-text">一切都是数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#THE-TOP-FILE"><span class="nav-number">8.1.2.</span> <span class="nav-text">THE TOP FILE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#介绍-1"><span class="nav-number">8.1.2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#栗子-2"><span class="nav-number">8.1.2.2.</span> <span class="nav-text">栗子</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ENVIRONMENTS"><span class="nav-number">8.1.2.3.</span> <span class="nav-text">ENVIRONMENTS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#入门"><span class="nav-number">8.1.2.4.</span> <span class="nav-text">入门</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多环境"><span class="nav-number">8.1.2.5.</span> <span class="nav-text">多环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#给目标选择一个环境"><span class="nav-number">8.1.2.6.</span> <span class="nav-text">给目标选择一个环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高级的minion目标"><span class="nav-number">8.1.2.7.</span> <span class="nav-text">高级的minion目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何编译顶级文件"><span class="nav-number">8.1.2.8.</span> <span class="nav-text">如何编译顶级文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#顶级文件编译栗子"><span class="nav-number">8.1.2.9.</span> <span class="nav-text">顶级文件编译栗子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML格式的SLS"><span class="nav-number">8.1.3.</span> <span class="nav-text">YAML格式的SLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加配置和用户"><span class="nav-number">8.1.4.</span> <span class="nav-text">添加配置和用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOVING-BEYOND-A-SINGLE-SLS"><span class="nav-number">8.1.5.</span> <span class="nav-text">MOVING BEYOND A SINGLE SLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXTENDING"><span class="nav-number">8.1.6.</span> <span class="nav-text">EXTENDING</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#渲染系统"><span class="nav-number">8.1.7.</span> <span class="nav-text">渲染系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DEBUG-SALT-STATES"><span class="nav-number">8.1.8.</span> <span class="nav-text">DEBUG SALT STATES</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STATES-TUTORIAL"><span class="nav-number">8.2.</span> <span class="nav-text">STATES TUTORIAL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本用法"><span class="nav-number">8.2.1.</span> <span class="nav-text">基本用法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置状态树"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">配置状态树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#准备顶级文件"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">准备顶级文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建sls文件"><span class="nav-number">8.2.1.3.</span> <span class="nav-text">创建sls文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装软件包"><span class="nav-number">8.2.1.4.</span> <span class="nav-text">安装软件包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ubuntu和centos两台minion"><span class="nav-number">8.2.1.5.</span> <span class="nav-text">ubuntu和centos两台minion</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复杂的状态和要求"><span class="nav-number">8.2.2.</span> <span class="nav-text">复杂的状态和要求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#调用多个状态"><span class="nav-number">8.2.2.1.</span> <span class="nav-text">调用多个状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#要求其它状态"><span class="nav-number">8.2.2.2.</span> <span class="nav-text">要求其它状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板、包含、扩展"><span class="nav-number">8.2.3.</span> <span class="nav-text">模板、包含、扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SLS模块模板"><span class="nav-number">8.2.3.1.</span> <span class="nav-text">SLS模块模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在SLS模块中使用GRAINS"><span class="nav-number">8.2.3.2.</span> <span class="nav-text">在SLS模块中使用GRAINS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在SLS模板中使用环境变量"><span class="nav-number">8.2.3.3.</span> <span class="nav-text">在SLS模板中使用环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从模板调用模块"><span class="nav-number">8.2.3.4.</span> <span class="nav-text">从模板调用模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SLS模块高级语法"><span class="nav-number">8.2.3.5.</span> <span class="nav-text">SLS模块高级语法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态工作流"><span class="nav-number">8.2.4.</span> <span class="nav-text">状态工作流</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Salt文件服务器路径继承"><span class="nav-number">8.2.4.1.</span> <span class="nav-text">Salt文件服务器路径继承</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#环境配置"><span class="nav-number">8.2.4.2.</span> <span class="nav-text">环境配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#栗子-3"><span class="nav-number">8.2.4.3.</span> <span class="nav-text">栗子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态系统参考"><span class="nav-number">8.2.5.</span> <span class="nav-text">状态系统参考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实用程序模块"><span class="nav-number">9.</span> <span class="nav-text">实用程序模块</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事件和反应器"><span class="nav-number">10.</span> <span class="nav-text">事件和反应器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#事件系统"><span class="nav-number">10.1.</span> <span class="nav-text">事件系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事件总线"><span class="nav-number">10.1.1.</span> <span class="nav-text">事件总线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件类型"><span class="nav-number">10.1.2.</span> <span class="nav-text">事件类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SALT-MASTER-EVENTS"><span class="nav-number">10.1.2.1.</span> <span class="nav-text">SALT MASTER EVENTS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#监听事件"><span class="nav-number">10.1.3.</span> <span class="nav-text">监听事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引发事件"><span class="nav-number">10.1.4.</span> <span class="nav-text">引发事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从Python引发事件"><span class="nav-number">10.1.5.</span> <span class="nav-text">从Python引发事件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Beacons"><span class="nav-number">10.2.</span> <span class="nav-text">Beacons</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BEACON-MODULES"><span class="nav-number">10.2.1.</span> <span class="nav-text">BEACON MODULES</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BEACONS-配置"><span class="nav-number">10.2.2.</span> <span class="nav-text">BEACONS 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Beacons监控间隔"><span class="nav-number">10.2.2.1.</span> <span class="nav-text">Beacons监控间隔</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#避免事件循环"><span class="nav-number">10.2.2.2.</span> <span class="nav-text">避免事件循环</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#栗子-4"><span class="nav-number">10.2.3.</span> <span class="nav-text">栗子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写Beacon插件"><span class="nav-number">10.2.4.</span> <span class="nav-text">编写Beacon插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反应器系统"><span class="nav-number">10.3.</span> <span class="nav-text">反应器系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事件系统-1"><span class="nav-number">10.3.1.</span> <span class="nav-text">事件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将事件映射到反应器SLS文件"><span class="nav-number">10.3.2.</span> <span class="nav-text">将事件映射到反应器SLS文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反应类型"><span class="nav-number">10.3.3.</span> <span class="nav-text">反应类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#哪里放置反应器SLS文件"><span class="nav-number">10.3.4.</span> <span class="nav-text">哪里放置反应器SLS文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写反应器SLS"><span class="nav-number">10.3.5.</span> <span class="nav-text">编写反应器SLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写反应器SLS的最佳实践"><span class="nav-number">10.3.6.</span> <span class="nav-text">编写反应器SLS的最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BEACONS-AND-REACTORS"><span class="nav-number">10.3.7.</span> <span class="nav-text">BEACONS AND REACTORS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动引发事件"><span class="nav-number">10.3.8.</span> <span class="nav-text">手动引发事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取事件信息"><span class="nav-number">10.3.9.</span> <span class="nav-text">获取事件信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编排"><span class="nav-number">11.</span> <span class="nav-text">编排</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ORCHESTRATE-RUNNER"><span class="nav-number">11.1.</span> <span class="nav-text">ORCHESTRATE RUNNER</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#THE-ORCHESTRATE-RUNNER"><span class="nav-number">11.1.1.</span> <span class="nav-text">THE ORCHESTRATE RUNNER</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编写SLS文件"><span class="nav-number">11.1.1.1.</span> <span class="nav-text">编写SLS文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行编排运行器"><span class="nav-number">11.1.1.2.</span> <span class="nav-text">执行编排运行器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#无主编排"><span class="nav-number">11.1.1.3.</span> <span class="nav-text">无主编排</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#栗子-5"><span class="nav-number">11.1.1.4.</span> <span class="nav-text">栗子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#程序化解析结果"><span class="nav-number">11.1.2.</span> <span class="nav-text">程序化解析结果</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在没有Minion的Master上运行STATE"><span class="nav-number">11.1.2.1.</span> <span class="nav-text">在没有Minion的Master上运行STATE</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SALT-PROXY-MINION"><span class="nav-number">12.</span> <span class="nav-text">SALT PROXY MINION</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#入门-1"><span class="nav-number">12.1.</span> <span class="nav-text">入门</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#网络自动化"><span class="nav-number">13.</span> <span class="nav-text">网络自动化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#命令参考"><span class="nav-number">14.</span> <span class="nav-text">命令参考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-CALL"><span class="nav-number">14.1.</span> <span class="nav-text">SALT-CALL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT"><span class="nav-number">14.2.</span> <span class="nav-text">SALT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-CLOUD"><span class="nav-number">14.3.</span> <span class="nav-text">SALT-CLOUD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-CP"><span class="nav-number">14.4.</span> <span class="nav-text">SALT-CP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-EXTEND"><span class="nav-number">14.5.</span> <span class="nav-text">SALT-EXTEND</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-KEY"><span class="nav-number">14.6.</span> <span class="nav-text">SALT-KEY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-MASTER"><span class="nav-number">14.7.</span> <span class="nav-text">SALT-MASTER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-MINION"><span class="nav-number">14.8.</span> <span class="nav-text">SALT-MINION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-PROXY"><span class="nav-number">14.9.</span> <span class="nav-text">SALT-PROXY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-RUN"><span class="nav-number">14.10.</span> <span class="nav-text">SALT-RUN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-SSH"><span class="nav-number">14.11.</span> <span class="nav-text">SALT-SSH</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#入门-2"><span class="nav-number">14.11.1.</span> <span class="nav-text">入门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ROSTER"><span class="nav-number">14.11.2.</span> <span class="nav-text">ROSTER</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Roster模块"><span class="nav-number">14.11.2.1.</span> <span class="nav-text">Roster模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何工作"><span class="nav-number">14.11.2.2.</span> <span class="nav-text">如何工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简单栗子"><span class="nav-number">14.11.2.3.</span> <span class="nav-text">简单栗子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署SSH-KEY"><span class="nav-number">14.11.3.</span> <span class="nav-text">部署SSH KEY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用SALT-SSH"><span class="nav-number">14.11.4.</span> <span class="nav-text">调用SALT SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STATES-VIA-SALT-SSH"><span class="nav-number">14.11.5.</span> <span class="nav-text">STATES VIA SALT SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TARGETING-WITH-SALT-SSH"><span class="nav-number">14.11.6.</span> <span class="nav-text">TARGETING WITH SALT SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置SALT-SSH"><span class="nav-number">14.11.7.</span> <span class="nav-text">配置SALT SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非特权用户运行-1"><span class="nav-number">14.11.8.</span> <span class="nav-text">非特权用户运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义CLI选项"><span class="nav-number">14.11.9.</span> <span class="nav-text">定义CLI选项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-SYNDIC"><span class="nav-number">14.12.</span> <span class="nav-text">SALT-SYNDIC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-UNITY"><span class="nav-number">14.13.</span> <span class="nav-text">SALT-UNITY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-API"><span class="nav-number">14.14.</span> <span class="nav-text">SALT-API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPM"><span class="nav-number">14.15.</span> <span class="nav-text">SPM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模块参考"><span class="nav-number">15.</span> <span class="nav-text">模块参考</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APIs"><span class="nav-number">16.</span> <span class="nav-text">APIs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#客户端API"><span class="nav-number">16.1.</span> <span class="nav-text">客户端API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#netapi模块"><span class="nav-number">16.2.</span> <span class="nav-text">netapi模块</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#架构"><span class="nav-number">17.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#高可用功能"><span class="nav-number">17.1.</span> <span class="nav-text">高可用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MULTIMASTER"><span class="nav-number">17.1.1.</span> <span class="nav-text">MULTIMASTER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MULTIMASTER-WITH-FAILOVER"><span class="nav-number">17.1.2.</span> <span class="nav-text">MULTIMASTER WITH FAILOVER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SYNDIC"><span class="nav-number">17.1.3.</span> <span class="nav-text">SYNDIC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SYNDIC-WITH-MULTIMASTER"><span class="nav-number">17.1.4.</span> <span class="nav-text">SYNDIC WITH MULTIMASTER</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SALT-SYNDIC-1"><span class="nav-number">17.2.</span> <span class="nav-text">SALT SYNDIC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Syndic"><span class="nav-number">17.2.1.</span> <span class="nav-text">配置Syndic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多主Syndic配置"><span class="nav-number">17.2.2.</span> <span class="nav-text">多主Syndic配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行"><span class="nav-number">17.2.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拓扑"><span class="nav-number">17.2.4.</span> <span class="nav-text">拓扑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SYNDIC-WAIT"><span class="nav-number">17.2.5.</span> <span class="nav-text">SYNDIC WAIT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Syndic配置项"><span class="nav-number">17.2.6.</span> <span class="nav-text">Syndic配置项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Minion数据缓存"><span class="nav-number">17.2.7.</span> <span class="nav-text">Minion数据缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#有规模的使用salt"><span class="nav-number">17.3.</span> <span class="nav-text">有规模的使用salt</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Master"><span class="nav-number">17.3.1.</span> <span class="nav-text">The Master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#资源太少"><span class="nav-number">17.3.2.</span> <span class="nav-text">资源太少</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Multi-Master"><span class="nav-number">17.4.</span> <span class="nav-text">Multi Master</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤概要"><span class="nav-number">17.4.1.</span> <span class="nav-text">步骤概要</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备冗余Master"><span class="nav-number">17.4.2.</span> <span class="nav-text">准备冗余Master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Minion"><span class="nav-number">17.4.3.</span> <span class="nav-text">配置Minion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在Master间共享文件"><span class="nav-number">17.4.4.</span> <span class="nav-text">在Master间共享文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具有故障转移的Multi-PKI-Master"><span class="nav-number">17.5.</span> <span class="nav-text">具有故障转移的Multi-PKI-Master</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Minion数据缓存-1"><span class="nav-number">18.</span> <span class="nav-text">Minion数据缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存模块"><span class="nav-number">18.1.</span> <span class="nav-text">缓存模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可插拔数据缓存"><span class="nav-number">18.2.</span> <span class="nav-text">可插拔数据缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置Minion数据缓存"><span class="nav-number">18.3.</span> <span class="nav-text">配置Minion数据缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Salt开发"><span class="nav-number">19.</span> <span class="nav-text">Salt开发</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang21</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 758.4k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2017/12/25/SaltStack/';
          this.page.identifier = '2017/12/25/SaltStack/';
          this.page.title = 'SaltStack';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
