<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Nginx," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="参考：  Nginx官方文档 Nginx-Wikipedia Nginx-repo  环境：  CentOS7x86_64; Nginx1.12.1     Nginx介绍Nginx（发音同engine x）是一个 Web服务器，也可以用作反向代理，负载平衡器和 HTTP缓存。它能反向代理 HTTP, HTTPS, SMTP, POP3, IMAP 的协议连接。基于BSD-like协议发行，支持多">
<meta name="keywords" content="Nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="https://zhang21.github.io/2017/09/01/Nginx/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考：  Nginx官方文档 Nginx-Wikipedia Nginx-repo  环境：  CentOS7x86_64; Nginx1.12.1     Nginx介绍Nginx（发音同engine x）是一个 Web服务器，也可以用作反向代理，负载平衡器和 HTTP缓存。它能反向代理 HTTP, HTTPS, SMTP, POP3, IMAP 的协议连接。基于BSD-like协议发行，支持多">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://zhang21.github.io/images/Nginx/Nginx001.jpg">
<meta property="og:image" content="https://zhang21.github.io/images/Nginx/Nginx002.jpg">
<meta property="og:image" content="https://zhang21.github.io/images/Nginx/auth.png">
<meta property="og:updated_time" content="2018-03-27T10:13:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx">
<meta name="twitter:description" content="参考：  Nginx官方文档 Nginx-Wikipedia Nginx-repo  环境：  CentOS7x86_64; Nginx1.12.1     Nginx介绍Nginx（发音同engine x）是一个 Web服务器，也可以用作反向代理，负载平衡器和 HTTP缓存。它能反向代理 HTTP, HTTPS, SMTP, POP3, IMAP 的协议连接。基于BSD-like协议发行，支持多">
<meta name="twitter:image" content="https://zhang21.github.io/images/Nginx/Nginx001.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2017/09/01/Nginx/"/>





  <title>Nginx | 风继续吹</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2017/09/01/Nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang21">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Nginx</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-01T16:22:58+08:00">
                2017-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/01/Nginx/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/09/01/Nginx/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  12,693
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考：</p>
<ul>
<li><a href="https://nginx.org/en/docs/" target="_blank" rel="noopener">Nginx官方文档</a></li>
<li><a href="https://zh.wikipedia.org/wiki/Nginx" target="_blank" rel="noopener">Nginx-Wikipedia</a></li>
<li><a href="http://nginx.org/packages/" target="_blank" rel="noopener">Nginx-repo</a></li>
</ul>
<p>环境：</p>
<ul>
<li>CentOS7x86_64;</li>
<li>Nginx1.12.1</li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<h1 id="Nginx介绍"><a href="#Nginx介绍" class="headerlink" title="Nginx介绍"></a>Nginx介绍</h1><p>Nginx（发音同engine x）是一个 Web服务器，也可以用作反向代理，负载平衡器和 HTTP缓存。它能反向代理 <code>HTTP, HTTPS, SMTP, POP3, IMAP</code> 的协议连接。<br>基于BSD-like协议发行，支持多种操作系统。</p>
<a id="more"></a>
<p>作为HTTP服务软件的后起之秀，Nginx有很多优点：</p>
<ul>
<li>在性能上，Nginx占用的系统资源更少，支持更多的并发连接（特别是小静态文件场景下），达到更高的访问效率；</li>
<li>在功能上，Nginx不仅是一个优秀的<em>Web服务软件</em>，还可以作为<em>反向代理</em> <em>负载均衡</em>及<em>缓存</em>使用。它类似于<em>LVS负载均衡</em>及<em>HAProxy</em>等专业代理软件，又类似于<em>Squid</em>等专业缓存服务软件；</li>
<li>在安装配置上，Nginx方便、简单、灵活。</li>
</ul>
<p>Nginx功能丰富，可作为HTTP服务器、反向代理服务器、邮件服务器。支持<em>FastCGI, SSL, Virtual Host, URL Rewrite, Gzip</em>等功能，并支持很多第三方模块扩展。</p>
<p><br></p>
<h2 id="与PHP的集成"><a href="#与PHP的集成" class="headerlink" title="与PHP的集成"></a>与PHP的集成</h2><p>自PHP-5.3.3起，PHP-FPM加入到了PHP核心，编译时加上–enable-fpm即可提供支持。<br>PHP-FPM以守护进程在后台运行，Nginx响应请求后，自行处理静态请求，PHP请求则经过fastcgi_pass交由PHP-FPM处理，处理完毕后返回。<br>Nginx和PHP-FPM的组合，是一种稳定、高效的PHP运行方式，效率要比传统的Apache和mod_php高出不少。</p>
<p><strong>Nginx的重要特性：</strong></p>
<blockquote>
<p>可针对静态资源高速高并发访问及缓存；<br>可使用反向代理加速，并且可进行数据缓存；<br>具有简单负载均衡、节点健康检查和容错功能；<br>支持远程FastCGI、Uwsgi、SCGI、Memcached Servers的加速和缓存；<br>支持SSL、TLS、SNI；<br>具有模块化的架构：过滤器包括gzip压缩、ranges支持、chunked响应、XSLT、SSI及图像缩放等功能。在SSI过滤器中，一个包含多个SSI的页面，如果FastCGI或反向代理处理，可被并行处理；<br>它具备的其他WWW服务特性：<br>支持基于名字、端口及IP的多虚拟主机站点；<br>支持Keep-alived和pipelined连接；<br>可进行修改Nginx配置，并且在代码上线时，可平滑重启，不中断业务访问；<br>可自定义访问日志格式，临时缓冲些日志操作，快速日志轮询及通过rsyslog处理日志；<br>可利用信号控制Nginx进程；<br>支持 3xx-5xx HTTP状态码重定向；<br>支持rewrite模块，支持URI重写及正则表达式匹配；<br>支持基于客户端IP地址和HTTP基本认证的访问控制；<br>支持PUT、DELETE、MKCOL、COPY及MOVE等较特殊的HTTP请求方法；<br>支持FLV流和MP4流技术产品应用；<br>支持HTTP响应速率限制；<br>支持同一IP地址的并发连接或请求数连接；<br>支持邮件服务器代理；</p>
</blockquote>
<p><br></p>
<h2 id="Nginx常用功能"><a href="#Nginx常用功能" class="headerlink" title="Nginx常用功能"></a>Nginx常用功能</h2><h3 id="http代理于反向代理"><a href="#http代理于反向代理" class="headerlink" title="http代理于反向代理"></a>http代理于反向代理</h3><p>Nginx在做反向代理时，提供性能稳定，并且能够提供配置灵活的转发功能。Nginx可以根据不同的正则匹配，采取不同的转发策略，比如图片文件结尾的走文件服务器，动态页面走web服务器，只要你正则写的没问题，又有相对应的服务器解决方案，你就可以随心所欲的玩。并且Nginx对返回结果进行错误页跳转，异常判断等。如果被分发的服务器存在异常，他可以将请求重新转发给另外一台服务器，然后自动去除异常服务器。</p>
<p><img src="/images/Nginx/Nginx001.jpg" alt="Nginx代理与反向代理"></p>
<p><br></p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>Nginx提供的负载均衡策略有2种：内置策略和扩展策略。内置策略为轮询，加权轮询，Ip hash。扩展策略，就天马行空，只有你想不到的没有他做不到的啦，你可以参照所有的负载均衡算法，给他一一找出来做下实现。</p>
<p><img src="/images/Nginx/Nginx002.jpg" alt=""></p>
<p><br></p>
<h3 id="web缓存"><a href="#web缓存" class="headerlink" title="web缓存"></a>web缓存</h3><p>Nginx可以对不同的文件做不同的缓存处理，配置灵活，并且支持FastCGI_Cache，主要用于对FastCGI的动态程序进行缓存。配合着第三方的ngx_cache_purge，对制定的URL缓存内容可以的进行增删管理。</p>
<p><br></p>
<h3 id="web服务"><a href="#web服务" class="headerlink" title="web服务"></a>web服务</h3><p>Nginx作为Web服务器的主要应用场景包括：</p>
<ul>
<li>使用Nginx运行HTML、JS、CSS、小图片等静态数据；</li>
<li>结合FastCGI运行PHP等动态程序（如fastcgi_pass）；</li>
<li>结合Tomcat/Resin等支持Java动态程序（如proxy_pass）。</li>
</ul>
<p><br></p>
<hr>
<p><br></p>
<h1 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h1><h2 id="RPM源安装"><a href="#RPM源安装" class="headerlink" title="RPM源安装:"></a>RPM源安装:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">yum install -y gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel    安装依赖</div><div class="line">rpm -ivm http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm 安装RPM源</div><div class="line"></div><div class="line">#安装Nginx</div><div class="line">yum install -y nginx</div><div class="line"></div><div class="line">#查询安装</div><div class="line">rpm -q nginx</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="添加Nginx-yum-repository安装"><a href="#添加Nginx-yum-repository安装" class="headerlink" title="添加Nginx yum repository安装"></a>添加Nginx yum repository安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">vim /etc/yum.repos.d/nginx.repo</div><div class="line"></div><div class="line"></div><div class="line">#必须唯一</div><div class="line">[nginx]</div><div class="line"></div><div class="line">name=nginx-repo</div><div class="line">baseurl=http://nginx.org/packages/$OS/$OSRELEASE/$basearch/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#建议解压于此目录</div><div class="line">cd /usr/local/src</div><div class="line"></div><div class="line">wget http://xxx.xx.com/nginx.tar.gz</div><div class="line">tar -zxvf nginx.tar.gz</div><div class="line"></div><div class="line">cd ./nginx</div><div class="line">./configure --prefix=/usr/local</div><div class="line"></div><div class="line">make&amp;&amp;make install</div></pre></td></tr></table></figure>
<p><br></p>
<hr>
<p><br></p>
<h1 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h1><h2 id="conf"><a href="#conf" class="headerlink" title="*.conf"></a>*.conf</h2><p>Nginx配置文件主要分为四部分：</p>
<ul>
<li>main(全局设置)；</li>
<li>server(主机设置)；</li>
<li>upstream(上游服务器设置)，用于反向代理和负载均衡；</li>
<li>location(URL匹配特定位置)。</li>
</ul>
<p>栗子：<br>运行<code>nginx -t</code>检查配置文件有误错误，这很重要!</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#main块</span></div><div class="line">user nginx;</div><div class="line">worker_processes 4;</div><div class="line">client_max_body_size  10M</div><div class="line"></div><div class="line"></div><div class="line">error_log /var/<span class="built_in">log</span>/nginx/error.log warn;</div><div class="line">pid /var/run/nginx.pid;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">	worker_connections 102400;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#http块</span></div><div class="line">http &#123;</div><div class="line">	include /etc/nginx/mime.types;</div><div class="line">    default_type application/octet-stream;</div><div class="line">    log_format main <span class="string">'$remote_addr - ...'</span>;</div><div class="line"></div><div class="line">    access_log /var/<span class="built_in">log</span>/nginx/access.log main;</div><div class="line">    sendfile on;</div><div class="line">    gzip on;</div><div class="line">    keepalive_timeout 60;</div><div class="line"></div><div class="line">	include /etc/nginx/conf.d/*.conf;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">#upstream块</span></div><div class="line">    upstream up_name&#123;</div><div class="line">    	server ip1;</div><div class="line">        server ip2:port;</div><div class="line">        server domain;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">	server &#123;</div><div class="line">    	server_name www.zhang21.cn;</div><div class="line"></div><div class="line">    	listen 80;</div><div class="line">        listen 443;</div><div class="line">        ssl on;</div><div class="line">        ssl_certificate /dir/path/xxx.crt;</div><div class="line">        ssl_certificate_key /dir/path/xxx.key;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">        	root /var/www/zhang;</div><div class="line">            index index.php index.html index.htm;</div><div class="line"></div><div class="line">            allow 192.168.1.0/22;</div><div class="line">            deny all;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location ~ \.php$ &#123;</div><div class="line">        	root /var/www/zhang;</div><div class="line">            fastcgi_pass 127.0.0.1:9000;</div><div class="line">            fastcgi_index index.php;</div><div class="line">            fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span>/<span class="variable">$fastcgi_script_name</span>;</div><div class="line">            include fastcgi_params;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>全局块：<br>配置影响Nginx全局的指令。一般由运行Nginx服务器的用户组，Nginx进程pid存放路径，日志存放路径，允许生成的worker_processes等。</p>
</li>
<li><p>events块：<br>配置影响Nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网络连接，开启多个网络连接序列化等。</p>
</li>
<li><p>http块：<br>可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，链接超时时间，单连接请求数等。</p>
</li>
<li><p>server块：<br>配置虚拟主机的相关参数，一个http中可以有多个server。</p>
</li>
<li><p>location块：<br>配置请求的路由，以及各种页面的处理情况。</p>
</li>
</ul>
<p><br></p>
<table>
<thead>
<tr>
<th>Nginx http功能模块</th>
<th>模块说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_http_core_module</td>
<td>一些核心的http参数配置，对应Nginx的配置中的http块</td>
</tr>
<tr>
<td>ngx_http_access_module</td>
<td>访问控制模块，用来控制网站用户对Nginx的访问</td>
</tr>
<tr>
<td>ngx_http_gzip_module</td>
<td>压缩模块，对Nginx返回的数据压缩，属于性能优化模块</td>
</tr>
<tr>
<td>ngx_http_fastcgi_module</td>
<td>FastCGI模块，和动态应用相关的模块，如PHP</td>
</tr>
<tr>
<td>ngx_http_proxy_module</td>
<td>proxy代理模块</td>
</tr>
<tr>
<td>ngx_http_upstream_module</td>
<td>负载均衡模块，可实现网站的负载均衡及节点的监控检查</td>
</tr>
<tr>
<td>ngx_http_rewrite_module</td>
<td>URL重写模块</td>
</tr>
<tr>
<td>ngx_http_limit_conn_module</td>
<td>限制用户并发连接数及请求数模块</td>
</tr>
<tr>
<td>ngx_http_limit_req_module</td>
<td>根据定义的key限制Nginx请求过程的速率</td>
</tr>
<tr>
<td>ngx_http_log_module</td>
<td>访问日志模块，以指定的格式记录Nginx访问信息</td>
</tr>
<tr>
<td>ngx_http_auth_basic_module</td>
<td>web认证模块，设置通过账号，密码访问Nginx</td>
</tr>
<tr>
<td>ngx_http_ssl_module</td>
<td>ssl模块</td>
</tr>
<tr>
<td>ngx_http_stub_status_module</td>
<td>记录Nginx基本访问状态信息扥的模块</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>Nginx的日志时自动切割，并且一行可以记录多个日志格式。</p>
<table>
<thead>
<tr>
<th>Nginx日志格式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$remote_addr</td>
<td>客户端ip地址</td>
</tr>
<tr>
<td>$http_x_forward_for</td>
<td>当前端有代理服务器时，设置web节点记录web节点记录客户端地址的配置</td>
</tr>
<tr>
<td>$remote_user</td>
<td>客户端用户名称</td>
</tr>
<tr>
<td>$time_local</td>
<td>访问时间和时区</td>
</tr>
<tr>
<td>$request</td>
<td>请求的http协议和URL</td>
</tr>
<tr>
<td>$status</td>
<td>请求状态，如200</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端文件主体内容大小</td>
</tr>
<tr>
<td>$http_referer</td>
<td>从哪个页面链接访问过来</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端浏览器信息</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p>http服务上支持若干虚拟主机。每个虚拟主机对应一个server配置项，配置项里面包含该虚拟主机的相关配置。每个server里面可同时有多个<code>server_name</code>。</p>
<p>在提供mail代理服务时，也可建立若干server，每个server通过监听地址或端口来区分。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#监听端口，默认80</span></div><div class="line">listen 80;</div><div class="line">listern 443;</div><div class="line"><span class="comment">#listen 88</span></div><div class="line">server_name www.zhang21.cn</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="location"><a href="#location" class="headerlink" title="location"></a>location</h2><p>location是http服务中，某些特定的URL对应的一系列配置项。</p>
<ul>
<li>root 定义此location的根目录位置，一般放置在server里</li>
<li>index 定义路径下的默认访问的文件名</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">	root /dir/path;</div><div class="line">    index index.html index.htm;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="location的正则写法"><a href="#location的正则写法" class="headerlink" title="location的正则写法"></a>location的正则写法</h3><p>location的使用方法：</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
<th>优先级</th>
<th>用法</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>精确匹配</td>
<td>最高</td>
<td>location =</td>
</tr>
<tr>
<td>~</td>
<td>区分大小写的正则匹配</td>
<td>次次之</td>
<td>location ~</td>
</tr>
<tr>
<td>~*</td>
<td>不区分大小写的正则匹配</td>
<td>次次之</td>
<td>location ~*</td>
</tr>
<tr>
<td>^~</td>
<td>常规字符串匹配</td>
<td>次之</td>
<td>location ^~</td>
</tr>
<tr>
<td>/</td>
<td>通用匹配</td>
<td>最低</td>
<td>location /</td>
</tr>
</tbody>
</table>
<p><strong>优先级：</strong></p>
<blockquote>
<p>= &gt; 完整路径 &gt; ^~ &gt; ~, ~* &gt; 部分路径 &gt; /</p>
</blockquote>
<p><br></p>
<h3 id="location使用建议"><a href="#location使用建议" class="headerlink" title="location使用建议"></a>location使用建议</h3><p>location的使用根据实际情况来定。</p>
<p>但个人觉得至少应该有三个匹配规则：</p>
<ol>
<li>直接匹配网站跟，通过域名访问网站首页比较频繁</li>
<li>处理静态文件请求，这是Nginx作为http服务器的强项</li>
<li>通用规则，用来转发动态请求到后端的应用服务器(符php-fpm)</li>
<li>根据实际情况的自定义需求</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">	listen 80;</div><div class="line">    listen 443;</div><div class="line">    server_name zhang21.cn www.zhang21.cn;</div><div class="line">    root /dir/path/zhang;</div><div class="line"></div><div class="line">    ssl on;</div><div class="line">    ssl_certificate /etc/nginx/ssl/zhang.crt;</div><div class="line">    ssl_certificate_key /etc/nginx/ssl/zhang.key;</div><div class="line"></div><div class="line">	<span class="comment">#rewtire ^(.*)$ https://zhang21.cn/$1 permanent;</span></div><div class="line">	<span class="built_in">return</span> 301 https://zhang21.cn/<span class="variable">$requets_uri</span></div><div class="line"></div><div class="line"></div><div class="line">	location = / &#123;</div><div class="line">    	rewrite .*? /index.html last;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">	location  ^~ /static/ &#123;</div><div class="line">    	root /dir/path/zhang/static;</div><div class="line">    &#125;</div><div class="line">    location ~* \.(gif|jpg|png|css|js)$ &#123;</div><div class="line">    	root /dir/path/zhang/static;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">	location / &#123;</div><div class="line">    	<span class="keyword">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</div><div class="line">            rewrite ^([^\?]+)$ /index.php?q=<span class="variable">$1</span> last;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    location ~ \.php$ &#123;</div><div class="line">        root           /dir/path;</div><div class="line">        fastcgi_pass   127.0.0.1:9000;</div><div class="line">        fastcgi_index  index.php;</div><div class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$document_root</span>/<span class="variable">$fastcgi_script_name</span>;</div><div class="line">        include        fastcgi_params;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="Rewrite"><a href="#Rewrite" class="headerlink" title="Rewrite"></a>Rewrite</h2><p>Nginx的主要功能是实现URL地址重写。Nginx的rewrite规则需要PCRE软件的支持，即通过Perl兼容正则表达式语法进行规则匹配。</p>
<p>Nginx rewrite语法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server, location, <span class="keyword">if</span></div><div class="line"></div><div class="line">rewrite regex replacement [flag]</div></pre></td></tr></table></figure>
<ul>
<li>rewrite的功能就是，使用Nginx提供的全局变量或自定义变量，结合正则表达式(re)和标志位实现URL重写以及重定向</li>
<li>rewrite只能放在server，location，if中，并且只能对域名后边的除去传递的参数外的字符串起作用</li>
<li>如果相对域名或参数字符串起作用，可以使用全局变量匹配，也可使用proxy_pass反向代理</li>
</ul>
<p><br></p>
<p>表面看rewrite和location功能有点像，都能实现跳转。主要区别在于：</p>
<ul>
<li>rewrite实在同一域名内更改获取资源的路径</li>
<li>location是对一类路径做访问控制或反向代理，可proxy_pass到其它机器</li>
</ul>
<p>循环超多10次，返回500 Internal Server Error!</p>
<p><br></p>
<h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><ul>
<li>last<ul>
<li>表示完成rewrite，继续向下匹配新的规则</li>
</ul>
</li>
<li>break<ul>
<li>停止执行当前虚拟主机的后续rewrite指令集</li>
</ul>
</li>
<li>redirect<ul>
<li>返回302临时重定向，地址栏会显示跳转后的地址</li>
</ul>
</li>
<li><p>permanent</p>
<ul>
<li>返回301永久重定向，地址栏会显示跳转后的地址</li>
</ul>
</li>
<li><p>last和break用来实现URL重写，浏览器地址栏的URL地址不变，但在服务器端访问的程序及路径发生了变化</p>
</li>
<li>redirect和permanent用来实现URL跳转，浏览器地址栏会显示跳转后的URL地址</li>
</ul>
<p>Nginx的rewrite功能应用非常广泛：</p>
<ul>
<li>可调整用户浏览的URL，使其看起来更规范</li>
<li>将动态URL地址伪装成静态地址提供服务</li>
<li>让旧域名跳转到新域名上</li>
<li>根据特殊变量、目录、客户端的信息进行URL跳转</li>
</ul>
<p><br></p>
<h3 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a>if指令</h3><p>if语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (condition) &#123;</div><div class="line">	xxx;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>if的条件可以是如下内容：</p>
<ul>
<li>当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会被当作<strong>false</strong></li>
<li>直接比较变量和内容时，使用<strong>=</strong>或<strong>!=</strong></li>
<li><strong>~</strong>正则表达式匹配，<strong>~*</strong>不区分大小写的正则匹配，<strong>!~</strong>不匹配</li>
<li><strong>-f</strong>和<strong>!-f</strong>，用来判断是否存在文件</li>
<li><strong>-d</strong>和<strong>!-d</strong>，用来判断是否存在目录</li>
<li><strong>-e</strong>和<strong>!-e</strong>，用来判断时都存在文件或目录</li>
<li><strong>-x</strong>和<strong>!-x</strong>，用来判断文件是否可执行</li>
</ul>
<p><br></p>
<p>栗子：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ MSIE) &#123;</div><div class="line">	rewrite ^(.*)$ /msie/<span class="variable">$1</span> <span class="built_in">break</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$http_cookie</span> ~* <span class="string">"id=([^;])(?:;|$)"</span>) &#123;</div><div class="line">	<span class="built_in">set</span> <span class="variable">$id</span> <span class="variable">$1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$http_method</span> = POST) &#123;</div><div class="line">	<span class="built_in">return</span> 405;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</div><div class="line">	<span class="built_in">break</span>;</div><div class="line">    proxy_pass http://zhang;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</div><div class="line">	<span class="built_in">return</span> 403;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Nginx全局变量"><a href="#Nginx全局变量" class="headerlink" title="Nginx全局变量"></a>Nginx全局变量</h3><p>常用作<code>if</code>判断的全局变量：</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>$args</td>
<td>等于请求行中的参数</td>
<td>同$query_string</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>响应是发送的body字节数</td>
<td>xxx</td>
</tr>
<tr>
<td>$content_length</td>
<td>Request Header中的Content-Length字段</td>
<td>内容长度</td>
</tr>
<tr>
<td>$content_type</td>
<td>Request Header中的Content-Type字段</td>
<td>内容类型</td>
</tr>
<tr>
<td>$document_root</td>
<td>当前根路径</td>
<td>xxx</td>
</tr>
<tr>
<td>$host</td>
<td>请求主机头字段，否则为服务器名称</td>
<td>xxx</td>
</tr>
<tr>
<td>$hostname</td>
<td>主机名</td>
<td>xxx</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端agent信息</td>
<td>xxx</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>客户端cookie信息</td>
<td>xxx</td>
</tr>
<tr>
<td>$is_args</td>
<td>如果有$args参数，这个变量等于”?”，否则等于空</td>
<td>xxx</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>限制连接数度</td>
<td>xxx</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端IP地址</td>
<td>xxx</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端端口</td>
<td>xxx</td>
</tr>
<tr>
<td>$remote_user</td>
<td>经过Auth Basic Module验证的用户名</td>
<td>要先开启Nginx认证</td>
</tr>
<tr>
<td>$request</td>
<td>用户请求信息</td>
<td>xxx</td>
</tr>
<tr>
<td>$request_method</td>
<td>客户端请求方法</td>
<td>通常为POST或GET</td>
</tr>
<tr>
<td>$request_body</td>
<td>记录POST过来的数据信息</td>
<td>xxx</td>
</tr>
<tr>
<td>$request_filename</td>
<td>当前请求的文件路径</td>
<td>由root或alias指令与URI请求生成</td>
</tr>
<tr>
<td>$request_completion</td>
<td>如果请求结束，设置为OK。否则为空</td>
<td>xxx</td>
</tr>
<tr>
<td>$scheme</td>
<td>HTTP方法</td>
<td>如http, https</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>请求使用的协议</td>
<td>通常为HTTP/1.0或HTTP/1.1</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器地址</td>
<td>在完成一次系统调用后可以确定这个值</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器名称</td>
<td>xxx</td>
</tr>
<tr>
<td>$server_port</td>
<td>请求到达服务器的端口号</td>
<td>xxx</td>
</tr>
<tr>
<td>$status</td>
<td>请求的响应状态码</td>
<td>如200</td>
</tr>
<tr>
<td>$request_uri</td>
<td>包含请求参数的原始URI，不包含主机名</td>
<td>如”/foo/bar.php?arg=abc”</td>
</tr>
<tr>
<td>$uri</td>
<td>不带请求参数的当前URI，不包含主机名</td>
<td>如”/foo/bar.html”</td>
</tr>
</tbody>
</table>
<p>栗子：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">http://localhost:88/test1/test2/test.php</div><div class="line"></div><div class="line"><span class="variable">$hsot</span>: localhost</div><div class="line"><span class="variable">$server_port</span>: 88</div><div class="line"><span class="variable">$request_uri</span>: http://localhost:88/test1/test2/test.php</div><div class="line"><span class="variable">$document_uri</span>: /test1/test2/test.php</div><div class="line"><span class="variable">$document_root</span>: /var/www/<span class="built_in">test</span></div><div class="line"><span class="variable">$request_filename</span>: /var/www/<span class="built_in">test</span>/test1/test2/test.php</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="rewrite实例"><a href="#rewrite实例" class="headerlink" title="rewrite实例"></a>rewrite实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">	log_format main xxxx;</div><div class="line">	rewrite_log on;</div><div class="line"></div><div class="line"></div><div class="line">    server &#123;</div><div class="line">    	root /var/www/zhang;</div><div class="line">        location / &#123;</div><div class="line">        	error_log logs/rewrite.log notice;</div><div class="line">            rewrite <span class="string">'^/images/([a-z]&#123;2&#125;)/([a-z0-9]&#123;5&#125;)/(.*)\.(png|jpg|gif)'</span>/data?file=<span class="variable">$3</span>.<span class="variable">$4</span>;</div><div class="line">            <span class="built_in">set</span> <span class="variable">$image_file</span> <span class="variable">$3</span>;</div><div class="line">            <span class="built_in">set</span> <span class="variable">$image_type</span> <span class="variable">$4</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /data &#123;</div><div class="line">        	access_log logs/images.log main;</div><div class="line">            root /data/images;</div><div class="line">            type_file /<span class="variable">$arg_file</span> /images404.html;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		location = /image404.html &#123;</div><div class="line">        	<span class="built_in">return</span> 404 <span class="string">"Image Not Found\n"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h2 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h2><p><br></p>
<h3 id="添加用户密码验证"><a href="#添加用户密码验证" class="headerlink" title="添加用户密码验证"></a>添加用户密码验证</h3><p>有时需要为我们的网站设置访问账号和密码权限。</p>
<p>具体为这两个参数：</p>
<ul>
<li><code>auth_basic</code><ul>
<li>默认值： <code>auth_basic off;</code></li>
<li>使用位置：http, server, location, limit_except</li>
</ul>
</li>
<li><code>auth_basic_user_file</code><ul>
<li>使用位置： http, server, location, limit_except</li>
</ul>
</li>
</ul>
<p>栗子：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/nginx/conf.d</div><div class="line">vim test.conf</div><div class="line"></div><div class="line"></div><div class="line">location / &#123;</div><div class="line">	auth_basic <span class="string">"Zhang"</span>;</div><div class="line">    auth_basic_user_file /etc/nginx/nginx.auth;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">vim /etc/nginx/nginx.auth</div><div class="line"></div><div class="line"><span class="comment">#user:passwd</span></div><div class="line">zhang:zhang</div><div class="line"><span class="built_in">test</span>:<span class="built_in">test</span></div></pre></td></tr></table></figure>
<p><img src="/images/Nginx/auth.png" alt=""></p>
<p><br></p>
<h3 id="限制IP访问"><a href="#限制IP访问" class="headerlink" title="限制IP访问"></a>限制IP访问</h3><ul>
<li>allow</li>
<li>deny</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">	...</div><div class="line">    allow IP1</div><div class="line">    allow IP2;</div><div class="line">    deny all;</div><div class="line"></div><div class="line">	location / &#123;</div><div class="line">    	allow IP 1;</div><div class="line">        deny all;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>deny一定要加一个IP，否则会直接跳转403，不在往下执行。如果403默认页是在同一域名下，会造成死循环访问</li>
<li>对于allow的IP短，从允许访问的IP段位从小到大排列，如127.0.0.0/24， 10.10.0.0/16</li>
<li>以<code>deny all</code>结尾，表示除了上面允许的，其它都禁止</li>
</ul>
<p><br><br><br></p>
<h2 id="语法检查"><a href="#语法检查" class="headerlink" title="语法检查"></a>语法检查</h2><p>在启动或重启Nginx服务前检查语法非常重要，可以防止因配置错误导致网站重启或重载配置对用户的影响。</p>
<p>每次更改Nginx配置文件后都需要重新加载，将配置信息加载到内存中。这样设计的目的是大幅度提升Nginx的访问性。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nginx -t</div><div class="line"></div><div class="line">nginx -s reload</div></pre></td></tr></table></figure>
<p><br></p>
<hr>
<p><br></p>
<h1 id="Nginx优化"><a href="#Nginx优化" class="headerlink" title="Nginx优化"></a>Nginx优化</h1><p><br></p>
<h2 id="常用优化"><a href="#常用优化" class="headerlink" title="常用优化"></a>常用优化</h2><p><br></p>
<h3 id="隐藏Nginx版本号"><a href="#隐藏Nginx版本号" class="headerlink" title="隐藏Nginx版本号"></a>隐藏Nginx版本号</h3><p>一般来说，软件漏洞都和版本有关。因此要尽量隐藏对访问用户显示各类敏感信息。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginc/nginx.conf</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#nginx版本号默认是开启的</span></div><div class="line"><span class="comment">#位置：http, server, location</span></div><div class="line"></div><div class="line">http &#123;</div><div class="line">	server_tokens off|on;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="更改Nginx服务默认用户"><a href="#更改Nginx服务默认用户" class="headerlink" title="更改Nginx服务默认用户"></a>更改Nginx服务默认用户</h3><ol>
<li>修改配置文件</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">user nginx;</div></pre></td></tr></table></figure>
<ol>
<li>如果是编译安装，直接在编译的时候指定用户和组</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure --user=nginx --group=nginx</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="优化Nginx进程对应的配置"><a href="#优化Nginx进程对应的配置" class="headerlink" title="优化Nginx进程对应的配置"></a>优化Nginx进程对应的配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">worker_process n;</div><div class="line"><span class="comment">#建议n为CPU核数</span></div><div class="line"><span class="comment">#高并发场合可考虑为核数*2</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#查看CPU核数</span></div><div class="line">cat /proc/cpuinfo | grep processor | wc -l</div><div class="line">lscpu</div><div class="line">top命令，按1显示所有CPU核数</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="优化绑定不同的Nginx进程到不同的CPU上"><a href="#优化绑定不同的Nginx进程到不同的CPU上" class="headerlink" title="优化绑定不同的Nginx进程到不同的CPU上"></a>优化绑定不同的Nginx进程到不同的CPU上</h3><p>默认情况下，Nginx的多个进程有可能跑在某一个CPU或CPU的某一核上，导致Nginx进程使用硬件资源不均。<br>所以，要尽可能地分配不同的Nginx进程给不同的CPU处理，达到充分有效利用硬件的多CPU多核资源的目的。</p>
<p>4核CPU配置举例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">worker_processes 4;</div><div class="line"><span class="comment">#CPU亲和力参数</span></div><div class="line">worker_cpu_affinity 0001 0010 0100 1000;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Nginx事件处理模型优化"><a href="#Nginx事件处理模型优化" class="headerlink" title="Nginx事件处理模型优化"></a>Nginx事件处理模型优化</h3><p>Nginx的连接处理机制在不同的操作系统会采用不同的I/O模型，在Linux下，Nginx使用epoll的I/O多路复用模型，在FreeBSD中使用kqueue的I/O多路复用模型，在solaris中使用/dev/poll方式的I/O多路复用模型，在Windows中使用的是icop。</p>
<p>配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#对于linux内核，推荐使用epoll工作模式</span></div><div class="line"><span class="comment">#Linux下默认epoll</span></div><div class="line"></div><div class="line">vim /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">events &#123;</div><div class="line">	use epoll;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Nginx单个进程允许的客户端最大连接数"><a href="#Nginx单个进程允许的客户端最大连接数" class="headerlink" title="Nginx单个进程允许的客户端最大连接数"></a>Nginx单个进程允许的客户端最大连接数</h3><p>请根据服务器性能和程序的内存使用量来合理制定最大连接数。<br>这个连接数包括了所有连接，如<strong>代理服务器连接、客户端的连接、实际的并发连接</strong>。</p>
<p>Nginx总并发连接数=worker*worker_connections</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">events &#123;</div><div class="line">	worker_connections 10240;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>仅仅修改了nginx最大连接数可能还不行，由于Linux系统有<code>ulimit</code>限制，所以可能还要做额外操作。</p>
<p>如：<code>nginx: [warn] 10240 worker_connections exceed open file resource limit: 1024</code>。</p>
<p>配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">ulimit</span> -a</div><div class="line"></div><div class="line"><span class="built_in">ulimit</span> -n 10240</div></pre></td></tr></table></figure>
<p>注意，使用<code>ulimit</code>命令修改的值并不是永久生效的。</p>
<p><br></p>
<h3 id="Nginx-worker进程最大打开文件数"><a href="#Nginx-worker进程最大打开文件数" class="headerlink" title="Nginx worker进程最大打开文件数"></a>Nginx worker进程最大打开文件数</h3><p>可能也要注意<code>ulimit</code>系统限制！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">events &#123;</div><div class="line">	worker_rlimit_nofile 65535;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="开启高效文件传输"><a href="#开启高效文件传输" class="headerlink" title="开启高效文件传输"></a>开启高效文件传输</h3><h4 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h4><p>sendfile()是作用于两个文件描述符之间的数据拷贝，这个拷贝是在内核之中的，被称为零拷贝。sendfile（）比read和write函数要高效很多，因为write和read函数要把数据拷贝到应用层再进行操作。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#位置：http, server, location, if in location</span></div><div class="line">sendfile on;</div></pre></td></tr></table></figure>
<p><br></p>
<h4 id="tcp-nopush"><a href="#tcp-nopush" class="headerlink" title="tcp_nopush"></a>tcp_nopush</h4><p>激活或禁用Linux上的TCP_CORK socket选项，仅当开启sendfile生效。允许把 http response和文件的开始部分放在一个文件里发布，其积极作用是减少网络报文段的数量。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server, location</div><div class="line">tcp_nopush on;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Nginx连接参数，连接超时时间"><a href="#Nginx连接参数，连接超时时间" class="headerlink" title="Nginx连接参数，连接超时时间"></a>Nginx连接参数，连接超时时间</h3><p>keep-alive可以使客户端到服务器端已经建立的连接一致工作不退出，当服务器有持续请求时，keep-alive会使用已经建立的连接提供服务，从而避免服务器重新建立新连接请求处理。</p>
<p>连接超时的作用：</p>
<blockquote>
<p>将无用的连接设置为尽快超时，可保护系统资源（CPU、内存、磁盘）<br>连接很多时，及时断掉那些已经建立好但又长时间不做事的连接，以减少其占用的服务器资源。因为服务器维护连接也是消耗资源的<br>黑客和恶意用户攻击网站，也会不断地和服务器建立多个连接，消耗连接数但啥也不干，大量消耗服务器的资源，此时就应该及时断掉这些恶意占用资源的连接<br>LNMP环境中，如果用户请求了动态服务，则Nginx就会建立连接，请求FastCGI服务以及后端的MySQL服务，此时这个Nginx连接就要设置一个超时时间，在用户容忍的时间内返回数据，或者再多等一会后端服务返回数据，具体策略根据具体业务进行具体分析<br>后端的FastCGI服务及MySQL服务也有对连接的超时控制</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server, location</div><div class="line">keepalive_timeout 60;</div></pre></td></tr></table></figure>
<p><br></p>
<p>默认情况下当数据发送时，内核并不会马上发送，可能会等待更多的字节组成一个数据包，这样可以提高I/O性能。<br>但是，在每次只发送很少字节的业务场景中，不使用tcp_nodelay功能，等待时间会比较长。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server, location</div><div class="line">tcp_nodelay on;</div></pre></td></tr></table></figure>
<p><br></p>
<p>读取客户端请求头数据的超时时间，如果超过这个时间，客户端还没有发送完整的header数据，服务器端将返回“Request time out（408）”错误。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server</div><div class="line">client_header_timeout 20;</div></pre></td></tr></table></figure>
<p><br></p>
<p>读取客户端请求主体的超时时间，如果在这个超时时间内，客户端没有发送任何数据，Nginx将返回“Request time out（408）”错误。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server, location</div><div class="line">client_body_timeout 60;</div></pre></td></tr></table></figure>
<p><br></p>
<p>指定响应客户端的超时时间，为握手后的一个超时。如果超过这个时间，客户端没有任何活动，Nginx将会关闭连接。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server, location</div><div class="line">send_timeout 60;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="上传文件大小限制-动态应用"><a href="#上传文件大小限制-动态应用" class="headerlink" title="上传文件大小限制(动态应用)"></a>上传文件大小限制(动态应用)</h3><p>设置为0，表示禁止检查客户端请求主体的大小。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">位置： http, server, location</div><div class="line">client_max_body_size 20m;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="gzip压缩"><a href="#gzip压缩" class="headerlink" title="gzip压缩"></a>gzip压缩</h3><p>Nginx gzip压缩模块提供了压缩文件内容的功能，用户请求的内容在发送到用户客户端之前，Nginx服务器会根据一些具体的策略实施压缩，以节约网络出口带宽，同时加快数据传输效率，提升用户体验。</p>
<p>压缩对象：</p>
<ul>
<li>纯文本内容压缩比很高，如 html, js, css, xml等</li>
<li>被压缩的纯文本文件必须要大于1KB，由于压缩算法的特殊原因，极小的文件压缩后可能反而变大</li>
<li>图片、媒体等文件尽量不要压缩，因为这些文件大都经过压缩，再压缩很可能不会减小很多，或有可能增大，同时还要消耗系统资源</li>
</ul>
<p>配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#压缩功能</span></div><div class="line">gzip on;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#允许压缩的页面最小字节数</span></div><div class="line">gzip_min_length  1K;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#申请4个单位为16K的内存作为压缩结果流缓存</span></div><div class="line">gzip_buffers  4 16K;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#http协议版本</span></div><div class="line">gzip_http_version  1.1;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#指定压缩比，1压缩比最小，处理速度最快；9压缩比最大，传输速度最快，处理最慢</span></div><div class="line">gzip_comp_level  5;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#指定压缩类型，对应文件类型参考mime.types</span></div><div class="line">gzip_types  text/html text/css;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#vary header支持</span></div><div class="line">gzip_vary on;</div></pre></td></tr></table></figure>
<p>在response header中查看效果： <code>Content-Encofing: gzip</code></p>
<p><br></p>
<h3 id="expires缓存"><a href="#expires缓存" class="headerlink" title="expires缓存"></a>expires缓存</h3><p>Nginx expires的功能就是为用户访问的网站内容设定一个过期时间。</p>
<p>当用户第一次访问这些内容时，会把这些内容储存在用户浏览器本地，这样用户第二次及以后继续访问该网站时，浏览器会检查加载已经缓存在用户浏览器本地的内容，而不用去服务器下载，直到缓存的内容过期或被清除为止。</p>
<p>缓存也要根据业务！当网站数据更新时，用户端看到的可能还是旧的已经缓存的内容。</p>
<p>配置：</p>
<ol>
<li>根据文件扩展名进行判断</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location ~ .*\.(gif|png|jpg|swf)$ &#123;</div><div class="line">	expires 10d;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">location ~ .*\.(css|js)$ &#123;</div><div class="line">	expires 20d;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>根据目录进行判断</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location ~ ^/(images|static|media)/ &#123;</div><div class="line">	expires 50d;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在response header中查看：</p>
<blockquote>
<p>Expires: 缓存过期时间<br>Cache-Control： 缓存总时间</p>
</blockquote>
<p><br><br><br></p>
<h2 id="FastCGI相关参数"><a href="#FastCGI相关参数" class="headerlink" title="FastCGI相关参数"></a>FastCGI相关参数</h2><p>FastCGI参数是配合Nginx向后请求PHP动态引擎服务的相关参数，这里指的是Nginx中的配置参数。</p>
<p>Module ngx_http_fastcgi_module： <a href="https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" target="_blank" rel="noopener">https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#给FastCGI服务器设置地址</span></div><div class="line">fastcgi_pass</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#设置一个将在 $fastcgi_scripts_name 变量结尾的URI之后添加的文件名</span></div><div class="line">fastcgi_index</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#设置一个应该传递给FastCGI服务器的参数，当且仅当fastcgi_param在当前级别上没有定义指令时，这些指令将从上一级继承</span></div><div class="line">fastcgi_param</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#指定在哪种情况下将请求传递给下一个服务器；</span></div><div class="line">fastcgi_next_upsteam</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#表示Nginx服务器和后端FastCGI服务器连接的超时时间，默认值为60秒，这个参数通常不要超过75秒</span></div><div class="line">fastcgi_connect_timeout</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#设置Nginx允许FastCGI服务器端返回数据的超时时间，即在规定时间之内后端服务器必须传完所有的数据。否则，Nginx将断开这个连接</span></div><div class="line">fastcgi_send_timeout</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#设置Nginx从FastCGI服务器端读取响应信息的超时时间，表示连接建立成功后，Nginx等待后端服务器的响应时间，是Nginx已经进入后端的排队之中等候处理的时间</span></div><div class="line">fastcgi_read_timeout</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#这是Nginx FastCGI的缓冲区大小参数，设定用来读取从FastCGI服务器端收到的第一部分响应信息的缓冲区大小，这里的第一部分通常会包含一个小的响应头部</span></div><div class="line">fastcgi_buffer_size</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#设定用来读取从FastCGI服务器端收到的响应信息的缓冲区大小和缓冲区数量</span></div><div class="line">fastcgi_buffers</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#用于设置系统很忙时可以使用的proxy_buffers大小，官方推荐大小为proxy_buffers * 2</span></div><div class="line">proxy_busy_buffers_size</div><div class="line"></div><div class="line"></div><div class="line"> <span class="comment">#用于设置系统很忙时可以使用的fastcgi_buffers大小，官方推荐为 fastcgi_buffers * 2</span></div><div class="line">fastcgi_busy_buffers_size</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#FastCGI临时文件大小</span></div><div class="line">fastcgi_temp_file_write_size</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#表示开启FastCGI缓存并为其指定一个名称</span></div><div class="line">fastcgi_cache cachename_nginx</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#fastcgi_cache缓存目录</span></div><div class="line">fastcgi_cache_path</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#用来指定应答代码的缓存时间</span></div><div class="line">fastcgi_cache_valid</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#设置请求几次之后响应将被缓存</span></div><div class="line">fastcgi_cache_min_uses</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#定义在哪些情况下使用过期缓存</span></div><div class="line">fastcgi_cache_use_stale</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#定义fastcgi_cache的key</span></div><div class="line">fastcgi_cache_key</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="日志与安全"><a href="#日志与安全" class="headerlink" title="日志与安全"></a>日志与安全</h2><p>现在Nginx 日志已经自动轮询了，所以感觉没有必要自己切割日志！</p>
<p><br></p>
<h3 id="不记录不需要的日志"><a href="#不记录不需要的日志" class="headerlink" title="不记录不需要的日志"></a>不记录不需要的日志</h3><p>日志写入太频繁会消耗大量的磁盘I/O，降低服务性能。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location ~ .*\.(js|png|css|gif|jpg) &#123;</div><div class="line">	access_log off;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="日志权限"><a href="#日志权限" class="headerlink" title="日志权限"></a>日志权限</h3><p>因为nginx master process的UID是root，所以可以修改日志权限。<br>不需要在日志目录上给Nginx用户读或写许可，很多人没注意这个问题，把权限直接给了Nginx用户，这就存在安全隐患。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown -R root:root  /path/<span class="built_in">log</span>/nginx</div><div class="line">chmod -R 700 /path/<span class="built_in">log</span>/nginx</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="站点目录及URL访问控制"><a href="#站点目录及URL访问控制" class="headerlink" title="站点目录及URL访问控制"></a>站点目录及URL访问控制</h2><h3 id="根据扩展名限制程序或文件访问"><a href="#根据扩展名限制程序或文件访问" class="headerlink" title="根据扩展名限制程序或文件访问"></a>根据扩展名限制程序或文件访问</h3><p>利用Nginx配置禁止访问上传资源目录下的PHP、Shell、Perl、Python程序文件，这样用户即使上传了木马文件也没法执行，从而加强了网站的安全。</p>
<p>对这些的限制必须放在Nginx处理<code>.php, .py, .sh</code>等文件的前面！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#禁止解析指定目录下的程序</span></div><div class="line">location ~ ^/images/.*\.(php|py|sh|pl)$ &#123;</div><div class="line">	deny all;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">location ~ ^/static/.*\.(py|php|pl|sh) &#123;</div><div class="line">	deny all;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#禁止访问某些文件</span></div><div class="line">location ~* \.(txt|doc)$ &#123;</div><div class="line">	root /var/www/file;</div><div class="line">    deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="禁止访问指定目录"><a href="#禁止访问指定目录" class="headerlink" title="禁止访问指定目录"></a>禁止访问指定目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">location ~ ^/<span class="built_in">test</span>/ &#123;</div><div class="line">	deny all;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#禁止访问多个目录</span></div><div class="line">location ~ ^/(<span class="built_in">test</span>|zhang) &#123;</div><div class="line">	deny all;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#返回状态码</span></div><div class="line">location ~ ^/haha/ &#123;</div><div class="line">	<span class="built_in">return</span> 403 <span class="string">"Hahaha"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="禁止非法域名解析访问网站"><a href="#禁止非法域名解析访问网站" class="headerlink" title="禁止非法域名解析访问网站"></a>禁止非法域名解析访问网站</h2><p>防止用户恶意域名解析。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/nginx/conf.d</div><div class="line">vim default.conf</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#返回HTTP状态码</span></div><div class="line">server &#123;</div><div class="line">	listen 80 default_server;</div><div class="line">    server_name _;</div><div class="line">    <span class="built_in">return</span> 403;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#重定向</span></div><div class="line">server &#123;</div><div class="line">	listen 80 default_server;</div><div class="line">    server_name _;</div><div class="line">    rewrite ^(.*) https://www.baidu.com permanent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p>利用<code>default_server</code>，将网站所有请求定向到维护页面。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">	listen 80 default_server;</div><div class="line">    server_name _;</div><div class="line">    root /var/www;</div><div class="line"></div><div class="line">	location / &#123;</div><div class="line">    	rewrite ^(.*) /maintance.html <span class="built_in">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">cd</span> /var/www</div><div class="line">vim maintance.html</div><div class="line"></div><div class="line"></div><div class="line">&lt;html&gt;</div><div class="line"></div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</div><div class="line">&lt;style <span class="built_in">type</span>=<span class="string">"text/css"</span>&gt;</div><div class="line">    h1&#123;text-align: center;</div><div class="line">       color: red;&#125;</div><div class="line">&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line"></div><div class="line">&lt;br&gt;</div><div class="line">&lt;br&gt;</div><div class="line"></div><div class="line">&lt;body&gt;</div><div class="line"></div><div class="line">&lt;h1&gt;网站维护中！&lt;/h1&gt;</div><div class="line"></div><div class="line">&lt;/body&gt;</div><div class="line"></div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="图片及目录防盗链"><a href="#图片及目录防盗链" class="headerlink" title="图片及目录防盗链"></a>图片及目录防盗链</h2><p><br></p>
<h3 id="什么是资源盗链"><a href="#什么是资源盗链" class="headerlink" title="什么是资源盗链"></a>什么是资源盗链</h3><p>简单地说，就是某些不法网站未经许可，通过在其自身网站程序里非法调用其他网站的资源，然后在自己的网站上显示这些调用的资源，达到填充自身网站的效果。</p>
<p>这一举动不仅浪费了调用资源网站的网络流量，还造成其他网站的带宽及服务压力吃紧。</p>
<p>问题：</p>
<blockquote>
<p>某公司CDN源站流量没有变化，但CDN加速那边流量超了很多。这么大异常流量，全都是钱呀！</p>
</blockquote>
<p><br></p>
<h3 id="常见防盗链解决方案"><a href="#常见防盗链解决方案" class="headerlink" title="常见防盗链解决方案"></a>常见防盗链解决方案</h3><p><br></p>
<h4 id="根据HTTP-referer-实现防盗链"><a href="#根据HTTP-referer-实现防盗链" class="headerlink" title="根据HTTP referer 实现防盗链"></a>根据HTTP referer 实现防盗链</h4><p>在HTTP 协议中，有一个表头字段叫 referer，使用URL格式来表示是哪里的链接用了当前网页的资源。</p>
<p>通过referer可以检测访问的来源网页，如果是资源文件，可以跟踪到显示它的网页地址，一旦检测出来不是本站，马上进行阻止。</p>
<p>HTTP referer 是header的一部分，当浏览器向web服务器发送请求时，一般会带上referer，告诉服务器我是从哪个页面过来的，服务器借此获得一些信息用于处理。</p>
<p><br></p>
<h4 id="根据cookie防盗链"><a href="#根据cookie防盗链" class="headerlink" title="根据cookie防盗链"></a>根据cookie防盗链</h4><p>通过加密技术变换访问路径实现防盗链</p>
<p><br></p>
<h3 id="Nginx实现防盗链"><a href="#Nginx实现防盗链" class="headerlink" title="Nginx实现防盗链"></a>Nginx实现防盗链</h3><p>利用<code>referer</code>，针对指定扩展名进行<code>rewrite</code>或其他操作。</p>
<p>请根据实际情况进行域名防盗链！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location ~* \.(jpg|png|gif|wav|mp3|zip|rar)$ &#123;</div><div class="line">	valid_referers none blocked *.zhang.com;</div><div class="line">    <span class="keyword">if</span> (<span class="variable">$invalid_regerer</span>) &#123;</div><div class="line">    	rewrite https://www.baidu.com;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>或者在产品设计上解决防盗链，如为资源加上水印等措施。</p>
<p><br><br><br></p>
<h2 id="错误页面优雅展示"><a href="#错误页面优雅展示" class="headerlink" title="错误页面优雅展示"></a>错误页面优雅展示</h2><p>我们可以将404、403等错误信息重定向到其他指定的页面，提升网站的用户访问体验！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">	xxxx;</div><div class="line"></div><div class="line"></div><div class="line">	error_page 403 /403.html;</div><div class="line">    error_page 404 /404.jpg;</div><div class="line">    error_page 500 503 504 /50x.html;</div><div class="line"></div><div class="line">	location = /50x.html &#123;</div><div class="line">    	root /var/www/50x.html;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="目录及文件权限优化"><a href="#目录及文件权限优化" class="headerlink" title="目录及文件权限优化"></a>目录及文件权限优化</h2><p>为了保证网站安全，所有站点的目录和用户组都为root，所有目录权限是755，所有文件权限是644。<br>虽然这样的全线可以防止黑客上传修改站点的文件，但这样合法的用户便也没有了上传权限。</p>
<p>比较好的方法是将用户上传文件的服务器与读取服务器进行分离，这样就可以进行安全授权。不同的服务所在的目录的权限依据业务功能而不同。</p>
<p>严格控制Nginx目录的访问才能降低网站被入侵的风险！</p>
<p><br><br><br></p>
<h2 id="反爬虫优化"><a href="#反爬虫优化" class="headerlink" title="反爬虫优化"></a>反爬虫优化</h2><p><br></p>
<h3 id="robots-txt机器人协议"><a href="#robots-txt机器人协议" class="headerlink" title="robots.txt机器人协议"></a>robots.txt机器人协议</h3><p>robots协议(<a href="https://zh.wikipedia.org/wiki/Robots.txt" target="_blank" rel="noopener">维基百科</a>)，也称为机器人协议，全称是<strong>网络爬虫排除标准（Robots Exclusion Protocol）</strong>。网站通过Robots协议告诉搜索引擎那些页面可以抓取，那些页面不能抓取。</p>
<p>robots.txt协议并不是一个规范，而只是约定俗成的，所以并不能保证网站的隐私。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">User-Agent: *</div><div class="line">Allow: /zhang</div><div class="line">Disallow: /</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Nginx反爬虫配置"><a href="#Nginx反爬虫配置" class="headerlink" title="Nginx反爬虫配置"></a>Nginx反爬虫配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* LWP::Simple|BBBike|wget) &#123;</div><div class="line">	<span class="built_in">return</span> 403;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> （<span class="variable">$http_user_agent</span> ~* (Firefox|MSIE) &#123;</div><div class="line">rewrite ^（.*） http://www.baidu.com:</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="限制HTTP请求方法"><a href="#限制HTTP请求方法" class="headerlink" title="限制HTTP请求方法"></a>限制HTTP请求方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ( <span class="variable">$request_method</span> !~ ^(GET|POST|HEAD)$ ) &#123;</div><div class="line">	<span class="built_in">return</span> 501;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h2><p>CDN的全称是 Content Delivery Network，中文意思是内容分发网络。<br>我们可以利用CDN做网站内容加速。</p>
<p>简单地讲，通过现有的Internet中增加一层新的网络架构，将网站的内容发布到最接近用户的Cache服务器内，通过智能DNS负载均衡技术，判断用户的来源，让用户就近使用与服务器相同线路的带宽访问Cache服务器，取得所需的内容。</p>
<blockquote>
<p>例如，北京电信用户访问北京电信Cache服务器上的内容，四川网通用户访问成都网通Cache服务器上的内容。这样可以有效减少数据在网络上传输的时间，提高访问速度。<br>CDN是一套全国或全球的风不是缓存集群，其实质是通过职能DNS判断用户的来源地域及上网线路，为用户选择一个最接近用户地域，以及和用户上网线路相同的服务器节点。因为低于近，线路相同，所以可以大幅度提升用户浏览网站的体验。</p>
</blockquote>
<p><br></p>
<p>CDN的价值：</p>
<ul>
<li>提升用户体验</li>
<li>阻挡大部分流量攻击</li>
</ul>
<p><br></p>
<p>CDN的特点：</p>
<ul>
<li>通过服务器内存缓存网站数据，提高了企业站点（尤其是含有大量图片、视频等的站点）的访问速度，并大大提高企业站点的稳定性；</li>
<li>用户根据智能DNS技术自动选择最适合的Cache服务器，降低不同运营商之间互联瓶颈造成的影响，实现了跨运营商的网络加速，保证不同网络中的用户都能得到良好的访问速度；</li>
<li>加快了访问速度，减少了原站点的带宽；</li>
<li>用户访问时从服务器的内存中读取数据，分担了网络流量，同时减轻了原站点负载压力；</li>
<li>使用CDN可以分担源站的网络流量，同时减轻源站的负载压力，并降低黑客入侵及各种DDOS攻击对网站的影响，保证网站有较好的服务质量；</li>
</ul>
<p><br></p>
<h3 id="使用CDN的要求"><a href="#使用CDN的要求" class="headerlink" title="使用CDN的要求"></a>使用CDN的要求</h3><p>首先要说的是，不是所有的网站都可以一上来就能用CDN的。要加速的业务数据应该存在独立的域名。如 pub.zhang21.com，业务内容图片、附件、JS、CSS等静态元素，这样的静态网站域名才能使用CDN。</p>
<p><strong>将域名做CNAME(别名)</strong><br>将如上的<code>pub.zhang21.com</code>配置成CDN的域名。</p>
<p><br><br><br></p>
<h2 id="程序架构优化"><a href="#程序架构优化" class="headerlink" title="程序架构优化"></a>程序架构优化</h2><p><strong>解耦</strong> 是开发人员中流行的一个名词，简单地说就是把一堆程序代码按照业务用途分开，然后提供服务。</p>
<blockquote>
<p>例如，注册登录、上传、下载、浏览、商品页信息等都应该是独立的程序服务，只不过在客户端看来是一个整体而已。</p>
</blockquote>
<p><br></p>
<p>分离的最佳方式是分别使用独立的服务器，可以选择改动程序或者在负载均衡器上配置（如Nginx），过滤请求，然后抛给后面对应的服务器。</p>
<ul>
<li>根据扩展名分发，请求图片就抛给图片服务器；</li>
<li>根据URL路径转发，请求下载就交给下载服务器；</li>
<li>请求动态PHP处理的就交给动态处理器；</li>
<li>不符合以上要求的就交给默认服务器；</li>
</ul>
<p><br><br><br></p>
<h2 id="使用no-root用户启动Nginx"><a href="#使用no-root用户启动Nginx" class="headerlink" title="使用no-root用户启动Nginx"></a>使用no-root用户启动Nginx</h2><p>默认情况下，Nginx的Master进程使用的是root用户，worker进程使用的是Nginx指定的普通用户。</p>
<p>使用root用户跑Nginx的Master进程有两个最大问题：</p>
<ul>
<li>管理权限必须是root，这就使得最小化分配权限原则遇到困难</li>
<li>使用root跑Nginx服务，一旦网站出现漏洞，用户就可以很容易地获取服务器的root权限</li>
</ul>
<p><br><br><br></p>
<h2 id="控制Nginx并发连接数"><a href="#控制Nginx并发连接数" class="headerlink" title="控制Nginx并发连接数"></a>控制Nginx并发连接数</h2><p><code>ngx_http_limit_conn_module</code>这个模块用于限制每个定义的Key值的连接数，特别是单IP的连接数。</p>
<p>不是所有的连接数都会被计数，一个符合要求的连接是整个请求头已经被读取的连接。</p>
<p>用法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#位置： http</span></div><div class="line">limit_conn_zone key zone=name:size;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#位置： http, server, location</span></div><div class="line">limit_conn zone number;</div></pre></td></tr></table></figure>
<p>栗子：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">	limit_conn_zone <span class="variable">$binary_remote_addr</span> zone=addr:10m;</div><div class="line">    xxx;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">	xxx;</div><div class="line">    location /download/ &#123;</div><div class="line">    	limit_conn addr 3;</div><div class="line">        <span class="comment">#限制单IP并发连接为3</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="控制客户端请求Nginx的速率"><a href="#控制客户端请求Nginx的速率" class="headerlink" title="控制客户端请求Nginx的速率"></a>控制客户端请求Nginx的速率</h2><p><code>ngx_http_limit_req_module</code>被用来限制每个IP访问没法key的请求速率。</p>
<p>用法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#位置： http</span></div><div class="line">limit_req_zone key zone=name:size rate=rate;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#位置： http, server, location</span></div><div class="line">limit_req zone=name;</div></pre></td></tr></table></figure>
<p>栗子：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">limit_req_zone <span class="variable">$binary_remote_addr</span> zone=one:10m rate=1r/s;</div><div class="line"></div><div class="line">  server &#123;</div><div class="line">	location /search/ &#123;</div><div class="line">	limit_req zone=one burst=5;</div><div class="line">	&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<hr>
<p><br></p>
<h1 id="Nginx反向代理与负载均衡"><a href="#Nginx反向代理与负载均衡" class="headerlink" title="Nginx反向代理与负载均衡"></a>Nginx反向代理与负载均衡</h1><p><br></p>
<h2 id="反向代理与负载均衡"><a href="#反向代理与负载均衡" class="headerlink" title="反向代理与负载均衡"></a>反向代理与负载均衡</h2><p>严格地说，Nginx仅仅是作为Nginx Proxy反向代理使用的，因为这个反向代理功能表现的效果是负载均衡集群的效果，所以本文称之为Nginx负载均衡。</p>
<ul>
<li>普通的负载均衡软件，如LVS，其实现的功能只是对请求数据包的转发、传递，从负载均衡下的节点服务器来看，接收到的请求还是来自访问负载均衡器的客户端的真实用户</li>
<li>反向代理服务器在接收访问用户请求后，会代理用户 重新发起请求代理下的节点服务器，最后把数据返回给客户端用户。在节点服务器看来，访问的节点服务器的客户端用户就是反向代理服务器，而非真实的网站访问用户</li>
<li>即，LVS等负载均衡是转发用户请求的数据包，而Nginx反向代理是接收用户请求后重新发起请求后端节点</li>
</ul>
<blockquote>
<p>这里我去看了一下Nginx的access.log，客户端的访问日志全在代理节点上（Nginx-upstream），而后端节点的access.log的来源是前端代理节点的IP</p>
</blockquote>
<p><br><br><br></p>
<h2 id="Nginx负载均衡的组件"><a href="#Nginx负载均衡的组件" class="headerlink" title="Nginx负载均衡的组件"></a>Nginx负载均衡的组件</h2><p>实现Nginx负载均衡的组件主要有两个:</p>
<ul>
<li>proyx</li>
<li>upstream</li>
</ul>
<table>
<thead>
<tr>
<th>Nginx_http模块</th>
<th>模块说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_http_proxy_module</td>
<td>proxy代理模块，用于把请求后抛给服务器节点或upstream服务器池</td>
</tr>
<tr>
<td>ngx_http_upstream_module</td>
<td>负载均衡模块，可以实现网站的负载均衡功能即节点的健康检查</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="nginx-upstream模块"><a href="#nginx-upstream模块" class="headerlink" title="nginx upstream模块"></a>nginx upstream模块</h3><p><br></p>
<h4 id="upstream模块介绍"><a href="#upstream模块介绍" class="headerlink" title="upstream模块介绍"></a>upstream模块介绍</h4><p>Module ngx_http_upstream_module: <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></p>
<p>upstream主要是用于七层上的负载均衡和转发。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Syntax：    upstream name &#123; ... &#125;</div><div class="line">Default:    —</div><div class="line">Context:    http</div></pre></td></tr></table></figure>
<p>Nginx的负载均衡功能依赖于ngx_http_upstream_module模。所支持的代理方式包括：</p>
<ul>
<li>proxy_pass</li>
<li>fastcgi_pass</li>
<li>memcached_pass</li>
<li>uwsgi_pass</li>
<li>scgi_pass</li>
</ul>
<p><br></p>
<p>upstream模块允许Nginx定义一组或多组节点服务器组，使用时可通过<code>proxy_pass</code>代理方式把网站的请求发送到事先定义好的对应<code>upstream组</code>的名字上。</p>
<p><br></p>
<p><strong>upstream模块内容放置于http{}内</strong>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">upstream upstream_name &#123;</div><div class="line">    server  address  [ parameters ]</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">####栗子</span></div><div class="line">http &#123;</div><div class="line">	upstream zhang &#123;</div><div class="line">		server 192.168.1.22:8080 weight=5;</div><div class="line">    	server www.zhang.cn weigh=5 max_conns=102400;</div><div class="line">        server 192.168.33 max_fails=2 fail_timeout=20s;</div><div class="line">    	server backup.zhang.cn backup;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">server &#123;</div><div class="line">	location / &#123;</div><div class="line">    	proxy_pass http://zhang;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">####reslove</span></div><div class="line">http &#123;</div><div class="line">    resolver 10.0.0.1;</div><div class="line">    upstream u &#123;</div><div class="line">        zone ...;</div><div class="line">        ...</div><div class="line">        server example.com resolve;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>address可以是主机名、域名、ip或Unix Socket，也可以指定端口号<ul>
<li>域名时需要解析的哦</li>
</ul>
</li>
<li>parameters代表可选参数, 有如下：<ul>
<li><code>backup</code>，表示当前server是备用服务器，只有其它非backup后端服务器都挂掉了或很忙才会分配请求给它</li>
<li><code>max_conns</code>，限制同时连接到代理服务器的最大数量。默认值为0，表示没有限制。</li>
<li><code>weight</code>，表示当前server负载权重，权重越大几率愈高</li>
<li><code>max_fails</code>和<code>fail_timeout</code>一般会关联使用，如果某台server在fail_timeout时间内出现了max_fails次连接失败，那么Nginx会认为其已经挂掉，从而在 fail_timeout 时间内不再去请求它，fail_timeout默认是 10s，max_fails默认是1，即默认情况只要是发生错误就认为服务器挂了，如果将max_fails设置为0，则表示取消这项检查</li>
<li><code>down</code>，标志服务器永远不可用，可配合ip_hash使用</li>
<li><code>resolve</code>，监视与服务器域名相对应的ip地址的变化，并自动地修改上游配置，而不用重启Nginx</li>
<li><code>route</code>，设置服务器路由名称</li>
<li><code>service</code></li>
<li><code>slow_start</code>，设置服务器将其weight从零恢复到正常值的时间</li>
<li><code>drain</code>，使服务器进入drain模式，在此模式下，只有绑定到服务器的请求才会被代理</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>upstream模块参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>weight</td>
<td>服务器权重</td>
</tr>
<tr>
<td>max_fails</td>
<td>Nginx尝试连接后端主机失败的次数，这个值是配合<code>proxy_next_upstream</code>、<code>fastcgi_next_upstream</code>和<code>memcached_next_upstream</code>这三个参数来使用的。当Nginx接收后端服务器返回这三个参数定义的状态码时，会将这个请求转发给正常工作的的后端服务器。如404、503、503、max_files=1</td>
</tr>
<tr>
<td>fail_timeout</td>
<td><code>max_fails</code>和<code>fail_timeout</code>一般会关联使用，如果某台server在fail_timeout时间内出现了max_fails次连接失败，那么Nginx会认为其已经挂掉，从而在fail_timeout时间内不再去请求它，fail_timeout默认是10s，max_fails默认是1，即默认情况只要是发生错误就认为服务器挂了，如果将max_fails设置为0，则表示取消这项检查</td>
</tr>
<tr>
<td>backup</td>
<td>表示当前server是备用服务器，只有其它非backup后端服务器都挂掉了或很忙才会分配请求给它</td>
</tr>
<tr>
<td>down</td>
<td>标志服务器永远不可用，可配合ip_hash使用</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>如果是两台Web服务器做高可用，可能就需要Keepalived配合。那使用<code>backup</code>参数通过负载均衡功能就可以实现Web服务器集群了。</p>
<p><br></p>
<h4 id="upstream模块调度算法"><a href="#upstream模块调度算法" class="headerlink" title="upstream模块调度算法"></a>upstream模块调度算法</h4><p>调度算法一般分为：</p>
<ul>
<li>静态调度算法: 即负载均衡器根据自身设置的规则进行分配，不需要考虑后端节点服务器的情况<ul>
<li>轮询</li>
<li>权重</li>
<li>ip_hash</li>
</ul>
</li>
<li>动态调度算法:  即负载均衡器会根据后端节点的当前状态来决定是否分发请求，如连接数少或响应时间短的优先获得请求<ul>
<li>fair</li>
<li>least_conn</li>
<li>url_hash</li>
<li>一致性hash</li>
</ul>
</li>
</ul>
<p><br></p>
<p><strong>轮询(rr)</strong><br>默认调度算法。<br>按照客户端请求顺序把请求逐一分配到不同的后端节点服务器，相当于LVS中的rr算法。如果后端服务器宕机，宕机的服务器会被自动从节点服务器池中剔除，以使客户端的用户访问不受影响，新的请求分配给正常的服务器。</p>
<p><br></p>
<p><strong>权重轮询(wrr)</strong><br>权重越大，被转发的请求也就越多。可以根据服务器的配置和性能指定权重大小，有效解决新旧服务器性能不均带来的请求分配问题。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upstream weight &#123;</div><div class="line">  server 191.168.1.11 weight=1;</div><div class="line">  server 192.168.1.22 weight=2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>ip_hash</strong><br>每个请求按客户端IP的hash结果分配，当新的请求到达时，先将其客户端ip通过哈希算法得出一个值，在随后的客户端请求中，客户IP的哈希值只要相同，就会被分配到同一台服务器。</p>
<p>该调度算法可以解决动态网页的session共享问题，但有时会导致请求分配不均，因为国内大多数都是NAT上网模式，多个客户端对应一个外部IP，所以这些客户端都会被分配到同一个节点服务器，从而导致请求分配不均。</p>
<p>ip_hash中，后端服务器在负载均衡调度中的状态不能有 weight和backup，有也不会生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream iphash &#123;</div><div class="line">  ip_hash;</div><div class="line">  server 192.168.1.11;</div><div class="line">  server 192.168.1.22:8080;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>fair</strong><br>根据后端节点服务器的响应时间来分配请求，响应时间短的优先分配。这是更加智能的调度算法。</p>
<p>Nginx本身不支持这种算法，需要upstream_fair模块: <a href="https://github.com/gnosek/nginx-upstream-fair" target="_blank" rel="noopener">https://github.com/gnosek/nginx-upstream-fair</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream fair &#123;</div><div class="line">  server 192.168.1.11;</div><div class="line">  server 192.168.1.22;</div><div class="line">  fair;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>least_conn</strong><br>根据后端节点的连接数来决定分配情况，哪个机器少就分发给它。</p>
<p><br></p>
<p><strong>url_hash</strong><br>根据访问URL的hash结果来分配请求的，让每个URL定向到同一个后端服务器，后端服务器为缓存服务器时效果显著。</p>
<p>Nginx本身不支持url_hash，需要hash。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">upstream urlhash &#123;</div><div class="line">  server hahaha1:5678;</div><div class="line">  server hahaha2:5678;</div><div class="line">  <span class="built_in">hash</span> <span class="variable">$request_uri</span>;</div><div class="line">  hash_method md5;</div><div class="line">  <span class="comment">#同样不能使用 weight、backup</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>一致性hash</strong><br>一致性hash算法一般用于代理后端业务为缓存服务器（如Memcached）的场景，通过将用户请求的URI或者指定字符串进行计算，然后调度到后端的服务器上，此后任何用户查找同一个URI货值指定字符串都会被调度到这一台服务器上，因此后端的每个节点缓存的内容都是不同的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream &#123;</div><div class="line">  consistent_hash <span class="variable">$request_uri</span>;</div><div class="line">  server xxx;</div><div class="line">  server xxx;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="nginx-proxy模块"><a href="#nginx-proxy模块" class="headerlink" title="nginx proxy模块"></a>nginx proxy模块</h3><p><br></p>
<h4 id="proxy-pass介绍"><a href="#proxy-pass介绍" class="headerlink" title="proxy_pass介绍"></a>proxy_pass介绍</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Syntax:		proxy_pass URL;</div><div class="line">Default:	—</div><div class="line">Context:	location, <span class="keyword">if</span> <span class="keyword">in</span> location, limit_except</div></pre></td></tr></table></figure>
<p><br></p>
<p>proxy_pass指令属于ngx_http_proxy_module模块，此模块可以将请求转发到另一台服务器，在实际的反向代理工作中，会通过location功能匹配指定的URI，然后把接收到服务匹配URI的请求通过proyx_pass抛给定义好的upstream节点池。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location /download/ &#123;</div><div class="line">  proxy_pass http://download/vedio/;</div><div class="line">&#125;</div><div class="line"><span class="comment">#这是前端代理节点的设置</span></div><div class="line"><span class="comment">#交给后端upstream为download的节点</span></div><div class="line"></div><div class="line">location /name/ &#123;</div><div class="line">  rewrite /name/([^/]+) /users?name=<span class="variable">$1</span> <span class="built_in">break</span>;</div><div class="line">  proyx_pass http://127.0.0.1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="http-proyx模块参数"><a href="#http-proyx模块参数" class="headerlink" title="http_proyx模块参数"></a>http_proyx模块参数</h3><p>ngx_http_proxy_module: <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">https://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></p>
<p>Nginx的代理功能是通过http_proxy模块来实现的。</p>
<table>
<thead>
<tr>
<th>proxy模块</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>proxy_next_upstream</td>
<td>什么情况下将请求传递到下一个upstream</td>
</tr>
<tr>
<td>proxy_limite_rate</td>
<td>限制从后端服务器读取响应的速率</td>
</tr>
<tr>
<td>proyx_set_header</td>
<td>设置http请求header传给后端服务器节点，如：可实现让代理后端的服务器节点获取访问客户端的这是ip</td>
</tr>
<tr>
<td>client_body_buffer_size</td>
<td>客户端请求主体缓冲区大小</td>
</tr>
<tr>
<td>proxy_connect_timeout</td>
<td>代理与后端节点服务器连接的超时时间</td>
</tr>
<tr>
<td>proxy_send_timeout</td>
<td>后端节点数据回传的超时时间</td>
</tr>
<tr>
<td>proxy_read_timeout</td>
<td>设置Nginx从代理的后端服务器获取信息的时间，表示连接成功建立后，Nginx等待后端服务器的响应时间</td>
</tr>
<tr>
<td>proxy_buffer_size</td>
<td>设置缓冲区大小</td>
</tr>
<tr>
<td>proxy_buffers</td>
<td>设置缓冲区的数量和大小</td>
</tr>
<tr>
<td>proyx_busy_buffers_size</td>
<td>用于设置系统很忙时可以使用的proxy_buffers大小，推荐为proxy_buffers*2</td>
</tr>
<tr>
<td>proxy_temp_file_write_size</td>
<td>指定proxy缓存临时文件的大小</td>
</tr>
</tbody>
</table>
<p><br><br><br></p>
<h2 id="Nginx负载均衡配置"><a href="#Nginx负载均衡配置" class="headerlink" title="Nginx负载均衡配置"></a>Nginx负载均衡配置</h2><p><br></p>
<h3 id="配置后端节点"><a href="#配置后端节点" class="headerlink" title="配置后端节点"></a>配置后端节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">vi /etc/nginx/nginx.conf</div><div class="line"></div><div class="line">server &#123;</div><div class="line">  listen 80;</div><div class="line">  root /path/xxx;</div><div class="line"></div><div class="line">  location / &#123;</div><div class="line">    xxxx;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="配置反向代理节点"><a href="#配置反向代理节点" class="headerlink" title="配置反向代理节点"></a>配置反向代理节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream <span class="built_in">test</span> &#123;</div><div class="line">  server test1 weight=5;</div><div class="line">  server test2 weight=5;</div><div class="line">  server 192.168.1.33;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">vi /etc/nginx/nginx.conf</div><div class="line"></div><div class="line"></div><div class="line">server &#123;</div><div class="line">  listen 8888;</div><div class="line">  server_name www.test.com www.xx.com;</div><div class="line"></div><div class="line">  location  / &#123;</div><div class="line">    proxy_read_timeout 10s;</div><div class="line">    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_404;</div><div class="line">    proyx_pass http://<span class="built_in">test</span>;<span class="comment">#把用户的请求反向代理定义的upstream服务器池</span></div><div class="line"></div><div class="line">    <span class="comment">#proyx_set_header Host $host;在代理后端服务器发送的http请求头中加入host字段信息</span></div><div class="line">    <span class="comment">#proxy_set_header $remote_addr;后端节点服务器日志获取客户端真实ip，否则全都是代理节点的ip</span></div><div class="line">    <span class="comment">#proyx_connect_timeout 30s;</span></div><div class="line">    <span class="comment">#proxy_buffers_size 4m;</span></div><div class="line">    <span class="comment">#xxx</span></div><div class="line">&#125;</div><div class="line">  xxxxx</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="与反向代理配置相关的参数"><a href="#与反向代理配置相关的参数" class="headerlink" title="与反向代理配置相关的参数"></a>与反向代理配置相关的参数</h3><p>除了具有多虚拟主机代理以及节点服务器记录真实用户ip的功能外，Nginx还提供了相当多的作为反向代理和后端节点服务器对话的相关控制参数。</p>
<p>由于参数众多，建议把这些参数都写到另外一个配置文件里，然后用 include 方式包含到虚拟主机配置文件里。其他Nginx参数也同样可以使用此方法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/proxy.conf</div><div class="line"></div><div class="line"></div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">proxy_set_header <span class="variable">$remote_addr</span>;</div><div class="line">proxy_connect_timeout 60s;</div><div class="line">proxy_read_timeout 10s;</div><div class="line">proxy_send_timeout 20s;</div><div class="line">proxy_buffer_size 4m;</div><div class="line">proxy_buffer_size 4 2m;</div><div class="line">proxy_temp_file_write_size 2m;</div><div class="line">proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_404</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">vim /etc/nginx/conf.d/test.conf</div><div class="line"></div><div class="line"></div><div class="line">server &#123;</div><div class="line">  listen 80;</div><div class="line">  server_name www.test.com www.xxx.com;</div><div class="line">  location / &#123;</div><div class="line">    include /etc/nginx/proxy.conf;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>proxy_next_upstream参数补充</strong><br>当Nginx接收后端服务器发返回的proxy_next_upstream参数定义的状态码时，会将这个请求转发给正常工作的后端服务器，如500、502、503，此参数可以提升用户访问体验。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proyx_next_upstream error timeout invalid_header http_500 http_503 http_502 http_504;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="根据URL中的目录地址实现代理转发"><a href="#根据URL中的目录地址实现代理转发" class="headerlink" title="根据URL中的目录地址实现代理转发"></a>根据URL中的目录地址实现代理转发</h2><p>通过Nginx实现动静分离，即通过Nginx反向代理配置规则实现让动态资源和静态资源及其他业务分别由不同的服务器解析，已解决网站性能、安全、用户体验等重要问题。</p>
<p><br></p>
<h3 id="动静态分离"><a href="#动静态分离" class="headerlink" title="动静态分离"></a>动静态分离</h3><p><strong>配置upstream.conf</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">upstream static &#123;</div><div class="line">  server 192.168.1.11;</div><div class="line">  <span class="comment">#或server static.com----hosts:static.com 192.168.1.11</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">upstream upload &#123;</div><div class="line">  server 192.168.1.22;</div><div class="line">&#125;</div><div class="line"></div><div class="line">upstream default &#123;</div><div class="line">  server 192.168.1.33;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#在http中加入,注意位置</span></div><div class="line">http &#123;</div><div class="line">  include upstream.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>配置virtual.conf</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#方案1：利用location实现</span></div><div class="line"></div><div class="line">location  /static/ &#123;</div><div class="line">  proyx_pass http://static;</div><div class="line">  include proyx.conf;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location /upload/ &#123;</div><div class="line">  proxy_pass http://upload;</div><div class="line">  include proxy.conf;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location / &#123;</div><div class="line">  proxy_pass http://default;</div><div class="line">  include proxy.conf;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">========================================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#方案2：利用if语句实现</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"^/static/(.*)$"</span>)</div><div class="line">&#123;</div><div class="line">      proxy_pass http://static/<span class="variable">$1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"^/upload/(.*)$"</span>)</div><div class="line">&#123;</div><div class="line">    proxy_pass http://upload/<span class="variable">$1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location / &#123;</div><div class="line">  proxy_pass http://default;</div><div class="line">  include  proyx.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br></p>
<h3 id="URL目录地址转发的应用场景"><a href="#URL目录地址转发的应用场景" class="headerlink" title="URL目录地址转发的应用场景"></a>URL目录地址转发的应用场景</h3><p>根据HTTP的URL进行转发的应用情况，被称为 第7层（应用层）的负载均衡；而LVS的负载均衡一般用于TCP等的转发，因此被称为第四层（传输层）的负载均衡 。</p>
<p>有时因为需求，需要在代理服务器上通过配置规则，使得匹配不同规则的请求会交给不同的服务器池处理。</p>
<p><br></p>
<h3 id="根据客户端的设备-user-agent-转发"><a href="#根据客户端的设备-user-agent-转发" class="headerlink" title="根据客户端的设备(user_agent)转发"></a>根据客户端的设备(user_agent)转发</h3><p>为了让不同客户端设备用户有更好的访问体验，需要在后端架设不同服务器来满足不同的客户端访问。如PC端和移动端，移动端又有安卓、苹果、Pad等。</p>
<ol>
<li><p>常规4层负载均衡解决方案架构</p>
<ul>
<li>在常规4层负载均衡架构下，可以使用不同的域名来实现这个需求。</li>
<li>如，分配移动端访问 wap.xxx.com，PC端访问www.xxx.com。</li>
<li>通过不同域名来引导用户到指定后端服务器，但是这样就分别得记住不同的域名。</li>
</ul>
</li>
<li><p>第7层负载均衡解决方案</p>
<ul>
<li>在7层负载均衡架构下，对外只需要用一个域名，如www.xxx.com，然后通过获取用户请求中的设备信息$http_user_agent，根据此信息转给后端合适的服务器处理。</li>
</ul>
</li>
</ol>
<p><br></p>
<p><strong>根据$user_agent转发</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"android"</span>)</div><div class="line">      &#123;</div><div class="line">          proxy_pass http://android;</div><div class="line">      &#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"iphone"</span>)</div><div class="line">      &#123;</div><div class="line">          proxy_pass http://iphone;</div><div class="line">      &#125;</div><div class="line">proxy_pass http://default;</div><div class="line">include proyx.conf;</div></pre></td></tr></table></figure>
<p><strong>根据文件扩展名实现代理转发</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">location ~*  .*\.(gif|jpg|png|css|js)$ &#123;</div><div class="line">  proyx_pass http://static;</div><div class="line">  include proxy.conf;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#if</span></div><div class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">".*\.php$"</span>)</div><div class="line">  &#123;</div><div class="line">      proxy_pass http://php;</div><div class="line">  &#125;</div><div class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">".*\.(jpg|png|css|js)$"</span>)</div><div class="line">  &#123;</div><div class="line">      proxy_pass http://static;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><br></p>
<p>在开发无法通过程序实现动静分离的时候，运维可以根据资源实体进行动静分离，根据不同实现策略制定后端服务器不同的组。在前端代理服务器上通过路径、扩展名等进行规则匹配，从而实现请求的动态分离。</p>
<p><br><br><br></p>
<h2 id="Nginx负载均衡检测节点状态"><a href="#Nginx负载均衡检测节点状态" class="headerlink" title="Nginx负载均衡检测节点状态"></a>Nginx负载均衡检测节点状态</h2><p>淘宝技术团队开发了一个Tengine（Nginx分支）模块nginx_upstream_check_module: <a href="https://github.com/yaoweibin/nginx_upstream_check_module" target="_blank" rel="noopener">https://github.com/yaoweibin/nginx_upstream_check_module</a>，用于提供主动式后端服务器健康检查。<br>通过它检测后端realserver的健康状态，如果后端节点不可用，则所有的请求就不会转发到该节点上。</p>
<p>Nginx需要通过打补丁的方式将该模块添加进去。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">wget https://codeload.github.com/yaoweibin/nginx_upstream_check_module/zip/master</div><div class="line">unzip master</div><div class="line"><span class="built_in">cd</span> nginx_upstream_check_module-master    <span class="comment">#解压后的文件夹</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span>  nginx源码安装包（我是 /usr/<span class="built_in">local</span>/nginx-1.12.1）</div><div class="line">patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.12.1+.patch    <span class="comment">#选择对应的Nginx版本号，我的是1.12.1    #打补丁</span></div><div class="line"></div><div class="line"><span class="comment">#编译，注意以前的编译参数</span></div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx \</div><div class="line">--user=nginx --group=nginx \</div><div class="line">--with-http_ssl_module \</div><div class="line">--with-http_realip_module \</div><div class="line">--with-http_addition_module \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--with-http_stub_status_module \</div><div class="line">--with-http_sub_module \</div><div class="line">--with-pcre \</div><div class="line">--add-module=../nginx_upstream_check_module-master</div><div class="line"></div><div class="line">make</div><div class="line"><span class="comment">#给已经安装的Nginx系统打补丁不用执行make install</span></div><div class="line"><span class="comment">#make是重新生成Nginx二进制启动命令</span></div><div class="line"></div><div class="line"><span class="comment">#备份</span></div><div class="line">mv /usr/<span class="built_in">local</span>/nginx/sbin/nginx&#123;,.bak&#125;</div><div class="line"></div><div class="line"><span class="comment">#经打过补丁的Nginx二进制程序复制到/usr/local/nginx/sbin/ 下</span></div><div class="line">cp /usr/<span class="built_in">local</span>/nginx-1.12.1/objs/nginx /usr/<span class="built_in">local</span>/nginx/sbin/</div><div class="line"></div><div class="line">nginx -t</div></pre></td></tr></table></figure>
<p><br></p>
<p><strong>配置nginx_upstream_check</strong></p>
<p>配置upstream.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">upstream zhang &#123;</div><div class="line">    server 192.168.1.7:5678 weight=1;</div><div class="line">    server 192.168.0.99:5678 weight=1;</div><div class="line">    check interval=3000 rise=2 fall=5 timeout=1000 <span class="built_in">type</span>=http;</div><div class="line">    <span class="comment">#每个3秒对负载均衡中所有节点检测一次，请求2次正常标记realserver状态为up；</span></div><div class="line">    <span class="comment">#如果检测5次都失败，则标记realserver状态为down，超时时间为1秒；</span></div><div class="line">    <span class="comment">#检查的协议为HTTP；</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置/status：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location /status &#123;</div><div class="line">    check_status;</div><div class="line">    access_log off;</div><div class="line">    allow 192.168.1.0/24;</div><div class="line">    deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br></p>
<h1 id="stream模块"><a href="#stream模块" class="headerlink" title="stream模块"></a>stream模块</h1><p>Module ngx_stream_core_module <a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html" target="_blank" rel="noopener">http://nginx.org/en/docs/stream/ngx_stream_core_module.html</a></p>
<p>nginx从1.9.0开始，新增加了一个stream模块，用来实现四层协议(tcp/udp)的转发、代理或者负载均衡等。<br>这个模块不是默认构建的，需要使用<code>--with-stream</code>参数。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Nginx/" rel="tag"># Nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/01/I-Like-For-You-To-Be-Still/" rel="next" title="I Like For You To Be Still">
                <i class="fa fa-chevron-left"></i> I Like For You To Be Still
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/01/Markdown/" rel="prev" title="Markdown">
                Markdown <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/leslie.jpg"
              alt="Zhang21" />
          
            <p class="site-author-name" itemprop="name">Zhang21</p>
            <p class="site-description motion-element" itemprop="description">踏踏实实谋发展</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/f13278e94ecb" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-circle-o"></i>简书</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:elite_zhang21@163.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx介绍"><span class="nav-number">1.</span> <span class="nav-text">Nginx介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#与PHP的集成"><span class="nav-number">1.1.</span> <span class="nav-text">与PHP的集成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx常用功能"><span class="nav-number">1.2.</span> <span class="nav-text">Nginx常用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http代理于反向代理"><span class="nav-number">1.2.1.</span> <span class="nav-text">http代理于反向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡"><span class="nav-number">1.2.2.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web缓存"><span class="nav-number">1.2.3.</span> <span class="nav-text">web缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web服务"><span class="nav-number">1.2.4.</span> <span class="nav-text">web服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx安装"><span class="nav-number">2.</span> <span class="nav-text">Nginx安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RPM源安装"><span class="nav-number">2.1.</span> <span class="nav-text">RPM源安装:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加Nginx-yum-repository安装"><span class="nav-number">2.2.</span> <span class="nav-text">添加Nginx yum repository安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码安装"><span class="nav-number">2.3.</span> <span class="nav-text">源码安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx配置"><span class="nav-number">3.</span> <span class="nav-text">Nginx配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#conf"><span class="nav-number">3.1.</span> <span class="nav-text">*.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#server"><span class="nav-number">3.2.</span> <span class="nav-text">server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#location"><span class="nav-number">3.3.</span> <span class="nav-text">location</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#location的正则写法"><span class="nav-number">3.3.1.</span> <span class="nav-text">location的正则写法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location使用建议"><span class="nav-number">3.3.2.</span> <span class="nav-text">location使用建议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rewrite"><span class="nav-number">3.4.</span> <span class="nav-text">Rewrite</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#flag"><span class="nav-number">3.4.1.</span> <span class="nav-text">flag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if指令"><span class="nav-number">3.4.2.</span> <span class="nav-text">if指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx全局变量"><span class="nav-number">3.4.3.</span> <span class="nav-text">Nginx全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rewrite实例"><span class="nav-number">3.4.4.</span> <span class="nav-text">rewrite实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问控制"><span class="nav-number">3.5.</span> <span class="nav-text">访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加用户密码验证"><span class="nav-number">3.5.1.</span> <span class="nav-text">添加用户密码验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#限制IP访问"><span class="nav-number">3.5.2.</span> <span class="nav-text">限制IP访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#语法检查"><span class="nav-number">3.6.</span> <span class="nav-text">语法检查</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx优化"><span class="nav-number">4.</span> <span class="nav-text">Nginx优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用优化"><span class="nav-number">4.1.</span> <span class="nav-text">常用优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#隐藏Nginx版本号"><span class="nav-number">4.1.1.</span> <span class="nav-text">隐藏Nginx版本号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更改Nginx服务默认用户"><span class="nav-number">4.1.2.</span> <span class="nav-text">更改Nginx服务默认用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化Nginx进程对应的配置"><span class="nav-number">4.1.3.</span> <span class="nav-text">优化Nginx进程对应的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化绑定不同的Nginx进程到不同的CPU上"><span class="nav-number">4.1.4.</span> <span class="nav-text">优化绑定不同的Nginx进程到不同的CPU上</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx事件处理模型优化"><span class="nav-number">4.1.5.</span> <span class="nav-text">Nginx事件处理模型优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx单个进程允许的客户端最大连接数"><span class="nav-number">4.1.6.</span> <span class="nav-text">Nginx单个进程允许的客户端最大连接数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-worker进程最大打开文件数"><span class="nav-number">4.1.7.</span> <span class="nav-text">Nginx worker进程最大打开文件数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启高效文件传输"><span class="nav-number">4.1.8.</span> <span class="nav-text">开启高效文件传输</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sendfile"><span class="nav-number">4.1.8.1.</span> <span class="nav-text">sendfile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tcp-nopush"><span class="nav-number">4.1.8.2.</span> <span class="nav-text">tcp_nopush</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx连接参数，连接超时时间"><span class="nav-number">4.1.9.</span> <span class="nav-text">Nginx连接参数，连接超时时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上传文件大小限制-动态应用"><span class="nav-number">4.1.10.</span> <span class="nav-text">上传文件大小限制(动态应用)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip压缩"><span class="nav-number">4.1.11.</span> <span class="nav-text">gzip压缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#expires缓存"><span class="nav-number">4.1.12.</span> <span class="nav-text">expires缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FastCGI相关参数"><span class="nav-number">4.2.</span> <span class="nav-text">FastCGI相关参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志与安全"><span class="nav-number">4.3.</span> <span class="nav-text">日志与安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不记录不需要的日志"><span class="nav-number">4.3.1.</span> <span class="nav-text">不记录不需要的日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志权限"><span class="nav-number">4.3.2.</span> <span class="nav-text">日志权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#站点目录及URL访问控制"><span class="nav-number">4.4.</span> <span class="nav-text">站点目录及URL访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#根据扩展名限制程序或文件访问"><span class="nav-number">4.4.1.</span> <span class="nav-text">根据扩展名限制程序或文件访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#禁止访问指定目录"><span class="nav-number">4.4.2.</span> <span class="nav-text">禁止访问指定目录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#禁止非法域名解析访问网站"><span class="nav-number">4.5.</span> <span class="nav-text">禁止非法域名解析访问网站</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#图片及目录防盗链"><span class="nav-number">4.6.</span> <span class="nav-text">图片及目录防盗链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是资源盗链"><span class="nav-number">4.6.1.</span> <span class="nav-text">什么是资源盗链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见防盗链解决方案"><span class="nav-number">4.6.2.</span> <span class="nav-text">常见防盗链解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#根据HTTP-referer-实现防盗链"><span class="nav-number">4.6.2.1.</span> <span class="nav-text">根据HTTP referer 实现防盗链</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#根据cookie防盗链"><span class="nav-number">4.6.2.2.</span> <span class="nav-text">根据cookie防盗链</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx实现防盗链"><span class="nav-number">4.6.3.</span> <span class="nav-text">Nginx实现防盗链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误页面优雅展示"><span class="nav-number">4.7.</span> <span class="nav-text">错误页面优雅展示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目录及文件权限优化"><span class="nav-number">4.8.</span> <span class="nav-text">目录及文件权限优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反爬虫优化"><span class="nav-number">4.9.</span> <span class="nav-text">反爬虫优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#robots-txt机器人协议"><span class="nav-number">4.9.1.</span> <span class="nav-text">robots.txt机器人协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx反爬虫配置"><span class="nav-number">4.9.2.</span> <span class="nav-text">Nginx反爬虫配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限制HTTP请求方法"><span class="nav-number">4.10.</span> <span class="nav-text">限制HTTP请求方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CDN"><span class="nav-number">4.11.</span> <span class="nav-text">CDN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用CDN的要求"><span class="nav-number">4.11.1.</span> <span class="nav-text">使用CDN的要求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#程序架构优化"><span class="nav-number">4.12.</span> <span class="nav-text">程序架构优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用no-root用户启动Nginx"><span class="nav-number">4.13.</span> <span class="nav-text">使用no-root用户启动Nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制Nginx并发连接数"><span class="nav-number">4.14.</span> <span class="nav-text">控制Nginx并发连接数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制客户端请求Nginx的速率"><span class="nav-number">4.15.</span> <span class="nav-text">控制客户端请求Nginx的速率</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx反向代理与负载均衡"><span class="nav-number">5.</span> <span class="nav-text">Nginx反向代理与负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#反向代理与负载均衡"><span class="nav-number">5.1.</span> <span class="nav-text">反向代理与负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx负载均衡的组件"><span class="nav-number">5.2.</span> <span class="nav-text">Nginx负载均衡的组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-upstream模块"><span class="nav-number">5.2.1.</span> <span class="nav-text">nginx upstream模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#upstream模块介绍"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">upstream模块介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#upstream模块调度算法"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">upstream模块调度算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-proxy模块"><span class="nav-number">5.2.2.</span> <span class="nav-text">nginx proxy模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#proxy-pass介绍"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">proxy_pass介绍</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-proyx模块参数"><span class="nav-number">5.2.3.</span> <span class="nav-text">http_proyx模块参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx负载均衡配置"><span class="nav-number">5.3.</span> <span class="nav-text">Nginx负载均衡配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置后端节点"><span class="nav-number">5.3.1.</span> <span class="nav-text">配置后端节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置反向代理节点"><span class="nav-number">5.3.2.</span> <span class="nav-text">配置反向代理节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#与反向代理配置相关的参数"><span class="nav-number">5.3.3.</span> <span class="nav-text">与反向代理配置相关的参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根据URL中的目录地址实现代理转发"><span class="nav-number">5.4.</span> <span class="nav-text">根据URL中的目录地址实现代理转发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动静态分离"><span class="nav-number">5.4.1.</span> <span class="nav-text">动静态分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URL目录地址转发的应用场景"><span class="nav-number">5.4.2.</span> <span class="nav-text">URL目录地址转发的应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据客户端的设备-user-agent-转发"><span class="nav-number">5.4.3.</span> <span class="nav-text">根据客户端的设备(user_agent)转发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx负载均衡检测节点状态"><span class="nav-number">5.5.</span> <span class="nav-text">Nginx负载均衡检测节点状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#stream模块"><span class="nav-number">6.</span> <span class="nav-text">stream模块</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang21</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 197.6k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2017/09/01/Nginx/';
          this.page.identifier = '2017/09/01/Nginx/';
          this.page.title = 'Nginx';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
