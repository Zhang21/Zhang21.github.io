<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Service Mesh,API,APIGateway,MicroService,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="参考：  Kong GitHub: https://github.com/Kong/kong Kong Docs: https://docs.konghq.com/   环境：  ELRH7x86_64 Kong v1.1 Docker CE v18.09 K8s v1.11">
<meta name="keywords" content="Service Mesh,API,APIGateway,MicroService">
<meta property="og:type" content="article">
<meta property="og:title" content="Kong">
<meta property="og:url" content="https://zhang21.github.io/2019/05/08/Kong/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考：  Kong GitHub: https://github.com/Kong/kong Kong Docs: https://docs.konghq.com/   环境：  ELRH7x86_64 Kong v1.1 Docker CE v18.09 K8s v1.11">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://zhang21.github.io/images/Kong/kongLogo.png">
<meta property="og:image" content="https://zhang21.github.io/images/Kong/kong-architecture.jpg">
<meta property="og:image" content="https://zhang21.github.io/images/Kong/kong-simple.png">
<meta property="og:updated_time" content="2019-05-24T09:14:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kong">
<meta name="twitter:description" content="参考：  Kong GitHub: https://github.com/Kong/kong Kong Docs: https://docs.konghq.com/   环境：  ELRH7x86_64 Kong v1.1 Docker CE v18.09 K8s v1.11">
<meta name="twitter:image" content="https://zhang21.github.io/images/Kong/kongLogo.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2019/05/08/Kong/">





  <title>Kong | 风继续吹</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2019/05/08/Kong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Leslie Zhang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kong</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-08T02:44:31+08:00">
                2019-05-08
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-05-24T17:14:28+08:00">
                2019-05-24
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/08/Kong/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/05/08/Kong/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  14,871
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考：</p>
<ul>
<li>Kong GitHub: <a href="https://github.com/Kong/kong" target="_blank" rel="noopener">https://github.com/Kong/kong</a></li>
<li>Kong Docs: <a href="https://docs.konghq.com/" target="_blank" rel="noopener">https://docs.konghq.com/</a></li>
</ul>
<p><br></p>
<p>环境：</p>
<ul>
<li>ELRH7x86_64</li>
<li>Kong v1.1</li>
<li>Docker CE v18.09</li>
<li>K8s v1.11</li>
</ul>
<p><br><br><br></p>
<hr>
<a id="more"></a>
<p><br><br><br></p>
<h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><p>GETTING STARTED</p>
<p><img src="/images/Kong/kongLogo.png" alt></p>
<p>Kong是一个可扩展的开源<strong>API Layer</strong>（也称为<strong>API Gateway</strong>或<strong>API Middleware</strong>）。Kong运行在任何RESTful API之前，并通过<strong>插件(plugin)</strong>进行扩展。</p>
<p>Kong的优点：</p>
<ul>
<li><strong>Scalable</strong>：只需添加更多机器便可轻易扩展，这意味着你的平台可以处理任何负载，同时保持低延迟；</li>
<li><strong>Modular</strong>：可以通过添加新的插件来扩展Kong，这些插件可通过RESTful API配置；</li>
<li><strong>Runs on any infrastructure</strong>：Kong可以运行在任何地方。</li>
</ul>
<p>Kong建立在N影响和Apache Cassandra或PostgreSQL等可靠技术之上，为你提供易于使用的RESTful API来操作和配置系统。</p>
<p><img src="/images/Kong/kong-architecture.jpg" alt></p>
<p><br></p>
<p>下图是一个使用Kong请求API的典型工作流程。<br>一旦Kong运行，对API的所有请求都将首先到达Kong，然后代理到最终的API。在请求和相应之间，Kong将执行你决定安装的任何插件，为你的API提供支持。Kong有效地成为每个API请求的入口点。</p>
<p><img src="/images/Kong/kong-simple.png" alt></p>
<p><br><br><br></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><a href="https://docs.konghq.com/1.1.x/getting-started/introduction/" target="_blank" rel="noopener">Introduction</a></p>
<p>你可能听过Kong是建立在Nginx之上的，它利用它的稳定性和效率。<br>更确切地说，Kong是一个在Nginx中运行的Lua Application，并且可通过<code>lua-nginx-module</code>模块实现。Kong不是用这个模块编译Nginx，而是与<strong>OpenResty</strong>一起发布，OpenResty以及包含了<code>lua-nginx-module</code>模块。OpenResty不是Nginx的分支(fork)，而是一组扩展其功能的模块。</p>
<p>这位可插拔架构(pluggable architecture)奠定了基础，在运行时启动并执行Lua scripts(plugins)。因此，我们认为Kong是微服务架构的典范，它的核心是实现<strong>数据库抽象(database abstraction)</strong>、<strong>路由(routing)</strong>和<strong>插件管理(plugin management)</strong>。插件可以存在于单独的代码中，并可以在几行代码中诸如到请求生命周期的任何位置。</p>
<p><br><br><br><br><br></p>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p><a href="https://docs.konghq.com/1.1.x/getting-started/quickstart/" target="_blank" rel="noopener">Quickstart</a></p>
<p>在本章中，你讲学习如何管理Kong实例。首先，你将启动Kong，以便可访问RESTful Admin Interface，通过该界面管理服务(service)、路由(route)、消费者(consumer)…通过Admin API发送的数据存储在Kong的数据存储区中(PostgreSQL后Cassandra)。</p>
<p><br><br><br></p>
<h3 id="启动Kong"><a href="#启动Kong" class="headerlink" title="启动Kong"></a>启动Kong</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行kong migrations命令来准备数据存储</span></span><br><span class="line">kong migrations bootstrap [-c /path/to/kong.conf]</span><br><span class="line"><span class="comment"># 你应该看到Kong已成功迁移的消息。否则，你可能在配置文件中错误的配置了数据库连接。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里把默认配置文件中的postgre注释取消就好</span></span><br><span class="line">cp /etc/kong/kong.conf.default kong.conf</span><br><span class="line">vim kong.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可指定配置项</span></span><br><span class="line">kong start [-c /path/to/kong.conf]</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="验证Kong"><a href="#验证Kong" class="headerlink" title="验证Kong"></a>验证Kong</h3><p>如果一切顺利，你应该看到一条消息通知你Kong正在运行。</p>
<p>默认情况下，Kong监听以下端口：</p>
<ul>
<li><strong>8000</strong>：监听来自Client的传入流量，并将其转发到上游服务</li>
<li><strong>8443</strong>：与8000端口类似，它监听HTTPS流量</li>
<li><strong>8001</strong>：Admin API用于配置Kong监听</li>
<li><strong>8444</strong>：Admin API监听HTTPS流量</li>
</ul>
<p><br><br><br></p>
<h3 id="停止和重载"><a href="#停止和重载" class="headerlink" title="停止和重载"></a>停止和重载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kong stop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在不停机的情况下重新加载Kong</span></span><br><span class="line">kong reload</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h2><p><a href="https://docs.konghq.com/1.1.x/getting-started/configuring-a-service/" target="_blank" rel="noopener">Configuring a Service</a></p>
<p>在本章中，你将向Kong添加API。为此，你首先需要添加一个<strong>服务（Service）</strong>，这就是Kong又来指代它管理的上游API和微服务的名称。</p>
<p>出于测试的目的，将创建一个指向Mockbin API（返回请求作为响应）的服务。这有助于了解Kong如何代理你的API请求。</p>
<p>在开始向服务发出请求之前，你需要为其添加<strong>路由（Route）</strong>。路由指定请求在到达Kong后如何（以及是否）发送到服务。单个服务可以有多个路由。</p>
<p>在配置了服务和路由之后，你能够通过Kong使用它们发出请求。</p>
<p>Kong在端口<code>8001</code>上公开RESTful Admin API。Kong的配置（包括添加服务和路由），是通过该API的请求进行的。</p>
<p><br><br><br></p>
<h3 id="添加服务"><a href="#添加服务" class="headerlink" title="添加服务"></a>添加服务</h3><p>Add your Service using the Admin API</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发出以下cURL请求，将服务添加到Kong</span></span><br><span class="line">curl -i -X POST \</span><br><span class="line">  --url http://localhost:8001/services/ \</span><br><span class="line">  --data <span class="string">'name=example-service'</span> \</span><br><span class="line">  --data <span class="string">'url=http://mockbin.org'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 你应该收到类似的响应</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">"host"</span>:<span class="string">"mockbin.org"</span>,</span><br><span class="line">   <span class="string">"created_at"</span>:1519130509,</span><br><span class="line">   <span class="string">"connect_timeout"</span>:60000,</span><br><span class="line">   <span class="string">"id"</span>:<span class="string">"92956672-f5ea-4e9a-b096-667bf55bc40c"</span>,</span><br><span class="line">   <span class="string">"protocol"</span>:<span class="string">"http"</span>,</span><br><span class="line">   <span class="string">"name"</span>:<span class="string">"example-service"</span>,</span><br><span class="line">   <span class="string">"read_timeout"</span>:60000,</span><br><span class="line">   <span class="string">"port"</span>:80,</span><br><span class="line">   <span class="string">"path"</span>:null,</span><br><span class="line">   <span class="string">"updated_at"</span>:1519130509,</span><br><span class="line">   <span class="string">"retries"</span>:5,</span><br><span class="line">   <span class="string">"write_timeout"</span>:60000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="为服务添加路由"><a href="#为服务添加路由" class="headerlink" title="为服务添加路由"></a>为服务添加路由</h3><p>Add a Route for the Service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST \</span><br><span class="line">  --url http://localhost:8001/services/example-service/routes \</span><br><span class="line">  --data <span class="string">'hosts[]=example.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似的响应</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">"created_at"</span>:1519131139,</span><br><span class="line">   <span class="string">"strip_path"</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="string">"hosts"</span>:[</span><br><span class="line">      <span class="string">"example.com"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="string">"preserve_host"</span>:<span class="literal">false</span>,</span><br><span class="line">   <span class="string">"regex_priority"</span>:0,</span><br><span class="line">   <span class="string">"updated_at"</span>:1519131139,</span><br><span class="line">   <span class="string">"paths"</span>:null,</span><br><span class="line">   <span class="string">"service"</span>:&#123;</span><br><span class="line">      <span class="string">"id"</span>:<span class="string">"79d7ee6e-9fc7-4b95-aa3b-61d2e17e7516"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="string">"methods"</span>:null,</span><br><span class="line">   <span class="string">"protocols"</span>:[</span><br><span class="line">      <span class="string">"http"</span>,</span><br><span class="line">      <span class="string">"https"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="string">"id"</span>:<span class="string">"f9ce2ed7-c06e-4e16-bd5d-3a82daef3f9d"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kong现在知道你的服务并准备代理请求。</p>
<p><br><br><br></p>
<h3 id="转发请求"><a href="#转发请求" class="headerlink" title="转发请求"></a>转发请求</h3><p>Forward your requests through Kong</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发出一下cURL请求来验证Kong是否正确地将请求转发给服务</span></span><br><span class="line"><span class="comment"># 默认情况下，Kong在8000端口上处理代理请求</span></span><br><span class="line">curl -i -X GET \</span><br><span class="line">  --url http://localhost:8000/ \</span><br><span class="line">  --header <span class="string">'Host: example.com'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="启用插件"><a href="#启用插件" class="headerlink" title="启用插件"></a>启用插件</h2><p><a href="https://docs.konghq.com/1.1.x/getting-started/enabling-plugins/" target="_blank" rel="noopener">Enabling Plugins</a></p>
<p>在本章中，你将学习如何配置Kong<strong>插件（Plugins）</strong>。Kong的核心原则之一是它通过插件的可扩展性。插件允许你轻松地向服务添加新功能或使其更易于管理。</p>
<p>下面的栗子中，将配置<code>key-auth</code>插件以向服务添加身份认证。</p>
<p><br><br><br></p>
<h3 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h3><p>Configure the key-auth plugin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插件配置栗子</span></span><br><span class="line">curl -i -X POST \</span><br><span class="line">  --url http://localhost:8001/services/example-service/plugins/ \</span><br><span class="line">  --data <span class="string">'name=key-auth'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="验证插件"><a href="#验证插件" class="headerlink" title="验证插件"></a>验证插件</h3><p>Verify that the plugin is properly configured</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X GET \</span><br><span class="line">  --url http://localhost:8000/ \</span><br><span class="line">  --header <span class="string">'Host: example.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于未指定key，因此响应为 401 Unauthorized</span></span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"message"</span>: <span class="string">"No API key found in request"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="添加消费者"><a href="#添加消费者" class="headerlink" title="添加消费者"></a>添加消费者</h2><p><a href="https://docs.konghq.com/1.1.x/getting-started/adding-consumers/" target="_blank" rel="noopener">Adding Consumers</a></p>
<p>在本章中，将介绍将<strong>消费者（Consumer）</strong>添加到Kong实例中。消费者与使用服务的个人相关联，并可用于追踪，访问管理等。</p>
<p><br></p>
<h3 id="创建消费者"><a href="#创建消费者" class="headerlink" title="创建消费者"></a>创建消费者</h3><p>Create a Consumer through the RESTful API</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个名为Jason的用户</span></span><br><span class="line"><span class="comment"># Kong还接受custom_id参数</span></span><br><span class="line">curl -i -X POST \</span><br><span class="line">  --url http://localhost:8001/consumers/ \</span><br><span class="line">  --data <span class="string">"username=Jason"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 类似响应</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"Jason"</span>,</span><br><span class="line">  <span class="string">"created_at"</span>: 1428555626000,</span><br><span class="line">  <span class="string">"id"</span>: <span class="string">"bbdf1c48-19dc-4ab7-cae0-ff4f59d87dc9"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="为消费者提供key"><a href="#为消费者提供key" class="headerlink" title="为消费者提供key"></a>为消费者提供key</h3><p>Provision key credentials for your Consumer</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为消费者创建密钥</span></span><br><span class="line">curl -i -X POST \</span><br><span class="line">  --url http://localhost:8001/consumers/Jason/key-auth/ \</span><br><span class="line">  --data <span class="string">'key=ENTER_KEY_HERE'</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="验证消费者凭证"><a href="#验证消费者凭证" class="headerlink" title="验证消费者凭证"></a>验证消费者凭证</h3><p> Verify that your Consumer credentials are valid</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发出请求来验证凭据是否有效</span></span><br><span class="line">curl -i -X GET \</span><br><span class="line">  --url http://localhost:8000 \</span><br><span class="line">  --header <span class="string">"Host: example.com"</span> \</span><br><span class="line">  --header <span class="string">"apikey: ENTER_KEY_HERE"</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><a href="https://konghq.com/install/" target="_blank" rel="noopener">install</a></p>
<p>Kong可以运行在多个环境中。</p>
<p><br><br><br></p>
<h2 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h2><p><a href="https://docs.konghq.com/install/centos/" target="_blank" rel="noopener">CentOS Installation</a></p>
<ul>
<li><strong>安装Kong</strong></li>
</ul>
<p>安装方式：</p>
<ul>
<li>yum repo</li>
<li>packages</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># repo</span></span><br><span class="line">wget https://bintray.com/kong/kong-rpm/rpm -O bintray-kong-kong-rpm.repo</span><br><span class="line"><span class="built_in">export</span> major_version=`grep -oE <span class="string">'[0-9]+\.[0-9]+'</span> /etc/redhat-release | cut -d <span class="string">"."</span> -f1`</span><br><span class="line">sed -i -e <span class="string">'s/baseurl.*/&amp;\/centos\/'</span><span class="variable">$major_version</span><span class="string">''</span>/ bintray-kong-kong-rpm.repo</span><br><span class="line">sudo mv bintray-kong-kong-rpm.repo /etc/yum.repos.d/</span><br><span class="line">sudo yum install -y kong</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>准备数据库</strong></li>
</ul>
<p>Kong支持PostgreSQL v9.5+和Cassandra 3.x.x作为数据存储。</p>
<p>此处我按照文档安装PostgreSQL v11: <a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装PostgreSQL v11</span></span><br><span class="line">sudo yum install -y https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-centos11-11-2.noarch.rpm</span><br><span class="line"></span><br><span class="line">sudo yum install -y postgresql11</span><br><span class="line"></span><br><span class="line">sudo yum install -y postgresql11-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自启</span></span><br><span class="line">/usr/pgsql-11/bin/postgresql-11-setup initdb</span><br><span class="line">systemctl <span class="built_in">enable</span> postgresql-11</span><br><span class="line">systemctl start postgresql-11</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># 登录psql</span><br><span class="line">sudo su postgres</span><br><span class="line">psql</span><br><span class="line"></span><br><span class="line"># 创建数据库，官方默认无密码，此处我使用密码</span><br><span class="line"># CREATE USER kong; CREATE DATABASE kong OWNER kong;</span><br><span class="line">CREATE USER kong with password &apos;kong&apos;; CREATE DATABASE kong OWNER kong; grant all privileges on database kong to kong;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 这里可能会报连接错误</span><br><span class="line"># psql: 致命错误:  对用户&quot;kong&quot;的对等认证失败</span><br><span class="line">sudo find / -name pg_hba.conf</span><br><span class="line">/var/lib/pgsql/11/data/pg_hba.conf</span><br><span class="line"></span><br><span class="line"># 修改安全配置</span><br><span class="line">vim /var/lib/pgsql/11/data/pg_hba.conf</span><br><span class="line"></span><br><span class="line"># METHOD指定如何处理客户端的认证。常用的有ident，md5，password，trust，reject</span><br><span class="line"># ident是Linux下PostgreSQL默认的local认证方式，凡是能正确登录服务器的操作系统用户（注：不是数据库用户）就能使用本用户映射的数据库用户不需密码登录数据库。</span><br><span class="line"># md5是常用的密码认证方式，如果你不使用ident，最好使用md5。密码是以md5形式传送给数据库，较安全，且不需建立同名的操作系统用户。</span><br><span class="line"># password是以明文密码传送给数据库，建议不要在生产环境中使用。</span><br><span class="line"># trust是只要知道数据库用户名就不需要密码或ident就能登录，建议不要在生产环境中使用。</span><br><span class="line"># reject是拒绝认证。</span><br><span class="line"></span><br><span class="line"># &quot;local&quot; is for Unix domain socket connections only</span><br><span class="line">local   all             all                                     peer</span><br><span class="line"># IPv4 local connections:</span><br><span class="line">host    all             all             127.0.0.1/32            ident</span><br><span class="line"># IPv6 local connections:</span><br><span class="line">host    all             all             ::1/128                 ident</span><br><span class="line"></span><br><span class="line"># 将peer改为md5（）</span><br><span class="line"># &quot;local&quot; is for Unix domain socket connections only</span><br><span class="line">local   all             all                                     md5</span><br><span class="line"># IPv4 local connections:</span><br><span class="line">host    all             all             127.0.0.1/32            ident</span><br><span class="line"># IPv6 local connections:</span><br><span class="line">host    all             all             ::1/128                 ident</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 重启psql</span><br><span class="line">systemctl restart postgresql-11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 登录postgre</span><br><span class="line">psql -U kong</span><br><span class="line"># 输入密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看帮助</span><br><span class="line">\h</span><br><span class="line"></span><br><span class="line"># 退出</span><br><span class="line">\q</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里需要提前配置kong配置文件，默认/etc/kong/kong.conf.default</span></span><br><span class="line">cp /etc/kong/kong.conf.default /etc/kong/kong.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改里面的数据库配置，写入用户、密码、数据库、端口等信息</span></span><br><span class="line">vim /etc/kong/kong.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kong migrations</span></span><br><span class="line">kong migrations bootstrap [-c /path/to/kong.conf]</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>启动Kong</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kong start [-c /path/to/kong.conf]</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>使用Kong</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://localhost:8001/</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p><a href="https://docs.konghq.com/install/docker/" target="_blank" rel="noopener">Docker Installation</a></p>
<p>以下是一个快速示例。</p>
<ul>
<li><strong>Create a Docker network</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create kong-net</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>Start your database</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostgreSQL</span></span><br><span class="line">docker run -d --name kong-database \</span><br><span class="line">               --network=kong-net \</span><br><span class="line">               -p 5432:5432 \</span><br><span class="line">               -e <span class="string">"POSTGRES_USER=kong"</span> \</span><br><span class="line">               -e <span class="string">"POSTGRES_DB=kong"</span> \</span><br><span class="line">               postgres:9.6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># or Cassandra</span></span><br><span class="line">docker run -d --name kong-database \</span><br><span class="line">               --network=kong-net \</span><br><span class="line">               -p 9042:9042 \</span><br><span class="line">               cassandra:3</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>Prepare your database</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">     --network=kong-net \</span><br><span class="line">     -e <span class="string">"KONG_DATABASE=postgres"</span> \</span><br><span class="line">     -e <span class="string">"KONG_PG_HOST=kong-database"</span> \</span><br><span class="line">     -e <span class="string">"KONG_CASSANDRA_CONTACT_POINTS=kong-database"</span> \</span><br><span class="line">     kong:latest kong migrations bootstrap</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>Start Kong</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kong \</span><br><span class="line">     --network=kong-net \</span><br><span class="line">     -e <span class="string">"KONG_DATABASE=postgres"</span> \</span><br><span class="line">     -e <span class="string">"KONG_PG_HOST=kong-database"</span> \</span><br><span class="line">     -e <span class="string">"KONG_CASSANDRA_CONTACT_POINTS=kong-database"</span> \</span><br><span class="line">     -e <span class="string">"KONG_PROXY_ACCESS_LOG=/dev/stdout"</span> \</span><br><span class="line">     -e <span class="string">"KONG_ADMIN_ACCESS_LOG=/dev/stdout"</span> \</span><br><span class="line">     -e <span class="string">"KONG_PROXY_ERROR_LOG=/dev/stderr"</span> \</span><br><span class="line">     -e <span class="string">"KONG_ADMIN_ERROR_LOG=/dev/stderr"</span> \</span><br><span class="line">     -e <span class="string">"KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl"</span> \</span><br><span class="line">     -p 8000:8000 \</span><br><span class="line">     -p 8443:8443 \</span><br><span class="line">     -p 8001:8001 \</span><br><span class="line">     -p 8444:8444 \</span><br><span class="line">     kong:latest</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>Use Kong</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i http://localhost:8001/</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h2><p><a href="https://docs.konghq.com/install/kubernetes/" target="_blank" rel="noopener">Kong on Kubernetes</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="无数据库和声明性配置"><a href="#无数据库和声明性配置" class="headerlink" title="无数据库和声明性配置"></a>无数据库和声明性配置</h1><p><a href="https://docs.konghq.com/1.1.x/db-less-and-declarative-config/" target="_blank" rel="noopener">DB-less and Declarative Configuration</a></p>
<p>传统上，Kong总是需要一个数据库（如PostgreSQL或Cassandra），来存储其配置的实体（如服务、路由和插件）。<br>Kong使用其配置文件（<code>kong.conf</code>）来指定各种设置。</p>
<p>Kong v1.1增加了在没有数据库的情况下运行Kong的能力，仅对实体使用内存存储。—— 称之为<strong>无数据库模式（DB-less mode）</strong>。当运行KOng无数据模式时，实体的配置是使用<strong>声明性配置（declarative configuration）</strong>（YAML或JSON）在第二本配置文件中完成的。</p>
<p>无数据库模式和声明性配置的组合具有许多优点：</p>
<ul>
<li>减少依赖的数量： 如果用例的整个设置适合内存，则无需管理数据库安装</li>
<li>非常适合CI/CD场景中的自动化：实体配置可以保存在通过Git Repo管理的单一源中</li>
<li>为Kong提供了更多的部署选项：在Service Mesh场景中非常适合轻量级Sidecar</li>
</ul>
<p><br><br><br></p>
<h2 id="声明性配置"><a href="#声明性配置" class="headerlink" title="声明性配置"></a>声明性配置</h2><p>What Is Declarative Configuration</p>
<p>正如其名称所言，声明性配置中的关键思想是陈述它是声明性（declarative）的，而不是命令式（ imperative style）配置。<br><strong>Imperative</strong>意味着配置是作为一系列顺序给出的：做这做那。<br><strong>Declarative</strong>意味着配置一次全部给出：宣布这是世界的状态。</p>
<p>Kong Admin API是命令式配置工具的一个栗子：配置的最终状态是通过一系列API调用获得。一个调用创建服务，一个调用创建路由，另一个调用添加插件…</p>
<p>像这样递增地执行具有中间状态的配置，会发生不期望的副作用。如在创建路由和添加插件之间存在时间窗口，其中路由没有应用插件。</p>
<p>另一方面，声明性配置文件将包含单个文件中所有所需实体的设置，并且一旦将改配置加载到Kong中，它将替换整个配置。当需要增量更改时，将对声明性配置文件进行更改，然后将其完整地重新加载。在任何时候，加载到Kong中的文件中描述的配置是系统的配置状态。</p>
<p><br><br><br></p>
<h2 id="在无数据库模式配置Kong"><a href="#在无数据库模式配置Kong" class="headerlink" title="在无数据库模式配置Kong"></a>在无数据库模式配置Kong</h2><p>Setting Up Kong in DB-less mode</p>
<p>要在无数据库模式下使用Kong，有两种方式：</p>
<ul>
<li>修改配置文件<code>kong.conf</code></li>
<li>修改环境变量<code>KONG_DATABASE</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kong/kong.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># database = postgres</span></span><br><span class="line">database=off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="built_in">export</span> KONG_DATABASE=off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kong start -c /etc/kong/kong.conf</span><br></pre></td></tr></table></figure>
<p>一旦Kong启动，访问Admin API的<code>/</code>根端点已验证它是否在没有数据库的情况下运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># httpie: &lt;https://github.com/jakubroztocil/httpie&gt;</span></span><br><span class="line">$ http :8001/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 6342</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Date: Wed, 27 Mar 2019 15:24:58 GMT</span><br><span class="line">Server: kong/1.1.0</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"configuration:"</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="string">"database"</span>: <span class="string">"off"</span>,</span><br><span class="line">       ...</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"1.1.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kong正在运行，但尚未加载声明性配置。这意味着此节点的配置为空。没有任何类型的路由、服务或实体。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># httpie</span></span><br><span class="line">http :8001/routes</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 23</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Date: Tue, 14 May 2019 06:58:37 GMT</span><br><span class="line">Server: kong/1.1.2</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"data"</span>: [],</span><br><span class="line">    <span class="string">"next"</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="创建声明性配置文件"><a href="#创建声明性配置文件" class="headerlink" title="创建声明性配置文件"></a>创建声明性配置文件</h2><p>Creating a Declarative Configuration File</p>
<p>要将实体载入到无数据库的Kong，我们需要一个声明性配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此命令在当前目录中创建kong.yml文件</span></span><br><span class="line">kong config -c kong.conf init</span><br><span class="line"></span><br><span class="line">ls .</span><br><span class="line">kong.yml</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="声明性配置格式"><a href="#声明性配置格式" class="headerlink" title="声明性配置格式"></a>声明性配置格式</h2><p>The Declarative Configuration Format</p>
<p>Kong声明性配置格式由实体列表及其属性组成。</p>
<p>看看<code>kong.yml</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># This is an example file to get you started with using</span></span><br><span class="line"><span class="comment"># declarative configuration in Kong.</span></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Metadata fields start with an underscore (_)</span></span><br><span class="line"><span class="comment"># Fields that do not start with an underscore represent Kong entities and attributes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># _format_version is mandatory,</span></span><br><span class="line"><span class="comment"># it specifies the minimum version of Kong that supports the format</span></span><br><span class="line"></span><br><span class="line"><span class="attr">_format_version:</span> <span class="string">"1.1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Each Kong entity (core entity or custom entity introduced by a plugin)</span></span><br><span class="line"><span class="comment"># can be listed in the top-level as an array of objects:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># services:</span></span><br><span class="line"><span class="comment"># - name: example-service</span></span><br><span class="line"><span class="comment">#   url: http://example.com</span></span><br><span class="line"><span class="comment">#   # Entities can store tags as metadata</span></span><br><span class="line"><span class="comment">#   tags:</span></span><br><span class="line"><span class="comment">#   - example</span></span><br><span class="line"><span class="comment">#   # Entities that have a foreign-key relationship can be nested:</span></span><br><span class="line"><span class="comment">#   routes:</span></span><br><span class="line"><span class="comment">#   - name: example-route</span></span><br><span class="line"><span class="comment">#     paths:</span></span><br><span class="line"><span class="comment">#     - /</span></span><br><span class="line"><span class="comment">#   plugins:</span></span><br><span class="line"><span class="comment">#   - name: key-auth</span></span><br><span class="line"><span class="comment"># - name: another-service</span></span><br><span class="line"><span class="comment">#   url: https://example.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># routes:</span></span><br><span class="line"><span class="comment"># - name: another-route</span></span><br><span class="line"><span class="comment">#   # Relationships can also be specified between top-level entities,</span></span><br><span class="line"><span class="comment">#   # either by name or by id</span></span><br><span class="line"><span class="comment">#   service: example-service</span></span><br><span class="line"><span class="comment">#   hosts: ["hello.com"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># consumers:</span></span><br><span class="line"><span class="comment"># - username: example-user</span></span><br><span class="line"><span class="comment">#   # Custom entities from plugin can also be specified</span></span><br><span class="line"><span class="comment">#   # If they specify a foreign-key relationshp, they can also be nested</span></span><br><span class="line"><span class="comment">#   keyauth_credentials:</span></span><br><span class="line"><span class="comment">#   - key: my-key</span></span><br><span class="line"><span class="comment">#   plugins:</span></span><br><span class="line"><span class="comment">#   - name: rate-limiting</span></span><br><span class="line"><span class="comment">#     _comment: "these are default rate-limits for user example-user"</span></span><br><span class="line"><span class="comment">#     config:</span></span><br><span class="line"><span class="comment">#       policy: local</span></span><br><span class="line"><span class="comment">#       second: 5</span></span><br><span class="line"><span class="comment">#       hour: 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># When an entity has multiple foreign-key relationships</span></span><br><span class="line"><span class="comment"># (e.g. a plugin matching on both consumer and service)</span></span><br><span class="line"><span class="comment"># it must be specified as a top-level entity, and not through</span></span><br><span class="line"><span class="comment"># nesting.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># plugins:</span></span><br><span class="line"><span class="comment"># - name: rate-limiting</span></span><br><span class="line"><span class="comment">#   consumer: example-user</span></span><br><span class="line"><span class="comment">#   service: another-service</span></span><br><span class="line"><span class="comment">#   _comment: "example-user is extra limited when using another-service"</span></span><br><span class="line"><span class="comment">#   config:</span></span><br><span class="line"><span class="comment">#     hour: 2</span></span><br><span class="line"><span class="comment">#   # tags are for your organization only and have no meaning for Kong:</span></span><br><span class="line"><span class="comment">#   tags:</span></span><br><span class="line"><span class="comment">#   - extra_limits</span></span><br><span class="line"><span class="comment">#   - my_tag</span></span><br></pre></td></tr></table></figure>
<p>唯一必须声明的元数据是<code>_format_version</code>，它指定声明性配置语法格式的版本号。这也匹配解析文件所需的Kong的最小版本。</p>
<p><br><br><br></p>
<h2 id="检查声明性配置文件"><a href="#检查声明性配置文件" class="headerlink" title="检查声明性配置文件"></a>检查声明性配置文件</h2><p>Checking The Declarative Configuration File</p>
<p>编辑完文件后，可在将声明性配置文件加载到Kong之前检查任何语法错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parse &lt;file&gt;，Parse a declarative config file (check its syntax) but do not load it into Kong.</span></span><br><span class="line"><span class="comment"># kong config -c kong.conf parse kong.yml</span></span><br><span class="line">kong config parse kong.yml</span><br><span class="line"></span><br><span class="line">parse successful</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="加载声明性配置文件"><a href="#加载声明性配置文件" class="headerlink" title="加载声明性配置文件"></a>加载声明性配置文件</h2><p>Loading The Declarative Configuration File</p>
<p>有两种方式可将声明性配置文件加载到Kong：</p>
<ul>
<li>通过<code>kong.conf</code></li>
<li>通过Admin API</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kong.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改环境变量</span></span><br><span class="line"><span class="built_in">export</span> KONG_DATABASE=off</span><br><span class="line"><span class="built_in">export</span> KONG_DECLARATIVE_CONFIG=kong.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或修改配置文件</span></span><br><span class="line">database=off</span><br><span class="line">declarative_config=kong.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kong start -c /etc/kong/kong.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用/根端点通过其Admin API将声明性配置加载在正在运行的Kong节点中</span></span><br><span class="line"><span class="comment"># 栗子使用httpie加载kong.yml</span></span><br><span class="line">http :8001/config config=@kong.yml</span><br><span class="line"></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 2</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Date: Tue, 14 May 2019 06:59:57 GMT</span><br><span class="line">Server: kong/1.1.2</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="在无数据库模式下使用Kong"><a href="#在无数据库模式下使用Kong" class="headerlink" title="在无数据库模式下使用Kong"></a>在无数据库模式下使用Kong</h2><p>Using Kong in DB-less Mode</p>
<p>在无数据库模式下使用Kong时，有许多事项需要注意。</p>
<p><br></p>
<h3 id="内存缓存要求"><a href="#内存缓存要求" class="headerlink" title="内存缓存要求"></a>内存缓存要求</h3><p>Memory Cache Requirements</p>
<p>实体的整个配置必须适合Kong Cache。确保正确配置了内存缓存（memory cache）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">'mem_cache_size'</span> /etc/kong/kong.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#mem_cache_size = 128m</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="只读Admin-API"><a href="#只读Admin-API" class="headerlink" title="只读Admin API"></a>只读Admin API</h3><p>Read-Only Admin API</p>
<p>由于配置实体的唯一方法是通过声明性配置文件，因此在无数据库模式下运行Kong时，实体上的CRUD操作的端点在Admin API中实际上是只读的。<code>GET</code>操作正常工作，但在端点(/services, /plugins…)中<code>POST, PATCH, PUT, DELETE</code>将返回<code>HTTP 405 Not Allowed</code>。</p>
<p>此限制仅限于数据库操作。特别是，仍然启用<code>POST</code>来设置目标的运行状态，因为这是特定节点的内存中的操作。</p>
<p><br><br><br></p>
<h3 id="插件兼容性"><a href="#插件兼容性" class="headerlink" title="插件兼容性"></a>插件兼容性</h3><p>Plugin Compatibility</p>
<p>并非所有的Kong插件斗鱼无数据库模式兼容。因为其中一些插件需要中央数据库协调或动态创建实体。</p>
<p><br></p>
<p><strong>完全兼容（Fully Compatible）</strong><br>以下插件只从数据库中读取（大多是读取初始配置），因此与无数据库模式完全兼容。</p>
<ul>
<li><code>aws-lambda</code></li>
<li><code>azure-functions</code></li>
<li><code>bot-detection</code></li>
<li><code>correlation-id</code></li>
<li><code>cors</code></li>
<li><code>datadog</code></li>
<li><code>file-log</code></li>
<li><code>http-log</code></li>
<li><code>tcp-log</code></li>
<li><code>udp-log</code></li>
<li><code>syslog</code></li>
<li><code>ip-restriction</code></li>
<li><code>prometheus</code></li>
<li><code>zipkin</code></li>
<li><code>request-transformer</code></li>
<li><code>response-transformer</code></li>
<li><code>request-termination</code></li>
<li><code>kubernetes-sidecar-injector</code></li>
</ul>
<p><br></p>
<p><strong>部分兼容（Partial Compatibility）</strong><br>只要使用的凭证集是静态的并且指定为声明性配置的一部分，就可以使用认证插件。在无数据库模式下，无法使用Admin API端点来动态创建、更新或删除凭据。属于此类的插件有：</p>
<ul>
<li><code>acl</code></li>
<li><code>basic-auth</code></li>
<li><code>hmac-auth</code></li>
<li><code>jwt</code></li>
<li><code>key-auth</code></li>
</ul>
<p>与Kong捆绑在一起的速率限制插件提供了不同的策略来存储可协调计数器：</p>
<ul>
<li><code>Local</code>策略：用于存储计数器节点的内存，以每个节点的方式应用限制；</li>
<li><code>Redis</code>策略：使用Redis作为外部键值存储来协调跨节点的计数器；</li>
<li><code>Cluster</code>策略：使用Kong数据库作为集群范围限制的中心协调点。</li>
</ul>
<p>在无数据库模式下，Local和Redis策略可用，无法使用Cluster策略。属于此类的插件有：</p>
<ul>
<li><code>rate-limiting</code></li>
<li><code>response-ratelimiting</code></li>
</ul>
<p>无服务器（serverless）的<code>pre-function</code>和<code>post-function</code>可在无数据库模式下使用。但需注意，如果任何已配置的功能尝试写入数据库，则写入将失败。</p>
<p><br></p>
<p><strong>不兼容（Not Compatible）</strong></p>
<ul>
<li><code>oauth2</code>：对于常规工作，插件需生成和删除token，并将这些更改提交到数据库</li>
</ul>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="流和服务网格"><a href="#流和服务网格" class="headerlink" title="流和服务网格"></a>流和服务网格</h1><p><a href="https://docs.konghq.com/1.1.x/streams-and-service-mesh/" target="_blank" rel="noopener">Streams and Service Mesh</a></p>
<p>Kong v1.0.0增加了代理(proxy)和路由(route)原始TCP和TLS流(stream)的能力，并使用service-mesh sidecar和在Kong节点之间交互TLS来部署Kong。<br>本章将介绍使用简单工具简化Service Mesh部署的基本设置： 两台服务器，通过两个Kong节点在一台主机中互相通信。如果你有兴趣使用k8s运行Service Mesh，请查看<a href="https://github.com/Kong/kong-mesh-dist-kubernetes" target="_blank" rel="noopener">Kubernetes and Service Mesh example</a></p>
<p>Kong支持逐步部署sidecar。它即可以作为传统网关，也可作为服务网格节点同时工作。在Kong中，服务网格是动态构建的，只有在Kong节点之间存在活动连接时才存在。简而言之，这意味着Kong节点不必了解其它Kong节点，服务也不必了解Kong。</p>
<p><br></p>
<h2 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h2><p>Prerequisites</p>
<p>需使用Kong v1.1.0+来运行不同的部署方案。建议使用Linux发行版来演示。系统上需要的一些工具：</p>
<ul>
<li><code>ncat</code>(<code>nmap</code>)</li>
<li><code>iptables</code></li>
<li><code>curl</code></li>
</ul>
<p>你的主机需要监控<code>lo0</code>网络适配器绑定到这些ip：</p>
<ul>
<li><code>127.0.0.1</code> (Host C running Kong Control Plane)</li>
<li><code>127.0.0.2</code> (Host A running Service A)</li>
<li><code>127.0.0.3</code> (Host A running Kong A)</li>
<li><code>127.0.0.4</code> (Host B running Kong B)</li>
<li><code>127.0.0.5</code> (Host B running Service B)</li>
</ul>
<p>本章的教程在单个主机上运行所有内容。为了简单起见，我们还是用IP地址而不是DNS来配置所有内容。<br>对于某些更改，可能需要root权限。</p>
<p><br><br><br><br><br></p>
<h2 id="术语和定义"><a href="#术语和定义" class="headerlink" title="术语和定义"></a>术语和定义</h2><p>Terms and Definitions</p>
<ul>
<li><strong>Kong Control Plane</strong>： 在<code>127.0.0.1</code>上启动。它在<code>8001</code>和<code>8444</code>上监听Kong Admin API，它不代理任何流量；</li>
<li><strong>Service A</strong>：假象的业务实体（微服务），使网络连接到Service B；</li>
<li><strong>Service B</strong>：接受来自Service A的网络连接的业务实体；</li>
<li><strong>Kong A</strong>：它是服务A前端的sidecar代理。它不监听和提供Kong Admin API；</li>
<li><strong>Kong B</strong>：它是服务B前端的sidecar代理。它不监听和提供Kong Admin API；</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="步骤1：启动服务B"><a href="#步骤1：启动服务B" class="headerlink" title="步骤1：启动服务B"></a>步骤1：启动服务B</h2><p>Step1: Start Service B</p>
<p>启动Service B监听TCP流量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ncat --listen \</span><br><span class="line">       --keep-open \</span><br><span class="line">       --verbose \</span><br><span class="line">       --sh-exec <span class="string">"echo 'Hello from Service B (TCP)'"</span> \</span><br><span class="line">       127.0.0.5 19000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on 127.0.0.5:19000</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>让命令继续运行。开一个新控制台并启动Service B监听TLS流量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ncat --listen \</span><br><span class="line">       --keep-open \</span><br><span class="line">       --verbose \</span><br><span class="line">       --ssl \</span><br><span class="line">       --sh-exec <span class="string">"echo 'Hello from Service B (TLS)'"</span> \</span><br><span class="line">       127.0.0.5 19443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on 127.0.0.5:19443</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>让它继续运行。开一个新控制台并启动Service B监听HTTP流量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ncat --listen \</span><br><span class="line">     --keep-open \</span><br><span class="line">     --verbose \</span><br><span class="line">     --sh-exec <span class="string">"echo 'HTTP/1.1 200 OK\r\n\r\nHello from Service (HTTP)'"</span> \</span><br><span class="line">     127.0.0.5 18000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on 127.0.0.5:18000</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>让它继续运行，开一个新控制台并启动Service B监听HTTPS流量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ncat --listen \</span><br><span class="line">     --keep-open \</span><br><span class="line">     --verbose \</span><br><span class="line">     --ssl \</span><br><span class="line">     --sh-exec <span class="string">"echo 'HTTP/1.1 200 OK\r\n\r\nHello from Service B (HTTPS)'"</span> \</span><br><span class="line">     127.0.0.5 18443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Generating a temporary 1024-bit RSA key. Use --ssl-key and --ssl-cert to use a permanent one.</span><br><span class="line">Ncat: SHA-1 fingerprint: 9B41 1A89 664A 434A 35A7 6DFA 9540 3D21 9466 46D1</span><br><span class="line">Ncat: Listening on 127.0.0.5:18443</span><br></pre></td></tr></table></figure>
<p>同样，保持命令继续运行。<br>此时，应该有4个ncat进程在运行，表示Service B使用不同的协议进行监听。</p>
<p><br><br><br><br><br></p>
<h2 id="步骤2：确保服务A可以连接到服务B"><a href="#步骤2：确保服务A可以连接到服务B" class="headerlink" title="步骤2：确保服务A可以连接到服务B"></a>步骤2：确保服务A可以连接到服务B</h2><p>Step2: Ensure that Service A can connect Service B</p>
<p>Service A直接调用<code>ncat</code>和<code>curl</code>。</p>
<p><br></p>
<p>使用TCP与Service B连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ncat --<span class="built_in">source</span> 127.0.0.2 --recv-only 127.0.0.5 19000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Hello from Service B (TCP)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用TLS与Service B连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ncat --<span class="built_in">source</span> 127.0.0.2 --recv-only --ssl 127.0.0.5 19443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Hello from Service B (TLS)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用HTTP与Service B连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl --interface 127.0.0.2 http://127.0.0.5:18000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Hello from Service B (HTTP)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用HTTPS与Service B连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl --interface 127.0.0.2 --insecure https://127.0.0.5:18443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Hello from Service B (HTTPS)</span><br></pre></td></tr></table></figure>
<p>服务A运行在<code>127.0.0.2</code>并可以直接连接到服务B。</p>
<p><br><br><br><br><br></p>
<h2 id="步骤3：启动Kong控制面板"><a href="#步骤3：启动Kong控制面板" class="headerlink" title="步骤3：启动Kong控制面板"></a>步骤3：启动Kong控制面板</h2><p>Step 3: Start Kong Control Plane</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动金监听Kong Admin API的Kong节点</span></span><br><span class="line">KONG_PREFIX=kong-c \</span><br><span class="line">KONG_LOG_LEVEL=debug \</span><br><span class="line">KONG_STREAM_LISTEN=<span class="string">"off"</span> \</span><br><span class="line">KONG_PROXY_LISTEN=<span class="string">"off"</span> \</span><br><span class="line">KONG_ADMIN_LISTEN=<span class="string">"127.0.0.1:8001, 127.0.0.1:8444 ssl"</span> \</span><br><span class="line">  kong start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Kong started</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="步骤4：启动Kong-A"><a href="#步骤4：启动Kong-A" class="headerlink" title="步骤4：启动Kong A"></a>步骤4：启动Kong A</h2><p>Step4: Start Kong A</p>
<p>Kong A将是一个作为Service A的sidecar的Kong实例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">KONG_PREFIX=kong<span class="_">-a</span> \</span><br><span class="line">KONG_LOG_LEVEL=debug \</span><br><span class="line">KONG_STREAM_LISTEN=<span class="string">"127.0.0.3:9000 transparent, 127.0.0.3:9443 transparent"</span> \</span><br><span class="line">KONG_PROXY_LISTEN=<span class="string">"127.0.0.3:8000 transparent, 127.0.0.3:8443 ssl transparent"</span> \</span><br><span class="line">KONG_ADMIN_LISTEN=<span class="string">"off"</span> \</span><br><span class="line">KONG_NGINX_PROXY_PROXY_BIND=<span class="string">"127.0.0.3"</span> \</span><br><span class="line">KONG_NGINX_SPROXY_PROXY_BIND=<span class="string">"127.0.0.3"</span> \</span><br><span class="line">  kong start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Kong started</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>关于<code>transparent</code>选项</strong></p>
<p><code>transparent</code>选项使Kong可使用<code>iptables PREROUTING</code>规则的请求，并在<code>iptables</code>堆栈透明地将其代理到其sidecar代理之前读取原始目标地址和客户端尝试连接的端口。</p>
<p><br><br><br><br><br></p>
<h2 id="步骤5：启动Kong-B"><a href="#步骤5：启动Kong-B" class="headerlink" title="步骤5：启动Kong B"></a>步骤5：启动Kong B</h2><p>Step 5: Start Kong B</p>
<p>Kong B将是一个作为Service B的sidecar的Kong实例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">KONG_PREFIX=kong-b \</span><br><span class="line">KONG_LOG_LEVEL=debug \</span><br><span class="line">KONG_STREAM_LISTEN=<span class="string">"127.0.0.4:9000 transparent, 127.0.0.4:9443 transparent"</span> \</span><br><span class="line">KONG_PROXY_LISTEN=<span class="string">"127.0.0.4:8000 transparent, 127.0.0.4:8443 transparent ssl"</span> \</span><br><span class="line">KONG_ADMIN_LISTEN=<span class="string">"off"</span> \</span><br><span class="line">KONG_NGINX_PROXY_PROXY_BIND=<span class="string">"127.0.0.4"</span> \</span><br><span class="line">KONG_NGINX_SPROXY_PROXY_BIND=<span class="string">"127.0.0.4"</span> \</span><br><span class="line">  kong start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Kong started</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="步骤6：创建Kong服务和路由"><a href="#步骤6：创建Kong服务和路由" class="headerlink" title="步骤6：创建Kong服务和路由"></a>步骤6：创建Kong服务和路由</h2><p>Step 6: Create Kong Services and Routes</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为Service B的TCP流量创建Kong服务</span></span><br><span class="line">curl -X PUT \</span><br><span class="line">       -d url=tcp://127.0.0.5:19000 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为服务创建路由</span></span><br><span class="line">curl -X POST \</span><br><span class="line">       -d name=service-b-tcp \</span><br><span class="line">       -d protocols=tcp \</span><br><span class="line">       -d destinations[1].ip=127.0.0.5 \</span><br><span class="line">       -d destinations[1].port=19000 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-tcp/routes</span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为Service B的TLS流量创建服务</span></span><br><span class="line">curl -X PUT \</span><br><span class="line">       -d url=tls://127.0.0.5:19443 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-tls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加路由</span></span><br><span class="line">curl -X POST \</span><br><span class="line">       -d name=service-b-tls \</span><br><span class="line">       -d protocols=tls \</span><br><span class="line">       -d destinations[1].ip=127.0.0.5 \</span><br><span class="line">       -d destinations[1].port=19443 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-tls/routes</span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为Service B的HTTP流量创建服务</span></span><br><span class="line">curl -X PUT \</span><br><span class="line">       -d url=http://127.0.0.5:18000 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-http</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加路由</span></span><br><span class="line">curl -X POST \</span><br><span class="line">       -d name=service-b-http \</span><br><span class="line">       -d protocols=http \</span><br><span class="line">       -d hosts=127.0.0.5 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-http/routes</span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为Service B的HTTPS流量创建服务</span></span><br><span class="line">curl -X PUT \</span><br><span class="line">       -d url=https://127.0.0.5:18443/ \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-https</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加路由</span></span><br><span class="line">curl -X POST \</span><br><span class="line">       -d name=service-b-https \</span><br><span class="line">       -d protocols=https \</span><br><span class="line">       -d hosts=127.0.0.5 \</span><br><span class="line">       http://127.0.0.1:8001/services/service-b-https/routes</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="步骤7：配置代理规则"><a href="#步骤7：配置代理规则" class="headerlink" title="步骤7：配置代理规则"></a>步骤7：配置代理规则</h2><p>Step 7: Configure Transparent Proxying Rules</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>Reference</p>
<p><br></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><a href="https://docs.konghq.com/1.1.x/configuration/" target="_blank" rel="noopener">Configuration Reference</a></p>
<p><br></p>
<h3 id="配置加载"><a href="#配置加载" class="headerlink" title="配置加载"></a>配置加载</h3><p>Configuration loading</p>
<p>如果通关官方软件包安装Kong，则可以在<code>/etc/kong/kong.conf.default</code>找到此默认文件。</p>
<p>如果配置文件中的所有值都被注释掉，Kong将使用默认配置运行。为方便起见，可将布尔值指定为<code>on/off</code>或<code>true/false</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置Kong</span></span><br><span class="line">cp /etc/kong/kong.conf.default /etc/kong/kong.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动时，Kong会查找可能包含配置文件的多个默认位置</span></span><br><span class="line">/etc/kong.conf</span><br><span class="line">/etc/kong/kong.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过-c/--conf参数指定自定义配置文件来覆盖默认行为</span></span><br><span class="line">kong start --conf /path/to/kong.conf</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h3><p>Verifying your configuration</p>
<p>你可以通过命令验证配置的完整性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kong check /path/to/kong.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># debug模式</span></span><br><span class="line">kong start -c /path/to/kong.conf --vv</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>Environment variables</p>
<p>从配置文件中加载属性时，Kong还是查找同名的环境变量。这允许你通过环境变量配置Kong，这对于容器结构非常方便。<br>要使用环境变量覆盖配置，请设置声明环境变量，如<code>KONG_XXX</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kong.conf</span></span><br><span class="line">log_level = debug</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># env</span></span><br><span class="line"><span class="built_in">export</span> KONG_LOG_LEVEL=error</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="注入Nginx指令"><a href="#注入Nginx指令" class="headerlink" title="注入Nginx指令"></a>注入Nginx指令</h3><p>Injecting Nginx directives</p>
<p>通过调整Kong实例的Nginx配置，你可以优化其基础架构的性能。</p>
<p>当Kong启动时，它会构建一个Nginx配置文件。你可通过Kong配置直接将自定义Nginx指令注入此文件。</p>
<p><br></p>
<h4 id="注入单个Nginx指令"><a href="#注入单个Nginx指令" class="headerlink" title="注入单个Nginx指令"></a>注入单个Nginx指令</h4><p>Injecting individual Nginx directives</p>
<p>添加到<code>kong.conf</code>文件的任何以<code>nginx_http_</code>, <code>nging_proxy_</code>, <code>nginx_admin_</code>为前缀的条目将通过删除前缀并添加到Nginx配置的相应部分而转换为等效的Nginx指令。</p>
<ul>
<li>带有<code>nginx_http_</code>前缀的条目将被注入http块；</li>
<li>带有<code>nginx_proxy_</code>前缀的条目将被注入处理Kong的代理端口的server块；</li>
<li>带有<code>nginx_admin_</code>前缀的条目将被注入处理Kong的Admin API端口的server块。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如，将以下行添加到`kong.conf`文件：</span></span><br><span class="line">nginx_proxy_large_client_header_buffers=16 128k</span><br><span class="line"><span class="comment"># 它将添加到Kong的Nginx 配置的代理server</span></span><br><span class="line">large_client_header_buffers 16 128k;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或通过环境变量</span></span><br><span class="line"><span class="built_in">export</span> KONG_NGINX_HTTP_OUTPUT_BUFFERS=<span class="string">"4 64k"</span></span><br><span class="line"><span class="comment"># 它将添加到nginx的http块</span></span><br><span class="line">output_buffers 4 64k;</span><br></pre></td></tr></table></figure>
<p>有关更多的Nginx指令，请参考<a href="https://nginx.org/en/docs/dirindex.html" target="_blank" rel="noopener">Nginx文档</a>。但请注意，某些执行依赖于特定Nginx模块，其中一些可能没有包含在Kong版本中。</p>
<p><br><br><br></p>
<h4 id="注入Nginx指令文件"><a href="#注入Nginx指令文件" class="headerlink" title="注入Nginx指令文件"></a>注入Nginx指令文件</h4><p>Including files via injected Nginx directives</p>
<p>对于更复杂的配置，可将Nginx指令写入配置文件，然后将其注入Kong。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 栗子，my-server.kong.conf</span></span><br><span class="line"><span class="comment"># custom server</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 2112;</span><br><span class="line">  location / &#123;</span><br><span class="line">    <span class="comment"># ...more settings...</span></span><br><span class="line">    <span class="built_in">return</span> 200;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在kong.conf配置文件中添加条目使kong节点服务此端口</span></span><br><span class="line">nginx_http_include = /path/to/your/my-server.kong.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或通过环境变量</span></span><br><span class="line"><span class="built_in">export</span> KONG_NGINX_HTTP_INCLUDE=<span class="string">"/path/to/your/my-server.kong.conf"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试</span></span><br><span class="line">curl -I http://127.0.0.1:2112</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="自定义Nginx模板并嵌入Kong"><a href="#自定义Nginx模板并嵌入Kong" class="headerlink" title="自定义Nginx模板并嵌入Kong"></a>自定义Nginx模板并嵌入Kong</h3><p>Custom Nginx templates and embedding Kong</p>
<p>对于绝大多数用例，使用上面的指令注入已足够定义Kong的Nginx实例的行为。这样，你可从单个<code>kong.conf</code>文件（以及自己包含的文件）管理Kong节点的配置和调优，而无需自定义Nginx配置模板。</p>
<p>有两种情况，你希望直接使用自定义的Nginx配置模板：</p>
<ul>
<li>在极少数情况下，你可能需要修改一些不能通过其标准<code>kong.conf</code>属性调整的Kong默认的Nginx配置。你可以修改Kong用于生成器Nginx配置并使用你自定义的模板启动Kong的模板；</li>
<li>如果需要在已经运行的OpenResty实例中嵌入Kong，则可重用Kong生成的配置并将其包含在现有配置中。</li>
</ul>
<p><br></p>
<h4 id="自定义Nginx模板"><a href="#自定义Nginx模板" class="headerlink" title="自定义Nginx模板"></a>自定义Nginx模板</h4><p>Custom Nginx templates</p>
<p>可使用<code>--nginx-conf</code>参数启动、重载和重启Kong，该参数必须指定Nginx配置模板。这样的模板使用Penlight模板引擎，该引擎使用给定的Kong配置进行编译，然后在启动Nginx之前将其转储到Kong前缀目录中。</p>
<p>默认模板可在GitHub上查看: <a href="https://github.com/kong/kong/tree/master/kong/templates" target="_blank" rel="noopener">https://github.com/kong/kong/tree/master/kong/templates</a>。它分为两个Nginx配置文件<code>nginx.lua</code>和<code>nginx_kong.lua</code>。当<code>kong start</code>运行时，它会将这两个文件复制到前缀目录中，如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kong</span><br><span class="line">├── nginx-kong.conf</span><br><span class="line">└── nginx.conf</span><br></pre></td></tr></table></figure>
<p>如果你必须调整Kong定义但不能通过<code>kong.conf</code>配置的全局设置，你可将<code>nginx_kong.lua</code>配置模板的内容内联到一个自定义模板文件，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------</span><br><span class="line"># custom_nginx.template</span><br><span class="line"># ---------------------</span><br><span class="line"></span><br><span class="line">worker_processes $&#123;&#123;NGINX_WORKER_PROCESSES&#125;&#125;; # can be set by kong.conf</span><br><span class="line">daemon $&#123;&#123;NGINX_DAEMON&#125;&#125;;                     # can be set by kong.conf</span><br><span class="line"></span><br><span class="line">pid pids/nginx.pid;                      # this setting is mandatory</span><br><span class="line">error_log logs/error.log $&#123;&#123;LOG_LEVEL&#125;&#125;; # can be set by kong.conf</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;          # a custom setting</span><br><span class="line">    multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">  # contents of the nginx_kong.lua template follow:</span><br><span class="line"></span><br><span class="line">  resolver $&#123;&#123;DNS_RESOLVER&#125;&#125; ipv6=off;</span><br><span class="line">  charset UTF-8;</span><br><span class="line">  error_log logs/error.log $&#123;&#123;LOG_LEVEL&#125;&#125;;</span><br><span class="line">  access_log logs/access.log;</span><br><span class="line"></span><br><span class="line">  ... # etc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">kong start -c kong.conf --nginx-conf custom_nginx.template</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="在OpenResty中嵌入Kong"><a href="#在OpenResty中嵌入Kong" class="headerlink" title="在OpenResty中嵌入Kong"></a>在OpenResty中嵌入Kong</h3><p>Embedding Kong in OpenResty</p>
<p>如果您正在运行自己的OpenResty Server，您还可以通过使用<code>include</code>指令包含Kong Nginx自配置来轻松嵌入Kong。栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># my_nginx.conf</span><br><span class="line"></span><br><span class="line"># ...your nginx settings...</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include &apos;nginx-kong.conf&apos;;</span><br><span class="line"></span><br><span class="line">    # ...your nginx settings...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Nginx实例</span></span><br><span class="line">nginx -p /usr/<span class="built_in">local</span>/openresty -c my_nginx.conf</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="同时提供来自Kong的Website和API"><a href="#同时提供来自Kong的Website和API" class="headerlink" title="同时提供来自Kong的Website和API"></a>同时提供来自Kong的Website和API</h3><p>Serving both a website and your APIs from Kong</p>
<p>提供API的一个常见用例是让Kong通过代理端口(80/443)在生产中同时为Website和API提供服务。例如，<code>https://example.net</code>（Website）和<code>https://example.net/api/v1</code>（API）。<br>为了实现此目标，我们不能简单地声明一个新的虚拟<code>server</code>块。一个好的解决办法是使用自定义Nginx配置模板，该模板内联<code>nginx_kong.lua</code>并添加一个新的<code>location</code>块，为Kong Proxy <code>location</code>块提供服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># ---------------------</span><br><span class="line"># custom_nginx.template</span><br><span class="line"># ---------------------</span><br><span class="line"></span><br><span class="line">worker_processes $&#123;&#123;NGINX_WORKER_PROCESSES&#125;&#125;; # can be set by kong.conf</span><br><span class="line">daemon $&#123;&#123;NGINX_DAEMON&#125;&#125;;                     # can be set by kong.conf</span><br><span class="line"></span><br><span class="line">pid pids/nginx.pid;                      # this setting is mandatory</span><br><span class="line">error_log logs/error.log $&#123;&#123;LOG_LEVEL&#125;&#125;; # can be set by kong.conf</span><br><span class="line">events &#123;&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  # here, we inline the contents of nginx_kong.lua</span><br><span class="line">  charset UTF-8;</span><br><span class="line"></span><br><span class="line">  # any contents until Kong&apos;s Proxy server block</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  # Kong&apos;s Proxy server block</span><br><span class="line">  server &#123;</span><br><span class="line">    server_name kong;</span><br><span class="line"></span><br><span class="line">    # any contents until the location / block</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    # here, we declare our custom location serving our website</span><br><span class="line">    # (or API portal) which we can optimize for serving static assets</span><br><span class="line">    location / &#123;</span><br><span class="line">      root /var/www/example.net;</span><br><span class="line">      index index.htm index.html;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # Kong&apos;s Proxy location / has been changed to /api/v1</span><br><span class="line">    location /api/v1 &#123;</span><br><span class="line">      set $upstream_host nil;</span><br><span class="line">      set $upstream_scheme nil;</span><br><span class="line">      set $upstream_uri nil;</span><br><span class="line"></span><br><span class="line">      # Any remaining configuration for the Proxy location</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Kong&apos;s Admin server block goes below</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p>Properties reference</p>
<p><br></p>
<h4 id="GENERAL"><a href="#GENERAL" class="headerlink" title="GENERAL"></a>GENERAL</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># GENERAL</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 工作目录。相当于Nginx的前缀路径，包含临时文件和日志</span><br><span class="line"># 每个Kong进程必须有一个单独的工作目录</span><br><span class="line">prefix = /usr/local/kong/  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Nginx Server的日志级别，位于&lt;prefix&gt;/logs/error.log</span><br><span class="line">log_level = notice  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 代理端口的访问日志路径。设置为off可禁用</span><br><span class="line"># 如果此值是相对路径，则它位于&lt;prefix&gt;</span><br><span class="line">proxy_access_log = logs/access.log  #default</span><br><span class="line"></span><br><span class="line"># 代理端口的错误日志路径</span><br><span class="line">proxy_error_log = logs/error.log  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Admin API请求访问的日志路径</span><br><span class="line">admin_access_log = logs/admin_access.log  #default</span><br><span class="line"></span><br><span class="line"># Admin API请求错误的日志路径</span><br><span class="line">admin_error_log = logs/error.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># plugins</span><br><span class="line"># 加载以逗号分隔的插件列表。默认情况下，只有捆绑在官方发行版中的插件才会通过bundled关键字加载。</span><br><span class="line"># 默认不启用加载插件</span><br><span class="line"># 特定名称将在Lua命名空间中替换为：kong.plugins.&#123;name&#125;.*</span><br><span class="line"># off关键字被指定为唯一时，不会加载任何插件</span><br><span class="line"># bundled和plugin名称可以混合在一起，示例如下：</span><br><span class="line">#  - plugins = bundled,custom-auth,custom-log</span><br><span class="line">#  - plugins = custom-auth,custom-log</span><br><span class="line">#  - plugins = off</span><br><span class="line"># 在禁用插件之前，请确保在重新启动Kong之前删除它的所有实例</span><br><span class="line">plugin = bundled  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 发送匿名使用数据，如错误栈追踪，以帮助改善Kong</span><br><span class="line">anonymous_reports = on  #default</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="NGINX"><a href="#NGINX" class="headerlink" title="NGINX"></a>NGINX</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># NGINX</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 以逗号分隔的代理服务器应监听HTTP/HTTPS流量的地址和端口列表</span><br><span class="line"># 代理服务器是Kong的公共入口点，它将来自消费者的流量代理到后端服务</span><br><span class="line"># 此值接受IPv4, IPv6, hostname</span><br><span class="line"># 可以为每对指定一些后缀：</span><br><span class="line">#  - ssl，要求通过特定地址/端口建立的所有连接都在启用TLS的情况下进行</span><br><span class="line">#  - http2，允许客户端打开到Kong代理服务器的HTTP2连接</span><br><span class="line">#  - proxy_protocol，为给定的地址/端口启用PROXY协议</span><br><span class="line">#  - transparent，Kong监听您在iptables中配置的任何IP 地址和端口，并进行响应</span><br><span class="line"># 此值可设为off，从而禁用此节点的HTTP/HTTPS代理端口</span><br><span class="line"># 栗子：proxy_listen = 0.0.0.0:443 ssl, 0.0.0.0:444 http2 ssl</span><br><span class="line">proxy_listen = 0.0.0.0:8000, 0.0.0.0:8443 ssl  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 流模式监听以逗号分隔的地址和端口列表</span><br><span class="line"># 此值接受 IPv4, Ipv6, hostname</span><br><span class="line"># 可为每队指定一些后缀：</span><br><span class="line">#  - proxy_protocol，为给定的地址/端口启用PROXY协议</span><br><span class="line">#  - transparent，Kong监听您在iptables中配置的任何IP 地址和端口，并进行响应</span><br><span class="line"># 不支持ssl后缀，并且每个地址/端口都将接受启用/未启用TLS的TCP</span><br><span class="line"># 栗子：</span><br><span class="line"># stream_listen = 127.0.0.1:7000</span><br><span class="line"># stream_listen = 0.0.0.0:989, 0.0.0.0:20</span><br><span class="line"># stream_listen = [::1]:1234</span><br><span class="line"># 默认设置为off，从而禁用此节点的流代理端口</span><br><span class="line">stream_listen = off  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Admin接口监听的地址和端口列表</span><br><span class="line"># Admin API允许您配置和管理Kong</span><br><span class="line"># 应仅限于Kong管理员访问此接口</span><br><span class="line"># 此值接受 IPv4, IPv6, Hostname</span><br><span class="line"># 可为每队执行一些后缀：</span><br><span class="line">#  - ssl</span><br><span class="line">#  - http2</span><br><span class="line">#  - proxy_protocol</span><br><span class="line"># 栗子</span><br><span class="line"># stream_listen = 127.0.0.1:8444 http2 ssl</span><br><span class="line">admin_listen = 127.0.0.1:8001, 127.0.0.1:8444 ssl  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义工作进程使用的用户和组凭据</span><br><span class="line"># 如果省略group，则默认为User一致</span><br><span class="line">nginx_user = nobody nobody</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Nginx生成的工作进程数</span><br><span class="line">nginx_worker_processes = auto  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Nginx是作为守护进程还是前台进程运行</span><br><span class="line"># 主要用于在Docker环境下运行Kong</span><br><span class="line">nginx_daemon = on  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 数据库实体的内存缓存大小</span><br><span class="line"># 单位接收KB和MB，最小推荐值几MBs</span><br><span class="line">mem_cache_size = 128m  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义Nginx提供的TLS密码</span><br><span class="line"># 可接受的值包括：modern, intermediate, old, custom</span><br><span class="line">ssl_cipher_suite = modern  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义由Nginx提供服务的TLS密码的自定义列表。此列表必须符合openssl密码定义的模式</span><br><span class="line">ssl_ciphers =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启用SL的proxy_listen值的SSL证书的绝对路径</span><br><span class="line">ssl_cert =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启用SSL的proxy_listen值的SSL Key的绝对路径</span><br><span class="line">ssl_cert_key =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 确定代理请求时Nginx是否应发送客户端SSL证书</span><br><span class="line">client_ssl = off  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 如果启用了client_ssl，则为proxy_ssl_certificate指令的客户端SSL证书的绝对路径</span><br><span class="line"># 请注意，此值是在节点上静态定义的，并且当前无法基于每个API进行配置。</span><br><span class="line">client_ssl_cert =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 如果启用了client_ssl，则为proxy_ssl_certificate_key地址的客户端SSL密钥的绝对路径</span><br><span class="line"># 请注意，此值是在节点上静态定义的，目前无法基于每个API进行配置</span><br><span class="line">client_ssl_cert_key =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启用SSL的admin_listen值的SSL证书的绝对路径</span><br><span class="line">admin_ssl_cert =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启用SSL的admin_listen值的SSL Key的绝对路径</span><br><span class="line">admin_ssl_cert_key =  #Default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置在每个工作进程的缓存中保留的上游服务器的最大空闲keepalive连接数。</span><br><span class="line"># 超过此数量时，将关闭最近最少使用的连接。</span><br><span class="line"># 值为0表示禁用此功能</span><br><span class="line">upstream_keepalive = 60  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 以逗号分隔的Header列表应该在客户端响应中注入</span><br><span class="line"># 接受的值如下：</span><br><span class="line">#  - Server，Server: kong/x.y.z</span><br><span class="line">#  - Via，Via: kong/x.y.z</span><br><span class="line">#  - X-Kong-Proxy-Latency，Kong代理上游请求之前处理并运行所有插件所花费的时间(ms)</span><br><span class="line">#  - X-Kong-Upstream-Latency，上游服务发送响应头所花费的时间(ms)</span><br><span class="line">#  - X-Kong-Upstream-Status，上游服务返回的HTTP状态码。如果响应被插件重写，这对于客户端区分上游状态特别有用</span><br><span class="line">#  - server_tokens，与指定Server和Via相同</span><br><span class="line">#  - latency_tokens，与指定X-Kong-Proxy-Latency和X-Kong-Upstream-Latency相同</span><br><span class="line">headers = server_tokens, latency_tokens  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义已知可发送正确的 X-Forwarded-* Header 的可信IP地址块</span><br><span class="line"># 来自信任的IP的请求使Kong向上游转发了它们的 X-Forwarded-* Header</span><br><span class="line"># 不受信任的请求使Kong插入它自己的 X-Forwarded-* headers</span><br><span class="line"># 此属性还在Nginx配置中配置 set_real_ip_from 指令。它接受相同类型的值(CIDR)，以逗号分割的列表</span><br><span class="line"># 要信任所有IP，将值设置为 0.0.0.0/0,::/0</span><br><span class="line"># 如果指定为 unix:，则所有 UNIX-domain sockets都将被信任</span><br><span class="line">trusted_ips =    #default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义请求头字段，其值将用于替换客户端地址</span><br><span class="line"># 此值设置Nginx配置中同名的 ngx_http_realip_module 指令</span><br><span class="line"># 如果此值接收 proxy_protocol</span><br><span class="line">#  - 至少有一个 proxy_listen 条目必须启用 proxy_protocol 标志</span><br><span class="line">#  - proxy_ptotocol 参数将附加到Nginx模板的 listen 指令</span><br><span class="line">real_ip_header = X-Real-IP  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 此值设置Nginx配置中同名的ngx_http_realip_module指令</span><br><span class="line">real_ip_recursive = off  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义由Kong代理的请求所运行的最大请求主体大小，在Content-Length请求头中指定。如果请求超过此限制，Kong将响应413（Request Entity Too Large）</span><br><span class="line"># 将此值设置为0禁用检查请求主体大小</span><br><span class="line">client_max_body_size = 0    #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义用于读取请求正文的缓冲区大小。如果客户端请求正文（request body）大于此值，则正文（body）将被缓冲到磁盘</span><br><span class="line"># 请注意，当主体缓冲到磁盘时，访问或操作请求主体可能无法正常工作，因此建议将此值设置得尽可能高。（例如，将其设置为与client_max_body_size一样，以强制保留请求主体在内存中）</span><br><span class="line"># 请注意，高并发环境将需要大量内存分配来处理许多并发的大型请求</span><br><span class="line">client_body_buffer_size = 8k  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 缺少Request Accept Header且Nginx返回请求错误时要使用的默认MIME类型</span><br><span class="line"># 接受的值有： text/plain, text/html, application/json, application/xml</span><br><span class="line">error_default_type = text/plain  #default</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h4><p>Kong把所有数据（如路由、服务、消费者、插件…）存储在Cassandra或PostgreSQL中，并且属于同一集群的所有Kong节点必须将它们自己连接到同一个数据库。</p>
<p>Kong支持的版本:</p>
<ul>
<li>PostgreSQL v9.5+</li>
<li>Cassandra v2.2+</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># DATASTORE</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 确定使用哪种存储</span><br><span class="line"># 接受的值有：postgres、cassandra、off</span><br><span class="line">database = postgres  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Postgres settings</span><br><span class="line">pg_host</span><br><span class="line">pg_port</span><br><span class="line">pg_timeout</span><br><span class="line">pg_user</span><br><span class="line">pg_password</span><br><span class="line">pg_database</span><br><span class="line">pg_schema</span><br><span class="line">pg_ssl</span><br><span class="line">pg_ssl_verify</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Cassandra settings</span><br><span class="line">cassandra_contact_points</span><br><span class="line">cassandra_port</span><br><span class="line">cassandra_keyspace</span><br><span class="line">cassandra_consistency</span><br><span class="line">cassandra_timeout</span><br><span class="line">cassandra_ssl</span><br><span class="line">cassandra_ssl_verify</span><br><span class="line">cassandra_username</span><br><span class="line">cassandra_password</span><br><span class="line">cassandra_lb_policy</span><br><span class="line">cassandra_local_datacenter</span><br><span class="line">cassandra_repl_strategy</span><br><span class="line">cassandra_repl_factor</span><br><span class="line">cassandra_data_centers</span><br><span class="line">cassandra_schema_consensus_timeout</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="Datastore-Cache"><a href="#Datastore-Cache" class="headerlink" title="Datastore Cache"></a>Datastore Cache</h4><p>为了避免与数据存储进行不必要的通信，Kong可将实体缓存一段可配置的时间。如果更新了这样的实体，它还会处理失效。<br>本节允许配置Kong关于此类配置实体的缓存的行为。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># DATASTORE CACHE</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 使用数据存储检查更新实体的频率（单位s）</span><br><span class="line"># 当节点通过Admin API创建，更新或删除实体时，其他节点需要等待下一轮询（由此值配置）以最终清除旧的缓存实体并开始使用新的实体</span><br><span class="line">db_update_frequency = 5  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 数据存储中的实体传播到另一个数据中心的副本节点所用的时间（单位s）</span><br><span class="line"># 单数据中心或单节点没有这样的问题，可安全地设置为0</span><br><span class="line">db_update_propagation = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 此节点缓存时实体从数据存储区的ttl（单位s）</span><br><span class="line"># 如果设置为0，则永不过期</span><br><span class="line">db_cache_ttl = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 数据存储区中的陈旧实体在无法刷新是的时间。当此TTL到期时，将进行刷新陈旧实体的新尝试</span><br><span class="line">db_resurrect_ttl = 30</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="DNS-Resolver"><a href="#DNS-Resolver" class="headerlink" title="DNS Resolver"></a>DNS Resolver</h4><p>默认情况下，DNS解析器将使用标准配置文件<code>/etc/hosts</code>和<code>/etc/resolv.conf</code>。如果已设置环境变量<code>LOCALDOMAIN</code>和<code>RES_OPTIONS</code>，则后一个文件的设置将被覆盖。</p>
<p>Kong会将主机名解析为<code>SRV</code>或<code>A</code>记录。如果名称被解析为SRV记录，它还将通过从DNS服务器接收的端口字段内容覆盖任何给定的端口号。</p>
<p>在ttl的持续时间内，内部DNS解析器将对通过DNS记录中的条目获得的每个请求进行负载均衡。对于SRV记录，权重（weight）字段将被接受，但它将仅使用记录中的最低优先级（priority）字段条目。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># DNS RESOLVER</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 以逗号分隔的nameserver列表，每个条目都采用 ip[:port] 的格式供Kong使用。如果省略，端口默认为53。它接受IPv4和IPv6地址</span><br><span class="line"># 如果未指定，将使用本地 resolv.conf 文件的配置</span><br><span class="line">dns_resolver =  #default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 要使用的hosts文件。此文件只读一次便加载为静态内存内容</span><br><span class="line"># 要在修改后再次读取文件，必须重新加载Kong</span><br><span class="line">dns_hostsfile = /etc/hosts  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 解析不同记录类型的顺序</span><br><span class="line">dns_order = LAST,SRV,A,CNAME  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 默认情况下，使用响应的TTL值缓存DNS记录。如果此属性收到一个值（以秒为单位），它将覆盖所有记录的TTL</span><br><span class="line">dns_valid_ttl =  #default: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 定义记录在缓存中保留的时间长度</span><br><span class="line">dns_stale_ttl = 4  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 空DNS响应和名称错误响应的TTL</span><br><span class="line">dns_not_found_ttl = 30  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 错误响应的TTL</span><br><span class="line">dns_error_ttl = 1  #default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 如果启用，则在缓存未命中时，每个请求都将触发其自己的dns查询</span><br><span class="line"># 禁用时，同一名称/类型的多个请求将同步到单个查询</span><br><span class="line">dns_no_sync = off</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="Development"><a href="#Development" class="headerlink" title="Development"></a>Development</h4><p>从<code>lua-nginx-module</code>继承的其他设置允许更多的灵活性和高级用法。</p>
<p><br><br><br></p>
<h4 id="Additional"><a href="#Additional" class="headerlink" title="Additional"></a>Additional</h4><ul>
<li><strong>origin</strong></li>
</ul>
<p><strong>Origin Configuration</strong>在复杂的网络配置中非常有用，并且在Kong用于<strong>服务网格（Service Mesh）</strong>通常是必需的。</p>
<p><code>origins</code>是一个以逗号分隔的成对的对象列表，每对使用<code>=</code>。每对左侧的原（origin）被右侧的原(origin)覆盖。此覆盖发生在访问阶段之后和上游解析之前。它具有导致Kong将流向左侧origin的流量发送到右侧origin的效果。</p>
<p>术语 <code>origin</code> 是指特定 scheme/host或ip/port，如RFC 6454中所描述。在Kong的origin配置中，该方案必须是<code>http</code>, <code>https</code>, <code>tcp</code>, <code>tls</code>。在每对origin中，必须匹配。如http可与https配对，tcp可与tls配对，但http不能与tcp配对。</p>
<p>When an encrypted scheme like <code>tls</code> or <code>https</code> in the left origin is paired with an unencrypted scheme like <code>tcp</code> or <code>http</code> in the right origin, Kong will terminate TLS on incoming connections matching the left origin, and will then route traffic unencrypted to the specified right origin. This is useful when connections will be made to the Kong node over TLS, but the local service (for which Kong is proxying traffic) doesn’t or can’t terminate TLS. Similarly, if the left origin is <code>tcp</code> or <code>http</code> and the right origin is <code>tls</code> or https, Kong will accept unencrypted incoming traffic, and will then wrap that traffic in TLS as it is routed outbound. This capability is an important enabler of Kong Mesh.</p>
<p>与所有Kong配置设置一样，可在<code>kong.conf</code>文件中声明origin设置。但是，建议Kong管理员不要这么做。相反，应该使用环境变量在每个节点上设置origin。因此，默认的<code>kong.conf.default</code>中不存在origin。</p>
<p><br></p>
<p>栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 如果给定的Kong节点具有以下origin的配置</span><br><span class="line">http://upstream-foo-bar:1234=http://localhost:5678</span><br><span class="line"># Kong节点不会尝试解析upstream-foo-bar，而是将该节点路由到localhost:5678</span><br><span class="line"># 在Kong的服务网格部署中，这种覆盖是必要的，以使邻近 upstream-foo-bar 应用程序的实例 Kong sidecar 将流量路由到本地实例，而不是试图将流量通过网络路由回到 upstream-foo-bar 的非本地实例</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在另一个典型的sidecar部署中，Kong节点作为Kong代理服务的一个实例，origin将配置为</span><br><span class="line">https://service-b:9876=http://localhost:5432</span><br><span class="line"># 这将导致Kong节点仅接受端口9876上的https连接，终止tls，然后将现在未加密的流量转发到localhost:5432</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 下面这个栗子由两对组成，由逗号分隔</span><br><span class="line">https://foo.bar.com:443=http://localhost:80,tls://dog.cat.org:9999=tcp://localhost:8888</span><br><span class="line"># 这将导致Kong仅接受端口443上的https流量，并仅接受 端口9999的TLS流量，在两种情况下都终止TLS，然后分别将流量转发到localhost:80和localhost:8888</span><br><span class="line"># 假设80和8888都与单独的服务相关，当Kong充当节点代理是，可能会发生这种配置，这是一个代表多个服务的本地代理</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h2><p><a href="https://docs.konghq.com/1.1.x/cli/" target="_blank" rel="noopener">CLI Reference</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Global flags</span></span><br><span class="line">--<span class="built_in">help</span>: <span class="built_in">print</span> the <span class="built_in">command</span>’s <span class="built_in">help</span> message</span><br><span class="line">--v: <span class="built_in">enable</span> verbose mode</span><br><span class="line">--vv: <span class="built_in">enable</span> debug mode (noisy)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kong --<span class="built_in">help</span></span><br><span class="line">No such <span class="built_in">command</span>: --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage: kong COMMAND [OPTIONS]</span><br><span class="line"></span><br><span class="line">The available commands are:</span><br><span class="line"> check</span><br><span class="line"> config</span><br><span class="line"> health</span><br><span class="line"> migrations</span><br><span class="line"> prepare</span><br><span class="line"> quit</span><br><span class="line"> reload</span><br><span class="line"> restart</span><br><span class="line"> roar</span><br><span class="line"> start</span><br><span class="line"> stop</span><br><span class="line"> version</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> --v              verbose</span><br><span class="line"> --vv             debug</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><p><a href="https://docs.konghq.com/1.1.x/proxy/" target="_blank" rel="noopener">Proxy Reference</a></p>
<p>本章我们将通过详细解释其路由功能(routing capabilities)和内部工作来涵盖Kong的代理功能(proxying capabilities)。</p>
<p>Kong公开了几个可以通过两个配置属性调整的接口:</p>
<ul>
<li><code>proxy_listen</code>，默认是<code>8000</code>，接受来自客户端的公共流量(public traffic)并将其代理带上游服务；</li>
<li><code>admin_listen</code>，默认<code>8001</code>，Admin API被限制为仅由管理员访问。</li>
</ul>
<p><br><br><br></p>
<h3 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h3><p>Terminology：</p>
<ul>
<li><code>client</code>，向Kong代理端口发出请求的下游客户端；</li>
<li><code>upstream service</code>，位于Kong后面的API/Service，转发客户端请求到此；</li>
<li><code>Service</code>，服务实体是每个上游服务的抽象；</li>
<li><code>Route</code>，Kong路由实体。路由是进入Kong的入口点(entrypoints)，并定义要匹配的请求的规则，并路由到给定的服务；</li>
<li><code>Plugin</code>，Kong插件。它们是在代理生命周期中运行的业务逻辑。可通过Admin API配置全局/特定路由和服务的插件。</li>
</ul>
<p><br><br><br></p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>从高层次的角度来看，Kong在其配置的代理和端口上监听HTTP流量(<code>8000/8443</code>)。Kong将根据你配置的路由评估任何传入的HTTP请求，并尝试查找匹配的路由。如果给定的请求与特定路由的规则匹配，Kong将处理代理请求。由于每个路由都链接(link)到一个服务，因此Kong将运行你在路由及相关服务上配置的插件，然后代理请求到上游。</p>
<p>你可以通过Kong Admin API管理路由。路由的<code>hosts, pahts, methods</code>属性定义用于匹配传入HTTP请求的规则。</p>
<p>如果Kong收到的请求无法与任何已配置的路由匹配（或没有配置路由），它将返回；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Server: kong/&lt;x.x.x&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;message&quot;: &quot;no route and no Service found with those values&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="如何配置服务"><a href="#如何配置服务" class="headerlink" title="如何配置服务"></a>如何配置服务</h3><p>How to configure a Service</p>
<p>在快速开始指南里面介绍了如何通过Admin API配置Kong。<br>通过向Admin API发送HTTP请求来向Kong添加服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://localhost:8001/services/ \</span><br><span class="line">    -d <span class="string">'name=foo-service'</span> \</span><br><span class="line">    -d <span class="string">'url=http://foo-service.com'</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"connect_timeout"</span>: 60000,</span><br><span class="line">    <span class="string">"created_at"</span>: 1515537771,</span><br><span class="line">    <span class="string">"host"</span>: <span class="string">"foo-service.com"</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"d54da06c-d69f-4910-8896-915c63c270cd"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"foo-service"</span>,</span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="string">"port"</span>: 80,</span><br><span class="line">    <span class="string">"protocol"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="string">"read_timeout"</span>: 60000,</span><br><span class="line">    <span class="string">"retries"</span>: 5,</span><br><span class="line">    <span class="string">"updated_at"</span>: 1515537771,</span><br><span class="line">    <span class="string">"write_timeout"</span>: 60000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该请求指示Kong注册一个名为<code>foo-service</code>的服务，该服务指向<code>http://foo-service.com</code>（上游）。<br><code>url</code>参数是一个简写的参数，用于一次填充<code>protocol, host, prot, path</code>属性。</p>
<p><br></p>
<p>现在，为了通过Kong向这个服务发送流量，我们需要指定一个路由，它作为Kong的入口点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://localhost:8001/routes/ \</span><br><span class="line">    -d <span class="string">'hosts[]=example.com'</span> \</span><br><span class="line">    -d <span class="string">'paths[]=/foo'</span> \</span><br><span class="line">    -d <span class="string">'service.id=d54da06c-d69f-4910-8896-915c63c270cd'</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"created_at"</span>: 1515539858,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">        <span class="string">"example.com"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"ee794195-6783-4056-a5cc-a7e0fde88c81"</span>,</span><br><span class="line">    <span class="string">"methods"</span>: null,</span><br><span class="line">    <span class="string">"paths"</span>: [</span><br><span class="line">        <span class="string">"/foo"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"preserve_host"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"priority"</span>: 0,</span><br><span class="line">    <span class="string">"protocols"</span>: [</span><br><span class="line">        <span class="string">"http"</span>,</span><br><span class="line">        <span class="string">"https"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"service"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="string">"d54da06c-d69f-4910-8896-915c63c270cd"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"strip_path"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"updated_at"</span>: 1515539858</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在已经配置了一个路由来匹配与给定<code>hosts</code>和<code>path</code>匹配的传入请求，并将它们转发到我们配置的<code>foo-service</code>服务，从而将此流量代理到<code>http://foo-service.com</code>。</p>
<p>Kong是一个透明的代理，它默认情况下会原封不同的(untouched)将请求转发给上游服务，但HTTP规范要求使用各种表头(Header)（如<code>Connection, Date ...</code>）</p>
<p><br><br><br></p>
<h3 id="路由和匹配"><a href="#路由和匹配" class="headerlink" title="路由和匹配"></a>路由和匹配</h3><p>Routes and matching capabilities</p>
<p>现在让我们讨论Kong如何匹配针对路由的已配置的<code>hosts, paths, methods</code>属性的请求。请注意，所有这三个字段都是可选的，但必须指定其中一个。</p>
<p>对于匹配路由的请求：</p>
<ul>
<li>请求必须包含所有已配置的字段；</li>
<li>请求中的字段值至少与其中一个配置值匹配（当字段配置接受一个或多个值时，请求只需其中一个值被视为匹配）。</li>
</ul>
<p><br></p>
<p>举个栗子。考虑如下配置的路由：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"hosts"</span>: [<span class="string">"example.com"</span>, <span class="string">"foo-service.com"</span>],</span><br><span class="line">    <span class="attr">"paths"</span>: [<span class="string">"/foo"</span>, <span class="string">"/bar"</span>],</span><br><span class="line">    <span class="attr">"methods"</span>: [<span class="string">"GET"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与此路由匹配的一些可能的请求如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /foo HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /bar HTTP/1.1</span><br><span class="line">Host: foo-service.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /foo/hello/world HTTP/1.1</span><br><span class="line">Host: example.com</span><br></pre></td></tr></table></figure>
<p>所有这三个请求都满足路径定义中设置的所有条件。</p>
<p>但是，以下请求与配置的路由条件不匹配：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># path不匹配</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># method不匹配</span><br><span class="line">POST /foo HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># host不匹配</span><br><span class="line">GET /foo HTTP/1.1</span><br><span class="line">Host: foo.com</span><br></pre></td></tr></table></figure>
<p>现在我们了解了<code>hosts, pahts, mehtods</code>属性如何协作工作，让我们分别探索每个属性。</p>
<p><br><br><br></p>
<h4 id="请求主机头"><a href="#请求主机头" class="headerlink" title="请求主机头"></a>请求主机头</h4><p>Request Host header</p>
<p>基于其Host Header路由请求是通过Kong代理流量的最直接的方式，尤其是因为这是HTTP Host Header的预期用途。Kong可以通过路由实体的<code>hosts</code>字段轻松完成。</p>
<p><code>hosts</code>接受多个值，在通过Admin API指定它们时必须以逗号分隔。这些值很容易在JSON有效负载中表示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://localhost:8001/routes/ \</span><br><span class="line">    -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">    -d <span class="string">'&#123;"hosts":["example.com", "foo-service.com"]&#125;'</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>由于Admin API还支持<strong>form-urlencoded</strong>内容类型，因此还可通过<code>[]</code>表示法指定数组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://localhost:8001/routes/ \</span><br><span class="line">    -d <span class="string">'hosts[]=example.com'</span> \</span><br><span class="line">    -d <span class="string">'hosts[]=foo-service.com'</span></span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>要满足此路由的<code>hosts</code>条件，来自客户端的任何传入请求现在必须将Host Header设置为两者之一：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Host:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Host:</span> <span class="string">foo-service.com</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h5 id="使用通配符主机名"><a href="#使用通配符主机名" class="headerlink" title="使用通配符主机名"></a>使用通配符主机名</h5><p>Using wildcard hostnames</p>
<p>为了提供灵活性，Kong允许你在<code>hosts</code>字段中指定带通配符的主机名。通配符主机名允许任何匹配的Host Header满足条件，从而匹配给定的路由。</p>
<p>通配符主机名必须在域的最左侧或最右侧标签中仅包含一个星号(<code>*</code>)：</p>
<ul>
<li><code>*.example.com</code><ul>
<li><code>a.example.com</code></li>
<li><code>x.y.z.example.com</code></li>
<li>…</li>
</ul>
</li>
<li><code>example.*</code><ul>
<li><code>example.com</code></li>
<li><code>example.org</code></li>
<li>…</li>
</ul>
</li>
</ul>
<p><br></p>
<p>栗子:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"hosts"</span>: [<span class="string">"*.example.com"</span>, <span class="string">"service.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>匹配的路由栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: an.example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: service.com</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h5 id="preserve-host属性"><a href="#preserve-host属性" class="headerlink" title="preserve_host属性"></a><code>preserve_host</code>属性</h5><p>代理时，Kong的默认行为是将上游请求的Host Header设置为服务<code>host</code>中指定的主机名。<code>preserve_host</code>字段接受一个布尔标志，指示Kong不要这样做。</p>
<p>例如，当<code>preserve_host</code>属性未更改且路由配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"hosts"</span>: [<span class="string">"service.com"</span>],</span><br><span class="line">    <span class="attr">"service"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"..."</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端对Kong的可能请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: service.com</span><br></pre></td></tr></table></figure>
<p>Kong从服务的<code>host</code>属性中提取Host Header，并将发送以下上游请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: &lt;my-service-host.com&gt;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>但是，通过使用<code>preserve_host=true</code>显式配置路由：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"hosts"</span>: [<span class="string">"service.com"</span>],</span><br><span class="line">    <span class="attr">"preserve_host"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"service"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"..."</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设来自客户端的相同请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: service.com</span><br></pre></td></tr></table></figure>
<p>Kong将根据客户端请求保留Host，并将发送以下上游请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: service.com</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="请求路径"><a href="#请求路径" class="headerlink" title="请求路径"></a>请求路径</h4><p>Request path</p>
<p>路由匹配的另一种方式是通过请求路径。要满足此路由条件，客户端请求的路径必须以<code>paths</code>属性的值之一为前缀。</p>
<p>例如，如下路由配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"paths"</span>: [<span class="string">"/service"</span>, <span class="string">"/hello/world"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下请求将匹配：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /service HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /service/resource?param=value HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /hello/world/resource HTTP/1.1</span><br><span class="line">Host: anything.com</span><br></pre></td></tr></table></figure>
<p>对于每一个请求，Kong检测其以路由的路径配置为前缀之一的URL path。默认情况下，Kong会在不更改URL path的情况下代理上游请求。<br>使用路径前缀进行代理时，首先评估最长路径(longest paths)。这允许你定力具有两个路径的两个路由：<code>/service</code>, <code>/service/resource</code>，并确保前者不会遮蔽(shadow)后者。</p>
<p><br><br><br></p>
<h5 id="在路径中使用正则"><a href="#在路径中使用正则" class="headerlink" title="在路径中使用正则"></a>在路径中使用正则</h5><p>Using regexes in paths</p>
<p>Kong通过PCRE(Perl Compatible Regular Expression)支持路由的路径字段的正则表达式模式匹配。你可以同时将路径作为前缀和正则表达式分配给路由。</p>
<p>例如，考虑如下路由：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"paths"</span>: [<span class="string">"/users/\d+/profile"</span>, <span class="string">"/following"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此路由匹配以下请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /following HTTP/1.1</span><br><span class="line">Host: ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /users/123/profile HTTP/1.1</span><br><span class="line">Host: ...</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>评估顺序(Evaluation order)</strong></li>
</ul>
<p>如前所述，Kong按长度评估前缀路径：首先评估最长路径。但是，Kong将根据路由的<code>regex_priority</code>属性从最高优先级到最低优先级来评估正则表达式。<br>考虑如下路由：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"paths"</span>: [<span class="string">"/status/\d+"</span>],</span><br><span class="line">        <span class="attr">"regex_priority"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"paths"</span>: [<span class="string">"/version/\d+/status/\d+"</span>],</span><br><span class="line">        <span class="attr">"regex_priority"</span>: <span class="number">6</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"paths"</span>: [<span class="string">"/version"</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"paths"</span>: [<span class="string">"/version/any/"</span>],</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在这种情况下，Kong将按照以下顺序评估对以下定义的URL的传入请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. /version/any/</span><br><span class="line">2. /version</span><br><span class="line">3. /version/\d+/status/\d+</span><br><span class="line">4. /status/\d+</span><br></pre></td></tr></table></figure>
<p>始终在正则表达式之前评估前缀路径。</p>
<p>向往常一样，请求仍然必须匹配路由的<code>hosts</code>和<code>methods</code>属性，并且Kong将遍历你的路由，直到找到匹配最多规则的路由。</p>
<p><br></p>
<ul>
<li><strong>捕获组(Capturing groups)</strong></li>
</ul>
<p>还支持捕获组，并且将从路径中提取匹配的组并可用于插件使用。</p>
<p>考虑如下正则和请求路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/version/(?&lt;version&gt;\d+)/users/(?&lt;user&gt;\S+)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/version/1/users/john</span><br></pre></td></tr></table></figure>
<p>Kong会将请求路径视为匹配，如果匹配整个路由(考虑<code>hosts</code>, <code>methods</code>)，则可从<code>ngx.ctx</code>变量中的插件获取捕获组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">local router_matches = ngx.ctx.router_matches</span><br><span class="line"></span><br><span class="line">-- router_matches.uri_captures is:</span><br><span class="line">-- &#123; &quot;1&quot;, &quot;john&quot;, version = &quot;1&quot;, user = &quot;john&quot; &#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li><strong>转义特殊字符(Escaping special characters)</strong></li>
</ul>
<p>通过Admin API配置具有正则表达式路径的路由时，请务必在必要时对你的有效负载进行URL编码。<br>例如，使用<code>curl</code>并使用<code>application/x-www-form-urlencoded</code>MIME类型：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST http://localhost:8001/routes \</span><br><span class="line">    --data-urlencode 'uris[]=/status/\d+'</span><br><span class="line">HTTP/1.1 201 Created</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>请注意，<code>curl</code>不会自动对你的有效负载进行URL编码，并注意使用<code>--data-urlencode</code>，它可以防止对<code>+</code>字符进行URL编码，并将其解释为Kong的Admin API `` 空间。</p>
<p><br><br><br></p>
<h5 id="strip-path属性"><a href="#strip-path属性" class="headerlink" title="strip_path属性"></a><code>strip_path</code>属性</h5><p>可能需要指定路径前缀以匹配路由，但不将其包括在上游请求中。要这样做，请在路由配置中使用<code>strip_path</code>属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    &quot;paths&quot;: [&quot;/service&quot;],</span><br><span class="line">    &quot;strip_path&quot;: true,</span><br><span class="line">    &quot;service&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &quot;...&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启用此标志会指示Kong在匹配此路由并继续代理服务时，不应在上游请求的URL中包含URL路径的匹配部分。</p>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 例如，以下客户端对上述路由的请求</span><br><span class="line">GET /service/path/to/resource HTTP/1.1</span><br><span class="line">Host: ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 将导致Kong发送以下上游请求</span><br><span class="line">GET /path/to/resource HTTP/1.1</span><br><span class="line">Host: ...</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>同样，如果启用了<code>strip_path</code>的路由上定义了正则表达式，则将剥离整个请求URL匹配序列。例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"paths"</span>: [<span class="string">"/version/\d+/service"</span>],</span><br><span class="line">    <span class="attr">"strip_path"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"service"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"..."</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下HTTP请求与提供的正则表达式路径匹配：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /version/1/service/path/to/resource HTTP/1.1</span><br><span class="line">Host: ...</span><br></pre></td></tr></table></figure>
<p>有Kong代理到上游：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /path/to/resource HTTP/1.1</span><br><span class="line">Host: ...</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h4><p>Request HTTP method</p>
<p><code>methods</code>字段允许根据HTTP方法匹配请求。它接受多个值。其默认值为空（HTTP方法不用于路由）。</p>
<p>以下路由允许通过<code>GET</code>和<code>HEAD</code>进行路由：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"methods"</span>: [<span class="string">"GET"</span>, <span class="string">"HEAD"</span>],</span><br><span class="line">    <span class="attr">"service"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"..."</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的路由符合以下要求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HEAD /resource HTTP/1.1</span><br><span class="line">Host: ...</span><br></pre></td></tr></table></figure>
<p>但它与<code>POST</code>和<code>DELETE</code>请求不匹配。在路由上配置插件时，这允许更多粒度。例如，你可以想象两个执行同一服务的路由：</p>
<ul>
<li>一个具有无限制的未认证的<code>GET</code>请求</li>
<li>另一个仅允许经过身份认证和速率限制的<code>POST</code>请求</li>
</ul>
<p><br><br><br></p>
<h3 id="匹配优先级"><a href="#匹配优先级" class="headerlink" title="匹配优先级"></a>匹配优先级</h3><p>Matching priorities</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Service-Mesh/" rel="tag"># Service Mesh</a>
          
            <a href="/tags/API/" rel="tag"># API</a>
          
            <a href="/tags/APIGateway/" rel="tag"># APIGateway</a>
          
            <a href="/tags/MicroService/" rel="tag"># MicroService</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/28/OSThreeEasyPieces/" rel="next" title="OSTEP">
                <i class="fa fa-chevron-left"></i> OSTEP
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image" src="/images/leslie.jpg" alt="Leslie Zhang">
          
            <p class="site-author-name" itemprop="name">Leslie Zhang</p>
            <p class="site-description motion-element" itemprop="description">那一年我二十一岁，在我一生的黄金时代</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">82</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">133</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:me@zhang21.cn" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#入门"><span class="nav-number">1.</span> <span class="nav-text">入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速开始"><span class="nav-number">1.2.</span> <span class="nav-text">快速开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动Kong"><span class="nav-number">1.2.1.</span> <span class="nav-text">启动Kong</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证Kong"><span class="nav-number">1.2.2.</span> <span class="nav-text">验证Kong</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止和重载"><span class="nav-number">1.2.3.</span> <span class="nav-text">停止和重载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置服务"><span class="nav-number">1.3.</span> <span class="nav-text">配置服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加服务"><span class="nav-number">1.3.1.</span> <span class="nav-text">添加服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为服务添加路由"><span class="nav-number">1.3.2.</span> <span class="nav-text">为服务添加路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#转发请求"><span class="nav-number">1.3.3.</span> <span class="nav-text">转发请求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启用插件"><span class="nav-number">1.4.</span> <span class="nav-text">启用插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置插件"><span class="nav-number">1.4.1.</span> <span class="nav-text">配置插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证插件"><span class="nav-number">1.4.2.</span> <span class="nav-text">验证插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加消费者"><span class="nav-number">1.5.</span> <span class="nav-text">添加消费者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建消费者"><span class="nav-number">1.5.1.</span> <span class="nav-text">创建消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为消费者提供key"><span class="nav-number">1.5.2.</span> <span class="nav-text">为消费者提供key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证消费者凭证"><span class="nav-number">1.5.3.</span> <span class="nav-text">验证消费者凭证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CentOS"><span class="nav-number">2.1.</span> <span class="nav-text">CentOS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker"><span class="nav-number">2.2.</span> <span class="nav-text">Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s"><span class="nav-number">2.3.</span> <span class="nav-text">k8s</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#无数据库和声明性配置"><span class="nav-number">3.</span> <span class="nav-text">无数据库和声明性配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#声明性配置"><span class="nav-number">3.1.</span> <span class="nav-text">声明性配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在无数据库模式配置Kong"><span class="nav-number">3.2.</span> <span class="nav-text">在无数据库模式配置Kong</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建声明性配置文件"><span class="nav-number">3.3.</span> <span class="nav-text">创建声明性配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#声明性配置格式"><span class="nav-number">3.4.</span> <span class="nav-text">声明性配置格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查声明性配置文件"><span class="nav-number">3.5.</span> <span class="nav-text">检查声明性配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加载声明性配置文件"><span class="nav-number">3.6.</span> <span class="nav-text">加载声明性配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在无数据库模式下使用Kong"><span class="nav-number">3.7.</span> <span class="nav-text">在无数据库模式下使用Kong</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#内存缓存要求"><span class="nav-number">3.7.1.</span> <span class="nav-text">内存缓存要求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#只读Admin-API"><span class="nav-number">3.7.2.</span> <span class="nav-text">只读Admin API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插件兼容性"><span class="nav-number">3.7.3.</span> <span class="nav-text">插件兼容性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流和服务网格"><span class="nav-number">4.</span> <span class="nav-text">流和服务网格</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#先决条件"><span class="nav-number">4.1.</span> <span class="nav-text">先决条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#术语和定义"><span class="nav-number">4.2.</span> <span class="nav-text">术语和定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤1：启动服务B"><span class="nav-number">4.3.</span> <span class="nav-text">步骤1：启动服务B</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤2：确保服务A可以连接到服务B"><span class="nav-number">4.4.</span> <span class="nav-text">步骤2：确保服务A可以连接到服务B</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤3：启动Kong控制面板"><span class="nav-number">4.5.</span> <span class="nav-text">步骤3：启动Kong控制面板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤4：启动Kong-A"><span class="nav-number">4.6.</span> <span class="nav-text">步骤4：启动Kong A</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤5：启动Kong-B"><span class="nav-number">4.7.</span> <span class="nav-text">步骤5：启动Kong B</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤6：创建Kong服务和路由"><span class="nav-number">4.8.</span> <span class="nav-text">步骤6：创建Kong服务和路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤7：配置代理规则"><span class="nav-number">4.9.</span> <span class="nav-text">步骤7：配置代理规则</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">5.1.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置加载"><span class="nav-number">5.1.1.</span> <span class="nav-text">配置加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证配置"><span class="nav-number">5.1.2.</span> <span class="nav-text">验证配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境变量"><span class="nav-number">5.1.3.</span> <span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注入Nginx指令"><span class="nav-number">5.1.4.</span> <span class="nav-text">注入Nginx指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注入单个Nginx指令"><span class="nav-number">5.1.4.1.</span> <span class="nav-text">注入单个Nginx指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注入Nginx指令文件"><span class="nav-number">5.1.4.2.</span> <span class="nav-text">注入Nginx指令文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义Nginx模板并嵌入Kong"><span class="nav-number">5.1.5.</span> <span class="nav-text">自定义Nginx模板并嵌入Kong</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义Nginx模板"><span class="nav-number">5.1.5.1.</span> <span class="nav-text">自定义Nginx模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在OpenResty中嵌入Kong"><span class="nav-number">5.1.6.</span> <span class="nav-text">在OpenResty中嵌入Kong</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同时提供来自Kong的Website和API"><span class="nav-number">5.1.7.</span> <span class="nav-text">同时提供来自Kong的Website和API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#属性"><span class="nav-number">5.1.8.</span> <span class="nav-text">属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GENERAL"><span class="nav-number">5.1.8.1.</span> <span class="nav-text">GENERAL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NGINX"><span class="nav-number">5.1.8.2.</span> <span class="nav-text">NGINX</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Database"><span class="nav-number">5.1.8.3.</span> <span class="nav-text">Database</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Datastore-Cache"><span class="nav-number">5.1.8.4.</span> <span class="nav-text">Datastore Cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DNS-Resolver"><span class="nav-number">5.1.8.5.</span> <span class="nav-text">DNS Resolver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Development"><span class="nav-number">5.1.8.6.</span> <span class="nav-text">Development</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Additional"><span class="nav-number">5.1.8.7.</span> <span class="nav-text">Additional</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CLI"><span class="nav-number">5.2.</span> <span class="nav-text">CLI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Proxy"><span class="nav-number">5.3.</span> <span class="nav-text">Proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#术语"><span class="nav-number">5.3.1.</span> <span class="nav-text">术语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">5.3.2.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何配置服务"><span class="nav-number">5.3.3.</span> <span class="nav-text">如何配置服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由和匹配"><span class="nav-number">5.3.4.</span> <span class="nav-text">路由和匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#请求主机头"><span class="nav-number">5.3.4.1.</span> <span class="nav-text">请求主机头</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#使用通配符主机名"><span class="nav-number">5.3.4.1.1.</span> <span class="nav-text">使用通配符主机名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#preserve-host属性"><span class="nav-number">5.3.4.1.2.</span> <span class="nav-text">preserve_host属性</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#请求路径"><span class="nav-number">5.3.4.2.</span> <span class="nav-text">请求路径</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在路径中使用正则"><span class="nav-number">5.3.4.2.1.</span> <span class="nav-text">在路径中使用正则</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#strip-path属性"><span class="nav-number">5.3.4.2.2.</span> <span class="nav-text">strip_path属性</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#请求方法"><span class="nav-number">5.3.4.3.</span> <span class="nav-text">请求方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#匹配优先级"><span class="nav-number">5.3.5.</span> <span class="nav-text">匹配优先级</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leslie Zhang</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 792.9k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2019/05/08/Kong/';
          this.page.identifier = '2019/05/08/Kong/';
          this.page.title = 'Kong';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
