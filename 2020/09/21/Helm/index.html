<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Helm,K8s,DevOps,CNCF,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="参考：  docs: https://docs.helm.sh/ github: https://github.com/helm  环境：  el7x86_64 helm v3.3">
<meta name="keywords" content="Helm,K8s,DevOps,CNCF">
<meta property="og:type" content="article">
<meta property="og:title" content="Helm">
<meta property="og:url" content="https://zhang21.github.io/2020/09/21/Helm/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考：  docs: https://docs.helm.sh/ github: https://github.com/helm  环境：  el7x86_64 helm v3.3">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://zhang21.github.io/images/Helm/Helm_Logo.png">
<meta property="og:updated_time" content="2020-10-12T09:19:44.737Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Helm">
<meta name="twitter:description" content="参考：  docs: https://docs.helm.sh/ github: https://github.com/helm  环境：  el7x86_64 helm v3.3">
<meta name="twitter:image" content="https://zhang21.github.io/images/Helm/Helm_Logo.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2020/09/21/Helm/">





  <title>Helm | 风继续吹</title>
  








  <!-- 爆炸效果 -->
  <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
  <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
  <script type="text/javascript" src="/js/firework.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-bullshift">
          <a href="https://suulnnka.github.io/BullshitGenerator/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-external-link"></i> <br>
            
            狗屁不通生成器
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2020/09/21/Helm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Leslie Zhang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Helm</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-21T15:11:22+08:00">
                2020-09-21
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-10-12T17:19:44+08:00">
                2020-10-12
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/21/Helm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/21/Helm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  19,851
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考：</p>
<ul>
<li>docs: <a href="https://docs.helm.sh/" target="_blank" rel="noopener">https://docs.helm.sh/</a></li>
<li>github: <a href="https://github.com/helm" target="_blank" rel="noopener">https://github.com/helm</a></li>
</ul>
<p>环境：</p>
<ul>
<li>el7x86_64</li>
<li>helm v3.3</li>
</ul>
<p><br><br><br></p>
<a id="more"></a>
<hr>
<p><br><br><br></p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><strong>Helm</strong>是Kubernetes生态系统中的一个软件包管理工具，主要用来管理<strong>Charts</strong>，有点类似于Ubuntu中的apt或CentOS中的yum。由go编写，是Deis公司发起的一个开源工具，有助于简化部署和管理Kubernetes应用。</p>
<p>在Kubernetes中，应用管理是需求最多、挑战最大的领域。Helm项目提供了一个统一软件打包方式，支持版本控制，可以大大简化Kubernetes应用分发与部署中的复杂性。</p>
<p>Helm Chart是用来封装 Kubernetes原生应用程序的一系列YAML文件。可以在你部署应用的时候自定义应用程序的一些 Metadata，以便于应用程序的分发。</p>
<p>对于应用发布者而言，可以通过 Helm 打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。</p>
<p>对于使用者而言，使用 Helm 后不用需要编写复杂的应用部署文件，可以以简单的方式在 Kubernetes 上查找、安装、升级、回滚、卸载应用程序。</p>
<p><br></p>
<p><img src="/images/Helm/Helm_Logo.png" alt></p>
<p><br></p>
<p>The package manager for Kubernetes.</p>
<p>Helm is the best way to find, share, and use software built for Kubernetes.</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><p>Glossary: <a href="https://helm.sh/docs/glossary/" target="_blank" rel="noopener">https://helm.sh/docs/glossary/</a></p>
<p><br></p>
<p><strong>Chart</strong></p>
<p>Helm包涵盖了将k8s资源安装到k8s集群所需的足够多的信息。<br>Charts包含了<code>Chart.yaml</code>文件核模板，默认值(<code>values.yaml</code>)，以及相关依赖。<br>Charts开发设计了良好定义的目录结构，并打包为chart archive。</p>
<p><br></p>
<p><strong>Chart Archive</strong></p>
<p>Chart包是被<code>tar</code>和<code>gzip</code>压缩（可选签名）的chart。</p>
<p><br></p>
<p><strong>Chart Dependency(Subcharts)</strong></p>
<p>Chart可以依赖于其它chart。依赖有两种方式：</p>
<ul>
<li>软依赖(soft): 如果另一个chart没有在集群中安装，chart可能会无法使用</li>
<li>硬依赖(hard): chart包含它所依赖的chart。（在<code>charts/</code>目录中）</li>
</ul>
<p>当一个chart打包(<code>helm package</code>)时，所有的依赖都会和它绑定。</p>
<p><br></p>
<p><strong>Chart Version</strong></p>
<p>每个chart都需要版本号。</p>
<p><br></p>
<p><strong>Chart.yaml</strong></p>
<p>chart的信息说明被存储在一个特定文件(<code>Chart.yaml</code>)。每个chart都必须有这个文件。</p>
<p><br></p>
<p><strong>helm</strong></p>
<p>Helm是k8s包管理器。作为一个操作系统包管理器，使其很容易在操作系统中安装工具。Helm使得k8s集群中安装应用和资源变得异常简单。</p>
<p><br></p>
<p><strong>Helm Configuration Files</strong></p>
<p>Helm将配置文件存储在XDG目录中。<code>helm</code>第一次运行，会自动生成。</p>
<p><strong>Kube Config(KUBECONFIG)</strong></p>
<p>helm客户端通过Kube config配置文件来理解k8s集群。默认<code>$HOME/.kube/config</code>。</p>
<p><br></p>
<p><strong>Lint</strong></p>
<p>Helm代码规范，规范一个chart是去验证其遵照Helm chart的标准规范和要求。Helm提供了<code>helm lint</code>命令。</p>
<p><br></p>
<p><strong>Provenance</strong></p>
<p>Helm chart可以由来源文件(provenance file)提供chart的出处以及它所包含的内容。</p>
<p>来源文件(<code>.prov</code>)是Helm安全的一部分。一个来源包含chart包文件的加密哈希值，<code>Chart.yaml</code>数据，一个签名块。当再加上一个钥匙链(keychain)时，可为chart用户提供以下能力：</p>
<ul>
<li>验证chart被可信第三方签名</li>
<li>验证chart文件没有被篡改</li>
<li>验证chart的元数据内容(<code>Chart.yaml</code>)</li>
<li>快速匹配chart的数据来源</li>
</ul>
<p><br></p>
<p><strong>Release</strong></p>
<p>发行版本。chart安装之后，Helm库会创建一个release来跟踪这个安装。</p>
<p>单个chart可以在同一个集群中安装多次，并能创建多个不同的版本。</p>
<p><br></p>
<p><strong>Release Number/Version</strong></p>
<p>单个版本号可以被升级多次。通过连续技术来跟踪升级发布版本。</p>
<p><br></p>
<p><strong>Rollback</strong></p>
<p>每一次发布会更新chart或者配置。当生成发布历史后，一次发布也可以被 rolled back 之前的发布版本号。回滚使用<code>helm rollback</code>命令。</p>
<p>重要的是, 每一次回滚版本会生成一个新的发布版本号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">操作			版本号</span><br><span class="line">install		release 1</span><br><span class="line">upgrade		release 2</span><br><span class="line">upgrade		release 3</span><br><span class="line">rollback 1	release 4 (但使用release 1的配置)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Helm Library(SDK)</strong></p>
<p>Helm库（或SDK）涉及到go代码，可以直接与k8s API服务交互进行安装、升级、查询 以及移除k8s资源。</p>
<p><br></p>
<p><strong>Repository</strong></p>
<p>Helm chart可以被存储到专用的HTTP服务器上，称之为chart仓库。</p>
<p>Helm客户端可以指向零个或多个chart仓库。默认没有配置仓库，可使用<code>helm repo add</code>添加。</p>
<p><br></p>
<p><strong>Values</strong></p>
<p>Values 提供了一种使用您自己的信息覆盖模板默认值的方式。</p>
<p>Helm Chart是参数化的, 这意味着chart开发者可以在安装时显式配置。比如说，chart可以暴露<code>username</code>字段， 允许为服务设置一个用户名。这些可暴露的变量在Helm用语中称为<code>values</code>。</p>
<p>Values可在<code>helm install</code>, <code>helm upgrage</code>时设置。也可以在<code>values.yaml</code>文件中设置。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Introduction: <a href="https://helm.sh/docs/intro/" target="_blank" rel="noopener">https://helm.sh/docs/intro/</a></p>
<p><br></p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>Quickstart: <a href="https://helm.sh/docs/intro/quickstart/" target="_blank" rel="noopener">https://helm.sh/docs/intro/quickstart/</a></p>
<p>如何快速安装核使用Helm。</p>
<p><br></p>
<h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><p>Prerequisites</p>
<p>使用Helm的前置条件：</p>
<ul>
<li>k8s集群<ul>
<li>建议最新k8s稳定版</li>
<li><code>kubectl</code></li>
</ul>
</li>
<li>安装的安全配置(如果有的话)</li>
<li>安装和配置Helm</li>
</ul>
<p>注意Helm版本对应支持的k8s版本。</p>
<p><br><br><br></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Install: <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener">https://helm.sh/docs/intro/install/</a></p>
<p>从源码、或二进制安装Helm CLI。</p>
<p><br></p>
<h4 id="从Helm项目"><a href="#从Helm项目" class="headerlink" title="从Helm项目"></a>从Helm项目</h4><p>From The Helm Project</p>
<p><br></p>
<p><strong>从二进制包:</strong></p>
<ul>
<li>下载特定版本包: <a href="https://github.com/helm/helm/releases" target="_blank" rel="noopener">https://github.com/helm/helm/releases</a></li>
<li>解压</li>
<li>添加到PATH</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.3.3-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf helm-v3.3.3-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">mv helm /usr/<span class="built_in">local</span>/bin/helm</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>从脚本:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3</span><br><span class="line">chmod 700 get_helm.sh</span><br><span class="line">./get_helm.sh</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="从源码"><a href="#从源码" class="headerlink" title="从源码"></a>从源码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/helm/helm.git</span><br><span class="line"><span class="built_in">cd</span> helm</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="初始化Helm-chart"><a href="#初始化Helm-chart" class="headerlink" title="初始化Helm chart"></a>初始化Helm chart</h3><p>Initialize a Helm Chart Repository</p>
<p>Helm安装好之后，你可以添加一个chart仓库。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加Helm官方仓库</span></span><br><span class="line">helm repo add stable https://kubernetes-charts.storage.googleapis.com/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看安装的charts列表</span></span><br><span class="line">helm search repo stable</span><br><span class="line">NAME                                    CHART VERSION   APP VERSION                     DESCRIPTION</span><br><span class="line">stable/acs-engine-autoscaler            2.2.2           2.1.1                           DEPRECATED Scales worker nodes within agent pools</span><br><span class="line">stable/aerospike                        0.2.8           v4.5.0.5                        A Helm chart <span class="keyword">for</span> Aerospike <span class="keyword">in</span> Kubernetes</span><br><span class="line">stable/airflow                          4.1.0           1.10.4                          Airflow is a platform to programmatically autho...</span><br><span class="line">stable/ambassador                       4.1.0           0.81.0                          A Helm chart <span class="keyword">for</span> Datawire Ambassador</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="安装Chart"><a href="#安装Chart" class="headerlink" title="安装Chart"></a>安装Chart</h3><p>Install an Example Chart</p>
<p>可以通过<code>helm install</code>命令安装chart。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm install，都会创建一个新的release</span></span><br><span class="line"><span class="comment"># 所以一个chart在同一个集群里面可以被安装多次，每一个都可以被独立的管理和升级</span></span><br><span class="line">helm install stable/mysql --generate-name</span><br><span class="line">NAME: mysql-1600679719</span><br><span class="line">LAST DEPLOYED: Mon Sep 21 17:15:23 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">NOTES:</span><br><span class="line">MySQL can be accessed via port 3306 on the following DNS name from within your cluster:</span><br><span class="line">mysql-1600679719.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">To get your root password run:</span><br><span class="line"></span><br><span class="line">    MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default mysql-1600679719 -o jsonpath=<span class="string">"&#123;.data.mysql-root-password&#125;"</span> | base64 --decode; <span class="built_in">echo</span>)</span><br><span class="line"></span><br><span class="line">To connect to your database:</span><br><span class="line"></span><br><span class="line">1. Run an Ubuntu pod that you can use as a client:</span><br><span class="line"></span><br><span class="line">    kubectl run -i --tty ubuntu --image=ubuntu:16.04 --restart=Never -- bash -il</span><br><span class="line"></span><br><span class="line">2. Install the mysql client:</span><br><span class="line"></span><br><span class="line">    $ apt-get update &amp;&amp; apt-get install mysql-client -y</span><br><span class="line"></span><br><span class="line">3. Connect using the mysql cli, <span class="keyword">then</span> provide your password:</span><br><span class="line">    $ mysql -h mysql-1600679719 -p</span><br><span class="line"></span><br><span class="line">To connect to your database directly from outside the K8s cluster:</span><br><span class="line">    MYSQL_HOST=127.0.0.1</span><br><span class="line">    MYSQL_PORT=3306</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Execute the following command to route the connection:</span></span><br><span class="line">    kubectl port-forward svc/mysql-1600679719 3306</span><br><span class="line"></span><br><span class="line">    mysql -h <span class="variable">$&#123;MYSQL_HOST&#125;</span> -P<span class="variable">$&#123;MYSQL_PORT&#125;</span> -u root -p<span class="variable">$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看此chart的基本信息</span></span><br><span class="line">helm show chart stable/mysql</span><br><span class="line">helm show all stable/mysql</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Releases"><a href="#Releases" class="headerlink" title="Releases"></a>Releases</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看chart发行版</span></span><br><span class="line">helm ls</span><br><span class="line">NAME                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span><br><span class="line">mysql-1600679719        default         1               2020-09-21 17:15:23.169811348 +0800 CST deployed        mysql-1.6.7     5.7.30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有部署的发行</span></span><br><span class="line">helm list</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="卸载Release"><a href="#卸载Release" class="headerlink" title="卸载Release"></a>卸载Release</h3><p>使用<code>helm uninstall</code>命令卸载realease。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall mysql-1600679719</span><br><span class="line">release <span class="string">"mysql-1600679719"</span> uninstalled</span><br></pre></td></tr></table></figure>
<p>它会删除和该release相关的所有资源。使用<code>--keep-history</code>选项，Helm将保存release history。所以你可以审计集群历史甚至使用<code>helm rollback</code>回滚release。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h1><p>Topic Guides: <a href="https://helm.sh/docs/topics/" target="_blank" rel="noopener">https://helm.sh/docs/topics/</a></p>
<p><br></p>
<h2 id="Charts"><a href="#Charts" class="headerlink" title="Charts"></a>Charts</h2><p>Charts: <a href="https://helm.sh/docs/topics/charts/" target="_blank" rel="noopener">https://helm.sh/docs/topics/charts/</a></p>
<p>Helm使用的包格式称为charts。chart就是一个描述k8s相关资源的文件集合。单个chart可以用来部署简单或复杂的服务。</p>
<p>Chart是作为特定目录布局的文件被创建，它们可以打包到要部署的版本存档中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 下载一个chart，但不安装</span><br><span class="line">helm pull xxx</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p>chart是一个组织在文件目录中的集合。目录名称就是chart名称(没有版本信息)。</p>
<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wordpress/</span><br><span class="line">  Chart.yaml          # 包含了chart信息的YAML文件</span><br><span class="line">  LICENSE             # 可选: 包含chart许可证的纯文本文件</span><br><span class="line">  README.md           # 可选: 可读的README文件</span><br><span class="line">  values.yaml         # chart 默认的配置值</span><br><span class="line">  values.schema.json  # 可选: 一个使用JSON结构的values.yaml文件</span><br><span class="line">  charts/             # 包含chart依赖的其他chart</span><br><span class="line">  crds/               # 自定义资源的定义</span><br><span class="line">  templates/          # 模板目录， 当和values 结合时，可生成有效的Kubernetes manifest文件</span><br><span class="line">  templates/NOTES.txt # 可选: 包含简要使用说明的纯文本文件</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h3><p><code>Chart.yaml</code>文件是chart必须的。包含以下字段。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">chart</span> <span class="string">API</span> <span class="string">版本</span> <span class="string">（必需）</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">chart名称</span> <span class="string">（必需）</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">语义化2</span> <span class="string">版本（必需）</span></span><br><span class="line"><span class="attr">kubeVersion:</span> <span class="string">兼容Kubernetes版本的语义化版本（可选）</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">一句话对这个项目的描述（可选）</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">chart类型</span> <span class="string">（可选）</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">关于项目的一组关键字（可选）</span></span><br><span class="line"><span class="attr">home:</span> <span class="string">项目home页面的URL</span> <span class="string">（可选）</span></span><br><span class="line"><span class="attr">sources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">项目源码的URL列表（可选）</span></span><br><span class="line"><span class="attr">dependencies:</span> <span class="comment"># chart 必要条件列表 （可选）</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">chart名称</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">    version:</span> <span class="string">chart版本</span> <span class="string">("1.2.3")</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">仓库URL</span> <span class="string">("https://example.com/charts")</span> <span class="string">或别名</span> <span class="string">("@repo-name")</span></span><br><span class="line"><span class="attr">    condition:</span> <span class="string">（可选）</span> <span class="string">解析为布尔值的yaml路径，用于启用、禁用chart</span> <span class="string">(e.g.</span> <span class="string">subchart1.enabled</span> <span class="string">)</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="comment"># （可选）</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">用于一次启用/禁用</span> <span class="string">一组chart的tag</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="string">（可选）</span> <span class="string">决定是否加载chart的布尔值</span></span><br><span class="line"><span class="attr">    import-values:</span> <span class="comment"># （可选）</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ImportValue</span> <span class="string">保存源值到导入父键的映射。每项可以是字符串或者一对子/父列表项</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">（可选）</span> <span class="string">chart中使用的别名。当你要多次添加相同的chart时会很有用</span></span><br><span class="line"><span class="attr">maintainers:</span> <span class="comment"># （可选）</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">维护者名字</span> <span class="string">（每个维护者都需要）</span></span><br><span class="line"><span class="attr">    email:</span> <span class="string">维护者邮箱</span> <span class="string">（每个维护者可选）</span></span><br><span class="line"><span class="attr">    url:</span> <span class="string">维护者URL</span> <span class="string">（每个维护者可选）</span></span><br><span class="line"><span class="attr">icon:</span> <span class="string">用做icon的SVG或PNG图片URL</span> <span class="string">（可选）</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">包含的应用版本（可选）。不需要是语义化的</span></span><br><span class="line"><span class="attr">deprecated:</span> <span class="string">不被推荐的chart</span> <span class="string">（可选，布尔值）</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line"><span class="attr">  example:</span> <span class="string">按名称输入的批注列表</span> <span class="string">（可选）.</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Chart和版本控制</strong></p>
<p>每个chart都必须有版本号。版本必须遵循SemVer2标准。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># nginx chart的版本字段version: 1.2.3</span><br><span class="line"># 按照名称设置为</span><br><span class="line">nginx-1.2.3.tgz</span><br></pre></td></tr></table></figure>
<p><code>Chart.yaml</code>文件中的<code>version</code>字段被很多Helm工具使用。当生成一个包时，<code>helm package</code>命令可以用<code>Chart.yaml</code>文件中找到的版本号作为包名的token。系统假设chart包名中的版本号可以与<code>Chart.yaml</code>文件中的版本号匹配。如果不满足这一假设会导致错误。</p>
<p><br></p>
<p><strong>apiVersion字段</strong></p>
<p>对于至少需要Helm3的chart，<code>apiVersion</code>字段应该是<code>v2</code>。</p>
<p><br></p>
<p><strong>kubeVersion字段</strong></p>
<p>可选的<code>kubeVersion</code>字段可以在支持的k8s版本上定义语义约束，Helm 在安装chart时会验证这个版本约束， 并在集群运行不支持的k8s版本时显示失败。</p>
<p>版本约束可以包含空格、比较操作符、逻辑操作符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;= 1.13.0 &lt; 1.15.0</span><br><span class="line"></span><br><span class="line">&gt;= 1.13.0 &lt; 1.14.0 || &gt;= 1.14.1 &lt; 1.15.0</span><br><span class="line"></span><br><span class="line">1.1 - 2.3.4</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>deprecated字段</strong></p>
<p>在Chart仓库管理chart时，有时需要废弃一个chart。<code>deprecated</code>字段可用来标记已弃用的chart。如果latest版本被标记为已弃用，则所有的chart都会被认为是已弃用的。以后可以通过发布未标记为已弃用的新版本来重新使用chart名称。</p>
<p><code>kubernetes/charts</code>项目遵循的弃用charts的流程为：</p>
<ul>
<li>升级chart的<code>Chart.yaml</code>文件，将这个文件标记为已弃用，并更改版本</li>
<li>在chart仓库中发布新版的chart</li>
<li>从源仓库中移除这个chart</li>
</ul>
<p><br></p>
<p><strong>type字段</strong></p>
<p><code>type</code>字段定义了chart的类型。有两种类型：</p>
<ul>
<li><code>application</code>：默认类型，是可以完全操作的标准chart。</li>
<li><code>library</code>：不能安装，提供针对chart构建的实用程序和功能。通常不包含任何资源对象。</li>
</ul>
<p>应用类型chart 可以作为库类型chart使用。可以通过将类型设置为<code>library</code>来实现。 然后这个库就被渲染成了一个库类型chart，所有的实用程序和功能都可以使用。所有的资源对象不会被渲染。</p>
<p><br><br><br></p>
<h3 id="许可证和描述"><a href="#许可证和描述" class="headerlink" title="许可证和描述"></a>许可证和描述</h3><p>Chart LICENSE, README and NOTES</p>
<p>Chart也可以包含描述安装、配置和使用的文件，以及chart许可证。</p>
<p>LICENSE是一个包含了chart license的纯文本文件。chart可以包含一个许可证，因为在模板里不只是配置，还可能有编码逻辑。如果需要，还可以为chart安装的应用程序提供单独的许可证。</p>
<p>README自述文件，一般包含：</p>
<ul>
<li>chart提供的应用或服务的描述</li>
<li>运行chart的先决条件或要求</li>
<li><code>values.yaml</code>的可选项和默认值的描述</li>
<li>与chart的安装或配置相关的其它信息</li>
</ul>
<p>chart也会包含一个简短的纯文本<code>templates/NOTES.txt</code>文件，这会在安装后及查看版本状态时打印出来。由于此文件是在运行<code>helm install</code>或<code>helm status</code>时打印到STDOUT的，因此建议保持内容简短，并指向自述文件以获取更多详细信息。</p>
<p><br><br><br></p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>Chart Dependencies</p>
<p>Helm中，chart可能会依赖其它任意个chart。这些依赖可使用<code>dependencies</code>字段(<code>Chart.yaml</code>)动态链接，或写入<code>charts/</code>目录。</p>
<p><br></p>
<p><strong>dependencies字段</strong></p>
<p>当前chart依赖的其它chart会在<code>dependencies</code>字段定义为一个列表。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">1.2</span><span class="number">.3</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="attr">https://example.com/charts</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">3.2</span><span class="number">.1</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="attr">https://another.example.com/charts</span></span><br></pre></td></tr></table></figure>
<p>必须使用<code>helm repo add</code>在本地添加仓库。</p>
<p>一旦你定义好了依赖，运行<code>helm dependency update</code>就会使用你的依赖文件下载所有你指定的chart到你的<code>charts/</code>目录。</p>
<p><br></p>
<p><strong>alias字段</strong></p>
<p>为依赖chart添加一个别名，会使用别名作为新依赖chart的名称。 需要使用其他名称访问chart时可以使用<code>alias</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  - name: subchart</span><br><span class="line">    repository: http://localhost:10191</span><br><span class="line">    version: 0.1.0</span><br><span class="line">    alias: new-subchart-1</span><br><span class="line">  - name: subchart</span><br><span class="line">    repository: http://localhost:10191</span><br><span class="line">    version: 0.1.0</span><br><span class="line">    alias: new-subchart-2</span><br><span class="line">  - name: subchart</span><br><span class="line">    repository: http://localhost:10191</span><br><span class="line">    version: 0.1.0</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>tags和condition字段</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">subchart1</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="attr">http://localhost:10191</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    condition:</span> <span class="string">subchart1.enabled,</span> <span class="string">global.subchart1.enabled</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">front-end</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">subchart1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">subchart2</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="attr">http://localhost:10191</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    condition:</span> <span class="string">subchart2.enabled,global.subchart2.enabled</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">back-end</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">subchart2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">subchart1:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="attr">  front-end:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  back-end:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 可以在CLI使用--set参数来设置标签和条件值</span><br><span class="line">helm install --set tags.front-end=true --set subchart2.enabled=false</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>通过依赖导入sub values</strong></p>
<p>在某些情况下，允许子chart的值作为公共默认传递到父chart中是值得的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parent's Chart.yaml file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">subchart</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="attr">http://localhost:10191</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">    import-values:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">data</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># child's values.yaml file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exports:</span></span><br><span class="line"><span class="attr">  data:</span></span><br><span class="line"><span class="attr">    myint:</span> <span class="number">99</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>通过charts目录手动管理依赖</strong></p>
<p>如果对依赖进行更多控制，通过将有依赖关系的chart复制到<code>charts/</code>目录中来显式表达这些依赖关系。</p>
<p>要将依赖放入<code>charts/</code>目录，使用<code>helm pull</code>命令。</p>
<p><br><br><br></p>
<h3 id="Templates-and-Values"><a href="#Templates-and-Values" class="headerlink" title="Templates and Values"></a>Templates and Values</h3><p>Helm Chart模板是按照<a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener">Go模板语言</a>书写。让我想起了Django模板语言，Jinja2模板语言。</p>
<p>所有模板语言存放在chart的<code>templates/</code>目录下。当Helm渲染chart时，它会通过模板引擎遍历目录中的每个文件。</p>
<p>模板的Value通过两种方式提供：</p>
<ul>
<li>通过<code>values.yaml</code>文件提供，此文件包含了默认值。</li>
<li>用户可以提供一个包含value的yaml文件，在<code>helm install</code>时使用它。</li>
</ul>
<p>当用户提供自定义的value时，会覆盖<code>values.yaml</code>中的值。</p>
<p><br></p>
<p><strong>模板文件示例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: deis-database</span><br><span class="line">  namespace: deis</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/managed-by: deis</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: deis-database</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: deis-database</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccount: deis-database</span><br><span class="line">      containers:</span><br><span class="line">        - name: deis-database</span><br><span class="line">          image: &#123;&#123; .Values.imageRegistry &#125;&#125;/postgres:&#123;&#123; .Values.dockerTag &#125;&#125;</span><br><span class="line">          imagePullPolicy: &#123;&#123; .Values.pullPolicy &#125;&#125;</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 5432</span><br><span class="line">          env:</span><br><span class="line">            - name: DATABASE_STORAGE</span><br><span class="line">              value: &#123;&#123; default &quot;minio&quot; .Values.storage &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>预定义的Values</strong></p>
<p>以下值是预定义的，对每个模板都有效，并且可以被覆盖。和所有值一样，名称 区分大小写：</p>
<ul>
<li><code>Release.Name</code>: 版本名称(非chart的)</li>
<li><code>Release.Namespace</code>: 发布的chart版本的命名空间</li>
<li><code>Release.Service</code>: 组织版本的服务</li>
<li><code>Release.IsUpgrade</code>: 如果当前操作是升级或回滚，设置为true</li>
<li><code>Release.IsInstall</code>: 如果当前操作是安装，设置为true</li>
<li><code>Chart</code>: <code>Chart.yaml</code>的内容。因此，chart的版本可以从<code>Chart.Version</code>获得， 并且维护者在<code>Chart.Maintainers</code>里</li>
<li><code>Files</code>：chart中的包含了非特殊文件的类图对象</li>
<li><code>Capabilities</code>: 包含了Kubernetes版本信息的类图对象</li>
</ul>
<p><br></p>
<p><strong>范围</strong></p>
<p>Scope, Dependencies, and Values</p>
<p>Values文件可以声明顶级chart的值，以及<code>charts/</code>目录中包含的其他任意chart。</p>
<p><br></p>
<p><strong>全局Values</strong></p>
<p>Helm支持特殊的<code>global</code>值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  app:</span> <span class="string">MyWordPress</span></span><br></pre></td></tr></table></figure>
<p>这个值以<code>.Values.global.app</code>在所有chart中有效。</p>
<p><br></p>
<p><strong>架构文件</strong></p>
<p>有时候，chart容器可能想基于它们的values值定义一个结构，这可以在<code>values.schema.json</code>文件中定义一个架构实现。</p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"$schema"</span>: <span class="string">"https://json-schema.org/draft-07/schema#"</span>,</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"image"</span>: &#123;</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"Container Image"</span>,</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"repo"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"tag"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"name"</span>: &#123;</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"Service name"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"port"</span>: &#123;</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"Port"</span>,</span><br><span class="line">      <span class="attr">"minimum"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"protocol"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"required"</span>: [</span><br><span class="line">    <span class="string">"protocol"</span>,</span><br><span class="line">    <span class="string">"port"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Values"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个架构会应用values值并验证它。当执行以下任意命令时会进行验证： <code>helm install, helm upgrage, helm lint, helm template</code>。</p>
<p><br><br><br></p>
<h3 id="用户自定义资源"><a href="#用户自定义资源" class="headerlink" title="用户自定义资源"></a>用户自定义资源</h3><p>Custom Resource Definitions</p>
<p>k8s提供了一种声明k8s新类型对象的机制。使用CustomResourceDefinition（CRD），k8s开发者可以声明自定义资源类型。</p>
<p>Helm3中，CRD被视为一种特殊的对象。它们被安装在chart的其他部分之前，并受到一些限制。</p>
<p>CRD YAML文件应被放置在chart的<code>crds/</code>目录中。 多个CRD(用YAML的开始<code>---</code>和结束符<code>...</code>分隔)可以被放置在同一个文件中。Helm会尝试加载CRD目录中所有的文件到k8s。</p>
<p>当Helm安装新chart时，会上传CRD，暂停安装直到CRD可以被API服务使用，然后启动模板引擎， 渲染chart其他部分，并上传k8s。</p>
<p><br></p>
<p><strong>CRD的限制</strong></p>
<p>不像大部分k8s对象，CRD是全局安装的。因此Helm管理CRD时会采取非常谨慎的方式。 CRD受到以下限制：</p>
<ul>
<li>CRD从不重新安装。 如果Helm确定<code>crds/</code>目录中的CRD已经存在（忽略版本），Helm不会安装或升级。</li>
<li>CRD从不会在升级或回滚时安装。Helm只会在安装时创建CRD。</li>
<li>CRD从不会被删除。自动删除CRD会删除集群中所有命名空间中的所有CRD内容。因此Helm不会删除CRD。</li>
</ul>
<p>希望升级或删除CRD的操作员应该谨慎地手动执行此操作。</p>
<p><br><br><br></p>
<h3 id="管理chart"><a href="#管理chart" class="headerlink" title="管理chart"></a>管理chart</h3><p>Using Helm to Manage Charts</p>
<p><code>helm</code>工具有一些命令用来处理chart。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建新chart</span><br><span class="line">helm create mychart</span><br><span class="line"></span><br><span class="line"># 打包</span><br><span class="line">helm package mychart</span><br><span class="line"></span><br><span class="line"># 格式信息</span><br><span class="line">helm lint mychart</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="仓库"><a href="#仓库" class="headerlink" title="仓库"></a>仓库</h3><p>Chart Repositories</p>
<p>当<code>helm</code>用来管理本地chart目录时， 共享chart时，首选的机制就是使用chart仓库。</p>
<p>仓库的主要特征存在一个名为<code>index.yaml</code>的特殊文件，文件中包含仓库提供的包的完整列表， 以及允许检索和验证这些包的元数据。</p>
<p>在客户端，仓库使用<code>helm repo</code>命令管理。然而，Helm不提供上传chart到远程仓库的工具。 这是因为这样做会给执行服务器增加大量的必要条件，也就增加了设置仓库的障碍。</p>
<p><br><br><br></p>
<h3 id="Starter-Packs"><a href="#Starter-Packs" class="headerlink" title="Starter Packs"></a>Starter Packs</h3><p><code>helm create</code>命令可以附带一个可选的<code>--starter</code>选项指定一个starter chart。Starter就只是普通chart，但是被放置在<code>$XDG_DATA_HOME/helm/starters</code>。</p>
<p><br><br><br></p>
<h2 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h2><p>Chart Hooks: <a href="https://helm.sh/docs/topics/charts_hooks/" target="_blank" rel="noopener">https://helm.sh/docs/topics/charts_hooks/</a></p>
<p>Helm提供了一个hook机制，使chart开发者在发行版(release)生命周期的特定点进行干预。你可以使用hooks做以下事情：</p>
<ul>
<li>安装过程中，在chart载入之前载入configmap或secret。</li>
<li>在安装一个新chart之前，执行一个作业(job)来备份数据库，然后执行第二个作业还原数据库。</li>
<li>在删除一个release之气，运行一个作业，在移除之前，来优雅地取出服务轮询。</li>
</ul>
<p>hooks工作像常规模板，但它们有特殊的注释(写在annotations下)，因此helm可以不同地使用它们。本章节，我们将介绍hooks的基本使用模式。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="string">"helm.sh/hook"</span><span class="string">:</span> <span class="string">post-install</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="可用的hooks"><a href="#可用的hooks" class="headerlink" title="可用的hooks"></a>可用的hooks</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pre-install</code></td>
<td>-</td>
<td>模板渲染之后执行，但在k8s创建任何资源之前</td>
</tr>
<tr>
<td><code>post-install</code></td>
<td>-</td>
<td>所有资源载入k8s后执行</td>
</tr>
<tr>
<td><code>pre-delete</code></td>
<td>-</td>
<td>在从k8s删除任意资源前，执行一个删除请求</td>
</tr>
<tr>
<td><code>post-delete</code></td>
<td>-</td>
<td>在所有release的资源被删除后，执行一个删除请求</td>
</tr>
<tr>
<td><code>pre-upgrade</code></td>
<td>-</td>
<td>在模板渲染后，执行一个升级请求，但在任意资源升级之前</td>
</tr>
<tr>
<td><code>post-upgrade</code></td>
<td>-</td>
<td>在所有资源都升级后，执行一个升级</td>
</tr>
<tr>
<td><code>pre-rollback</code></td>
<td>-</td>
<td>在模板渲染后，执行一个回滚请求，但在任意资源回滚前</td>
</tr>
<tr>
<td><code>post-rollback</code></td>
<td>-</td>
<td>在所有资源都被修改后，执行一个回滚请求</td>
</tr>
<tr>
<td><code>test</code></td>
<td>-</td>
<td>当heml test子命令调用时执行</td>
</tr>
</tbody>
</table>
</div>
<p><br><br><br></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>Chart Tests: <a href="https://helm.sh/docs/topics/chart_tests/" target="_blank" rel="noopener">https://helm.sh/docs/topics/chart_tests/</a></p>
<p>chart包含许多k8s资源和协同工作的组件。作为包作者，你可能想编写一个测试，来验证包安装时是否如预期那样工作。</p>
<p>helm chart中的测试位于<code>templates/</code>目录下，是一个作业(job)定义，指定一个容器运行特定的命令。容器成功退出(exit 0)，被认为测试成功。作业定义必须包含<code>helm.sh/hook: test</code>的注释。</p>
<p>示例测试：</p>
<ul>
<li>验证<code>values.yaml</code>文件被正确配置</li>
<li>验证服务、负载均衡正常</li>
<li>等等</li>
</ul>
<p>可在helm中运行预定义测试，在release上使用<code>helm test &lt;RELEASE_NAME&gt;</code>命令。对于包的使用者，这是一个检测release of chart工作正常的方式。</p>
<p><br></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>Example Test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm pull bitnami/wordpress --untar</span><br><span class="line"></span><br><span class="line">wordpress/</span><br><span class="line">  Chart.yaml</span><br><span class="line">  README.md</span><br><span class="line">  values.yaml</span><br><span class="line">  charts/</span><br><span class="line">  templates/</span><br><span class="line">  templates/tests/test-mariadb-connection.yaml</span><br></pre></td></tr></table></figure>
<p><code>templates/tests/test-mariadb-connection.yaml</code>的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">.Values.mariadb.enabled</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">"<span class="template-variable">&#123;&#123; .Release.Name &#125;&#125;</span>-credentials-test"</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">"helm.sh/hook"</span><span class="string">:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-credentials-test</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"wordpress.image"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.image.pullPolicy</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string">      <span class="template-variable">&#123;&#123;- if .Values.securityContext.enabled &#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        runAsUser:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.securityContext.runAsUser</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MARIADB_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mariadb.fullname"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MARIADB_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"3306"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">WORDPRESS_DATABASE_NAME</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">&#123;&#123;</span> <span class="string">default</span> <span class="string">""</span> <span class="string">.Values.mariadb.db.name</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">        - name:</span> <span class="string">WORDPRESS_DATABASE_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">&#123;&#123;</span> <span class="string">default</span> <span class="string">""</span> <span class="string">.Values.mariadb.db.user</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">        - name:</span> <span class="string">WORDPRESS_DATABASE_PASSWORD</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            secretKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mariadb.fullname"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">mariadb-password</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/bin/bash</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-ec</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mysql --host=$MARIADB_HOST --port=$MARIADB_PORT --user=$WORDPRESS_DATABASE_USER --password=$WORDPRESS_DATABASE_PASSWORD</span></span><br><span class="line"><span class="string"></span><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>运行测试:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm install quirky-walrus wordpress --namespace default</span><br><span class="line"></span><br><span class="line">helm <span class="built_in">test</span> quirky-walrus</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>注意：</strong></p>
<ul>
<li>你可以在<code>templates/</code>目录下定义许多测试</li>
<li>你可以嵌套你的测试<code>&lt;chart-name&gt;/templates/tests/</code></li>
<li>一个测试就是一个helm hook</li>
</ul>
<p><br><br><br></p>
<h2 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h2><p>Library Charts: <a href="https://helm.sh/docs/topics/library_charts/" target="_blank" rel="noopener">https://helm.sh/docs/topics/library_charts/</a></p>
<p>A library chart is a type of Helm chart，定义chart可通过helm模板在其它charts中共享。</p>
<p><br><br><br></p>
<h2 id="完整性校验"><a href="#完整性校验" class="headerlink" title="完整性校验"></a>完整性校验</h2><p>Helm Provenance and Integrity: <a href="https://helm.sh/docs/topics/provenance/" target="_blank" rel="noopener">https://helm.sh/docs/topics/provenance/</a></p>
<p>helm有来源工具，帮助chart user验证包的来源和完整性。使用基于行业标准的PIK, GnuPG等备受推崇的包管理器，Helm 可以生成和验证签名文件。</p>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 生成</span><br><span class="line">helm package --sign ...</span><br><span class="line">helm package --sign --key &apos;John Smith&apos; --keyring path/to/keyring.secret mychart</span><br><span class="line"></span><br><span class="line"># 校验</span><br><span class="line">helm install --verify</span><br><span class="line">helm verify mychart-0.1.0.tgz</span><br><span class="line">helm install --generate-name --verify mychart-0.1.0.tgz</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="仓库-1"><a href="#仓库-1" class="headerlink" title="仓库"></a>仓库</h2><p>Chart Repository: <a href="https://helm.sh/docs/topics/chart_repository/" target="_blank" rel="noopener">https://helm.sh/docs/topics/chart_repository/</a></p>
<p>官方的chart repo由<a href="https://github.com/helm/charts" target="_blank" rel="noopener">Kubernetes Charts</a>项目维护。欢迎各位参与。Helm也使得创建和运行自己的chart repo变得很容易。</p>
<p><br></p>
<h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3><p>Create a chart repository: <a href="https://helm.sh/docs/topics/chart_repository/" target="_blank" rel="noopener">https://helm.sh/docs/topics/chart_repository/</a></p>
<p>一个chart repo是一个HTTP服务器，它容纳了一个<code>index.yaml</code>文件和一些包。当你准备好分享你的charts，方法是将它们上传到一个chart repository。你可以使用GCS, S3, GitHub Pages等来创建你自己的web服务器。</p>
<p><br><br><br></p>
<h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><p>Registries: <a href="https://helm.sh/docs/topics/registries/" target="_blank" rel="noopener">https://helm.sh/docs/topics/registries/</a></p>
<p>Helm 3 支持OCI用于包分发。 Chart包可以通过基于OCI的注册中心存储和分发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 激活对OCI的支持</span><br><span class="line">export HELM_EXPERIMENTAL_OCI=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 运行一个注册中心</span><br><span class="line">docker run -dp 5000:5000 --restart=always --name registry registry</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 认证</span><br><span class="line">htpasswd -cB -b auth.htpasswd myuser mypass</span><br><span class="line">docker run -dp 5000:5000 --restart=always --name registry \</span><br><span class="line">  -v $(pwd)/auth.htpasswd:/etc/docker/registry/auth.htpasswd \</span><br><span class="line">  -e REGISTRY_AUTH=&quot;&#123;htpasswd: &#123;realm: localhost, path: /etc/docker/registry/auth.htpasswd&#125;&#125;&quot; \</span><br><span class="line">  registry</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 登录</span><br><span class="line">helm registry login -u myuser localhost:5000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 注销</span><br><span class="line">helm registry logout localhost:5000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 保存</span><br><span class="line">helm chart save mychart/ localhost:5000/myrepo/mychart:2.7.0</span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">helm chart list</span><br><span class="line"></span><br><span class="line"># 导出</span><br><span class="line">helm chart export localhost:5000/myrepo/mychart:2.7.0</span><br><span class="line"></span><br><span class="line"># 推送到远程</span><br><span class="line">helm chart push localhost:5000/myrepo/mychart:2.7.0</span><br><span class="line"></span><br><span class="line"># 从缓存中移除</span><br><span class="line">helm chart remove localhost:5000/myrepo/mychart:2.7.0</span><br><span class="line"></span><br><span class="line"># 从远程拉取</span><br><span class="line">helm chart pull localhost:5000/myrepo/mychart:2.7.0</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>使用上述命令存储的chart会被缓存到文件系统中。OCI 镜像设计规范 严格遵守文件系统布局的。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tree ~/Library/Caches/helm/</span><br><span class="line">└── registry</span><br><span class="line">    ├── cache</span><br><span class="line">    │   ├── blobs</span><br><span class="line">    │   │   └── sha256</span><br><span class="line">    │   │       ├── 1b251d38cfe948dfc0a5745b7af5ca574ecb61e52aed10b19039db39af6e1617</span><br><span class="line">    │   │       ├── 31fb454efb3c69fafe53672598006790122269a1b3b458607dbe106aba7059ef</span><br><span class="line">    │   │       └── 8ec7c0f2f6860037c19b54c3cfbab48d9b4b21b485a93d87b64690fdb68c2111</span><br><span class="line">    │   ├── index.json</span><br><span class="line">    │   ├── ingest</span><br><span class="line">    │   └── oci-layout</span><br><span class="line">    └── config.json</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>Helm Architecture: <a href="https://helm.sh/docs/topics/architecture/" target="_blank" rel="noopener">https://helm.sh/docs/topics/architecture/</a></p>
<p>介绍Helm在高级别的架构。</p>
<p><br></p>
<h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>The Purpose of Helm</p>
<p>Helm是管理称为chart的k8s包的工具。Helm可以做以下事情：</p>
<ul>
<li>从头开始创建一个新的charts</li>
<li>packages charts为归档(tgz) chart文件</li>
<li>与chart repo交互，并存储在那</li>
<li>安装和卸载charts到k8s集群</li>
<li>管理已安装的charts的发行版</li>
</ul>
<p>对于Helm，有三个重要的概念：</p>
<ul>
<li>chart是创建一个k8s应用实例所需的信息束</li>
<li>config包含配置信息，可以合并到package chart来创建一个可发行的对象</li>
<li>release是一个运行的chart实例，包含特定的配置</li>
</ul>
<p><br><br><br></p>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p>Components</p>
<p>Helm被实现为两个不同部分来执行：</p>
<p>Helm CLI客户端，负责以下事情：</p>
<ul>
<li>本地chart开发</li>
<li>管理repo</li>
<li>管理release</li>
<li>与Helm Library接口<ul>
<li>发送chart安装</li>
<li>请求升级或卸载releases</li>
</ul>
</li>
</ul>
<p>Helm Library提供了执行所有helm操作的逻辑。与k8s API接口交互，并提供以下功能：</p>
<ul>
<li>组合chart和配置来构建一个release</li>
<li>安装chart到k8s，并提供release对象</li>
<li>通过与k8s交互，升级和卸载chart</li>
</ul>
<p><br><br><br></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>Implementation</p>
<p>Helm client和library由go编写。library使用k8s client与k8s集群通信。目前，library使用<code>REST+JSON</code>。它存储信息在k8s内的secrets里，不需要自己的数据库。配置文件以YAML编写。</p>
<p><br><br><br></p>
<h2 id="高级技术"><a href="#高级技术" class="headerlink" title="高级技术"></a>高级技术</h2><p>Advanced Helm Techniques: <a href="https://helm.sh/docs/topics/advanced/" target="_blank" rel="noopener">https://helm.sh/docs/topics/advanced/</a></p>
<p><br></p>
<h3 id="后置渲染"><a href="#后置渲染" class="headerlink" title="后置渲染"></a>后置渲染</h3><p>Post Rendering</p>
<p><br><br><br></p>
<h3 id="GO-SDK"><a href="#GO-SDK" class="headerlink" title="GO SDK"></a>GO SDK</h3><p><br><br><br></p>
<h3 id="后端存储"><a href="#后端存储" class="headerlink" title="后端存储"></a>后端存储</h3><p>Storage backends</p>
<p><br><br><br></p>
<h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><p>Role-based Access Control: <a href="https://helm.sh/docs/topics/rbac/" target="_blank" rel="noopener">https://helm.sh/docs/topics/rbac/</a></p>
<p>k8s rbac: <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a></p>
<p>介绍Helm如何与k8s RBAC进行交互。</p>
<p>在k8s中，授权角色给特定用户或应用的服务账号(service account)，以确保应用程序的操作在特定范围内。从k8s v1.6开始，RBAC默认启用。</p>
<p>使用RBAC，你可以：</p>
<ul>
<li>授权特权操作给管理员</li>
<li>限制用户在特定命名空间/集群范围创建资源的能力</li>
<li>限制用户在特定命名空间/集群范围内查看资源的能力</li>
</ul>
<p><br></p>
<h3 id="管理用户账户"><a href="#管理用户账户" class="headerlink" title="管理用户账户"></a>管理用户账户</h3><p>Managing user accounts</p>
<p>所有的k8s集群有两种类型的用户：</p>
<ul>
<li>service accounts managed by Kubernetes</li>
<li>normal users</li>
</ul>
<p>普通用户假定由外部进行管理，独立的服务。管理员分发私钥，用户存储密码，甚至是用户名密码列表这样的文件。在这方面，k8s不具有代表普通用户账户的对象。普通用户无法通过API调用被添加到集群。</p>
<p>相比之下，服务账号是由k8s API管理的用户。它们被绑定到特定的命名空间，通过API server自动创建，或通过API调用手动创建。服务账号绑定在一组凭据里，存储为secret，它被挂载到pod，允许集群内进程与k8s API进行交谈。</p>
<p>API请求被绑定到任何一个用户（普通用户、服务账号），或者被视为匿名请求。这意味着集群内或集群外的每一个进程，从工作站上输入<code>kubectl</code>的人类用户，到节点上的kubelets，到控制面板的成员，在进行请求API server时必须进行认证，或被视为匿名用户。</p>
<p><br><br><br></p>
<h3 id="角色、集群角色、角色绑定、集群角色绑定"><a href="#角色、集群角色、角色绑定、集群角色绑定" class="headerlink" title="角色、集群角色、角色绑定、集群角色绑定"></a>角色、集群角色、角色绑定、集群角色绑定</h3><p>Roles, ClusterRoles, RoleBindings, and ClusterRoleBindings</p>
<p>在k8s中，用户账户和服务账户只能够根据授权访问来查看和修改资源。这种授权是通过使用<strong>角色(Roles)</strong>和<strong>角色绑定(RoleBindings)</strong>。角色和角色绑定被绑定到特定的命名空间，它通过角色提供授权，授予用户在此命名空间内查看或修改资源的能力。</p>
<p>在集群范围内，这些被称为<strong>集群角色(ClusterRoles)</strong>和<strong>集群角色绑定(ClusterRoleBindings)</strong>。授权用户集群角色，允许它们访问和修改整个集群的资源。这也需要查看和修改集群范围(命名空间，资源配额，节点)的资源。</p>
<p>集群角色可通过角色绑定的引用来绑定到特定的命名空间。<code>admin</code>, <code>edit</code>, <code>view</code>是最常使用的默认集群角色。</p>
<p>k8s有一些默认的集群角色可用，它们的本意是面向用户的角色。它们包含超级角色(<code>cluster-admin</code>)，和细粒度访问的角色(<code>admin</code>, <code>edit</code>, <code>view</code>)。</p>
<p><br></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Default ClusterRole</th>
<th>Default ClusterRoleBinding</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cluster-admin</td>
<td>system:masters group</td>
<td>允许超级用户访问对任意资源执行任意动作。</td>
</tr>
<tr>
<td>admin</td>
<td>None</td>
<td>允许管理员访问，在命名空间内使用角色绑定来授权。如读写命名空间内的大部分资源，包括在命名空间内创建角色和角色绑定的能力。但不允许对资源配额或命名空间进行写操作。</td>
</tr>
<tr>
<td>edit</td>
<td>None</td>
<td>允许在命名空间内读取大多数对象的权限，不允许查看或修改角色和角色绑定</td>
</tr>
<tr>
<td>view</td>
<td>None</td>
<td>允许在命名空间内查看大多数对象的权限。不允许查看角色和角色绑定。不允许查看secrets。</td>
</tr>
</tbody>
</table>
</div>
<p><br><br><br></p>
<h3 id="限制用户账户使用RBAC访问"><a href="#限制用户账户使用RBAC访问" class="headerlink" title="限制用户账户使用RBAC访问"></a>限制用户账户使用RBAC访问</h3><p>Restricting a user account access using RBAC</p>
<p>现在让我们了解基于角色的访问控制的基础知识，让我们讨论管理员如何限制用户的访问范围。</p>
<p><br></p>
<p><strong>示例：授予用户命名空间范围的读写权限</strong></p>
<p>Grant a user read/write access to a particular namespace</p>
<p>要限制用户对特定命名空间的读写权限，可以使用<code>edit</code>或<code>admin</code>角色。</p>
<p>此外，你还可以使用<code>cluster-admin</code>来创建一个角色绑定。授予在命名空间范围内的<code>cluster-admin</code>来提供在此命名空间内完整控制资源的权限，包含命名空间自身。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建ns</span><br><span class="line">kubectl create namespace foo</span><br><span class="line"></span><br><span class="line">#创建RoleBinding</span><br><span class="line">kubectl create rolebinding sam-edit</span><br><span class="line">    --clusterrole edit \</span><br><span class="line">    --user sam \</span><br><span class="line">    --namespace foo</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>示例：授予用户集群范围的读写权限</strong></p>
<p>Example: Grant a user read/write access at the cluster scope</p>
<p>如果用户希望安装chart，在集群范围内安装集群资源（ns, roles, crd…），它们将需要集群范围的写权限。要这样做，授予用户<code>admin</code>或<code>cluster-admin</code>角色权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding sam-view</span><br><span class="line">    --clusterrole view \</span><br><span class="line">    --user sam</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding sam-secret-reader</span><br><span class="line">    --clusterrole secret-reader \</span><br><span class="line">    --user sam</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>示例：授予用户命名空间范围的只读权限</strong></p>
<p>Example: Grant a user read-only access to a particular namespace</p>
<p>你可能注意到了，没有查看secret的集群角色。<code>view</code>集群角色没有授予用户访问secret的权限。然而，Helm默认将release metadata存储为secret。</p>
<p>为了使用户运行<code>helm list</code>，它需要读取这些secrets。为此，我们将创建一个特殊的<code>secret-reader</code>集群角色。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster-role-secret-reader.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["secrets"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f clusterrole-secret-reader.yaml</span><br><span class="line"></span><br><span class="line">kubectl create namespace foo</span><br><span class="line"></span><br><span class="line">kubectl create rolebinding sam-view</span><br><span class="line">    --clusterrole view \</span><br><span class="line">    --user sam \</span><br><span class="line">    --namespace foo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create rolebinding sam-secret-reader</span><br><span class="line">    --clusterrole secret-reader \</span><br><span class="line">    --user sam \</span><br><span class="line">    --namespace foo</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>示例：授予用户集群范围的只读权限</strong></p>
<p>Example: Grant a user read-only access at the cluster scope</p>
<p>如果用户想运行<code>helm l ist --all-namespaces</code>命令，API需要用户拥有集群范围内的读权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding sam-view</span><br><span class="line">    --clusterrole view \</span><br><span class="line">    --user sam</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding sam-secret-reader</span><br><span class="line">    --clusterrole secret-reader \</span><br><span class="line">    --user sam</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>The Helm Plugins Guide: <a href="https://helm.sh/docs/topics/plugins/" target="_blank" rel="noopener">https://helm.sh/docs/topics/plugins/</a></p>
<p>Helm plugin是一个可通过helm CLI访问的工具，但不是内置的helm基础代码的一部分。</p>
<p><br><br><br></p>
<h2 id="V2迁移到V3"><a href="#V2迁移到V3" class="headerlink" title="V2迁移到V3"></a>V2迁移到V3</h2><p>Migrating Helm v2 to v3: <a href="https://helm.sh/docs/topics/v2_v3_migration/" target="_blank" rel="noopener">https://helm.sh/docs/topics/v2_v3_migration/</a></p>
<p><br><br><br></p>
<h2 id="弃用的k8s-api"><a href="#弃用的k8s-api" class="headerlink" title="弃用的k8s api"></a>弃用的k8s api</h2><p>Deprecated Kubernetes APIs: <a href="https://helm.sh/docs/topics/kubernetes_apis/" target="_blank" rel="noopener">https://helm.sh/docs/topics/kubernetes_apis/</a></p>
<p><br><br><br></p>
<h2 id="版本支持"><a href="#版本支持" class="headerlink" title="版本支持"></a>版本支持</h2><p>Helm Version Support Policy: <a href="https://helm.sh/docs/topics/version_skew/" target="_blank" rel="noopener">https://helm.sh/docs/topics/version_skew/</a></p>
<p><br><br><br></p>
<h2 id="SQL存储后端的权限管理"><a href="#SQL存储后端的权限管理" class="headerlink" title="SQL存储后端的权限管理"></a>SQL存储后端的权限管理</h2><p>Permissions management for SQL storage backend: <a href="https://helm.sh/docs/topics/permissions_sql_storage_backend/" target="_blank" rel="noopener">https://helm.sh/docs/topics/permissions_sql_storage_backend/</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><p>The Chart Best Practices Guide: <a href="https://helm.sh/docs/chart_best_practices/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/</a></p>
<p>涵盖了Helm团队对创建chart的最佳做法。它侧重于chart应该如何构造。主要关注那些可能会公开部署的charts的最佳实践。</p>
<p><br></p>
<h2 id="一般约定"><a href="#一般约定" class="headerlink" title="一般约定"></a>一般约定</h2><p>General Conventions: <a href="https://helm.sh/docs/chart_best_practices/conventions/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/conventions/</a></p>
<p><br></p>
<h3 id="chart名称"><a href="#chart名称" class="headerlink" title="chart名称"></a>chart名称</h3><p>Chart Names</p>
<p>chart名称必须是小写字母和数字，可用<code>-</code>隔开。</p>
<p>chart目录必须与chart名称相同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">drupal</span><br><span class="line">nginx-lego</span><br><span class="line">aws-cluster-autoscaler</span><br><span class="line"></span><br><span class="line">nginx-lego</span><br><span class="line">nginx-lego/</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h3><p>Version Numbers</p>
<p>只要有可能，Helm使用SemVer2来表示版本号。请注意，Docker image tag并不一定遵循SemVer，注意。</p>
<p><br><br><br></p>
<h3 id="格式化YAML"><a href="#格式化YAML" class="headerlink" title="格式化YAML"></a>格式化YAML</h3><p>Formatting YAML</p>
<p>YAML应该使用两个空格（别使用tab）。</p>
<p><br><br><br></p>
<h3 id="词"><a href="#词" class="headerlink" title="词"></a>词</h3><p>Usage of the Words Helm and Chart</p>
<p>Helm词的一些约定：</p>
<ul>
<li>Helm指作为一个整体的项目</li>
<li><code>helm</code>客户端CLI</li>
<li><code>chart</code>不需要大写，它不是专有名词</li>
<li><code>Chart.yaml</code>需要大写，因为该文件名是大小写敏感的</li>
</ul>
<p><br><br><br></p>
<h2 id="值"><a href="#值" class="headerlink" title="值"></a>值</h2><p>Values: <a href="https://helm.sh/docs/chart_best_practices/values/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/values/</a></p>
<p>提供给你如何组织和设计chart的<code>values.yaml</code>文件，并使用你的值。</p>
<p><br></p>
<h3 id="命名约定"><a href="#命名约定" class="headerlink" title="命名约定"></a>命名约定</h3><p>Naming Conventions</p>
<p>变量名必须小写字母开头，使用驼峰分开：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chicken: true</span><br><span class="line">chickenNoodleSoup: true</span><br></pre></td></tr></table></figure>
<p>请注意，所有Helm内置变量以大写字母开头，用户可以轻松区分开:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.Release.Name</span><br><span class="line">.Capabilities.KubeVersion</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="嵌套值"><a href="#嵌套值" class="headerlink" title="嵌套值"></a>嵌套值</h3><p>YAML是一种灵活的格式，值可以被深度嵌套。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  name: nginx</span><br><span class="line">  port: 80</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; if .Values.server &#125;&#125;</span><br><span class="line">  &#123;&#123; default &quot;none&quot; .Values.server.name &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="使类型清晰"><a href="#使类型清晰" class="headerlink" title="使类型清晰"></a>使类型清晰</h3><p>Make Types Clear</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># YAM的类型强制规则有时是反直觉的。例如一下两者是不同的</span></span><br><span class="line"><span class="attr">foo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">foo:</span> <span class="string">"false"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 避免类型转化错误的最简单的方法是要明确字符串和隐含的一切。使用引号引用字符串</span></span><br><span class="line"><span class="comment"># 要避免整数转换错误，将整数存储为字符串，使用以下方法来获取整数值</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">int</span> <span class="string">$value</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在大多数情况下，显式类型标签被尊重。如以下1234被当作字符串</span></span><br><span class="line"><span class="attr">foo:</span> <span class="type">!!string</span> <span class="number">1234</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="考虑用户如何使用你的值"><a href="#考虑用户如何使用你的值" class="headerlink" title="考虑用户如何使用你的值"></a>考虑用户如何使用你的值</h3><p>Consider How Users Will Use Your Values</p>
<p>值有三个来源：</p>
<ul>
<li><code>values.yaml</code>文件</li>
<li><code>helm install -f</code>或<code>helm upgrade -f</code>时指定的文件里</li>
<li><code>--set</code>或<code>--set-string</code>选项指定</li>
</ul>
<p>当设计值的组织结构时，用户是希望可通过<code>-f</code>或<code>--set</code>选项来覆盖它们。YAML建议写成映射(mapping)，便于替换<code>--set servers.foo.port=80</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">servers:</span><br><span class="line">  foo:</span><br><span class="line">    port: 80</span><br><span class="line">  bar:</span><br><span class="line">    port: 81</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h3><p>每个在<code>values.yaml</code>中定义的属性应该被记录(documented)。文档字符串应该用它描述的属性的名称开始，然后给出至少一个单句描述。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># serverHost is the host name for the webserver</span></span><br><span class="line"><span class="attr">serverHost:</span> <span class="string">example</span></span><br><span class="line"><span class="comment"># serverPort is the HTTP listener port for the webserver</span></span><br><span class="line"><span class="attr">serverPort:</span> <span class="number">9191</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>Templates: <a href="https://helm.sh/docs/chart_best_practices/templates/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/templates/</a></p>
<p><br></p>
<h3 id="templates目录架构"><a href="#templates目录架构" class="headerlink" title="templates目录架构"></a>templates目录架构</h3><p>Structure of <code>templates/</code></p>
<p><code>templates/</code>目录应该是如下结构：</p>
<ul>
<li>模板文件是<code>.yaml</code>扩展的YAML输出。<code>.tpl</code>扩展可用于未经格式化的模板文件</li>
<li>模板文件名应使用虚线(example-configmap.yaml)，而不是驼峰</li>
<li>每个资源定义应该有自己的模板文件</li>
<li>模板文件应放映资源类型（如<code>foo-pod.yaml</code>, <code>bar-svc.yaml</code>）</li>
</ul>
<p><br><br><br></p>
<h3 id="定义的模板的名称"><a href="#定义的模板的名称" class="headerlink" title="定义的模板的名称"></a>定义的模板的名称</h3><p>Names of Defined Templates</p>
<p>定义的模板(模板文件内的<code></code>)是全局访问的。这意味着，chart和它的subchart可以访问所有<code></code>创建的模板。这样我想起了Pythond的模板语言（Django模板语言，Jinja2等等）。</p>
<p>出于此原因，所有定义的模板名称都应该命名空间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- define &quot;nginx.fullname&quot; &#125;&#125;</span><br><span class="line">&#123;&#123;/* ... */&#125;&#125;</span><br><span class="line">&#123;&#123; end -&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>It is highly recommended that new charts are created via helm create command as the template names are automatically defined as per this best practice.</p>
<p><br><br><br></p>
<h3 id="格式化模板"><a href="#格式化模板" class="headerlink" title="格式化模板"></a>格式化模板</h3><p>Formatting Templates</p>
<p>模板应该使用两个空格，而不是tab。花括号前后应该有空格。有适当的空格和缩进。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; .foo &#125;&#125;</span><br><span class="line">&#123;&#123; print &quot;foo&quot; &#125;&#125;</span><br><span class="line">&#123;&#123;- print &quot;bar&quot; -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; if $foo -&#125;&#125;</span><br><span class="line">  &#123;&#123;- with .Bar &#125;&#125;Hello&#123;&#123; end -&#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="生成模板中的空格"><a href="#生成模板中的空格" class="headerlink" title="生成模板中的空格"></a>生成模板中的空格</h3><p>Whitespace in Generated Templates</p>
<p>优选的是，保持在生成的模板中的空格数量降到最低。特别是，许多空行不应出现彼此相邻。但偶尔空行还是可以的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is best</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    first:</span> <span class="string">first</span></span><br><span class="line"><span class="attr">    second:</span> <span class="string">second</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is okay</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    first:</span> <span class="string">first</span></span><br><span class="line"><span class="attr">    second:</span> <span class="string">second</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>Comments (YAML Comments vs Template Comments)</p>
<p>YAML文件注释和模板注释。当一个模板记录功能时，应该使用模板注释。当Helm用户通过查看注释调试时，在模板内应该使用YANML注释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># yaml 注释</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;- /*</span><br><span class="line">模板注释</span><br><span class="line">*/ -&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;- /*</span><br><span class="line">mychart.shortname provides a 6 char truncated version of the release name.</span><br><span class="line">*/ -&#125;&#125;</span><br><span class="line">&#123;&#123; define &quot;mychart.shortname&quot; -&#125;&#125;</span><br><span class="line">&#123;&#123; .Release.Name | trunc 6 &#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This may cause problems if the value is more than 100Gi</span><br><span class="line">memory: &#123;&#123; .Values.maxMem | quote &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="在模板和模板输出中使用JSON"><a href="#在模板和模板输出中使用JSON" class="headerlink" title="在模板和模板输出中使用JSON"></a>在模板和模板输出中使用JSON</h3><p>Use of JSON in Templates and Template Output</p>
<p>YAML是JSON的超集(superset)。在一些情况下，使用JSON语法可比其它YAML表示更具有可读性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 列表</span><br><span class="line"></span><br><span class="line"># yaml</span><br><span class="line">arguments:</span><br><span class="line">  - &quot;--dirname&quot;</span><br><span class="line">  - &quot;/foo&quot;</span><br><span class="line"></span><br><span class="line"># json</span><br><span class="line">arguments: [&quot;--dirname&quot;, &quot;/foo&quot;]</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h2><p>Dependencies: <a href="https://helm.sh/docs/chart_best_practices/dependencies/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/dependencies/</a></p>
<p>介绍<code>Chart.yaml</code>内声明的<code>dependencies</code>的最佳实践。</p>
<p><br></p>
<h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>Versions</p>
<p>如果可能的化，使用版本范围，而不是某个确切的版本。建议使用补丁级别(patch-level)版本匹配:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># &gt;= 1.2.3, &lt; 1.3.0</span><br><span class="line">version: ~1.2.3</span><br></pre></td></tr></table></figure>
<p>repo ruls，如果可能，使用HTTPS。文件URL(<code>file://...</code>)被认为是一个特殊，对由一个固定部署的流水线charts。</p>
<p><br><br><br></p>
<h3 id="条件和标记"><a href="#条件和标记" class="headerlink" title="条件和标记"></a>条件和标记</h3><p>Conditions and Tags</p>
<p>条件或标记应被添加到任何依赖（可选的）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 条件的推荐格式</span><br><span class="line">condition: somechart.enabled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 标记</span><br><span class="line">tags:</span><br><span class="line">  - webaccelerator</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="标签和注释"><a href="#标签和注释" class="headerlink" title="标签和注释"></a>标签和注释</h2><p>Labels and Annotations: <a href="https://helm.sh/docs/chart_best_practices/labels/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/labels/</a></p>
<p>讨论chart中使用标签和注释的最佳实践。</p>
<p><br></p>
<h3 id="标签还是注释"><a href="#标签还是注释" class="headerlink" title="标签还是注释"></a>标签还是注释</h3><p>Is it a Label or an Annotation?</p>
<p>以下条件的元数据项应该为标签(label)：</p>
<ul>
<li>它利用k8s来标识此资源</li>
<li>暴露给查询系统的目的是有用的</li>
</ul>
<p>如果元数据的条目不用于查询，它应该设置为注释。Helm hooks总是注释。</p>
<p><br><br><br></p>
<h3 id="标准的标签"><a href="#标准的标签" class="headerlink" title="标准的标签"></a>标准的标签</h3><p>Standard Labels</p>
<p>下表定义了Helm chart常用的标签。Helm自身从未要求特定的标签存在。REC的标签是建议的，并应该放置到全局一致性的chart。OPT的标签是可选的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">名称    状态   描述</span><br><span class="line">app.kubernetes.io/name  REC    这应该是app名称。通常使用&#123;&#123; template &quot;name&quot; . &#125;&#125; 这由许多k8s manifests使用，不是Helm特定的</span><br><span class="line">helm.sh/chart           REC  chart名称和版本: &#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;</span><br><span class="line">app.kubernetes.io/managed-by    REC    这应该始终设置为&#123;&#123; .Release.Service &#125;&#125;</span><br><span class="line">app.kubernetes.io/instance    REC    这应该为&#123;&#123; .Release.Name &#125;&#125;，有助于在同意应用不同实例之间进行区分</span><br><span class="line">app.kubernetes.io/version    OPT   应用的版本设置为&#123;&#123; .Chart.AppVersion &#125;&#125;</span><br><span class="line">app.kubernetes.io/component    OPT   This is a common label for marking the different roles that pieces may play in an application</span><br><span class="line">|app.kubernetes.io/part-of    OPT   当多个charts或软件片一起使用来做一个应用</span><br></pre></td></tr></table></figure>
<p>可在k8s 文档中，带有<code>app.kubernetes.io</code>前缀的文档中查看更多信息。</p>
<p><br><br><br></p>
<h2 id="Pods和PodTemplates"><a href="#Pods和PodTemplates" class="headerlink" title="Pods和PodTemplates"></a>Pods和PodTemplates</h2><p>Pods and PodTemplates: <a href="https://helm.sh/docs/chart_best_practices/pods/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/pods/</a></p>
<p>以下资源列表使用PodTemplate：</p>
<ul>
<li>Deployment</li>
<li>ReplicationController</li>
<li>ReplicaSet</li>
<li>DaemonSet</li>
<li>StatefulSet</li>
</ul>
<p><br></p>
<h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><p>Images</p>
<p>容器镜像应该使用确定的标记或镜像的SHA。但不应该使用<code>latest</code>, <code>head</code>, <code>canary</code>这样的标记。</p>
<p>镜像可以在<code>values.yaml</code>文件中定义，使其很容易替换镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image: &#123;&#123; .Values.redisImage | quote &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>镜像和标记可在<code>values.yaml</code>中被定义为分开的两个字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image: &quot;&#123;&#123; .Values.redisImage &#125;&#125;:&#123;&#123; .Values.redisTag &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="镜像拉取策略"><a href="#镜像拉取策略" class="headerlink" title="镜像拉取策略"></a>镜像拉取策略</h3><p>ImagePullPolicy</p>
<p><code>helm create</code>默认在<code>deployment.yaml</code>中设置<code>imagePullPolicy</code>为<code>IfNotPresent</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.image.pullPolicy</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values.yaml</span></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line"><span class="attr">  pullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<p>同样，如果未设置<code>impagePullPolicy</code>，k8s默认会将其设置为<code>IfNotPresent</code>。如果想要修改此值，只需在<code>values.yaml</code>文件中更新此值。</p>
<p><br><br><br></p>
<h3 id="PodTemplate应该声明选择器"><a href="#PodTemplate应该声明选择器" class="headerlink" title="PodTemplate应该声明选择器"></a>PodTemplate应该声明选择器</h3><p>PodTemplates Should Declare Selectors</p>
<p>所有的PodTemplate部分应该指定一个选择器。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line"><span class="attr">  matchLabels:</span></span><br><span class="line">      <span class="string">app.kubernetes.io/name:</span> <span class="string">MyName</span></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line"><span class="attr">  metadata:</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line">      <span class="string">app.kubernetes.io/name:</span> <span class="string">MyName</span></span><br></pre></td></tr></table></figure>
<p>这是一个很好的做法，因为它使set和pod相关联。</p>
<p>但是，这对于像Deployment这样的集更为重要。没有这一点，整个标签集(set of labels)用于选择匹配pod，如果你使用的标签发生改变（如版本或日期），这将打破匹配。</p>
<p><br><br><br></p>
<h2 id="自定义资源的定义"><a href="#自定义资源的定义" class="headerlink" title="自定义资源的定义"></a>自定义资源的定义</h2><p>Custom Resource Definitions</p>
<p>当使用自定义资源定义(CRDs)，区分两种不同的片是很重要的：</p>
<ul>
<li>声明一个CRD(<code>kind: CustomResourceDefinition</code>)</li>
<li>然后资源使用CRD</li>
</ul>
<p><br></p>
<h3 id="使用资源前安装CRD声明"><a href="#使用资源前安装CRD声明" class="headerlink" title="使用资源前安装CRD声明"></a>使用资源前安装CRD声明</h3><p>Install a CRD Declaration Before Using the Resource</p>
<p>Helm是尽可能优化地载入更多的资源到k8s中。按照设计，k8s可以采取一整套清单(manifests)，并带它们所有上线（这就是所谓的和解循环(reconciliation loop))）。</p>
<p>但是，CRDs有一些不同。对于CRD，在任意CRDs类型资源被使用之前，必须先注册声明。注册过程有时需要几秒。</p>
<p><br></p>
<p><strong>方法1：让helm为你做此事</strong></p>
<p>Method 1: Let helm Do It For You</p>
<p>随着Helm3的到来，出于更简单的方法，Helm移除了旧的<code>crd-install</code> hooks。这在是一个称为<code>crds</code>的新目录，在你创建的chart的此目录下保存你的CRDs。这些CRDs没有模板，但会在chart运行<code>helm install</code>时默认安装。如果CRD已存在，它会被跳过。你也可以通过传递<code>--skip-crds</code>选项来跳过CRD的安装。</p>
<p><strong>一些注意事项:</strong></p>
<p>目前不支持使用Helm更新或删除CRDs。这是一个经过反复讨论的明确的决定，由于存在非故意丢失数据的危险。此外，目前社区如何处理CRDs和它的生命周期没有共识，由于这种演变，Helm将添加对这些用例的支持。</p>
<p><code>helm install</code>和<code>helm upgrade</code>的<code>--dry-run</code>选项暂不支持CRDs。Dry Run的目的是去验证chart的输出将实际地工作，如果发送到服务器。但CRDs可通过服务器行为的修改。Helm无法在dry run上安装CRD，因此发现客户端将不知道自定义资源(CR)，并验证将失败。你可以可选地移动CRDs到它们自己的chart，或使用<code>helm template</code>来代替。</p>
<p>围绕CRD支持的另一个重要的考虑点是如何处理模板的渲染(rendering of templates)。一个在Helm2中使用<code>crd-install</code>方法的明显的缺点是不能正确验证chart，由于改变API可用性（一个CRD被实际添加到另一个可用API到k8s集群）。如果一个chart安装了CRD，<code>helm</code>不再有一组API版本的有效集。这也是在移除从CRDs的模板支持的原因。随着安装CRD的新的<code>crds</code>方法，我们现在确保<code>helm</code>有关于当前集群状态的完整信息。</p>
<p><br></p>
<p><strong>方法2：独立chart</strong></p>
<p>Separate Charts</p>
<p>另一种方法是，把CRD定义在一个chart中，然后把所有资源使用的该CRD放在另一个chart。</p>
<p>在此方法中，每个char都必须单独安装。然而，这个工作流程可能是集群操作器(cluster operators)（对集群拥有admin权限）使用。</p>
<p><br><br><br></p>
<h2 id="RBAC-1"><a href="#RBAC-1" class="headerlink" title="RBAC"></a>RBAC</h2><p>Role-Based Access Control: <a href="https://helm.sh/docs/chart_best_practices/rbac/" target="_blank" rel="noopener">https://helm.sh/docs/chart_best_practices/rbac/</a></p>
<p>RBAC资源有：</p>
<ul>
<li>ServiceAccount (namespaced)</li>
<li>Role (namespaced)</li>
<li>ClusterRole</li>
<li>RoleBinding (namespaced)</li>
<li>ClusterRoleBinding</li>
</ul>
<p><br></p>
<h3 id="YAML配置"><a href="#YAML配置" class="headerlink" title="YAML配置"></a>YAML配置</h3><p>RBAC和ServiceAccount配置因该在单独的密钥里。它们是不同的东西。拆分这两个概念在YAML歧义消除它们，使之更清楚。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rbac:</span></span><br><span class="line">  <span class="comment"># Specifies whether RBAC resources should be created</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">serviceAccount:</span></span><br><span class="line">  <span class="comment"># Specifies whether a ServiceAccount should be created</span></span><br><span class="line"><span class="attr">  create:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># The name of the ServiceAccount to use.</span></span><br><span class="line">  <span class="comment"># If not set and create is true, a name is generated using the fullname template</span></span><br><span class="line"><span class="attr">  name:</span></span><br></pre></td></tr></table></figure>
<p>多个服务账号可以扩展为更复杂的charts。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">someComponent:</span><br><span class="line">  serviceAccount:</span><br><span class="line">    create: true</span><br><span class="line">    name:</span><br><span class="line">anotherComponent:</span><br><span class="line">  serviceAccount:</span><br><span class="line">    create: true</span><br><span class="line">    name:</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="RBAC资源应该被默认创建"><a href="#RBAC资源应该被默认创建" class="headerlink" title="RBAC资源应该被默认创建"></a>RBAC资源应该被默认创建</h3><p>RBAC Resources Should be Created by Default</p>
<p><code>rbac.create</code>应该是一个布尔值，由RBAC资源来控制创建。默认应该为true。希望管理RBAC访问控制的用户可以将此设置为false。</p>
<p><br><br><br></p>
<h3 id="使用RBAC资源"><a href="#使用RBAC资源" class="headerlink" title="使用RBAC资源"></a>使用RBAC资源</h3><p>Using RBAC Resources</p>
<p><code>serviceAccount.name</code>应该被设置为由chart创建的访问控制资源使用的服务账号名称。如果<code>serviceAccount.create</code>为true，那么此名称的服务名称应该被创建。如果此名称未设置，则使用模板<code>fullname</code>来生成。如果为false，则它不应该被创建，但它应该与同样的资源相关联，以便创建后引用该手动创建RBAC资源正常工作。如果为false且没有指定名称，则使用默认的服务账号。</p>
<p>下面的助手模板应该用于服务账号：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;/*</span></span><br><span class="line"><span class="string">Create</span> <span class="string">the</span> <span class="string">name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">service</span> <span class="string">account</span> <span class="string">to</span> <span class="string">use</span></span><br><span class="line"><span class="string">*/&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">define</span> <span class="string">"mychart.serviceAccountName"</span> <span class="bullet">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">.Values.serviceAccount.create</span> <span class="bullet">-&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">default</span> <span class="string">(include</span> <span class="string">"mychart.fullname"</span> <span class="string">.)</span> <span class="string">.Values.serviceAccount.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">else</span> <span class="bullet">-&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">default</span> <span class="string">"default"</span> <span class="string">.Values.serviceAccount.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="bullet">-&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="bullet">-&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="模板-1"><a href="#模板-1" class="headerlink" title="模板"></a>模板</h1><p>Chart Template: <a href="https://helm.sh/docs/chart_template_guide/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/</a></p>
<p>Helm‘s chart templates，重点介绍模板语言。让我想起的Django模板语言、Jinja2模板语言。</p>
<p>模板生成清单文件，这是k8s可理解的YAML格式的资源描述。本章重点介绍以下概念：</p>
<ul>
<li>Helm模板语言</li>
<li>Values使用</li>
<li>使用模板的技术</li>
</ul>
<p><br></p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>Getting Started: <a href="https://helm.sh/docs/chart_template_guide/getting_started/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/getting_started/</a></p>
<p>创建一个chart并添加一个模板。</p>
<p><br></p>
<h3 id="Charts-1"><a href="#Charts-1" class="headerlink" title="Charts"></a>Charts</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mychart/</span><br><span class="line">  Chart.yaml</span><br><span class="line">  values.yaml</span><br><span class="line">  charts/</span><br><span class="line">  templates/</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p><code>templates/</code>目录存放模板文件。当Helm评估一个chart，它会发送所有模板目录中的文件到模板渲染引擎。然后，它收集模板的结果，并将它们发送到k8s。</p>
<p><code>values.yaml</code>文件对模板也很重要。此文件包含了一个chart的默认值。默认值可通过命令行选项进行覆盖。</p>
<p><code>Chart.yaml</code>文件包含对chart包的描述信息。你可在模板中访问它。<code>charts/</code>目录可能包含其它chats(称为subcharts)。</p>
<p><br><br><br></p>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>A Starter Chart</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个名为mychart的chart包</span><br><span class="line">helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 目录结构</span><br><span class="line">tree ./mychart -L 2</span><br><span class="line">./mychart</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl    #模板助手，你可以重新使用整个chart</span><br><span class="line">│   ├── hpa.yaml    #</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt    #chart包的帮助文本(help text)，会在运行helm install显示</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建自己的模板</span><br><span class="line">rm -rf mychart/templates/*</span><br></pre></td></tr></table></figure>
<p>当编写生产环境的chart包时，有这些charts包的基础版本可能很有用。</p>
<p><br><br><br></p>
<h3 id="第一个模板"><a href="#第一个模板" class="headerlink" title="第一个模板"></a>第一个模板</h3><p>A First Template</p>
<p>创建一个<code>ConfigMap</code>资源的模板。由于它是一个基本的资源，因此它为我们提供了一个很好的起点。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mychart/templates/configmap.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mychart-configpmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br></pre></td></tr></table></figure>
<p>小技巧：模板名称不遵循严格的命名模式。然而，我们建议为YAML文件使用<code>.yaml</code>后缀，为模板助手使用<code>.tpl</code>后缀。</p>
<p>上述YAML文件是一个最基本的ConfigMap，最有最小的必要的字段。它会通过模板引擎进行发送。</p>
<p>一个普通的平YAML文件是蛮好的。当Helm读取此模板，它会简单地将文件原样发送给k8s。</p>
<p>在这个简单的例子中，我们现在有了一个可安装的chart包。安装一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">helm install full-coral mychart</span><br><span class="line">NAME: full-coral</span><br><span class="line">LAST DEPLOYED: Sun Sep 27 10:38:03 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm ls</span><br><span class="line">NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span><br><span class="line">full-coral      default         1               2020-09-27 10:38:03.546664865 +0800 CST deployed        mychart-0.1.0   1.16.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm get manifest full-coral</span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mychart-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: &quot;Hello World&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get configmap</span><br><span class="line">NAME                DATA   AGE</span><br><span class="line">mychart-configmap   1      9m47s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 卸载</span><br><span class="line">helm uninstall full-coral</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>添加一个简单的模板调用</strong></p>
<p>Adding a Simple Template Call</p>
<p>硬编码的<code>name</code>，通常被认为是不好的做法。每个发行版的名称应该是唯一的。因此，我们可能将生成一个名称字段来写入发行版名称。</p>
<p>注意，由于DNS系统的限制，<code>name</code>字段被限制为63字符。出于这个原因，发行版名称被限制为53字符。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 模板指令放置于&#123;&#123; xxx &#125;&#125; 块内</span><br><span class="line">helm install clunky-serval mychart/</span><br><span class="line">NAME: clunky-serval</span><br><span class="line">LAST DEPLOYED: Sun Sep 27 11:16:20 2020</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm get manifest clunky-serval</span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: clunky-serval-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: &quot;Hello World&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 可使用--debug查看详情</span><br><span class="line"># 下面将渲染模板，返回渲染输出，不会真正安装</span><br><span class="line">helm install --debug --dry-run goodly-guppy ./mychart</span><br></pre></td></tr></table></figure>
<p>使用<code>--dry-run</code>将更容易对代码进行测试，但它不会保证k8s会接受你生成的模板。</p>
<p><br><br><br></p>
<h2 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a>内置对象</h2><p>Built-in Objects: <a href="https://helm.sh/docs/chart_template_guide/builtin_objects/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/builtin_objects/</a></p>
<p>对象动模板引擎传递到模板。你的代码可以传递对象范围（如<code>with</code>和<code>range</code>）。有一些方法可在模板中创建新的对象，如<code>tuple</code>函数。</p>
<p>对象可以很简单，它只有一个值。它们也可以包含其它对象或函数。如，<code>Realease</code>对象可包含几个对象（如<code>Release.Name</code>），<code>Files</code>对象有一些函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- `Release`对象</span><br><span class="line">  - `Release.Name`</span><br><span class="line">  - `Release.Namespace`</span><br><span class="line">  - `Release.IsUpgrade`</span><br><span class="line">  - `Release.IsInstall`</span><br><span class="line">  - `Release.Revision`</span><br><span class="line">  - `Release.Service`：在Helm中，总是Helm</span><br><span class="line">- `Values`: `values.yaml`中传递给模板的值</span><br><span class="line">- `Chart`: `Chart.yaml`文件内容</span><br><span class="line">- `Files`: 访问chart包中非模板的文件</span><br><span class="line">  - `Files.Get`: 通过名称生成文件的函数</span><br><span class="line">  - `Files.GetBytes`</span><br><span class="line">  - `Files.Glob`: 返回文件为列表的函数</span><br><span class="line">  - `Files.Lines`: 一行行读取文件的函数</span><br><span class="line">  - `Files.AsSecrets`: 返回文件内容为base64编码字符串的函数</span><br><span class="line">  - `Files.AsConfig`: 返回文件内容为YAML map的函数</span><br><span class="line">- `Capabilities`</span><br><span class="line">  - `Capabilities.APIVersions`</span><br><span class="line">  - `Capabilities.APIVersions.Has $version`</span><br><span class="line">  - `Capabilities.KubeVersion`, `Capabilities.KubeVersion.Version`</span><br><span class="line">  - `Capabilities.KubeVersion.Major`</span><br><span class="line">  - `Capabilities.KubeVersion.Minor`</span><br><span class="line">- `Template`</span><br><span class="line">  - `Template.Name`</span><br><span class="line">  - `Template.BasePath`</span><br></pre></td></tr></table></figure>
<p>内置的值总以大写字母开头。这与go命名方式保持一致。</p>
<p><br><br><br></p>
<h3 id="值文件"><a href="#值文件" class="headerlink" title="值文件"></a>值文件</h3><p>Values Files: <a href="https://helm.sh/docs/chart_template_guide/values_files/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/values_files/</a></p>
<p><code>Values</code>是一个内置的对象。它提供了访问值并传递到chart包。值文件是平YAML文件。其内容来源于多个源：</p>
<ul>
<li>chart包中的<code>values.yaml</code>文件</li>
<li>如果是一个subchart包，则为parent chart包的<code>values.yaml</code>文件</li>
<li>通过<code>helm install/upgrade</code>的<code>-f myvals.yaml</code>传递值</li>
<li>通过<code>helm install/upgrade</code>的<code>--set foo=bar</code>选项传递值</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values.yaml</span></span><br><span class="line"><span class="attr">favoriteDrink:</span> <span class="string">coffee</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favoriteDrink</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 渲染</span><br><span class="line">helm install geared-marsupi ./mychart --dry-run --debug</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: geared-marsupi-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: &quot;Hello World&quot;</span><br><span class="line">  drink: coffee</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 通过命令行选项覆盖值</span><br><span class="line">helm install solid-vulture ./mychart --dry-run --debug --set favoriteDrink=slurm</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: solid-vulture-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: &quot;Hello World&quot;</span><br><span class="line">  drink: slurm</span><br></pre></td></tr></table></figure>
<p>值文件也可以包含更多结构化的内容。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">coffee</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">pizza</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>虽然结构化数据这种方式是可行的，但建议你保持值的浅度(shallow)，有利于平整。当看到subcharts包的值时，我们将看到值是如何使用树状结构命名的。</p>
<p><br><br><br></p>
<h3 id="删除一个默认键"><a href="#删除一个默认键" class="headerlink" title="删除一个默认键"></a>删除一个默认键</h3><p>Deleting a default key</p>
<p>如果你需要从默认值删除一个键，你可以覆盖这个键的值为<code>null</code>，在这种情况下，Helm将从覆盖值得合并中移除这个键。</p>
<p><br><br><br></p>
<h2 id="模板函数和管道"><a href="#模板函数和管道" class="headerlink" title="模板函数和管道"></a>模板函数和管道</h2><p>Template Functions and Pipelines: <a href="https://helm.sh/docs/chart_template_guide/functions_and_pipelines/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/functions_and_pipelines/</a></p>
<p>到目前为止，我们以将看到如何将信息转换为模板。但这些信息放入未修改的模板。有时候，我们希望以一种更可用的方式来转换提供的数据。</p>
<p>在模板指令中调用<code>quote</code>函数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">quote</span> <span class="string">.Values.favorite.drink</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">quote</span> <span class="string">.Values.favorite.food</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>模板函数使用<code>funcationName arg1 arg2...</code>语法。上面的<code>quote .Values.favorite.drink</code>调用<code>quote</code>函数并传递一个参数。</p>
<p>Helm有超过60个可用的函数。一些通过go模板语言定义。大多数是Sprig template library的一部分。</p>
<p><br></p>
<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>pipelines(<code>|</code>)</p>
<p>模板语言的一个强大功能就是它的管道(<code>|</code>)。管道是让几件事情依序进行的有效方式。让我们使用管道重写上面的示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| quote &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>使用管道，我们可以将多个函数链接在一起：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| repeat 5 | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#drink: "coffeecoffeecoffeecoffeecoffee"</span></span><br><span class="line"><span class="string">#food: "PIZZA"</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="default函数"><a href="#default函数" class="headerlink" title="default函数"></a>default函数</h3><p><code>default</code>函数经常在模板中使用(<code>default DEFAULT_VALUE GIVEN_VALUE</code>)。此函数允许你指定一个默认值。有则替换它，无则使用默认值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>在实际的chart包中，所有静态默认值都应该位于<code>values.yaml</code>中，而不应该使用<code>default</code>重复。然而，<code>default</code>命令对于不能在<code>values.yaml</code>中声明的值，是完美的计算值的方法。例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| default (printf "%s-tea" (include "fullname" .)) &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="lookup函数"><a href="#lookup函数" class="headerlink" title="lookup函数"></a>lookup函数</h3><p><code>lookup</code>函数可用于在正在运行的集群中查找资源。它查找<code>apiVersion</code>, <code>kind</code>, <code>namespace</code>, <code>name</code>到resource或resource list。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># apiVersion, kind, namespace, name都是string</span><br><span class="line"># name, namespace两个是可选的，可以为空进行传递</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 下列将会返回mynamespace对象的注释</span><br><span class="line">(lookup &quot;v1&quot; &quot;Namespace&quot; &quot;&quot; &quot;mynamespace&quot;).metadata.annotations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 当lookup返回一个列表(list)对象时，可以通过items字段访问列表对象</span><br><span class="line">&#123;&#123; range $index, $service := (lookup &quot;v1&quot; &quot;Service&quot; &quot;mynamespace&quot; &quot;&quot;).items &#125;&#125;</span><br><span class="line">    &#123;&#123;/* do something with each service */&#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>当没有找到对象时，则返回一个空值。这可以用于检查对象是否存在。</p>
<p><code>lookup</code>函数使用Helm现有的k8s连接配置来查询k8s。如果调用API server进行交互时返回错误，则Helm的模板处理将失败。</p>
<p>请记住，Helm是不应该在<code>helm template</code>或<code>helm install|update|delete|rollback --dry-run</code>期间连接到k8s API server，因此，<code>lookup</code>在此情况下将会获得一个空列表。</p>
<p><br><br><br></p>
<h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><p>Operators are functions</p>
<p>对于模板，操作符(<code>eq</code>, <code>ne</code>, <code>lt</code>, <code>gt</code>, <code>and</code>, <code>or</code>等)都被实现为函数。在管道中，操作符可使用括号<code>()</code>进行分组。</p>
<p><br><br><br></p>
<h2 id="函数列表"><a href="#函数列表" class="headerlink" title="函数列表"></a>函数列表</h2><p>Template Function List: <a href="https://helm.sh/docs/chart_template_guide/function_list/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/function_list/</a></p>
<p>Helm包含很多模板函数，你可以在模板中使用它们。下面按照功能列出：</p>
<ul>
<li>Cryptographic and Security</li>
<li>Date</li>
<li>Dictionaries</li>
<li>Encoding</li>
<li>File Path</li>
<li>Kubernetes and Chart</li>
<li>Logic and Flow Control</li>
<li>Lists</li>
<li>Math</li>
<li>Network</li>
<li>Reflection</li>
<li>Regular Expressions</li>
<li>Semantic Versions</li>
<li>String</li>
<li>Type Conversion</li>
<li>URL</li>
<li>UUID</li>
</ul>
<p><br><br><br></p>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>Flow Control: <a href="https://helm.sh/docs/chart_template_guide/control_structures/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/control_structures/</a></p>
<p>控制结构（在模板原语中称为行动）提供给模板作者，模板生成的控制流程的能力。Helm的模板语言提供了如下控制结构：</p>
<ul>
<li><code>if</code>, <code>else</code>：创建条件块</li>
<li><code>with</code>：指定一个范围</li>
<li><code>range</code>： 提供一个类似的for循环</li>
</ul>
<p>除此之外，它为声明和使用命名模板段提供了一些动作：</p>
<ul>
<li><code>define</code>：在模板内声明一个新的命名模板</li>
<li><code>template</code>：导入一个命名的模板</li>
<li><code>block</code>：声明一个特殊的可填写的模板区域</li>
</ul>
<p>这些都让我想起之前用Django模板语言写前端的时候，基本上一样的原理。</p>
<p><br></p>
<h3 id="if和else"><a href="#if和else" class="headerlink" title="if和else"></a>if和else</h3><p><code>if</code>, <code>else</code>块示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">if</span> <span class="string">PIPELINE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># Do something</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">else</span> <span class="string">if</span> <span class="string">OTHER</span> <span class="string">PIPELINE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># Do something else</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">else</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># Default case</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123; if eq .Values.favorite.drink "coffee" &#125;&#125;</span>mug: true<span class="template-variable">&#123;&#123; end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="控制空格"><a href="#控制空格" class="headerlink" title="控制空格"></a>控制空格</h3><p>Controlling Whitespace</p>
<p>虽然我们看到了条件语句，我们也应该了解模板中的空格的控制方式。这主要是确保对于生成的YAML文件的缩进的正确性。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123; if eq .Values.favorite.drink "coffee" &#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">    mug:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>生成的不正确的YAML格式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">eyewitness-elk-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">"coffee"</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">"PIZZA"</span></span><br><span class="line"><span class="attr">    mug:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>mug被不正确地缩进。让我们修改模板：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123; if eq .Values.favorite.drink "coffee" &#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">  mug:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样生成的YAML是有效的，但显得很滑稽：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">telling-chimp-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">"coffee"</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">"PIZZA"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  mug:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>请注意，在YAML文件中生成了几个空行。为什么？当模板引擎运行时，它将删除花括号里的内容，但它留下的剩余空格完全一样。</p>
<p><br></p>
<p>YAML对空白很在意，所以管理空白变得非常重要。幸运的是，Helm有一些工具来帮助我们。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 首先，模板声明的花括号 &#123;&#123; 可以使用特殊字符进行修改，来告诉模板引擎排列空白</span><br><span class="line">&#123;&#123;- 表示空白应靠左(chomped left)</span><br><span class="line">-&#125;&#125; 表示空白应在右边消耗(right should be consumed)</span><br><span class="line"># 注意，换行也是空白（Newlines are whitespace)</span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- if eq .Values.favorite.drink "coffee" &#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">  mug:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Source: mychart/templates/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: clunky-cat-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: &quot;Hello World&quot;</span><br><span class="line">  drink: &quot;coffee&quot;</span><br><span class="line">  food: &quot;PIZZA&quot;</span><br><span class="line">  mug: true</span><br></pre></td></tr></table></figure>
<p>小心使用排列修改器(chomping modifier)。很容易不小心做了下面的事情：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">food:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.favorite.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string"><span class="template-variable">&#123;&#123;- if eq .Values.favorite.drink "coffee" -&#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="bullet">-&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这会生成<code>food: &quot;PIZZA&quot;mug:true</code>这样，因为它消耗了两侧的换行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 最后，有时很容易告诉模板系统如何缩进，而不是试图掌握模板指令的空格。</span><br><span class="line"># 出于此原因，你有时可能会发现使用 indent函数 处理缩进是很有用的</span><br><span class="line">&#123;&#123; indent 2 &quot;mug: true&quot; &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="使用with修改范围"><a href="#使用with修改范围" class="headerlink" title="使用with修改范围"></a>使用with修改范围</h3><p>Modifying scope using with</p>
<p>另一个控制结构是<code>with</code>动作。这可以控制变量的范围，<code>.</code>是指的当前范围。因此，<code>.Values</code>告诉模板到当前范围下去寻找<code>Values</code>对象。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># with语法和if语句类似</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">with</span> <span class="string">PIPELINE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># restricted scope</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>范围可以被更改。<code>with</code>可以允许你将当前范围(<code>.</code>)设置为特定对象。例如，我们使用<code>.Values.favorite</code>工作。让我们在<code>.Values.favorite</code>范围来重写ConfigMap：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 注意，由于我们使用 with 将范围设置在了 .Values.favorite</span><br><span class="line"># 所以我们使用 .drink, .food。范围在 &#123;&#123; end &#125;&#125; 后被还原</span><br></pre></td></tr></table></figure>
<p>但这里有一个值得注意的问题！在限制的范围内，你将无法从父对象范围(<code>.</code>)访问其它对象。以下示例会失败：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">food:</span> <span class="string">&#123;&#123;</span> <span class="string">.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">release:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">release-2:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>由于<code>Release.Name</code>没有在限制的范围(<code>.</code>)内，会报错。但在限制的之外就没有问题。</p>
<p>或者，我们可以使用<code>$</code>符号从父范围访问<code>Release.Name</code>对象。<code>$</code>符号在开始执行时会映射到根范围内，在模板执行时也不会改变。示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">food:</span> <span class="string">&#123;&#123;</span> <span class="string">.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">release:</span> <span class="string">&#123;&#123;</span> <span class="string">$.Release.Name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>在了解<code>range</code>后，我们会看到模板变量，它提供了一个解决上述作用域问题的方法。</p>
<p><br><br><br></p>
<h3 id="range循环"><a href="#range循环" class="headerlink" title="range循环"></a>range循环</h3><p>Looping with the range action</p>
<p>许多编程语言都是用<code>for</code>循环，在Helm模板语言中，它使用<code>range</code>操作符来实现迭代。</p>
<p>首先，让我们在<code>values.yaml</code>文件里添加一个列表。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">coffee</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">mushrooms</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cheese</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">peppers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">onions</span></span><br></pre></td></tr></table></figure>
<p>在我们的ConfigMap中获取值里面的列表：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">  toppings:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">ranage</span> <span class="string">.Values.pizzaToppings</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;&#123;</span> <span class="string">.</span> <span class="string">| title | quote &#125;&#125;</span></span><br><span class="line"><span class="string">    <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>我们可以使用<code>$</code>来访问父范围内的<code>Values.pizzaToppings</code>。<code>$</code>符号映射到根目录下，并在函数执行时不会改变。示例如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">$.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  toppings:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$.Values.pizzaToppings</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;&#123;</span> <span class="string">.|</span> <span class="string">title</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string">    <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>渲染示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">edgy-dragonfly-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">"coffee"</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">"PIZZA"</span></span><br><span class="line"><span class="attr">  toppings:</span> <span class="string">|-</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"Mushrooms"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"Cheese"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"Peppers"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"Onions"</span></span><br></pre></td></tr></table></figure>
<p>符号<code>|-</code>声明一个多行字符串。因此，实际上我们的toppings不是一个YAML list，而是一个big string。我们为什么要这样做？因为在ConfigMaps <code>data</code>里的数据是由键值对(k/v)组成，其中键和值都是简单的字符串。要理解为什么这样的化，请查看k8s configmap文档。</p>
<p>YAML里的<code>|-</code>符号表示一个多行字符串(multi-line string)。这可以在文件中嵌入一大块数据。</p>
<p>Helm模板具有一个<code>tuple</code>函数，来使得操作更简单。让我想起了Python中的tuple数据类型。示例如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sizes:</span> <span class="string">|-</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">ruple</span> <span class="string">"small"</span> <span class="string">"medium"</span> <span class="string">"large"</span><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">&#123;&#123;</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sizes:</span> <span class="string">|-</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">small</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">medium</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">large</span></span><br></pre></td></tr></table></figure>
<p>除了list和tuple，<code>range</code>还可以迭代具有有键值对的map和dict。我们将在后面的章节中了解它们。</p>
<p><br><br><br><br><br></p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>Variables: <a href="https://helm.sh/docs/chart_template_guide/variables/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/variables/</a></p>
<p>我们可以在模板中使用变量。在Helm模板中，变量是其它对象的命名引用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Releae.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">$relname</span> <span class="string">:=</span> <span class="string">.Release.Name</span> <span class="bullet">-&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">&#123;&#123;</span> <span class="string">.drink</span> <span class="string">| default "tea" | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  food:</span> <span class="string">&#123;&#123;</span> <span class="string">.food</span> <span class="string">| upper | quote &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  release:</span> <span class="string">&#123;&#123;</span> <span class="string">$relname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>在<code>with</code>块之前，我们赋值了一个变量。在<code>with</code>块内，<code>$relname</code>变量仍然指向版本名称。</p>
<p>在<code>range</code>循环中使用变量：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">toppings:</span> <span class="string">|-</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$index,</span> <span class="string">$topping</span> <span class="string">:=</span> <span class="string">.Values.pizzaToppings</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">$index</span> <span class="string">&#125;&#125;:</span> <span class="string">&#123;&#123;</span> <span class="string">$topping</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>渲染效果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">toppings:</span> <span class="string">|-</span></span><br><span class="line">    <span class="number">0</span><span class="string">:</span> <span class="string">mushrooms</span></span><br><span class="line">    <span class="number">1</span><span class="string">:</span> <span class="string">cheese</span></span><br><span class="line">    <span class="number">2</span><span class="string">:</span> <span class="string">peppers</span></span><br><span class="line">    <span class="number">3</span><span class="string">:</span> <span class="string">onions</span></span><br></pre></td></tr></table></figure>
<p>有一个变量(<code>$</code>)它永远是全局的，此变量将永远指向根上下文(root context)。放你使用<code>range</code>循环，并且需要知道chart的版本名称时，这非常有用。示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">.Values.tlsSecrets</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="comment"># Many helm templates would use `.` below, but that will not work,</span></span><br><span class="line">    <span class="comment"># however `$` will work here</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"fullname"</span> <span class="string">$</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="comment"># I cannot reference .Chart.Name, but I can do $.Chart.Name</span></span><br><span class="line">    <span class="string">helm.sh/chart:</span> <span class="string">"<span class="template-variable">&#123;&#123; $.Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; $.Chart.Version &#125;&#125;</span>"</span></span><br><span class="line">    <span class="string">app.kubernetes.io/instance:</span> <span class="string">"<span class="template-variable">&#123;&#123; $.Release.Name &#125;&#125;</span>"</span></span><br><span class="line">    <span class="comment"># Value from appVersion in Chart.yaml</span></span><br><span class="line">    <span class="string">app.kubernetes.io/version:</span> <span class="string">"<span class="template-variable">&#123;&#123; $.Chart.AppVersion &#125;&#125;</span>"</span></span><br><span class="line">    <span class="string">app.kubernetes.io/managed-by:</span> <span class="string">"<span class="template-variable">&#123;&#123; $.Release.Service &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">tls.crt:</span> <span class="string">&#123;&#123;</span> <span class="string">.certificate</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">tls.key:</span> <span class="string">&#123;&#123;</span> <span class="string">.key</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>到目前为止，我们已看到了只在一个文件中声明的模板。但是Helm模板语言的一个强大功能是声明多个模板和使用它们。我们将在后面的章节了解到。</p>
<p><br><br><br><br><br></p>
<h2 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h2><p>Named Templates: <a href="https://helm.sh/docs/chart_template_guide/named_templates/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/named_templates/</a></p>
<p>是时候使用多个模板了。本章中，我们将在一个文件中命名模板，然后在其它地方使用它们。这让我想起了Python写Web是的模板。命名模板（有时称为子模板）是在文件中定义的一个简单的模板。有两种方法来创建它，有几种不同的方法来使用它。</p>
<p>在流程控制(flow control)章节，我们介绍了<code>define</code>, <code>template</code>, <code>block</code>这三个声明和管理模板的动作。在本章中，我们将讨论这三种动作，并引入一种特殊目的的<code>include</code>函数。</p>
<p>命名模板的一个重要细节：模板名称是全局的。如果声明了两个相同名称的模板，whichever one is loaded last will be the one used. 由于subcharts中的模板与顶级模板一起编译，你应该小心命名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 一种流行的命名约定是使用chart名作为前缀：</span><br><span class="line">&#123;&#123; define &quot;mychart.labels&quot; &#125;&#125;</span><br><span class="line"># 通过使用特定的chart名称作为前缀，我们可以避免相同模板名称所带来的冲突</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="下划线文件"><a href="#下划线文件" class="headerlink" title="下划线文件"></a>下划线文件</h3><p>Partials and <code>_</code> files</p>
<p>目前为止，我们使用的一个文件中包含一个模板。但是Helm模板语言允许你创建命名嵌套模板，可通过名称在其它任何地方进行访问。</p>
<p>在我们开始编写这些模板之前，我们需要注意一下命名规范：</p>
<ul>
<li><code>templates/</code>下的大多数文件被视为包含k8s manifests</li>
<li><code>NOTES.txt</code>是一个例外</li>
<li>以下划线(<code>_</code>)开头的文件被假定为不包含k8s manifests。这些文件不会被渲染为k8s对象定义，但可在任意chart templates中使用。</li>
</ul>
<p>这些文件用来存储特定(partials)和助手(helpers)。实际上，当我们第一次创建<code>mychart</code>，我们会看到<code>_helpers.tpl</code>文件，此文件是默认的template partials。</p>
<p><br><br><br></p>
<h3 id="声明和使用模板"><a href="#声明和使用模板" class="headerlink" title="声明和使用模板"></a>声明和使用模板</h3><p>Declaring and using templates with <code>define</code> and <code>template</code>。</p>
<p><code>define</code>动作允许我们在一个模板文件中创建命名模板(named template)。语法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;MY.NAME &quot;&#125;&#125;</span><br><span class="line">  # body of template here</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">define</span> <span class="string">"mychart.labels"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    generator:</span> <span class="string">helm</span></span><br><span class="line"><span class="attr">    data:</span> <span class="string">&#123;&#123;</span> <span class="string">now</span> <span class="string">| htmlDate &#125;&#125;</span></span><br><span class="line"><span class="string"><span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">template</span> <span class="string">"mychart.labels"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  data:</span></span><br><span class="line"><span class="attr">    myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$key,</span> <span class="string">$va1</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">$key</span> <span class="string">&#125;&#125;:</span> <span class="string">&#123;&#123;</span> <span class="string">$va1</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string">    <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>渲染之后的效果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">running-panda-configmap</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    generator:</span> <span class="string">helm</span></span><br><span class="line"><span class="attr">    date:</span> <span class="number">2016</span><span class="bullet">-11</span><span class="bullet">-02</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">"coffee"</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">"pizza"</span></span><br></pre></td></tr></table></figure>
<p><code>define</code>仅定义，只有在模板中调用时才会产生输出。</p>
<p>按照惯例，Helm charts将这些模板放在partials文件中（通常是<code>_helpers.tpl</code>），如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;/* Generate basic labels */&#125;&#125;</span><br><span class="line">&#123;&#123;- define &quot;mychart.labels&quot; &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    generator: helm</span><br><span class="line">    date: &#123;&#123; now | htmlDate &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 按照管理，define函数 应该有一个简单的文档块 &#123;&#123;/*...*/&#125;&#125;</span><br><span class="line"># 如上。然后在其它模板文件中访问它。</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="设置模板范围"><a href="#设置模板范围" class="headerlink" title="设置模板范围"></a>设置模板范围</h3><p>Setting the scope of a template</p>
<p>在上面定义的模板中，我们没有使用任何对象。让我们做些修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;/* Generate basic labels */&#125;&#125;</span><br><span class="line">&#123;&#123;- define &quot;mychart.labels&quot; &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    generator: helm</span><br><span class="line">    data: &#123;&#123; now | htmlData &#125;&#125;</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    version: &#123;&#123; .Chart.Version &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上面定义的名称和版本是动态的，会根据不同的模板生成不同的值。</p>
<p>之前的引用并没有床底范围，因此在模板内我们不能使用<code>.</code>来访问任何事物。现在我们对模板加上范围:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">template</span> <span class="string">"mychart.labels"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>注意上面在模板调用处使用的点(<code>.</code>)。我们可以非常容易地传递<code>.Values</code>或<code>.Values.favorite</code>或任何我们需要的范围。但是，我们需要的是顶级范围。</p>
<p>现在运行渲染(<code>helm install --dry-run --debug plinking-anaco ./mychart</code>)来预览下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">plinking-anaco-configmap</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    generator:</span> <span class="string">helm</span></span><br><span class="line"><span class="attr">    date:</span> <span class="number">2016</span><span class="bullet">-11</span><span class="bullet">-02</span></span><br><span class="line"><span class="attr">    chart:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">    version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="include"><a href="#include" class="headerlink" title="include"></a>include</h3><p>The <code>include</code> function</p>
<p>假设我们定义了如下一个简单模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- define &quot;mychart.app&quot; -&#125;&#125;</span><br><span class="line">app_name: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">app_version: &quot;&#123;&#123; .Chart.Version &#125;&#125;&quot;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>一个错误的栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"mychart.app"</span> <span class="string">.</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$key,</span> <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">$key</span> <span class="string">&#125;&#125;:</span> <span class="string">&#123;&#123;</span> <span class="string">$val</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br><span class="line"><span class="string"><span class="template-variable">&#123;&#123; template "mychart.app" . &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>渲染的结果并不正确：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">measly-whippet-configmap</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app_name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">app_version:</span> <span class="string">"0.1.0+1478129847"</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">"coffee"</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">"pizza"</span></span><br><span class="line"><span class="attr">  app_name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">app_version:</span> <span class="string">"0.1.0+1478129847"</span></span><br></pre></td></tr></table></figure>
<p>Because the template that is substituted in has the text aligned to the right. Because template is an action, and not a function, there is no way to pass the output of a template call to other functions; the data is simply inserted inline.</p>
<p>To work around this case, Helm provides an alternative to template that will import the contents of a template into the present pipeline where it can be passed along to other functions in the pipeline.</p>
<p>因为模板是靠右对齐的文本，因为<code>template</code>是一个动作，不是一个函数，因此无法传递调用其它函数的<code>template</code>的输出，数据被简单的插入内联。</p>
<p><br></p>
<p>现在我们需要使用<code>ident</code>来告诉模板正确的缩进，栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">include</span> <span class="string">"mychart.app"</span> <span class="string">.</span> <span class="string">| indent 4 &#125;&#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$key,</span> <span class="string">$va1</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">$key</span> <span class="string">&#125;&#125;:</span> <span class="string">&#123;&#123;</span> <span class="string">$val</span> <span class="string">| quote &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123; include "mychart.app" . | indent 2 &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>正确的渲染结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">edgy-mole-configmap</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app_name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">    app_version:</span> <span class="string">"0.1.0+1478129987"</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  myvalue:</span> <span class="string">"Hello World"</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">"coffee"</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">"pizza"</span></span><br><span class="line"><span class="attr">  app_name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">  app_version:</span> <span class="string">"0.1.0+1478129987"</span></span><br></pre></td></tr></table></figure>
<p>在Helm template中使用<code>include</code>对<code>template</code>被认为更好，这使得输出格式可以为YAML文档更好地处理。</p>
<p>有时候，我们想要导入内容，但不作为模板。也就是逐字导入文件。我们可以通过<code>.Files</code>对象访问文件来实现这一目标。</p>
<p><br><br><br></p>
<h2 id="在模板内访问文件"><a href="#在模板内访问文件" class="headerlink" title="在模板内访问文件"></a>在模板内访问文件</h2><p>Accessing Files Inside Templates: <a href="https://helm.sh/docs/chart_template_guide/accessing_files/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/accessing_files/</a></p>
<p>Helm提供了<code>.Files</code>对象来访问文件。在开始模板示例之前，有些事需要注意下：</p>
<ul>
<li>可以添加额外的文件到Helm chart。这些文件将被捆绑。要注意，charts必须小于1MB，因为k8s对象的存储限制。</li>
<li>某些文件无法通过<code>.Files</code>对象访问，通常出于安全原因<ul>
<li><code>templates/</code>目录内的文件无法访问</li>
<li><code>.helmignore</code>中包含的文件无法访问</li>
</ul>
</li>
<li>Charts不保留UNIX mode信息，当设计到<code>.Files</code>对象时，文件级别的权限对一个文件的可用性没有影响。</li>
</ul>
<p><br></p>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><p>Basic example</p>
<p>添加三个位于<code>mychart/</code>目录下的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># config1.toml</span><br><span class="line">message = Hello from config 1</span><br><span class="line"></span><br><span class="line"># config1.tom2</span><br><span class="line">message = Hello from config 2</span><br><span class="line"></span><br><span class="line"># config1.tom3</span><br><span class="line">message = Goodbye from config 3</span><br></pre></td></tr></table></figure>
<p>在模板中访问文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">$files</span> <span class="string">:=</span> <span class="string">.Files</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">tuple</span> <span class="string">"config1.tom1"</span> <span class="string">"config2.toml"</span> <span class="string">"config3.toml"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">.&#125;&#125;:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">$files.Get</span> <span class="string">.&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 首先，创建了一个 $files变量 来保存.Files对象的引用</span><br><span class="line"># 我们同样使用 tuple函数来创建循环的文件列表</span><br><span class="line"># 接着打印每个文件名 &#123;&#123; . &#125;&#125;: |- 后面接着文件内容 &#123;&#123; $files.Get . &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>渲染效果示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">quieting-giraf-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">config1.toml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">message</span> <span class="string">=</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">config</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="string">config2.toml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">message</span> <span class="string">=</span> <span class="string">This</span> <span class="string">is</span> <span class="string">config</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  <span class="string">config3.toml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">message</span> <span class="string">=</span> <span class="string">Goodbye</span> <span class="string">from</span> <span class="string">config</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="路径助手"><a href="#路径助手" class="headerlink" title="路径助手"></a>路径助手</h3><p>Path helpers</p>
<p>使用文件时，对文件路径执行一些标准的操作是有用的。为了帮助处理，Helm从go path包中引入了许多函数供你使用:</p>
<ul>
<li><code>Base</code></li>
<li><code>Dir</code></li>
<li><code>Ext</code></li>
<li><code>IsAbs</code></li>
<li><code>Clean</code></li>
</ul>
<p><br><br><br></p>
<h3 id="Glob模式"><a href="#Glob模式" class="headerlink" title="Glob模式"></a>Glob模式</h3><p>Glob patterns</p>
<p>随着你的chart包的增长，你会发现你有一个更大的需来组织你的文件，因此我们提供了<code>Files.Glob(pattern string)</code>方法，以帮助提取某些文件与glob patterns的所有灵活性。</p>
<p><code>.Glob</code>返回一个<code>Files</code>类型，因此你可以在返回的对象上调用任意<code>Files</code>方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 示例的目录结构</span><br><span class="line">foo/:</span><br><span class="line">  foo.txt foo.yaml</span><br><span class="line"></span><br><span class="line">bar/:</span><br><span class="line">  bar.go bar.conf baz.yaml</span><br></pre></td></tr></table></figure>
<p>使用Globs的多种选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; $currentScope := .&#125;&#125;</span><br><span class="line">&#123;&#123; range $path, $_ :=  .Files.Glob  &quot;**.yaml&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- with $currentScope&#125;&#125;</span><br><span class="line">        &#123;&#123; .Files.Get $path &#125;&#125;</span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>或者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; range $path, $_ :=  .Files.Glob  &quot;**.yaml&quot; &#125;&#125;</span><br><span class="line">      &#123;&#123; $.Files.Get $path &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="ConfigMap和Secrets的实用功能"><a href="#ConfigMap和Secrets的实用功能" class="headerlink" title="ConfigMap和Secrets的实用功能"></a>ConfigMap和Secrets的实用功能</h3><p>ConfigMap and Secrets utility functions</p>
<p>将文件内容放置到K8s ConfigMap或Secrets中非常常见，然后在运行的时候挂载到容器。为了帮助实现此功能，我们在<code>Files</code>类型上提供了几种实用的方法：</p>
<ul>
<li><code>AsCoinfig</code></li>
<li><code>AsSecrets</code></li>
</ul>
<p>栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">(.Files.Glob</span> <span class="string">"foo/*"</span><span class="string">).AsConfig</span> <span class="string">| indent 2 &#125;&#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">very-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">(.Files.Glob</span> <span class="string">"bar/*"</span><span class="string">).AsSecrets</span> <span class="string">| indent 2 &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><p>Encoding</p>
<p>你可以导入一个文件，并实用base64编码来确保成功传输：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">.Files.Get</span> <span class="string">"config1.toml"</span> <span class="string">| b64enc &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>渲染后的效果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">lucky-turkey-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">bWVzc2FnZSA9IEhlbGxvIGZyb20gY29uZmlnIDEK</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="行"><a href="#行" class="headerlink" title="行"></a>行</h3><p>Lines</p>
<p>有时候需要在模板中访问一个文件中的每行内容。我们为此提供了<code>Lines</code>方法。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">some-file.txt:</span> <span class="string">&#123;&#123;</span> <span class="string">range</span> <span class="string">.Files.Lines</span> <span class="string">"foo/bar.txt"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="string">&#123;&#123;</span> <span class="string">.</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="NOTES-txt"><a href="#NOTES-txt" class="headerlink" title="NOTES.txt"></a>NOTES.txt</h2><p>Creating a NOTES.txt File: <a href="https://helm.sh/docs/chart_template_guide/notes_files/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/notes_files/</a></p>
<p>在<code>helm install</code>或<code>helm upgrade</code>结束，Helm可以为用户打印一块有用的信息。此信息使用模板且高度可定制。</p>
<p>要为你的chart包添加安装说明，简单地创建一个<code>templates/NOTES.txt</code>文件。此文件是纯文本文件，但它像作为模板一样处理，并可访问所有正常模板函数和对象。</p>
<p><code>NOTES.txt</code>文件示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Thank you for installing &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line"></span><br><span class="line">Your release is named &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line"></span><br><span class="line">To learn more about the release, try:</span><br><span class="line">  $ helm status &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  $ helm get all &#123;&#123; .Release.Name &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>接下来运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">helm install rude-cardinal ./mychart</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                   TYPE      DATA      AGE</span><br><span class="line">rude-cardinal-secret   Opaque    1         0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                      DATA      AGE</span><br><span class="line">rude-cardinal-configmap   3         0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">Thank you for installing mychart.</span><br><span class="line"></span><br><span class="line">Your release is named rude-cardinal.</span><br><span class="line"></span><br><span class="line">To learn more about the release, try:</span><br><span class="line"></span><br><span class="line">  $ helm status rude-cardinal</span><br><span class="line">  $ helm get all rude-cardinal</span><br></pre></td></tr></table></figure>
<p>强烈建议创建<code>NOTES.txt</code>文件，以帮助用户获得chart包的有用信息。</p>
<p><br><br><br></p>
<h2 id="Subcharts"><a href="#Subcharts" class="headerlink" title="Subcharts"></a>Subcharts</h2><p>Subcharts and Global Values: <a href="https://helm.sh/docs/chart_template_guide/subcharts_and_globals/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/subcharts_and_globals/</a></p>
<p>之前我们只有一个chart，但charts可能会有依赖(dependencies)，称为subcharts。subcharts也有自己的值和模板。本章我们将会创建subchart，并看看我们可以从模板访问值的不同的方式。</p>
<p>subcharts的一些重要详情：</p>
<ul>
<li>一个subchart被认为是独立的(stand-alone)，这意味着一个subchart不能明确依赖它的parent chart</li>
<li>出于此原因，subchart不能访问parent chart的值</li>
<li>parent chart可以覆盖subcharts的值</li>
<li>Helm有一个全局值(global values)的概念，这些全局值可被所有charts访问</li>
</ul>
<p><br></p>
<h3 id="创建一个subchart"><a href="#创建一个subchart" class="headerlink" title="创建一个subchart"></a>创建一个subchart</h3><p>Creating a Subchart</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mychart/charts</span><br><span class="line"></span><br><span class="line">helm create mysubchart</span><br><span class="line"></span><br><span class="line">rm -rf mysubchart/templates/*.*</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="对subchart添加值和模板"><a href="#对subchart添加值和模板" class="headerlink" title="对subchart添加值和模板"></a>对subchart添加值和模板</h3><p>Adding Values and a Template to the Subchart</p>
<p>为subchart添加一个简单的值和模板：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values.yaml</span></span><br><span class="line"><span class="attr">dessert:</span> <span class="string">cake</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-cfgmap2</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  dessert:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.dessert</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>因为每个subchart都是独立的chart，我们可以测试mysubchart：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">helm install --generate-name --dry-run --debug mychart/charts/mysubchart</span><br><span class="line">SERVER: <span class="string">"localhost:44134"</span></span><br><span class="line">CHART PATH: /Users/mattbutcher/Code/Go/src/helm.sh/helm/_scratch/mychart/charts/mysubchart</span><br><span class="line">NAME:   newbie-elk</span><br><span class="line">TARGET NAMESPACE:   default</span><br><span class="line">CHART:  mysubchart 0.1.0</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: mysubchart/templates/configmap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: newbie-elk-cfgmap2</span><br><span class="line">data:</span><br><span class="line">  dessert: cake</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="从parent-chart覆盖值"><a href="#从parent-chart覆盖值" class="headerlink" title="从parent chart覆盖值"></a>从parent chart覆盖值</h3><p>现在，mychart是mysubchart的parent chart。因为mychart是parent chart，我们可以在mychart中指定配置，并将配置推送到mysubchart中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mychart/values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">coffee</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">mushrooms</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cheese</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">peppers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">onions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysubchart:</span></span><br><span class="line"><span class="attr">  dessert:</span> <span class="string">ice</span> <span class="string">cream</span></span><br></pre></td></tr></table></figure>
<p>我们在parent chart(mychart)的值文件里添加了mysubchart的值，mysubchart这部分值会发送到mysubchart包，这回覆盖mysubchart的值。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">helm install --dry-run --debug mychart</span><br><span class="line"></span><br><span class="line"><span class="comment"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: unhinged-bee-cfgmap2</span><br><span class="line">data:</span><br><span class="line">  dessert: ice cream</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="全局值"><a href="#全局值" class="headerlink" title="全局值"></a>全局值</h3><p>Global Chart Values</p>
<p>有时候你需要将值提供给所有模板，这可以使用全局值(global chart values)。全局值可被任意chart或subchart通过相同的名称来访问。全局需要明确地声明。</p>
<p>值数据类型保留在称为<code>Values.global</code>的区域，此区域可以设置全局值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mychart/values.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line"><span class="attr">  drink:</span> <span class="string">coffee</span></span><br><span class="line"><span class="attr">  food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">mushrooms</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cheese</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">peppers</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">onions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysubchart:</span></span><br><span class="line"><span class="attr">  dessert:</span> <span class="string">ice</span> <span class="string">cream</span></span><br><span class="line"></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  salad:</span> <span class="string">caesar</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任意chart和subchart都可以使用 &#123;&#123; .Values.global.salad &#125;&#125; 来访问这个值</span></span><br><span class="line"><span class="comment"># mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  salad:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.global.salad</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysubchart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">&#123;&#123;</span> <span class="string">.Release.Name</span> <span class="string">&#125;&#125;-cfgmap2</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  dessert:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.dessert</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  salad:</span> <span class="string">&#123;&#123;</span> <span class="string">.Values.global.salad</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>渲染输出效果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">silly-snake-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  salad:</span> <span class="string">caesar</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">silly-snake-cfgmap2</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  dessert:</span> <span class="string">ice</span> <span class="string">cream</span></span><br><span class="line"><span class="attr">  salad:</span> <span class="string">caesar</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="共享模板"><a href="#共享模板" class="headerlink" title="共享模板"></a>共享模板</h3><p>Sharing Templates with Subcharts</p>
<p>parent charts和subcharts可以共享模板。任意在chart中定义的block(块)都可以被其它charts所使用。</p>
<p>定义一个简单的模板栗子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;-</span> <span class="string">define</span> <span class="string">"labels"</span> <span class="string">&#125;&#125;from:</span> <span class="string">mychart</span> <span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>尽管chart开发者可以在<code>include</code>和<code>template</code>之间选择，但使用<code>include</code>的优点是它可以动态引用模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; include $mytemplate &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上面间接引用<code>$mytemplate</code>。<code>template</code>函数，相反它只接受一个字符串。</p>
<p><br><br><br></p>
<h3 id="避免使用块"><a href="#避免使用块" class="headerlink" title="避免使用块"></a>避免使用块</h3><p>Avoid Using Blocks</p>
<p>go模板语言提供了一个<code>block</code>关键字，来允许开发者提供一个覆盖的默认实现。在Helm chart中，块(block)并不是覆盖的最佳工具，因为如果提供了相同块的多个实现，选择的那个是不可预测的。</p>
<p>建议使用<code>include</code>来代替。</p>
<p><br><br><br></p>
<h2 id="helmignore"><a href="#helmignore" class="headerlink" title=".helmignore"></a>.helmignore</h2><p>The .helmignore file: <a href="https://helm.sh/docs/chart_template_guide/helm_ignore_file/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/helm_ignore_file/</a></p>
<p><code>.helmignore</code>也就类似于<code>.gitignore</code>, <code>.dockerignore</code>，指定不需要包含在chart包中的文件。</p>
<p>如果此文件存在，<code>helm package</code>命令将忽略<code>.helmignore</code>里面匹配到的文件打包到应用的包里。</p>
<p>一个<code>.helmignore</code>文件的栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># comment</span><br><span class="line"></span><br><span class="line"># Match any file or path named .git</span><br><span class="line">.git</span><br><span class="line"></span><br><span class="line"># Match any text file</span><br><span class="line">*.txt</span><br><span class="line"></span><br><span class="line"># Match only directories named mydir</span><br><span class="line">mydir/</span><br><span class="line"></span><br><span class="line"># Match only text files in the top-level directory</span><br><span class="line">/*.txt</span><br><span class="line"></span><br><span class="line"># Match only the file foo.txt in the top-level directory</span><br><span class="line">/foo.txt</span><br><span class="line"></span><br><span class="line"># Match any file named ab.txt, ac.txt, or ad.txt</span><br><span class="line">a[b-d].txt</span><br><span class="line"></span><br><span class="line"># Match any file under subdir matching temp*</span><br><span class="line">*/temp*</span><br><span class="line"></span><br><span class="line">*/*/temp*</span><br><span class="line">temp?</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h2 id="模板调试"><a href="#模板调试" class="headerlink" title="模板调试"></a>模板调试</h2><p>Debugging Templates: <a href="https://helm.sh/docs/chart_template_guide/debugging/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/debugging/</a></p>
<p>有几个命令可帮助调试模板：</p>
<ul>
<li><code>helm lint</code>: 验证chart最佳实践的工具</li>
<li><code>helm install --dry-run --debug</code>或<code>helm template --debug</code>：渲染模板并返回k8s manifest文件</li>
<li><code>helm get manifest</code>：查看安装了哪些模板</li>
</ul>
<p><br><br><br></p>
<h2 id="YAML技巧"><a href="#YAML技巧" class="headerlink" title="YAML技巧"></a>YAML技巧</h2><p>YAML Techniques: <a href="https://helm.sh/docs/chart_template_guide/yaml_techniques/" target="_blank" rel="noopener">https://helm.sh/docs/chart_template_guide/yaml_techniques/</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="Helm命令"><a href="#Helm命令" class="headerlink" title="Helm命令"></a>Helm命令</h1><p>Helm Commands: <a href="https://helm.sh/docs/helm/" target="_blank" rel="noopener">https://helm.sh/docs/helm/</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="社区指南"><a href="#社区指南" class="headerlink" title="社区指南"></a>社区指南</h1><p>Community Guides: <a href="https://helm.sh/docs/community/" target="_blank" rel="noopener">https://helm.sh/docs/community/</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>Frequently Asked Questions: <a href="https://helm.sh/docs/faq/" target="_blank" rel="noopener">https://helm.sh/docs/faq/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Helm/" rel="tag"># Helm</a>
          
            <a href="/tags/K8s/" rel="tag"># K8s</a>
          
            <a href="/tags/DevOps/" rel="tag"># DevOps</a>
          
            <a href="/tags/CNCF/" rel="tag"># CNCF</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/22/Go/" rel="next" title="Go">
                <i class="fa fa-chevron-left"></i> Go
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image" src="/images/leslie.jpg" alt="Leslie Zhang">
          
            <p class="site-author-name" itemprop="name">Leslie Zhang</p>
            <p class="site-description motion-element" itemprop="description">那一年我二十一岁，在我一生的黄金时代</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">112</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:me@zhang21.cn" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#术语"><span class="nav-number">2.</span> <span class="nav-text">术语</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">3.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#快速入门"><span class="nav-number">3.1.</span> <span class="nav-text">快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#先决条件"><span class="nav-number">3.1.1.</span> <span class="nav-text">先决条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">3.1.2.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#从Helm项目"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">从Helm项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从源码"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">从源码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化Helm-chart"><span class="nav-number">3.1.3.</span> <span class="nav-text">初始化Helm chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Chart"><span class="nav-number">3.1.4.</span> <span class="nav-text">安装Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Releases"><span class="nav-number">3.1.5.</span> <span class="nav-text">Releases</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#卸载Release"><span class="nav-number">3.1.6.</span> <span class="nav-text">卸载Release</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#主题"><span class="nav-number">4.</span> <span class="nav-text">主题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Charts"><span class="nav-number">4.1.</span> <span class="nav-text">Charts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件结构"><span class="nav-number">4.1.1.</span> <span class="nav-text">文件结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chart-yaml"><span class="nav-number">4.1.2.</span> <span class="nav-text">Chart.yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#许可证和描述"><span class="nav-number">4.1.3.</span> <span class="nav-text">许可证和描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖"><span class="nav-number">4.1.4.</span> <span class="nav-text">依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Templates-and-Values"><span class="nav-number">4.1.5.</span> <span class="nav-text">Templates and Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用户自定义资源"><span class="nav-number">4.1.6.</span> <span class="nav-text">用户自定义资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理chart"><span class="nav-number">4.1.7.</span> <span class="nav-text">管理chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#仓库"><span class="nav-number">4.1.8.</span> <span class="nav-text">仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Starter-Packs"><span class="nav-number">4.1.9.</span> <span class="nav-text">Starter Packs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hooks"><span class="nav-number">4.2.</span> <span class="nav-text">Hooks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#可用的hooks"><span class="nav-number">4.2.1.</span> <span class="nav-text">可用的hooks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试"><span class="nav-number">4.3.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">4.3.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Library"><span class="nav-number">4.4.</span> <span class="nav-text">Library</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#完整性校验"><span class="nav-number">4.5.</span> <span class="nav-text">完整性校验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#仓库-1"><span class="nav-number">4.6.</span> <span class="nav-text">仓库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建仓库"><span class="nav-number">4.6.1.</span> <span class="nav-text">创建仓库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册中心"><span class="nav-number">4.7.</span> <span class="nav-text">注册中心</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构"><span class="nav-number">4.8.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#目的"><span class="nav-number">4.8.1.</span> <span class="nav-text">目的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件"><span class="nav-number">4.8.2.</span> <span class="nav-text">组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现"><span class="nav-number">4.8.3.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级技术"><span class="nav-number">4.9.</span> <span class="nav-text">高级技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#后置渲染"><span class="nav-number">4.9.1.</span> <span class="nav-text">后置渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GO-SDK"><span class="nav-number">4.9.2.</span> <span class="nav-text">GO SDK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后端存储"><span class="nav-number">4.9.3.</span> <span class="nav-text">后端存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC"><span class="nav-number">4.10.</span> <span class="nav-text">RBAC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#管理用户账户"><span class="nav-number">4.10.1.</span> <span class="nav-text">管理用户账户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#角色、集群角色、角色绑定、集群角色绑定"><span class="nav-number">4.10.2.</span> <span class="nav-text">角色、集群角色、角色绑定、集群角色绑定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#限制用户账户使用RBAC访问"><span class="nav-number">4.10.3.</span> <span class="nav-text">限制用户账户使用RBAC访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件"><span class="nav-number">4.11.</span> <span class="nav-text">插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V2迁移到V3"><span class="nav-number">4.12.</span> <span class="nav-text">V2迁移到V3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#弃用的k8s-api"><span class="nav-number">4.13.</span> <span class="nav-text">弃用的k8s api</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#版本支持"><span class="nav-number">4.14.</span> <span class="nav-text">版本支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL存储后端的权限管理"><span class="nav-number">4.15.</span> <span class="nav-text">SQL存储后端的权限管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#最佳实践"><span class="nav-number">5.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一般约定"><span class="nav-number">5.1.</span> <span class="nav-text">一般约定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#chart名称"><span class="nav-number">5.1.1.</span> <span class="nav-text">chart名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#版本号"><span class="nav-number">5.1.2.</span> <span class="nav-text">版本号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#格式化YAML"><span class="nav-number">5.1.3.</span> <span class="nav-text">格式化YAML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#词"><span class="nav-number">5.1.4.</span> <span class="nav-text">词</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#值"><span class="nav-number">5.2.</span> <span class="nav-text">值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#命名约定"><span class="nav-number">5.2.1.</span> <span class="nav-text">命名约定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套值"><span class="nav-number">5.2.2.</span> <span class="nav-text">嵌套值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使类型清晰"><span class="nav-number">5.2.3.</span> <span class="nav-text">使类型清晰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#考虑用户如何使用你的值"><span class="nav-number">5.2.4.</span> <span class="nav-text">考虑用户如何使用你的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#values-yaml"><span class="nav-number">5.2.5.</span> <span class="nav-text">values.yaml</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模板"><span class="nav-number">5.3.</span> <span class="nav-text">模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#templates目录架构"><span class="nav-number">5.3.1.</span> <span class="nav-text">templates目录架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义的模板的名称"><span class="nav-number">5.3.2.</span> <span class="nav-text">定义的模板的名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#格式化模板"><span class="nav-number">5.3.3.</span> <span class="nav-text">格式化模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成模板中的空格"><span class="nav-number">5.3.4.</span> <span class="nav-text">生成模板中的空格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注释"><span class="nav-number">5.3.5.</span> <span class="nav-text">注释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在模板和模板输出中使用JSON"><span class="nav-number">5.3.6.</span> <span class="nav-text">在模板和模板输出中使用JSON</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#依赖-1"><span class="nav-number">5.4.</span> <span class="nav-text">依赖</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#版本"><span class="nav-number">5.4.1.</span> <span class="nav-text">版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#条件和标记"><span class="nav-number">5.4.2.</span> <span class="nav-text">条件和标记</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#标签和注释"><span class="nav-number">5.5.</span> <span class="nav-text">标签和注释</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#标签还是注释"><span class="nav-number">5.5.1.</span> <span class="nav-text">标签还是注释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#标准的标签"><span class="nav-number">5.5.2.</span> <span class="nav-text">标准的标签</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pods和PodTemplates"><span class="nav-number">5.6.</span> <span class="nav-text">Pods和PodTemplates</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像"><span class="nav-number">5.6.1.</span> <span class="nav-text">镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像拉取策略"><span class="nav-number">5.6.2.</span> <span class="nav-text">镜像拉取策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PodTemplate应该声明选择器"><span class="nav-number">5.6.3.</span> <span class="nav-text">PodTemplate应该声明选择器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义资源的定义"><span class="nav-number">5.7.</span> <span class="nav-text">自定义资源的定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用资源前安装CRD声明"><span class="nav-number">5.7.1.</span> <span class="nav-text">使用资源前安装CRD声明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC-1"><span class="nav-number">5.8.</span> <span class="nav-text">RBAC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML配置"><span class="nav-number">5.8.1.</span> <span class="nav-text">YAML配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RBAC资源应该被默认创建"><span class="nav-number">5.8.2.</span> <span class="nav-text">RBAC资源应该被默认创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用RBAC资源"><span class="nav-number">5.8.3.</span> <span class="nav-text">使用RBAC资源</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模板-1"><span class="nav-number">6.</span> <span class="nav-text">模板</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#入门"><span class="nav-number">6.1.</span> <span class="nav-text">入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Charts-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">Charts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-1"><span class="nav-number">6.1.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第一个模板"><span class="nav-number">6.1.3.</span> <span class="nav-text">第一个模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内置对象"><span class="nav-number">6.2.</span> <span class="nav-text">内置对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#值文件"><span class="nav-number">6.2.1.</span> <span class="nav-text">值文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除一个默认键"><span class="nav-number">6.2.2.</span> <span class="nav-text">删除一个默认键</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模板函数和管道"><span class="nav-number">6.3.</span> <span class="nav-text">模板函数和管道</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#管道"><span class="nav-number">6.3.1.</span> <span class="nav-text">管道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#default函数"><span class="nav-number">6.3.2.</span> <span class="nav-text">default函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lookup函数"><span class="nav-number">6.3.3.</span> <span class="nav-text">lookup函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作符"><span class="nav-number">6.3.4.</span> <span class="nav-text">操作符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#函数列表"><span class="nav-number">6.4.</span> <span class="nav-text">函数列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流程控制"><span class="nav-number">6.5.</span> <span class="nav-text">流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#if和else"><span class="nav-number">6.5.1.</span> <span class="nav-text">if和else</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制空格"><span class="nav-number">6.5.2.</span> <span class="nav-text">控制空格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用with修改范围"><span class="nav-number">6.5.3.</span> <span class="nav-text">使用with修改范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range循环"><span class="nav-number">6.5.4.</span> <span class="nav-text">range循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量"><span class="nav-number">6.6.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命名模板"><span class="nav-number">6.7.</span> <span class="nav-text">命名模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下划线文件"><span class="nav-number">6.7.1.</span> <span class="nav-text">下划线文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明和使用模板"><span class="nav-number">6.7.2.</span> <span class="nav-text">声明和使用模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置模板范围"><span class="nav-number">6.7.3.</span> <span class="nav-text">设置模板范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include"><span class="nav-number">6.7.4.</span> <span class="nav-text">include</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在模板内访问文件"><span class="nav-number">6.8.</span> <span class="nav-text">在模板内访问文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-2"><span class="nav-number">6.8.1.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路径助手"><span class="nav-number">6.8.2.</span> <span class="nav-text">路径助手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Glob模式"><span class="nav-number">6.8.3.</span> <span class="nav-text">Glob模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConfigMap和Secrets的实用功能"><span class="nav-number">6.8.4.</span> <span class="nav-text">ConfigMap和Secrets的实用功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编码"><span class="nav-number">6.8.5.</span> <span class="nav-text">编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#行"><span class="nav-number">6.8.6.</span> <span class="nav-text">行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NOTES-txt"><span class="nav-number">6.9.</span> <span class="nav-text">NOTES.txt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Subcharts"><span class="nav-number">6.10.</span> <span class="nav-text">Subcharts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个subchart"><span class="nav-number">6.10.1.</span> <span class="nav-text">创建一个subchart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对subchart添加值和模板"><span class="nav-number">6.10.2.</span> <span class="nav-text">对subchart添加值和模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从parent-chart覆盖值"><span class="nav-number">6.10.3.</span> <span class="nav-text">从parent chart覆盖值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局值"><span class="nav-number">6.10.4.</span> <span class="nav-text">全局值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#共享模板"><span class="nav-number">6.10.5.</span> <span class="nav-text">共享模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#避免使用块"><span class="nav-number">6.10.6.</span> <span class="nav-text">避免使用块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helmignore"><span class="nav-number">6.11.</span> <span class="nav-text">.helmignore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模板调试"><span class="nav-number">6.12.</span> <span class="nav-text">模板调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML技巧"><span class="nav-number">6.13.</span> <span class="nav-text">YAML技巧</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Helm命令"><span class="nav-number">7.</span> <span class="nav-text">Helm命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#社区指南"><span class="nav-number">8.</span> <span class="nav-text">社区指南</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FAQ"><span class="nav-number">9.</span> <span class="nav-text">FAQ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leslie Zhang</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 126.1k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2020/09/21/Helm/';
          this.page.identifier = '2020/09/21/Helm/';
          this.page.title = 'Helm';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
