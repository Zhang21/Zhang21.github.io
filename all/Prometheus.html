<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content=",,,,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="参考：  Prometheus文档： https://prometheus.io/docs GitHub: https://github.com/prometheus/  环境：  CentOS7x86_64 Prometheus v2.14">
<meta name="keywords" content="DevOps,Prometheus,Monitor,Alert">
<meta property="og:type" content="website">
<meta property="og:title" content="Prometheus">
<meta property="og:url" content="https://zhang21.github.io/all/Prometheus.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="参考：  Prometheus文档： https://prometheus.io/docs GitHub: https://github.com/prometheus/  环境：  CentOS7x86_64 Prometheus v2.14">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/prometheus.jpg">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/architecture.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/9090.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/expression01.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/expression02.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/alerts_state.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/grafana_prometheus.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/grafana_login.png">
<meta property="og:image" content="https://zhang21.github.io/images/Prometheus/add_prometheus_datasource.png">
<meta property="og:updated_time" content="2019-11-18T07:30:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Prometheus">
<meta name="twitter:description" content="参考：  Prometheus文档： https://prometheus.io/docs GitHub: https://github.com/prometheus/  环境：  CentOS7x86_64 Prometheus v2.14">
<meta name="twitter:image" content="https://zhang21.github.io/images/Prometheus/prometheus.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/all/Prometheus.html">





  <title>Prometheus | 风继续吹</title>
  








  <!-- 爆炸效果 -->
  <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
  <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
  <script type="text/javascript" src="/js/firework.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-bullshift">
          <a href="https://suulnnka.github.io/BullshitGenerator/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-external-link"></i> <br>
            
            狗屁不通生成器
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

	<h1 class="post-title" itemprop="name headline">Prometheus</h1>



</header>

      
      
      
      <div class="post-body">
        
        
          <p>参考：</p>
<ul>
<li>Prometheus文档： <a href="https://prometheus.io/docs" target="_blank" rel="noopener">https://prometheus.io/docs</a></li>
<li>GitHub: <a href="https://github.com/prometheus/" target="_blank" rel="noopener">https://github.com/prometheus/</a></li>
</ul>
<p>环境：</p>
<ul>
<li>CentOS7x86_64</li>
<li>Prometheus v2.14</li>
</ul>
<p><br></p>
<a id="more"></a>
<p><img src="/images/Prometheus/prometheus.jpg" alt="Prometheus"></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Introduction</p>
<p><br></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><br></p>
<h3 id="Prometheus是什么"><a href="#Prometheus是什么" class="headerlink" title="Prometheus是什么"></a>Prometheus是什么</h3><p>What is Prometheus?</p>
<p>Prometheus是一个最初在SoundCloud上构建的<strong>开源监控系统和报警工具包</strong>。现在是一个独立的开源项目，由社区进行维护。</p>
<p><br></p>
<p><strong>功能(Features)</strong><br>Prometheus的主要特点：</p>
<ul>
<li>具有由度量名称(metric name)和键值对(key-value)标识的时间序列(time series)数据的多维(multi-dimensional)数据模型</li>
<li>灵活的查询语言，以利用此维度</li>
<li>不依赖分布式存储(distributed storage)，单个服务器节点是自治的(autonomous)</li>
<li>时间序列集合通过HTPP的<code>pull model</code>发生</li>
<li><code>push</code>时间序列通过中间网关(intermediary gateway)的支持</li>
<li>通过服务发现或静态配置来发现目标</li>
<li>图形和仪表盘支持多种模式</li>
</ul>
<p><br></p>
<p><strong>组件(Components)</strong><br>Prometheus系统由多个组件构成，其中某些组件是可选的：</p>
<ul>
<li>主要的<strong>Prometheus Server</strong>，用于存储时间序列数据</li>
<li><strong>client libraries</strong>，用于检测应用程序代码</li>
<li><strong>push gateway</strong>，用于支持短暂的(short-lived)工作</li>
<li><strong>exporters</strong>，用于服务的特殊目的</li>
<li><strong>alertmanager</strong>，用于处理报警</li>
<li>各种支持工具</li>
</ul>
<p><br></p>
<p><strong>架构(Architecture)</strong><br>Prometheus的体系结构和系统组件图：</p>
<p><img src="/images/Prometheus/architecture.png" alt="Prometheus架构图"></p>
<p><br><br><br></p>
<h3 id="什么时候适合"><a href="#什么时候适合" class="headerlink" title="什么时候适合"></a>什么时候适合</h3><p>When does it fit?</p>
<p>Prometheus适用于记录任何纯数字时间序列。它既适用于以机器为中心的监控，也适用于高度动态的面向服务架构的监控。在微服务的世界中，它对多维数据收集和查询的支持是一种特殊的优势。<br>Prometheus专为提高可靠性而设计，是你在断电期间可以快速诊断问题的系统。每个Prometheus Server都是独立的，不依赖于网络存储或其它远程服务。当基础架构其它部分损坏时，你仍可以依赖它，并且你不需要设置大量的基础架构来使用它。</p>
<p><br><br><br></p>
<h3 id="什么时候不适合"><a href="#什么时候不适合" class="headerlink" title="什么时候不适合"></a>什么时候不适合</h3><p>When does it not fit?</p>
<p>Prometheus重视可靠性。即使在系统故障情况下，你也可以随时查看有关系统的可用统计信息。如果你需要100%的准确度，Prometheus不是一个好的选择，你可能需要使用其它系统。</p>
<p><br><br><br><br><br></p>
<h2 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h2><p>步骤：</p>
<ul>
<li>下载</li>
<li>配置</li>
<li>运行</li>
<li>使用表达式浏览器</li>
<li>使用图形接口</li>
<li>监控其它目标</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><p>GLOSSARY</p>
<ul>
<li><p><strong>Alert</strong><br>是Prometheus正在开火的警报规则的结果。警报从Prometheus发送到AlterManger。</p>
</li>
<li><p><strong>Alertmanager</strong><br>接收警报，将它们聚合成组，删除重复数据，应用静音、限制，然后发送电子邮件等通知。</p>
</li>
<li><p><strong>Bridge</strong><br>是一个从Client Library中获取样本并将它们暴露给 non-Prometheus 监控系统的组件。例如，Python、Java、Go…客户端可将指标导出到Graphite。</p>
</li>
<li><p><strong>Client library</strong><br>是某种语言的库(Go, Java, Python…)，可以直接检测代码，编写自定义收集器以从其它系统中收集指标并将指标公开给Prometheus。</p>
</li>
<li><p><strong>Collector</strong><br>是表示一组度量标准的 exporter 的一部分。如果它是直接检测的一部分，则可以是单个度量，如果是从另一个系统提取度量，则可以是许多度量。</p>
</li>
<li><p><strong>Direct instrumentation</strong><br>作为源代码程序的一部分内联添加的检测。</p>
</li>
<li><p><strong>Endpoint</strong></p>
</li>
<li><p><strong>Exporter</strong><br>是一个公开Prometheus指标的程序，通常将 non-prometheus 格式的指标转换为 Prometheus 支持的格式。</p>
</li>
<li><p><strong>Instance</strong><br>唯一标识作业中目标的标签</p>
</li>
<li><p><strong>Job</strong><br>具有相同目的的目标集合</p>
</li>
<li><p><strong>Notification</strong><br>代表一组多个警报</p>
</li>
<li><p><strong>Promdash</strong><br>原生Prometheus仪表盘构建器。它已被弃用，并被 Grafana 取代</p>
</li>
<li><p><strong>Prometheus</strong><br>通常指的是Prometheus System的核心程序，也可指整个监控系统。</p>
</li>
<li><p><strong>PromQL</strong><br>Prometheus Query Language</p>
</li>
<li><p><strong>Pushgateway</strong><br>持续从批量作业中最新推出的指标</p>
</li>
<li><p><strong>Remote Read</strong><br>允许从其它系统透明读取时间序列作为查询的一部分</p>
</li>
<li><p><strong>Remote Read Adapter</strong><br>并非所有系统都支持远程读取。远程读取适配器便是用于此。</p>
</li>
<li><p><strong>Remote Read Endpoint</strong><br>Prometheus进行远程读取时的对象</p>
</li>
<li><p><strong>Remote Write</strong><br>允许动态地将采集的样本发送到其它系统</p>
</li>
<li><p><strong>Remote Write Adapter</strong></p>
</li>
<li><p><strong>Remote Write Endpoint</strong></p>
</li>
<li><p><strong>Sample</strong><br>时间序列中某个时间点的单个值，Prometheus中，每个样本都包含一个<code>float64</code>和<code>ms</code>精度的时间戳。</p>
</li>
<li><p><strong>Silence</strong><br>防止报警</p>
</li>
<li><p><strong>Target</strong><br>抓取对象的定义</p>
</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>faq: <a href="https://prometheus.io/docs/introduction/faq/" target="_blank" rel="noopener">https://prometheus.io/docs/introduction/faq/</a></p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>CONCEPTS</p>
<p><br></p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>Data model</p>
<p>Prometheus从根本上将所有数据存储为<strong>时间序列(time series)</strong>: 属于同一指标和同一标记维度的带时间戳值的流。除了存储时间序列，Prometheus还可以临时生成时间序列作为查询的结果。</p>
<p><br><br><br></p>
<h3 id="指标名称和标签"><a href="#指标名称和标签" class="headerlink" title="指标名称和标签"></a>指标名称和标签</h3><p>Metric names and labels</p>
<p>每个时间序列都是有<strong>指标名称(metric name)</strong>和一组键值对(也称为<strong>标签(label)</strong>)来唯一标识。</p>
<p>指标名称： 可能包含ASCII字母，下划线，冒号。它必须匹配正则: <code>[a-zA-Z_:][a-zA-Z0-9_:]*</code>。<br>标签启用Prometheus的维度数据模型：</p>
<p><br><br><br><br><br></p>
<h2 id="指标类型"><a href="#指标类型" class="headerlink" title="指标类型"></a>指标类型</h2><p>metric types</p>
<p><br><br><br><br><br></p>
<h2 id="工作和实例"><a href="#工作和实例" class="headerlink" title="工作和实例"></a>工作和实例</h2><p>Job and Instance</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h1><p><br></p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>GETTING STARTED</p>
<p>本节介绍如何安装，配置，使用Prometheus的简单例子。你将在本地安装和运行Prometheus，将其配置为自我填充和示例应用程序，然后使用查询，规则和图表来使用收集的序列数据。</p>
<p><br></p>
<p><strong>下载</strong></p>
<p>下载地址: <a href="https://prometheus.io/download/" target="_blank" rel="noopener">https://prometheus.io/download/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xvfz prometheus-*.tar.gz</span><br><span class="line"></span><br><span class="line">cd prometheus-*</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>配置和监控</strong><br>Prometheus通过在目标上通过HTTP endPoints来抓取指标，来收集受监控目标的指标。由于Prometheus也以相同的方式公开自身数据，它也可以获取和监测自身的健康状况。<br>虽然Prometheus Server只收集有关自身的数据在实践中不是很有用，但它是一个很好的示例。如<code>prometheus.yml</code>示例配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span>     <span class="number">15</span><span class="string">s</span> <span class="comment"># By default, scrape targets every 15 seconds.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Attach these labels to any time series or alerts when communicating with</span></span><br><span class="line">  <span class="comment"># external systems (federation, remote storage, Alertmanager).</span></span><br><span class="line"><span class="attr">  external_labels:</span></span><br><span class="line"><span class="attr">    monitor:</span> <span class="string">'codelab-monitor'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it's Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line"><span class="attr">    scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['localhost:9090']</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>启动</strong><br>启动后，可访问9090端口查看状态。可访问<code>localhost:9090/metrics</code>查看有关自身的相关指标。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd prometheus-2.3.2.linux-amd64</span><br><span class="line">./prometheus --config.file=&quot;prometheus.yml&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/images/Prometheus/9090.png" alt="9090"></p>
<p><br></p>
<p><strong>使用表达式浏览器</strong><br>让我们看一下Prometheus收集的一些数据。要使用Prometheus的内建表达式浏览器(expression browser)，请跳转到<code>http://localhost:9090/graph</code>并选择<code>Graph -&gt; Console</code>，在其中输入表达式。<br>绘制表达式图形同样在此操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#表达式</span><br><span class="line">prometheus_target_interval_length_seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#表达式</span><br><span class="line">prometheus_target_interval_length_seconds&#123;quantile=&quot;0.99&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#计算返回的时间序列数</span><br><span class="line">count(prometheus_target_interval_length_seconds)</span><br></pre></td></tr></table></figure>
<p><img src="/images/Prometheus/expression01.png" alt="表达式结果"></p>
<p><img src="/images/Prometheus/expression02.png" alt="表达式图形"></p>
<p><br></p>
<p><strong>启动简单的目标</strong><br>启动一些示例目标让Prometheus获取。<br>确保已安装Go表一起并设置了正常的GO PATH。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir ./sample &amp;&amp; cd sample</span><br><span class="line"></span><br><span class="line">git clone https://github.com/prometheus/client_golang.git</span><br><span class="line">cd client_golang/examples/random</span><br><span class="line">go get -d</span><br><span class="line">go build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Start 3 example targets in separate terminals:</span><br><span class="line">./random -listen-address=:9091</span><br><span class="line">./random -listen-address=:9092</span><br><span class="line">./random -listen-address=:9093</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#访问</span><br><span class="line">http://localhost:9091/metrices</span><br><span class="line">http://localhost:9092/metrices</span><br><span class="line">http://localhost:9093/metrices</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>监控示例目标</strong><br>现在需要配置Prometheus来抓取目标。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="attr">  - job_name:</span>       <span class="string">'example-random'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Override the global default and scrape targets from this job every 5 seconds.</span></span><br><span class="line"><span class="attr">    scrape_interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['localhost:8080',</span> <span class="string">'localhost:8081'</span><span class="string">]</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          group:</span> <span class="string">'production'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['localhost:8082']</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          group:</span> <span class="string">'canary'</span></span><br></pre></td></tr></table></figure>
<p>重启Prometheus，检测<code>rpc_durations_seconds</code> metric来验证。</p>
<p><br></p>
<p><strong>配置规则</strong><br>Configure rules for aggregating scraped data into new time series</p>
<p>聚合超过数千个时间序列的查询在计算<code>ad-hoc</code>时会变慢。为了提高效率，Prometheus允许你通过配置的规则将预录表达式预先记录到全新的持久时间序列中。</p>
<p>创建规则文件<code>prometheus.rules.yml</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#job_service:rpc_durations_seconds_count:avg_rate5m</span><br><span class="line">groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line">  - record: job_service:rpc_durations_seconds_count:avg_rate5m</span><br><span class="line">    expr: avg(rate(rpc_durations_seconds_count[5m])) by (job, service)</span><br></pre></td></tr></table></figure></p>
<p>要是Prometheus选择此新规则，需要修改Prometheus配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # By default, scrape targets every 15 seconds.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds.</span><br><span class="line"></span><br><span class="line">  # Attach these extra labels to all timeseries collected by this Prometheus instance.</span><br><span class="line">  external_labels:</span><br><span class="line">    monitor: &apos;codelab-monitor&apos;</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &apos;prometheus.rules.yml&apos;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;localhost:9090&apos;]</span><br><span class="line"></span><br><span class="line">  - job_name:       &apos;example-random&apos;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;localhost:8091&apos;, &apos;localhost:8092&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;production&apos;</span><br><span class="line"></span><br><span class="line">      - targets: [&apos;localhost:9093&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &apos;canary&apos;</span><br></pre></td></tr></table></figure>
<p>重启Prometheus，使用<code>job_service:rpc_durations_seconds_count:avg_rate5m</code> metric验证。</p>
<p><br><br><br></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><br></p>
<h3 id="使用预编译的二进制文件"><a href="#使用预编译的二进制文件" class="headerlink" title="使用预编译的二进制文件"></a>使用预编译的二进制文件</h3><p><br><br><br></p>
<h3 id="使用源码"><a href="#使用源码" class="headerlink" title="使用源码"></a>使用源码</h3><p><br><br><br></p>
<h3 id="使用Docker"><a href="#使用Docker" class="headerlink" title="使用Docker"></a>使用Docker</h3><p>所有的Prometheus服务都可以作为 Docker image 来使用。<br>Prometheus image 使用 volume 来存储实际的指标。对于生产部署，强烈建议使用 Data Volume Container 来升级数据的管理。</p>
<p>栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#bind-mount</span><br><span class="line">docker run -p 9090:9090 -v /tmp/prometheus.yml:/etc/prometheus.yml  prom/prometheus</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#volume</span><br><span class="line">docker run -p 9090:9090 -v /promethe-data  prom/prometheus  --config.file=/prometheus-data/prometheus.yml</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>自定义镜像</strong></p>
<p>Dockerfile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM prom/prometheus</span><br><span class="line">ADD prometheus.yml /etc/prometheus/</span><br><span class="line">xxx</span><br></pre></td></tr></table></figure>
<p>构建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t my-prometheus .</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="使用配置管理系统"><a href="#使用配置管理系统" class="headerlink" title="使用配置管理系统"></a>使用配置管理系统</h3><ul>
<li>Ansible</li>
<li>Chef</li>
<li>Puppet</li>
<li>SaltStack</li>
</ul>
<p><br><br><br><br><br></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Configuration</p>
<p>Prometheus通过命令行标志(flag)和配置文件进行配置。使用<code>./prometheus -h</code>查看所有命令行标志。<br>Prometheus可在运行时重新加载配置。</p>
<p><br></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>configuration file: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p>
<p>使用<code>--config.file</code>标志指定配置文件。配置文件使用<code>YAML</code>格式。</p>
<p>一个配置文件栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># How frequently to scrape targets by default.</span></span><br><span class="line">  <span class="string">[</span> <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">| default = 1m ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # How long until a scrape request times out.</span></span><br><span class="line"><span class="string">  [ scrape_timeout: &lt;duration&gt; | default = 10s ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # How frequently to evaluate rules.</span></span><br><span class="line"><span class="string">  [ evaluation_interval: &lt;duration&gt; | default = 1m ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # The labels to add to any time series or alerts when communicating with</span></span><br><span class="line"><span class="string">  # external systems (federation, remote storage, Alertmanager).</span></span><br><span class="line"><span class="string"></span><span class="attr">  external_labels:</span></span><br><span class="line">    <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rule files specifies a list of globs. Rules and alerts are read from</span></span><br><span class="line"><span class="comment"># all matching files.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A list of scrape configurations.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alerting specifies settings related to the Alertmanager.</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alert_relabel_configs:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line">    <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the remote write feature.</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings related to the remote read feature.</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p>各个配置项，详细详细请看文档: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p>
<ul>
<li><code>scrape_config</code></li>
<li><code>tls_config</code></li>
<li><code>azure_sd_config</code></li>
<li><code>consul_sd_config</code></li>
<li><code>dns_sd_config</code></li>
<li><code>ec2_sd_config</code></li>
<li><code>openstack_sd_config</code></li>
<li><code>file_sd_config</code></li>
<li><code>gce_sd_config</code></li>
<li><code>kubernetes_sd_config</code></li>
<li><code>marathon_sd_config</code></li>
<li><code>nerve_sd_config</code></li>
<li><code>serverset_sd_config</code></li>
<li><code>triton_sd_config</code></li>
<li><code>static_config</code></li>
<li><code>relabel_config</code></li>
<li><code>metric_relabel_configs</code></li>
<li><code>alert_relabel_configs</code></li>
<li><code>alertmanager_config</code></li>
<li><code>remote_write</code></li>
<li><code>remote_read</code></li>
</ul>
<p><br><br><br><br><br></p>
<h3 id="记录规则"><a href="#记录规则" class="headerlink" title="记录规则"></a>记录规则</h3><p>Recording rules</p>
<p><br></p>
<h4 id="配置规则"><a href="#配置规则" class="headerlink" title="配置规则"></a>配置规则</h4><p>Configuring rules</p>
<p>Prometheus支持两种类型的可被配置的以规定的间隔进行评估的规则:</p>
<ul>
<li>recording rules</li>
<li>alterting rules</li>
</ul>
<p>要在Prometheus中包含规则，创建包含必要规则的语句并在Prometheus配置文件中通过<code>rule_files</code>字段配置并加载文件。规则使用YAML格式。</p>
<p>规则文件可在Prometheus运行通过发送<code>SIGHUP</code>到Prometheus来进行重载。只有在所有规则文件都是正确格式下才会应用更改。</p>
<p><br><br><br></p>
<h4 id="语法检查规则"><a href="#语法检查规则" class="headerlink" title="语法检查规则"></a>语法检查规则</h4><p>Syntax-checking rules</p>
<p>要快速检查规则文件的语法是否正确，而无需启动Prometheus Server，可安装和运行Prometheus的<code>promtool</code>命令行工具:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/prometheus/prometheus/cmd/promtool</span><br><span class="line"></span><br><span class="line">promtool check rules /path/to/example.rules.yml</span><br></pre></td></tr></table></figure>
<p>如果规则文件语法正确，会返回<code>0</code>状态码。如果语法错误，会返回错误信息和<code>1</code>状态码。</p>
<p><br><br><br></p>
<h4 id="记录规则-1"><a href="#记录规则-1" class="headerlink" title="记录规则"></a>记录规则</h4><p>Recording rules</p>
<p>记录规则允许你预先计算经常需要或计算昂贵的表达式并保存它们的结果到一个新的时序集(set of time series)。查询预先计算的结果会比每次执行原始表达式快得多。这对Dashboard来说尤其有用，它经常刷新时间反复查询同样的表达式。</p>
<p>记录和告警规则位于一个规则组(rule group)。一个组内的规则在一个规定的间隔内依序运行。</p>
<p>规则文件语法:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;rule_group&gt;</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">  - name: example</span><br><span class="line">    relues:</span><br><span class="line">    - record: job:http_inprogress_requests:sum</span><br><span class="line">      expr: sum(http_inprogress_requests) by (job)</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong><rule_group></rule_group></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The name of the group. Must be unique within a file.</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How often rules in the group are evaluated.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">| default = global.evaluation_interval ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">rules:</span></span><br><span class="line">  <span class="string">[</span> <span class="bullet">-</span> <span class="string">&lt;rule&gt;</span> <span class="string">...</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong><rule></rule></strong></p>
<p>记录规则的语法:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The name of the time series to output to. Must be a valid metric name.</span></span><br><span class="line"><span class="attr">record:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The PromQL expression to evaluate. Every evaluation cycle this is</span></span><br><span class="line"><span class="comment"># evaluated at the current time, and the result recorded as a new set of</span></span><br><span class="line"><span class="comment"># time series with the metric name as given by 'record'.</span></span><br><span class="line"><span class="attr">expr:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Labels to add or overwrite before storing the result.</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;]</span></span><br></pre></td></tr></table></figure>
<p>告警规则的语法:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The name of the alert. Must be a valid metric name.</span></span><br><span class="line"><span class="attr">alert:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The PromQL expression to evaluate. Every evaluation cycle this is</span></span><br><span class="line"><span class="comment"># evaluated at the current time, and all resultant time series become</span></span><br><span class="line"><span class="comment"># pending/firing alerts.</span></span><br><span class="line"><span class="attr">expr:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alerts are considered firing once they have been returned for this long.</span></span><br><span class="line"><span class="comment"># Alerts which have not yet fired for long enough are considered pending.</span></span><br><span class="line"><span class="string">[</span> <span class="attr">for:</span> <span class="string">&lt;duration&gt;</span> <span class="string">| default = 0s ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Labels to add or overwrite for each alert.</span></span><br><span class="line"><span class="string"></span><span class="attr">labels:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;tmp_string&gt;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Annotations to add to each alert.</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="string">[</span> <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;tmpl_string&gt;</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h3><p>Alerting rules</p>
<p>告警规则允许你根据Prometheus表达式语言来定义告警条件，并发送提醒到外部服务。每当告警表达式在给定的时间内导致一个或多个矢量元素，告警计数主动作为这些元素的标签集。</p>
<p><br></p>
<h4 id="定义告警规则"><a href="#定义告警规则" class="headerlink" title="定义告警规则"></a>定义告警规则</h4><p>在Prometheus中，告警规则的配置与记录规则的配置一样。</p>
<p>栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - alerts:</span> <span class="string">HighRequestLatency</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="attr">job:request_latency_seconds:mean5m&#123;job="myjob"&#125;</span> <span class="string">&gt; 0.5</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">High</span> <span class="string">request</span> <span class="string">latency</span></span><br></pre></td></tr></table></figure>
<p>可选的<code>for</code>子句导致Prometheus等待在第一次遇到一个新的表达式输出矢量元素和计数的告警作为点燃的此元素的一定持续时间。在这个栗子中，Prometheus将检查在点燃告警之前的每个10分钟的警告持续激活。元素是活跃的，但未点燃，出于待定(pending)状态。</p>
<p><code>labels</code>子句允许指定一组附加标签到告警。任何目前有冲突的标签将被覆盖。标签的值可以作为模板。</p>
<p><code>annotations</code>子句指定的一组信息可用来存储更长的附加信息。注释的值可以作为模板。</p>
<p><br><br><br></p>
<h4 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h4><p>Templating</p>
<p>标签和注释的值可以使用<code>console template</code>作为模板。<code>$labels</code>变量保存一个告警实例的k/v键值对。已配置的外部标签可通过<code>$externalLabels</code>变量进行访问。<code>$value</code>变量保存告警实例的评估值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To insert a firing element's label values:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">$labels.&lt;labelname&gt;</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To insert the numeric expression value of the firing element:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">$value</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Alert for any instance that is unreachable for &gt;5 minutes.</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">InstanceDown</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    for:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line"><span class="attr">      severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down"</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 5 minutes."</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Alert for any instance that has a median request latency &gt;1s.</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">APIHighRequestLatency</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">api_http_request_latencies_second&#123;quantile="0.5"&#125;</span> <span class="string">&gt; 1</span></span><br><span class="line"><span class="string"></span><span class="attr">    for:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">"High request latency on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has a median request latency above 1s (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)s"</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="运行时检查告警"><a href="#运行时检查告警" class="headerlink" title="运行时检查告警"></a>运行时检查告警</h4><p>Inspecting alerts during runtime</p>
<p>要手动检查告警是否活跃(active)(pending或firing)，请浏览原生Prometheus的Alerts栏目项。这里将确切地显示标签集，每个定义的告警当前的状态。</p>
<p><img src="/images/Prometheus/alerts_state.png" alt></p>
<p>对于<code>pengding</code>和<code>firing</code>的告警，Prometheus还存储合成<code>ALERTS{alertname=&quot;&lt;alert name&gt;&quot;, alertstate=&quot;pending|firing&quot;, &lt;additional alert labels&gt;}</code>形式的时间序列。只要该警告是在所指示的active(pending或firing)状态，样本值被设置为1。当不再是这样时，该系列被标记为stale。</p>
<p><br><br><br></p>
<h4 id="发送告警通知"><a href="#发送告警通知" class="headerlink" title="发送告警通知"></a>发送告警通知</h4><p>Sending alert notifications</p>
<p>Prometheus的告警规则善于盘算现在什么坏了(broken)，但是它不是一个成熟的通知解决方案。需要另一层添加汇总，通知速率限制，沉默和告警依赖于简单告警定义。在Prometheus的生态系统中，<strong>Alertmanager</strong>承担了这一角色。因此，Prometheus可以配置成定期发送关于告警状态信息到Alertmanager实例，然后采取调度权发送通知。<br>Prometheus通过集成服务发现，可配置为自动发现可用的Alertmanager实例。</p>
<p><br><br><br></p>
<h3 id="模板-1"><a href="#模板-1" class="headerlink" title="模板"></a>模板</h3><p>Template example</p>
<p>Prometheus在alerts的annotations和labels中支持模板化，以及在控制台页面。模板要针对本地数据库运行查询、迭代数据，使用条件、格式数据等能力。Prometheus模板语言是基于Go template system。</p>
<p><br></p>
<h4 id="简单告警字段模板"><a href="#简单告警字段模板" class="headerlink" title="简单告警字段模板"></a>简单告警字段模板</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line"><span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"><span class="attr">for:</span> <span class="number">5</span><span class="string">m</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"><span class="attr">  severity:</span> <span class="string">page</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line"><span class="attr">  summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span> down"</span></span><br><span class="line"><span class="attr">  description:</span> <span class="string">"<span class="template-variable">&#123;&#123;$labels.instance&#125;&#125;</span> of job <span class="template-variable">&#123;&#123;$labels.job&#125;&#125;</span> has been down for more than 5 minutes."</span></span><br></pre></td></tr></table></figure>
<p>告警字段模板为每个点燃的告警在每一个规则迭代过程中执行，所以保持任意查询和模板的轻量化。如果你需要为告警编写更复杂的模板，建议链接到控制台。</p>
<p><br><br><br></p>
<h4 id="简单迭代"><a href="#简单迭代" class="headerlink" title="简单迭代"></a>简单迭代</h4><p>simple iteration</p>
<p>这显示的实例列表，以及它们是否up:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">range</span> <span class="string">query</span> <span class="string">"up"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">.Labels.instance</span> <span class="string">&#125;&#125;</span> <span class="string">&#123;&#123;</span> <span class="string">.Value</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>特殊的<code>.</code>变量包含对于每次循环迭代当前样本的值。</p>
<p><br><br><br></p>
<h4 id="展示一个值"><a href="#展示一个值" class="headerlink" title="展示一个值"></a>展示一个值</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">with</span> <span class="string">query</span> <span class="string">"some_metric&#123;instance='someinstance'&#125;"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;</span> <span class="string">.</span> <span class="string">| first | value | humanize &#125;</span></span><br><span class="line"><span class="string"><span class="template-variable">&#123;&#123; end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>Go和Go的模板语言两者都是强类型，因此必须检查阳平返回，以避免执行错误。<br>这里所包含的<code>prom_query_drilldown</code>模板处理，允许结果的格式，并链接到表达式浏览器。</p>
<p><br><br><br></p>
<h4 id="使用控制台url参数"><a href="#使用控制台url参数" class="headerlink" title="使用控制台url参数"></a>使用控制台url参数</h4><p>Using console URL parameters</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">with</span> <span class="string">printf</span> <span class="string">"node_memory_MemTotal&#123;job='node', instance='%s'&#125;"</span> <span class="string">.Params.instance</span> <span class="string">| query&#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123; . | first | value | humanize1024 &#125;&#125;</span>B</span></span><br><span class="line"><span class="string"><span class="template-variable">&#123;&#123; end &#125;&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>如果作为<code>console.html?instance=hostname</code>访问, <code>.Params.instance</code>将评估<code>hostname</code>。</p>
<p><br><br><br></p>
<h4 id="高级的迭代"><a href="#高级的迭代" class="headerlink" title="高级的迭代"></a>高级的迭代</h4><p>Advanced iteration</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;table&gt;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">range</span> <span class="string">printf</span> <span class="string">"node_network_receive_bytes&#123;job='node',instance='%s',device!='lo'&#125;"</span> <span class="string">.Params.instance</span> <span class="string">| query | sortByLabel "device"&#125;&#125;</span></span><br><span class="line"><span class="string">&lt;tr&gt;&lt;th colspan=2&gt;<span class="template-variable">&#123;&#123; .Labels.device &#125;&#125;</span>&lt;/th&gt;&lt;/tr&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;Received&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;<span class="template-variable">&#123;&#123; with printf "rate(node_network_receive_bytes&#123;job='node',instance='%s',device='%s'&#125;[5m])" .Labels.instance .Labels.device | query &#125;&#125;</span><span class="template-variable">&#123;&#123; . | first | value | humanize &#125;&#125;</span>B/s<span class="template-variable">&#123;&#123;end&#125;&#125;</span>&lt;/td&gt;</span></span><br><span class="line"><span class="string">&lt;/tr&gt;</span></span><br><span class="line"><span class="string">&lt;tr&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;Transmitted&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;td&gt;<span class="template-variable">&#123;&#123; with printf "rate(node_network_transmit_bytes&#123;job='node',instance='%s',device='%s'&#125;[5m])" .Labels.instance .Labels.device | query &#125;&#125;</span><span class="template-variable">&#123;&#123; . | first | value | humanize &#125;&#125;</span>B/s<span class="template-variable">&#123;&#123;end&#125;&#125;</span>&lt;/td&gt;</span></span><br><span class="line"><span class="string">  &lt;/tr&gt;<span class="template-variable">&#123;&#123; end &#125;&#125;</span></span></span><br><span class="line"><span class="string">&lt;/table&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里，我们迭代了所有网络设备，并显示每个设备的网络流量。随着<code>range</code>动作不指定变量，<code>.Params.instance</code>循环内不可用，<code>.</code>现在是作为循环变量。</p>
<p><br><br><br></p>
<h4 id="定义可重复使用的模板"><a href="#定义可重复使用的模板" class="headerlink" title="定义可重复使用的模板"></a>定义可重复使用的模板</h4><p>Defining reusable templates</p>
<p>Prometheus支持定义可重复使用的模板。当与控制台库相结合时，使得可共享模板，这很有用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">/*</span> <span class="string">Define</span> <span class="string">the</span> <span class="string">template</span> <span class="string">*/</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;define</span> <span class="string">"myTemplate"</span><span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">do</span> <span class="string">something</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;&#123;/*</span> <span class="string">Use</span> <span class="string">the</span> <span class="string">template</span> <span class="string">*/&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;template</span> <span class="string">"myTemplate"</span><span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>模板仅限于一个参数。<code>args</code>函数可包装多个参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;define</span> <span class="string">"myMultiArgTemplate"</span><span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">First</span> <span class="attr">argument:</span> <span class="string">&#123;&#123;.arg0&#125;&#125;</span></span><br><span class="line">  <span class="string">Second</span> <span class="attr">argument:</span> <span class="string">&#123;&#123;.arg1&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">template</span> <span class="string">"myMultiArgTemplate"</span> <span class="string">(args</span> <span class="number">1</span> <span class="number">2</span><span class="string">)&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="模板引用"><a href="#模板引用" class="headerlink" title="模板引用"></a>模板引用</h3><p>TEMPLATE REFERENCE</p>
<p><br></p>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>Data Structures</p>
<p>用于处理时间序列数据的主要数据结构栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type sample struct &#123;</span><br><span class="line">    Labels map[string]string</span><br><span class="line">    Value float64</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>栗子的指标名称(metric)编码在<code>Labels</code>map的特殊的<code>__name__</code>标签里。<br><code>[]sample</code>表示实例列表。<br>Go中的<code>interface{}</code>与C中的void pointer类似。</p>
<p><br><br><br></p>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p>除了Go模板提供的默认函数，Prometheus为模板查询结果提供了更易处理的函数。<br>如果函数在管道中使用，管道值将作为最后一个参数传递。</p>
<p><strong>Queries</strong></p>
<p><br></p>
<p><strong>Numbers</strong></p>
<p><br></p>
<p><strong>Strings</strong></p>
<p><br></p>
<p><strong>Others</strong></p>
<p><br><br><br></p>
<h4 id="模板类型差异"><a href="#模板类型差异" class="headerlink" title="模板类型差异"></a>模板类型差异</h4><p>Template type differences</p>
<p>每种类型的模板提供了可用于参数模板的不同信息，并有一些其它差异。</p>
<p><br><br><br></p>
<h3 id="规则单元测试"><a href="#规则单元测试" class="headerlink" title="规则单元测试"></a>规则单元测试</h3><p>Unit Testing for Rules</p>
<p>你可使用<code>promtool</code>来测试你的规则。</p>
<p><br><br><br><br><br></p>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>Querying</p>
<p><br></p>
<h3 id="查询Prometheus"><a href="#查询Prometheus" class="headerlink" title="查询Prometheus"></a>查询Prometheus</h3><p>Prometheus提供了一个名为<code>PromQL</code>(Prometheus Query Language)功能化查询语言，让用户选择并实时汇总时间序列数据。表达式的结果可被显示为图形，可在Prometheus浏览器上查看，或通过HTTP API来获取。</p>
<p><br></p>
<h4 id="表达式语言数据类型"><a href="#表达式语言数据类型" class="headerlink" title="表达式语言数据类型"></a>表达式语言数据类型</h4><p>Expression language data types</p>
<p>在Prometheus表达式语言中，一个表达式或子表达式可以评估为四种类型中的一种:</p>
<ul>
<li><strong>瞬时向量(Instant vector)</strong>: 包含每个时间序列的单个样品的一组时间序列，全部共享相同的时间戳</li>
<li><strong>区间向量(Range vector)</strong>: 包含随时间序列的范围的数据点的一组时间序列</li>
<li><strong>标量(Scalar)</strong>: 一个简单的数字浮点值</li>
<li><strong>字符串(String)</strong>: 一个简单的字符串值，当前未使用</li>
</ul>
<p>根据不同的使用情况(graphing, displaying the output of an expression)，例如：瞬时向量表达式返回的数据类型是唯一可以直接绘制成图表的数据类型。</p>
<p><br><br><br></p>
<h4 id="Literals"><a href="#Literals" class="headerlink" title="Literals"></a>Literals</h4><p><strong>String literals</strong></p>
<p>字符串可以被指定为在单引号、双引号或反引号内的文字。</p>
<p>PromQL遵循Go的转义规则。<br>不像Go，Prometheus不丢弃反引号里面的换行符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;this is a string&quot;</span><br><span class="line">&apos;these are unescaped: \n \\ \t&apos;</span><br><span class="line">`these are not unescaped: \n &apos; &quot; \t`&quot;&apos;`</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Float literals</strong></p>
<p>标量浮点值可被逐字地写为<code>[-](digits)[.(digits)]</code>数字形式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-2.43</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="时序选择器"><a href="#时序选择器" class="headerlink" title="时序选择器"></a>时序选择器</h4><p>Time series Selectors</p>
<p>Prometheus中的所有正则表达式使用<a href="https://github.com/google/re2/wiki/Syntax" target="_blank" rel="noopener">RE2 syntax</a>。</p>
<p><br></p>
<p><strong>Instant vector selectors</strong></p>
<p>Instant vector selectors允许一组时间序列并为每个在给定的时间戳单一样品值的选择: 在最简单的格式中，只制定了一个指标名称。这导致了包含有该指标名称的所有时间序列的元素instant vector。</p>
<p>这个栗子将选择具有<code>http_requests_total</code>指标名称的所有时间序列:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total</span><br></pre></td></tr></table></figure>
<p>有可能通过附加一组标签在大括号来匹配进一步过滤这些时间序列。</p>
<p>这个栗子只选择<code>job label为</code>prometheus<code>和group lable为</code>canary的<code>http_requests_total</code>指标名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=&quot;prometheus&quot;, group=&quot;canary&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>也可将标签值负匹配，或匹配正则表达式。下面的标签匹配操作符存在:</p>
<ul>
<li><code>=</code>: 等于;</li>
<li><code>!=</code> 不等于;</li>
<li><code>=~</code>: 正则匹配;</li>
<li><code>!~</code>: 非正则匹配.</li>
</ul>
<p>举个栗子，以下匹配<code>staging</code>, <code>testing</code>, <code>development</code>环境变量和<code>GET</code>以外的HTTP方法的<code>http_requests_total</code>指标名称的所有时序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;environment=~&quot;staging|testing|development&quot;, method!=&quot;GET&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;job=~&quot;.*&quot;&#125; # Bad!</span><br><span class="line"></span><br><span class="line">&#123;job=~&quot;.+&quot;&#125;              # Good!</span><br><span class="line">&#123;job=~&quot;.*&quot;,method=&quot;get&quot;&#125; # Good!</span><br><span class="line"></span><br><span class="line">&#123;__name__=~&quot;job:.*&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Range Vector Selectors</strong></p>
<p>Range vector literals与 instant vector literals类似，不同之处在于它选择了一个范围。时间序列放在方括号<code>[]</code>内。</p>
<p>时间范围被指定为一个数字，使用以下单位:</p>
<ul>
<li><code>s</code>: 秒;</li>
<li><code>m</code>: 分;</li>
<li><code>h</code>: 时;</li>
<li><code>d</code>: 天;</li>
<li><code>w</code>: 周;</li>
<li><code>y</code>: 年。</li>
</ul>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=&quot;prometheus&quot;&#125;[5m]</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Offset modifier</strong></p>
<p><code>offset</code>修饰符允许为查询中的individual instant和range vectors改变时间偏移。</p>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total offset 5m</span><br><span class="line"></span><br><span class="line">sum(http_requests_total&#123;method=&quot;GET&quot;&#125; offset 5m) // GOOD.</span><br><span class="line"></span><br><span class="line">sum(http_requests_total&#123;method=&quot;GET&quot;&#125;) offset 5m // INVALID.</span><br><span class="line"></span><br><span class="line">rate(http_requests_total[5m] offset 1w)</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><p>Subquery</p>
<p>子查询允许你为一个给定的range和resolution运行一个即时查询(instant)。子查询的结果为range vector。</p>
<p>语法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># resolution可选。Default is the global evaluation interval.</span><br><span class="line">Syntax: &lt;instant_query&gt; &apos;[&apos; &lt;range&gt; &apos;:&apos; [&lt;resolution&gt;] &apos;]&apos; [ offset &lt;duration&gt; ]</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><p>Operators: <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/operators/</a></p>
<p><br></p>
<h4 id="二元运算符"><a href="#二元运算符" class="headerlink" title="二元运算符"></a>二元运算符</h4><p>Binary Operators</p>
<p>Prometheus查询语言支持基本的逻辑和算数运算符。</p>
<p><br></p>
<p><strong>Arithmetic binary operators</strong></p>
<p>Prometheus中存在以下二元算术运算符:</p>
<ul>
<li><code>+</code> (addition)</li>
<li><code>-</code> (subtraction)</li>
<li><code>*</code> (multiplication)</li>
<li><code>/</code> (division)</li>
<li><code>%</code> (modulo)</li>
<li><code>^</code> (power/exponentiation)</li>
</ul>
<p>二元运算符在下列之间定义:</p>
<ul>
<li>scalar/scalar</li>
<li>vector/scalar</li>
<li>vector/vector</li>
</ul>
<p><br></p>
<p><strong>Comparison binary operators</strong></p>
<p>Prometheus中有以下二元比较符:</p>
<ul>
<li><code>==</code> (equal)</li>
<li><code>!=</code> (not-equal)</li>
<li><code>&gt;</code> (greater-than)</li>
<li><code>&lt;</code> (less-than)</li>
<li><code>&gt;=</code> (greater-or-equal)</li>
<li><code>&lt;=</code> (less-or-equal)</li>
</ul>
<p>比较运算符在下列之间定义，默认情况下进行筛选。它们的行为可由运算符之后提供的<code>bool</code>进行修改，这将返回<code>0</code>或<code>1</code>而不是过滤。</p>
<ul>
<li>scalar/scalar</li>
<li>vector/scalar</li>
<li>vector/vector</li>
</ul>
<p><br></p>
<p><strong>Logical/set binary operators</strong></p>
<p>logical/set 二元运算符尽在instan vectors之间定义:</p>
<ul>
<li><code>and</code> (intersection)</li>
<li><code>or</code> (union)</li>
<li><code>unless</code> (complement)</li>
</ul>
<p><br><br><br></p>
<h4 id="矢量匹配"><a href="#矢量匹配" class="headerlink" title="矢量匹配"></a>矢量匹配</h4><p>Vector matching</p>
<p>矢量之间的操作试图找到为左手侧的每个条目匹配右手侧的元素。有两种基本类型匹配的行为: One-to-one 和 many-to-one/one-to-many。</p>
<p><br></p>
<p><strong>One-to-one vector matches</strong></p>
<p>一对一从操作的每一侧查找唯一的一对条目。在默认情况下，操作遵循如下格式<code>vector1 &lt;operator&gt; vector2</code>。如果它们有完全相同的一组标签和相应的值，则两个条目匹配。<code>ignoring</code>关键字允许匹配忽略某些标签，<code>on</code>关键字允许降低考虑的标签集来提供列表:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure>
<p>输入案例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  24</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  30</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;put&quot;, code=&quot;501&quot;&#125;  3</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 6</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 21</span><br><span class="line"></span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;get&quot;&#125;  600</span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;del&quot;&#125;  34</span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;post&quot;&#125; 120</span><br></pre></td></tr></table></figure>
<p>查询栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;code=&quot;500&quot;&#125; / ignoring(code) method:http_requests:rate5m</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Many-to-one and one-to-many vector matches</strong></p>
<p>多对一或一对多匹配指的是一侧能够匹配多侧的多个元素。这明确要求必须使用<code>group_left</code>或<code>group_right</code>修饰符，其中左/右确定该矢量有更高的基数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure>
<p>查询案例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m / ignoring(code) group_left method:http_request:rate5m</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  0.05            //  30 / 600</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 0.05            //   6 / 120</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 0.175           //  21 / 120</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="聚合运算符"><a href="#聚合运算符" class="headerlink" title="聚合运算符"></a>聚合运算符</h4><p>Aggregation operators</p>
<p>Prometheus支持以下内置聚合运算符，可以用于聚合单一瞬间向量的元素:</p>
<ul>
<li><code>sum</code> (calculate sum over dimensions)</li>
<li><code>min</code> (select minimum over dimensions)</li>
<li><code>max</code> (select maximum over dimensions)</li>
<li><code>avg</code> (calculate the average over dimensions)</li>
<li><code>stddev</code> (calculate population standard deviation over dimensions)</li>
<li><code>stdvar</code> (calculate population standard variance over dimensions)</li>
<li><code>count</code> (count number of elements in the vector)</li>
<li><code>count_values</code> (count number of elements with the same value)</li>
<li><code>bottomk</code> (smallest k elements by sample value)</li>
<li><code>topk</code> (largest k elements by sample value)</li>
<li><code>quantile</code> (calculate φ-quantile (<code>0 ≤ φ ≤ 1</code>) over dimensions)</li>
</ul>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt; [without|by (&lt;label list&gt;)] ([parameter,] &lt;vector expression&gt;)</span><br><span class="line"></span><br><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br><span class="line"></span><br><span class="line">sum without (instance) (http_requests_total)</span><br><span class="line"></span><br><span class="line">sum by (application, group) (http_requests_total)</span><br><span class="line"></span><br><span class="line">count_values(&quot;version&quot;, build_version)</span><br><span class="line"></span><br><span class="line">topk(5, http_requests_total)</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="二元运算符优先级"><a href="#二元运算符优先级" class="headerlink" title="二元运算符优先级"></a>二元运算符优先级</h4><p>Binary operator precedence</p>
<p>以下优先级由高到低:</p>
<ul>
<li><code>^</code></li>
<li><code>*</code>, <code>/</code>, <code>%</code></li>
<li><code>+</code>, <code>-</code></li>
<li><code>==</code>, <code>!=</code>, <code>&lt;=</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&gt;</code></li>
<li><code>and</code>, <code>unless</code></li>
<li><code>or</code></li>
</ul>
<p><br><br><br></p>
<h3 id="函数-1"><a href="#函数-1" class="headerlink" title="函数"></a>函数</h3><p>Founctions: <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/functions/</a></p>
<p>一些函数有默认的参数，如<code>year(v=vector(time()) instant-vector)</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">abs()</span><br><span class="line">abs(v instant-vector) 返回输入向量的所有样本的绝对值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">absent()</span><br><span class="line">absent(v instant-vector)，判断是否存在</span><br><span class="line"></span><br><span class="line">absent(nonexistent&#123;job=&quot;myjob&quot;&#125;)</span><br><span class="line"># =&gt; &#123;job=&quot;myjob&quot;&#125;</span><br><span class="line"></span><br><span class="line">absent(nonexistent&#123;job=&quot;myjob&quot;,instance=~&quot;.*&quot;&#125;)</span><br><span class="line"># =&gt; &#123;job=&quot;myjob&quot;&#125;</span><br><span class="line"></span><br><span class="line">absent(sum(nonexistent&#123;job=&quot;myjob&quot;&#125;))</span><br><span class="line"># =&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ceil()</span><br><span class="line">ceil(v instant-vector) 将v中所有元素的样本值向上四舍五入到最接近的整数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">floor()</span><br><span class="line">floor(v instant-vector) 与ceil()相反，将v中所有元素的样本值向下四舍五入到最接近的整数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">changes()</span><br><span class="line">changes(v range-vector) 输入一个区间向量，返回这个区间向量内每个样本数据值变化的次数（瞬时向量）。如果样本数据值没有发生变化，则返回结果为1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clamp_max()</span><br><span class="line">clamp_max(v instant-vector, max scalar) 输入一个瞬时向量和最大值，样本数据值若大于max，则改为max，否则不变</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clamp_min()</span><br><span class="line">clamp_min(v instant-vector, min scalar) 输入一个瞬时向量和最小值，样本数据值若小于min，则改为min，否则不变</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">day_of_month()</span><br><span class="line">day_of_month(v=vector(time()) instant-vector) 值范围为1-31</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">day_of_week()</span><br><span class="line">day_of_week(v=vector(time()) instant-vector) 值范围为0-6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">days_in_month()</span><br><span class="line">days_in_month(v=vector(time()) instant-vector) 月份的天数，值范围为28-31</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">minute()</span><br><span class="line">minute(v=vector(time()) instant-vector) 函数返回给定UTC时间当前小时的第多少分钟，范围为0-59</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">month()</span><br><span class="line">month(v=vector(time()) instant-vector) 函数返回给定UTC时间当前属于第几个月，范围为1-12</span><br><span class="line"></span><br><span class="line">year()</span><br><span class="line">year(v=vector(time()) instant-vector) 返回被给定 UTC 时间的当前年份</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hour()</span><br><span class="line">hour(v=vector(time()) instant-vector) 值范围为0-23</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delta()</span><br><span class="line">delta(v range-vector) 它计算一个区间向量v的第一个元素和最后一个元素之间的差值，返回一个瞬时向量</span><br><span class="line">delta(cpu_temp_celsius&#123;host=&quot;zeus&quot;&#125;[2h]) # 现在和两小时前的CPU温度差</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">idelta()</span><br><span class="line">idelta(v range-vector) 计算最后两个样本之间的差</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">deriv()</span><br><span class="line">deriv(v range-vector) 使用简单的线性回归计算区间向量v中各个时间序列的导数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exp()</span><br><span class="line">exp(v instant-vector) 输入一个瞬时向量，返回各个样本值的e的指数值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">histogram_quantile()</span><br><span class="line">histogram_quantile(φ float, b instant-vector)</span><br><span class="line">histogram_quantile(0.9, rate(http_request_duration_seconds_bucket[10m])) # 计算过去10分钟内请求持续在90%</span><br><span class="line">histogram_quantile(0.9, sum(rate(http_request_duration_seconds_bucket[10m])) by (job, le)) # 聚合</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">holt_winters()</span><br><span class="line">holt_winters(v range-vector, sf scalar, tf scalar) 基于区间向量v，生成时间序列数据平滑值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">increase()</span><br><span class="line">increase(v range-vector) 获取区间向量中的第一个和最后一个样本并返回其增长量</span><br><span class="line">increase(http_requests_total&#123;job=&quot;api-server&quot;&#125;[5m]) # 区间向量中每个时间序列过去5分钟内HTTP请求数的增长数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">label_join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">label_replace()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ln()</span><br><span class="line">ln(v instant-vector) 计算瞬时向量v中所有样本数据的自然对数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log2()</span><br><span class="line">log2(v instant-vector) 函数计算瞬时向量v中所有样本数据的二进制对数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log10()</span><br><span class="line">log10(v instant-vector) 计算瞬时向量v中所有样本数据的十进制对数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">predict_linear()</span><br><span class="line">predict_linear(v range-vector, t scalar) 函数可以预测时间序列v在t秒后的值</span><br><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[2h], 4 * 3600) &lt; 0 # 基于2小时的样本数据，来预测主机可用磁盘空间的是否在4个小时候被占满</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rate()</span><br><span class="line">rate(v range-vector) 直接计算区间向量 v 在时间窗口内平均增长速率</span><br><span class="line">rate(http_requests_total[5m]) 区间向量中每个时间序列过去5分钟内HTTP请求数的每秒增长率</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">irate()</span><br><span class="line">irate(v range-vector) 用于计算区间向量的增长率，但是其反应出的是瞬时增长率。通过区间向量中最后两个两本数据来计算区间向量的增长速率。</span><br><span class="line">irate(http_requests_total&#123;job=&quot;api-server&quot;&#125;[5m]) # 区间向量中每个时间序列过去 5 分钟内最后两个样本数据的 HTTP 请求数的增长率</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">resets()</span><br><span class="line">resets(v range-vector) 的参数是一个区间向量。对于每个时间序列，它都返回一个计数器重置的次数。两个连续样本之间的值的减少被认为是一次计数器重置。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">round()</span><br><span class="line">round(v instant-vector, to_nearest=1 scalar) 与ceil和floor函数类似，返回向量中所有样本值的最接近的整数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scalar()</span><br><span class="line">scalar(v instant-vector) 函数的参数是一个单元素的瞬时向量,它返回其唯一的时间序列的值作为一个标量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sort()</span><br><span class="line">sort(v instant-vector) 函数对向量按元素的值进行升序排序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sort_desc()</span><br><span class="line">降序排列</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sqrt()</span><br><span class="line">sqrt(v instant-vector) 计算向量v 所有元素的平方根</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vector()</span><br><span class="line">vector(s scalar)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;aggregation&gt;_over_time()</span><br><span class="line">avg_over_time(range-vector) : 区间向量内每个度量指标的平均值。</span><br><span class="line">min_over_time(range-vector) : 区间向量内每个度量指标的最小值。</span><br><span class="line">max_over_time(range-vector) : 区间向量内每个度量指标的最大值。</span><br><span class="line">sum_over_time(range-vector) : 区间向量内每个度量指标的求和。</span><br><span class="line">count_over_time(range-vector) : 区间向量内每个度量指标的样本数据个数。</span><br><span class="line">quantile_over_time(scalar, range-vector) : 区间向量内每个度量指标的样本数据值分位数，φ-quantile (0 ≤ φ ≤ 1)。</span><br><span class="line">stddev_over_time(range-vector) : 区间向量内每个度量指标的总体标准差。</span><br><span class="line">stdvar_over_time(range-vector) : 区间向量内每个度量指标的总体标准方差。</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="查询栗子"><a href="#查询栗子" class="headerlink" title="查询栗子"></a>查询栗子</h3><p>Query examples: <a href="https://prometheus.io/docs/prometheus/latest/querying/examples/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/examples/</a></p>
<p><br></p>
<h4 id="简单时序选择"><a href="#简单时序选择" class="headerlink" title="简单时序选择"></a>简单时序选择</h4><p>返回指标<code>http_requests_total</code>的所有时间序列数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total</span><br></pre></td></tr></table></figure>
<p>返回指标名为<code>http_requests_total</code>，给定标签job和handler:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=&quot;apiserver&quot;, handler=&quot;/api/comments&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>加上时间，5分钟内:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=&quot;apiserver&quot;, handler=&quot;/api/comments&quot;&#125;[5m]</span><br></pre></td></tr></table></figure>
<p>使用正则:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=~&quot;.*server&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>http状态码不为4xx:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;status!~&quot;4..&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="子查询-1"><a href="#子查询-1" class="headerlink" title="子查询"></a>子查询</h4><p>Return the 5-minute rate of the http_requests_total metric for the past 30 minutes, with a resolution of 1 minute.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[5m])[30m:1m]</span><br></pre></td></tr></table></figure>
<p>嵌套子查询:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_over_time(deriv(rate(distance_covered_total[5s])[30s:5s])[10m:])</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="使用函数，运算符"><a href="#使用函数，运算符" class="headerlink" title="使用函数，运算符"></a>使用函数，运算符</h4><p>过去5分钟的平均值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[5m])</span><br></pre></td></tr></table></figure>
<p>过去5分钟平均值综合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sum by (job) (</span><br><span class="line">  rate(http_requests_total[5m])</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>如果两个指标具有相同维度的标签，我们可以使用二元操作符计算样本数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(instance_memory_limit_bytes - instance_memory_usage_bytes) / 1024 / 1024</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 同样的表达式，只不过通过应用相加</span><br><span class="line">sum by (app, proc) (</span><br><span class="line">  instance_memory_limit_bytes - instance_memory_usage_bytes</span><br><span class="line">) / 1024 / 1024</span><br></pre></td></tr></table></figure>
<p>获取CPU使用最高的三个样本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(3, sum by (app, proc) (rate(instance_cpu_time_ns[5m])))</span><br></pre></td></tr></table></figure>
<p>假设一个服务实例只有一个时间序列数据，那么我们可以通过下面表达式统计出每个应用的实例数量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count(instance_cpu_time_ns) by (app)</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="HTTP-API"><a href="#HTTP-API" class="headerlink" title="HTTP API"></a>HTTP API</h3><p>HTTP API: <a href="https://prometheus.io/docs/prometheus/latest/querying/api/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/api/</a></p>
<p>目前稳定的HTTP API在Prometheus Server的<code>/api/v1</code>下。</p>
<p><br></p>
<h4 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h4><p>API响应格式为JSON。每个成功的请求都返回<code>2xx</code>状态码。</p>
<p>到达API处理程序无效的请求返回一个错误的JSON对象和以下状态码之一:</p>
<ul>
<li><code>400 Bad Request</code>: 当参数错误或者缺失</li>
<li><code>422 Unprocessable Entity</code>: 当表达式无法执行</li>
<li><code>503 Service Unavailable</code>:  当请求超时或者被中断时</li>
</ul>
<p>JSON响应包格式如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"success"</span> | <span class="string">"error"</span>,</span><br><span class="line">  <span class="attr">"data"</span>: &lt;data&gt;,</span><br><span class="line"></span><br><span class="line">  // Only set if status is "error". The data field may still hold</span><br><span class="line">  // additional data.</span><br><span class="line">  "errorType": "&lt;string&gt;",</span><br><span class="line">  "error": "&lt;string&gt;",</span><br><span class="line"></span><br><span class="line">  // Only if there were warnings while executing the request.</span><br><span class="line">  // There will still be data in the data field.</span><br><span class="line">  "warnings": ["&lt;string&gt;"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求中输入的时间为RFC3339或Unix原子时间，输出时间戳总是Unix原子时间。</p>
<p>查询参数的名称可用中括号<code>[]</code>重复次数。</p>
<p><code>&lt;duration&gt;</code>占位符指的是<code>[0-9]+[smhdwy]</code>形式的Prometheus 持续时间字符串。例如，<code>5m</code>表示5分钟的持续时间。</p>
<p><br><br><br></p>
<h4 id="表达式查询"><a href="#表达式查询" class="headerlink" title="表达式查询"></a>表达式查询</h4><p>查询语言表达式可在单个时刻或一定范围内进行评估。以下部分用于描述每个类型的表达式查询的API endpoint。</p>
<p><br></p>
<p><strong>瞬时查询(Instant query)</strong></p>
<p>端点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/query</span><br><span class="line">POST /api/v1/query</span><br></pre></td></tr></table></figure>
<p>URL查询参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 表达式</span><br><span class="line">query=&lt;string&gt;</span><br><span class="line"></span><br><span class="line"># 时间戳，可选。默认使用当前系统时间</span><br><span class="line">time=&lt;rfc3339 | unix_timestamp&gt;</span><br><span class="line"></span><br><span class="line"># 超时，可选。默认使用全局的-query.timeout参数</span><br><span class="line">timeout=&lt;duration&gt;</span><br></pre></td></tr></table></figure>
<p>查询结果的<code>data</code>部分格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;resultType&quot;: &quot;matrix&quot; | &quot;vector&quot; | &quot;scalar&quot; | &quot;string&quot;,</span><br><span class="line">  &quot;result&quot;: &lt;value&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ curl &apos;http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z&apos;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;status&quot; : &quot;success&quot;,</span><br><span class="line">   &quot;data&quot; : &#123;</span><br><span class="line">      &quot;resultType&quot; : &quot;vector&quot;,</span><br><span class="line">      &quot;result&quot; : [</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;prometheus&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9090&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;value&quot;: [ 1435781451.781, &quot;1&quot; ]</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;node&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9100&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;value&quot; : [ 1435781451.781, &quot;0&quot; ]</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>区间查询(range query)</strong></p>
<p>端点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/query_range</span><br><span class="line">POST /api/v1/query_range</span><br></pre></td></tr></table></figure>
<p>URL查询参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 表达式</span><br><span class="line">query=&lt;string&gt;</span><br><span class="line"></span><br><span class="line"># 时间戳</span><br><span class="line">start=&lt;rfc3339 | unix_timestamp&gt;</span><br><span class="line">end=&lt;rfc3339 | unix_timestamp&gt;</span><br><span class="line"></span><br><span class="line"># 查询时间步长，时间区间内每step秒执行一次</span><br><span class="line">step=&lt;duration | float&gt;</span><br><span class="line"></span><br><span class="line"># 超时，可选</span><br><span class="line">timeout=&lt;duration&gt;</span><br></pre></td></tr></table></figure>
<p>查询结果的<code>data</code>部分格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;resultType&quot;: &quot;matrix&quot;,</span><br><span class="line">  &quot;result&quot;: &lt;value&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ curl &apos;http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s&apos;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;status&quot; : &quot;success&quot;,</span><br><span class="line">   &quot;data&quot; : &#123;</span><br><span class="line">      &quot;resultType&quot; : &quot;matrix&quot;,</span><br><span class="line">      &quot;result&quot; : [</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;prometheus&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9090&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;values&quot; : [</span><br><span class="line">               [ 1435781430.781, &quot;1&quot; ],</span><br><span class="line">               [ 1435781445.781, &quot;1&quot; ],</span><br><span class="line">               [ 1435781460.781, &quot;1&quot; ]</span><br><span class="line">            ]</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            &quot;metric&quot; : &#123;</span><br><span class="line">               &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">               &quot;job&quot; : &quot;node&quot;,</span><br><span class="line">               &quot;instance&quot; : &quot;localhost:9091&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;values&quot; : [</span><br><span class="line">               [ 1435781430.781, &quot;0&quot; ],</span><br><span class="line">               [ 1435781445.781, &quot;0&quot; ],</span><br><span class="line">               [ 1435781460.781, &quot;1&quot; ]</span><br><span class="line">            ]</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="查询元数据"><a href="#查询元数据" class="headerlink" title="查询元数据"></a>查询元数据</h4><p><strong>通过标签匹配器查找序列(Finding series by label matchers)</strong></p>
<p>端点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/series</span><br><span class="line">POST /api/v1/series</span><br></pre></td></tr></table></figure>
<p>URL请求参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 标签选择器是 series_selector。必须至少提供一个match[]参数</span><br><span class="line">match[]=&lt;series_selector&gt;</span><br><span class="line"></span><br><span class="line"># 时间戳</span><br><span class="line">start=&lt;rfc3339 | unix_timestamp&gt;</span><br><span class="line">end=&lt;rfc3339 | unix_timestamp&gt;</span><br></pre></td></tr></table></figure>
<p>返回结果的data部分，由k/v键值对的对象列表组成。<br>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ curl -g &apos;http://localhost:9090/api/v1/series?&apos; --data-urlencode=&apos;match[]=up&apos; --data-urlencode=&apos;match[]=process_start_time_seconds&#123;job=&quot;prometheus&quot;&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;status&quot; : &quot;success&quot;,</span><br><span class="line">   &quot;data&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">         &quot;job&quot; : &quot;prometheus&quot;,</span><br><span class="line">         &quot;instance&quot; : &quot;localhost:9090&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;__name__&quot; : &quot;up&quot;,</span><br><span class="line">         &quot;job&quot; : &quot;node&quot;,</span><br><span class="line">         &quot;instance&quot; : &quot;localhost:9091&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;__name__&quot; : &quot;process_start_time_seconds&quot;,</span><br><span class="line">         &quot;job&quot; : &quot;prometheus&quot;,</span><br><span class="line">         &quot;instance&quot; : &quot;localhost:9090&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>获取标签名(label)</strong></p>
<p>端点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/labels</span><br><span class="line">POST /api/v1/labels</span><br></pre></td></tr></table></figure>
<p>返回结果的<code>data</code>部分是一个标签名字符串列表。<br>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ curl &apos;localhost:9090/api/v1/labels&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">    &quot;data&quot;: [</span><br><span class="line">        &quot;__name__&quot;,</span><br><span class="line">        &quot;call&quot;,</span><br><span class="line">        &quot;code&quot;,</span><br><span class="line">        &quot;config&quot;,</span><br><span class="line">        &quot;dialer_name&quot;,</span><br><span class="line">        &quot;endpoint&quot;,</span><br><span class="line">        &quot;event&quot;,</span><br><span class="line">        &quot;goversion&quot;,</span><br><span class="line">        &quot;handler&quot;,</span><br><span class="line">        &quot;instance&quot;,</span><br><span class="line">        &quot;interval&quot;,</span><br><span class="line">        &quot;job&quot;,</span><br><span class="line">        &quot;le&quot;,</span><br><span class="line">        &quot;listener_name&quot;,</span><br><span class="line">        &quot;name&quot;,</span><br><span class="line">        &quot;quantile&quot;,</span><br><span class="line">        &quot;reason&quot;,</span><br><span class="line">        &quot;role&quot;,</span><br><span class="line">        &quot;scrape_job&quot;,</span><br><span class="line">        &quot;slice&quot;,</span><br><span class="line">        &quot;version&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>查询标签值</strong></p>
<p>请求如下端点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/label/&lt;label_name&gt;/values</span><br></pre></td></tr></table></figure>
<p>JSON响应的<code>data</code>部分是标签值字符串列表。<br>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://localhost:9090/api/v1/label/job/values</span><br><span class="line">&#123;</span><br><span class="line">   &quot;status&quot; : &quot;success&quot;,</span><br><span class="line">   &quot;data&quot; : [</span><br><span class="line">      &quot;node&quot;,</span><br><span class="line">      &quot;prometheus&quot;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="表达式查询结果的格式"><a href="#表达式查询结果的格式" class="headerlink" title="表达式查询结果的格式"></a>表达式查询结果的格式</h4><p>Expression query result formats</p>
<p>表达式查询结果可能会在<code>data</code>部分的<code>result</code>字段中返回以下响应值。</p>
<p><br></p>
<p><strong>区间向量(range vectors)</strong></p>
<p>区间向量返回<code>matrix</code> resultType。<code>result</code>的响应格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;metric&quot;: &#123; &quot;&lt;label_name&gt;&quot;: &quot;&lt;label_value&gt;&quot;, ... &#125;,</span><br><span class="line">    &quot;values&quot;: [ [ &lt;unix_time&gt;, &quot;&lt;sample_value&gt;&quot; ], ... ]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>瞬时向量(instant vectors)</strong></p>
<p>瞬时向量返回<code>vector</code> resultType。<code>result</code>的响应格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;metric&quot;: &#123; &quot;&lt;label_name&gt;&quot;: &quot;&lt;label_value&gt;&quot;, ... &#125;,</span><br><span class="line">    &quot;value&quot;: [ &lt;unix_time&gt;, &quot;&lt;sample_value&gt;&quot; ]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>标量(Scalars)</strong></p>
<p>标量返回<code>scalar</code> resultType。<code>result</code>的响应格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &lt;unix_time&gt;, &quot;&lt;scalar_value&gt;&quot; ]</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>字符串(string)</strong></p>
<p>字符串返回<code>string</code> resultType。<code>result</code>的响应格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &lt;unix_time&gt;, &quot;&lt;string_value&gt;&quot; ]</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><p>Targets</p>
<p>以下端点返回Prometheus目标发现的当前状态的概述:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/targets</span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/targets</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;activeTargets&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;discoveredLabels&quot;: &#123;</span><br><span class="line">          &quot;__address__&quot;: &quot;127.0.0.1:9090&quot;,</span><br><span class="line">          &quot;__metrics_path__&quot;: &quot;/metrics&quot;,</span><br><span class="line">          &quot;__scheme__&quot;: &quot;http&quot;,</span><br><span class="line">          &quot;job&quot;: &quot;prometheus&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;labels&quot;: &#123;</span><br><span class="line">          &quot;instance&quot;: &quot;127.0.0.1:9090&quot;,</span><br><span class="line">          &quot;job&quot;: &quot;prometheus&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;scrapeUrl&quot;: &quot;http://127.0.0.1:9090/metrics&quot;,</span><br><span class="line">        &quot;lastError&quot;: &quot;&quot;,</span><br><span class="line">        &quot;lastScrape&quot;: &quot;2017-01-17T15:07:44.723715405+01:00&quot;,</span><br><span class="line">        &quot;health&quot;: &quot;up&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;droppedTargets&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;discoveredLabels&quot;: &#123;</span><br><span class="line">          &quot;__address__&quot;: &quot;127.0.0.1:9100&quot;,</span><br><span class="line">          &quot;__metrics_path__&quot;: &quot;/metrics&quot;,</span><br><span class="line">          &quot;__scheme__&quot;: &quot;http&quot;,</span><br><span class="line">          &quot;job&quot;: &quot;node&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h4><p>Rules</p>
<p>此api端点返回当前载入的告警和记录规则的列表。此外，它还会返回由每个告警规则的Prometheus实例点燃的当前激活的告警。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/rules</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/rules</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;groups&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;rules&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;alerts&quot;: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;activeAt&quot;: &quot;2018-07-04T20:27:12.60602144+02:00&quot;,</span><br><span class="line">                                &quot;annotations&quot;: &#123;</span><br><span class="line">                                    &quot;summary&quot;: &quot;High request latency&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;labels&quot;: &#123;</span><br><span class="line">                                    &quot;alertname&quot;: &quot;HighRequestLatency&quot;,</span><br><span class="line">                                    &quot;severity&quot;: &quot;page&quot;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;state&quot;: &quot;firing&quot;,</span><br><span class="line">                                &quot;value&quot;: &quot;1e+00&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        &quot;annotations&quot;: &#123;</span><br><span class="line">                            &quot;summary&quot;: &quot;High request latency&quot;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;duration&quot;: 600,</span><br><span class="line">                        &quot;health&quot;: &quot;ok&quot;,</span><br><span class="line">                        &quot;labels&quot;: &#123;</span><br><span class="line">                            &quot;severity&quot;: &quot;page&quot;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;name&quot;: &quot;HighRequestLatency&quot;,</span><br><span class="line">                        &quot;query&quot;: &quot;job:request_latency_seconds:mean5m&#123;job=\&quot;myjob\&quot;&#125; &gt; 0.5&quot;,</span><br><span class="line">                        &quot;type&quot;: &quot;alerting&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;health&quot;: &quot;ok&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;job:http_inprogress_requests:sum&quot;,</span><br><span class="line">                        &quot;query&quot;: &quot;sum(http_inprogress_requests) by (job)&quot;,</span><br><span class="line">                        &quot;type&quot;: &quot;recording&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                &quot;file&quot;: &quot;/rules.yaml&quot;,</span><br><span class="line">                &quot;interval&quot;: 60,</span><br><span class="line">                &quot;name&quot;: &quot;example&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;status&quot;: &quot;success&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h4><p>Alerts</p>
<p>此端点返回所有激活的告警的列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/alerts</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/alerts</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;alerts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;activeAt&quot;: &quot;2018-07-04T20:27:12.60602144+02:00&quot;,</span><br><span class="line">                &quot;annotations&quot;: &#123;&#125;,</span><br><span class="line">                &quot;labels&quot;: &#123;</span><br><span class="line">                    &quot;alertname&quot;: &quot;my-alert&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;state&quot;: &quot;firing&quot;,</span><br><span class="line">                &quot;value&quot;: &quot;1e+00&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;status&quot;: &quot;success&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="查询目标元数据"><a href="#查询目标元数据" class="headerlink" title="查询目标元数据"></a>查询目标元数据</h4><p>Query target metadata</p>
<p>此段点返回目前由目标爬取的关于指标的元数据。这是实验性的，未来可能发生改变。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/targets/metadata</span><br></pre></td></tr></table></figure>
<p>URL查询参数:</p>
<ul>
<li><code>match_target=&lt;label_selectors&gt;</code>: 标签选择器通过标签集匹配的目标。如果为空，则所有目标都被选中。</li>
<li><code>metics=&lt;string&gt;</code>: 检索元数据的指标名称。如果为空，则所有指标元数据都被检索。</li>
<li><code>limit=&lt;number&gt;</code>: 匹配的目标的最大数量。</li>
</ul>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">curl -G http://localhost:9091/api/v1/targets/metadata \</span><br><span class="line">    --data-urlencode &apos;metric=go_goroutines&apos; \</span><br><span class="line">    --data-urlencode &apos;match_target=&#123;job=&quot;prometheus&quot;&#125;&apos; \</span><br><span class="line">    --data-urlencode &apos;limit=2&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;target&quot;: &#123;</span><br><span class="line">        &quot;instance&quot;: &quot;127.0.0.1:9090&quot;,</span><br><span class="line">        &quot;job&quot;: &quot;prometheus&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;type&quot;: &quot;gauge&quot;,</span><br><span class="line">      &quot;help&quot;: &quot;Number of goroutines that currently exist.&quot;,</span><br><span class="line">      &quot;unit&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;target&quot;: &#123;</span><br><span class="line">        &quot;instance&quot;: &quot;127.0.0.1:9091&quot;,</span><br><span class="line">        &quot;job&quot;: &quot;prometheus&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;type&quot;: &quot;gauge&quot;,</span><br><span class="line">      &quot;help&quot;: &quot;Number of goroutines that currently exist.&quot;,</span><br><span class="line">      &quot;unit&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -G http://localhost:9091/api/v1/targets/metadata \</span><br><span class="line">    --data-urlencode &apos;match_target=&#123;instance=&quot;127.0.0.1:9090&quot;&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: [</span><br><span class="line">    // ...</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;target&quot;: &#123;</span><br><span class="line">        &quot;instance&quot;: &quot;127.0.0.1:9090&quot;,</span><br><span class="line">        &quot;job&quot;: &quot;prometheus&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;metric&quot;: &quot;prometheus_treecache_zookeeper_failures_total&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;counter&quot;,</span><br><span class="line">      &quot;help&quot;: &quot;The total number of ZooKeeper failures.&quot;,</span><br><span class="line">      &quot;unit&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;target&quot;: &#123;</span><br><span class="line">        &quot;instance&quot;: &quot;127.0.0.1:9090&quot;,</span><br><span class="line">        &quot;job&quot;: &quot;prometheus&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;metric&quot;: &quot;prometheus_tsdb_reloads_total&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;counter&quot;,</span><br><span class="line">      &quot;help&quot;: &quot;Number of times the database reloaded block data from disk.&quot;,</span><br><span class="line">      &quot;unit&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    // ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="告警器"><a href="#告警器" class="headerlink" title="告警器"></a>告警器</h4><p>AlertManagers</p>
<p>此端点返回Prometheus alertmanager discovery的当前状态的概述:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/alertmanagers</span><br></pre></td></tr></table></figure>
<p>active和dropped Alertmanagers都是响应的一部分:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/alertmanagers</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;activeAlertmanagers&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;url&quot;: &quot;http://127.0.0.1:9090/api/v1/alerts&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;droppedAlertmanagers&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;url&quot;: &quot;http://127.0.0.1:9093/api/v1/alerts&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h4><p>Status</p>
<p>以下状态端点暴露当前Prometheus配置。</p>
<p><br></p>
<p><strong>Config</strong></p>
<p>此端点返回当前加载的配置文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/status/config</span><br></pre></td></tr></table></figure>
<p>配置返回为转存的YAML文件。由于YAML库的限制，YAML中不包含注释:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/status/config</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;yaml&quot;: &quot;&lt;content of the loaded config file in YAML&gt;&quot;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Flags</strong></p>
<p>此端点返回Prometheus配置的标志值:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/status/flags</span><br></pre></td></tr></table></figure>
<p>所有值的结果类型都是字符串:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/status/flags</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;alertmanager.notification-queue-capacity&quot;: &quot;10000&quot;,</span><br><span class="line">    &quot;alertmanager.timeout&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;log.level&quot;: &quot;info&quot;,</span><br><span class="line">    &quot;query.lookback-delta&quot;: &quot;5m&quot;,</span><br><span class="line">    &quot;query.max-concurrency&quot;: &quot;20&quot;,</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>RunTime Information</strong></p>
<p>此端点返回Prometheus Server的各种运行信息属性:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/status/runtimeinfo</span><br></pre></td></tr></table></figure>
<p>根据运行属性，返回的值有两种类型:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/status/runtimeinfo</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;startTime&quot;: &quot;2019-11-02T17:23:59.301361365+01:00&quot;,</span><br><span class="line">    &quot;CWD&quot;: &quot;/&quot;,</span><br><span class="line">    &quot;reloadConfigSuccess&quot;: true,</span><br><span class="line">    &quot;lastConfigTime&quot;: &quot;2019-11-02T17:23:59+01:00&quot;,</span><br><span class="line">    &quot;chunkCount&quot;: 873,</span><br><span class="line">    &quot;timeSeriesCount&quot;: 873,</span><br><span class="line">    &quot;corruptionCount&quot;: 0,</span><br><span class="line">    &quot;goroutineCount&quot;: 48,</span><br><span class="line">    &quot;GOMAXPROCS&quot;: 4,</span><br><span class="line">    &quot;GOGC&quot;: &quot;&quot;,</span><br><span class="line">    &quot;GODEBUG&quot;: &quot;&quot;,</span><br><span class="line">    &quot;storageRetention&quot;: &quot;15d&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Build Information</strong></p>
<p>此端点返回各种关于Prometheus Server的构建信息属性:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/status/buildinfo</span><br></pre></td></tr></table></figure>
<p>所有结果的值的类型都是字符串:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/api/v1/status/buildinfo</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;version&quot;: &quot;2.13.1&quot;,</span><br><span class="line">    &quot;revision&quot;: &quot;cb7cbad5f9a2823a622aaa668833ca04f50a0ea7&quot;,</span><br><span class="line">    &quot;branch&quot;: &quot;master&quot;,</span><br><span class="line">    &quot;buildUser&quot;: &quot;julius@desktop&quot;,</span><br><span class="line">    &quot;buildDate&quot;: &quot;20191102-16:19:59&quot;,</span><br><span class="line">    &quot;goVersion&quot;: &quot;go1.13.1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="TSDB-Admin-APIs"><a href="#TSDB-Admin-APIs" class="headerlink" title="TSDB Admin APIs"></a>TSDB Admin APIs</h4><p>这些都是为高级用户公开的数据库功能的API。除非设置<code>--web.enable-admin-api</code>，否则不启用这些API。</p>
<p>我们也公开了一个gRPC API。这是实验性的，未来可能会改变。</p>
<p><br></p>
<p><strong>Snapshot</strong></p>
<p>创建所有当前数据的快照<code>snapshots/datetime-rand</code>早TSDB的数据目录并返回目录作为响应。它将可选地跳过快照数据尽在头部块，并且未被压缩到磁盘。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/admin/tsdb/snapshot</span><br><span class="line">PUT /api/v1/admin/tsdb/snapshot</span><br></pre></td></tr></table></figure>
<p>URL查询参数:</p>
<ul>
<li><code>skip_head=&lt;bool&gt;</code>: 跳过存在于头部块(head block)的数据，可选。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9090/api/v1/admin/tsdb/snapshot</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;20171210T211224Z-2be650b6d019eb54&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>快照现在位于: <code>&lt;data-dir&gt;/snapshots/20171210T211224Z-2be650b6d019eb54</code></p>
<p><br></p>
<p><strong>Delete Series</strong></p>
<p>删除在一个时间范围内选择的一些列数据。实际数据仍然存在于磁盘上，并在未来被清除或通过点击Clean Tombstones endpoint来明确清理。<br>如果成功，返回<code>204</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/admin/tsdb/delete_series</span><br><span class="line">PUT /api/v1/admin/tsdb/delete_series</span><br></pre></td></tr></table></figure>
<p>URL查询参数:</p>
<ul>
<li><code>match[]=&lt;series_selector&gt;</code>: 至少必须提供一个</li>
<li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code></li>
<li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code></li>
</ul>
<p>未指定时间范围将删除匹配的所有数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -g &apos;http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]=up&amp;match[]=process_start_time_seconds&#123;job=&quot;prometheus&quot;&#125;&apos;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>Clean Tombstones</strong></p>
<p>从磁盘中删除已删除的数据并清理现有的tombstones。这可在清理数据后腾出磁盘空间。</p>
<p>如果成功，返回<code>204</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/admin/tsdb/clean_tombstones</span><br><span class="line">PUT /api/v1/admin/tsdb/clean_tombstones</span><br></pre></td></tr></table></figure>
<p>不需要任何参数或body:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9090/api/v1/admin/tsdb/clean_tombstones</span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p>Storage: <a href="https://prometheus.io/docs/prometheus/latest/storage/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/storage/</a></p>
<p>Prometheus包含了一个本地磁盘上的时序数据库(time series database)，但是可选地与远程存储系统集成。</p>
<p><br></p>
<h3 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h3><p>Local storage</p>
<p>Prometheus本地时序数据库存储时序数据自定义格式存储到磁盘上。</p>
<p><br></p>
<p><strong>On-disk layout</strong></p>
<p>Prometheus按两小时为一个时间窗口分组存储在一个块(block)中。每个块是一个单独地目录，里面包含该时间窗口内的所有样本数据(chunks)，元数据文件(meta.json)以及索引文件(index)。其中索引文件会将指标名称和标签索引到样板数据的时间序列中。此期间如果通过 API 删除时间序列，删除记录会保存在单独的逻辑文件<code>tombstone</code>当中。</p>
<p>当前样本数据所在的块会被直接保存在内存中，不会持久化到磁盘中。为了确保Prometheus发生崩溃或重启时能够恢复数据，Prometheus启动时会通过预写日志（write-ahead-log(WAL)）重新记录，从而恢复数据。预写日志文件保存在<code>wal</code>目录中，每个文件大小为<code>128MB</code>。wal 文件包括还没有被压缩的原始数据，所以比常规的块文件大得多。一般情况下，Prometheus 会保留三个 wal 文件，但如果有些高负载服务器需要保存两个小时以上的原始数据，wal文件的数量就会大于3个。</p>
<p>Prometheus块数据的目录结构如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">./data</span><br><span class="line">├── 01BKGV7JBM69T2G1BGBGM6KB12</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── 01BKGTZQ1SYQJTR4PB43C8PD98</span><br><span class="line">│   ├── chunks</span><br><span class="line">│   │   └── 000001</span><br><span class="line">│   ├── tombstones</span><br><span class="line">│   ├── index</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K</span><br><span class="line">│   └── meta.json</span><br><span class="line">├── 01BKGV7JC0RY8A6MACW02A2PJD</span><br><span class="line">│   ├── chunks</span><br><span class="line">│   │   └── 000001</span><br><span class="line">│   ├── tombstones</span><br><span class="line">│   ├── index</span><br><span class="line">│   └── meta.json</span><br><span class="line">└── wal</span><br><span class="line">    ├── 00000002</span><br><span class="line">    └── checkpoint.000001</span><br></pre></td></tr></table></figure>
<p>本地存储的局限性是它无法构建集群(clustered)或副本(replicated)。因此，如果本地磁盘或节点出现故障，存储将无法扩展和迁移。使用RAID用于磁盘的可用性，使用快照用于备份，容量规划…建议提高耐用性。如果你对数据持久化的要求不是很严格，可以使用本地磁盘存储多达数年的数据。</p>
<p>可替代地，外部存储可通过使用<code>remote read/write APIs</code>。仔细评估这些系统，因为它们在耐用性，性能和效率差异很大。</p>
<p>有关存储格式的详细信息，请参考 <a href="https://github.com/prometheus/prometheus/blob/master/tsdb/docs/format/README.md" target="_blank" rel="noopener">TSDB格式</a></p>
<p><br><br><br></p>
<h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><p>最初两个小时的块最终会在后台被压缩成更长的块。</p>
<p><br></p>
<h3 id="操作配置"><a href="#操作配置" class="headerlink" title="操作配置"></a>操作配置</h3><p>Prometheus提供了几个标志来允许配置本地存储。最重要的几个:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 数据存储路径，默认data/</span><br><span class="line">--storage.tsdb.path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 样本数据在存储中保存的时间。超过该时间限制的数据就会被删除。默认15d</span><br><span class="line">-storage.tsdb.retention.time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 每个块的最大字节数（不包括 wal 文件）。如果超过限制，最早的样本数据会被优先删除。支持的单位有 KB, MB, GB, PB。默认0，即为不限制</span><br><span class="line">--storage.tsdb.retention.size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 压缩wal</span><br><span class="line">--storage.tsdb.wal-compression</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>一般情况下，Prometheus中存储的每一个样本大概会占用1-2Byte。因此，如果需要对Prometheus Server的本地磁盘空间做容量规划，可通过以下公式计算:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample</span><br></pre></td></tr></table></figure>
<p>从上面公式中可以看出在保留时间（<code>retention_time_seconds</code>）和样本大小（<code>bytes_per_sample</code>）不变的情况下，如果想减少本地磁盘的容量需求，只能通过减少每秒获取样本数（<code>ingested_samples_per_second</code>）的方式。因此有两种手段，一是减少时间序列的数量，二是增加采集样本的时间间隔。考虑到 Prometheus 会对时间序列进行压缩效率，减少时间序列的数量效果更明显。</p>
<p><br><br><br></p>
<hr>
<p><br><br><br></p>
<h1 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h1><p>Visualization</p>
<p><br></p>
<h2 id="表达式浏览器"><a href="#表达式浏览器" class="headerlink" title="表达式浏览器"></a>表达式浏览器</h2><p>Expression browser</p>
<p>表达其浏览器在 Prometheus Server 的 <code>/graph</code> 处。<br>对于图形，请使用 Grafana 或 Console template。</p>
<p><br><br><br><br><br></p>
<h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><p>Grafana: <a href="https://grafana.com/" target="_blank" rel="noopener">https://grafana.com/</a></p>
<p>Grafana，美丽的分析和监控的开放平台，时序分析的开源那软件。</p>
<p>Grafana 支持查询 Prometheus。如下是一个Grafana仪表盘，用于查询Prometheus的数据：</p>
<p><img src="/images/Prometheus/grafana_prometheus.png" alt></p>
<p><br></p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>完整的安装说明，请查看Grafana Docs。</p>
<p><br></p>
<h4 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h4><p><strong>RPM</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#sudo yum install &lt;rpm package url&gt;</span><br><span class="line">sudo yum install https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.1.4-1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p><strong>repo</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[grafana]</span><br><span class="line">name=grafana</span><br><span class="line">baseurl=https://packagecloud.io/grafana/stable/el/7/$basearch</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packagecloud.io/gpg.key https://grafanarel.s3.amazonaws.com/RPM-GPG-KEY-grafana</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo yum install -y grafana</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">systemctl start grafana-server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#命令行工具</span><br><span class="line">grafana-cli</span><br></pre></td></tr></table></figure>
<p><strong>包详情</strong></p>
<ul>
<li>Installs binary to <code>/usr/sbin/grafana-server</code></li>
<li>Copies init.d script to <code>/etc/init.d/grafana-server</code></li>
<li>Installs default file (environment vars) to <code>/etc/sysconfig/grafana-server</code></li>
<li>Copies configuration file to <code>/etc/grafana/grafana.ini</code></li>
<li>Installs systemd service (if systemd is available) name <code>grafana-server.service</code></li>
<li>The default configuration uses a log file at <code>/var/log/grafana/grafana.log</code></li>
<li>The default configuration specifies an sqlite3 database at <code>/var/lib/grafana/grafana.db</code></li>
</ul>
<p><br></p>
<p><strong>二进制tar文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Download and unpack Grafana from binary tar (adjust version as appropriate).</span><br><span class="line">curl -L -O https://grafanarel.s3.amazonaws.com/builds/grafana-2.5.0.linux-x64.tar.gz</span><br><span class="line">tar zxf grafana-2.5.0.linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line"># Start Grafana.</span><br><span class="line">cd grafana-2.5.0/</span><br><span class="line">./bin/grafana-server web</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#基础栗子</span><br><span class="line">docker run -d -p 3000:3000 grafana/grafana</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置化</span><br><span class="line">docker run \</span><br><span class="line">  -d \</span><br><span class="line">  -p 3000:3000 \</span><br><span class="line">  --name=grafana \</span><br><span class="line">  -e &quot;GF_SERVER_ROOT_URL=http://grafana.server.name&quot; \</span><br><span class="line">  -e &quot;GF_SECURITY_ADMIN_PASSWORD=secret&quot; \</span><br><span class="line">  grafana/grafana:version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#默认环境变量值</span><br><span class="line">GF_PATHS_CONFIG	/etc/grafana/grafana.ini</span><br><span class="line">GF_PATHS_DATA	/var/lib/grafana</span><br><span class="line">GF_PATHS_HOME	/usr/share/grafana</span><br><span class="line">GF_PATHS_LOGS	/var/log/grafana</span><br><span class="line">GF_PATHS_PLUGINS	/var/lib/grafana/plugins</span><br><span class="line">GF_PATHS_PROVISIONING	/etc/grafana/provisioning</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>默认情况下，访问<code>http://localhost:3000</code>来访问Grafana。默认登录的用户名和密码： <code>admin/admin</code>。</p>
<p><img src="/images/Prometheus/grafana_login.png" alt="Grafana"></p>
<p><br></p>
<p><strong>创建Prometheus数据源</strong></p>
<p><img src="/images/Prometheus/add_prometheus_datasource.png" alt></p>
<p><br></p>
<p><strong>创建Prometheus图表</strong></p>
<p><br><br><br><br><br></p>
<h2 id="Console-template"><a href="#Console-template" class="headerlink" title="Console template"></a>Console template</h2><p>控制台模板允许使用Go templating language创建任意控制台。这些都是从Prometheus Server提供的。</p>

        
      </div>
      
      
      
    </div>
    
    
    
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image" src="/images/leslie.jpg" alt="Leslie Zhang">
          
            <p class="site-author-name" itemprop="name">Leslie Zhang</p>
            <p class="site-description motion-element" itemprop="description">那一年我二十一岁，在我一生的黄金时代</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:me@zhang21.cn" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus是什么"><span class="nav-number">1.1.1.</span> <span class="nav-text">Prometheus是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么时候适合"><span class="nav-number">1.1.2.</span> <span class="nav-text">什么时候适合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么时候不适合"><span class="nav-number">1.1.3.</span> <span class="nav-text">什么时候不适合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第一步"><span class="nav-number">1.2.</span> <span class="nav-text">第一步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#术语"><span class="nav-number">1.3.</span> <span class="nav-text">术语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-number">1.4.</span> <span class="nav-text">FAQ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#概念"><span class="nav-number">2.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据模型"><span class="nav-number">2.1.</span> <span class="nav-text">数据模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#指标名称和标签"><span class="nav-number">2.1.1.</span> <span class="nav-text">指标名称和标签</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#指标类型"><span class="nav-number">2.2.</span> <span class="nav-text">指标类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工作和实例"><span class="nav-number">2.3.</span> <span class="nav-text">工作和实例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Prometheus"><span class="nav-number">3.</span> <span class="nav-text">Prometheus</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#入门"><span class="nav-number">3.1.</span> <span class="nav-text">入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">3.2.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用预编译的二进制文件"><span class="nav-number">3.2.1.</span> <span class="nav-text">使用预编译的二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用源码"><span class="nav-number">3.2.2.</span> <span class="nav-text">使用源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Docker"><span class="nav-number">3.2.3.</span> <span class="nav-text">使用Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用配置管理系统"><span class="nav-number">3.2.4.</span> <span class="nav-text">使用配置管理系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">3.3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件"><span class="nav-number">3.3.1.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#记录规则"><span class="nav-number">3.3.2.</span> <span class="nav-text">记录规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置规则"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">配置规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#语法检查规则"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">语法检查规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#记录规则-1"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">记录规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#告警规则"><span class="nav-number">3.3.3.</span> <span class="nav-text">告警规则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义告警规则"><span class="nav-number">3.3.3.1.</span> <span class="nav-text">定义告警规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模板"><span class="nav-number">3.3.3.2.</span> <span class="nav-text">模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行时检查告警"><span class="nav-number">3.3.3.3.</span> <span class="nav-text">运行时检查告警</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送告警通知"><span class="nav-number">3.3.3.4.</span> <span class="nav-text">发送告警通知</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板-1"><span class="nav-number">3.3.4.</span> <span class="nav-text">模板</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单告警字段模板"><span class="nav-number">3.3.4.1.</span> <span class="nav-text">简单告警字段模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简单迭代"><span class="nav-number">3.3.4.2.</span> <span class="nav-text">简单迭代</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#展示一个值"><span class="nav-number">3.3.4.3.</span> <span class="nav-text">展示一个值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用控制台url参数"><span class="nav-number">3.3.4.4.</span> <span class="nav-text">使用控制台url参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高级的迭代"><span class="nav-number">3.3.4.5.</span> <span class="nav-text">高级的迭代</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义可重复使用的模板"><span class="nav-number">3.3.4.6.</span> <span class="nav-text">定义可重复使用的模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板引用"><span class="nav-number">3.3.5.</span> <span class="nav-text">模板引用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据结构"><span class="nav-number">3.3.5.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#函数"><span class="nav-number">3.3.5.2.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模板类型差异"><span class="nav-number">3.3.5.3.</span> <span class="nav-text">模板类型差异</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#规则单元测试"><span class="nav-number">3.3.6.</span> <span class="nav-text">规则单元测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询"><span class="nav-number">3.4.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询Prometheus"><span class="nav-number">3.4.1.</span> <span class="nav-text">查询Prometheus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#表达式语言数据类型"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">表达式语言数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Literals"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">Literals</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时序选择器"><span class="nav-number">3.4.1.3.</span> <span class="nav-text">时序选择器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#子查询"><span class="nav-number">3.4.1.4.</span> <span class="nav-text">子查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作符"><span class="nav-number">3.4.2.</span> <span class="nav-text">操作符</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#二元运算符"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">二元运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#矢量匹配"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">矢量匹配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#聚合运算符"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">聚合运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二元运算符优先级"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">二元运算符优先级</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数-1"><span class="nav-number">3.4.3.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询栗子"><span class="nav-number">3.4.4.</span> <span class="nav-text">查询栗子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单时序选择"><span class="nav-number">3.4.4.1.</span> <span class="nav-text">简单时序选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#子查询-1"><span class="nav-number">3.4.4.2.</span> <span class="nav-text">子查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用函数，运算符"><span class="nav-number">3.4.4.3.</span> <span class="nav-text">使用函数，运算符</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-API"><span class="nav-number">3.4.5.</span> <span class="nav-text">HTTP API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#格式"><span class="nav-number">3.4.5.1.</span> <span class="nav-text">格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#表达式查询"><span class="nav-number">3.4.5.2.</span> <span class="nav-text">表达式查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询元数据"><span class="nav-number">3.4.5.3.</span> <span class="nav-text">查询元数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#表达式查询结果的格式"><span class="nav-number">3.4.5.4.</span> <span class="nav-text">表达式查询结果的格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#目标"><span class="nav-number">3.4.5.5.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则"><span class="nav-number">3.4.5.6.</span> <span class="nav-text">规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#告警"><span class="nav-number">3.4.5.7.</span> <span class="nav-text">告警</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询目标元数据"><span class="nav-number">3.4.5.8.</span> <span class="nav-text">查询目标元数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#告警器"><span class="nav-number">3.4.5.9.</span> <span class="nav-text">告警器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#状态"><span class="nav-number">3.4.5.10.</span> <span class="nav-text">状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TSDB-Admin-APIs"><span class="nav-number">3.4.5.11.</span> <span class="nav-text">TSDB Admin APIs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#存储"><span class="nav-number">3.5.</span> <span class="nav-text">存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本地存储"><span class="nav-number">3.5.1.</span> <span class="nav-text">本地存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compaction"><span class="nav-number">3.5.2.</span> <span class="nav-text">Compaction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作配置"><span class="nav-number">3.5.3.</span> <span class="nav-text">操作配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#可视化"><span class="nav-number">4.</span> <span class="nav-text">可视化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#表达式浏览器"><span class="nav-number">4.1.</span> <span class="nav-text">表达式浏览器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Grafana"><span class="nav-number">4.2.</span> <span class="nav-text">Grafana</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CentOS"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">CentOS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">Docker</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用"><span class="nav-number">4.2.2.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Console-template"><span class="nav-number">4.3.</span> <span class="nav-text">Console template</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leslie Zhang</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 21.5k</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/all/Prometheus.html';
          this.page.identifier = 'all/Prometheus.html';
          this.page.title = 'Prometheus';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
